# 爱签电子签约平台集成

<cite>
**本文档引用的文件**
- [esign.service.ts](file://backend/src/modules/esign/esign.service.ts)
- [esign_payment_integration.js](file://backend/esign_payment_integration.js)
- [mcp-esign-server.js](file://mcp-esign-server.js)
- [调试文档.md](file://爱签SDK/调试说明文档Markdown/调试文档.md)
- [esign.controller.ts](file://backend/src/modules/esign/esign.controller.ts)
- [Api.py](file://爱签SDK/Api.py)
</cite>

## 目录
1. [项目结构](#项目结构)
2. [核心组件](#核心组件)
3. [架构概览](#架构概览)
4. [详细组件分析](#详细组件分析)
5. [依赖分析](#依赖分析)
6. [性能考量](#性能考量)
7. [故障排除指南](#故障排除指南)
8. [结论](#结论)

## 项目结构
项目采用分层架构，主要分为前端、后端和脚本三大模块。后端基于NestJS框架，实现了模块化设计，其中`esign`模块专门负责与爱签电子签约平台的集成。`contracts`模块管理合同数据，与`esign`模块紧密协作。爱签SDK以Python和C#示例形式提供，位于独立目录中。支付联动逻辑和MCP服务解耦逻辑作为独立的Node.js脚本存在，体现了关注点分离的设计原则。

```mermaid
graph TB
subgraph "前端"
FE[React应用]
end
subgraph "后端"
BE[NestJS应用]
ES[esign模块]
CM[contracts模块]
end
subgraph "集成服务"
SDK[爱签SDK]
PAY[支付联动]
MCP[MCP服务]
end
FE --> BE
BE --> ES
ES --> SDK
ES --> PAY
ES --> MCP
CM --> ES
```

**图示来源**
- [esign.service.ts](file://backend/src/modules/esign/esign.service.ts)
- [esign_payment_integration.js](file://backend/esign_payment_integration.js)
- [mcp-esign-server.js](file://mcp-esign-server.js)

## 核心组件
核心组件包括`esign.service.ts`，它封装了对爱签API的所有调用，是集成的核心。`esign_payment_integration.js`实现了合同签署与支付流程的联动。`mcp-esign-server.js`提供了一个MCP（Model Context Protocol）服务器，实现了服务解耦。`Api.py`是爱签官方提供的Python SDK，作为HTTP调用的基础。

**组件来源**
- [esign.service.ts](file://backend/src/modules/esign/esign.service.ts)
- [esign_payment_integration.js](file://backend/esign_payment_integration.js)
- [mcp-esign-server.js](file://mcp-esign-server.js)
- [Api.py](file://爱签SDK/Api.py)

## 架构概览
系统架构采用微服务风格，前端通过API与后端通信。后端的`esign`服务作为爱签平台的适配器，处理所有电子签约相关的业务逻辑。该服务通过HTTP调用爱签的OpenAPI，并通过回调机制（NotifyUrl）接收异步通知。支付联动服务监听合同状态，一旦合同签署完成，即引导用户进入支付流程。MCP服务器则为外部系统提供了一个标准化的接口来调用爱签功能。

```mermaid
sequenceDiagram
participant 前端 as 前端
participant 后端 as 后端
participant 爱签 as 爱签平台
participant 支付 as 支付网关
前端->>后端 : 创建合同请求
后端->>爱签 : 调用createContractWithTemplate
爱签-->>后端 : 返回签署链接
后端-->>前端 : 返回签署链接
前端->>爱签 : 用户签署合同
爱签->>后端 : 发送回调通知 (NotifyUrl)
后端->>后端 : 更新合同状态为"已签约"
后端->>前端 : 重定向至支付页面
前端->>后端 : 创建支付订单
后端->>支付 : 调用支付API
支付-->>后端 : 返回支付二维码
后端-->>前端 : 返回支付二维码
支付->>后端 : 支付成功回调
后端->>后端 : 更新合同支付状态
```

**图示来源**
- [esign.service.ts](file://backend/src/modules/esign/esign.service.ts)
- [esign_payment_integration.js](file://backend/esign_payment_integration.js)

## 详细组件分析

### 爱签服务分析
`esign.service.ts`是集成的核心，它封装了爱签SDK的HTTP调用。

#### 类图
```mermaid
classDiagram
class ESignService {
-config : ESignConfig
-axiosInstance : AxiosInstance
+createContractWithTemplate(params) : Promise~{signFlowId, signUrl}~
+getSignFlowStatus(signFlowId) : Promise~{status, documents}~
+verifyCallback(signature, timestamp, body) : boolean
+testConnection() : Promise~{success, message, config}~
}
class ESignConfig {
+type : string
+appId : string
+publicKey : string
+privateKey : string
+host : string
+version : string
+notifyUrl : string
}
class ESignResponse {
+code : number
+message : string
+data : T
}
ESignService --> ESignConfig : "使用"
ESignService --> AxiosInstance : "依赖"
ESignService --> ESignResponse : "返回"
```

**图示来源**
- [esign.service.ts](file://backend/src/modules/esign/esign.service.ts)

#### 关键功能分析

**合同创建与模板填充**
服务通过`createContractFromTemplate`方法创建合同。它首先调用`/v1/files/createByTemplate` API，使用模板ID和填充参数生成PDF文档，然后调用`/v1/signflows` API创建签署流程。签名机制基于RSA-SHA256，使用商户私钥对请求参数进行签名。

**异步回调处理**
`verifyCallback`方法用于验证爱签平台发来的回调通知。它使用爱签提供的公钥验证签名，确保通知的完整性和真实性。回调URL（NotifyUrl）在创建签署流程时指定，爱签平台会在合同状态变化时调用此URL。

**API版本兼容性与连接测试**
服务通过`testConnection`方法测试与爱签API的连接。该方法尝试调用一个基础API（如`/v1/accounts/verify`），并检查响应。服务的配置（如`host`和`version`）从环境变量中读取，便于在沙箱（`https://prev.asign.cn`）和生产环境（`https://api.asign.cn`或`https://oapi.asign.cn`）之间切换。

**密钥管理**
私钥优先从文件（`ESIGN_PRIVATE_KEY_PATH`）读取，其次从环境变量（`ESIGN_PRIVATE_KEY`）获取，最后使用内置的默认私钥。公钥用于验证回调，从环境变量（`ESIGN_PUBLIC_KEY`）获取。

**组件来源**
- [esign.service.ts](file://backend/src/modules/esign/esign.service.ts)
- [调试文档.md](file://爱签SDK/调试说明文档Markdown/调试文档.md)

### 支付联动逻辑分析
`esign_payment_integration.js`实现了合同签署与支付的无缝衔接。

#### 序列图
```mermaid
sequenceDiagram
participant 前端 as 前端
participant 支付服务 as 支付服务
participant 爱签 as 爱签平台
前端->>支付服务 : POST /create-contract-with-payment
支付服务->>爱签 : 创建爱签合同 (设置redirectUrl)
爱签-->>支付服务 : 合同创建成功
支付服务->>数据库 : 保存合同信息
支付服务->>爱签 : 更新合同跳转链接 (包含contractId)
支付服务-->>前端 : 返回签署链接
前端->>爱签 : 用户签署合同
爱签->>支付服务 : POST /esign/contract-callback
支付服务->>数据库 : 更新合同状态为"已签约"
支付服务-->>爱签 : 回调处理成功
前端->>支付服务 : GET /contracts/{contractId}/payment-info
支付服务->>数据库 : 查询合同支付信息
支付服务-->>前端 : 返回支付信息
前端->>支付服务 : POST /payments/create
支付服务->>数据库 : 验证合同状态
支付服务->>支付网关 : 创建支付订单
支付网关-->>支付服务 : 返回支付二维码
支付服务-->>前端 : 返回支付二维码
支付网关->>支付服务 : POST /payments/notify
支付服务->>数据库 : 更新支付状态
支付服务->>数据库 : 更新合同支付状态
支付服务-->>支付网关 : 回调处理成功
```

**图示来源**
- [esign_payment_integration.js](file://backend/esign_payment_integration.js)

#### 关键逻辑
- **创建合同时设置跳转链接**：在创建合同时，`redirectUrl`被设置为一个包含占位符的URL。合同创建成功后，服务会用真实的合同ID更新这个链接，确保用户签署完成后能跳转到正确的支付页面。
- **状态机联动**：合同状态（待签约、已签约）与支付状态（待支付、已支付）形成联动。只有当合同状态为"已签约"时，才能创建支付订单。
- **回调验证**：无论是爱签的合同回调还是支付网关的支付回调，都应进行签名验证，以确保安全性。

**组件来源**
- [esign_payment_integration.js](file://backend/esign_payment_integration.js)

### MCP服务解耦分析
`mcp-esign-server.js`实现了服务解耦，为外部系统提供了一个标准化的接口。

#### 流程图
```mermaid
flowchart TD
Start([MCP服务器启动]) --> Listen["监听标准输入"]
Listen --> Parse["解析JSON-RPC请求"]
Parse --> Method{"方法: tools/call?"}
Method --> |是| FindTool["查找工具: create_signing_flow等"]
FindTool --> |找到| Execute["执行工具函数"]
Execute --> Format["格式化JSON-RPC响应"]
Format --> Output["输出到标准输出"]
Method --> |否| ListTools["处理tools/list等其他方法"]
ListTools --> Format
Execute --> |异常| Error["捕获异常"]
Error --> FormatError["格式化错误响应"]
FormatError --> Output
```

**图示来源**
- [mcp-esign-server.js](file://mcp-esign-server.js)

#### 关键设计
- **工具注册**：服务将`esign.service.ts`中的各种功能（如`create_signing_flow`、`get_template_preview`）封装为MCP工具，并注册到`tools`映射中。
- **资源抽象**：将模板列表、配置信息等数据抽象为资源（`esign://templates`），可通过`resources/read`方法读取。
- **标准化接口**：通过JSON-RPC协议与外部系统通信，实现了语言和平台的无关性，达到了服务解耦的目的。

**组件来源**
- [mcp-esign-server.js](file://mcp-esign-server.js)

### 合同生命周期管理
合同的生命周期通过状态机进行管理。

#### 状态图
```mermaid
stateDiagram-v2
[*] --> 待创建
待创建 --> 待签约 : 创建合同
待签约 --> 签约中 : 开始签署
签约中 --> 已签约 : 所有方签署完成
签约中 --> 已拒绝 : 任一方拒绝
签约中 --> 已过期 : 超时未完成
已签约 --> 待支付 : 签署完成
待支付 --> 已支付 : 支付成功
待支付 --> 支付失败 : 支付超时/失败
已支付 --> [*]
已拒绝 --> [*]
已过期 --> [*]
支付失败 --> [*]
```

**图示来源**
- [esign.service.ts](file://backend/src/modules/esign/esign.service.ts)
- [esign_payment_integration.js](file://backend/esign_payment_integration.js)

#### 状态流转
- **状态查询**：通过`getSignFlowStatus`方法查询爱签平台的合同状态（0:待签, 1:签署中, 2:已完成等）。
- **状态同步**：爱签的`contract-callback`回调会触发本地数据库的状态更新。
- **前端动态状态**：前端根据爱签的原始状态计算出更友好的状态文本，如"匹配中"、"签约中"、"已签约"。

**组件来源**
- [esign.service.ts](file://backend/src/modules/esign/esign.service.ts)
- [esign_payment_integration.js](file://backend/esign_payment_integration.js)
- [ContractStatusMini.tsx](file://frontend/src/components/ContractStatusMini.tsx)

## 依赖分析
系统依赖关系清晰，层次分明。

```mermaid
graph TD
A[前端] --> B[后端API]
B --> C[esign.service]
C --> D[爱签OpenAPI]
C --> E[数据库]
F[支付联动] --> C
F --> E
F --> G[支付网关]
H[MCP服务器] --> C
I[调试文档] --> C
```

**图示来源**
- [esign.service.ts](file://backend/src/modules/esign/esign.service.ts)
- [esign_payment_integration.js](file://backend/esign_payment_integration.js)
- [mcp-esign-server.js](file://mcp-esign-server.js)

## 性能考量
- **HTTP调用**：`esign.service.ts`使用axios进行HTTP调用，设置了30秒超时。
- **日志记录**：服务在关键步骤记录日志，便于调试，但需注意生产环境的日志级别。
- **模拟模式**：当私钥未配置时，服务会返回模拟数据，这在开发和测试中很有用，但在生产环境中必须禁用。

## 故障排除指南
根据`调试文档.md`和代码分析，常见问题及解决方法如下：

1.  **签名验证失败**：
    *   **原因**：私钥或公钥配置错误。
    *   **排查**：检查`ESIGN_PRIVATE_KEY`和`ESIGN_PUBLIC_KEY`环境变量，确保格式正确（包含`-----BEGIN PRIVATE KEY-----`等前后缀）。

2.  **API连接失败**：
    *   **原因**：域名配置错误或网络不通。
    *   **排查**：使用`testConnection`方法测试连接。检查`ESIGN_HOST`环境变量，沙箱环境为`https://prev.asign.cn`，生产环境为`https://oapi.asign.cn`。

3.  **模板预览失败**：
    *   **原因**：模板ID错误或网络问题。
    *   **排查**：首先调用`getTemplateList`确认模板存在。服务会尝试多种方式生成预览，可检查日志中的错误信息。

4.  **回调未收到或验证失败**：
    *   **原因**：`notifyUrl`配置错误或服务器防火墙阻止。
    *   **排查**：检查`ESIGN_NOTIFY_URL`是否可从公网访问。使用`getDebugConfig`确认配置。

5.  **支付联动不工作**：
    *   **原因**：合同ID未正确注入到跳转链接。
    *   **排查**：检查`esign_payment_integration.js`中`updateEsignContractRedirectUrl`的调用逻辑。

**组件来源**
- [调试文档.md](file://爱签SDK/调试说明文档Markdown/调试文档.md)
- [esign.service.ts](file://backend/src/modules/esign/esign.service.ts)
- [esign_payment_integration.js](file://backend/esign_payment_integration.js)

## 结论
本集成方案通过`esign.service.ts`实现了与爱签平台的稳定对接，涵盖了合同创建、状态查询、回调处理等核心功能。通过`esign_payment_integration.js`实现了合同与支付的无缝联动，提升了用户体验。`mcp-esign-server.js`的设计体现了良好的架构思想，实现了服务解耦。整体方案设计合理，具备良好的可维护性和扩展性。开发者在扩展新签约场景时，可参考现有模式，在`esign.service.ts`中添加新方法，并在MCP服务器中注册为新工具。