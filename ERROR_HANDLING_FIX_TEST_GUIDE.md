# 错误处理修复 - 测试指南

## 📋 测试目标

验证客户创建/编辑模块的错误处理是否正确显示错误信息。

---

## 🧪 测试场景

### 场景 1: 创建客户 - 手机号重复

**测试步骤**:
1. 登录系统
2. 进入 **客户管理** > **创建客户**
3. 填写客户信息，使用已存在的手机号（如 `13581640539`）
4. 点击 **提交**

**预期结果**:
- ✅ 显示错误提示: `该手机号已存在客户记录`
- ❌ **不应该**显示: `创建客户错误: m`

---

### 场景 2: 编辑客户 - 手机号冲突

**测试步骤**:
1. 登录系统
2. 进入 **客户管理** > 选择一个客户 > **编辑**
3. 修改手机号为其他客户已使用的手机号
4. 点击 **保存**

**预期结果**:
- ✅ 显示错误提示: `该手机号已被其他客户使用`
- ❌ **不应该**显示: `客户信息更新失败: m`

---

### 场景 3: 网络错误

**测试步骤**:
1. 登录系统
2. 断开网络连接（或停止后端服务）
3. 尝试创建客户
4. 点击 **提交**

**预期结果**:
- ✅ 显示有意义的错误提示（如 `网络错误，请检查网络连接或后端服务是否启动`）
- ❌ **不应该**显示: `创建客户错误: m` 或 `undefined`

---

### 场景 4: 验证错误

**测试步骤**:
1. 登录系统
2. 进入 **客户管理** > **创建客户**
3. 填写无效的数据（如手机号格式错误）
4. 点击 **提交**

**预期结果**:
- ✅ 显示清晰的验证错误提示
- ✅ 错误信息应该是中文且易于理解

---

## 🔍 验证要点

### 1. 错误信息完整性
- [ ] 错误信息是完整的句子，不是单个字母或 `undefined`
- [ ] 错误信息是中文
- [ ] 错误信息准确描述了问题

### 2. 用户体验
- [ ] 错误提示使用 Ant Design 的 `message.error()` 显示
- [ ] 错误提示在屏幕顶部居中显示
- [ ] 错误提示会自动消失（3秒后）

### 3. 控制台日志
- [ ] 浏览器控制台有详细的错误日志
- [ ] 错误日志包含完整的错误对象信息

---

## 🛠️ 调试方法

### 查看浏览器控制台

1. 打开浏览器开发者工具 (F12)
2. 切换到 **Console** 标签
3. 触发错误操作
4. 查看控制台输出

**正常输出示例**:
```javascript
创建客户错误: Error: 该手机号已存在客户记录
    at ...
```

**异常输出示例** (需要修复):
```javascript
创建客户错误: m
```

---

## 📊 测试结果记录

### 测试环境
- **环境**: 生产环境
- **URL**: http://crm.andejiazheng.com
- **浏览器**: Chrome / Firefox / Safari
- **测试日期**: 2025-12-16

### 测试结果

| 场景 | 状态 | 错误信息 | 备注 |
|------|------|----------|------|
| 手机号重复 | ✅ / ❌ | | |
| 手机号冲突 | ✅ / ❌ | | |
| 网络错误 | ✅ / ❌ | | |
| 验证错误 | ✅ / ❌ | | |

---

## 🔧 技术实现

### 错误处理工具

新增的 `errorHandler.ts` 提供以下功能：

```typescript
// 提取错误信息
const errorMessage = extractErrorMessage(error, '默认消息');

// 获取详细错误信息
const errorInfo = getDetailedErrorInfo(error);
// 返回: { message, status, statusText, code, details }

// 判断错误类型
isNetworkError(error)      // 网络错误
isAuthError(error)         // 认证错误
isPermissionError(error)   // 权限错误
isValidationError(error)   // 验证错误
```

### 错误信息提取优先级

1. `error.response.data.message` - API 返回的业务错误
2. `error.message` - Error 对象的消息
3. `error.toString()` - 错误对象的字符串表示
4. 默认消息 - 如"客户创建失败"

---

## 📝 常见问题

### Q1: 为什么之前显示 `m`？

**A**: 错误处理逻辑不完善，无法正确提取 API 返回的错误信息，导致显示了错误对象的某个属性片段。

### Q2: 修复后会影响其他功能吗？

**A**: 不会。修复只影响客户创建和编辑模块的错误处理，其他功能不受影响。

### Q3: 如何在其他模块使用这个错误处理工具？

**A**: 
```typescript
import { extractErrorMessage } from '@/utils/errorHandler';

try {
  // 业务逻辑
} catch (error: any) {
  const errorMessage = extractErrorMessage(error, '操作失败');
  message.error(errorMessage);
}
```

---

## ✅ 验收标准

- [ ] 所有测试场景通过
- [ ] 错误信息清晰、准确、完整
- [ ] 用户体验良好
- [ ] 控制台日志完整
- [ ] 无新增 Bug

---

## 📞 问题反馈

如发现问题，请提供：
1. 测试场景
2. 实际错误信息
3. 浏览器控制台截图
4. 操作步骤

---

**测试完成日期**: ___________  
**测试人员**: ___________  
**测试结果**: ✅ 通过 / ❌ 未通过

