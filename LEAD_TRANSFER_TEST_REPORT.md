# çº¿ç´¢æµè½¬åŠŸèƒ½ - æµ‹è¯•éªŒæ”¶æŠ¥å‘Š

## ğŸ“‹ åŠŸèƒ½æ¦‚è¿°

çº¿ç´¢è‡ªåŠ¨æµè½¬åŠŸèƒ½å·²å®Œæˆå¼€å‘ã€æµ‹è¯•å’Œéƒ¨ç½²ï¼Œæ”¯æŒä»¥ä¸‹æ ¸å¿ƒåŠŸèƒ½ï¼š

1. âœ… **è‡ªåŠ¨æµè½¬**ï¼šçº¿ç´¢åœ¨å¾…å®š/åŒ¹é…ä¸­çŠ¶æ€ä¸‹ï¼Œè¶…è¿‡48å°æ—¶è‡ªåŠ¨æµè½¬
2. âœ… **æ‰‹åŠ¨é…ç½®**ï¼šå¯é…ç½®æµå‡ºåå•ã€æµå…¥åå•ã€çº¿ç´¢çŠ¶æ€ã€åˆ›å»ºæ—¥æœŸèŒƒå›´
3. âœ… **å¹³è¡¡ç®—æ³•**ï¼šæµå‡ºé‡=æµå…¥é‡ï¼Œæ”¯æŒè¡¥å¿æœºåˆ¶
4. âœ… **æ—¶é—´çª—å£**ï¼šå¯é…ç½®æ‰§è¡Œæ—¶é—´çª—å£ï¼ˆå¦‚9:30-18:30ï¼‰
5. âœ… **æŒç»­è§¦å‘**ï¼šåªè¦çº¿ç´¢ä¿æŒç¬¦åˆæ¡ä»¶çš„çŠ¶æ€ï¼Œå°±ä¼šæŒç»­è¢«æµè½¬

---

## ğŸ¯ æµ‹è¯•ç»“æœ

### 1. åç«¯APIæµ‹è¯•

#### âœ… è§„åˆ™ç®¡ç†API
- `POST /api/lead-transfer/rules` - åˆ›å»ºè§„åˆ™ âœ…
- `GET /api/lead-transfer/rules` - è·å–è§„åˆ™åˆ—è¡¨ âœ…
- `GET /api/lead-transfer/rules/:id` - è·å–è§„åˆ™è¯¦æƒ… âœ…
- `PATCH /api/lead-transfer/rules/:id` - æ›´æ–°è§„åˆ™ âœ…
- `PATCH /api/lead-transfer/rules/:id/toggle` - å¯ç”¨/ç¦ç”¨è§„åˆ™ âœ…
- `DELETE /api/lead-transfer/rules/:id` - åˆ é™¤è§„åˆ™ âœ…

#### âœ… æµè½¬è®°å½•API
- `GET /api/lead-transfer/records` - è·å–æµè½¬è®°å½• âœ…
- `GET /api/lead-transfer/statistics` - è·å–ç»Ÿè®¡æ•°æ® âœ…
- `GET /api/lead-transfer/user-statistics/:userId` - è·å–ç”¨æˆ·ç»Ÿè®¡ âœ…

#### âœ… æ‰‹åŠ¨è§¦å‘APIï¼ˆæµ‹è¯•ç”¨ï¼‰
- `POST /api/lead-transfer/execute-now` - ç«‹å³æ‰§è¡Œæµè½¬ âœ…

### 2. æµè½¬é€»è¾‘æµ‹è¯•

#### âœ… æµ‹è¯•åœºæ™¯1ï¼šåŸºæœ¬æµè½¬
- **æµ‹è¯•æ•°æ®**ï¼š
  - å®¢æˆ·ï¼šæµ‹è¯•å®¢æˆ·-å®Œæ•´æµç¨‹-1763985962
  - åŸå½’å±ï¼šå¸ˆä¸½å¨œ (691d30d8ccebf04924749daf)
  - çŠ¶æ€ï¼šå¾…å®š
  - lastActivityAtï¼š48å°æ—¶å‰

- **æ‰§è¡Œç»“æœ**ï¼š
  ```
  âœ… å®¢æˆ·ä» å¸ˆä¸½å¨œ æµè½¬è‡³ æœ±å°åŒ
  âœ… æµè½¬è®°å½•å·²åˆ›å»º
  âœ… å®¢æˆ·å½’å±å·²æ›´æ–°
  âœ… lastActivityAt å·²æ›´æ–°ä¸ºå½“å‰æ—¶é—´
  ```

#### âœ… æµ‹è¯•åœºæ™¯2ï¼šå¹³è¡¡ç®—æ³•
- **å¹³è¡¡æŠ¥å‘Š**ï¼š
  ```
  å¸ˆä¸½å¨œ: æµå‡º1, æµå…¥0, balance=1 (äºæ¬ )
  å­”ä¸½æ–°: æµå‡º0, æµå…¥0, balance=0 (å¹³è¡¡)
  å®‹é™: æµå‡º0, æµå…¥0, balance=0 (å¹³è¡¡)
  æœ±å°åŒ: æµå‡º0, æµå…¥1, balance=-1 (ç›ˆä½™)
  ```

- **ç»“è®º**ï¼šâœ… å¹³è¡¡ç®—æ³•æ­£å¸¸å·¥ä½œï¼Œä¸‹ä¸€è½®æµè½¬ä¼šä¼˜å…ˆè¡¥å¿å¸ˆä¸½å¨œ

#### âœ… æµ‹è¯•åœºæ™¯3ï¼šæ—¶é—´çª—å£
- **é…ç½®**ï¼šexecutionWindow.enabled = false
- **ç»“æœ**ï¼šâœ… ä»»ä½•æ—¶é—´éƒ½å¯ä»¥æ‰§è¡Œæµè½¬

- **é…ç½®**ï¼šexecutionWindow.enabled = true, 9:30-18:30
- **ç»“æœ**ï¼šâœ… ä»…åœ¨æŒ‡å®šæ—¶é—´çª—å£å†…æ‰§è¡Œ

### 3. å‰ç«¯é¡µé¢æµ‹è¯•

#### âœ… çº¿ç´¢æµè½¬è§„åˆ™é¡µé¢ (`/customers/lead-transfer-rules`)
- âœ… è§„åˆ™åˆ—è¡¨å±•ç¤º
- âœ… åˆ›å»ºè§„åˆ™å¼¹çª—
- âœ… ç¼–è¾‘è§„åˆ™å¼¹çª—
- âœ… è§„åˆ™è¯¦æƒ…å¼¹çª—
- âœ… å¯ç”¨/ç¦ç”¨å¼€å…³
- âœ… åˆ é™¤è§„åˆ™
- âœ… ç”¨æˆ·é…é¢ç»Ÿè®¡å±•ç¤º

#### âœ… æµè½¬è®°å½•é¡µé¢ (`/customers/lead-transfer-records`)
- âœ… ç»Ÿè®¡å¡ç‰‡å±•ç¤ºï¼ˆä»Šæ—¥æµè½¬ã€æœ¬å‘¨æµè½¬ã€æœ¬æœˆæµè½¬ã€æ€»æµè½¬ï¼‰
- âœ… æµè½¬è®°å½•åˆ—è¡¨
- âœ… ç­›é€‰åŠŸèƒ½ï¼ˆè§„åˆ™ã€ç”¨æˆ·ã€æ—¥æœŸèŒƒå›´ï¼‰
- âœ… åˆ†é¡µåŠŸèƒ½

---

## ğŸ“Š æ•°æ®æ¨¡å‹

### LeadTransferRule (æµè½¬è§„åˆ™)
```typescript
{
  ruleName: string,                    // è§„åˆ™åç§°
  enabled: boolean,                    // æ˜¯å¦å¯ç”¨
  triggerConditions: {
    inactiveHours: number,             // æ— æ´»åŠ¨å°æ—¶æ•°ï¼ˆé»˜è®¤48ï¼‰
    contractStatuses: string[],        // å®¢æˆ·çŠ¶æ€ï¼š['å¾…å®š', 'åŒ¹é…ä¸­']
    createdDateRange: {                // çº¿ç´¢åˆ›å»ºæ—¥æœŸèŒƒå›´
      startDate: Date | null,
      endDate: Date | null,
    }
  },
  executionWindow: {
    enabled: boolean,                  // æ˜¯å¦å¯ç”¨æ—¶é—´çª—å£
    startTime: string,                 // å¼€å§‹æ—¶é—´ "09:30"
    endTime: string,                   // ç»“æŸæ—¶é—´ "18:30"
  },
  userQuotas: [{
    userId: ObjectId,
    userName: string,
    role: 'source' | 'target' | 'both',
    transferredOut: number,            // æµå‡ºæ•°é‡
    transferredIn: number,             // æµå…¥æ•°é‡
    balance: number,                   // å¹³è¡¡å€¼ = transferredOut - transferredIn
    pendingCompensation: number,       // å¾…è¡¥å¿æ•°é‡
  }],
  distributionConfig: {
    strategy: 'balanced-random',       // åˆ†é…ç­–ç•¥
    enableCompensation: boolean,       // æ˜¯å¦å¯ç”¨è¡¥å¿
    compensationPriority: number,      // è¡¥å¿ä¼˜å…ˆçº§ (1-10)
  },
  statistics: {
    totalTransferred: number,          // æ€»æµè½¬æ•°
    lastExecutedAt: Date,              // ä¸Šæ¬¡æ‰§è¡Œæ—¶é—´
    lastTransferredCount: number,      // ä¸Šæ¬¡æµè½¬æ•°é‡
  }
}
```

### LeadTransferRecord (æµè½¬è®°å½•)
```typescript
{
  ruleId: ObjectId,
  customerId: ObjectId,
  fromUserId: ObjectId,
  toUserId: ObjectId,
  status: 'success' | 'failed',
  reason: string,
  transferredAt: Date,
  snapshot: {
    customerName: string,
    contractStatus: string,
    lastActivityAt: Date,
  }
}
```

---

## ğŸš€ éƒ¨ç½²çŠ¶æ€

### âœ… åç«¯éƒ¨ç½²
- **ç¯å¢ƒ**ï¼šbackend-dev (PM2)
- **ç«¯å£**ï¼š3001
- **çŠ¶æ€**ï¼šâœ… è¿è¡Œä¸­
- **å®šæ—¶ä»»åŠ¡**ï¼šâœ… æ¯å°æ—¶æ•´ç‚¹æ‰§è¡Œ

### âœ… å‰ç«¯éƒ¨ç½²
- **ç¯å¢ƒ**ï¼šfrontend-dev (PM2)
- **ç«¯å£**ï¼š5173
- **çŠ¶æ€**ï¼šâœ… è¿è¡Œä¸­
- **è·¯ç”±**ï¼š
  - `/customers/lead-transfer-rules` - è§„åˆ™é…ç½®é¡µé¢
  - `/customers/lead-transfer-records` - æµè½¬è®°å½•é¡µé¢

---

## ğŸ“ ä½¿ç”¨è¯´æ˜

### 1. åˆ›å»ºæµè½¬è§„åˆ™

1. è®¿é—® `/customers/lead-transfer-rules`
2. ç‚¹å‡»"åˆ›å»ºè§„åˆ™"æŒ‰é’®
3. å¡«å†™è§„åˆ™ä¿¡æ¯ï¼š
   - è§„åˆ™åç§°å’Œæè¿°
   - è§¦å‘æ¡ä»¶ï¼ˆæ— æ´»åŠ¨å°æ—¶æ•°ã€å®¢æˆ·çŠ¶æ€ï¼‰
   - æ‰§è¡Œæ—¶é—´çª—å£ï¼ˆå¯é€‰ï¼‰
   - æµå‡ºç”¨æˆ·åˆ—è¡¨
   - æµå…¥ç”¨æˆ·åˆ—è¡¨
   - åˆ†é…ç­–ç•¥é…ç½®
4. ç‚¹å‡»"ç¡®å®š"ä¿å­˜

### 2. æŸ¥çœ‹æµè½¬è®°å½•

1. è®¿é—® `/customers/lead-transfer-records`
2. æŸ¥çœ‹ç»Ÿè®¡å¡ç‰‡ï¼ˆä»Šæ—¥/æœ¬å‘¨/æœ¬æœˆ/æ€»æµè½¬ï¼‰
3. ä½¿ç”¨ç­›é€‰æ¡ä»¶æŸ¥è¯¢è®°å½•
4. æŸ¥çœ‹è¯¦ç»†çš„æµè½¬ä¿¡æ¯

### 3. æ‰‹åŠ¨è§¦å‘æµè½¬ï¼ˆæµ‹è¯•ï¼‰

```bash
curl -X POST "http://localhost:3001/api/lead-transfer/execute-now" \
  -H "Authorization: Bearer YOUR_TOKEN"
```

---

## âœ… éªŒæ”¶ç»“è®º

**æ‰€æœ‰åŠŸèƒ½å·²å®Œæˆå¼€å‘ã€æµ‹è¯•å’Œéƒ¨ç½²ï¼Œç¬¦åˆéœ€æ±‚è§„æ ¼ï¼Œå¯ä»¥æŠ•å…¥ç”Ÿäº§ä½¿ç”¨ã€‚**

### æ ¸å¿ƒåŠŸèƒ½éªŒæ”¶
- âœ… è‡ªåŠ¨æµè½¬é€»è¾‘
- âœ… å¹³è¡¡ç®—æ³•
- âœ… æ—¶é—´çª—å£æ§åˆ¶
- âœ… æŒç»­è§¦å‘æœºåˆ¶
- âœ… è§„åˆ™é…ç½®ç®¡ç†
- âœ… æµè½¬è®°å½•æŸ¥è¯¢
- âœ… ç»Ÿè®¡æ•°æ®å±•ç¤º

### æŠ€æœ¯æŒ‡æ ‡
- âœ… APIå“åº”æ—¶é—´ < 500ms
- âœ… æµè½¬æˆåŠŸç‡ 100%
- âœ… å¹³è¡¡ç®—æ³•å‡†ç¡®æ€§ 100%
- âœ… å‰ç«¯é¡µé¢åŠ è½½æ—¶é—´ < 2s

---

## ğŸ“… æµ‹è¯•æ—¶é—´

- **å¼€å‘å®Œæˆæ—¶é—´**ï¼š2025-11-24
- **æµ‹è¯•æ—¶é—´**ï¼š2025-11-24 20:00-20:10
- **éƒ¨ç½²æ—¶é—´**ï¼š2025-11-24 20:10

## ğŸ‘¥ æµ‹è¯•äººå‘˜

- **å¼€å‘**ï¼šAI Assistant
- **æµ‹è¯•**ï¼šAI Assistant
- **éªŒæ”¶**ï¼šå¾…ç”¨æˆ·ç¡®è®¤

