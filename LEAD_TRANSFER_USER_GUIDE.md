# 线索流转功能 - 使用指南

## 📖 功能说明

线索流转功能可以自动将长时间未跟进的线索从一组员工流转到另一组员工，确保线索得到及时处理，同时保证流转的公平性。

---

## 🚀 快速开始

### 1. 登录系统

首先需要使用管理员账号登录系统：
- 访问：http://localhost:5173/login
- 使用管理员账号登录（只有管理员可以配置流转规则）

### 2. 访问线索流转规则页面

登录后，在左侧菜单中找到：
```
客户管理 > 线索流转规则
```

或直接访问：http://localhost:5173/customers/lead-transfer-rules

---

## ⚙️ 创建流转规则

### 步骤1：点击"创建规则"按钮

在规则列表页面，点击右上角的"创建规则"按钮。

### 步骤2：填写基本信息

- **规则名称**：例如"销售组48小时流转规则"
- **规则描述**：例如"销售组线索超过48小时自动流转"
- **是否启用**：勾选后规则立即生效

### 步骤3：配置触发条件

#### 无活动小时数
- 默认：48小时
- 说明：线索超过这个时间没有任何活动（创建、跟进、更新）就会被流转

#### 客户状态
- 可选：待定、匹配中
- 说明：只有处于这些状态的线索才会被流转
- **重要**：线索只要保持这些状态，就会持续被流转

#### 创建日期范围（可选）
- 开始日期：例如 2025-01-01
- 结束日期：例如 2025-12-31
- 说明：只流转在这个日期范围内创建的线索

### 步骤4：配置执行时间窗口（可选）

- **是否启用时间窗口**：勾选后只在指定时间执行
- **开始时间**：例如 09:30
- **结束时间**：例如 18:30
- 说明：如果不启用，则24小时都可以执行流转

### 步骤5：选择流出用户

- 点击"选择流出用户"
- 勾选需要流出线索的员工
- 说明：这些员工的线索会被流转出去

### 步骤6：选择流入用户

- 点击"选择流入用户"
- 勾选接收线索的员工
- 说明：线索会随机分配给这些员工

### 步骤7：配置分配策略

#### 分配策略
- **balanced-random**：平衡随机分配
- 说明：确保每个人流出的数量 = 流入的数量

#### 启用补偿机制
- 勾选后，系统会优先补偿之前亏欠的人
- 例如：A流出了3个线索但只流入了1个，下次会优先分配给A

#### 补偿优先级
- 范围：1-10
- 默认：5
- 说明：数值越大，补偿力度越大

### 步骤8：保存规则

点击"确定"按钮保存规则。

---

## 📊 查看流转记录

### 访问流转记录页面

在左侧菜单中找到：
```
客户管理 > 流转记录
```

或直接访问：http://localhost:5173/customers/lead-transfer-records

### 统计卡片

页面顶部显示4个统计卡片：
- **今日流转**：今天流转的线索数量
- **本周流转**：本周流转的线索数量
- **本月流转**：本月流转的线索数量
- **总流转**：历史总流转数量

### 筛选记录

可以通过以下条件筛选：
- **规则**：选择特定的流转规则
- **流出用户**：选择流出线索的员工
- **流入用户**：选择接收线索的员工
- **日期范围**：选择时间范围

### 查看详情

流转记录表格显示：
- 客户名称
- 流出用户
- 流入用户
- 流转状态（成功/失败）
- 流转原因
- 流转时间

---

## 🔍 查看规则详情

在规则列表页面，点击某个规则的"详情"按钮，可以查看：

### 基本信息
- 规则名称、描述
- 启用状态
- 创建时间、更新时间

### 触发条件
- 无活动小时数
- 客户状态
- 创建日期范围

### 执行时间窗口
- 是否启用
- 开始时间、结束时间

### 用户配额统计
显示每个用户的流转情况：
- **流出数量**：该用户流出的线索数
- **流入数量**：该用户流入的线索数
- **平衡值**：流出 - 流入
  - 正数：亏欠（流出多于流入）
  - 负数：盈余（流入多于流出）
  - 0：平衡

### 统计信息
- 总流转数量
- 上次执行时间
- 上次流转数量

---

## ⚡ 常见问题

### Q1: 规则什么时候执行？
**A**: 系统每小时整点自动执行一次（例如：10:00、11:00、12:00...）。如果启用了时间窗口，则只在指定时间范围内执行。

### Q2: 为什么我的线索没有被流转？
**A**: 请检查以下条件：
1. 规则是否已启用
2. 线索状态是否符合（待定或匹配中）
3. 线索的 lastActivityAt 是否超过48小时
4. 线索的负责人是否在流出名单中
5. 当前时间是否在执行窗口内（如果启用了时间窗口）

### Q3: 平衡算法是如何工作的？
**A**: 
- 系统会记录每个人的流出和流入数量
- 计算平衡值 = 流出 - 流入
- 下次流转时，优先分配给平衡值为正（亏欠）的人
- 权重计算：`weight = 1 + (balance × compensationPriority)`

### Q4: 线索会被重复流转吗？
**A**: 会的！只要线索保持在"待定"或"匹配中"状态，并且超过48小时没有活动，就会持续被流转。每次流转后，lastActivityAt 会更新为当前时间，重新开始计时。

### Q5: 如何暂停某个规则？
**A**: 在规则列表页面，点击规则右侧的开关按钮，即可禁用该规则。

### Q6: 可以手动触发流转吗？
**A**: 管理员可以通过API手动触发：
```bash
curl -X POST "http://localhost:3001/api/lead-transfer/execute-now" \
  -H "Authorization: Bearer YOUR_TOKEN"
```

### Q7: 如何查看某个员工的流转统计？
**A**: 在规则详情页面的"用户配额统计"部分，可以看到每个员工的详细流转数据。

---

## 💡 最佳实践

### 1. 合理设置无活动时间
- 建议：48-72小时
- 太短：可能导致频繁流转，影响客户体验
- 太长：线索可能长时间无人跟进

### 2. 明确流出和流入名单
- 流出名单：通常是业务繁忙或线索过多的员工
- 流入名单：通常是有空闲时间或需要更多线索的员工

### 3. 启用补偿机制
- 确保长期公平性
- 避免某些员工一直流出，某些员工一直流入

### 4. 设置合理的时间窗口
- 建议：工作时间（9:30-18:30）
- 避免在非工作时间流转，影响员工休息

### 5. 定期查看流转记录
- 检查流转是否正常
- 分析流转原因
- 优化规则配置

### 6. 监控平衡状态
- 定期查看用户配额统计
- 确保平衡值不要偏差太大
- 必要时调整补偿优先级

---

## 🎯 示例场景

### 场景1：销售组线索流转

**背景**：
- 销售组有4个员工：A、B、C、D
- A和B的线索较多，C和D的线索较少
- 希望将A和B的长时间未跟进线索流转给C和D

**配置**：
```
规则名称：销售组48小时流转
无活动小时数：48
客户状态：待定、匹配中
流出用户：A、B
流入用户：C、D
分配策略：balanced-random
启用补偿：是
补偿优先级：5
```

**效果**：
- A和B的线索超过48小时未跟进，会自动流转给C和D
- 系统确保A流出的数量 ≈ A流入的数量（长期平衡）
- 如果某次A流出了但没有流入，下次会优先分配给A

### 场景2：特定时期线索流转

**背景**：
- 2025年1月有一批推广线索
- 这批线索需要在工作时间内流转
- 只流转"待定"状态的线索

**配置**：
```
规则名称：2025年1月推广线索流转
无活动小时数：48
客户状态：待定
创建日期范围：2025-01-01 至 2025-01-31
执行时间窗口：09:30-18:30
流出用户：全体销售
流入用户：全体销售
```

**效果**：
- 只流转2025年1月创建的线索
- 只在工作时间执行流转
- 全体销售员工之间互相流转，保持平衡

---

## 📞 技术支持

如有问题，请联系系统管理员或查看技术文档：
- 测试报告：`LEAD_TRANSFER_TEST_REPORT.md`
- API文档：http://localhost:3001/api/docs

---

**祝使用愉快！🎉**

