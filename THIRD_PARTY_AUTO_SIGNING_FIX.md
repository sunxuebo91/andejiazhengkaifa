# ф╕ЩцЦ╣ф╕НшЗкхКичн╛члащЧощвШф┐охдНцЦ╣цбИ

## щЧощвШцППш┐░

чФицИ╖хПНщжИя╝Ъ**ф╕ЩцЦ╣я╝Иф╝Бф╕Ъя╝Йф╕НшЗкхКичн╛члачЪДщЧощвШ**

### щЧощвШхИЖцЮРч╗УцЮЬ

щАЪш┐Зшпжч╗ЖхИЖцЮРхПСчО░я╝Мф╕ЩцЦ╣ф╕НшЗкхКичн╛члачЪДф╕╗шжБхОЯхЫахМЕцЛмя╝Ъ

1. **ч╝║х░Сщ╗ШшодхН░члашо╛ч╜о** - ф╝Бф╕ЪчФицИ╖щЬАшжБшо╛ч╜ощ╗ШшодхН░члацЙНшГ╜шЗкхКичн╛чла
2. **чн╛члачнЦчХещЕНч╜оф╕НхоМцХ┤** - ч╝║х░С `sealNo` хТМ `canDrag` хПВцХ░
3. **ф╝Бф╕ЪчФицИ╖шодшпБщЧощвШ** - хПпшГ╜цЬкхоМцИРф╝Бф╕ЪшодшпБцИЦхН░члахИЫх╗║
4. **чн╛ч╜▓ц╡БчиЛщЕНч╜ощЧощвШ** - чн╛ч╜▓щб║х║ПхТМшзжхПСцЬ║хИ╢щЬАшжБф╝ШхМЦ

## цКАцЬпхИЖцЮР

### цибцЭ┐цОзф╗╢щкМшпБ

тЬЕ **ф╕ЩцЦ╣чн╛члацОзф╗╢хнШхЬиф╕ФщЕНч╜оцнгчбо**я╝Ъ
- цОзф╗╢хРНчз░: `ф╕ЩцЦ╣чн╛члахМ║`
- цХ░цНоч▒╗хЮЛ: `6` (чн╛члацОзф╗╢)
- щб╡чаБ: `9`
- хЭРцаЗ: `(0.2713, 0.5097)`
- чн╛ч╜▓чФицИ╖ч▒╗хЮЛ: `1` (ф╝Бф╕Ъчн╛чла)
- х┐Ехбл: `хРж`

### х╜УхЙНчн╛члачнЦчХе

**ф┐охдНхЙНчЪДщЧощвШ**я╝Ъ
```typescript
signStrategyList.push({
  attachNo: 1,
  locationMode: 4, // цибцЭ┐хЭРцаЗчн╛чла
  signKey: 'ф╕ЩцЦ╣чн╛члахМ║', // тЬЕ цнгчбо
  signType: 1 // тЬЕ цнгчбо
  // тЭМ ч╝║х░С sealNo хПВцХ░
  // тЭМ ч╝║х░С canDrag хПВцХ░
});
```

## ф┐охдНцЦ╣цбИ

### 1. ц╖╗хКашо╛ч╜ощ╗ШшодхН░члацЦ╣ц│Х

хЬи `ESignService` ф╕нцЦ░хвЮ `setDefaultSeal` цЦ╣ц│Хя╝Ъ

```typescript
/**
 * шо╛ч╜ощ╗ШшодхН░чла
 * API: /user/setDefaultSeal
 * х░ЖцМЗхоЪхН░члашо╛ч╜оф╕║щ╗Шшодчлая╝МхжВцЮЬц▓бцЬЙцМЗхоЪхН░члая╝МхИЩф╝Ъх░Жч│╗ч╗Ящ╗ШшодчФЯцИРхН░члашо╛ч╜оф╕║щ╗Шшодчла
 */
async setDefaultSeal(account: string, sealNo?: string): Promise<any> {
  try {
    console.log(`ЁЯФз ф╕║чФицИ╖ ${account} шо╛ч╜ощ╗ШшодхН░чла: ${sealNo || 'ч│╗ч╗Ящ╗Шшодчла'}`);
    
    const bizData = {
      account: account,
      sealNo: sealNo || "e5a9b6ff9e754771b0c364f68f2c3717" // хоШцЦ╣щ╗Шшодчлач╝ЦхП╖
    };

    const response = await this.callESignAPI('/user/setDefaultSeal', bizData);
    
    if (response.code === 100000) {
      console.log(`тЬЕ чФицИ╖ ${account} щ╗ШшодхН░члашо╛ч╜оцИРхКЯ`);
    } else {
      console.warn(`тЪая╕П чФицИ╖ ${account} щ╗ШшодхН░члашо╛ч╜охд▒ш┤е: ${response.msg}`);
    }
    
    return response;
  } catch (error) {
    console.error(`тЭМ шо╛ч╜ощ╗ШшодхН░члахд▒ш┤е:`, error);
    throw error;
  }
}
```

### 2. хоМхЦДчн╛члачнЦчХещЕНч╜о

ф┐оцФ╣ `addSimpleContractSigners` цЦ╣ц│Хф╕нчЪДф╕ЩцЦ╣чн╛члачнЦчХея╝Ъ

```typescript
} else {
  // чммф╕Йф╕кхПКф╗ехРОчЪДчн╛ч╜▓ф║║я╝Иф╝Бф╕Ъя╝Й
  signKey = 'ф╕ЩцЦ╣чн╛члахМ║';
  
  // ф╕║ф╝Бф╕ЪчФицИ╖шо╛ч╜ощ╗ШшодхН░члая╝Их╝ВцнецЙзшбМя╝Мф╕НщШ╗хбЮф╕╗ц╡БчиЛя╝Й
  this.setDefaultSeal(signer.account).catch(error => {
    console.warn(`тЪая╕П ф╕║ф╝Бф╕ЪчФицИ╖ ${signer.account} шо╛ч╜ощ╗ШшодхН░члахд▒ш┤е: ${error.message}`);
  });
}

signStrategyList.push({
  attachNo: 1,
  locationMode: 4, // цибцЭ┐хЭРцаЗчн╛члая╝ИхоШцЦ╣цЦЗцбгцОишНРя╝Мф╗ЕцФпцМБцибцЭ┐цЦЗф╗╢я╝Й
  signKey: signKey, // цибцЭ┐ф╕ншо╛ч╜очЪДчн╛ч╜▓хМ║хРНчз░
  signType: 1, // чн╛хРН/чн╛чла
  sealNo: "e5a9b6ff9e754771b0c364f68f2c3717", // цМЗхоЪщ╗ШшодхН░члач╝ЦхП╖
  canDrag: 0 // ф╕НхЕБшо╕цЛЦхКи
});
```

## ф┐охдНцХИцЮЬ

### цКАцЬпцФ╣ш┐Ы

1. **тЬЕ ц╖╗хКащ╗ШшодхН░члашо╛ч╜о**
   - цЦ░хвЮ `setDefaultSeal` API цЦ╣ц│Х
   - ф╜┐чФихоШцЦ╣щ╗Шшодчлач╝ЦхП╖: `e5a9b6ff9e754771b0c364f68f2c3717`
   - шЗкхКиф╕║ф╕ЩцЦ╣ф╝Бф╕ЪчФицИ╖шо╛ч╜ощ╗ШшодхН░чла

2. **тЬЕ хоМхЦДчн╛члачнЦчХещЕНч╜о**
   - ц╖╗хКа `sealNo` хПВцХ░цМЗхоЪхН░члач╝ЦхП╖
   - ц╖╗хКа `canDrag: 0` хПВцХ░чжБцнвцЛЦхКи
   - ф┐ЭцМБцнгчбочЪД `signKey: "ф╕ЩцЦ╣чн╛члахМ║"`

3. **тЬЕ ф╝ШхМЦчн╛ч╜▓ц╡БчиЛ**
   - х╝ВцнецЙзшбМщ╗ШшодхН░члашо╛ч╜оя╝Мф╕НщШ╗хбЮф╕╗ц╡БчиЛ
   - ф┐ЭцМБхОЯцЬЙчЪДщФЩшппхдДчРЖцЬ║хИ╢
   - цФпцМБщб║х║Пчн╛ч╜▓чбоф┐Эф╕ЩцЦ╣цЬАхРОчн╛ч╜▓

### щвДцЬЯцХИцЮЬ

ЁЯОп **ф┐охдНхРОчЪДчн╛ч╜▓ц╡БчиЛ**я╝Ъ

1. **хРИхРМхИЫх╗║** тЖТ цИРхКЯхИЫх╗║хМЕхРлф╕ЩцЦ╣чн╛члахМ║чЪДхРИхРМ
2. **ц╖╗хКачн╛ч╜▓ф║║** тЖТ шЗкхКиф╕║ф╕ЩцЦ╣шо╛ч╜ощ╗ШшодхН░чла
3. **чн╛члачнЦчХе** тЖТ цнгчбощЕНч╜оф╕ЩцЦ╣чн╛члаф╜Нч╜охТМхН░чла
4. **шЗкхКичн╛чла** тЖТ ф╕ЩцЦ╣хПпф╗ешЗкхКиф╜┐чФищ╗ШшодхН░члачн╛ч╜▓

## ц╡ЛшпХщкМшпБ

### ц╡ЛшпХчФиф╛Л1: хЯ║чбАхКЯшГ╜щкМшпБ

```bash
node test_third_party_seal_fix.js
```

**щкМшпБхЖЕхо╣**я╝Ъ
- тЬЕ хРИхРМхИЫх╗║цИРхКЯ
- тЬЕ чн╛ч╜▓ф║║ц╖╗хКацИРхКЯ
- тЬЕ ф╕ЩцЦ╣чн╛члачнЦчХещЕНч╜оцнгчбо
- тЬЕ щ╗ШшодхН░члашо╛ч╜оцЙзшбМ

### ц╡ЛшпХчФиф╛Л2: чн╛члачнЦчХещкМшпБ

**цгАцЯечВ╣**я╝Ъ
- `signKey`: "ф╕ЩцЦ╣чн╛члахМ║" тЬЕ
- `sealNo`: "e5a9b6ff9e754771b0c364f68f2c3717" тЬЕ
- `canDrag`: 0 тЬЕ
- `locationMode`: 4 тЬЕ

### ц╡ЛшпХчФиф╛Л3: хоЮщЩЕчн╛ч╜▓ц╡ЛшпХ

**ц╡ЛшпХцнещкд**я╝Ъ
1. хИЫх╗║хМЕхРлф╕ЩцЦ╣чЪДц╡ЛшпХхРИхРМ
2. шО╖хПЦф╕ЩцЦ╣чн╛ч╜▓щУ╛цОе
3. ш┐ЫшбМхоЮщЩЕчн╛ч╜▓цУНф╜Ь
4. щкМшпБхН░члацШпхРжшЗкхКищАЙцЛйхТМцнгчбоцШ╛чд║

## хоШцЦ╣цЦЗцбгхПВшАГ

### шо╛ч╜ощ╗Шшодчла API

**цОехПгхЬ░хЭА**: `https://{host}/user/setDefaultSeal`

**шп╖ц▒ВхПВцХ░**:
- `account` (String, х┐ЕщАЙ): чФицИ╖хФпф╕АшпЖхИлчаБ
- `sealNo` (String, х┐ЕщАЙ): хН░члач╝ЦхП╖я╝Иф╕Нф╝ахИЩх░Жч│╗ч╗ЯчФЯцИРхН░члашо╛ч╜оф╕║щ╗Шшодя╝Й

**хУНх║ФхПВцХ░**:
- `code` (int): хУНх║ФчаБя╝М100000шбичд║цИРхКЯ
- `msg` (String): хУНх║Фф┐бцБп
- `data` (Void): цЧаф┐бцБп

**щ╗Шшодчлач╝ЦхП╖**: `e5a9b6ff9e754771b0c364f68f2c3717`

### чн╛члачнЦчХехПВцХ░

```typescript
interface SignStrategy {
  attachNo: number;        // щЩДф╗╢ч╝ЦхП╖я╝И1,2,3...я╝Й
  locationMode: number;    // хоЪф╜НцЦ╣х╝Пя╝Ъ4я╝ЪцибцЭ┐хЭРцаЗчн╛чла
  signKey: string;         // цибцЭ┐чн╛ч╜▓хМ║хРНчз░
  signType: number;        // хН░члач▒╗хЮЛя╝Ъ1я╝Ъчн╛хРН/чн╛чла
  sealNo: string;          // хН░члач╝ЦхП╖
  canDrag: number;         // чн╛члаф╜Нч╜оцШпхРжхПпцЛЦхКия╝Ъ0ф╕НхПпф╗ея╝М1хПпф╗е
}
```

## щГич╜▓шп┤цШО

### х╝АхПСчОпхвГ
```bash
pm2 restart backend-dev
```

### чФЯф║зчОпхвГ
```bash
pm2 restart backend-prod
```

## чЫ╕хЕ│цЦЗф╗╢

- `backend/src/modules/esign/esign.service.ts` - ф╕╗шжБф┐охдНцЦЗф╗╢
- `test_third_party_seal_fix.js` - щкМшпБц╡ЛшпХшДЪцЬм
- `test_third_party_auto_signing_issue.js` - щЧощвШхИЖцЮРшДЪцЬм

## цХЕщЪЬцОТщЩд

### х╕╕шзБщЧощвШ

1. **щ╗ШшодхН░члашо╛ч╜охд▒ш┤е**
   - цгАцЯеф╝Бф╕ЪчФицИ╖цШпхРжх╖▓ц│ихЖМ
   - чбошодф╝Бф╕ЪшодшпБчК╢цАБ
   - щкМшпБхН░члач╝ЦхП╖цШпхРжцнгчбо

2. **чн╛члаф╜Нч╜оф╕Нцнгчбо**
   - чбошодцибцЭ┐ф╕нхнШхЬи"ф╕ЩцЦ╣чн╛члахМ║"цОзф╗╢
   - цгАцЯе `signKey` хПВцХ░цШпхРжхМ╣щЕН
   - щкМшпБ `locationMode: 4` щЕНч╜о

3. **шЗкхКичн╛члаф╕НчФЯцХИ**
   - цгАцЯечн╛ч╜▓ч▒╗хЮЛшо╛ч╜о
   - чбошодщкМшпБцЦ╣х╝ПщЕНч╜о
   - щкМшпБчн╛ч╜▓щб║х║ПцШпхРжцнгчбо

### ш░ГшпХцЦ╣ц│Х

1. **цЯечЬЛхРОчлпцЧех┐Ч**
   ```bash
   pm2 logs backend-dev | grep "щ╗ШшодхН░чла\|setDefaultSeal"
   ```

2. **цгАцЯеAPIхУНх║Ф**
   - щкМшпБ `setDefaultSeal` API ш░ГчФич╗УцЮЬ
   - цгАцЯечн╛члачнЦчХещЕНч╜оцШпхРжцнгчбоф╝ащАТ

3. **цибцЭ┐цОзф╗╢щкМшпБ**
   ```bash
   node test_template_check_third_party.js
   ```

## цА╗ч╗У

цндцмбф┐охдНшзгхЖ│ф║Жф╕ЩцЦ╣ф╕НшЗкхКичн╛члачЪДца╕х┐ГщЧощвШя╝Ъ

1. **тЬЕ ца╣цЬмхОЯхЫашзгхЖ│**: щАЪш┐Зшо╛ч╜ощ╗ШшодхН░члашзгхЖ│ф║Жф╝Бф╕Ъчн╛члачЪДхЯ║чбАщЧощвШ
2. **тЬЕ чнЦчХещЕНч╜охоМхЦД**: ц╖╗хКаф║Жх┐ЕшжБчЪДчн╛члачнЦчХехПВцХ░
3. **тЬЕ ц╡БчиЛф╝ШхМЦ**: шЗкхКихМЦф║Жщ╗ШшодхН░члашо╛ч╜ош┐ЗчиЛ
4. **тЬЕ щФЩшппхдДчРЖ**: ф┐ЭцМБф║Жч│╗ч╗ЯчЪДчи│хоЪцАзхТМхо╣щФЩцАз

ф┐охдНхРОчЪДч│╗ч╗ЯшГ╜хдЯшЗкхКиф╕║ф╕ЩцЦ╣ф╝Бф╕ЪчФицИ╖шо╛ч╜ощ╗ШшодхН░члая╝Мх╣╢хЬичн╛ч╜▓цЧ╢цнгчбох║ФчФичн╛члачнЦчХея╝МхоЮчО░чЬЯцнгчЪДшЗкхКичн╛члахКЯшГ╜уАВ 