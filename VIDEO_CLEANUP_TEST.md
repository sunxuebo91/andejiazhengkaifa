# 视频画面卡住问题 - 测试指南

## 问题描述

当用户点击浏览器标签页的 **X** 关闭窗口时，该用户的视频画面会"卡"在其他用户的界面上，不会自动消失。

## 🎯 问题的本质（根据 ZEGO 官方文档）

根据 ZEGO 官方文档，问题的核心是：

### 1. 用户ID必须保持一致
> **同一个用户每次进入房间必须使用相同的 userID**

如果每次进入都生成新的 userID，ZEGO SDK 会认为是**不同的用户**，导致：
- ❌ 旧用户的画面不会被清理
- ❌ 新用户的画面会被创建
- ❌ 结果：同一个人出现多个画面

### 2. 重新登录的识别机制
ZEGO SDK 提供了 `relogin` 参数来识别用户状态：
- `relogin = 0`：首次登录
- `relogin = 1`：重新登录（系统识别为同一用户）

### 3. 会话管理
- 每次登录都会生成新的 `session_id`
- 但 `userID` 必须保持不变
- 这样 ZEGO SDK 才能正确识别为"同一用户重新连接"

## ✅ 最新修复方案（会话恢复机制）

### 核心方案：持久化用户ID（会话恢复）⭐⭐⭐

**实现原理**：
```typescript
// 使用 localStorage 存储访客ID
const storageKey = `guest_id_${roomId}_${userName}_${role}`;
let guestId = localStorage.getItem(storageKey);

if (!guestId || isExpired) {
  // 首次进入或ID已过期，生成新的访客ID
  guestId = `guest_${Date.now()}_${Math.random().toString(36).substring(2, 9)}`;
  localStorage.setItem(storageKey, guestId);
  console.log('✅ 首次进入，生成新访客ID:', guestId);
} else {
  // 重新进入，使用已有的访客ID（会话恢复）
  console.log('🔄 会话恢复，使用已有访客ID:', guestId);
}
```

**关键特性**：
- ✅ 同一用户使用相同的 userID
- ✅ ZEGO SDK 识别为"重新登录"（relogin = 1）
- ✅ 不会创建新用户，不会出现重复画面
- ✅ 1小时后自动过期，避免ID冲突
- ✅ 房间解散时清理，确保下次使用新ID

### 辅助方案1：beforeunload 事件监听
- 在用户关闭标签页时，使用 `navigator.sendBeacon` 立即通知后端
- 销毁 ZEGO 实例，断开 WebRTC 连接

### 辅助方案2：onUserLeave 回调 + 调试日志
- 当 ZEGO SDK 检测到用户离开时，打印详细的调试信息
- 使用多种选择器查找视频元素
- 如果第一次没找到，3秒后自动重试

### 辅助方案3：定期清理任务（仅HR端）
- 每3秒检查一次是否有残留的视频元素
- 对比参与者列表，删除不在列表中的视频元素

## 测试步骤

### 🔥 测试1：会话恢复（最核心的测试）

这是验证问题是否解决的**最关键测试**！

1. **准备**：
   - HR 创建房间并进入
   - 访客A 通过邀请链接进入房间（使用姓名"张三"，角色"客户"）
   - 确认双方都能看到对方的视频画面

2. **执行**：
   - 访客A 点击浏览器标签页的 **X** 关闭窗口
   - 等待 3-5 秒（让 ZEGO SDK 检测到断线）
   - 访客A 重新打开邀请链接
   - **使用相同的姓名"张三"和角色"客户"** 进入房间

3. **预期结果（关键）**：
   - ✅ 访客A 应该能正常进入房间
   - ✅ **不应该出现两个"张三"的画面**
   - ✅ 控制台应该显示：
     ```
     🔄 会话恢复，使用已有访客ID: guest_1234567890_abc123
     ```
   - ✅ ZEGO SDK 应该识别为"重新登录"（relogin = 1）

4. **如果失败（出现重复画面）**：
   - 检查控制台是否显示 `✅ 首次进入，生成新访客ID`（这是错误的！）
   - 检查 localStorage 中是否有对应的 `guest_id_...` 键
   - 检查是否超过1小时（ID会过期）

### 测试2：点击 X 关闭标签页（画面清理）

1. **准备**：
   - HR 创建房间并进入
   - 访客A 通过邀请链接进入房间
   - 确认双方都能看到对方的视频画面

2. **执行**：
   - 访客A 点击浏览器标签页的 **X** 关闭窗口
   - **不要点击"挂断"按钮**

3. **预期结果**：
   - HR 端应该在 **3-5秒内** 看到访客A的画面消失
   - 浏览器控制台应该显示：
     ```
     🔧 用户离开房间: [{userID: "...", userName: "访客A"}]
     🔍 开始清理用户 访客A (...) - 尝试1
     📊 容器内所有元素数量: ...
     📹 找到的 video 元素: ...
     ```

4. **如果失败**：
   - 检查控制台是否有 `⚠️ 未找到用户 ... 的视频元素` 的警告
   - 检查是否有 `🔧 发现残留视频元素，清理:` 的日志（HR端定期清理）
   - 查看打印的 video 元素信息，确认 ZEGO 使用的 DOM 结构

### 测试2：点击挂断按钮（正常流程）

1. **准备**：
   - HR 创建房间并进入
   - 访客A 通过邀请链接进入房间

2. **执行**：
   - 访客A 点击 ZEGO UI 中的"挂断"按钮

3. **预期结果**：
   - 访客A的画面应该 **立即消失**
   - 控制台应该显示正常的离开日志

### 测试3：网络断线（模拟意外断线）

1. **准备**：
   - HR 创建房间并进入
   - 访客A 通过邀请链接进入房间

2. **执行**：
   - 打开浏览器开发者工具 (F12)
   - 切换到 Network 标签
   - 选择 "Offline" 模式（模拟断网）
   - 等待几秒

3. **预期结果**：
   - ZEGO SDK 应该检测到断线
   - HR 端应该在 **5-10秒内** 看到访客A的画面消失

### 测试4：多个用户同时离开

1. **准备**：
   - HR 创建房间并进入
   - 访客A、访客B、访客C 同时进入房间

2. **执行**：
   - 访客A、访客B 同时点击 X 关闭标签页

3. **预期结果**：
   - HR 端应该看到两个用户的画面都消失
   - 访客C 的画面应该保持正常

### 测试5：快速重新进入（测试持久化ID）

1. **准备**：
   - HR 创建房间并进入
   - 访客A 通过邀请链接进入房间

2. **执行**：
   - 访客A 点击 X 关闭标签页
   - 等待画面消失
   - 访客A 重新打开邀请链接，使用 **相同的姓名和角色** 进入

3. **预期结果**：
   - 访客A 应该能正常进入
   - **不应该出现重复的画面**
   - 控制台应该显示：`✅ 重新进入，使用已有访客ID: ...`

## 调试技巧

### 1. 查看控制台日志

**关键日志标识**：
- `🔧` - 清理相关操作
- `✅` - 成功操作
- `⚠️` - 警告信息
- `❌` - 错误信息

**重要日志**：
```javascript
// 页面关闭时
🔧 检测到页面即将关闭/刷新
✅ 已发送离开房间请求（sendBeacon）
✅ ZEGO 实例已销毁（页面关闭）

// 用户离开时
🔧 用户离开房间: [{userID: "...", userName: "..."}]
✅ 清理用户 ... 的视频元素 (尝试1, 选择器: ...)

// 定期清理（HR端）
🔧 发现残留视频元素，清理: ...
```

### 2. 检查 DOM 结构

在浏览器控制台执行：
```javascript
// 查看所有视频相关元素
document.querySelectorAll('[data-userid], [id*="zego"], video')

// 查看容器内容
document.querySelector('#meeting-container').innerHTML
```

### 3. 检查参与者列表（HR端）

在 React DevTools 中查看 `VideoInterview` 组件的 `participants` 状态，确认用户离开后是否从列表中移除。

### 4. 检查后端日志

后端应该显示：
```
🔧 用户离开房间: { roomId: '...', userId: '...' }
用户 ... 离开房间: ..., 剩余人数: ...
```

## 已知问题和限制

### 1. ZEGO SDK 延迟检测
- ZEGO SDK 需要 **3-5秒** 才能检测到用户断线
- 这是 WebRTC 的正常行为，无法完全避免

### 2. DOM 选择器限制
- ZEGO UIKit 的 DOM 结构可能会变化
- 如果更新 ZEGO SDK 版本，可能需要调整选择器

### 3. sendBeacon 兼容性
- 旧版浏览器可能不支持 `navigator.sendBeacon`
- 建议使用现代浏览器测试（Chrome 90+, Firefox 88+, Safari 14+）

## 如果问题仍然存在

### 方案A：增加清理频率
修改 `VideoInterview.tsx` 中的定期清理间隔：
```javascript
// 从 3000ms 改为 1000ms
cleanupIntervalRef.current = setInterval(() => {
  // ...
}, 1000); // 每1秒检查一次
```

### 方案B：使用更激进的清理策略
在 `onUserLeave` 回调中，直接清空整个容器并重新渲染：
```javascript
onUserLeave: (users: any[]) => {
  // 清空整个容器
  if (meetingContainerRef.current) {
    meetingContainerRef.current.innerHTML = '';
  }
  // 让 ZEGO SDK 重新渲染
  // 注意：这可能会导致所有用户的画面闪烁
}
```

### 方案C：使用 ZEGO 服务端 API
调用 ZEGO 的服务端 API 强制踢出用户：
- 参考文档：https://doc-zh.zego.im/article/api?doc=Express_Video_SDK_API~ServerAPI~Java~KickOutUser
- 需要在后端实现

## 测试环境要求

- **浏览器**：Chrome 90+, Firefox 88+, Safari 14+
- **网络**：稳定的网络连接
- **设备**：至少2台设备或2个浏览器窗口（一个HR，一个访客）
- **摄像头/麦克风**：需要授权访问

## 联系支持

如果问题持续存在，请提供：
1. 浏览器控制台的完整日志
2. 问题复现的详细步骤
3. 浏览器版本和操作系统信息
4. 网络环境（是否使用VPN、代理等）

