# å°ç¨‹åºAPIå®Œæ•´æ–‡æ¡£

## ğŸ“‹ ç›®å½•

- [è®¤è¯æˆæƒ](#è®¤è¯æˆæƒ)
- [ğŸ‘¤ ç”¨æˆ·æ³¨å†Œä¸ç™»å½•](#ç”¨æˆ·æ³¨å†Œä¸ç™»å½•)
  - [ç”¨æˆ·æ³¨å†Œæˆ–æ›´æ–°](#ç”¨æˆ·æ³¨å†Œæˆ–æ›´æ–°)
  - [è®°å½•ç”¨æˆ·ç™»å½•](#è®°å½•ç”¨æˆ·ç™»å½•)
  - [è´¦å·å¯†ç ç™»å½•](#è´¦å·å¯†ç ç™»å½•)
- [Bannerè½®æ’­å›¾](#bannerè½®æ’­å›¾)
- [æ–‡ç« å†…å®¹](#æ–‡ç« å†…å®¹)
  - [è·å–æ–‡ç« åˆ—è¡¨](#è·å–æ–‡ç« åˆ—è¡¨)
  - [è·å–æ–‡ç« è¯¦æƒ…](#è·å–æ–‡ç« è¯¦æƒ…)
- [ç®€å†ç®¡ç†](#ç®€å†ç®¡ç†)
  - [åˆ›å»ºç®€å†](#åˆ›å»ºç®€å†)
  - [è·å–ç®€å†è¯¦æƒ…](#è·å–ç®€å†è¯¦æƒ…)
  - [æ›´æ–°ç®€å†](#æ›´æ–°ç®€å†)
  - [æ¨èç†ç”±æ ‡ç­¾è¯´æ˜](#æ¨èç†ç”±æ ‡ç­¾è¯´æ˜)
- [å‘˜å·¥è¯„ä»·](#å‘˜å·¥è¯„ä»·)
  - [åˆ›å»ºå‘˜å·¥è¯„ä»·](#åˆ›å»ºå‘˜å·¥è¯„ä»·)
  - [è·å–è¯„ä»·åˆ—è¡¨](#è·å–è¯„ä»·åˆ—è¡¨)
  - [è·å–è¯„ä»·ç»Ÿè®¡](#è·å–è¯„ä»·ç»Ÿè®¡)
- [ï¿½ åˆåŒç®¡ç†](#åˆåŒç®¡ç†)
  - [è·å–åˆåŒåˆ—è¡¨](#è·å–åˆåŒåˆ—è¡¨)
  - [è·å–åˆåŒè¯¦æƒ…](#è·å–åˆåŒè¯¦æƒ…)
  - [æ ¹æ®åˆåŒç¼–å·è·å–åˆåŒ](#æ ¹æ®åˆåŒç¼–å·è·å–åˆåŒ)
  - [æ ¹æ®å®¢æˆ·IDè·å–åˆåŒ](#æ ¹æ®å®¢æˆ·idè·å–åˆåŒ)
  - [æ ¹æ®æœåŠ¡äººå‘˜IDè·å–åˆåŒ](#æ ¹æ®æœåŠ¡äººå‘˜idè·å–åˆåŒ)
  - [æ ¹æ®æœåŠ¡äººå‘˜ä¿¡æ¯æœç´¢åˆåŒ](#æ ¹æ®æœåŠ¡äººå‘˜ä¿¡æ¯æœç´¢åˆåŒ)
  - [æ£€æŸ¥å®¢æˆ·ç°æœ‰åˆåŒ](#æ£€æŸ¥å®¢æˆ·ç°æœ‰åˆåŒ)
  - [è·å–å®¢æˆ·åˆåŒå†å²](#è·å–å®¢æˆ·åˆåŒå†å²)
  - [è·å–åˆåŒç»Ÿè®¡ä¿¡æ¯](#è·å–åˆåŒç»Ÿè®¡ä¿¡æ¯)
  - [åˆ›å»ºåˆåŒ](#åˆ›å»ºåˆåŒ)
  - [æ›´æ–°åˆåŒ](#æ›´æ–°åˆåŒ)
  - [åˆ›å»ºæ¢äººåˆåŒ](#åˆ›å»ºæ¢äººåˆåŒ)
  - [æ‰‹åŠ¨è§¦å‘ä¿é™©åŒæ­¥](#æ‰‹åŠ¨è§¦å‘ä¿é™©åŒæ­¥)
  - [åŒæ­¥çˆ±ç­¾åˆåŒçŠ¶æ€](#åŒæ­¥çˆ±ç­¾åˆåŒçŠ¶æ€)
  - [æ‰¹é‡åŒæ­¥æ‰€æœ‰åˆåŒçŠ¶æ€](#æ‰¹é‡åŒæ­¥æ‰€æœ‰åˆåŒçŠ¶æ€)
  - [è·å–çˆ±ç­¾ä¿¡æ¯](#è·å–çˆ±ç­¾ä¿¡æ¯)
  - [é‡æ–°è·å–ç­¾ç½²é“¾æ¥](#é‡æ–°è·å–ç­¾ç½²é“¾æ¥)
  - [ä¸‹è½½å·²ç­¾ç½²åˆåŒ](#ä¸‹è½½å·²ç­¾ç½²åˆåŒ)
- [ï¿½ğŸ›¡ï¸ ä¿é™©ä¿å•ç®¡ç†](#ä¿é™©ä¿å•ç®¡ç†)
  - [è·å–ä¿å•åˆ—è¡¨](#è·å–ä¿å•åˆ—è¡¨)
  - [æ ¹æ®èº«ä»½è¯å·æŸ¥è¯¢ä¿å•](#æ ¹æ®èº«ä»½è¯å·æŸ¥è¯¢ä¿å•)
  - [è·å–ä¿å•è¯¦æƒ…](#è·å–ä¿å•è¯¦æƒ…)
  - [æ ¹æ®ä¿å•å·æŸ¥è¯¢](#æ ¹æ®ä¿å•å·æŸ¥è¯¢)
  - [æ ¹æ®å•†æˆ·å•å·æŸ¥è¯¢](#æ ¹æ®å•†æˆ·å•å·æŸ¥è¯¢)
  - [åˆ›å»ºä¿å•ï¼ˆæŠ•ä¿ï¼‰](#åˆ›å»ºä¿å•æŠ•ä¿)
  - [æŸ¥è¯¢ä¿å•çŠ¶æ€ï¼ˆå¤§æ ‘ä¿ï¼‰](#æŸ¥è¯¢ä¿å•çŠ¶æ€å¤§æ ‘ä¿)
  - [åˆ›å»ºæ”¯ä»˜è®¢å•](#åˆ›å»ºæ”¯ä»˜è®¢å•)
  - [æ³¨é”€ä¿å•](#æ³¨é”€ä¿å•)
  - [é€€ä¿](#é€€ä¿)
  - [è·å–ç”µå­ä¿å•PDF](#è·å–ç”µå­ä¿å•pdf)
  - [æ‰¹æ”¹ä¿å•ï¼ˆæ›¿æ¢è¢«ä¿é™©äººï¼‰](#æ‰¹æ”¹ä¿å•æ›¿æ¢è¢«ä¿é™©äºº)
  - [æ‰¹å¢ï¼ˆå¢åŠ è¢«ä¿é™©äººï¼‰](#æ‰¹å¢å¢åŠ è¢«ä¿é™©äºº)
  - [åŒæ­¥ä¿å•çŠ¶æ€](#åŒæ­¥ä¿å•çŠ¶æ€)
- [æ–‡ä»¶ä¸Šä¼ ](#æ–‡ä»¶ä¸Šä¼ )
- [æ•°æ®å­—å…¸](#æ•°æ®å­—å…¸)
- [é”™è¯¯ç è¯´æ˜](#é”™è¯¯ç è¯´æ˜)

---

## ğŸ” è®¤è¯æˆæƒ

### åŸºç¡€ä¿¡æ¯

- **ç”Ÿäº§ç¯å¢ƒ**: `https://crm.andejiazheng.com/api`
- **å¼€å‘ç¯å¢ƒ**: `http://localhost:3000/api`
- **è®¤è¯æ–¹å¼**: JWT Bearer Token
- **è¯·æ±‚å¤´**: `Authorization: Bearer {token}`

### è·å–Token

```http
POST /api/auth/miniprogram/login
Content-Type: application/json

{
  "code": "å¾®ä¿¡ç™»å½•code"
}
```

**å“åº”ç¤ºä¾‹**:
```json
{
  "success": true,
  "data": {
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "user": {
      "id": "user_id",
      "openid": "openid",
      "role": "employee"
    }
  }
}
```

### ğŸ›¡ï¸ è§’è‰²æƒé™æ§åˆ¶ï¼ˆRBACï¼‰

å°ç¨‹åºAPIå®æ–½äº†åŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶ï¼ˆv1.9.0èµ·ï¼‰ï¼Œä¸åŒè§’è‰²çœ‹åˆ°çš„æ•°æ®èŒƒå›´ä¸åŒï¼š

| è§’è‰² | è‹±æ–‡æ ‡è¯† | æ•°æ®èŒƒå›´ | è¯´æ˜ |
|------|---------|---------|------|
| **ç³»ç»Ÿç®¡ç†å‘˜** | `admin` | å…¨éƒ¨æ•°æ® | å¯æŸ¥çœ‹å’Œæ“ä½œæ‰€æœ‰è®°å½• |
| **ç»ç†** | `manager` | å…¨éƒ¨æ•°æ® | å¯æŸ¥çœ‹å’Œæ“ä½œæ‰€æœ‰è®°å½• |
| **æ™®é€šå‘˜å·¥** | `employee` | ä»…è‡ªå·±çš„æ•°æ® | åªèƒ½æŸ¥çœ‹å’Œæ“ä½œè‡ªå·±åˆ›å»ºçš„è®°å½•ï¼ˆæŒ‰ `createdBy` è¿‡æ»¤ï¼‰ |

**æƒé™è§„åˆ™**ï¼š
- æ‰€æœ‰ä¸šåŠ¡æ¥å£ï¼ˆåˆåŒã€ä¿é™©ã€ç®€å†ã€å‘˜å·¥è¯„ä»·ï¼‰å‡éœ€è¦ JWT è®¤è¯
- æ¯ä¸ªè¯·æ±‚å¿…é¡»åœ¨ Header ä¸­æºå¸¦æœ‰æ•ˆçš„ `Authorization: Bearer {token}`
- æ™®é€šå‘˜å·¥åªèƒ½çœ‹åˆ°è‡ªå·±åˆ›å»ºçš„åˆåŒã€ä¿å•ç­‰æ•°æ®
- ç®¡ç†å‘˜å’Œç»ç†å¯ä»¥çœ‹åˆ°å…¨éƒ¨æ•°æ®

**å…¬å¼€æ¥å£ï¼ˆæ— éœ€Tokenï¼‰**ï¼š
- ç”¨æˆ·æ³¨å†Œ/ç™»å½•æ¥å£ï¼ˆ`/api/miniprogram-users/*`ï¼‰
- Bannerè½®æ’­å›¾ï¼ˆ`/api/banners/miniprogram/*`ï¼‰
- æ–‡ç« å†…å®¹ï¼ˆ`/api/articles/miniprogram/*`ï¼‰
- é˜¿å§¨è‡ªåŠ©æ³¨å†Œï¼ˆ`/api/resumes/miniprogram/self-register`ï¼‰
- ç®€å†åˆ†äº«é“¾æ¥ï¼ˆ`/api/resumes/shared/:token`ï¼‰

### æ¥å£è®¤è¯æ€»è§ˆ

| æ¨¡å— | è®¤è¯è¦æ±‚ | è§’è‰²è¿‡æ»¤ |
|------|---------|---------|
| ç”¨æˆ·æ³¨å†Œä¸ç™»å½• | âŒ æ— éœ€è®¤è¯ | - |
| Bannerè½®æ’­å›¾ | âŒ æ— éœ€è®¤è¯ | - |
| æ–‡ç« å†…å®¹ | âŒ æ— éœ€è®¤è¯ | - |
| ç®€å†ç®¡ç† | âœ… éœ€è¦JWTï¼ˆself-registeré™¤å¤–ï¼‰ | âœ… æ™®é€šå‘˜å·¥ä»…è‡ªå·±æ•°æ® |
| å‘˜å·¥è¯„ä»· | âœ… éœ€è¦JWT | âœ… æ™®é€šå‘˜å·¥ä»…è‡ªå·±æ•°æ® |
| åˆåŒç®¡ç† | âœ… éœ€è¦JWT | âœ… æ™®é€šå‘˜å·¥ä»…è‡ªå·±æ•°æ® |
| ä¿é™©ä¿å•ç®¡ç† | âœ… éœ€è¦JWT | âœ… æ™®é€šå‘˜å·¥ä»…è‡ªå·±æ•°æ® |

---

## ğŸ‘¤ ç”¨æˆ·æ³¨å†Œä¸ç™»å½•

å°ç¨‹åºç”¨æˆ·æ³¨å†Œä¸ç™»å½•ç®¡ç†ï¼Œç”¨äºè®°å½•ç”¨æˆ·ä¿¡æ¯å’Œç™»å½•è¡Œä¸ºã€‚

### ğŸ“± ä¸€å¥è¯æ€»ç»“

**å°ç¨‹åºç«¯ç”¨æˆ·ç®¡ç†æä¾›ä¸‰ç§ç™»å½•æ–¹å¼ï¼šï¼ˆ1ï¼‰OpenID è‡ªåŠ¨ç™»å½•ï¼ˆæ¨èï¼‰ï¼šåœ¨ `app.js` çš„ `onLaunch` ä¸­è°ƒç”¨ `POST /api/miniprogram-users/login` ä¼ å…¥ `{openid}` è‡ªåŠ¨åˆ›å»ºåŒ¿åç”¨æˆ·å¹¶è¿”å› `hasPhone` å­—æ®µæç¤ºæ˜¯å¦éœ€è¦æˆæƒæ‰‹æœºå·ï¼›ï¼ˆ2ï¼‰æ‰‹æœºå·æ³¨å†Œ/æ›´æ–°ï¼šç”¨æˆ·æˆæƒæ‰‹æœºå·åè°ƒç”¨ `POST /api/miniprogram-users/register` ä¼ å…¥ `{openid, phone, username?, password?, nickname?, avatar?, avatarFile?, gender?, city?, province?}` ç»‘å®šæ‰‹æœºå·å’Œå®Œå–„ä¿¡æ¯ï¼ˆæ”¯æŒè®¾ç½®è´¦å·å¯†ç ï¼‰ï¼›ï¼ˆ3ï¼‰è´¦å·å¯†ç ç™»å½•ï¼šç”¨æˆ·è®¾ç½®è´¦å·å¯†ç åå¯è°ƒç”¨ `POST /api/miniprogram-users/login-with-password` ä¼ å…¥ `{username, password}` ç›´æ¥ç™»å½•ã€‚æ‰€æœ‰æ¥å£éƒ½æ— éœ€ tokenï¼Œå¯†ç ä½¿ç”¨ bcrypt åŠ å¯†å­˜å‚¨ä¸”å“åº”ä¸­ä¸è¿”å›ï¼Œç³»ç»Ÿè‡ªåŠ¨è®°å½•æ³¨å†Œæ—¶é—´ã€ç™»å½•æ—¶é—´ã€ç™»å½•æ¬¡æ•°å’Œ IP åœ°å€ï¼Œåå°ç®¡ç†å‘˜å¯åœ¨"è¤“è´åå°-å°ç¨‹åºç”¨æˆ·ç®¡ç†"æŸ¥çœ‹æ‰€æœ‰ç”¨æˆ·æ•°æ®ã€ç»Ÿè®¡ä¿¡æ¯å’Œå®Œæ•´çš„ç”¨æˆ·åˆ—è¡¨ï¼ˆåŒ…æ‹¬è´¦å·ã€OpenIDã€æ‰‹æœºå·ã€å¤´åƒã€åœ°åŒºã€ç™»å½•æ¬¡æ•°ç­‰ï¼‰ã€‚**

---

### ğŸ“‹ æ¥å£åˆ—è¡¨

| æ¥å£ | æ–¹æ³• | è·¯å¾„ | è®¤è¯ | è¯´æ˜ |
|------|------|------|------|------|
| ç”¨æˆ·æ³¨å†Œæˆ–æ›´æ–° | POST | `/api/miniprogram-users/register` | âŒ æ— éœ€è®¤è¯ | æ³¨å†Œæ–°ç”¨æˆ·æˆ–æ›´æ–°ç°æœ‰ç”¨æˆ·ä¿¡æ¯ï¼ˆæ”¯æŒè®¾ç½®è´¦å·å¯†ç ï¼‰ |
| è®°å½•ç”¨æˆ·ç™»å½• | POST | `/api/miniprogram-users/login` | âŒ æ— éœ€è®¤è¯ | ä½¿ç”¨ OpenID æˆ–æ‰‹æœºå·ç™»å½•ï¼Œè‡ªåŠ¨åˆ›å»ºç”¨æˆ·ï¼ˆæ”¯æŒä¼ é€’ç”¨æˆ·ä¿¡æ¯ï¼‰ |
| è´¦å·å¯†ç ç™»å½• | POST | `/api/miniprogram-users/login-with-password` | âŒ æ— éœ€è®¤è¯ | ä½¿ç”¨è´¦å·å’Œå¯†ç ç™»å½•ï¼ŒéªŒè¯å¯†ç å¹¶è¿”å›ç”¨æˆ·ä¿¡æ¯ |

**æ³¨æ„**ï¼šä»¥ä¸Šä¸‰ä¸ªæ¥å£éƒ½æ˜¯å…¬å¼€æ¥å£ï¼Œæ— éœ€ token è®¤è¯ï¼Œé€‚åˆå°ç¨‹åºç«¯ç›´æ¥è°ƒç”¨ã€‚

---

### ç”¨æˆ·æ³¨å†Œæˆ–æ›´æ–°

ç”¨æˆ·é¦–æ¬¡ä½¿ç”¨å°ç¨‹åºæ—¶æ³¨å†Œï¼Œæˆ–æ›´æ–°ç”¨æˆ·ä¿¡æ¯ã€‚å¦‚æœæ‰‹æœºå·å·²å­˜åœ¨åˆ™æ›´æ–°ä¿¡æ¯ï¼Œä¸å­˜åœ¨åˆ™åˆ›å»ºæ–°ç”¨æˆ·ã€‚

#### è¯·æ±‚

```http
POST /api/miniprogram-users/register
Content-Type: application/json

{
  "openid": "oXXXX_xxxxxxxxxxxxx",
  "phone": "13800138000",
  "username": "user123",
  "password": "password123",
  "nickname": "å¾®ä¿¡ç”¨æˆ·",
  "avatar": "https://thirdwx.qlogo.cn/xxx.jpg",
  "avatarFile": "/uploads/avatars/user123.jpg",
  "unionid": "oXXXX_xxxxxxxxxxxxx",
  "gender": 1,
  "city": "åŒ—äº¬",
  "province": "åŒ—äº¬",
  "country": "ä¸­å›½",
  "language": "zh_CN"
}
```

**è®¤è¯**: âŒ æ— éœ€ç™»å½•ï¼ˆå…¬å¼€æ¥å£ï¼‰

#### è¯·æ±‚å‚æ•°

| å‚æ•° | ç±»å‹ | å¿…å¡« | è¯´æ˜ |
|------|------|------|------|
| `openid` | string | æ˜¯ | å¾®ä¿¡openidï¼ˆç”¨æˆ·å”¯ä¸€æ ‡è¯†ï¼‰ |
| `phone` | string | æ˜¯ | æ‰‹æœºå·ï¼ˆ11ä½ä¸­å›½å¤§é™†æ‰‹æœºå·ï¼‰ |
| `username` | string | å¦ | è´¦å·ï¼ˆç”¨æˆ·è‡ªå®šä¹‰è´¦å·ï¼Œå”¯ä¸€ï¼‰ |
| `password` | string | å¦ | å¯†ç ï¼ˆæ˜æ–‡ä¼ è¾“ï¼Œåç«¯è‡ªåŠ¨åŠ å¯†å­˜å‚¨ï¼‰ |
| `nickname` | string | å¦ | æ˜µç§° |
| `avatar` | string | å¦ | å¤´åƒURLï¼ˆå¾®ä¿¡å¤´åƒæˆ–å›¾ç‰‡URLï¼‰ |
| `avatarFile` | string | å¦ | å¤´åƒæ–‡ä»¶è·¯å¾„ï¼ˆç”¨æˆ·ä¸Šä¼ çš„å›¾ç‰‡æ–‡ä»¶ï¼‰ |
| `unionid` | string | å¦ | å¾®ä¿¡unionid |
| `gender` | number | å¦ | æ€§åˆ«ï¼š0-æœªçŸ¥, 1-ç”·, 2-å¥³ |
| `city` | string | å¦ | åŸå¸‚ |
| `province` | string | å¦ | çœä»½ |
| `country` | string | å¦ | å›½å®¶ |
| `language` | string | å¦ | è¯­è¨€ï¼ˆå¦‚ï¼šzh_CNï¼‰ |

#### æˆåŠŸå“åº” (200)

```json
{
  "success": true,
  "data": {
    "_id": "679abcdef1234567890abcde",
    "phone": "13800138000",
    "username": "user123",
    "nickname": "å¾®ä¿¡ç”¨æˆ·",
    "avatar": "https://thirdwx.qlogo.cn/xxx.jpg",
    "avatarFile": "/uploads/avatars/user123.jpg",
    "openid": "oXXXX_xxxxxxxxxxxxx",
    "unionid": "oXXXX_xxxxxxxxxxxxx",
    "gender": 1,
    "city": "åŒ—äº¬",
    "province": "åŒ—äº¬",
    "country": "ä¸­å›½",
    "language": "zh_CN",
    "status": "active",
    "loginCount": 1,
    "lastLoginAt": "2026-01-21T10:00:00.000Z",
    "lastLoginIp": "192.168.1.100",
    "createdAt": "2026-01-21T10:00:00.000Z",
    "updatedAt": "2026-01-21T10:00:00.000Z"
  },
  "message": "æ³¨å†ŒæˆåŠŸ"
}
```

**æ³¨æ„**ï¼šå“åº”ä¸­ä¸ä¼šè¿”å› `password` å­—æ®µï¼ˆå¯†ç å·²åŠ å¯†å­˜å‚¨ï¼Œä¸ä¼šè¿”å›ç»™å®¢æˆ·ç«¯ï¼‰ã€‚

#### å“åº”å­—æ®µè¯´æ˜

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| `_id` | string | ç”¨æˆ·å”¯ä¸€ID |
| `phone` | string | æ‰‹æœºå· |
| `nickname` | string | æ˜µç§° |
| `avatar` | string | å¤´åƒURL |
| `openid` | string | å¾®ä¿¡openid |
| `unionid` | string | å¾®ä¿¡unionid |
| `gender` | number | æ€§åˆ«ï¼š0-æœªçŸ¥, 1-ç”·, 2-å¥³ |
| `city` | string | åŸå¸‚ |
| `province` | string | çœä»½ |
| `country` | string | å›½å®¶ |
| `language` | string | è¯­è¨€ |
| `status` | string | çŠ¶æ€ï¼šactive-æ´»è·ƒ, inactive-ä¸æ´»è·ƒ, blocked-å·²å°ç¦ |
| `loginCount` | number | ç™»å½•æ¬¡æ•° |
| `lastLoginAt` | string | æœ€è¿‘ç™»å½•æ—¶é—´ï¼ˆISO 8601æ ¼å¼ï¼‰ |
| `lastLoginIp` | string | æœ€è¿‘ç™»å½•IP |
| `createdAt` | string | æ³¨å†Œæ—¶é—´ï¼ˆISO 8601æ ¼å¼ï¼‰ |
| `updatedAt` | string | æ›´æ–°æ—¶é—´ï¼ˆISO 8601æ ¼å¼ï¼‰ |

#### é”™è¯¯å“åº”

**éªŒè¯é”™è¯¯ (400)**:
```json
{
  "success": false,
  "message": "è¯·è¾“å…¥æœ‰æ•ˆçš„ä¸­å›½å¤§é™†æ‰‹æœºå·"
}
```

#### å°ç¨‹åºè°ƒç”¨ç¤ºä¾‹

**æœ€ç®€å•çš„è°ƒç”¨æ–¹å¼ï¼ˆç›´æ¥ä½¿ç”¨ wx.requestï¼‰ï¼š**

```javascript
// 1. è®°å½•ç™»å½•ï¼ˆåœ¨å°ç¨‹åºå¯åŠ¨æ—¶è°ƒç”¨ï¼Œä½¿ç”¨ openidï¼Œæ¨èåŒæ—¶ä¼ é€’ç”¨æˆ·ä¿¡æ¯ï¼‰
// è·å–ç”¨æˆ·ä¿¡æ¯
wx.getUserProfile({
  desc: 'ç”¨äºå®Œå–„ç”¨æˆ·èµ„æ–™',
  success: (profileRes) => {
    const userInfo = profileRes.userInfo;

    // è°ƒç”¨ç™»å½•æ¥å£ï¼Œä¼ é€’å®Œæ•´çš„ç”¨æˆ·ä¿¡æ¯
    wx.request({
      url: 'https://crm.andejiazheng.com/api/miniprogram-users/login',
      method: 'POST',
      data: {
        openid: 'oXXXX_xxxxxxxxxxxxx',   // å¿…å¡«ï¼šå¾®ä¿¡openid
        nickname: userInfo.nickName,      // æ¨èï¼šæ˜µç§°
        avatar: userInfo.avatarUrl,       // æ¨èï¼šå¤´åƒURL
        gender: userInfo.gender,          // æ¨èï¼šæ€§åˆ«
        city: userInfo.city,              // å¯é€‰ï¼šåŸå¸‚
        province: userInfo.province,      // å¯é€‰ï¼šçœä»½
        country: userInfo.country,        // å¯é€‰ï¼šå›½å®¶
        language: userInfo.language       // å¯é€‰ï¼šè¯­è¨€
      },
      success(res) {
        if (res.data.success) {
          console.log('ç™»å½•æˆåŠŸ', res.data.data);
          console.log('æ˜¯å¦å·²æˆæƒæ‰‹æœºå·:', res.data.data.hasPhone);

          // å¦‚æœç”¨æˆ·è¿˜æ²¡æˆæƒæ‰‹æœºå·ï¼Œå¼•å¯¼ç”¨æˆ·æˆæƒ
          if (!res.data.data.hasPhone) {
            // æ˜¾ç¤ºæˆæƒæ‰‹æœºå·æŒ‰é’®
          }
        }
      }
    });
  }
});

// 2. ç”¨æˆ·æ³¨å†Œï¼ˆåœ¨è·å–æ‰‹æœºå·åè°ƒç”¨ï¼‰
wx.request({
  url: 'https://crm.andejiazheng.com/api/miniprogram-users/register',
  method: 'POST',
  data: {
    openid: 'oXXXX_xxxxxxxxxxxxx',  // å¿…å¡«ï¼šå¾®ä¿¡openid
    phone: '13800138000',           // å¿…å¡«ï¼šæ‰‹æœºå·
    username: 'user123',            // å¯é€‰ï¼šè´¦å·ï¼ˆç”¨æˆ·è‡ªå®šä¹‰ï¼‰
    password: 'password123',        // å¯é€‰ï¼šå¯†ç ï¼ˆæ˜æ–‡ï¼Œåç«¯è‡ªåŠ¨åŠ å¯†ï¼‰
    nickname: 'å¾®ä¿¡ç”¨æˆ·',            // å¯é€‰ï¼šæ˜µç§°
    avatar: 'https://xxx.jpg',      // å¯é€‰ï¼šå¤´åƒURL
    avatarFile: '/uploads/xxx.jpg', // å¯é€‰ï¼šå¤´åƒæ–‡ä»¶è·¯å¾„
    gender: 1,                      // å¯é€‰ï¼šæ€§åˆ« 0-æœªçŸ¥ 1-ç”· 2-å¥³
    city: 'åŒ—äº¬',                   // å¯é€‰ï¼šåŸå¸‚
    province: 'åŒ—äº¬'                // å¯é€‰ï¼šçœä»½
  },
  success(res) {
    if (res.data.success) {
      console.log('æ³¨å†ŒæˆåŠŸ', res.data.data);
      // ä¿å­˜ç”¨æˆ·ä¿¡æ¯
      wx.setStorageSync('userInfo', res.data.data);
    } else {
      console.error('æ³¨å†Œå¤±è´¥', res.data.message);
    }
  }
});
```

**å®Œæ•´çš„é›†æˆç¤ºä¾‹ï¼š**

```javascript
// app.js - å°ç¨‹åºå¯åŠ¨æ—¶è®°å½•ç™»å½•
App({
  globalData: {
    openid: '',
    userInfo: null
  },

  onLaunch() {
    // 1. å…ˆç™»å½•è·å– openid
    wx.login({
      success: (res) => {
        if (res.code) {
          // è°ƒç”¨åç«¯æ¥å£ï¼Œç”¨ code æ¢å– openid
          // è¿™é‡Œå‡è®¾ä½ æœ‰ä¸€ä¸ªæ¥å£ /api/auth/wx-login
          wx.request({
            url: 'https://crm.andejiazheng.com/api/auth/wx-login',
            method: 'POST',
            data: { code: res.code },
            success: (loginRes) => {
              if (loginRes.data.success) {
                const openid = loginRes.data.data.openid;
                this.globalData.openid = openid;

                // 2. è®°å½•ç™»å½•
                this.recordLogin(openid);
              }
            }
          });
        }
      }
    });
  },

  // è®°å½•ç™»å½•
  recordLogin(openid) {
    wx.request({
      url: 'https://crm.andejiazheng.com/api/miniprogram-users/login',
      method: 'POST',
      data: { openid },
      success: (res) => {
        if (res.data.success) {
          console.log('ç™»å½•æˆåŠŸ');
          this.globalData.userInfo = res.data.data;

          // å¦‚æœç”¨æˆ·è¿˜æ²¡æˆæƒæ‰‹æœºå·ï¼Œå¼•å¯¼ç”¨æˆ·æˆæƒ
          if (!res.data.data.hasPhone) {
            console.log('ç”¨æˆ·è¿˜æœªæˆæƒæ‰‹æœºå·');
            // å¯ä»¥åœ¨é¦–é¡µæ˜¾ç¤ºæˆæƒæç¤º
          }
        }
      }
    });
  }
});
```

---

### è´¦å·å¯†ç ç™»å½•

ä½¿ç”¨è´¦å·å’Œå¯†ç ç™»å½•ï¼Œé€‚ç”¨äºç”¨æˆ·è®¾ç½®äº†è´¦å·å¯†ç çš„åœºæ™¯ã€‚

#### è¯·æ±‚

```http
POST /api/miniprogram-users/login-with-password
Content-Type: application/json

{
  "username": "user123",
  "password": "password123"
}
```

#### è¯·æ±‚å‚æ•°

| å‚æ•° | ç±»å‹ | å¿…å¡« | è¯´æ˜ |
|------|------|------|------|
| `username` | string | æ˜¯ | è´¦å·ï¼ˆç”¨æˆ·æ³¨å†Œæ—¶è®¾ç½®çš„è´¦å·ï¼‰ |
| `password` | string | æ˜¯ | å¯†ç ï¼ˆæ˜æ–‡ä¼ è¾“ï¼Œåç«¯ä¼šéªŒè¯åŠ å¯†åçš„å¯†ç ï¼‰ |

#### å“åº”

**æˆåŠŸå“åº”**:
```json
{
  "success": true,
  "data": {
    "_id": "user_id",
    "phone": "13800138000",
    "username": "user123",
    "nickname": "æµ‹è¯•ç”¨æˆ·",
    "avatar": "https://example.com/avatar.jpg",
    "avatarFile": "/uploads/avatars/user123.jpg",
    "openid": "oXXXX_xxxxxxxxxxxxx",
    "status": "active",
    "lastLoginAt": "2024-01-20T10:30:00.000Z",
    "lastLoginIp": "127.0.0.1",
    "loginCount": 5,
    "gender": 1,
    "city": "åŒ—äº¬",
    "province": "åŒ—äº¬",
    "createdAt": "2024-01-15T08:00:00.000Z",
    "updatedAt": "2024-01-20T10:30:00.000Z",
    "hasPhone": true,
    "isNewUser": false
  },
  "message": "ç™»å½•æˆåŠŸ"
}
```

**é”™è¯¯å“åº”**:
```json
{
  "success": false,
  "message": "å¯†ç é”™è¯¯"
}
```

```json
{
  "success": false,
  "message": "ç”¨æˆ·ä¸å­˜åœ¨"
}
```

```json
{
  "success": false,
  "message": "è¯¥ç”¨æˆ·æœªè®¾ç½®å¯†ç ï¼Œè¯·ä½¿ç”¨å…¶ä»–æ–¹å¼ç™»å½•"
}
```

#### å“åº”å­—æ®µè¯´æ˜

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| `success` | boolean | æ˜¯å¦æˆåŠŸ |
| `data` | object | ç”¨æˆ·ä¿¡æ¯ï¼ˆä¸åŒ…å«å¯†ç ï¼‰ |
| `data.hasPhone` | boolean | æ˜¯å¦å·²ç»‘å®šæ‰‹æœºå· |
| `data.isNewUser` | boolean | æ˜¯å¦ä¸ºæ–°ç”¨æˆ·ï¼ˆè´¦å·å¯†ç ç™»å½•æ—¶å§‹ç»ˆä¸º falseï¼‰ |
| `data.loginCount` | number | ç™»å½•æ¬¡æ•°ï¼ˆè‡ªåŠ¨+1ï¼‰ |
| `data.lastLoginAt` | string | æœ€è¿‘ç™»å½•æ—¶é—´ï¼ˆè‡ªåŠ¨æ›´æ–°ï¼‰ |
| `data.lastLoginIp` | string | æœ€è¿‘ç™»å½•IPï¼ˆè‡ªåŠ¨è®°å½•ï¼‰ |
| `message` | string | æç¤ºä¿¡æ¯ |

#### å°ç¨‹åºç«¯è°ƒç”¨ç¤ºä¾‹

**æœ€ç®€å•çš„è°ƒç”¨æ–¹å¼ï¼š**

```javascript
// è´¦å·å¯†ç ç™»å½•
wx.request({
  url: 'https://crm.andejiazheng.com/api/miniprogram-users/login-with-password',
  method: 'POST',
  data: {
    username: 'user123',
    password: 'password123'
  },
  success(res) {
    if (res.data.success) {
      console.log('ç™»å½•æˆåŠŸ', res.data.data);
      // ä¿å­˜ç”¨æˆ·ä¿¡æ¯
      wx.setStorageSync('userInfo', res.data.data);
      // è·³è½¬åˆ°é¦–é¡µ
      wx.switchTab({ url: '/pages/index/index' });
    } else {
      wx.showToast({
        title: res.data.message,
        icon: 'none'
      });
    }
  }
});
```

**å®Œæ•´çš„ç™»å½•é¡µé¢ç¤ºä¾‹ï¼š**

```javascript
// pages/login/login.js - ç”¨æˆ·æˆæƒæ‰‹æœºå·åæ³¨å†Œ
const app = getApp();

Page({
  data: {
    userInfo: null
  },

  onLoad() {
    // è·å–ç”¨æˆ·ä¿¡æ¯
    wx.getUserProfile({
      desc: 'ç”¨äºå®Œå–„ç”¨æˆ·èµ„æ–™',
      success: (res) => {
        this.setData({ userInfo: res.userInfo });
      }
    });
  },

  // è·å–æ‰‹æœºå·æŒ‰é’®ç‚¹å‡»äº‹ä»¶
  getPhoneNumber(e) {
    if (e.detail.errMsg !== 'getPhoneNumber:ok') {
      wx.showToast({ title: 'è·å–æ‰‹æœºå·å¤±è´¥', icon: 'none' });
      return;
    }

    const openid = app.globalData.openid;
    if (!openid) {
      wx.showToast({ title: 'è¯·å…ˆç™»å½•', icon: 'none' });
      return;
    }

    // æ³¨å†Œç”¨æˆ·ï¼ˆç»‘å®šæ‰‹æœºå·ï¼‰
    wx.request({
      url: 'https://crm.andejiazheng.com/api/miniprogram-users/register',
      method: 'POST',
      data: {
        openid: openid,                      // å¿…å¡«ï¼šå¾®ä¿¡openid
        phone: e.detail.phoneNumber,         // å¿…å¡«ï¼šæ‰‹æœºå·
        username: 'user_' + openid.slice(-8), // å¯é€‰ï¼šè‡ªåŠ¨ç”Ÿæˆè´¦å·
        password: 'default123',              // å¯é€‰ï¼šé»˜è®¤å¯†ç ï¼ˆå»ºè®®å¼•å¯¼ç”¨æˆ·ä¿®æ”¹ï¼‰
        nickname: this.data.userInfo.nickName,
        avatar: this.data.userInfo.avatarUrl,
        gender: this.data.userInfo.gender,
        city: this.data.userInfo.city,
        province: this.data.userInfo.province
      },
      success(res) {
        if (res.data.success) {
          wx.showToast({ title: 'æˆæƒæˆåŠŸ', icon: 'success' });
          // ä¿å­˜ç”¨æˆ·ä¿¡æ¯
          app.globalData.userInfo = res.data.data;
          wx.setStorageSync('userInfo', res.data.data);
          // è·³è½¬åˆ°é¦–é¡µ
          wx.switchTab({ url: '/pages/index/index' });
        } else {
          wx.showToast({ title: res.data.message, icon: 'none' });
        }
      }
    });
  }
});
```

```html
<!-- pages/login/login.wxml - è·å–æ‰‹æœºå·æŒ‰é’® -->
<button open-type="getPhoneNumber" bindgetphonenumber="getPhoneNumber">
  æˆæƒæ‰‹æœºå·
</button>
```

---

### è®°å½•ç”¨æˆ·ç™»å½•

è®°å½•ç”¨æˆ·ç™»å½•è¡Œä¸ºï¼Œæ›´æ–°æœ€è¿‘ç™»å½•æ—¶é—´ã€IPå’Œç™»å½•æ¬¡æ•°ã€‚**å¦‚æœç”¨æˆ·ä¸å­˜åœ¨ï¼Œä¼šè‡ªåŠ¨åˆ›å»ºæ–°ç”¨æˆ·ï¼ˆæ”¯æŒä¼ é€’ç”¨æˆ·ä¿¡æ¯å¦‚æ˜µç§°ã€å¤´åƒç­‰ï¼‰ã€‚**

#### è¯·æ±‚

```http
POST /api/miniprogram-users/login
Content-Type: application/json

{
  "openid": "oXXXX_xxxxxxxxxxxxx",
  "phone": "13800138000",
  "nickname": "å¾®ä¿¡ç”¨æˆ·",
  "avatar": "https://thirdwx.qlogo.cn/xxx.jpg",
  "avatarFile": "/uploads/avatars/user123.jpg",
  "gender": 1,
  "city": "åŒ—äº¬",
  "province": "åŒ—äº¬",
  "country": "ä¸­å›½",
  "language": "zh_CN"
}
```

**è®¤è¯**: âŒ æ— éœ€ç™»å½•ï¼ˆå…¬å¼€æ¥å£ï¼‰

#### è¯·æ±‚å‚æ•°

| å‚æ•° | ç±»å‹ | å¿…å¡« | è¯´æ˜ |
|------|------|------|------|
| `openid` | string | æ˜¯ï¼ˆäºŒé€‰ä¸€ï¼‰ | å¾®ä¿¡openidï¼ˆæ¨èä½¿ç”¨ï¼‰ |
| `phone` | string | æ˜¯ï¼ˆäºŒé€‰ä¸€ï¼‰ | æ‰‹æœºå·ï¼ˆå…¼å®¹æ—§ç‰ˆæœ¬ï¼‰ |
| `nickname` | string | å¦ | æ˜µç§°ï¼ˆæ¨èä¼ é€’ï¼Œç”¨äºé¦–æ¬¡ç™»å½•æ—¶åˆ›å»ºç”¨æˆ·ï¼‰ |
| `avatar` | string | å¦ | å¤´åƒURLï¼ˆæ¨èä¼ é€’ï¼Œç”¨äºé¦–æ¬¡ç™»å½•æ—¶åˆ›å»ºç”¨æˆ·ï¼‰ |
| `avatarFile` | string | å¦ | å¤´åƒæ–‡ä»¶è·¯å¾„ï¼ˆç”¨æˆ·ä¸Šä¼ çš„å›¾ç‰‡æ–‡ä»¶ï¼‰ |
| `gender` | number | å¦ | æ€§åˆ«ï¼š0-æœªçŸ¥, 1-ç”·, 2-å¥³ |
| `city` | string | å¦ | åŸå¸‚ |
| `province` | string | å¦ | çœä»½ |
| `country` | string | å¦ | å›½å®¶ |
| `language` | string | å¦ | è¯­è¨€ï¼ˆå¦‚ï¼šzh_CNï¼‰ |

**æ³¨æ„**ï¼š
1. ä¼˜å…ˆä½¿ç”¨ `openid`ï¼Œå› ä¸ºå°ç¨‹åºå¯åŠ¨æ—¶å¯ä»¥ç›´æ¥è·å–ï¼Œæ— éœ€ç”¨æˆ·æˆæƒ
2. **å¼ºçƒˆæ¨èä¼ é€’ `nickname` å’Œ `avatar`**ï¼Œè¿™æ ·CRMåå°çš„ç”¨æˆ·åˆ—è¡¨ä¼šæ˜¾ç¤ºç”¨æˆ·å¤´åƒå’Œæ˜µç§°
3. å¦‚æœç”¨æˆ·å·²å­˜åœ¨ï¼Œåªä¼šæ›´æ–°ç™»å½•ä¿¡æ¯ï¼›å¦‚æœç”¨æˆ·ä¸å­˜åœ¨ï¼Œä¼šåˆ›å»ºæ–°ç”¨æˆ·å¹¶ä¿å­˜ä¼ é€’çš„æ‰€æœ‰ä¿¡æ¯

#### æˆåŠŸå“åº” (200)

**å·²æ³¨å†Œç”¨æˆ·ç™»å½•ï¼š**
```json
{
  "success": true,
  "data": {
    "_id": "679abcdef1234567890abcde",
    "openid": "oXXXX_xxxxxxxxxxxxx",
    "phone": "13800138000",
    "nickname": "å¾®ä¿¡ç”¨æˆ·",
    "avatar": "https://thirdwx.qlogo.cn/xxx.jpg",
    "status": "active",
    "loginCount": 5,
    "lastLoginAt": "2026-01-21T10:30:00.000Z",
    "lastLoginIp": "192.168.1.100",
    "createdAt": "2026-01-21T10:00:00.000Z",
    "updatedAt": "2026-01-21T10:30:00.000Z",
    "hasPhone": true,
    "isNewUser": false
  },
  "message": "ç™»å½•æˆåŠŸ"
}
```

**é¦–æ¬¡ç™»å½•ï¼ˆè‡ªåŠ¨åˆ›å»ºåŒ¿åç”¨æˆ·ï¼‰ï¼š**
```json
{
  "success": true,
  "data": {
    "_id": "679abcdef1234567890abcde",
    "openid": "oXXXX_xxxxxxxxxxxxx",
    "status": "active",
    "loginCount": 1,
    "lastLoginAt": "2026-01-21T10:30:00.000Z",
    "lastLoginIp": "192.168.1.100",
    "createdAt": "2026-01-21T10:30:00.000Z",
    "updatedAt": "2026-01-21T10:30:00.000Z",
    "hasPhone": false,
    "isNewUser": true
  },
  "message": "é¦–æ¬¡ç™»å½•ï¼Œå·²åˆ›å»ºç”¨æˆ·"
}
```

#### å“åº”å­—æ®µè¯´æ˜

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| `hasPhone` | boolean | æ˜¯å¦å·²æˆæƒæ‰‹æœºå·ï¼ˆtrue-å·²æˆæƒï¼Œfalse-æœªæˆæƒï¼‰ |
| `isNewUser` | boolean | æ˜¯å¦ä¸ºæ–°ç”¨æˆ·ï¼ˆtrue-é¦–æ¬¡ç™»å½•ï¼Œfalse-è€ç”¨æˆ·ï¼‰ |

**é‡è¦**ï¼šæ ¹æ® `hasPhone` å­—æ®µåˆ¤æ–­æ˜¯å¦éœ€è¦å¼•å¯¼ç”¨æˆ·æˆæƒæ‰‹æœºå·ã€‚

#### å°ç¨‹åºè°ƒç”¨ç¤ºä¾‹

**æœ€ç®€å•çš„è°ƒç”¨æ–¹å¼ï¼ˆç›´æ¥ä½¿ç”¨ wx.requestï¼‰ï¼š**

```javascript
// è®°å½•ç”¨æˆ·ç™»å½•ï¼ˆä½¿ç”¨ openidï¼‰
wx.request({
  url: 'https://crm.andejiazheng.com/api/miniprogram-users/login',
  method: 'POST',
  data: {
    openid: 'oXXXX_xxxxxxxxxxxxx'  // å¿…å¡«ï¼šå¾®ä¿¡openid
  },
  success(res) {
    if (res.data.success) {
      console.log('ç™»å½•æˆåŠŸ', res.data.data);
      console.log('æ˜¯å¦å·²æˆæƒæ‰‹æœºå·:', res.data.data.hasPhone);
      console.log('æ˜¯å¦ä¸ºæ–°ç”¨æˆ·:', res.data.data.isNewUser);
      console.log('ç™»å½•æ¬¡æ•°:', res.data.data.loginCount);

      // å¦‚æœç”¨æˆ·è¿˜æ²¡æˆæƒæ‰‹æœºå·ï¼Œå¼•å¯¼ç”¨æˆ·æˆæƒ
      if (!res.data.data.hasPhone) {
        // æ˜¾ç¤ºæˆæƒæ‰‹æœºå·æŒ‰é’®æˆ–å¼¹çª—
        wx.showModal({
          title: 'æç¤º',
          content: 'ä¸ºäº†æ›´å¥½çš„æœåŠ¡ï¼Œè¯·æˆæƒæ‚¨çš„æ‰‹æœºå·',
          confirmText: 'å»æˆæƒ',
          success(modalRes) {
            if (modalRes.confirm) {
              wx.navigateTo({ url: '/pages/login/login' });
            }
          }
        });
      }
    }
  }
});
```

**æ¨èçš„ä½¿ç”¨åœºæ™¯ï¼š**

```javascript
// åœºæ™¯1: åœ¨ app.js ä¸­ï¼Œå°ç¨‹åºå¯åŠ¨æ—¶è®°å½•ç™»å½•
App({
  globalData: {
    openid: ''
  },

  onLaunch() {
    // 1. å…ˆè°ƒç”¨ wx.login è·å– code
    wx.login({
      success: (res) => {
        if (res.code) {
          // 2. ç”¨ code æ¢å– openidï¼ˆéœ€è¦åç«¯æ¥å£ï¼‰
          wx.request({
            url: 'https://crm.andejiazheng.com/api/auth/wx-login',
            method: 'POST',
            data: { code: res.code },
            success: (loginRes) => {
              if (loginRes.data.success) {
                const openid = loginRes.data.data.openid;
                this.globalData.openid = openid;

                // 3. è®°å½•ç™»å½•
                wx.request({
                  url: 'https://crm.andejiazheng.com/api/miniprogram-users/login',
                  method: 'POST',
                  data: { openid },
                  success: (userRes) => {
                    if (userRes.data.success) {
                      console.log('ç™»å½•æˆåŠŸ');

                      // å¦‚æœç”¨æˆ·è¿˜æ²¡æˆæƒæ‰‹æœºå·ï¼Œå¼•å¯¼æˆæƒ
                      if (!userRes.data.data.hasPhone) {
                        // å¯ä»¥åœ¨é¦–é¡µæ˜¾ç¤ºæˆæƒæç¤º
                      }
                    }
                  }
                });
              }
            }
          });
        }
      }
    });
  }
});

// åœºæ™¯2: åœ¨å…³é”®é¡µé¢ï¼Œç”¨æˆ·è¿›å…¥æ—¶è®°å½•æ´»è·ƒåº¦
const app = getApp();

Page({
  onShow() {
    const openid = app.globalData.openid;
    if (openid) {
      wx.request({
        url: 'https://crm.andejiazheng.com/api/miniprogram-users/login',
        method: 'POST',
        data: { openid }
      });
    }
  }
});
```

---

### ğŸ¯ å®Œæ•´ä½¿ç”¨æµç¨‹å’Œæœ€ä½³å®è·µ

#### ğŸ“± æ¨èçš„é›†æˆæµç¨‹

**æµç¨‹å›¾ï¼š**
```
å°ç¨‹åºå¯åŠ¨
    â†“
wx.login() è·å– code
    â†“
è°ƒç”¨åç«¯æ¥å£ç”¨ code æ¢å– openid
    â†“
è°ƒç”¨ POST /api/miniprogram-users/login ä¼ å…¥ {openid}
    â†“
æ£€æŸ¥å“åº”ä¸­çš„ hasPhone å­—æ®µ
    â†“
â”œâ”€ hasPhone = true  â†’ ç”¨æˆ·å·²å®Œæˆæ³¨å†Œï¼Œç›´æ¥è¿›å…¥é¦–é¡µ
â””â”€ hasPhone = false â†’ å¼•å¯¼ç”¨æˆ·æˆæƒæ‰‹æœºå·
        â†“
    ç”¨æˆ·ç‚¹å‡»æˆæƒæŒ‰é’®
        â†“
    è°ƒç”¨ POST /api/miniprogram-users/register ä¼ å…¥ {openid, phone, ...}
        â†“
    æ³¨å†ŒæˆåŠŸï¼Œè¿›å…¥é¦–é¡µ
```

#### ğŸ” ä¸‰ç§ç™»å½•æ–¹å¼çš„ä½¿ç”¨åœºæ™¯

| ç™»å½•æ–¹å¼ | ä½¿ç”¨åœºæ™¯ | ä¼˜ç‚¹ | ç¼ºç‚¹ |
|---------|---------|------|------|
| **OpenID è‡ªåŠ¨ç™»å½•** | å°ç¨‹åºå¯åŠ¨æ—¶ | æ— éœ€ç”¨æˆ·æ“ä½œï¼Œä½“éªŒæœ€å¥½ | æ— æ³•è·å–æ‰‹æœºå·ç­‰æ•æ„Ÿä¿¡æ¯ |
| **æ‰‹æœºå·æ³¨å†Œ/æ›´æ–°** | éœ€è¦ç”¨æˆ·æ‰‹æœºå·æ—¶ | å¯è·å–çœŸå®æ‰‹æœºå·ï¼Œä¾¿äºè”ç³» | éœ€è¦ç”¨æˆ·æˆæƒ |
| **è´¦å·å¯†ç ç™»å½•** | ç”¨æˆ·è®¾ç½®äº†è´¦å·å¯†ç å | å¯è·¨è®¾å¤‡ç™»å½•ï¼Œä¸ä¾èµ–å¾®ä¿¡ | éœ€è¦ç”¨æˆ·è®°ä½è´¦å·å¯†ç  |

#### ğŸ’¡ æœ€ä½³å®è·µå»ºè®®

**1. å°ç¨‹åºå¯åŠ¨æ—¶ï¼ˆapp.jsï¼‰**
```javascript
App({
  globalData: {
    openid: '',
    userInfo: null
  },

  onLaunch() {
    // ç¬¬ä¸€æ­¥ï¼šè·å– openid
    wx.login({
      success: (res) => {
        if (res.code) {
          // è°ƒç”¨åç«¯æ¥å£æ¢å– openid
          wx.request({
            url: 'https://crm.andejiazheng.com/api/auth/wx-login',
            method: 'POST',
            data: { code: res.code },
            success: (loginRes) => {
              if (loginRes.data.success) {
                const openid = loginRes.data.data.openid;
                this.globalData.openid = openid;

                // ç¬¬äºŒæ­¥ï¼šè®°å½•ç™»å½•
                this.recordLogin(openid);
              }
            }
          });
        }
      }
    });
  },

  recordLogin(openid) {
    wx.request({
      url: 'https://crm.andejiazheng.com/api/miniprogram-users/login',
      method: 'POST',
      data: { openid },
      success: (res) => {
        if (res.data.success) {
          this.globalData.userInfo = res.data.data;

          // æ£€æŸ¥æ˜¯å¦éœ€è¦å¼•å¯¼ç”¨æˆ·æˆæƒæ‰‹æœºå·
          if (!res.data.data.hasPhone) {
            // å¯ä»¥è®¾ç½®ä¸€ä¸ªæ ‡å¿—ï¼Œåœ¨é¦–é¡µæ˜¾ç¤ºæˆæƒæç¤º
            wx.setStorageSync('needPhoneAuth', true);
          }
        }
      }
    });
  }
});
```

**2. é¦–é¡µå¼•å¯¼æˆæƒï¼ˆpages/index/index.jsï¼‰**
```javascript
Page({
  data: {
    showAuthModal: false
  },

  onShow() {
    // æ£€æŸ¥æ˜¯å¦éœ€è¦å¼•å¯¼æˆæƒ
    const needPhoneAuth = wx.getStorageSync('needPhoneAuth');
    if (needPhoneAuth) {
      this.setData({ showAuthModal: true });
    }
  },

  // ç”¨æˆ·ç‚¹å‡»æˆæƒæŒ‰é’®
  getPhoneNumber(e) {
    if (e.detail.errMsg !== 'getPhoneNumber:ok') {
      return;
    }

    const app = getApp();
    wx.request({
      url: 'https://crm.andejiazheng.com/api/miniprogram-users/register',
      method: 'POST',
      data: {
        openid: app.globalData.openid,
        phone: e.detail.phoneNumber,
        nickname: app.globalData.userInfo?.nickname,
        avatar: app.globalData.userInfo?.avatar
      },
      success: (res) => {
        if (res.data.success) {
          wx.removeStorageSync('needPhoneAuth');
          this.setData({ showAuthModal: false });
          wx.showToast({ title: 'æˆæƒæˆåŠŸ', icon: 'success' });
        }
      }
    });
  }
});
```

**3. è´¦å·å¯†ç ç™»å½•é¡µé¢ï¼ˆpages/login/login.jsï¼‰**
```javascript
Page({
  data: {
    username: '',
    password: ''
  },

  onUsernameInput(e) {
    this.setData({ username: e.detail.value });
  },

  onPasswordInput(e) {
    this.setData({ password: e.detail.value });
  },

  handleLogin() {
    const { username, password } = this.data;

    if (!username || !password) {
      wx.showToast({ title: 'è¯·è¾“å…¥è´¦å·å’Œå¯†ç ', icon: 'none' });
      return;
    }

    wx.request({
      url: 'https://crm.andejiazheng.com/api/miniprogram-users/login-with-password',
      method: 'POST',
      data: { username, password },
      success: (res) => {
        if (res.data.success) {
          // ä¿å­˜ç”¨æˆ·ä¿¡æ¯
          const app = getApp();
          app.globalData.userInfo = res.data.data;
          app.globalData.openid = res.data.data.openid;
          wx.setStorageSync('userInfo', res.data.data);

          // è·³è½¬åˆ°é¦–é¡µ
          wx.switchTab({ url: '/pages/index/index' });
        } else {
          wx.showToast({ title: res.data.message, icon: 'none' });
        }
      }
    });
  }
});
```

#### ğŸ”’ å®‰å…¨æ³¨æ„äº‹é¡¹

1. **å¯†ç ä¼ è¾“**ï¼šç”Ÿäº§ç¯å¢ƒå¿…é¡»ä½¿ç”¨ HTTPSï¼Œå¯†ç åœ¨ä¼ è¾“è¿‡ç¨‹ä¸­ä¼šè¢«åŠ å¯†
2. **å¯†ç å­˜å‚¨**ï¼šåç«¯ä½¿ç”¨ bcrypt åŠ å¯†å­˜å‚¨ï¼ŒsaltRounds=10
3. **å¯†ç å“åº”**ï¼šæ‰€æœ‰ API å“åº”ä¸­éƒ½ä¸ä¼šè¿”å›å¯†ç å­—æ®µ
4. **OpenID ä¿æŠ¤**ï¼šOpenID æ˜¯ç”¨æˆ·çš„å”¯ä¸€æ ‡è¯†ï¼Œä¸è¦æ³„éœ²ç»™ç¬¬ä¸‰æ–¹
5. **æ‰‹æœºå·æˆæƒ**ï¼šåªåœ¨å¿…è¦æ—¶è¯·æ±‚æ‰‹æœºå·æˆæƒï¼Œé¿å…è¿‡åº¦æ‰“æ‰°ç”¨æˆ·

#### ğŸ“Š åå°ç®¡ç†åŠŸèƒ½

ç®¡ç†å‘˜å¯ä»¥åœ¨"è¤“è´åå° - å°ç¨‹åºç”¨æˆ·ç®¡ç†"ä¸­æŸ¥çœ‹ï¼š

- **ç”¨æˆ·åˆ—è¡¨**ï¼šæ˜¾ç¤ºæ‰€æœ‰ç”¨æˆ·çš„è´¦å·ã€OpenIDã€æ‰‹æœºå·ã€æ˜µç§°ã€å¤´åƒã€åœ°åŒºç­‰ä¿¡æ¯
- **ç»Ÿè®¡ä¿¡æ¯**ï¼šæ€»ç”¨æˆ·æ•°ã€ä»Šæ—¥æ–°å¢ã€ä»Šæ—¥æ´»è·ƒ
- **ç”¨æˆ·è¯¦æƒ…**ï¼šç™»å½•æ¬¡æ•°ã€æœ€è¿‘ç™»å½•æ—¶é—´ã€æœ€è¿‘ç™»å½•IPã€æ³¨å†Œæ—¶é—´ç­‰
- **æœç´¢åŠŸèƒ½**ï¼šæ”¯æŒæŒ‰æ‰‹æœºå·ã€æ˜µç§°ã€è´¦å·æœç´¢ç”¨æˆ·

**æ³¨æ„**ï¼šå¯†ç å­—æ®µä¸ä¼šåœ¨åå°æ˜¾ç¤ºï¼Œç¡®ä¿ç”¨æˆ·éšç§å®‰å…¨ã€‚

---

## ğŸ–¼ï¸ Bannerè½®æ’­å›¾

è·å–å°ç¨‹åºé¦–é¡µå±•ç¤ºçš„Bannerè½®æ’­å›¾åˆ—è¡¨ã€‚

### è·å–æ´»è·ƒBanneråˆ—è¡¨

è·å–æ‰€æœ‰å¯ç”¨çŠ¶æ€çš„Bannerï¼ŒæŒ‰æ’åºå­—æ®µå‡åºæ’åˆ—ã€‚

#### è¯·æ±‚

```http
GET /api/banners/miniprogram/active
```

**è®¤è¯**: âŒ æ— éœ€ç™»å½•

#### å“åº”

```json
{
  "success": true,
  "data": [
    {
      "_id": "696224b526da74c3b9e0c565",
      "title": "é¦–é¡µBanner",
      "imageUrl": "https://housekeeping-1254058915.cos.ap-guangzhou.myqcloud.com/personalPhoto/xxx.jpg",
      "linkType": "none",
      "order": 0
    },
    {
      "_id": "696224b526da74c3b9e0c566",
      "title": "æ´»åŠ¨Banner",
      "imageUrl": "https://housekeeping-1254058915.cos.ap-guangzhou.myqcloud.com/personalPhoto/yyy.jpg",
      "linkType": "none",
      "order": 1
    }
  ],
  "message": "è·å–æˆåŠŸ"
}
```

#### å“åº”å­—æ®µè¯´æ˜

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| `_id` | string | Bannerå”¯ä¸€ID |
| `title` | string | Banneræ ‡é¢˜ |
| `imageUrl` | string | å›¾ç‰‡URLï¼ˆè…¾è®¯äº‘COSï¼‰ |
| `linkType` | string | é“¾æ¥ç±»å‹ï¼šnoneï¼ˆæ— è·³è½¬ï¼‰ |
| `order` | number | æ’åºå€¼ï¼Œæ•°å­—è¶Šå°è¶Šé å‰ |

#### å°ç¨‹åºè°ƒç”¨ç¤ºä¾‹

```javascript
// utils/api.js
const BASE_URL = 'https://crm.andejiazheng.com/api';

/**
 * è·å–é¦–é¡µBanneråˆ—è¡¨
 * @returns {Promise<Array>} Banneråˆ—è¡¨
 */
export function getBannerList() {
  return new Promise((resolve, reject) => {
    wx.request({
      url: `${BASE_URL}/banners/miniprogram/active`,
      method: 'GET',
      success(res) {
        if (res.data.success) {
          resolve(res.data.data);
        } else {
          reject(new Error(res.data.message || 'è·å–Bannerå¤±è´¥'));
        }
      },
      fail(err) {
        reject(err);
      }
    });
  });
}
```

```javascript
// pages/index/index.js
import { getBannerList } from '../../utils/api';

Page({
  data: {
    bannerList: []
  },

  onLoad() {
    this.loadBanners();
  },

  async loadBanners() {
    try {
      const banners = await getBannerList();
      this.setData({ bannerList: banners });
    } catch (err) {
      console.error('åŠ è½½Bannerå¤±è´¥:', err);
    }
  }
});
```

```html
<!-- pages/index/index.wxml -->
<swiper class="banner-swiper" indicator-dots autoplay circular>
  <swiper-item wx:for="{{bannerList}}" wx:key="_id">
    <image src="{{item.imageUrl}}" mode="aspectFill" class="banner-image" />
  </swiper-item>
</swiper>
```

```css
/* pages/index/index.wxss */
.banner-swiper {
  width: 100%;
  height: 300rpx;
}
.banner-image {
  width: 100%;
  height: 100%;
}
```

---

## ğŸ“° æ–‡ç« å†…å®¹

å°ç¨‹åºå¯ä»¥è·å–å’Œå±•ç¤ºè¤“è´åå°å‘å¸ƒçš„æ–‡ç« å†…å®¹ï¼Œç”¨äºè‚²å„¿çŸ¥è¯†ã€å®¶æ”¿æŠ€å·§ç­‰å†…å®¹å±•ç¤ºã€‚

### ğŸ“± ä¸€å¥è¯æ€»ç»“

**å°ç¨‹åºè°ƒç”¨æ–‡ç« æ¥å£éå¸¸ç®€å•ï¼šä½¿ç”¨ `GET https://crm.andejiazheng.com/api/articles/miniprogram/list?page=1&pageSize=10` è·å–æ–‡ç« åˆ—è¡¨ï¼Œä½¿ç”¨ `GET https://crm.andejiazheng.com/api/articles/miniprogram/:id` è·å–æ–‡ç« è¯¦æƒ…ã€‚ä¸¤ä¸ªæ¥å£éƒ½æ˜¯å…¬å¼€æ¥å£ï¼ˆæ— éœ€ä¼  tokenï¼‰ï¼Œè‡ªåŠ¨åªè¿”å›å·²å‘å¸ƒæ–‡ç« ã€‚åˆ—è¡¨è¿”å›æ–‡ç« æ•°ç»„å’Œåˆ†é¡µä¿¡æ¯ï¼Œè¯¦æƒ…è¿”å›å®Œæ•´å†…å®¹ï¼ˆåŒ…æ‹¬ contentHtml å¯Œæ–‡æœ¬å’Œ imageUrls å›¾ç‰‡æ•°ç»„ï¼‰ã€‚ä½¿ç”¨ `<rich-text nodes="{{article.contentHtml}}">` æ¸²æŸ“å¯Œæ–‡æœ¬ï¼Œä½¿ç”¨ `<image wx:for="{{article.imageUrls}}">` å±•ç¤ºå›¾ç‰‡ã€‚æ”¯æŒæœç´¢ã€åˆ†é¡µã€ä¸Šæ‹‰åŠ è½½æ›´å¤šç­‰åŠŸèƒ½ã€‚**

### è·å–æ–‡ç« åˆ—è¡¨

è·å–å·²å‘å¸ƒçš„æ–‡ç« åˆ—è¡¨ï¼Œæ”¯æŒåˆ†é¡µå’Œæœç´¢ã€‚

#### è¯·æ±‚

```http
GET /api/articles/miniprogram/list?page=1&pageSize=10&keyword=è‚²å„¿
```

**è®¤è¯**: âŒ æ— éœ€ç™»å½•ï¼ˆå…¬å¼€æ¥å£ï¼Œè‡ªåŠ¨åªè¿”å›å·²å‘å¸ƒæ–‡ç« ï¼‰

#### è¯·æ±‚å‚æ•°

| å‚æ•° | ç±»å‹ | å¿…å¡« | è¯´æ˜ |
|------|------|------|------|
| `keyword` | string | å¦ | æœç´¢å…³é”®è¯ï¼ˆæ ‡é¢˜/æ­£æ–‡/ä½œè€…/æ¥æºï¼‰ |
| `page` | number | å¦ | é¡µç ï¼Œé»˜è®¤ 1 |
| `pageSize` | number | å¦ | æ¯é¡µæ•°é‡ï¼Œé»˜è®¤ 10 |

**æ³¨æ„**ï¼šå°ç¨‹åºæ¥å£è‡ªåŠ¨åªè¿”å› `status='published'` çš„æ–‡ç« ï¼Œæ— éœ€ä¼  status å‚æ•°ã€‚

#### å“åº”

```json
{
  "success": true,
  "data": {
    "list": [
      {
        "_id": "6967700ebaf1a7bfe723665c",
        "title": "æ–°ç”Ÿå„¿æŠ¤ç†è¦ç‚¹",
        "author": "æ–°åç¤¾",
        "source": "äººæ°‘æ—¥æŠ¥",
        "status": "published",
        "createdAt": "2026-01-15T10:00:00.000Z",
        "updatedAt": "2026-01-15T10:00:00.000Z",
        "createdBy": {
          "_id": "user123",
          "name": "ç®¡ç†å‘˜",
          "username": "admin"
        }
      }
    ],
    "total": 50,
    "page": 1,
    "pageSize": 10,
    "totalPages": 5
  },
  "message": "è·å–æˆåŠŸ"
}
```

#### å“åº”å­—æ®µè¯´æ˜

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| `_id` | string | æ–‡ç« å”¯ä¸€ID |
| `title` | string | æ–‡ç« æ ‡é¢˜ |
| `author` | string | ä½œè€… |
| `source` | string | æ¥æº/å‡ºå¤„ |
| `status` | string | çŠ¶æ€ï¼š`draft`ï¼ˆè‰ç¨¿ï¼‰ã€`published`ï¼ˆå·²å‘å¸ƒï¼‰ |
| `createdAt` | string | åˆ›å»ºæ—¶é—´ï¼ˆISO 8601æ ¼å¼ï¼‰ |
| `updatedAt` | string | æ›´æ–°æ—¶é—´ï¼ˆISO 8601æ ¼å¼ï¼‰ |
| `createdBy` | object | åˆ›å»ºäººä¿¡æ¯ |
| `total` | number | æ€»è®°å½•æ•° |
| `page` | number | å½“å‰é¡µç  |
| `pageSize` | number | æ¯é¡µæ•°é‡ |
| `totalPages` | number | æ€»é¡µæ•° |

---

### è·å–æ–‡ç« è¯¦æƒ…

è·å–å•ç¯‡æ–‡ç« çš„å®Œæ•´å†…å®¹ï¼ŒåŒ…æ‹¬æ­£æ–‡å’Œå›¾ç‰‡ã€‚

#### è¯·æ±‚

```http
GET /api/articles/miniprogram/:id
```

**è®¤è¯**: âŒ æ— éœ€ç™»å½•ï¼ˆå…¬å¼€æ¥å£ï¼Œè‡ªåŠ¨åªè¿”å›å·²å‘å¸ƒæ–‡ç« ï¼‰

#### è·¯å¾„å‚æ•°

| å‚æ•° | ç±»å‹ | å¿…å¡« | è¯´æ˜ |
|------|------|------|------|
| `id` | string | æ˜¯ | æ–‡ç« ID |

#### å“åº”

```json
{
  "success": true,
  "data": {
    "_id": "6967700ebaf1a7bfe723665c",
    "title": "æ–°ç”Ÿå„¿æŠ¤ç†è¦ç‚¹",
    "author": "æ–°åç¤¾",
    "source": "äººæ°‘æ—¥æŠ¥",
    "contentRaw": "æ–°ç”Ÿå„¿æŠ¤ç†æ˜¯æ¯ä¸ªæ–°æ‰‹çˆ¶æ¯éƒ½éœ€è¦æŒæ¡çš„æŠ€èƒ½...\n\n## ä¸€ã€æ¸©åº¦æ§åˆ¶\n\næ–°ç”Ÿå„¿ä½“æ¸©è°ƒèŠ‚èƒ½åŠ›è¾ƒå¼±...",
    "contentHtml": "<p>æ–°ç”Ÿå„¿æŠ¤ç†æ˜¯æ¯ä¸ªæ–°æ‰‹çˆ¶æ¯éƒ½éœ€è¦æŒæ¡çš„æŠ€èƒ½...</p><h2>ä¸€ã€æ¸©åº¦æ§åˆ¶</h2><p>æ–°ç”Ÿå„¿ä½“æ¸©è°ƒèŠ‚èƒ½åŠ›è¾ƒå¼±...</p>",
    "imageUrls": [
      "https://housekeeping-1254058915.cos.ap-guangzhou.myqcloud.com/article/image1.jpg",
      "https://housekeeping-1254058915.cos.ap-guangzhou.myqcloud.com/article/image2.jpg"
    ],
    "status": "published",
    "createdAt": "2026-01-15T10:00:00.000Z",
    "updatedAt": "2026-01-15T10:00:00.000Z",
    "createdBy": {
      "_id": "user123",
      "name": "ç®¡ç†å‘˜",
      "username": "admin"
    },
    "updatedBy": {
      "_id": "user123",
      "name": "ç®¡ç†å‘˜",
      "username": "admin"
    }
  },
  "message": "è·å–æˆåŠŸ"
}
```

#### å“åº”å­—æ®µè¯´æ˜

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| `_id` | string | æ–‡ç« å”¯ä¸€ID |
| `title` | string | æ–‡ç« æ ‡é¢˜ |
| `author` | string | ä½œè€… |
| `source` | string | æ¥æº/å‡ºå¤„ |
| `contentRaw` | string | åŸå§‹æ­£æ–‡å†…å®¹ï¼ˆæ”¯æŒç®€æ˜“Markdownæ ¼å¼ï¼‰ |
| `contentHtml` | string | HTMLæ ¼å¼çš„æ­£æ–‡å†…å®¹ï¼ˆå·²å¤„ç†æ ¼å¼ï¼‰ |
| `imageUrls` | array | å›¾ç‰‡URLåˆ—è¡¨ï¼ˆè…¾è®¯äº‘COSï¼‰ |
| `status` | string | çŠ¶æ€ï¼š`draft`ï¼ˆè‰ç¨¿ï¼‰ã€`published`ï¼ˆå·²å‘å¸ƒï¼‰ |
| `createdAt` | string | åˆ›å»ºæ—¶é—´ï¼ˆISO 8601æ ¼å¼ï¼‰ |
| `updatedAt` | string | æ›´æ–°æ—¶é—´ï¼ˆISO 8601æ ¼å¼ï¼‰ |
| `createdBy` | object | åˆ›å»ºäººä¿¡æ¯ |
| `updatedBy` | object | æœ€åæ›´æ–°äººä¿¡æ¯ |

#### å°ç¨‹åºè°ƒç”¨ç¤ºä¾‹

```javascript
// utils/api.js
const BASE_URL = 'https://crm.andejiazheng.com/api';

/**
 * è·å–æ–‡ç« åˆ—è¡¨ï¼ˆå°ç¨‹åºä¸“ç”¨å…¬å¼€æ¥å£ï¼‰
 * @param {Object} params - æŸ¥è¯¢å‚æ•°
 * @param {string} params.keyword - æœç´¢å…³é”®è¯
 * @param {number} params.page - é¡µç 
 * @param {number} params.pageSize - æ¯é¡µæ•°é‡
 * @returns {Promise<Object>} æ–‡ç« åˆ—è¡¨æ•°æ®
 */
export function getArticleList(params = {}) {
  const { keyword = '', page = 1, pageSize = 10 } = params;

  return new Promise((resolve, reject) => {
    wx.request({
      url: `${BASE_URL}/articles/miniprogram/list`,
      method: 'GET',
      data: {
        keyword,
        page,
        pageSize
      },
      success(res) {
        if (res.data.success) {
          resolve(res.data.data);
        } else {
          reject(new Error(res.data.message || 'è·å–æ–‡ç« åˆ—è¡¨å¤±è´¥'));
        }
      },
      fail(err) {
        reject(err);
      }
    });
  });
}

/**
 * è·å–æ–‡ç« è¯¦æƒ…ï¼ˆå°ç¨‹åºä¸“ç”¨å…¬å¼€æ¥å£ï¼‰
 * @param {string} id - æ–‡ç« ID
 * @returns {Promise<Object>} æ–‡ç« è¯¦æƒ…æ•°æ®
 */
export function getArticleDetail(id) {
  return new Promise((resolve, reject) => {
    wx.request({
      url: `${BASE_URL}/articles/miniprogram/${id}`,
      method: 'GET',
      success(res) {
        if (res.data.success) {
          resolve(res.data.data);
        } else {
          reject(new Error(res.data.message || 'è·å–æ–‡ç« è¯¦æƒ…å¤±è´¥'));
        }
      },
      fail(err) {
        reject(err);
      }
    });
  });
}
```

```javascript
// pages/article/list/list.js
import { getArticleList } from '../../../utils/api';

Page({
  data: {
    articleList: [],
    page: 1,
    pageSize: 10,
    total: 0,
    loading: false,
    hasMore: true
  },

  onLoad() {
    this.loadArticles();
  },

  async loadArticles() {
    if (this.data.loading || !this.data.hasMore) return;

    this.setData({ loading: true });

    try {
      const result = await getArticleList({
        page: this.data.page,
        pageSize: this.data.pageSize
      });

      this.setData({
        articleList: [...this.data.articleList, ...result.list],
        total: result.total,
        page: this.data.page + 1,
        hasMore: this.data.articleList.length + result.list.length < result.total,
        loading: false
      });
    } catch (err) {
      console.error('åŠ è½½æ–‡ç« å¤±è´¥:', err);
      wx.showToast({
        title: 'åŠ è½½å¤±è´¥',
        icon: 'none'
      });
      this.setData({ loading: false });
    }
  },

  // ä¸‹æ‹‰åˆ·æ–°
  onPullDownRefresh() {
    this.setData({
      articleList: [],
      page: 1,
      hasMore: true
    });
    this.loadArticles().then(() => {
      wx.stopPullDownRefresh();
    });
  },

  // ä¸Šæ‹‰åŠ è½½æ›´å¤š
  onReachBottom() {
    this.loadArticles();
  },

  // è·³è½¬åˆ°æ–‡ç« è¯¦æƒ…
  goToDetail(e) {
    const { id } = e.currentTarget.dataset;
    wx.navigateTo({
      url: `/pages/article/detail/detail?id=${id}`
    });
  }
});
```

```javascript
// pages/article/detail/detail.js
import { getArticleDetail } from '../../../utils/api';

Page({
  data: {
    article: null,
    loading: true
  },

  onLoad(options) {
    const { id } = options;
    if (id) {
      this.loadArticle(id);
    }
  },

  async loadArticle(id) {
    try {
      const article = await getArticleDetail(id);
      this.setData({
        article,
        loading: false
      });
    } catch (err) {
      console.error('åŠ è½½æ–‡ç« è¯¦æƒ…å¤±è´¥:', err);
      wx.showToast({
        title: 'åŠ è½½å¤±è´¥',
        icon: 'none'
      });
      this.setData({ loading: false });
    }
  }
});
```

```html
<!-- pages/article/list/list.wxml -->
<view class="article-list">
  <view class="article-item" wx:for="{{articleList}}" wx:key="_id"
        bindtap="goToDetail" data-id="{{item._id}}">
    <view class="article-title">{{item.title}}</view>
    <view class="article-meta">
      <text class="author">{{item.author}}</text>
      <text class="date">{{item.createdAt}}</text>
    </view>
  </view>

  <view class="loading" wx:if="{{loading}}">åŠ è½½ä¸­...</view>
  <view class="no-more" wx:if="{{!hasMore && articleList.length > 0}}">æ²¡æœ‰æ›´å¤šäº†</view>
</view>
```

```html
<!-- pages/article/detail/detail.wxml -->
<view class="article-detail" wx:if="{{article}}">
  <view class="article-header">
    <view class="article-title">{{article.title}}</view>
    <view class="article-meta">
      <text class="author">ä½œè€…ï¼š{{article.author}}</text>
      <text class="source" wx:if="{{article.source}}">æ¥æºï¼š{{article.source}}</text>
      <text class="date">{{article.createdAt}}</text>
    </view>
  </view>

  <view class="article-content">
    <rich-text nodes="{{article.contentHtml}}"></rich-text>
  </view>

  <view class="article-images" wx:if="{{article.imageUrls.length > 0}}">
    <image wx:for="{{article.imageUrls}}" wx:key="index"
           src="{{item}}" mode="widthFix" class="article-image" />
  </view>
</view>
```

---

## ğŸ“ ç®€å†ç®¡ç†

### åˆ›å»ºç®€å†

åˆ›å»ºä¸€ä¸ªæ–°çš„ç®€å†è®°å½•ã€‚

#### è¯·æ±‚

```http
POST /api/resumes/miniprogram/create
Authorization: Bearer {token}
Content-Type: application/json
Idempotency-Key: {unique-key}  # å¯é€‰ï¼Œç”¨äºé˜²æ­¢é‡å¤æäº¤

{
  "name": "å¼ ä¸‰",
  "phone": "13800138000",
  "gender": "female",
  "age": 35,
  "jobType": "yuexin",
  "education": "high",
  "maternityNurseLevel": "gold",
  "expectedSalary": 8000,
  "nativePlace": "æ²³å—çœéƒ‘å·å¸‚",
  "experienceYears": 3,
  "skills": ["chanhou", "yuying"],
  "serviceArea": ["åŒ—äº¬å¸‚æœé˜³åŒº"],
  "selfIntroduction": "è‡ªæˆ‘ä»‹ç»å†…å®¹",
  "wechat": "wechat123",
  "currentAddress": "åŒ—äº¬å¸‚æœé˜³åŒº",
  "hukouAddress": "æ²³å—çœéƒ‘å·å¸‚",
  "birthDate": "1990-01-01",
  "idNumber": "410102199001011234",
  "ethnicity": "æ±‰æ—",
  "zodiac": "é©¬",
  "zodiacSign": "æ‘©ç¾¯åº§",
  "maritalStatus": "married",
  "religion": "æ— ",
  "emergencyContactName": "æå››",
  "emergencyContactPhone": "13900139000",
  "medicalExamDate": "2024-01-01",
  "orderStatus": "available",
  "learningIntention": "yes",
  "currentStage": "working",
  "workExperiences": [
    {
      "startDate": "2020-01-01",
      "endDate": "2020-03-31",
      "description": "åœ¨åŒ—äº¬æœé˜³åŒºæŸå®¶åº­æ‹…ä»»æœˆå«‚ï¼Œè´Ÿè´£æ–°ç”Ÿå„¿æŠ¤ç†å’Œäº§å¦‡æœˆå­é¤",
      "orderNumber": "CON12345678901",
      "district": "chaoyang",
      "customerName": "å¼ å¥³å£«",
      "customerReview": "æœåŠ¡æ€åº¦å¥½ï¼Œä¸“ä¸šæŠ€èƒ½å¼ºï¼Œå®å®æŠ¤ç†å¾—å¾ˆå¥½",
      "photos": [
        {
          "url": "https://cos.example.com/work-photo-1.jpg",
          "name": "å·¥ä½œç…§ç‰‡1.jpg",
          "size": 102400,
          "mimeType": "image/jpeg"
        }
      ]
    },
    {
      "startDate": "2020-05-01",
      "endDate": "2020-07-31",
      "description": "åœ¨åŒ—äº¬æµ·æ·€åŒºæŸå®¶åº­æ‹…ä»»æœˆå«‚",
      "orderNumber": "CON12345678902",
      "district": "haidian",
      "customerName": "æå¥³å£«"
    }
  ]
}
```

#### å¿…å¡«å­—æ®µ

| å­—æ®µ | ç±»å‹ | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|------|
| `name` | string | å§“åï¼Œ2-20å­—ç¬¦ | "å¼ ä¸‰" |
| `phone` | string | æ‰‹æœºå·ç ï¼Œ11ä½æ•°å­— | "13800138000" |
| `gender` | string | æ€§åˆ«ï¼š"female" æˆ– "male" | "female" |
| `age` | number | å¹´é¾„ï¼Œ18-65å² | 35 |
| `jobType` | string | å·¥ç§ç±»å‹ï¼Œè§[å·¥ç§ç±»å‹](#å·¥ç§ç±»å‹) | "yuexin" |
| `education` | string | å­¦å†ï¼Œè§[å­¦å†ç±»å‹](#å­¦å†ç±»å‹) | "high" |

#### å¯é€‰å­—æ®µ

| å­—æ®µ | ç±»å‹ | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|------|
| `maternityNurseLevel` | string | æœˆå«‚æ¡£ä½ï¼ˆä»…æœˆå«‚ï¼‰ï¼Œè§[æœˆå«‚æ¡£ä½](#æœˆå«‚æ¡£ä½) | "gold" |
| `expectedSalary` | number | æœŸæœ›è–ªèµ„ | 8000 |
| `nativePlace` | string | ç±è´¯ï¼Œæœ€å¤§20å­—ç¬¦ | "æ²³å—çœéƒ‘å·å¸‚" |
| `experienceYears` | number | å·¥ä½œç»éªŒå¹´é™ | 3 |
| `skills` | array | æŠ€èƒ½åˆ—è¡¨ | ["chanhou", "yuying"] |
| `serviceArea` | array | æœåŠ¡åŒºåŸŸ | ["åŒ—äº¬å¸‚æœé˜³åŒº"] |
| `selfIntroduction` | string | è‡ªæˆ‘ä»‹ç» | "è‡ªæˆ‘ä»‹ç»å†…å®¹" |
| `wechat` | string | å¾®ä¿¡å· | "wechat123" |
| `currentAddress` | string | ç°å±…åœ°å€ | "åŒ—äº¬å¸‚æœé˜³åŒº" |
| `hukouAddress` | string | æˆ·å£åœ°å€ | "æ²³å—çœéƒ‘å·å¸‚" |
| `birthDate` | string | å‡ºç”Ÿæ—¥æœŸï¼Œæ ¼å¼ï¼šYYYY-MM-DD | "1990-01-01" |
| `idNumber` | string | èº«ä»½è¯å· | "410102199001011234" |
| `ethnicity` | string | æ°‘æ— | "æ±‰æ—" |
| `zodiac` | string | ç”Ÿè‚– | "é©¬" |
| `zodiacSign` | string | æ˜Ÿåº§ | "æ‘©ç¾¯åº§" |
| `maritalStatus` | string | å©šå§»çŠ¶å†µï¼Œè§[å©šå§»çŠ¶å†µ](#å©šå§»çŠ¶å†µ) | "married" |
| `religion` | string | å®—æ•™ä¿¡ä»° | "æ— " |
| `emergencyContactName` | string | ç´§æ€¥è”ç³»äººå§“å | "æå››" |
| `emergencyContactPhone` | string | ç´§æ€¥è”ç³»äººç”µè¯ | "13900139000" |
| `medicalExamDate` | string | ä½“æ£€æ—¥æœŸï¼Œæ ¼å¼ï¼šYYYY-MM-DD | "2024-01-01" |
| `orderStatus` | string | æ¥å•çŠ¶æ€ï¼Œè§[æ¥å•çŠ¶æ€](#æ¥å•çŠ¶æ€) | "available" |
| `learningIntention` | string | åŸ¹è®­æ„å‘ï¼Œè§[åŸ¹è®­æ„å‘](#åŸ¹è®­æ„å‘) | "yes" |
| `currentStage` | string | å½“å‰é˜¶æ®µï¼Œè§[å½“å‰é˜¶æ®µ](#å½“å‰é˜¶æ®µ) | "working" |
| `workExperiences` | array | å·¥ä½œç»å†æ•°ç»„ï¼ˆè¯¦è§ä¸‹æ–¹è¯´æ˜ï¼‰ | è§ä¸‹æ–¹è¯´æ˜ |

#### å·¥ä½œç»å†å¯¹è±¡ç»“æ„

```json
{
  // å¿…å¡«å­—æ®µ
  "startDate": "2020-01-01",      // å¿…å¡«ï¼šå¼€å§‹æ—¥æœŸï¼ˆYYYY-MM-DDï¼‰
  "endDate": "2023-12-31",        // å¿…å¡«ï¼šç»“æŸæ—¥æœŸï¼ˆYYYY-MM-DDï¼‰
  "description": "åœ¨åŒ—äº¬æœé˜³åŒºæŸå®¶åº­æ‹…ä»»æœˆå«‚ï¼Œè´Ÿè´£æ–°ç”Ÿå„¿æŠ¤ç†å’Œäº§å¦‡æœˆå­é¤",  // å¿…å¡«ï¼šå·¥ä½œæè¿°

  // å¯é€‰å­—æ®µï¼ˆæ–°å¢ï¼‰
  "orderNumber": "CON12345678901",  // å¯é€‰ï¼šè®¢å•ç¼–å·ï¼ˆæ ¼å¼ï¼šCON{11ä½æ•°å­—}ï¼‰
  "district": "chaoyang",           // å¯é€‰ï¼šæœåŠ¡åŒºåŸŸï¼ˆåŒ—äº¬å¸‚åŒºå¿ä»£ç ï¼‰
  "customerName": "å¼ å¥³å£«",         // å¯é€‰ï¼šå®¢æˆ·å§“å
  "customerReview": "æœåŠ¡æ€åº¦å¥½ï¼Œä¸“ä¸šæŠ€èƒ½å¼ºï¼Œå®å®æŠ¤ç†å¾—å¾ˆå¥½",  // å¯é€‰ï¼šå®¢æˆ·è¯„ä»·
  "photos": [                       // å¯é€‰ï¼šå·¥ä½œç…§ç‰‡æ•°ç»„
    {
      "url": "https://cos.example.com/work-photo-1.jpg",  // å¿…å¡«ï¼šå›¾ç‰‡URL
      "name": "å·¥ä½œç…§ç‰‡1.jpg",      // å¯é€‰ï¼šæ–‡ä»¶å
      "size": 102400,               // å¯é€‰ï¼šæ–‡ä»¶å¤§å°ï¼ˆå­—èŠ‚ï¼‰
      "mimeType": "image/jpeg"      // å¯é€‰ï¼šMIMEç±»å‹
    }
  ]
}
```

**åŒ—äº¬å¸‚åŒºå¿ä»£ç **ï¼š
```
dongcheng: ä¸œåŸåŒº      xicheng: è¥¿åŸåŒº       chaoyang: æœé˜³åŒº
fengtai: ä¸°å°åŒº        shijingshan: çŸ³æ™¯å±±åŒº  haidian: æµ·æ·€åŒº
mentougou: é—¨å¤´æ²ŸåŒº    fangshan: æˆ¿å±±åŒº      tongzhou: é€šå·åŒº
shunyi: é¡ºä¹‰åŒº         changping: æ˜Œå¹³åŒº     daxing: å¤§å…´åŒº
huairou: æ€€æŸ”åŒº        pinggu: å¹³è°·åŒº        miyun: å¯†äº‘åŒº
yanqing: å»¶åº†åŒº
```

#### æˆåŠŸå“åº” (201)

```json
{
  "success": true,
  "data": {
    "id": "66e2f4af8b1234567890abcd",
    "createdAt": "2025-09-12T10:19:27.671Z",
    "action": "CREATED",
    "resume": {
      "id": "66e2f4af8b1234567890abcd",
      "name": "å¼ ä¸‰",
      "phone": "13800138000",
      "age": 35,
      "gender": "female",
      "jobType": "yuexin",
      "education": "high",
      "maternityNurseLevel": "gold",
      "expectedSalary": 8000,
      // ... å…¶ä»–å­—æ®µ
    }
  },
  "message": "åˆ›å»ºç®€å†æˆåŠŸ"
}
```

#### é”™è¯¯å“åº”

**é‡å¤æ‰‹æœºå· (409)**:
```json
{
  "success": false,
  "code": "DUPLICATE",
  "data": {
    "existingId": "66e2f4af8b1234567890abcd"
  },
  "message": "è¯¥æ‰‹æœºå·å·²è¢«ä½¿ç”¨"
}
```

**éªŒè¯é”™è¯¯ (400)**:
```json
{
  "success": false,
  "code": "VALIDATION_ERROR",
  "data": {
    "errors": ["å§“åä¸èƒ½ä¸ºç©º", "æ‰‹æœºå·ç æ ¼å¼ä¸æ­£ç¡®"]
  },
  "message": "æ•°æ®éªŒè¯å¤±è´¥"
}
```

---

### è·å–ç®€å†è¯¦æƒ…

è·å–æŒ‡å®šIDçš„ç®€å†è¯¦ç»†ä¿¡æ¯ã€‚

#### è¯·æ±‚

```http
GET /api/resumes/miniprogram/{id}
Authorization: Bearer {token}
```

#### è·¯å¾„å‚æ•°

| å‚æ•° | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| `id` | string | ç®€å†ID |

#### æˆåŠŸå“åº” (200)

```json
{
  "success": true,
  "data": {
    "id": "66e2f4af8b1234567890abcd",
    "name": "å¼ ä¸‰",
    "phone": "13800138000",
    "age": 35,
    "gender": "female",
    "jobType": "yuexin",
    "education": "high",
    "experienceYears": 3,
    "nativePlace": "æ²³å—çœéƒ‘å·å¸‚",
    "selfIntroduction": "è‡ªæˆ‘ä»‹ç»å†…å®¹",
    "wechat": "wechat123",
    "currentAddress": "åŒ—äº¬å¸‚æœé˜³åŒº",
    "hukouAddress": "æ²³å—çœéƒ‘å·å¸‚",
    "birthDate": "1990-01-01",
    "skills": ["chanhou", "yuying"],
    "serviceArea": ["åŒ—äº¬å¸‚æœé˜³åŒº"],
    "expectedSalary": 8000,
    "maternityNurseLevel": "gold",
    "workExperiences": [
      {
        "startDate": "2020-01-01",
        "endDate": "2020-03-31",
        "description": "åœ¨åŒ—äº¬æœé˜³åŒºæŸå®¶åº­æ‹…ä»»æœˆå«‚ï¼Œè´Ÿè´£æ–°ç”Ÿå„¿æŠ¤ç†å’Œäº§å¦‡æœˆå­é¤",
        "orderNumber": "CON12345678901",
        "district": "chaoyang",
        "customerName": "å¼ å¥³å£«",
        "customerReview": "æœåŠ¡æ€åº¦å¥½ï¼Œä¸“ä¸šæŠ€èƒ½å¼ºï¼Œå®å®æŠ¤ç†å¾—å¾ˆå¥½",
        "photos": [
          {
            "url": "https://cos.example.com/work-photo-1.jpg",
            "name": "å·¥ä½œç…§ç‰‡1.jpg",
            "size": 102400,
            "mimeType": "image/jpeg"
          },
          {
            "url": "https://cos.example.com/work-photo-2.jpg",
            "name": "å·¥ä½œç…§ç‰‡2.jpg",
            "size": 98304,
            "mimeType": "image/jpeg"
          }
        ]
      },
      {
        "startDate": "2020-05-01",
        "endDate": "2020-07-31",
        "description": "åœ¨åŒ—äº¬æµ·æ·€åŒºæŸå®¶åº­æ‹…ä»»æœˆå«‚",
        "orderNumber": "CON12345678902",
        "district": "haidian",
        "customerName": "æå¥³å£«"
      }
    ],
    "idCardFront": {
      "url": "https://example.com/idcard-front.jpg",
      "key": "uploads/idcard/front.jpg"
    },
    "idCardBack": {
      "url": "https://example.com/idcard-back.jpg",
      "key": "uploads/idcard/back.jpg"
    },
    "personalPhoto": [
      {
        "url": "https://example.com/photo1.jpg",
        "key": "uploads/photo/photo1.jpg"
      }
    ],
    "certificates": [
      {
        "url": "https://example.com/cert1.jpg",
        "key": "uploads/cert/cert1.jpg"
      }
    ],
    "reports": [
      {
        "url": "https://example.com/report1.jpg",
        "key": "uploads/report/report1.jpg"
      }
    ],
    "selfIntroductionVideo": {
      "url": "https://example.com/video.mp4",
      "key": "uploads/video/video.mp4"
    },
    "employeeEvaluations": [
      {
        "_id": "694e0a9a8878020d398b7f61",
        "employeeId": "66e2f4af8b1234567890abcd",
        "employeeName": "å¼ ä¸‰",
        "evaluationType": "daily",
        "overallRating": 4.5,
        "serviceAttitudeRating": 5,
        "professionalSkillRating": 4,
        "workEfficiencyRating": 4.5,
        "communicationRating": 4.5,
        "comment": "å·¥ä½œè®¤çœŸè´Ÿè´£ï¼ŒæŠ€èƒ½ç†Ÿç»ƒï¼Œæ²Ÿé€šè‰¯å¥½",
        "tags": ["è®¤çœŸè´Ÿè´£", "æŠ€èƒ½ç†Ÿç»ƒ"],
        "isPublic": true,
        "status": "published",
        "createdAt": "2025-01-15T10:00:00.000Z"
      }
    ],
    "recommendationTags": [
      {
        "tag": "å½¢è±¡æ°”è´¨å¥½",
        "count": 3
      },
      {
        "tag": "å¥½æ²Ÿé€š",
        "count": 3
      },
      {
        "tag": "ç›¸å¤„æ„‰å¿«",
        "count": 3
      },
      {
        "tag": "è®¤çœŸè´Ÿè´£",
        "count": 2
      },
      {
        "tag": "æŠ€èƒ½ç†Ÿç»ƒ",
        "count": 1
      }
    ],
    "createdAt": "2025-09-12T10:19:27.671Z",
    "updatedAt": "2025-09-12T10:19:27.671Z"
  },
  "message": "è·å–ç®€å†æˆåŠŸ"
}
```

#### é”™è¯¯å“åº”

**ç®€å†ä¸å­˜åœ¨ (404)**:
```json
{
  "success": false,
  "data": null,
  "message": "ç®€å†ä¸å­˜åœ¨"
}
```

---

### æ›´æ–°ç®€å†

æ›´æ–°æŒ‡å®šIDçš„ç®€å†ä¿¡æ¯ã€‚æ”¯æŒéƒ¨åˆ†æ›´æ–°ï¼Œåªéœ€ä¼ é€’éœ€è¦æ›´æ–°çš„å­—æ®µã€‚

#### è¯·æ±‚

```http
PUT /api/resumes/miniprogram/{id}
Authorization: Bearer {token}
Content-Type: application/json

{
  "expectedSalary": 9000,
  "maternityNurseLevel": "platinum",
  "selfIntroduction": "æ›´æ–°åçš„è‡ªæˆ‘ä»‹ç»",
  "orderStatus": "available"
}
```

#### è·¯å¾„å‚æ•°

| å‚æ•° | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| `id` | string | ç®€å†ID |

#### å¯æ›´æ–°å­—æ®µ

é™¤äº† `phone`ï¼ˆæ‰‹æœºå·ï¼‰å¤–ï¼Œæ‰€æœ‰åˆ›å»ºæ—¶çš„å¯é€‰å­—æ®µéƒ½å¯ä»¥æ›´æ–°ã€‚

#### æˆåŠŸå“åº” (200)

```json
{
  "success": true,
  "data": {
    "id": "66e2f4af8b1234567890abcd",
    "name": "å¼ ä¸‰",
    "phone": "13800138000",
    "age": 35,
    "gender": "female",
    "jobType": "yuexin",
    "education": "high",
    "experienceYears": 3,
    "expectedSalary": 9000,
    "maternityNurseLevel": "platinum",
    "nativePlace": "æ²³å—çœéƒ‘å·å¸‚",
    "skills": ["chanhou", "yuying"],
    "serviceArea": ["åŒ—äº¬å¸‚æœé˜³åŒº"],
    "selfIntroduction": "æ›´æ–°åçš„è‡ªæˆ‘ä»‹ç»",
    "orderStatus": "available",
    // ... å…¶ä»–å­—æ®µ
  },
  "message": "æ›´æ–°ç®€å†æˆåŠŸ"
}
```

#### é”™è¯¯å“åº”

**ç®€å†ä¸å­˜åœ¨ (404)**:
```json
{
  "success": false,
  "message": "ç®€å†ä¸å­˜åœ¨"
}
```

**éªŒè¯é”™è¯¯ (400)**:
```json
{
  "success": false,
  "code": "VALIDATION_ERROR",
  "data": {
    "errors": ["å¹´é¾„å¿…é¡»åœ¨18-65ä¹‹é—´"]
  },
  "message": "æ•°æ®éªŒè¯å¤±è´¥"
}
```

---

### æ¨èç†ç”±æ ‡ç­¾è¯´æ˜

#### ğŸ“Œ åŠŸèƒ½è¯´æ˜

æ¨èç†ç”±æ ‡ç­¾ï¼ˆ`recommendationTags`ï¼‰æ˜¯ç³»ç»Ÿè‡ªåŠ¨ä»**å®¢æˆ·è¯„ä»·**å’Œ**å†…éƒ¨å‘˜å·¥è¯„ä»·**ä¸­æå–çš„å…³é”®è¯æ ‡ç­¾ï¼Œç”¨äºå¿«é€Ÿå±•ç¤ºå‘˜å·¥çš„ä¼˜åŠ¿ç‰¹ç‚¹ã€‚

#### ğŸ¯ æ•°æ®æ¥æº

æ¨èç†ç”±æ ‡ç­¾ä»ä»¥ä¸‹3ä¸ªæ¸ é“è‡ªåŠ¨æå–ï¼š

1. **å†…éƒ¨å‘˜å·¥è¯„ä»·çš„tagså­—æ®µ**
   - ç›´æ¥ä»å‘˜å·¥è¯„ä»·è¡¨çš„ `tags` æ•°ç»„æå–
   - æ¡ä»¶ï¼šè¯„ä»·çŠ¶æ€ä¸º `published`ï¼ˆå·²å‘å¸ƒï¼‰
   - åªç»Ÿè®¡é•¿åº¦åœ¨2-6ä¸ªå­—ä¹‹é—´çš„æ ‡ç­¾

2. **å†…éƒ¨å‘˜å·¥è¯„ä»·çš„commentå†…å®¹**
   - ä»è¯„ä»·å†…å®¹ä¸­æ™ºèƒ½æå–å…³é”®è¯
   - ä½¿ç”¨å†…ç½®çš„30+ä¸ªæ­£é¢è¯„ä»·å…³é”®è¯åº“è¿›è¡ŒåŒ¹é…
   - å…³é”®è¯ç¤ºä¾‹ï¼šå½¢è±¡æ°”è´¨å¥½ã€å¥½æ²Ÿé€šã€ç›¸å¤„æ„‰å¿«ã€åšäº‹è®¤çœŸã€ä¸“ä¸šçŸ¥è¯†ä¸°å¯Œç­‰

3. **å·¥ä½œç»å†ä¸­çš„å®¢æˆ·è¯„ä»·**
   - ä» `workHistory` æ•°ç»„ä¸­çš„ `customerReview` å­—æ®µæå–
   - åŒæ ·ä½¿ç”¨å…³é”®è¯åº“è¿›è¡ŒåŒ¹é…

#### ğŸ“Š ç»Ÿè®¡è§„åˆ™

- **æ ‡ç­¾èšåˆ**ï¼šå°†3ä¸ªæ¥æºçš„æ ‡ç­¾åˆå¹¶ç»Ÿè®¡
- **è®¡æ•°ç´¯åŠ **ï¼šç›¸åŒæ ‡ç­¾çš„å‡ºç°æ¬¡æ•°ç´¯åŠ 
- **æ’åºè§„åˆ™**ï¼šæŒ‰å‡ºç°æ¬¡æ•°ä»é«˜åˆ°ä½æ’åº
- **è¿”å›æ ¼å¼**ï¼š`[{tag: "æ ‡ç­¾å", count: æ¬¡æ•°}, ...]`

#### ğŸ’¡ ä½¿ç”¨ç¤ºä¾‹

```javascript
// å°ç¨‹åºç«¯è°ƒç”¨
wx.request({
  url: 'https://crm.andejiazheng.com/api/resumes/miniprogram/694e0a9a8878020d398b7f60',
  method: 'GET',
  success: (res) => {
    const { recommendationTags } = res.data.data;

    // æ˜¾ç¤ºæ¨èç†ç”±æ ‡ç­¾
    // recommendationTags = [
    //   { tag: "å½¢è±¡æ°”è´¨å¥½", count: 3 },
    //   { tag: "å¥½æ²Ÿé€š", count: 3 },
    //   { tag: "ç›¸å¤„æ„‰å¿«", count: 3 },
    //   { tag: "è®¤çœŸè´Ÿè´£", count: 2 },
    //   { tag: "æŠ€èƒ½ç†Ÿç»ƒ", count: 1 }
    // ]

    // æ¸²æŸ“æ ‡ç­¾
    recommendationTags.forEach(item => {
      console.log(`${item.tag}(${item.count})`);
    });
  }
});
```

#### ğŸ¨ UIå±•ç¤ºå»ºè®®

```html
<!-- æ¨èç†ç”±æ ‡ç­¾å±•ç¤º -->
<view class="recommendation-tags">
  <view class="tag-title">æ¨èç†ç”±</view>
  <view class="tag-list">
    <view
      class="tag-item"
      wx:for="{{recommendationTags}}"
      wx:key="tag"
    >
      {{item.tag}}({{item.count}})
    </view>
  </view>
</view>
```

```css
.recommendation-tags {
  padding: 20rpx;
  background: #f5f5f5;
  border-radius: 10rpx;
}

.tag-title {
  font-size: 32rpx;
  font-weight: bold;
  margin-bottom: 20rpx;
}

.tag-list {
  display: flex;
  flex-wrap: wrap;
  gap: 16rpx;
}

.tag-item {
  padding: 12rpx 24rpx;
  background: #1890ff;
  color: white;
  border-radius: 8rpx;
  font-size: 28rpx;
}
```

#### âš ï¸ æ³¨æ„äº‹é¡¹

1. **è‡ªåŠ¨ç”Ÿæˆ**ï¼šæ ‡ç­¾ç”±ç³»ç»Ÿè‡ªåŠ¨æå–ï¼Œæ— éœ€æ‰‹åŠ¨ç»´æŠ¤
2. **å®æ—¶æ›´æ–°**ï¼šæ¯æ¬¡æ·»åŠ æ–°è¯„ä»·åï¼Œæ ‡ç­¾ä¼šè‡ªåŠ¨æ›´æ–°
3. **å¯èƒ½ä¸ºç©º**ï¼šå¦‚æœæ²¡æœ‰è¯„ä»·æ•°æ®ï¼Œ`recommendationTags` å°†è¿”å›ç©ºæ•°ç»„ `[]`
4. **éœ€è¦è®¤è¯**ï¼šè·å–ç®€å†è¯¦æƒ…æ¥å£éœ€è¦JWTè®¤è¯ï¼Œæ™®é€šå‘˜å·¥ä»…å¯æŸ¥çœ‹è‡ªå·±åˆ›å»ºçš„ç®€å†

---

## ğŸ“ æ–‡ä»¶ä¸Šä¼ 

### ä¸Šä¼ æ–‡ä»¶

ä¸Šä¼ å„ç±»æ–‡ä»¶ï¼ˆç…§ç‰‡ã€è¯ä¹¦ã€è§†é¢‘ç­‰ï¼‰ã€‚

#### è¯·æ±‚

```http
POST /api/upload/miniprogram
Authorization: Bearer {token}
Content-Type: multipart/form-data

file: [æ–‡ä»¶äºŒè¿›åˆ¶æ•°æ®]
type: "idcard-front" | "idcard-back" | "photo" | "certificate" | "report" | "video"
```

#### æ–‡ä»¶ç±»å‹è¯´æ˜

| typeå€¼ | è¯´æ˜ | æ”¯æŒæ ¼å¼ | å¤§å°é™åˆ¶ |
|--------|------|----------|----------|
| `idcard-front` | èº«ä»½è¯æ­£é¢ | jpg, jpeg, png | 5MB |
| `idcard-back` | èº«ä»½è¯åé¢ | jpg, jpeg, png | 5MB |
| `photo` | ä¸ªäººç…§ç‰‡ | jpg, jpeg, png | 5MB |
| `certificate` | è¯ä¹¦ç…§ç‰‡ | jpg, jpeg, png | 5MB |
| `report` | ä½“æ£€æŠ¥å‘Š | jpg, jpeg, png, pdf | 10MB |
| `video` | è‡ªæˆ‘ä»‹ç»è§†é¢‘ | mp4, mov | 50MB |

#### æˆåŠŸå“åº” (200)

```json
{
  "success": true,
  "data": {
    "url": "https://example.com/uploads/photo/123456.jpg",
    "key": "uploads/photo/123456.jpg",
    "size": 102400,
    "mimeType": "image/jpeg"
  },
  "message": "ä¸Šä¼ æˆåŠŸ"
}
```

#### é”™è¯¯å“åº”

**æ–‡ä»¶è¿‡å¤§ (413)**:
```json
{
  "success": false,
  "message": "æ–‡ä»¶å¤§å°è¶…è¿‡é™åˆ¶"
}
```

**æ–‡ä»¶æ ¼å¼ä¸æ”¯æŒ (400)**:
```json
{
  "success": false,
  "message": "ä¸æ”¯æŒçš„æ–‡ä»¶æ ¼å¼"
}
```

### åˆ é™¤æ–‡ä»¶

åˆ é™¤å·²ä¸Šä¼ çš„æ–‡ä»¶ã€‚

#### è¯·æ±‚

```http
DELETE /api/upload/miniprogram
Authorization: Bearer {token}
Content-Type: application/json

{
  "key": "uploads/photo/123456.jpg"
}
```

#### æˆåŠŸå“åº” (200)

```json
{
  "success": true,
  "message": "åˆ é™¤æˆåŠŸ"
}
```

---

### ç®€å†æ–‡ä»¶ä¸Šä¼ ï¼ˆæ¨èï¼‰

ä¸Šä¼ ç®€å†ç›¸å…³æ–‡ä»¶ï¼Œç›´æ¥å…³è”åˆ°ç®€å†è®°å½•ã€‚

#### ä¸Šä¼ å•ä¸ªæ–‡ä»¶

```http
POST /api/resumes/miniprogram/:id/upload-file
Authorization: Bearer {token}
Content-Type: multipart/form-data

file: [æ–‡ä»¶äºŒè¿›åˆ¶æ•°æ®]
type: "idCardFront" | "idCardBack" | "personalPhoto" | "certificate" | "medicalReport" | "selfIntroductionVideo" | "confinementMealPhoto" | "cookingPhoto" | "complementaryFoodPhoto" | "positiveReviewPhoto"
```

#### æ–‡ä»¶ç±»å‹è¯´æ˜

| typeå€¼ | è¯´æ˜ | å¯¹åº”å­—æ®µ |
|--------|------|---------|
| `idCardFront` | èº«ä»½è¯æ­£é¢ | `idCardFront` |
| `idCardBack` | èº«ä»½è¯èƒŒé¢ | `idCardBack` |
| `personalPhoto` | ä¸ªäººç…§ç‰‡ | `photoUrls` / `personalPhoto` |
| `certificate` | æŠ€èƒ½è¯ä¹¦ | `certificateUrls` / `certificates` |
| `medicalReport` | ä½“æ£€æŠ¥å‘Š | `medicalReportUrls` / `reports` |
| `selfIntroductionVideo` | è‡ªæˆ‘ä»‹ç»è§†é¢‘ | `selfIntroductionVideo` |
| `confinementMealPhoto` | æœˆå­é¤ç…§ç‰‡ | `confinementMealPhotos` |
| `cookingPhoto` | çƒ¹é¥ªç…§ç‰‡ | `cookingPhotos` |
| `complementaryFoodPhoto` | è¾…é£Ÿæ·»åŠ ç…§ç‰‡ | `complementaryFoodPhotos` |
| `positiveReviewPhoto` | å¥½è¯„å±•ç¤ºç…§ç‰‡ | `positiveReviewPhotos` |

#### æˆåŠŸå“åº” (200)

```json
{
  "success": true,
  "data": {
    "fileUrl": "https://housekeeping-1254058915.cos.ap-guangzhou.myqcloud.com/certificate/xxx.jpg",
    "fileType": "certificate",
    "fileName": "photo.jpg",
    "fileSize": 123456,
    "resumeId": "68ea31595750fa9479e15732"
  },
  "message": "æ–‡ä»¶ä¸Šä¼ æˆåŠŸ"
}
```

#### åˆ é™¤ç®€å†æ–‡ä»¶

```http
DELETE /api/resumes/miniprogram/:id/delete-file
Authorization: Bearer {token}
Content-Type: application/json

{
  "fileUrl": "https://housekeeping-1254058915.cos.ap-guangzhou.myqcloud.com/certificate/xxx.jpg",
  "fileType": "certificate"
}
```

#### æˆåŠŸå“åº” (200)

```json
{
  "success": true,
  "data": {
    "resumeId": "68ea31595750fa9479e15732",
    "deletedFileUrl": "https://...",
    "fileType": "certificate"
  },
  "message": "æ–‡ä»¶åˆ é™¤æˆåŠŸ"
}
```

---

## ğŸ“– æ•°æ®å­—å…¸

### å·¥ç§ç±»å‹

| å€¼ | è¯´æ˜ |
|---|---|
| `yuexin` | æœˆå«‚ |
| `zhujia-yuer` | ä½å®¶è‚²å„¿å«‚ |
| `baiban-yuer` | ç™½ç­è‚²å„¿å«‚ |
| `baojie` | ä¿æ´ |
| `baiban-baomu` | ç™½ç­ä¿å§† |
| `zhujia-baomu` | ä½å®¶ä¿å§† |
| `yangchong` | å…»å®  |
| `xiaoshi` | å°æ—¶å·¥ |
| `zhujia-hulao` | ä½å®¶æŠ¤è€ |

### å­¦å†ç±»å‹

| å€¼ | è¯´æ˜ |
|---|---|
| `no` | æ— å­¦å† |
| `primary` | å°å­¦ |
| `middle` | åˆä¸­ |
| `secondary` | ä¸­ä¸“ |
| `vocational` | èŒé«˜ |
| `high` | é«˜ä¸­ |
| `college` | å¤§ä¸“ |
| `bachelor` | æœ¬ç§‘ |
| `graduate` | ç ”ç©¶ç”Ÿ |

### æœˆå«‚æ¡£ä½

**ä»…å½“ jobType ä¸º "yuexin" (æœˆå«‚) æ—¶ä½¿ç”¨**

| å€¼ | è¯´æ˜ |
|---|---|
| `junior` | åˆçº§æœˆå«‚ |
| `silver` | é“¶ç‰Œæœˆå«‚ |
| `gold` | é‡‘ç‰Œæœˆå«‚ |
| `platinum` | é“‚é‡‘æœˆå«‚ |
| `diamond` | é’»çŸ³æœˆå«‚ |
| `crown` | çš‡å† æœˆå«‚ |

### å©šå§»çŠ¶å†µ

| å€¼ | è¯´æ˜ |
|---|---|
| `single` | æœªå©š |
| `married` | å·²å©š |
| `divorced` | ç¦»å¼‚ |
| `widowed` | ä¸§å¶ |

### æ¥å•çŠ¶æ€

| å€¼ | è¯´æ˜ |
|---|---|
| `available` | å¯æ¥å• |
| `busy` | å¿™ç¢Œä¸­ |
| `unavailable` | æš‚ä¸æ¥å• |

### åŸ¹è®­æ„å‘

| å€¼ | è¯´æ˜ |
|---|---|
| `yes` | æœ‰æ„å‘ |
| `no` | æ— æ„å‘ |
| `considering` | è€ƒè™‘ä¸­ |

### å½“å‰é˜¶æ®µ

| å€¼ | è¯´æ˜ |
|---|---|
| `training` | åŸ¹è®­ä¸­ |
| `working` | å·¥ä½œä¸­ |
| `resting` | ä¼‘æ¯ä¸­ |
| `seeking` | æ±‚èŒä¸­ |

### æŠ€èƒ½åˆ—è¡¨

| å€¼ | è¯´æ˜ |
|---|---|
| `chanhou` | äº§åæŠ¤ç† |
| `yuying` | å©´å„¿æŠ¤ç† |
| `cuiru` | å‚¬ä¹³ |
| `zaojiao` | æ—©æ•™ |
| `yingyang` | è¥å…»é…é¤ |
| `jiating` | å®¶åº­ä¿æ´ |
| `laoren` | è€äººæŠ¤ç† |
| `chongwu` | å® ç‰©æŠ¤ç† |

---

## âš ï¸ é”™è¯¯ç è¯´æ˜

### HTTPçŠ¶æ€ç 

| çŠ¶æ€ç  | è¯´æ˜ |
|--------|------|
| 200 | è¯·æ±‚æˆåŠŸ |
| 201 | åˆ›å»ºæˆåŠŸ |
| 400 | è¯·æ±‚å‚æ•°é”™è¯¯ |
| 401 | æœªæˆæƒï¼Œtokenæ— æ•ˆæˆ–è¿‡æœŸ |
| 403 | ç¦æ­¢è®¿é—® |
| 404 | èµ„æºä¸å­˜åœ¨ |
| 409 | èµ„æºå†²çªï¼ˆå¦‚æ‰‹æœºå·é‡å¤ï¼‰ |
| 413 | è¯·æ±‚ä½“è¿‡å¤§ |
| 500 | æœåŠ¡å™¨å†…éƒ¨é”™è¯¯ |

### ä¸šåŠ¡é”™è¯¯ç 

| é”™è¯¯ç  | è¯´æ˜ |
|--------|------|
| `VALIDATION_ERROR` | æ•°æ®éªŒè¯å¤±è´¥ |
| `DUPLICATE` | èµ„æºé‡å¤ï¼ˆå¦‚æ‰‹æœºå·å·²å­˜åœ¨ï¼‰ |
| `NOT_FOUND` | èµ„æºä¸å­˜åœ¨ |
| `UNAUTHORIZED` | æœªæˆæƒ |
| `FORBIDDEN` | ç¦æ­¢è®¿é—® |
| `FILE_TOO_LARGE` | æ–‡ä»¶è¿‡å¤§ |
| `INVALID_FILE_TYPE` | æ–‡ä»¶ç±»å‹ä¸æ”¯æŒ |

---

## ğŸ’» å°ç¨‹åºç«¯é›†æˆç¤ºä¾‹

### å®Œæ•´çš„APIå°è£…

```javascript
// utils/api.js
const BASE_URL = 'https://crm.andejiazheng.com/api';

class API {
  // è·å–token
  getToken() {
    return wx.getStorageSync('token');
  }

  // é€šç”¨è¯·æ±‚æ–¹æ³•
  async request(url, options = {}) {
    const token = this.getToken();
    const header = {
      'Content-Type': 'application/json',
      ...options.header
    };

    if (token) {
      header['Authorization'] = `Bearer ${token}`;
    }

    try {
      const response = await wx.request({
        url: `${BASE_URL}${url}`,
        method: options.method || 'GET',
        header,
        data: options.data
      });

      if (response.statusCode === 401) {
        // tokenè¿‡æœŸï¼Œé‡æ–°ç™»å½•
        await this.login();
        return this.request(url, options);
      }

      return response.data;
    } catch (error) {
      console.error('è¯·æ±‚å¤±è´¥:', error);
      throw error;
    }
  }

  // ç™»å½•
  async login() {
    const { code } = await wx.login();
    const response = await wx.request({
      url: `${BASE_URL}/auth/miniprogram/login`,
      method: 'POST',
      data: { code }
    });

    if (response.data.success) {
      wx.setStorageSync('token', response.data.data.token);
      return response.data.data;
    }
    throw new Error('ç™»å½•å¤±è´¥');
  }

  // åˆ›å»ºç®€å†
  async createResume(data) {
    return this.request('/resumes/miniprogram/create', {
      method: 'POST',
      data
    });
  }

  // è·å–ç®€å†è¯¦æƒ…
  async getResume(id) {
    return this.request(`/resumes/miniprogram/${id}`);
  }

  // æ›´æ–°ç®€å†
  async updateResume(id, data) {
    return this.request(`/resumes/miniprogram/${id}`, {
      method: 'PUT',
      data
    });
  }

  // ä¸Šä¼ æ–‡ä»¶
  async uploadFile(filePath, type) {
    const token = this.getToken();

    return new Promise((resolve, reject) => {
      wx.uploadFile({
        url: `${BASE_URL}/upload/miniprogram`,
        filePath,
        name: 'file',
        formData: { type },
        header: {
          'Authorization': `Bearer ${token}`
        },
        success: (res) => {
          const data = JSON.parse(res.data);
          if (data.success) {
            resolve(data.data);
          } else {
            reject(new Error(data.message));
          }
        },
        fail: reject
      });
    });
  }

  // åˆ é™¤æ–‡ä»¶
  async deleteFile(key) {
    return this.request('/upload/miniprogram', {
      method: 'DELETE',
      data: { key }
    });
  }
}

export default new API();
```

### åˆ›å»ºç®€å†é¡µé¢ç¤ºä¾‹

```javascript
// pages/resume/create.js
import api from '../../utils/api';

Page({
  data: {
    formData: {
      name: '',
      phone: '',
      gender: 'female',
      age: 30,
      jobType: 'yuexin',
      education: 'high',
      maternityNurseLevel: 'gold',
      expectedSalary: 8000,
      nativePlace: '',
      experienceYears: 0,
      skills: [],
      serviceArea: [],
      selfIntroduction: '',
      wechat: '',
      currentAddress: '',
      orderStatus: 'available'
    },

    // é€‰é¡¹åˆ—è¡¨
    jobTypes: [
      { value: 'yuexin', label: 'æœˆå«‚' },
      { value: 'zhujia-yuer', label: 'ä½å®¶è‚²å„¿å«‚' },
      { value: 'baiban-yuer', label: 'ç™½ç­è‚²å„¿å«‚' }
    ],

    maternityNurseLevels: [
      { value: 'junior', label: 'åˆçº§æœˆå«‚' },
      { value: 'silver', label: 'é“¶ç‰Œæœˆå«‚' },
      { value: 'gold', label: 'é‡‘ç‰Œæœˆå«‚' },
      { value: 'platinum', label: 'é“‚é‡‘æœˆå«‚' },
      { value: 'diamond', label: 'é’»çŸ³æœˆå«‚' },
      { value: 'crown', label: 'çš‡å† æœˆå«‚' }
    ],

    showMaternityLevel: true
  },

  onLoad() {
    // é¡µé¢åŠ è½½
  },

  // å·¥ç§å˜åŒ–
  onJobTypeChange(e) {
    const jobType = e.detail.value;
    this.setData({
      'formData.jobType': jobType,
      showMaternityLevel: jobType === 'yuexin'
    });
  },

  // è¡¨å•è¾“å…¥
  onInputChange(e) {
    const { field } = e.currentTarget.dataset;
    this.setData({
      [`formData.${field}`]: e.detail.value
    });
  },

  // æäº¤è¡¨å•
  async onSubmit() {
    const { formData } = this.data;

    // éªŒè¯å¿…å¡«å­—æ®µ
    if (!formData.name || !formData.phone) {
      wx.showToast({
        title: 'è¯·å¡«å†™å¿…å¡«ä¿¡æ¯',
        icon: 'none'
      });
      return;
    }

    // éªŒè¯æ‰‹æœºå·
    if (!/^1[3-9]\d{9}$/.test(formData.phone)) {
      wx.showToast({
        title: 'æ‰‹æœºå·æ ¼å¼ä¸æ­£ç¡®',
        icon: 'none'
      });
      return;
    }

    try {
      wx.showLoading({ title: 'æäº¤ä¸­...' });

      // å¦‚æœä¸æ˜¯æœˆå«‚ï¼Œç§»é™¤æ¡£ä½å­—æ®µ
      const submitData = { ...formData };
      if (submitData.jobType !== 'yuexin') {
        delete submitData.maternityNurseLevel;
      }

      const response = await api.createResume(submitData);

      wx.hideLoading();

      if (response.success) {
        wx.showToast({
          title: 'åˆ›å»ºæˆåŠŸ',
          icon: 'success'
        });

        // è·³è½¬åˆ°è¯¦æƒ…é¡µ
        setTimeout(() => {
          wx.navigateTo({
            url: `/pages/resume/detail?id=${response.data.id}`
          });
        }, 1500);
      } else {
        wx.showToast({
          title: response.message || 'åˆ›å»ºå¤±è´¥',
          icon: 'none'
        });
      }
    } catch (error) {
      wx.hideLoading();
      wx.showToast({
        title: 'ç½‘ç»œé”™è¯¯',
        icon: 'none'
      });
      console.error('åˆ›å»ºç®€å†å¤±è´¥:', error);
    }
  }
});
```

### ç®€å†è¯¦æƒ…é¡µé¢ç¤ºä¾‹

```javascript
// pages/resume/detail.js
import api from '../../utils/api';

Page({
  data: {
    resumeId: '',
    resume: null,
    loading: true
  },

  onLoad(options) {
    if (options.id) {
      this.setData({ resumeId: options.id });
      this.loadResume();
    }
  },

  // åŠ è½½ç®€å†
  async loadResume() {
    try {
      this.setData({ loading: true });

      const response = await api.getResume(this.data.resumeId);

      if (response.success) {
        this.setData({
          resume: response.data,
          loading: false
        });
      } else {
        wx.showToast({
          title: response.message || 'åŠ è½½å¤±è´¥',
          icon: 'none'
        });
      }
    } catch (error) {
      wx.showToast({
        title: 'ç½‘ç»œé”™è¯¯',
        icon: 'none'
      });
      console.error('åŠ è½½ç®€å†å¤±è´¥:', error);
    }
  },

  // ç¼–è¾‘ç®€å†
  onEdit() {
    wx.navigateTo({
      url: `/pages/resume/edit?id=${this.data.resumeId}`
    });
  },

  // æ›´æ–°æ¥å•çŠ¶æ€
  async updateOrderStatus(status) {
    try {
      wx.showLoading({ title: 'æ›´æ–°ä¸­...' });

      const response = await api.updateResume(this.data.resumeId, {
        orderStatus: status
      });

      wx.hideLoading();

      if (response.success) {
        wx.showToast({
          title: 'æ›´æ–°æˆåŠŸ',
          icon: 'success'
        });
        this.loadResume();
      }
    } catch (error) {
      wx.hideLoading();
      wx.showToast({
        title: 'æ›´æ–°å¤±è´¥',
        icon: 'none'
      });
    }
  }
});
```

### æ–‡ä»¶ä¸Šä¼ ç¤ºä¾‹

```javascript
// pages/resume/upload.js
import api from '../../utils/api';

Page({
  data: {
    resumeId: '',
    photos: []
  },

  // é€‰æ‹©ç…§ç‰‡
  async choosePhoto() {
    try {
      const { tempFilePaths } = await wx.chooseImage({
        count: 9,
        sizeType: ['compressed'],
        sourceType: ['album', 'camera']
      });

      // ä¸Šä¼ æ‰€æœ‰ç…§ç‰‡
      for (const filePath of tempFilePaths) {
        await this.uploadPhoto(filePath);
      }
    } catch (error) {
      console.error('é€‰æ‹©ç…§ç‰‡å¤±è´¥:', error);
    }
  },

  // ä¸Šä¼ ç…§ç‰‡
  async uploadPhoto(filePath) {
    try {
      wx.showLoading({ title: 'ä¸Šä¼ ä¸­...' });

      const result = await api.uploadFile(filePath, 'photo');

      wx.hideLoading();

      // æ·»åŠ åˆ°ç…§ç‰‡åˆ—è¡¨
      this.setData({
        photos: [...this.data.photos, result]
      });

      wx.showToast({
        title: 'ä¸Šä¼ æˆåŠŸ',
        icon: 'success'
      });
    } catch (error) {
      wx.hideLoading();
      wx.showToast({
        title: 'ä¸Šä¼ å¤±è´¥',
        icon: 'none'
      });
      console.error('ä¸Šä¼ ç…§ç‰‡å¤±è´¥:', error);
    }
  },

  // åˆ é™¤ç…§ç‰‡
  async deletePhoto(index) {
    const photo = this.data.photos[index];

    try {
      const result = await wx.showModal({
        title: 'ç¡®è®¤åˆ é™¤',
        content: 'ç¡®å®šè¦åˆ é™¤è¿™å¼ ç…§ç‰‡å—ï¼Ÿ'
      });

      if (result.confirm) {
        wx.showLoading({ title: 'åˆ é™¤ä¸­...' });

        await api.deleteFile(photo.key);

        wx.hideLoading();

        // ä»åˆ—è¡¨ä¸­ç§»é™¤
        const photos = [...this.data.photos];
        photos.splice(index, 1);
        this.setData({ photos });

        wx.showToast({
          title: 'åˆ é™¤æˆåŠŸ',
          icon: 'success'
        });
      }
    } catch (error) {
      wx.hideLoading();
      wx.showToast({
        title: 'åˆ é™¤å¤±è´¥',
        icon: 'none'
      });
      console.error('åˆ é™¤ç…§ç‰‡å¤±è´¥:', error);
    }
  }
});
```

---

## ğŸ“‹ æœ€ä½³å®è·µ

### 1. é”™è¯¯å¤„ç†

```javascript
async function handleRequest() {
  try {
    const response = await api.createResume(data);

    if (response.success) {
      // å¤„ç†æˆåŠŸ
    } else {
      // å¤„ç†ä¸šåŠ¡é”™è¯¯
      if (response.code === 'DUPLICATE') {
        wx.showModal({
          title: 'æç¤º',
          content: 'è¯¥æ‰‹æœºå·å·²è¢«ä½¿ç”¨ï¼Œæ˜¯å¦æŸ¥çœ‹å·²æœ‰ç®€å†ï¼Ÿ',
          success: (res) => {
            if (res.confirm) {
              wx.navigateTo({
                url: `/pages/resume/detail?id=${response.data.existingId}`
              });
            }
          }
        });
      } else {
        wx.showToast({
          title: response.message,
          icon: 'none'
        });
      }
    }
  } catch (error) {
    // å¤„ç†ç½‘ç»œé”™è¯¯
    wx.showToast({
      title: 'ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•',
      icon: 'none'
    });
  }
}
```

### 2. å¹‚ç­‰æ€§å¤„ç†

```javascript
// ä½¿ç”¨å¹‚ç­‰æ€§é”®é˜²æ­¢é‡å¤æäº¤
async function createResumeWithIdempotency(data) {
  const idempotencyKey = `resume_${Date.now()}_${Math.random()}`;

  const response = await wx.request({
    url: `${BASE_URL}/resumes/miniprogram/create`,
    method: 'POST',
    header: {
      'Authorization': `Bearer ${token}`,
      'Idempotency-Key': idempotencyKey
    },
    data
  });

  return response.data;
}
```

### 3. æ•°æ®éªŒè¯

```javascript
// å‰ç«¯éªŒè¯
function validateResumeData(data) {
  const errors = [];

  if (!data.name || data.name.length < 2 || data.name.length > 20) {
    errors.push('å§“åé•¿åº¦åº”åœ¨2-20ä¸ªå­—ç¬¦ä¹‹é—´');
  }

  if (!/^1[3-9]\d{9}$/.test(data.phone)) {
    errors.push('æ‰‹æœºå·æ ¼å¼ä¸æ­£ç¡®');
  }

  if (data.age < 18 || data.age > 65) {
    errors.push('å¹´é¾„åº”åœ¨18-65å²ä¹‹é—´');
  }

  if (data.jobType === 'yuexin' && !data.maternityNurseLevel) {
    errors.push('æœˆå«‚å·¥ç§éœ€è¦é€‰æ‹©æ¡£ä½');
  }

  return errors;
}
```

### 4. ç¼“å­˜ç­–ç•¥

```javascript
// ç¼“å­˜ç®€å†æ•°æ®
class ResumeCache {
  static KEY = 'resume_cache';
  static EXPIRE_TIME = 5 * 60 * 1000; // 5åˆ†é’Ÿ

  static set(id, data) {
    const cache = {
      data,
      timestamp: Date.now()
    };
    wx.setStorageSync(`${this.KEY}_${id}`, cache);
  }

  static get(id) {
    const cache = wx.getStorageSync(`${this.KEY}_${id}`);
    if (!cache) return null;

    // æ£€æŸ¥æ˜¯å¦è¿‡æœŸ
    if (Date.now() - cache.timestamp > this.EXPIRE_TIME) {
      this.remove(id);
      return null;
    }

    return cache.data;
  }

  static remove(id) {
    wx.removeStorageSync(`${this.KEY}_${id}`);
  }
}

// ä½¿ç”¨ç¼“å­˜
async function getResumeWithCache(id) {
  // å…ˆä»ç¼“å­˜è·å–
  const cached = ResumeCache.get(id);
  if (cached) {
    return cached;
  }

  // ç¼“å­˜ä¸å­˜åœ¨ï¼Œä»APIè·å–
  const response = await api.getResume(id);
  if (response.success) {
    ResumeCache.set(id, response.data);
    return response.data;
  }

  return null;
}
```

### 5. æ–‡ä»¶ä¸Šä¼ ä¼˜åŒ–

```javascript
// æ‰¹é‡ä¸Šä¼ æ–‡ä»¶
async function uploadMultipleFiles(filePaths, type) {
  const results = [];
  const errors = [];

  // é™åˆ¶å¹¶å‘æ•°
  const concurrency = 3;

  for (let i = 0; i < filePaths.length; i += concurrency) {
    const batch = filePaths.slice(i, i + concurrency);
    const promises = batch.map(async (filePath) => {
      try {
        const result = await api.uploadFile(filePath, type);
        results.push(result);
      } catch (error) {
        errors.push({ filePath, error });
      }
    });

    await Promise.all(promises);
  }

  return { results, errors };
}
```

---

## ğŸ” å¸¸è§é—®é¢˜

### Q1: Tokenè¿‡æœŸæ€ä¹ˆåŠï¼Ÿ

A: APIä¼šè‡ªåŠ¨å¤„ç†tokenè¿‡æœŸçš„æƒ…å†µã€‚å½“æ”¶åˆ°401å“åº”æ—¶ï¼Œä¼šè‡ªåŠ¨é‡æ–°ç™»å½•å¹¶é‡è¯•è¯·æ±‚ã€‚

### Q2: å¦‚ä½•é˜²æ­¢é‡å¤æäº¤ï¼Ÿ

A: ä½¿ç”¨`Idempotency-Key`è¯·æ±‚å¤´ï¼Œä¼ å…¥å”¯ä¸€çš„é”®å€¼ã€‚ç›¸åŒçš„é”®å€¼åœ¨ä¸€å®šæ—¶é—´å†…åªä¼šå¤„ç†ä¸€æ¬¡ã€‚

### Q3: æœˆå«‚æ¡£ä½ä»€ä¹ˆæ—¶å€™å¿…å¡«ï¼Ÿ

A: åªæœ‰å½“`jobType`ä¸º`yuexin`ï¼ˆæœˆå«‚ï¼‰æ—¶ï¼Œæ‰éœ€è¦å¡«å†™`maternityNurseLevel`å­—æ®µã€‚

### Q4: å¦‚ä½•æ›´æ–°éƒ¨åˆ†å­—æ®µï¼Ÿ

A: ä½¿ç”¨PUTè¯·æ±‚ï¼Œåªä¼ é€’éœ€è¦æ›´æ–°çš„å­—æ®µå³å¯ï¼Œå…¶ä»–å­—æ®µä¿æŒä¸å˜ã€‚

### Q5: æ–‡ä»¶ä¸Šä¼ å¤±è´¥æ€ä¹ˆåŠï¼Ÿ

A: æ£€æŸ¥æ–‡ä»¶å¤§å°å’Œæ ¼å¼æ˜¯å¦ç¬¦åˆè¦æ±‚ï¼Œç¡®ä¿ç½‘ç»œè¿æ¥æ­£å¸¸ï¼Œå¯ä»¥å®ç°é‡è¯•æœºåˆ¶ã€‚

### Q6: å¦‚ä½•å¤„ç†æ‰‹æœºå·é‡å¤ï¼Ÿ

A: åˆ›å»ºæ—¶å¦‚æœæ‰‹æœºå·é‡å¤ï¼Œä¼šè¿”å›409çŠ¶æ€ç å’Œå·²å­˜åœ¨çš„ç®€å†IDï¼Œå¯ä»¥å¼•å¯¼ç”¨æˆ·æŸ¥çœ‹æˆ–æ›´æ–°å·²æœ‰ç®€å†ã€‚

---

## ğŸ’¡ æœ€ä½³å®è·µ

### 1. æ–‡ä»¶ä¸Šä¼ æœ€ä½³å®è·µ

#### å›¾ç‰‡é¢„å‹ç¼©
```javascript
// åœ¨ä¸Šä¼ å‰å‹ç¼©å›¾ç‰‡
async function compressAndUpload(filePath, type) {
  try {
    // å‹ç¼©å›¾ç‰‡
    const compressRes = await wx.compressImage({
      src: filePath,
      quality: 80
    });

    // ä¸Šä¼ å‹ç¼©åçš„å›¾ç‰‡
    const uploadRes = await wx.uploadFile({
      url: `${API_BASE_URL}/api/resumes/miniprogram/${resumeId}/upload-file`,
      filePath: compressRes.tempFilePath,
      name: 'file',
      formData: { type: type },
      header: {
        'Authorization': `Bearer ${wx.getStorageSync('token')}`
      }
    });

    return JSON.parse(uploadRes.data);
  } catch (error) {
    console.error('ä¸Šä¼ å¤±è´¥:', error);
    throw error;
  }
}
```

#### æ‰¹é‡ä¸Šä¼ ä¼˜åŒ–
```javascript
// é™åˆ¶å¹¶å‘æ•°çš„æ‰¹é‡ä¸Šä¼ 
async function uploadBatch(files, concurrency = 3) {
  const results = [];
  const errors = [];

  for (let i = 0; i < files.length; i += concurrency) {
    const batch = files.slice(i, i + concurrency);

    const batchPromises = batch.map(async (file) => {
      try {
        const result = await uploadFile(file.path, file.type);
        return { success: true, data: result };
      } catch (error) {
        return { success: false, error: error.message };
      }
    });

    const batchResults = await Promise.all(batchPromises);

    batchResults.forEach((result, index) => {
      if (result.success) {
        results.push(result.data);
      } else {
        errors.push({
          file: batch[index],
          error: result.error
        });
      }
    });
  }

  return { results, errors };
}
```

#### ä¸Šä¼ è¿›åº¦æ˜¾ç¤º
```javascript
// æ˜¾ç¤ºä¸Šä¼ è¿›åº¦
function uploadWithProgress(filePath, type) {
  return new Promise((resolve, reject) => {
    const uploadTask = wx.uploadFile({
      url: `${API_BASE_URL}/api/resumes/miniprogram/${resumeId}/upload-file`,
      filePath: filePath,
      name: 'file',
      formData: { type: type },
      header: {
        'Authorization': `Bearer ${wx.getStorageSync('token')}`
      },
      success: (res) => {
        const data = JSON.parse(res.data);
        if (data.success) {
          resolve(data);
        } else {
          reject(new Error(data.message));
        }
      },
      fail: reject
    });

    // ç›‘å¬ä¸Šä¼ è¿›åº¦
    uploadTask.onProgressUpdate((res) => {
      console.log('ä¸Šä¼ è¿›åº¦', res.progress);
      console.log('å·²ä¸Šä¼ æ•°æ®é•¿åº¦', res.totalBytesSent);
      console.log('é¢„æœŸéœ€è¦ä¸Šä¼ çš„æ•°æ®æ€»é•¿åº¦', res.totalBytesExpectedToSend);

      // æ›´æ–°UIæ˜¾ç¤ºè¿›åº¦
      this.setData({
        uploadProgress: res.progress
      });
    });
  });
}
```

### 2. é”™è¯¯å¤„ç†æœ€ä½³å®è·µ

#### ç»Ÿä¸€é”™è¯¯å¤„ç†
```javascript
// å°è£…ç»Ÿä¸€çš„é”™è¯¯å¤„ç†
class APIError extends Error {
  constructor(code, message, data) {
    super(message);
    this.code = code;
    this.data = data;
  }
}

async function handleAPICall(apiFunction) {
  try {
    const result = await apiFunction();

    if (!result.success) {
      throw new APIError(
        result.code || 'UNKNOWN_ERROR',
        result.message || 'æ“ä½œå¤±è´¥',
        result.data
      );
    }

    return result.data;
  } catch (error) {
    if (error instanceof APIError) {
      // æ ¹æ®é”™è¯¯ç æ˜¾ç¤ºä¸åŒçš„æç¤º
      switch (error.code) {
        case 'DUPLICATE':
          wx.showModal({
            title: 'æç¤º',
            content: 'è¯¥æ‰‹æœºå·å·²è¢«ä½¿ç”¨ï¼Œæ˜¯å¦æŸ¥çœ‹å·²æœ‰ç®€å†ï¼Ÿ',
            success: (res) => {
              if (res.confirm) {
                // è·³è½¬åˆ°å·²æœ‰ç®€å†
                wx.navigateTo({
                  url: `/pages/resume/detail?id=${error.data.existingId}`
                });
              }
            }
          });
          break;

        case 'VALIDATION_ERROR':
          wx.showToast({
            title: error.message,
            icon: 'none',
            duration: 2000
          });
          break;

        case 'FILE_TOO_LARGE':
          wx.showModal({
            title: 'æ–‡ä»¶è¿‡å¤§',
            content: 'è¯·é€‰æ‹©å°äº10MBçš„æ–‡ä»¶',
            showCancel: false
          });
          break;

        default:
          wx.showToast({
            title: error.message || 'æ“ä½œå¤±è´¥',
            icon: 'none'
          });
      }
    } else {
      // ç½‘ç»œé”™è¯¯ç­‰
      wx.showToast({
        title: 'ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•',
        icon: 'none'
      });
    }

    throw error;
  }
}
```

#### é‡è¯•æœºåˆ¶
```javascript
// å¸¦æŒ‡æ•°é€€é¿çš„é‡è¯•æœºåˆ¶
async function retryWithBackoff(fn, maxRetries = 3, baseDelay = 1000) {
  for (let i = 0; i < maxRetries; i++) {
    try {
      return await fn();
    } catch (error) {
      if (i === maxRetries - 1) {
        throw error;
      }

      // æŒ‡æ•°é€€é¿
      const delay = baseDelay * Math.pow(2, i);
      console.log(`é‡è¯• ${i + 1}/${maxRetries}ï¼Œç­‰å¾… ${delay}ms`);

      await new Promise(resolve => setTimeout(resolve, delay));
    }
  }
}

// ä½¿ç”¨ç¤ºä¾‹
try {
  const result = await retryWithBackoff(async () => {
    return await uploadFile(filePath, 'cookingPhoto');
  });
  console.log('ä¸Šä¼ æˆåŠŸ', result);
} catch (error) {
  console.error('ä¸Šä¼ å¤±è´¥ï¼Œå·²é‡è¯•3æ¬¡', error);
}
```

### 3. æ•°æ®éªŒè¯æœ€ä½³å®è·µ

#### å‰ç«¯éªŒè¯
```javascript
// è¡¨å•éªŒè¯å·¥å…·
const validators = {
  // æ‰‹æœºå·éªŒè¯
  phone: (value) => {
    const pattern = /^1[3-9]\d{9}$/;
    if (!pattern.test(value)) {
      return 'è¯·è¾“å…¥æ­£ç¡®çš„æ‰‹æœºå·ç ';
    }
    return null;
  },

  // èº«ä»½è¯å·éªŒè¯
  idNumber: (value) => {
    const pattern = /(^\d{15}$)|(^\d{18}$)|(^\d{17}(\d|X|x)$)/;
    if (!pattern.test(value)) {
      return 'è¯·è¾“å…¥æ­£ç¡®çš„èº«ä»½è¯å·ç ';
    }
    return null;
  },

  // å¹´é¾„éªŒè¯
  age: (value) => {
    const age = parseInt(value);
    if (isNaN(age) || age < 18 || age > 65) {
      return 'å¹´é¾„å¿…é¡»åœ¨18-65å²ä¹‹é—´';
    }
    return null;
  },

  // å¿…å¡«éªŒè¯
  required: (value, fieldName) => {
    if (!value || value.trim() === '') {
      return `${fieldName}ä¸èƒ½ä¸ºç©º`;
    }
    return null;
  }
};

// éªŒè¯è¡¨å•
function validateForm(formData) {
  const errors = [];

  // éªŒè¯å¿…å¡«å­—æ®µ
  const requiredFields = [
    { key: 'name', label: 'å§“å' },
    { key: 'phone', label: 'æ‰‹æœºå·' },
    { key: 'age', label: 'å¹´é¾„' },
    { key: 'gender', label: 'æ€§åˆ«' },
    { key: 'jobType', label: 'å·¥ç§' },
    { key: 'education', label: 'å­¦å†' }
  ];

  requiredFields.forEach(field => {
    const error = validators.required(formData[field.key], field.label);
    if (error) errors.push(error);
  });

  // éªŒè¯æ‰‹æœºå·
  if (formData.phone) {
    const error = validators.phone(formData.phone);
    if (error) errors.push(error);
  }

  // éªŒè¯èº«ä»½è¯å·
  if (formData.idNumber) {
    const error = validators.idNumber(formData.idNumber);
    if (error) errors.push(error);
  }

  // éªŒè¯å¹´é¾„
  if (formData.age) {
    const error = validators.age(formData.age);
    if (error) errors.push(error);
  }

  return errors;
}

// ä½¿ç”¨ç¤ºä¾‹
const errors = validateForm(formData);
if (errors.length > 0) {
  wx.showModal({
    title: 'éªŒè¯å¤±è´¥',
    content: errors.join('\n'),
    showCancel: false
  });
  return;
}
```

### 4. æ€§èƒ½ä¼˜åŒ–å»ºè®®

#### æ•°æ®ç¼“å­˜
```javascript
// ç¼“å­˜ç®€å†æ•°æ®
const ResumeCache = {
  cache: {},

  set(id, data, ttl = 5 * 60 * 1000) { // é»˜è®¤5åˆ†é’Ÿè¿‡æœŸ
    this.cache[id] = {
      data: data,
      expireAt: Date.now() + ttl
    };
  },

  get(id) {
    const item = this.cache[id];
    if (!item) return null;

    if (Date.now() > item.expireAt) {
      delete this.cache[id];
      return null;
    }

    return item.data;
  },

  clear(id) {
    if (id) {
      delete this.cache[id];
    } else {
      this.cache = {};
    }
  }
};

// ä½¿ç”¨ç¼“å­˜
async function getResume(id, forceRefresh = false) {
  // å¦‚æœä¸å¼ºåˆ¶åˆ·æ–°ï¼Œå…ˆå°è¯•ä»ç¼“å­˜è·å–
  if (!forceRefresh) {
    const cached = ResumeCache.get(id);
    if (cached) {
      console.log('ä»ç¼“å­˜è·å–ç®€å†');
      return cached;
    }
  }

  // ä»æœåŠ¡å™¨è·å–
  const res = await wx.request({
    url: `${API_BASE_URL}/api/resumes/miniprogram/${id}`,
    method: 'GET',
    header: {
      'Authorization': `Bearer ${wx.getStorageSync('token')}`
    }
  });

  if (res.data.success) {
    // å­˜å…¥ç¼“å­˜
    ResumeCache.set(id, res.data.data);
    return res.data.data;
  }

  throw new Error(res.data.message);
}
```

#### å›¾ç‰‡æ‡’åŠ è½½
```javascript
// å›¾ç‰‡æ‡’åŠ è½½ç»„ä»¶
Component({
  properties: {
    src: String,
    mode: {
      type: String,
      value: 'aspectFill'
    }
  },

  data: {
    loaded: false,
    showImage: false
  },

  lifetimes: {
    attached() {
      this.observer = wx.createIntersectionObserver(this);

      this.observer
        .relativeToViewport({ bottom: 100 })
        .observe('.lazy-image', (res) => {
          if (res.intersectionRatio > 0 && !this.data.loaded) {
            this.setData({
              showImage: true,
              loaded: true
            });
            this.observer.disconnect();
          }
        });
    },

    detached() {
      if (this.observer) {
        this.observer.disconnect();
      }
    }
  }
});
```

### 5. å®‰å…¨å»ºè®®

#### Tokenç®¡ç†
```javascript
// Tokenç®¡ç†å·¥å…·
const TokenManager = {
  // ä¿å­˜Token
  saveToken(token) {
    wx.setStorageSync('token', token);
    wx.setStorageSync('tokenTime', Date.now());
  },

  // è·å–Token
  getToken() {
    return wx.getStorageSync('token');
  },

  // æ£€æŸ¥Tokenæ˜¯å¦è¿‡æœŸï¼ˆå‡è®¾Tokenæœ‰æ•ˆæœŸä¸º7å¤©ï¼‰
  isTokenExpired() {
    const tokenTime = wx.getStorageSync('tokenTime');
    if (!tokenTime) return true;

    const expireTime = 7 * 24 * 60 * 60 * 1000; // 7å¤©
    return Date.now() - tokenTime > expireTime;
  },

  // æ¸…é™¤Token
  clearToken() {
    wx.removeStorageSync('token');
    wx.removeStorageSync('tokenTime');
  },

  // åˆ·æ–°Token
  async refreshToken() {
    try {
      const res = await wx.request({
        url: `${API_BASE_URL}/api/auth/refresh`,
        method: 'POST',
        header: {
          'Authorization': `Bearer ${this.getToken()}`
        }
      });

      if (res.data.success) {
        this.saveToken(res.data.data.token);
        return res.data.data.token;
      }

      throw new Error('åˆ·æ–°Tokenå¤±è´¥');
    } catch (error) {
      this.clearToken();
      throw error;
    }
  }
};
```

#### è¯·æ±‚æ‹¦æˆªå™¨
```javascript
// å°è£…è¯·æ±‚ï¼Œè‡ªåŠ¨å¤„ç†Token
async function request(options) {
  // æ£€æŸ¥Tokenæ˜¯å¦è¿‡æœŸ
  if (TokenManager.isTokenExpired()) {
    try {
      await TokenManager.refreshToken();
    } catch (error) {
      // Tokenåˆ·æ–°å¤±è´¥ï¼Œè·³è½¬åˆ°ç™»å½•é¡µ
      wx.redirectTo({
        url: '/pages/login/login'
      });
      throw new Error('ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•');
    }
  }

  // æ·»åŠ Tokenåˆ°è¯·æ±‚å¤´
  const token = TokenManager.getToken();
  if (token) {
    options.header = options.header || {};
    options.header['Authorization'] = `Bearer ${token}`;
  }

  // å‘é€è¯·æ±‚
  return new Promise((resolve, reject) => {
    wx.request({
      ...options,
      success: (res) => {
        // å¤„ç†401æœªæˆæƒ
        if (res.statusCode === 401) {
          TokenManager.clearToken();
          wx.redirectTo({
            url: '/pages/login/login'
          });
          reject(new Error('æœªæˆæƒï¼Œè¯·é‡æ–°ç™»å½•'));
          return;
        }

        resolve(res);
      },
      fail: reject
    });
  });
}
```

---

## ğŸ“ å·¥ä½œç»å†å­—æ®µè¯¦ç»†è¯´æ˜

### å·¥ä½œç»å†å¯¹è±¡å®Œæ•´ç»“æ„

æ¯ä¸ªå·¥ä½œç»å†å¯¹è±¡åŒ…å«ä»¥ä¸‹å­—æ®µï¼š

#### å¿…å¡«å­—æ®µ

| å­—æ®µ | ç±»å‹ | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|------|
| `startDate` | string | å¼€å§‹æ—¥æœŸï¼ˆYYYY-MM-DDï¼‰ | "2020-01-01" |
| `endDate` | string | ç»“æŸæ—¥æœŸï¼ˆYYYY-MM-DDï¼‰ | "2023-12-31" |
| `description` | string | å·¥ä½œæè¿° | "åœ¨åŒ—äº¬æœé˜³åŒºæŸå®¶åº­æ‹…ä»»æœˆå«‚" |

#### å¯é€‰å­—æ®µï¼ˆæ–°å¢ï¼‰

| å­—æ®µ | ç±»å‹ | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|------|
| `orderNumber` | string | è®¢å•ç¼–å·ï¼ˆæ ¼å¼ï¼šCON{11ä½æ•°å­—}ï¼‰ | "CON12345678901" |
| `district` | string | æœåŠ¡åŒºåŸŸï¼ˆåŒ—äº¬å¸‚åŒºå¿ä»£ç ï¼‰ | "chaoyang" |
| `customerName` | string | å®¢æˆ·å§“å | "å¼ å¥³å£«" |
| `customerReview` | string | å®¢æˆ·è¯„ä»· | "æœåŠ¡æ€åº¦å¥½ï¼Œä¸“ä¸šæŠ€èƒ½å¼º" |
| `photos` | array | å·¥ä½œç…§ç‰‡æ•°ç»„ | è§ä¸‹æ–¹ç…§ç‰‡å¯¹è±¡è¯´æ˜ |

### å·¥ä½œç…§ç‰‡å¯¹è±¡ç»“æ„

æ¯ä¸ªç…§ç‰‡å¯¹è±¡åŒ…å«ä»¥ä¸‹å­—æ®µï¼š

| å­—æ®µ | ç±»å‹ | å¿…å¡« | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|------|------|
| `url` | string | æ˜¯ | å›¾ç‰‡URL | "https://cos.example.com/photo.jpg" |
| `name` | string | å¦ | æ–‡ä»¶å | "å·¥ä½œç…§ç‰‡1.jpg" |
| `size` | number | å¦ | æ–‡ä»¶å¤§å°ï¼ˆå­—èŠ‚ï¼‰ | 102400 |
| `mimeType` | string | å¦ | MIMEç±»å‹ | "image/jpeg" |

### åŒ—äº¬å¸‚åŒºå¿ä»£ç å¯¹ç…§è¡¨

| ä»£ç  | åŒºå¿åç§° | ä»£ç  | åŒºå¿åç§° |
|------|----------|------|----------|
| `dongcheng` | ä¸œåŸåŒº | `xicheng` | è¥¿åŸåŒº |
| `chaoyang` | æœé˜³åŒº | `fengtai` | ä¸°å°åŒº |
| `shijingshan` | çŸ³æ™¯å±±åŒº | `haidian` | æµ·æ·€åŒº |
| `mentougou` | é—¨å¤´æ²ŸåŒº | `fangshan` | æˆ¿å±±åŒº |
| `tongzhou` | é€šå·åŒº | `shunyi` | é¡ºä¹‰åŒº |
| `changping` | æ˜Œå¹³åŒº | `daxing` | å¤§å…´åŒº |
| `huairou` | æ€€æŸ”åŒº | `pinggu` | å¹³è°·åŒº |
| `miyun` | å¯†äº‘åŒº | `yanqing` | å»¶åº†åŒº |

### ä½¿ç”¨ç¤ºä¾‹

#### åˆ›å»ºåŒ…å«å®Œæ•´å·¥ä½œç»å†çš„ç®€å†

```javascript
// å°ç¨‹åºç«¯ç¤ºä¾‹
const createResumeWithWorkExperience = async () => {
  const resumeData = {
    // å¿…å¡«å­—æ®µ
    name: "å¼ ä¸‰",
    phone: "13800138000",
    gender: "female",
    age: 35,
    jobType: "yuexin",
    education: "high",

    // å·¥ä½œç»å†ï¼ˆåŒ…å«æ–°å­—æ®µï¼‰
    workExperiences: [
      {
        startDate: "2020-01-01",
        endDate: "2020-03-31",
        description: "åœ¨åŒ—äº¬æœé˜³åŒºæŸå®¶åº­æ‹…ä»»æœˆå«‚ï¼Œè´Ÿè´£æ–°ç”Ÿå„¿æŠ¤ç†å’Œäº§å¦‡æœˆå­é¤",
        orderNumber: "CON12345678901",
        district: "chaoyang",
        customerName: "å¼ å¥³å£«",
        customerReview: "æœåŠ¡æ€åº¦å¥½ï¼Œä¸“ä¸šæŠ€èƒ½å¼ºï¼Œå®å®æŠ¤ç†å¾—å¾ˆå¥½",
        photos: [
          {
            url: "https://cos.example.com/work-photo-1.jpg",
            name: "å·¥ä½œç…§ç‰‡1.jpg",
            size: 102400,
            mimeType: "image/jpeg"
          }
        ]
      },
      {
        startDate: "2020-05-01",
        endDate: "2020-07-31",
        description: "åœ¨åŒ—äº¬æµ·æ·€åŒºæŸå®¶åº­æ‹…ä»»æœˆå«‚",
        orderNumber: "CON12345678902",
        district: "haidian",
        customerName: "æå¥³å£«"
        // å…¶ä»–å­—æ®µå¯é€‰ï¼Œä¸å¡«å†™ä¹Ÿå¯ä»¥
      }
    ]
  };

  try {
    const response = await wx.request({
      url: 'https://crm.andejiazheng.com/api/resumes/miniprogram/create',
      method: 'POST',
      header: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      },
      data: resumeData
    });

    if (response.data.success) {
      console.log('ç®€å†åˆ›å»ºæˆåŠŸ:', response.data);
      return response.data.data;
    }
  } catch (error) {
    console.error('åˆ›å»ºå¤±è´¥:', error);
  }
};
```

#### æ›´æ–°å·¥ä½œç»å†

```javascript
// æ›´æ–°ç°æœ‰ç®€å†çš„å·¥ä½œç»å†
const updateWorkExperience = async (resumeId) => {
  const updateData = {
    workExperiences: [
      {
        startDate: "2020-01-01",
        endDate: "2020-03-31",
        description: "å·¥ä½œæè¿°",
        orderNumber: "CON12345678901",
        district: "chaoyang",
        customerName: "å¼ å¥³å£«",
        customerReview: "æœåŠ¡å¾ˆå¥½",
        photos: [
          {
            url: "https://cos.example.com/photo.jpg",
            name: "ç…§ç‰‡.jpg"
          }
        ]
      }
    ]
  };

  try {
    const response = await wx.request({
      url: `https://crm.andejiazheng.com/api/resumes/miniprogram/${resumeId}`,
      method: 'PUT',
      header: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      },
      data: updateData
    });

    if (response.data.success) {
      console.log('æ›´æ–°æˆåŠŸ');
    }
  } catch (error) {
    console.error('æ›´æ–°å¤±è´¥:', error);
  }
};
```

### æ³¨æ„äº‹é¡¹

1. **è®¢å•ç¼–å·æ ¼å¼**ï¼šå¿…é¡»æ˜¯ `CON` å¼€å¤´ + 11ä½æ•°å­—ï¼Œä¾‹å¦‚ï¼š`CON12345678901`
2. **æœåŠ¡åŒºåŸŸä»£ç **ï¼šå¿…é¡»ä½¿ç”¨åŒ—äº¬å¸‚åŒºå¿ä»£ç ï¼Œä¸èƒ½ä½¿ç”¨ä¸­æ–‡åç§°
3. **æ—¥æœŸæ ¼å¼**ï¼šå¿…é¡»ä½¿ç”¨ `YYYY-MM-DD` æ ¼å¼ï¼Œä¾‹å¦‚ï¼š`2020-01-01`
4. **ç…§ç‰‡URL**ï¼šå¿…é¡»æ˜¯æœ‰æ•ˆçš„HTTPS URL
5. **å‘åå…¼å®¹**ï¼šæ‰€æœ‰æ–°å¢å­—æ®µéƒ½æ˜¯å¯é€‰çš„ï¼Œä¸å½±å“ç°æœ‰åŠŸèƒ½

---

---

## ğŸ“Š å‘˜å·¥è¯„ä»·

å†…éƒ¨å‘˜å·¥è¯„ä»·ç®¡ç†ï¼Œæ”¯æŒåˆ›å»ºè¯„ä»·ã€æŸ¥è¯¢è¯„ä»·åˆ—è¡¨å’Œç»Ÿè®¡åˆ†æã€‚

**è·¯ç”±å‰ç¼€**: `/api/employee-evaluations/`
**è®¤è¯è¦æ±‚**: âœ… æ‰€æœ‰æ¥å£å‡éœ€JWTè®¤è¯ + è§’è‰²æƒé™éªŒè¯

### åˆ›å»ºå‘˜å·¥è¯„ä»·

åˆ›å»ºå¯¹å‘˜å·¥çš„å†…éƒ¨è¯„ä»·è®°å½•ã€‚

#### è¯·æ±‚

```http
POST /api/employee-evaluations/miniprogram/create
Authorization: Bearer {token}
Content-Type: application/json
```

**è®¤è¯**: âœ… éœ€è¦ç™»å½•

#### è¯·æ±‚ä½“

```json
{
  "employeeId": "507f1f77bcf86cd799439011",
  "employeeName": "å¼ ä¸‰",
  "contractId": "507f1f77bcf86cd799439012",
  "contractNo": "CON20240101001",
  "evaluationType": "daily",
  "overallRating": 4.5,
  "serviceAttitudeRating": 5,
  "professionalSkillRating": 4,
  "workEfficiencyRating": 4.5,
  "communicationRating": 5,
  "comment": "å·¥ä½œè®¤çœŸè´Ÿè´£ï¼Œä¸“ä¸šæŠ€èƒ½å¼ºï¼ŒæœåŠ¡æ€åº¦å¥½",
  "strengths": "æœåŠ¡æ€åº¦å¥½ï¼ŒæŠ€èƒ½ç†Ÿç»ƒï¼Œæ²Ÿé€šèƒ½åŠ›å¼º",
  "improvements": "å·¥ä½œæ•ˆç‡å¯ä»¥è¿›ä¸€æ­¥æå‡",
  "tags": ["è®¤çœŸè´Ÿè´£", "æŠ€èƒ½ç†Ÿç»ƒ", "æ²Ÿé€šè‰¯å¥½"],
  "isPublic": false,
  "status": "published"
}
```

#### è¯·æ±‚å­—æ®µè¯´æ˜

| å­—æ®µ | ç±»å‹ | å¿…å¡« | è¯´æ˜ |
|------|------|------|------|
| `employeeId` | string | âœ… | è¢«è¯„ä»·å‘˜å·¥IDï¼ˆç®€å†IDï¼‰ |
| `employeeName` | string | âœ… | è¢«è¯„ä»·å‘˜å·¥å§“å |
| `contractId` | string | âŒ | å…³è”åˆåŒID |
| `contractNo` | string | âŒ | è®¢å•ç¼–å· |
| `evaluationType` | string | âœ… | è¯„ä»·ç±»å‹ï¼šdaily/monthly/contract_end/special |
| `overallRating` | number | âœ… | ç»¼åˆè¯„åˆ†ï¼ˆ1-5åˆ†ï¼‰ |
| `serviceAttitudeRating` | number | âŒ | æœåŠ¡æ€åº¦è¯„åˆ†ï¼ˆ1-5åˆ†ï¼‰ |
| `professionalSkillRating` | number | âŒ | ä¸“ä¸šæŠ€èƒ½è¯„åˆ†ï¼ˆ1-5åˆ†ï¼‰ |
| `workEfficiencyRating` | number | âŒ | å·¥ä½œæ•ˆç‡è¯„åˆ†ï¼ˆ1-5åˆ†ï¼‰ |
| `communicationRating` | number | âŒ | æ²Ÿé€šèƒ½åŠ›è¯„åˆ†ï¼ˆ1-5åˆ†ï¼‰ |
| `comment` | string | âœ… | è¯„ä»·å†…å®¹ |
| `strengths` | string | âŒ | ä¼˜ç‚¹ |
| `improvements` | string | âŒ | å¾…æ”¹è¿›é¡¹ |
| `tags` | array | âŒ | è¯„ä»·æ ‡ç­¾ |
| `isPublic` | boolean | âŒ | æ˜¯å¦å…¬å¼€ï¼ˆé»˜è®¤falseï¼‰ |
| `status` | string | âŒ | çŠ¶æ€ï¼šdraft/published/archivedï¼ˆé»˜è®¤publishedï¼‰ |

#### å“åº”ç¤ºä¾‹

```json
{
  "success": true,
  "data": {
    "_id": "678a1b2c3d4e5f6789012345",
    "employeeId": "507f1f77bcf86cd799439011",
    "employeeName": "å¼ ä¸‰",
    "evaluatorId": "507f1f77bcf86cd799439013",
    "evaluatorName": "æç»ç†",
    "contractId": "507f1f77bcf86cd799439012",
    "contractNo": "CON20240101001",
    "evaluationType": "daily",
    "overallRating": 4.5,
    "serviceAttitudeRating": 5,
    "professionalSkillRating": 4,
    "workEfficiencyRating": 4.5,
    "communicationRating": 5,
    "comment": "å·¥ä½œè®¤çœŸè´Ÿè´£ï¼Œä¸“ä¸šæŠ€èƒ½å¼ºï¼ŒæœåŠ¡æ€åº¦å¥½",
    "strengths": "æœåŠ¡æ€åº¦å¥½ï¼ŒæŠ€èƒ½ç†Ÿç»ƒï¼Œæ²Ÿé€šèƒ½åŠ›å¼º",
    "improvements": "å·¥ä½œæ•ˆç‡å¯ä»¥è¿›ä¸€æ­¥æå‡",
    "tags": ["è®¤çœŸè´Ÿè´£", "æŠ€èƒ½ç†Ÿç»ƒ", "æ²Ÿé€šè‰¯å¥½"],
    "isPublic": false,
    "status": "published",
    "evaluationDate": "2026-01-18T10:30:00.000Z",
    "createdAt": "2026-01-18T10:30:00.000Z",
    "updatedAt": "2026-01-18T10:30:00.000Z"
  },
  "message": "å‘˜å·¥è¯„ä»·åˆ›å»ºæˆåŠŸ"
}
```

#### å°ç¨‹åºè°ƒç”¨ç¤ºä¾‹

```javascript
// åˆ›å»ºå‘˜å·¥è¯„ä»·
wx.request({
  url: 'https://crm.andejiazheng.com/api/employee-evaluations/miniprogram/create',
  method: 'POST',
  header: {
    'Authorization': `Bearer ${token}`,
    'Content-Type': 'application/json'
  },
  data: {
    employeeId: '507f1f77bcf86cd799439011',
    employeeName: 'å¼ ä¸‰',
    evaluationType: 'daily',
    overallRating: 4.5,
    serviceAttitudeRating: 5,
    professionalSkillRating: 4,
    comment: 'å·¥ä½œè®¤çœŸè´Ÿè´£ï¼Œä¸“ä¸šæŠ€èƒ½å¼º',
    tags: ['è®¤çœŸè´Ÿè´£', 'æŠ€èƒ½ç†Ÿç»ƒ']
  },
  success(res) {
    if (res.data.success) {
      wx.showToast({ title: 'è¯„ä»·æˆåŠŸ', icon: 'success' });
    }
  }
});
```

---

### è·å–è¯„ä»·åˆ—è¡¨

è·å–å‘˜å·¥è¯„ä»·åˆ—è¡¨ï¼Œæ”¯æŒç­›é€‰å’Œåˆ†é¡µã€‚

#### è¯·æ±‚

```http
GET /api/employee-evaluations/miniprogram/list?employeeId={employeeId}&page=1&pageSize=10
Authorization: Bearer {token}
```

**è®¤è¯**: âœ… éœ€è¦JWTè®¤è¯ + è§’è‰²æƒé™

#### æŸ¥è¯¢å‚æ•°

| å‚æ•° | ç±»å‹ | å¿…å¡« | è¯´æ˜ |
|------|------|------|------|
| `employeeId` | string | âŒ | å‘˜å·¥IDç­›é€‰ |
| `evaluatorId` | string | âŒ | è¯„ä»·äººIDç­›é€‰ |
| `evaluationType` | string | âŒ | è¯„ä»·ç±»å‹ç­›é€‰ |
| `status` | string | âŒ | çŠ¶æ€ç­›é€‰ |
| `page` | number | âŒ | é¡µç ï¼ˆé»˜è®¤1ï¼‰ |
| `pageSize` | number | âŒ | æ¯é¡µæ•°é‡ï¼ˆé»˜è®¤10ï¼‰ |

#### å“åº”ç¤ºä¾‹

```json
{
  "success": true,
  "data": {
    "items": [
      {
        "_id": "678a1b2c3d4e5f6789012345",
        "employeeId": {
          "_id": "507f1f77bcf86cd799439011",
          "name": "å¼ ä¸‰",
          "phone": "13800138000",
          "jobType": "yuexin"
        },
        "employeeName": "å¼ ä¸‰",
        "evaluatorId": {
          "_id": "507f1f77bcf86cd799439013",
          "username": "manager01",
          "name": "æç»ç†"
        },
        "evaluatorName": "æç»ç†",
        "overallRating": 4.5,
        "comment": "å·¥ä½œè®¤çœŸè´Ÿè´£ï¼Œä¸“ä¸šæŠ€èƒ½å¼º",
        "evaluationType": "daily",
        "status": "published",
        "evaluationDate": "2026-01-18T10:30:00.000Z"
      }
    ],
    "total": 25,
    "page": 1,
    "pageSize": 10,
    "totalPages": 3
  },
  "message": "è·å–å‘˜å·¥è¯„ä»·åˆ—è¡¨æˆåŠŸ"
}
```

#### å°ç¨‹åºè°ƒç”¨ç¤ºä¾‹

```javascript
// è·å–æŸä¸ªå‘˜å·¥çš„è¯„ä»·åˆ—è¡¨
const token = wx.getStorageSync('token');
wx.request({
  url: 'https://crm.andejiazheng.com/api/employee-evaluations/miniprogram/list',
  method: 'GET',
  header: {
    'Authorization': `Bearer ${token}`
  },
  data: {
    employeeId: '507f1f77bcf86cd799439011',
    page: 1,
    pageSize: 20
  },
  success(res) {
    if (res.data.success) {
      const evaluations = res.data.data.items;
      console.log('è¯„ä»·åˆ—è¡¨:', evaluations);
    }
  }
});
```

---

### è·å–è¯„ä»·ç»Ÿè®¡

è·å–å‘˜å·¥çš„è¯„ä»·ç»Ÿè®¡æ•°æ®ï¼ŒåŒ…æ‹¬å¹³å‡åˆ†ã€è¯„åˆ†åˆ†å¸ƒç­‰ã€‚

#### è¯·æ±‚

```http
GET /api/employee-evaluations/miniprogram/statistics/{employeeId}
Authorization: Bearer {token}
```

**è®¤è¯**: âœ… éœ€è¦JWTè®¤è¯ + è§’è‰²æƒé™

#### è·¯å¾„å‚æ•°

| å‚æ•° | ç±»å‹ | å¿…å¡« | è¯´æ˜ |
|------|------|------|------|
| `employeeId` | string | âœ… | å‘˜å·¥IDï¼ˆç®€å†IDï¼‰ |

#### å“åº”ç¤ºä¾‹

```json
{
  "success": true,
  "data": {
    "employeeId": "507f1f77bcf86cd799439011",
    "totalEvaluations": 25,
    "averageRating": 4.52,
    "averageServiceAttitude": 4.8,
    "averageProfessionalSkill": 4.5,
    "averageWorkEfficiency": 4.3,
    "averageCommunication": 4.7,
    "ratingDistribution": {
      "5": 12,
      "4": 10,
      "3": 3,
      "2": 0,
      "1": 0
    },
    "recentEvaluations": [
      {
        "_id": "678a1b2c3d4e5f6789012345",
        "evaluatorName": "æç»ç†",
        "overallRating": 4.5,
        "comment": "å·¥ä½œè®¤çœŸè´Ÿè´£ï¼Œä¸“ä¸šæŠ€èƒ½å¼º",
        "evaluationDate": "2026-01-18T10:30:00.000Z"
      }
    ]
  },
  "message": "è·å–å‘˜å·¥è¯„ä»·ç»Ÿè®¡æˆåŠŸ"
}
```

#### å“åº”å­—æ®µè¯´æ˜

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| `totalEvaluations` | number | æ€»è¯„ä»·æ•° |
| `averageRating` | number | ç»¼åˆå¹³å‡åˆ† |
| `averageServiceAttitude` | number | æœåŠ¡æ€åº¦å¹³å‡åˆ† |
| `averageProfessionalSkill` | number | ä¸“ä¸šæŠ€èƒ½å¹³å‡åˆ† |
| `averageWorkEfficiency` | number | å·¥ä½œæ•ˆç‡å¹³å‡åˆ† |
| `averageCommunication` | number | æ²Ÿé€šèƒ½åŠ›å¹³å‡åˆ† |
| `ratingDistribution` | object | è¯„åˆ†åˆ†å¸ƒï¼ˆ5åˆ†åˆ¶ï¼‰ |
| `recentEvaluations` | array | æœ€è¿‘5æ¡è¯„ä»· |

#### å°ç¨‹åºè°ƒç”¨ç¤ºä¾‹

```javascript
// è·å–å‘˜å·¥è¯„ä»·ç»Ÿè®¡
wx.request({
  url: `https://crm.andejiazheng.com/api/employee-evaluations/miniprogram/statistics/507f1f77bcf86cd799439011`,
  method: 'GET',
  success(res) {
    if (res.data.success) {
      const stats = res.data.data;
      console.log('å¹³å‡è¯„åˆ†:', stats.averageRating);
      console.log('æ€»è¯„ä»·æ•°:', stats.totalEvaluations);
      console.log('è¯„åˆ†åˆ†å¸ƒ:', stats.ratingDistribution);
    }
  }
});
```

---

## ğŸ“ åˆåŒç®¡ç†

å°ç¨‹åºç«¯åˆåŒç®¡ç†æ¥å£ï¼Œæ”¯æŒåˆåŒåˆ›å»ºã€æŸ¥è¯¢ã€æ›´æ–°ã€æ¢äººã€ä¿é™©åŒæ­¥ã€ç”µå­ç­¾ç« ç­‰å®Œæ•´æ“ä½œæµç¨‹ã€‚

**è·¯ç”±å‰ç¼€**: `/api/contracts/miniprogram/`
**è®¤è¯è¦æ±‚**: âœ… æ‰€æœ‰æ¥å£å‡éœ€JWTè®¤è¯ + è§’è‰²æƒé™éªŒè¯
**æ•°æ®éš”ç¦»**: æ™®é€šå‘˜å·¥ä»…å¯æŸ¥çœ‹è‡ªå·±åˆ›å»ºçš„åˆåŒï¼Œç®¡ç†å‘˜å’Œç»ç†å¯æŸ¥çœ‹å…¨éƒ¨

### åˆåŒç±»å‹æšä¸¾ï¼ˆContractTypeï¼‰

| å€¼ | è¯´æ˜ |
|------|------|
| `æœˆå«‚` | æœˆå«‚æœåŠ¡ |
| `ä½å®¶è‚²å„¿å«‚` | ä½å®¶è‚²å„¿å«‚æœåŠ¡ |
| `ä¿æ´` | ä¿æ´æœåŠ¡ |
| `ä½å®¶ä¿å§†` | ä½å®¶ä¿å§†æœåŠ¡ |
| `å…»å® ` | å…»å® æœåŠ¡ |
| `å°æ—¶å·¥` | å°æ—¶å·¥æœåŠ¡ |
| `ç™½ç­è‚²å„¿` | ç™½ç­è‚²å„¿æœåŠ¡ |
| `ç™½ç­ä¿å§†` | ç™½ç­ä¿å§†æœåŠ¡ |
| `ä½å®¶æŠ¤è€` | ä½å®¶æŠ¤è€æœåŠ¡ |

### åˆåŒçŠ¶æ€æšä¸¾ï¼ˆContractStatusï¼‰

| å€¼ | è¯´æ˜ |
|------|------|
| `draft` | è‰ç¨¿ |
| `signing` | ç­¾çº¦ä¸­ |
| `active` | ç”Ÿæ•ˆä¸­ |
| `replaced` | å·²è¢«æ›¿æ¢ |
| `cancelled` | å·²ä½œåºŸ |

---

### è·å–åˆåŒåˆ—è¡¨

åˆ†é¡µè·å–åˆåŒåˆ—è¡¨ï¼Œæ”¯æŒå…³é”®è¯æœç´¢ã€‚

#### è¯·æ±‚

```http
GET /api/contracts/miniprogram/list?page=1&limit=10&search=å­™å­¦åš
Authorization: Bearer {token}
```

**è®¤è¯**: âœ… éœ€è¦JWTè®¤è¯ + è§’è‰²æƒé™

| å‚æ•° | ç±»å‹ | å¿…å¡« | è¯´æ˜ |
|------|------|------|------|
| `page` | number | âŒ | é¡µç ï¼Œé»˜è®¤1 |
| `limit` | number | âŒ | æ¯é¡µæ•°é‡ï¼Œé»˜è®¤10 |
| `search` | string | âŒ | æœç´¢å…³é”®è¯ï¼ˆåŒ¹é…å®¢æˆ·å§“åã€æ‰‹æœºå·ã€åˆåŒç¼–å·ç­‰ï¼‰ |

#### å“åº”

```json
{
  "success": true,
  "data": {
    "contracts": [
      {
        "_id": "698549c7ff8bbd52fc75df76",
        "contractNumber": "CONTRACT_1770342853643_81ql5hl3v",
        "customerName": "å­™å­¦åš",
        "customerPhone": "18604592681",
        "contractType": "ä½å®¶è‚²å„¿å«‚",
        "contractStatus": "active",
        "workerName": "èµµç‘¶å¦‚",
        "workerPhone": "18614058566",
        "workerIdCard": "141034199605090042",
        "startDate": "2026-02-06T01:54:14.808Z",
        "endDate": "2027-02-06T00:00:00.000Z",
        "workerSalary": 7000,
        "customerServiceFee": 7000,
        "isLatest": true,
        "esignStatus": "2",
        "createdAt": "2026-02-06T01:54:14.808Z"
      }
    ],
    "total": 6,
    "page": 1,
    "limit": 10,
    "totalPages": 1
  },
  "message": "è·å–åˆåŒåˆ—è¡¨æˆåŠŸ"
}
```

---

### è·å–åˆåŒè¯¦æƒ…

æ ¹æ®åˆåŒIDè·å–å®Œæ•´è¯¦æƒ…ã€‚

#### è¯·æ±‚

```http
GET /api/contracts/miniprogram/detail/{id}
Authorization: Bearer {token}
```

**è®¤è¯**: âœ… éœ€è¦JWTè®¤è¯ + è§’è‰²æƒé™

| å‚æ•° | ç±»å‹ | å¿…å¡« | è¯´æ˜ |
|------|------|------|------|
| `id` | string | âœ… | åˆåŒID |

#### å“åº”

```json
{
  "success": true,
  "data": {
    "_id": "698549c7ff8bbd52fc75df76",
    "contractNumber": "CONTRACT_1770342853643_81ql5hl3v",
    "customerName": "å­™å­¦åš",
    "customerPhone": "18604592681",
    "customerIdCard": "230623199105111630",
    "contractType": "ä½å®¶è‚²å„¿å«‚",
    "contractStatus": "active",
    "workerName": "èµµç‘¶å¦‚",
    "workerIdCard": "141034199605090042",
    "startDate": "2026-02-06T01:54:14.808Z",
    "endDate": "2027-02-06T00:00:00.000Z",
    "workerSalary": 7000,
    "customerServiceFee": 7000,
    "esignContractNo": "CONTRACT_1770342853643_81ql5hl3v",
    "esignStatus": "2",
    "esignSignedAt": "2026-02-06T01:55:00.000Z",
    "isLatest": true,
    "insuranceSyncStatus": "success"
  },
  "message": "è·å–åˆåŒè¯¦æƒ…æˆåŠŸ"
}
```

---

### æ ¹æ®åˆåŒç¼–å·è·å–åˆåŒ

#### è¯·æ±‚

```http
GET /api/contracts/miniprogram/by-number/{contractNumber}
Authorization: Bearer {token}
```

**è®¤è¯**: âœ… éœ€è¦JWTè®¤è¯ + è§’è‰²æƒé™

| å‚æ•° | ç±»å‹ | å¿…å¡« | è¯´æ˜ |
|------|------|------|------|
| `contractNumber` | string | âœ… | åˆåŒç¼–å· |

#### å“åº”

```json
{
  "success": true,
  "data": { "...åˆåŒè¯¦æƒ…..." },
  "message": "è·å–åˆåŒè¯¦æƒ…æˆåŠŸ"
}
```

### æ ¹æ®å®¢æˆ·IDè·å–åˆåŒ

#### è¯·æ±‚

```http
GET /api/contracts/miniprogram/by-customer/{customerId}
Authorization: Bearer {token}
```

**è®¤è¯**: âœ… éœ€è¦JWTè®¤è¯ + è§’è‰²æƒé™

#### å“åº”

```json
{
  "success": true,
  "data": [ { "...åˆåŒå¯¹è±¡..." } ],
  "message": "è·å–å®¢æˆ·åˆåŒåˆ—è¡¨æˆåŠŸ"
}
```

---

### æ ¹æ®æœåŠ¡äººå‘˜IDè·å–åˆåŒ

#### è¯·æ±‚

```http
GET /api/contracts/miniprogram/by-worker-id/{workerId}
Authorization: Bearer {token}
```

**è®¤è¯**: âœ… éœ€è¦JWTè®¤è¯ + è§’è‰²æƒé™

#### å“åº”

```json
{
  "success": true,
  "data": [ { "...åˆåŒå¯¹è±¡..." } ],
  "message": "è·å–æœåŠ¡äººå‘˜åˆåŒåˆ—è¡¨æˆåŠŸ"
}
```

---

### æ ¹æ®æœåŠ¡äººå‘˜ä¿¡æ¯æœç´¢åˆåŒ

é€šè¿‡å§“åã€èº«ä»½è¯å·ã€æ‰‹æœºå·æ¨¡ç³Šæœç´¢å…³è”åˆåŒï¼Œå¸¸ç”¨äºä¿é™©æŠ•ä¿é¡µé¢è‡ªåŠ¨å¡«å……ã€‚

#### è¯·æ±‚

```http
GET /api/contracts/miniprogram/search-worker?name=èµµç‘¶å¦‚&idCard=141034199605090042&phone=18614058566
Authorization: Bearer {token}
```

**è®¤è¯**: âœ… éœ€è¦JWTè®¤è¯ + è§’è‰²æƒé™

| å‚æ•° | ç±»å‹ | å¿…å¡« | è¯´æ˜ |
|------|------|------|------|
| `name` | string | âŒ | æœåŠ¡äººå‘˜å§“å |
| `idCard` | string | âŒ | æœåŠ¡äººå‘˜èº«ä»½è¯å· |
| `phone` | string | âŒ | æœåŠ¡äººå‘˜æ‰‹æœºå· |

> è‡³å°‘æä¾›ä¸€ä¸ªæŸ¥è¯¢å‚æ•°

#### å“åº”

```json
{
  "success": true,
  "data": [
    {
      "_id": "698549c7ff8bbd52fc75df76",
      "contractNumber": "CONTRACT_1770342853643_81ql5hl3v",
      "customerName": "å­™å­¦åš",
      "workerName": "èµµç‘¶å¦‚",
      "contractStatus": "active"
    }
  ],
  "message": "æŸ¥è¯¢æˆåŠŸ"
}
```

---

### æ£€æŸ¥å®¢æˆ·ç°æœ‰åˆåŒ

æ£€æŸ¥å®¢æˆ·æ˜¯å¦å·²æœ‰åˆåŒï¼Œç”¨äºåˆ¤æ–­æ–°å»ºåˆåŒè¿˜æ˜¯æ¢äººåˆåŒã€‚

#### è¯·æ±‚

```http
GET /api/contracts/miniprogram/check-customer/{customerPhone}
Authorization: Bearer {token}
```

**è®¤è¯**: âœ… éœ€è¦JWTè®¤è¯ + è§’è‰²æƒé™

| å‚æ•° | ç±»å‹ | å¿…å¡« | è¯´æ˜ |
|------|------|------|------|
| `customerPhone` | string | âœ… | å®¢æˆ·æ‰‹æœºå· |

#### å“åº”

```json
{
  "success": true,
  "data": {
    "hasContract": true,
    "contract": { "...æœ€æ–°åˆåŒå¯¹è±¡..." },
    "contractCount": 3
  },
  "message": "å®¢æˆ·å·²æœ‰åˆåŒ"
}
```

---

### è·å–å®¢æˆ·åˆåŒå†å²

è·å–å®¢æˆ·çš„å®Œæ•´åˆåŒå˜æ›´å†å²è®°å½•ã€‚

#### è¯·æ±‚

```http
GET /api/contracts/miniprogram/history/{customerPhone}
Authorization: Bearer {token}
```

**è®¤è¯**: âœ… éœ€è¦JWTè®¤è¯ + è§’è‰²æƒé™

| å‚æ•° | ç±»å‹ | å¿…å¡« | è¯´æ˜ |
|------|------|------|------|
| `customerPhone` | string | âœ… | å®¢æˆ·æ‰‹æœºå· |

#### å“åº”

```json
{
  "success": true,
  "data": {
    "customerPhone": "18604592681",
    "contracts": [ { "...åˆåŒå¯¹è±¡..." } ],
    "timeline": [ { "...å˜æ›´è®°å½•..." } ]
  },
  "message": "è·å–å®¢æˆ·åˆåŒå†å²æˆåŠŸ"
}
```

---

### è·å–åˆåŒç»Ÿè®¡ä¿¡æ¯

è·å–åˆåŒæ€»æ•°ã€æŒ‰ç±»å‹ç»Ÿè®¡ã€æœ¬æœˆ/æœ¬å¹´æ•°é‡ç­‰ã€‚

#### è¯·æ±‚

```http
GET /api/contracts/miniprogram/statistics
Authorization: Bearer {token}
```

**è®¤è¯**: âœ… éœ€è¦JWTè®¤è¯ + è§’è‰²æƒé™

#### å“åº”

```json
{
  "success": true,
  "data": {
    "total": 6,
    "byContractType": { "ä½å®¶è‚²å„¿å«‚": 6 },
    "thisMonth": 5,
    "thisYear": 5
  },
  "message": "è·å–ç»Ÿè®¡ä¿¡æ¯æˆåŠŸ"
}
```

### åˆ›å»ºåˆåŒ

åˆ›å»ºæ–°åˆåŒã€‚

#### è¯·æ±‚

```http
POST /api/contracts/miniprogram/create
Authorization: Bearer {token}
Content-Type: application/json
```

**è®¤è¯**: âœ… éœ€è¦JWTè®¤è¯ + è§’è‰²æƒé™

```json
{
  "customerName": "å­™å­¦åš",
  "customerPhone": "18604592681",
  "customerIdCard": "230623199105111630",
  "contractType": "ä½å®¶è‚²å„¿å«‚",
  "startDate": "2026-02-06",
  "endDate": "2027-02-06",
  "workerName": "èµµç‘¶å¦‚",
  "workerPhone": "18614058566",
  "workerIdCard": "141034199605090042",
  "workerSalary": 7000,
  "customerServiceFee": 7000,
  "workerServiceFee": 500,
  "deposit": 1000,
  "remarks": "å¤‡æ³¨ä¿¡æ¯"
}
```

| å‚æ•° | ç±»å‹ | å¿…å¡« | è¯´æ˜ |
|------|------|------|------|
| `customerName` | string | âœ… | å®¢æˆ·å§“å |
| `customerPhone` | string | âœ… | å®¢æˆ·æ‰‹æœºå· |
| `customerIdCard` | string | âŒ | å®¢æˆ·èº«ä»½è¯å· |
| `contractType` | string | âŒ | åˆåŒç±»å‹ï¼ˆè§æšä¸¾ï¼‰ |
| `startDate` | string | âŒ | å¼€å§‹æ—¥æœŸ |
| `endDate` | string | âŒ | ç»“æŸæ—¥æœŸ |
| `workerName` | string | âŒ | æœåŠ¡äººå‘˜å§“å |
| `workerPhone` | string | âŒ | æœåŠ¡äººå‘˜æ‰‹æœºå· |
| `workerIdCard` | string | âŒ | æœåŠ¡äººå‘˜èº«ä»½è¯å· |
| `workerSalary` | number | âŒ | å®¶æ”¿å‘˜å·¥èµ„ |
| `customerServiceFee` | number | âŒ | å®¢æˆ·æœåŠ¡è´¹ |
| `workerServiceFee` | number | âŒ | å®¶æ”¿å‘˜æœåŠ¡è´¹ |
| `deposit` | number | âŒ | çº¦å®šå®šé‡‘ |
| `finalPayment` | number | âŒ | çº¦å®šå°¾æ¬¾ |
| `expectedDeliveryDate` | string | âŒ | é¢„äº§æœŸ |
| `salaryPaymentDay` | number | âŒ | å·¥èµ„å‘æ”¾æ—¥ï¼ˆ1-31ï¼‰ |
| `monthlyWorkDays` | number | âŒ | æœˆå·¥ä½œå¤©æ•°ï¼ˆ1-31ï¼‰ |
| `remarks` | string | âŒ | å¤‡æ³¨ |

#### å“åº”

```json
{
  "success": true,
  "data": { "...æ–°åˆ›å»ºçš„åˆåŒå¯¹è±¡..." },
  "message": "åˆåŒåˆ›å»ºæˆåŠŸ"
}
```

---

### æ›´æ–°åˆåŒ

#### è¯·æ±‚

```http
PUT /api/contracts/miniprogram/update/{id}
Authorization: Bearer {token}
Content-Type: application/json
```

**è®¤è¯**: âœ… éœ€è¦JWTè®¤è¯ + è§’è‰²æƒé™

| è·¯å¾„å‚æ•° | è¯´æ˜ |
|------|------|
| `id` | åˆåŒID |

è¯·æ±‚ä½“ä¸åˆ›å»ºåˆåŒå­—æ®µç›¸åŒï¼Œæ‰€æœ‰å­—æ®µå‡ä¸ºå¯é€‰ã€‚

#### å“åº”

```json
{
  "success": true,
  "data": { "...æ›´æ–°åçš„åˆåŒå¯¹è±¡..." },
  "message": "åˆåŒæ›´æ–°æˆåŠŸ"
}
```

---

### åˆ›å»ºæ¢äººåˆåŒ

åŸºäºåŸåˆåŒåˆ›å»ºæ¢äººåˆåŒï¼Œè‡ªåŠ¨åˆå¹¶åŸåˆåŒå‚æ•°ã€‚

#### è¯·æ±‚

```http
POST /api/contracts/miniprogram/change-worker/{originalContractId}
Authorization: Bearer {token}
Content-Type: application/json
```

**è®¤è¯**: âœ… éœ€è¦JWTè®¤è¯ + è§’è‰²æƒé™

| è·¯å¾„å‚æ•° | è¯´æ˜ |
|------|------|
| `originalContractId` | åŸåˆåŒID |

```json
{
  "customerName": "å­™å­¦åš",
  "customerPhone": "18604592681",
  "workerName": "å¾åŒæ¢…",
  "workerPhone": "18910415525",
  "workerIdCard": "13032219780902162X",
  "workerSalary": 7999,
  "customerServiceFee": 7000,
  "contractType": "ä½å®¶è‚²å„¿å«‚",
  "startDate": "2026-02-06",
  "endDate": "2027-02-06"
}
```

#### å“åº”

```json
{
  "success": true,
  "data": {
    "_id": "6985671d6f813160cd287bae",
    "contractNumber": "CONTRACT_1770350360363_zu643qx2b",
    "contractStatus": "draft",
    "replacesContractId": "698549c7ff8bbd52fc75df76"
  },
  "message": "æ¢äººåˆåŒåˆ›å»ºæˆåŠŸ"
}
```

---

### æ‰‹åŠ¨è§¦å‘ä¿é™©åŒæ­¥

åˆåŒç­¾çº¦åæ‰‹åŠ¨è§¦å‘ä¿é™©åŒæ­¥ï¼ˆæŸ¥è¯¢çˆ±ç­¾çŠ¶æ€å¹¶åŒæ­¥ä¿å•ï¼‰ã€‚

#### è¯·æ±‚

```http
POST /api/contracts/miniprogram/sync-insurance/{id}
Authorization: Bearer {token}
```

**è®¤è¯**: âœ… éœ€è¦JWTè®¤è¯ + è§’è‰²æƒé™

| è·¯å¾„å‚æ•° | è¯´æ˜ |
|------|------|
| `id` | åˆåŒID |

#### å“åº”

```json
{
  "success": true,
  "data": { "message": "ä¿é™©åŒæ­¥å·²å®Œæˆ", "syncResult": "..." },
  "message": "ä¿é™©åŒæ­¥å·²å®Œæˆ"
}
```

---

### åŒæ­¥çˆ±ç­¾åˆåŒçŠ¶æ€

ä»çˆ±ç­¾APIæŸ¥è¯¢æœ€æ–°çŠ¶æ€å¹¶åŒæ­¥åˆ°æœ¬åœ°æ•°æ®åº“ã€‚

#### è¯·æ±‚

```http
POST /api/contracts/miniprogram/sync-esign-status/{id}
Authorization: Bearer {token}
```

**è®¤è¯**: âœ… éœ€è¦JWTè®¤è¯ + è§’è‰²æƒé™

| è·¯å¾„å‚æ•° | è¯´æ˜ |
|------|------|
| `id` | åˆåŒID |

#### å“åº”

```json
{
  "success": true,
  "data": {
    "esignStatus": "2",
    "contractStatus": "active",
    "message": "å·²ç­¾çº¦"
  },
  "message": "çŠ¶æ€åŒæ­¥æˆåŠŸ"
}
```

**çˆ±ç­¾çŠ¶æ€è¯´æ˜**:

| esignStatus | contractStatus | è¯´æ˜ |
|-------------|----------------|------|
| "0" | "draft" | ç­‰å¾…ç­¾çº¦ |
| "1" | "signing" | ç­¾çº¦ä¸­ |
| "2" | "active" | å·²ç­¾çº¦ï¼ˆç”Ÿæ•ˆä¸­ï¼‰ |
| "3" | - | è¿‡æœŸ |
| "4" | - | æ‹’ç­¾ |
| "6" | "cancelled" | ä½œåºŸ |
| "7" | "cancelled" | æ’¤é”€ |

---

### æ‰¹é‡åŒæ­¥æ‰€æœ‰åˆåŒçŠ¶æ€

æ‰¹é‡åŒæ­¥æ‰€æœ‰è‰ç¨¿å’Œç­¾çº¦ä¸­çŠ¶æ€çš„åˆåŒï¼ˆæœ€å¤š50ä¸ªï¼‰ã€‚

#### è¯·æ±‚

```http
POST /api/contracts/miniprogram/sync-all-esign-status
Authorization: Bearer {token}
```

**è®¤è¯**: âœ… éœ€è¦JWTè®¤è¯ + è§’è‰²æƒé™

#### å“åº”

```json
{
  "success": true,
  "data": {
    "total": 5,
    "success": 5,
    "failed": 0,
    "updated": 3,
    "details": [
      {
        "contractNumber": "CONTRACT_1770282785780_59jb3gozk",
        "oldStatus": "draft",
        "newStatus": "active",
        "esignStatus": "2"
      },
      {
        "contractNumber": "CONTRACT_1754297069164_8dw350x75",
        "oldStatus": "draft",
        "newStatus": "signing",
        "esignStatus": "1"
      }
    ]
  },
  "message": "æ‰¹é‡åŒæ­¥å®Œæˆï¼šæˆåŠŸ5ä¸ªï¼Œå¤±è´¥0ä¸ªï¼Œæ›´æ–°3ä¸ª"
}
```

**ä½¿ç”¨åœºæ™¯**:
- CRMç«¯å‘ç°åˆåŒçŠ¶æ€ä¸ä¸€è‡´æ—¶
- å®šæœŸåŒæ­¥æ‰€æœ‰åˆåŒçŠ¶æ€
- çˆ±ç­¾å›è°ƒå¤±è´¥åçš„è¡¥æ•‘æªæ–½

---

### è·å–çˆ±ç­¾ä¿¡æ¯

è·å–åˆåŒå…³è”çš„çˆ±ç­¾ç”µå­ç­¾ç« ä¿¡æ¯ï¼ˆç­¾ç½²çŠ¶æ€ã€é¢„è§ˆé“¾æ¥ç­‰ï¼‰ã€‚

#### è¯·æ±‚

```http
GET /api/contracts/miniprogram/esign-info/{id}
Authorization: Bearer {token}
```

**è®¤è¯**: âœ… éœ€è¦JWTè®¤è¯ + è§’è‰²æƒé™

| è·¯å¾„å‚æ•° | è¯´æ˜ |
|------|------|
| `id` | åˆåŒID |

#### å“åº”

```json
{
  "success": true,
  "data": {
    "contractNo": "CONTRACT_1770342853643_81ql5hl3v",
    "templateNo": "TN84E8C106BFE74FD3AE36AC2CA33A44DE",
    "status": { "contractStatus": "2", "statusName": "å·²ç­¾çº¦" },
    "preview": { "previewUrl": "https://..." }
  },
  "message": "è·å–çˆ±ç­¾ä¿¡æ¯æˆåŠŸ"
}
```

---

### é‡æ–°è·å–ç­¾ç½²é“¾æ¥

é‡æ–°è·å–åˆåŒçš„ç­¾ç½²é“¾æ¥ï¼ˆç”¨äºç­¾ç½²é“¾æ¥è¿‡æœŸåé‡æ–°è·å–ï¼‰ã€‚

#### è¯·æ±‚

```http
POST /api/contracts/miniprogram/resend-sign-urls/{id}
Authorization: Bearer {token}
```

**è®¤è¯**: âœ… éœ€è¦JWTè®¤è¯ + è§’è‰²æƒé™

| è·¯å¾„å‚æ•° | è¯´æ˜ |
|------|------|
| `id` | åˆåŒID |

#### å“åº”

```json
{
  "success": true,
  "data": {
    "signUrls": [
      { "name": "å­™å­¦åš", "mobile": "18604592681", "signUrl": "https://..." },
      { "name": "èµµç‘¶å¦‚", "mobile": "18614058566", "signUrl": "https://..." }
    ]
  },
  "message": "è·å–ç­¾ç½²é“¾æ¥æˆåŠŸ"
}
```

---

### ä¸‹è½½å·²ç­¾ç½²åˆåŒ

ä¸‹è½½å·²ç­¾ç½²å®Œæˆçš„åˆåŒæ–‡ä»¶ã€‚

#### è¯·æ±‚

```http
POST /api/contracts/miniprogram/download-contract/{id}
Authorization: Bearer {token}
Content-Type: application/json
```

**è®¤è¯**: âœ… éœ€è¦JWTè®¤è¯ + è§’è‰²æƒé™

| è·¯å¾„å‚æ•° | è¯´æ˜ |
|------|------|
| `id` | åˆåŒID |

```json
{
  "force": 0,
  "downloadFileType": 0
}
```

| å‚æ•° | ç±»å‹ | å¿…å¡« | è¯´æ˜ |
|------|------|------|------|
| `force` | number | âŒ | æ˜¯å¦å¼ºåˆ¶é‡æ–°ç”Ÿæˆï¼ˆ0å¦/1æ˜¯ï¼‰ |
| `downloadFileType` | number | âŒ | æ–‡ä»¶ç±»å‹ï¼ˆ0-PDFï¼‰ |

#### å“åº”

```json
{
  "success": true,
  "data": { "downloadUrl": "https://..." },
  "message": "åˆåŒä¸‹è½½æˆåŠŸ"
}
```

---

### å°ç¨‹åºè°ƒç”¨ç¤ºä¾‹

```javascript
// utils/contract-api.js
const BASE_URL = 'https://crm.andejiazheng.com/api';

/** è·å–è¯·æ±‚å¤´ï¼ˆå«JWTè®¤è¯ï¼‰ */
function getAuthHeader() {
  const token = wx.getStorageSync('token');
  return {
    'Authorization': `Bearer ${token}`,
    'Content-Type': 'application/json'
  };
}

/** è·å–åˆåŒåˆ—è¡¨ï¼ˆæ™®é€šå‘˜å·¥ä»…è¿”å›è‡ªå·±åˆ›å»ºçš„åˆåŒï¼‰ */
export function getContractList(params = {}) {
  const query = new URLSearchParams(params).toString();
  return new Promise((resolve, reject) => {
    wx.request({
      url: `${BASE_URL}/contracts/miniprogram/list?${query}`,
      method: 'GET',
      header: getAuthHeader(),
      success(res) {
        if (res.data.success) resolve(res.data.data);
        else reject(new Error(res.data.message));
      },
      fail: reject
    });
  });
}

/** æ£€æŸ¥å®¢æˆ·æ˜¯å¦å·²æœ‰åˆåŒ */
export function checkCustomerContract(phone) {
  return new Promise((resolve, reject) => {
    wx.request({
      url: `${BASE_URL}/contracts/miniprogram/check-customer/${phone}`,
      method: 'GET',
      header: getAuthHeader(),
      success(res) {
        if (res.data.success) resolve(res.data.data);
        else reject(new Error(res.data.message));
      },
      fail: reject
    });
  });
}

/** åˆ›å»ºæ¢äººåˆåŒ */
export function createChangeWorkerContract(originalContractId, data) {
  return new Promise((resolve, reject) => {
    wx.request({
      url: `${BASE_URL}/contracts/miniprogram/change-worker/${originalContractId}`,
      method: 'POST',
      header: getAuthHeader(),
      data,
      success(res) {
        if (res.data.success) resolve(res.data.data);
        else reject(new Error(res.data.message));
      },
      fail: reject
    });
  });
}
```

---

## ğŸ›¡ï¸ ä¿é™©ä¿å•ç®¡ç†

å°ç¨‹åºç«¯ä¿é™©ä¿å•ç®¡ç†æ¥å£ï¼Œå¯¹æ¥å¤§æ ‘ä¿å¹³å°ï¼Œæ”¯æŒä¿å•åˆ›å»ºã€æŸ¥è¯¢ã€æ”¯ä»˜ã€é€€ä¿ç­‰å®Œæ•´æ“ä½œæµç¨‹ã€‚

**è·¯ç”±å‰ç¼€**: `/api/dashubao/miniprogram/`
**è®¤è¯è¦æ±‚**: âœ… æ‰€æœ‰æ¥å£å‡éœ€JWTè®¤è¯ + è§’è‰²æƒé™éªŒè¯
**æ•°æ®éš”ç¦»**: æ™®é€šå‘˜å·¥ä»…å¯æŸ¥çœ‹è‡ªå·±åˆ›å»ºçš„ä¿å•ï¼Œç®¡ç†å‘˜å’Œç»ç†å¯æŸ¥çœ‹å…¨éƒ¨

### ğŸ“‹ æ¥å£åˆ—è¡¨

| æ¥å£ | æ–¹æ³• | è·¯å¾„ | è¯´æ˜ |
|------|------|------|------|
| è·å–ä¿å•åˆ—è¡¨ | GET | `/api/dashubao/miniprogram/policies` | åˆ†é¡µè·å–ä¿å•åˆ—è¡¨ |
| èº«ä»½è¯æŸ¥ä¿å• | GET | `/api/dashubao/miniprogram/policy/by-id-card/:idCard` | æ ¹æ®è¢«ä¿é™©äººèº«ä»½è¯å·æŸ¥è¯¢ |
| ä¿å•å·æŸ¥ä¿å• | GET | `/api/dashubao/miniprogram/policy/by-policy-no/:policyNo` | æ ¹æ®å¤§æ ‘ä¿ä¿å•å·æŸ¥è¯¢ |
| å•†æˆ·å•å·æŸ¥ä¿å• | GET | `/api/dashubao/miniprogram/policy/by-policy-ref/:policyRef` | æ ¹æ®æ¸ é“æµæ°´å·æŸ¥è¯¢ |
| è·å–ä¿å•è¯¦æƒ… | GET | `/api/dashubao/miniprogram/policy/:id` | æ ¹æ®è®°å½•IDè·å–è¯¦æƒ… |
| åˆ›å»ºä¿å• | POST | `/api/dashubao/miniprogram/policy` | æŠ•ä¿ç¡®è®¤ï¼Œåˆ›å»ºæ–°ä¿å• |
| æŸ¥è¯¢ä¿å•çŠ¶æ€ | POST | `/api/dashubao/miniprogram/policy/query` | ä»å¤§æ ‘ä¿æŸ¥è¯¢æœ€æ–°çŠ¶æ€ |
| åˆ›å»ºæ”¯ä»˜è®¢å• | POST | `/api/dashubao/miniprogram/policy/payment/:policyRef` | è·å–å¾®ä¿¡å°ç¨‹åºæ”¯ä»˜ä¿¡æ¯ |
| æ³¨é”€ä¿å• | POST | `/api/dashubao/miniprogram/policy/cancel` | æ³¨é”€æœªç”Ÿæ•ˆä¿å• |
| é€€ä¿ | POST | `/api/dashubao/miniprogram/policy/surrender` | å·²ç”Ÿæ•ˆä¿å•é€€ä¿ |
| è·å–ç”µå­ä¿å• | POST | `/api/dashubao/miniprogram/policy/print` | è·å–ç”µå­ä¿å•PDF |
| æ‰¹æ”¹ä¿å• | POST | `/api/dashubao/miniprogram/policy/amend` | æ›¿æ¢è¢«ä¿é™©äºº |
| æ‰¹å¢è¢«ä¿é™©äºº | POST | `/api/dashubao/miniprogram/policy/add-insured` | å¢åŠ è¢«ä¿é™©äºº |
| åŒæ­¥ä¿å•çŠ¶æ€ | POST | `/api/dashubao/miniprogram/policy/sync/:identifier` | ä»å¤§æ ‘ä¿åŒæ­¥æœ€æ–°çŠ¶æ€åˆ°æœ¬åœ° |

---

### è·å–ä¿å•åˆ—è¡¨

åˆ†é¡µè·å–ä¿å•åˆ—è¡¨ï¼Œæ”¯æŒæŒ‰çŠ¶æ€å’Œç®€å†IDç­›é€‰ã€‚

#### è¯·æ±‚

```http
GET /api/dashubao/miniprogram/policies?page=1&limit=10&status=active
Authorization: Bearer {token}
```

**è®¤è¯**: âœ… éœ€è¦JWTè®¤è¯ + è§’è‰²æƒé™

#### è¯·æ±‚å‚æ•°

| å‚æ•° | ç±»å‹ | å¿…å¡« | è¯´æ˜ |
|------|------|------|------|
| `status` | string | å¦ | ä¿å•çŠ¶æ€ï¼špending/processing/active/expired/cancelled/surrendered |
| `resumeId` | string | å¦ | å…³è”ç®€å†ID |
| `page` | number | å¦ | é¡µç ï¼Œé»˜è®¤1 |
| `limit` | number | å¦ | æ¯é¡µæ¡æ•°ï¼Œé»˜è®¤10 |

#### å“åº”

```json
{
  "success": true,
  "data": {
    "data": [
      {
        "_id": "6985518e2b89d09207c00045",
        "agencyPolicyRef": "ANDE1770344846144mrvapl",
        "policyNo": "14527006800217497720",
        "planCode": "PK00029001",
        "effectiveDate": "20260207000000",
        "expireDate": "20260306000000",
        "groupSize": 1,
        "totalPremium": 12,
        "status": "active",
        "policyHolder": {
          "policyHolderType": "C",
          "policyHolderName": "åŒ—äº¬å®‰å¾—å®¶æ”¿æœ‰é™å…¬å¸",
          "phIdType": "G",
          "phIdNumber": "91110111MACJMD2R5J"
        },
        "insuredList": [
          {
            "insuredName": "èµµç‘¶å¦‚",
            "idType": "1",
            "idNumber": "141034199605090042",
            "birthDate": "19960509000000",
            "gender": "F",
            "mobile": "18614058566"
          }
        ],
        "contractId": "69855462f92117b2d2455202",
        "createdAt": "2026-02-06T02:27:26.411Z"
      }
    ],
    "total": 1
  },
  "message": "è·å–æˆåŠŸ"
}
```

#### ä¿å•çŠ¶æ€è¯´æ˜

| çŠ¶æ€å€¼ | è¯´æ˜ |
|--------|------|
| `pending` | å¾…æ”¯ä»˜ |
| `processing` | å¤„ç†ä¸­ |
| `active` | å·²ç”Ÿæ•ˆ |
| `expired` | å·²è¿‡æœŸ |
| `cancelled` | å·²æ³¨é”€ |
| `surrendered` | å·²é€€ä¿ |

---

### æ ¹æ®èº«ä»½è¯å·æŸ¥è¯¢ä¿å•

æ ¹æ®è¢«ä¿é™©äººçš„èº«ä»½è¯å·æŸ¥è¯¢æ‰€æœ‰å…³è”ä¿å•ã€‚

#### è¯·æ±‚

```http
GET /api/dashubao/miniprogram/policy/by-id-card/141034199605090042
Authorization: Bearer {token}
```

**è®¤è¯**: âœ… éœ€è¦JWTè®¤è¯ + è§’è‰²æƒé™

#### å“åº”

```json
{
  "success": true,
  "data": [
    {
      "_id": "6985518e2b89d09207c00045",
      "agencyPolicyRef": "ANDE1770344846144mrvapl",
      "policyNo": "14527006800217497720",
      "status": "active",
      "insuredList": [
        {
          "insuredName": "èµµç‘¶å¦‚",
          "idNumber": "141034199605090042"
        }
      ],
      "totalPremium": 12,
      "effectiveDate": "20260207000000",
      "expireDate": "20260306000000"
    }
  ],
  "message": "è·å–æˆåŠŸ"
}
```

---

### è·å–ä¿å•è¯¦æƒ…

æ ¹æ®ä¿å•è®°å½•IDè·å–å®Œæ•´è¯¦æƒ…ã€‚

#### è¯·æ±‚

```http
GET /api/dashubao/miniprogram/policy/6985518e2b89d09207c00045
Authorization: Bearer {token}
```

**è®¤è¯**: âœ… éœ€è¦JWTè®¤è¯ + è§’è‰²æƒé™

#### å“åº”

```json
{
  "success": true,
  "data": {
    "_id": "6985518e2b89d09207c00045",
    "agencyPolicyRef": "ANDE1770344846144mrvapl",
    "policyNo": "14527006800217497720",
    "orderId": "19753109",
    "productCode": "MP10450132",
    "planCode": "PK00029001",
    "issueDate": "20260206102726",
    "effectiveDate": "20260207000000",
    "expireDate": "20260306000000",
    "groupSize": 1,
    "totalPremium": 12,
    "status": "active",
    "policyHolder": {
      "policyHolderType": "C",
      "policyHolderName": "åŒ—äº¬å®‰å¾—å®¶æ”¿æœ‰é™å…¬å¸",
      "phIdType": "G",
      "phIdNumber": "91110111MACJMD2R5J",
      "phAddress": "åŒ—äº¬å¸‚æœé˜³åŒºæœ›äº¬å›­602å·æ¥¼3å±‚339"
    },
    "insuredList": [
      {
        "insuredName": "èµµç‘¶å¦‚",
        "insuredType": "1",
        "idType": "1",
        "idNumber": "141034199605090042",
        "birthDate": "19960509000000",
        "gender": "F",
        "mobile": "18614058566"
      }
    ],
    "contractId": "69855462f92117b2d2455202",
    "createdAt": "2026-02-06T02:27:26.411Z",
    "updatedAt": "2026-02-06T02:40:55.229Z"
  },
  "message": "è·å–æˆåŠŸ"
}
```

---

### æ ¹æ®ä¿å•å·æŸ¥è¯¢

æ ¹æ®å¤§æ ‘ä¿ä¿å•å·æŸ¥è¯¢ä¿å•ã€‚

#### è¯·æ±‚

```http
GET /api/dashubao/miniprogram/policy/by-policy-no/14527006800217497720
Authorization: Bearer {token}
```

**è®¤è¯**: âœ… éœ€è¦JWTè®¤è¯ + è§’è‰²æƒé™

#### å“åº”

åŒ"è·å–ä¿å•è¯¦æƒ…"å“åº”æ ¼å¼ã€‚

---

### æ ¹æ®å•†æˆ·å•å·æŸ¥è¯¢

æ ¹æ®æ¸ é“æµæ°´å·ï¼ˆå•†æˆ·å•å·ï¼‰æŸ¥è¯¢ä¿å•ã€‚

#### è¯·æ±‚

```http
GET /api/dashubao/miniprogram/policy/by-policy-ref/ANDE1770344846144mrvapl
Authorization: Bearer {token}
```

**è®¤è¯**: âœ… éœ€è¦JWTè®¤è¯ + è§’è‰²æƒé™

#### å“åº”

åŒ"è·å–ä¿å•è¯¦æƒ…"å“åº”æ ¼å¼ã€‚

---

### åˆ›å»ºä¿å•ï¼ˆæŠ•ä¿ï¼‰

å‘å¤§æ ‘ä¿å¹³å°æäº¤æŠ•ä¿è¯·æ±‚ï¼Œåˆ›å»ºæ–°ä¿å•ã€‚

#### è¯·æ±‚

```http
POST /api/dashubao/miniprogram/policy
Authorization: Bearer {token}
Content-Type: application/json
```

**è®¤è¯**: âœ… éœ€è¦JWTè®¤è¯ + è§’è‰²æƒé™

#### è¯·æ±‚å‚æ•°

```json
{
  "planCode": "PK00029001",
  "effectiveDate": "20260207000000",
  "expireDate": "20260306000000",
  "groupSize": 1,
  "totalPremium": 12,
  "policyHolder": {
    "policyHolderType": "C",
    "policyHolderName": "åŒ—äº¬å®‰å¾—å®¶æ”¿æœ‰é™å…¬å¸",
    "phIdType": "G",
    "phIdNumber": "91110111MACJMD2R5J",
    "phAddress": "åŒ—äº¬å¸‚æœé˜³åŒºæœ›äº¬å›­602å·æ¥¼3å±‚339",
    "phProvinceCode": "110000",
    "phCityCode": "110100",
    "phDistrictCode": "110105"
  },
  "insuredList": [
    {
      "insuredName": "èµµç‘¶å¦‚",
      "idType": "1",
      "idNumber": "141034199605090042",
      "birthDate": "19960509000000",
      "gender": "F",
      "mobile": "18614058566"
    }
  ],
  "resumeId": "å¯é€‰-å…³è”ç®€å†ID"
}
```

#### è¯·æ±‚å­—æ®µè¯´æ˜

| å­—æ®µ | ç±»å‹ | å¿…å¡« | è¯´æ˜ |
|------|------|------|------|
| `planCode` | string | âœ… | è®¡åˆ’ä»£ç  |
| `effectiveDate` | string | âœ… | ç”Ÿæ•ˆæ—¥æœŸï¼ˆyyyyMMddHHmmssï¼‰ |
| `expireDate` | string | âœ… | ç»“æŸæ—¥æœŸï¼ˆyyyyMMddHHmmssï¼‰ |
| `groupSize` | number | âœ… | è¢«ä¿é™©äººæ•°é‡ |
| `totalPremium` | number | âœ… | æ€»ä¿è´¹ |
| `productCode` | string | å¦ | äº§å“ä»£ç  |
| `destination` | string | å¦ | ç›®çš„åœ° |
| `remark` | string | å¦ | å¤‡æ³¨ |
| `serviceAddress` | string | å¦ | æœåŠ¡åœ°å€ï¼ˆå·¥å•é™©å¿…ä¼ ï¼‰ |
| `workOrderId` | string | å¦ | è®¢å•ç¼–å·ï¼ˆå·¥å•é™©å¿…ä¼ ï¼‰ |
| `resumeId` | string | å¦ | å…³è”çš„é˜¿å§¨ç®€å†ID |

**æŠ•ä¿äººå­—æ®µï¼ˆpolicyHolderï¼‰**:

| å­—æ®µ | ç±»å‹ | å¿…å¡« | è¯´æ˜ |
|------|------|------|------|
| `policyHolderType` | string | âœ… | I-ä¸ªäººï¼ŒC-ä¼ä¸š |
| `policyHolderName` | string | âœ… | æŠ•ä¿äººåç§° |
| `phIdType` | string | âœ… | è¯ä»¶ç±»å‹ï¼ˆG-è¥ä¸šæ‰§ç…§ï¼Œ1-èº«ä»½è¯ç­‰ï¼‰ |
| `phIdNumber` | string | âœ… | è¯ä»¶å·ç  |
| `phAddress` | string | å¦ | åœ°å€ |
| `phProvinceCode` | string | å¦ | çœçº§ç¼–ç ï¼ˆå·¥å•é™©å¿…ä¼ ï¼‰ |
| `phCityCode` | string | å¦ | å¸‚çº§ç¼–ç ï¼ˆå·¥å•é™©å¿…ä¼ ï¼‰ |
| `phDistrictCode` | string | å¦ | åŒºçº§ç¼–ç ï¼ˆå·¥å•é™©å¿…ä¼ ï¼‰ |

**è¢«ä¿é™©äººå­—æ®µï¼ˆinsuredList[]ï¼‰**:

| å­—æ®µ | ç±»å‹ | å¿…å¡« | è¯´æ˜ |
|------|------|------|------|
| `insuredName` | string | âœ… | è¢«ä¿é™©äººå§“å |
| `idType` | string | âœ… | è¯ä»¶ç±»å‹ï¼š1-èº«ä»½è¯ |
| `idNumber` | string | âœ… | è¯ä»¶å·ç  |
| `birthDate` | string | âœ… | å‡ºç”Ÿæ—¥æœŸï¼ˆyyyyMMddHHmmssï¼‰ |
| `gender` | string | âœ… | æ€§åˆ«ï¼šM-ç”·ï¼ŒF-å¥³ |
| `mobile` | string | å¦ | è”ç³»ç”µè¯ |
| `occupationCode` | string | å¦ | èŒä¸šç±»åˆ«ä»£ç  |

#### å“åº”

```json
{
  "success": true,
  "data": {
    "_id": "6985518e2b89d09207c00045",
    "agencyPolicyRef": "ANDE1770344846144mrvapl",
    "policyNo": "14527006800217497720",
    "status": "pending",
    "totalPremium": 12
  },
  "message": "ä¿å•åˆ›å»ºæˆåŠŸ"
}
```

---

### æŸ¥è¯¢ä¿å•çŠ¶æ€ï¼ˆå¤§æ ‘ä¿ï¼‰

ä»å¤§æ ‘ä¿å¹³å°æŸ¥è¯¢ä¿å•æœ€æ–°çŠ¶æ€ï¼ˆéæœ¬åœ°ç¼“å­˜ï¼‰ã€‚

#### è¯·æ±‚

```http
POST /api/dashubao/miniprogram/policy/query
Authorization: Bearer {token}
Content-Type: application/json
```

**è®¤è¯**: âœ… éœ€è¦JWTè®¤è¯ + è§’è‰²æƒé™

#### è¯·æ±‚å‚æ•°

```json
{
  "agencyPolicyRef": "ANDE1770344846144mrvapl",
  "policyNo": "14527006800217497720"
}
```

| å‚æ•° | ç±»å‹ | å¿…å¡« | è¯´æ˜ |
|------|------|------|------|
| `agencyPolicyRef` | string | äºŒé€‰ä¸€ | æ¸ é“æµæ°´å· |
| `policyNo` | string | äºŒé€‰ä¸€ | å¤§æ ‘ä¿ä¿å•å· |

#### å“åº”

```json
{
  "success": true,
  "data": {
    "Success": "true",
    "PolicyNo": "14527006800217497720",
    "Status": "1",
    "Message": ""
  },
  "message": "æŸ¥è¯¢æˆåŠŸ"
}
```

---

### åˆ›å»ºæ”¯ä»˜è®¢å•

è·å–å¾®ä¿¡å°ç¨‹åºæ”¯ä»˜ä¿¡æ¯ï¼Œç”¨äºå‘èµ·å¾®ä¿¡æ”¯ä»˜ã€‚å°ç¨‹åºç«¯å›ºå®šä½¿ç”¨ MINI æ”¯ä»˜æ–¹å¼ã€‚

#### è¯·æ±‚

```http
POST /api/dashubao/miniprogram/policy/payment/ANDE1770344846144mrvapl
Authorization: Bearer {token}
```

**è®¤è¯**: âœ… éœ€è¦JWTè®¤è¯ + è§’è‰²æƒé™

#### è·¯å¾„å‚æ•°

| å‚æ•° | è¯´æ˜ |
|------|------|
| `policyRef` | ä¿å•å·æˆ–å•†æˆ·å•å· |

#### å“åº”

```json
{
  "success": true,
  "data": {
    "Success": "true",
    "WeChatAppId": "wx1234567890",
    "WeChatTimeStamp": "1770344846",
    "WeChatNonceStr": "éšæœºå­—ç¬¦ä¸²",
    "WeChatPackageValue": "prepay_id=wx...",
    "WeChatSign": "ç­¾åå­—ç¬¦ä¸²",
    "WeChatPrepayId": "wx..."
  },
  "message": "è·å–æ”¯ä»˜ä¿¡æ¯æˆåŠŸ"
}
```

> âš ï¸ **æ³¨æ„**: æ”¯ä»˜æˆåŠŸåå¤§æ ‘ä¿ä¼šå›è°ƒ `/api/dashubao/payment/callback`ï¼ˆç³»ç»Ÿè‡ªåŠ¨å¤„ç†ï¼‰ï¼Œä¿å•çŠ¶æ€ä¼šè‡ªåŠ¨æ›´æ–°ä¸º `active`ã€‚

---

### æ³¨é”€ä¿å•

æ³¨é”€æœªç”Ÿæ•ˆçš„ä¿å•ã€‚

#### è¯·æ±‚

```http
POST /api/dashubao/miniprogram/policy/cancel
Authorization: Bearer {token}
Content-Type: application/json
```

**è®¤è¯**: âœ… éœ€è¦JWTè®¤è¯ + è§’è‰²æƒé™

```json
{
  "policyNo": "14527006800217497720"
}
```

#### å“åº”

```json
{
  "success": true,
  "data": { "Success": "true", "Message": "" },
  "message": "æ³¨é”€æˆåŠŸ"
}
```

---

### é€€ä¿

å·²ç”Ÿæ•ˆä¿å•é€€ä¿ã€‚

#### è¯·æ±‚

```http
POST /api/dashubao/miniprogram/policy/surrender
Authorization: Bearer {token}
Content-Type: application/json
```

**è®¤è¯**: âœ… éœ€è¦JWTè®¤è¯ + è§’è‰²æƒé™

```json
{
  "policyNo": "14527006800217497720",
  "removeReason": "13"
}
```

| å‚æ•° | ç±»å‹ | å¿…å¡« | è¯´æ˜ |
|------|------|------|------|
| `policyNo` | string | âœ… | ä¿å•å· |
| `removeReason` | string | âœ… | é€€ä¿åŸå› ï¼š13-é€€ç¥¨é€€ä¿ï¼Œ14-èˆªç­å–æ¶ˆï¼Œ15-èˆªç­æ”¹ç­¾ |

#### å“åº”

```json
{
  "success": true,
  "data": { "Success": "true", "SurrenderPremium": "10.00" },
  "message": "é€€ä¿æˆåŠŸ"
}
```

---

### è·å–ç”µå­ä¿å•PDF

è·å–ç”µå­ä¿å•PDFæ–‡ä»¶ã€‚

#### è¯·æ±‚

```http
POST /api/dashubao/miniprogram/policy/print
Authorization: Bearer {token}
Content-Type: application/json
```

**è®¤è¯**: âœ… éœ€è¦JWTè®¤è¯ + è§’è‰²æƒé™

```json
{
  "policyNo": "14527006800217497720"
}
```

#### å“åº”

è¿”å› `application/pdf` äºŒè¿›åˆ¶æ–‡ä»¶æµï¼Œå¯ç›´æ¥ç”¨äºä¸‹è½½æˆ–é¢„è§ˆã€‚

---

### æ‰¹æ”¹ä¿å•ï¼ˆæ›¿æ¢è¢«ä¿é™©äººï¼‰

æ›¿æ¢ä¿å•ä¸­çš„è¢«ä¿é™©äººä¿¡æ¯ã€‚

#### è¯·æ±‚

```http
POST /api/dashubao/miniprogram/policy/amend
Authorization: Bearer {token}
Content-Type: application/json
```

**è®¤è¯**: âœ… éœ€è¦JWTè®¤è¯ + è§’è‰²æƒé™

```json
{
  "policyNo": "14527006800217497720",
  "oldInsured": {
    "insuredName": "èµµç‘¶å¦‚",
    "idType": "1",
    "idNumber": "141034199605090042",
    "birthDate": "19960509000000",
    "gender": "F"
  },
  "newInsured": {
    "insuredName": "å¼ ä¸‰",
    "idType": "1",
    "idNumber": "110101199001011234",
    "birthDate": "19900101000000",
    "gender": "M",
    "mobile": "13800138000"
  }
}
```

#### å“åº”

```json
{
  "success": true,
  "data": { "Success": "true", "Message": "" },
  "message": "æ‰¹æ”¹æˆåŠŸ"
}
```

### æ‰¹å¢ï¼ˆå¢åŠ è¢«ä¿é™©äººï¼‰

åœ¨ç°æœ‰ä¿å•ä¸­å¢åŠ è¢«ä¿é™©äººã€‚

#### è¯·æ±‚

```http
POST /api/dashubao/miniprogram/policy/add-insured
Authorization: Bearer {token}
Content-Type: application/json
```

**è®¤è¯**: âœ… éœ€è¦JWTè®¤è¯ + è§’è‰²æƒé™

```json
{
  "policyNo": "14527006800217497720",
  "totalPremium": 24,
  "insuredList": [
    {
      "insuredName": "æå››",
      "idType": "1",
      "idNumber": "110101199201011234",
      "birthDate": "19920101000000",
      "gender": "M",
      "mobile": "13900139000"
    }
  ]
}
```

#### å“åº”

```json
{
  "success": true,
  "data": { "Success": "true", "Message": "" },
  "message": "æ‰¹å¢æˆåŠŸ"
}
```

---

### åŒæ­¥ä¿å•çŠ¶æ€

ä»å¤§æ ‘ä¿å¹³å°åŒæ­¥æœ€æ–°ä¿å•çŠ¶æ€åˆ°æœ¬åœ°æ•°æ®åº“ã€‚

#### è¯·æ±‚

```http
POST /api/dashubao/miniprogram/policy/sync/ANDE1770344846144mrvapl
Authorization: Bearer {token}
```

**è®¤è¯**: âœ… éœ€è¦JWTè®¤è¯ + è§’è‰²æƒé™

#### è·¯å¾„å‚æ•°

| å‚æ•° | è¯´æ˜ |
|------|------|
| `identifier` | ä¿å•å·æˆ–å•†æˆ·å•å· |

#### å“åº”

```json
{
  "success": true,
  "data": {
    "_id": "6985518e2b89d09207c00045",
    "status": "active",
    "policyNo": "14527006800217497720"
  },
  "message": "åŒæ­¥æˆåŠŸ"
}
```

---

### å°ç¨‹åºè°ƒç”¨ç¤ºä¾‹

```javascript
// utils/insurance-api.js
const BASE_URL = 'https://crm.andejiazheng.com/api';

/** è·å–è¯·æ±‚å¤´ï¼ˆå«JWTè®¤è¯ï¼‰ */
function getAuthHeader() {
  const token = wx.getStorageSync('token');
  return {
    'Authorization': `Bearer ${token}`,
    'Content-Type': 'application/json'
  };
}

/**
 * è·å–ä¿å•åˆ—è¡¨ï¼ˆæ™®é€šå‘˜å·¥ä»…è¿”å›è‡ªå·±åˆ›å»ºçš„ä¿å•ï¼‰
 */
export function getPolicyList(params = {}) {
  const query = new URLSearchParams(params).toString();
  return new Promise((resolve, reject) => {
    wx.request({
      url: `${BASE_URL}/dashubao/miniprogram/policies?${query}`,
      method: 'GET',
      header: getAuthHeader(),
      success(res) {
        if (res.data.success) resolve(res.data.data);
        else reject(new Error(res.data.message));
      },
      fail: reject
    });
  });
}

/**
 * æ ¹æ®èº«ä»½è¯å·æŸ¥è¯¢ä¿å•
 */
export function getPoliciesByIdCard(idCard) {
  return new Promise((resolve, reject) => {
    wx.request({
      url: `${BASE_URL}/dashubao/miniprogram/policy/by-id-card/${idCard}`,
      method: 'GET',
      header: getAuthHeader(),
      success(res) {
        if (res.data.success) resolve(res.data.data);
        else reject(new Error(res.data.message));
      },
      fail: reject
    });
  });
}

/**
 * åˆ›å»ºä¿å•
 */
export function createPolicy(policyData) {
  return new Promise((resolve, reject) => {
    wx.request({
      url: `${BASE_URL}/dashubao/miniprogram/policy`,
      method: 'POST',
      header: getAuthHeader(),
      data: policyData,
      success(res) {
        if (res.data.success) resolve(res.data.data);
        else reject(new Error(res.data.message));
      },
      fail: reject
    });
  });
}

/**
 * åˆ›å»ºæ”¯ä»˜è®¢å•ï¼ˆå°ç¨‹åºæ”¯ä»˜ï¼‰
 */
export function createPaymentOrder(policyRef) {
  return new Promise((resolve, reject) => {
    wx.request({
      url: `${BASE_URL}/dashubao/miniprogram/policy/payment/${policyRef}`,
      method: 'POST',
      header: getAuthHeader(),
      success(res) {
        if (res.data.success) resolve(res.data.data);
        else reject(new Error(res.data.message));
      },
      fail: reject
    });
  });
}

/**
 * å‘èµ·å¾®ä¿¡æ”¯ä»˜
 */
export async function payForPolicy(policyRef) {
  const payInfo = await createPaymentOrder(policyRef);
  return new Promise((resolve, reject) => {
    wx.requestPayment({
      timeStamp: payInfo.WeChatTimeStamp,
      nonceStr: payInfo.WeChatNonceStr,
      package: payInfo.WeChatPackageValue,
      signType: 'MD5',
      paySign: payInfo.WeChatSign,
      success: resolve,
      fail: reject
    });
  });
}
```

---

## ğŸ“ æŠ€æœ¯æ”¯æŒ

å¦‚æœ‰é—®é¢˜æˆ–å»ºè®®ï¼Œè¯·è”ç³»æŠ€æœ¯å›¢é˜Ÿã€‚

**æ–‡æ¡£ç‰ˆæœ¬**: v1.9.0
**æœ€åæ›´æ–°**: 2026-02-28
**ç»´æŠ¤å›¢é˜Ÿ**: å®‰å¾—å®¶æ”¿æŠ€æœ¯å›¢é˜Ÿ

**v1.9.0 æ›´æ–°å†…å®¹ï¼ˆå®‰å…¨åŠ å›ºï¼‰**:
- ğŸ”’ **åˆåŒæ¨¡å—**ï¼šç§»é™¤æ‰€æœ‰ `@Public()` è£…é¥°å™¨ï¼Œæ–°å¢ JWT è®¤è¯ + è§’è‰²æƒé™æ§åˆ¶ï¼ˆ24ä¸ªæ¥å£ï¼‰
- ğŸ”’ **ä¿é™©æ¨¡å—**ï¼šç§»é™¤æ‰€æœ‰ `@Public()` è£…é¥°å™¨ï¼Œæ–°å¢ JWT è®¤è¯ + è§’è‰²æƒé™æ§åˆ¶ï¼ˆ14ä¸ªæ¥å£ï¼‰
- ğŸ”’ **ç®€å†æ¨¡å—**ï¼šminiprogram æ¥å£æ–°å¢ `RolesGuard` è§’è‰²æƒé™éªŒè¯ï¼Œç§»é™¤ `create`/`get-by-id` çš„ `@Public()`
- ğŸ”’ **å‘˜å·¥è¯„ä»·æ¨¡å—**ï¼šç§»é™¤æ‰€æœ‰ `@Public()` è£…é¥°å™¨ï¼Œæ–°å¢ç±»çº§ JWT è®¤è¯ + è§’è‰²æƒé™æ§åˆ¶ï¼ˆ3ä¸ªæ¥å£ï¼‰
- âœ… å®æ–½ RBAC è§’è‰²æ•°æ®éš”ç¦»ï¼šæ™®é€šå‘˜å·¥ä»…å¯æŸ¥çœ‹è‡ªå·±åˆ›å»ºçš„æ•°æ®ï¼Œç®¡ç†å‘˜/ç»ç†å¯æŸ¥çœ‹å…¨éƒ¨
- âœ… ä¿æŒå…¬å¼€æ¥å£ä¸å˜ï¼šé˜¿å§¨è‡ªåŠ©æ³¨å†Œï¼ˆself-registerï¼‰ã€åˆ†äº«é“¾æ¥ï¼ˆshared/:tokenï¼‰ã€Bannerã€æ–‡ç« 
- âš ï¸ **æ³¨æ„**ï¼šæ‰€æœ‰ä¸šåŠ¡æ¥å£ç°åœ¨éœ€è¦åœ¨è¯·æ±‚å¤´ä¸­æºå¸¦ `Authorization: Bearer {token}`ï¼Œæœªæºå¸¦å°†è¿”å› 401

**v1.8.0 æ›´æ–°å†…å®¹**:
- âœ… æ–°å¢åˆåŒç®¡ç†APIï¼ˆ17ä¸ªæ¥å£ï¼‰
- âœ… æ”¯æŒåˆåŒåˆ›å»ºã€æŸ¥è¯¢ã€æ›´æ–°ã€æ¢äººã€ä¿é™©åŒæ­¥ç­‰å®Œæ•´æ“ä½œ
- âœ… æ”¯æŒæ ¹æ®åˆåŒç¼–å·ã€å®¢æˆ·IDã€æœåŠ¡äººå‘˜ä¿¡æ¯ç­‰å¤šç§æ–¹å¼æŸ¥è¯¢
- âœ… æ”¯æŒçˆ±ç­¾ç”µå­ç­¾ç« é›†æˆï¼ˆç­¾ç½²é“¾æ¥ã€ä¸‹è½½åˆåŒã€çŠ¶æ€æŸ¥è¯¢ï¼‰
- âœ… æ”¯æŒå®¢æˆ·åˆåŒå†å²å’Œç»Ÿè®¡ä¿¡æ¯

**v1.7.0 æ›´æ–°å†…å®¹**:
- âœ… æ–°å¢ä¿é™©ä¿å•ç®¡ç†APIï¼ˆ14ä¸ªæ¥å£ï¼‰
- âœ… æ”¯æŒä¿å•åˆ›å»ºã€æŸ¥è¯¢ã€æ”¯ä»˜ã€æ³¨é”€ã€é€€ä¿ã€æ‰¹æ”¹ã€æ‰¹å¢ç­‰å®Œæ•´æ“ä½œ
- âœ… æ”¯æŒæ ¹æ®èº«ä»½è¯å·ã€ä¿å•å·ã€å•†æˆ·å•å·å¤šç§æ–¹å¼æŸ¥è¯¢
- âœ… å°ç¨‹åºæ”¯ä»˜å›ºå®šä½¿ç”¨MINIæ”¯ä»˜æ–¹å¼
- âœ… æ”¯æŒä»å¤§æ ‘ä¿åŒæ­¥æœ€æ–°ä¿å•çŠ¶æ€

**v1.6.0 æ›´æ–°å†…å®¹**:
- âœ… æ–°å¢å‘˜å·¥è¯„ä»·ç®¡ç†APIï¼ˆåˆ›å»ºè¯„ä»·ã€è·å–è¯„ä»·åˆ—è¡¨ã€è·å–è¯„ä»·ç»Ÿè®¡ï¼‰
- âœ… æ”¯æŒå¤šç»´åº¦è¯„åˆ†ï¼ˆæœåŠ¡æ€åº¦ã€ä¸“ä¸šæŠ€èƒ½ã€å·¥ä½œæ•ˆç‡ã€æ²Ÿé€šèƒ½åŠ›ï¼‰
- âœ… æ”¯æŒè¯„ä»·æ ‡ç­¾å’Œè¯¦ç»†è¯„è¯­
- âœ… æä¾›è¯„ä»·ç»Ÿè®¡å’Œåˆ†æåŠŸèƒ½

**v1.5.0 æ›´æ–°å†…å®¹**:
- âœ… æ–°å¢æ–‡ç« å†…å®¹ç®¡ç†APIï¼ˆè·å–æ–‡ç« åˆ—è¡¨ã€è·å–æ–‡ç« è¯¦æƒ…ï¼‰
- âœ… å…¬å¼€æ¥å£ï¼Œæ— éœ€è®¤è¯ï¼Œè‡ªåŠ¨åªè¿”å›å·²å‘å¸ƒæ–‡ç« 
- âœ… æä¾›å®Œæ•´çš„å°ç¨‹åºè°ƒç”¨ç¤ºä¾‹å’Œé¡µé¢ä»£ç 
- âœ… æ”¯æŒæ–‡ç« æœç´¢ã€åˆ†é¡µå’ŒçŠ¶æ€ç­›é€‰
- âœ… æ”¯æŒå¯Œæ–‡æœ¬æ¸²æŸ“å’Œå›¾ç‰‡å±•ç¤º

