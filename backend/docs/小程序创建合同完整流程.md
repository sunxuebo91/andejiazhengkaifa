# å°ç¨‹åºåˆ›å»ºåˆåŒå®Œæ•´æµç¨‹æ–‡æ¡£

> **ç‰ˆæœ¬**: v1.0.0  
> **æ›´æ–°æ—¶é—´**: 2026-02-06  
> **é€‚ç”¨åœºæ™¯**: å°ç¨‹åºç«¯åˆ›å»ºå®¶æ”¿æœåŠ¡åˆåŒï¼ˆå«å¿«æ·æœç´¢ã€è‡ªåŠ¨å¡«å……ã€æ¢äººåˆå¹¶ï¼‰

---

## ğŸ“‹ ç›®å½•

- [æµç¨‹æ¦‚è§ˆ](#æµç¨‹æ¦‚è§ˆ)
- [æ ¸å¿ƒåŠŸèƒ½](#æ ¸å¿ƒåŠŸèƒ½)
- [APIæ¥å£è¯¦è§£](#apiæ¥å£è¯¦è§£)
- [å®Œæ•´ä»£ç ç¤ºä¾‹](#å®Œæ•´ä»£ç ç¤ºä¾‹)
- [å¸¸è§é—®é¢˜](#å¸¸è§é—®é¢˜)

---

## ğŸ¯ æµç¨‹æ¦‚è§ˆ

åˆ›å»ºåˆåŒåˆ†ä¸º **3ä¸ªæ ¸å¿ƒé˜¶æ®µ**ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  é˜¶æ®µ1: å¿«æ·æœç´¢æœåŠ¡äººå‘˜ (å¯é€‰)                              â”‚
â”‚  â†’ è¾“å…¥èº«ä»½è¯å·/å§“å/æ‰‹æœºå·                                  â”‚
â”‚  â†’ è‡ªåŠ¨å¡«å……æœåŠ¡äººå‘˜ä¿¡æ¯                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  é˜¶æ®µ2: æ£€æŸ¥å®¢æˆ·ç°æœ‰åˆåŒ (å¿…é¡»)                              â”‚
â”‚  â†’ è¾“å…¥å®¢æˆ·æ‰‹æœºå·                                            â”‚
â”‚  â†’ åˆ¤æ–­æ˜¯å¦éœ€è¦æ¢äºº                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  é˜¶æ®µ3: åˆ›å»ºåˆåŒ                                             â”‚
â”‚  â†’ å¦‚æœå®¢æˆ·æ— åˆåŒ: åˆ›å»ºæ–°åˆåŒ                                â”‚
â”‚  â†’ å¦‚æœå®¢æˆ·æœ‰åˆåŒ: è‡ªåŠ¨æ¢äººåˆå¹¶                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸš€ æ ¸å¿ƒåŠŸèƒ½

### 1. **å¿«æ·æœç´¢ + è‡ªåŠ¨å¡«å……**

é€šè¿‡æœåŠ¡äººå‘˜çš„**ä»»æ„ä¸€é¡¹ä¿¡æ¯**ï¼ˆèº«ä»½è¯å·/å§“å/æ‰‹æœºå·ï¼‰ï¼Œå¿«é€ŸæŸ¥æ‰¾å†å²åˆåŒå¹¶è‡ªåŠ¨å¡«å……ï¼š

- âœ… å®¢æˆ·ä¿¡æ¯ï¼ˆå§“åã€æ‰‹æœºã€åœ°å€ï¼‰
- âœ… æœåŠ¡äººå‘˜ä¿¡æ¯ï¼ˆå§“åã€èº«ä»½è¯ã€æ‰‹æœºï¼‰
- âœ… åˆåŒå‚æ•°ï¼ˆæœåŠ¡ç±»å‹ã€ä»·æ ¼ã€æœåŠ¡æ—¶é—´ï¼‰

### 2. **æ™ºèƒ½æ¢äººæ£€æµ‹**

è¾“å…¥å®¢æˆ·æ‰‹æœºå·åï¼Œç³»ç»Ÿè‡ªåŠ¨æ£€æµ‹ï¼š

- ğŸ” å®¢æˆ·æ˜¯å¦æœ‰ç°æœ‰åˆåŒ
- ğŸ”„ å¦‚æœæœ‰ï¼Œè‡ªåŠ¨è¿›å…¥**æ¢äººåˆå¹¶æ¨¡å¼**
- ğŸ“‹ ç»§æ‰¿åŸåˆåŒçš„å®¢æˆ·ä¿¡æ¯å’ŒæœåŠ¡å‚æ•°

### 3. **è‡ªåŠ¨åˆå¹¶åˆ›å»º**

åç«¯æ™ºèƒ½åˆ¤æ–­ï¼š

```javascript
// ä¼ªä»£ç é€»è¾‘
if (å®¢æˆ·æœ‰ç°æœ‰åˆåŒ) {
  è‡ªåŠ¨è°ƒç”¨æ¢äººæ¥å£
  åˆå¹¶åŸåˆåŒå‚æ•°
  æ ‡è®°æ—§åˆåŒä¸º isLatest=false
} else {
  åˆ›å»ºå…¨æ–°åˆåŒ
}
```

---

## ğŸ“¡ APIæ¥å£è¯¦è§£

### æ¥å£1: å¿«æ·æœç´¢æœåŠ¡äººå‘˜

**ç”¨é€”**: æ ¹æ®æœåŠ¡äººå‘˜ä¿¡æ¯æŸ¥æ‰¾å†å²åˆåŒï¼Œç”¨äºè‡ªåŠ¨å¡«å……è¡¨å•

#### è¯·æ±‚

```http
GET /api/contracts/miniprogram/search-worker?idCard=141034199605090042
```

**å‚æ•°** (è‡³å°‘æä¾›ä¸€ä¸ª):

| å‚æ•° | ç±»å‹ | å¿…å¡« | è¯´æ˜ |
|------|------|------|------|
| `name` | string | âŒ | æœåŠ¡äººå‘˜å§“å |
| `idCard` | string | âŒ | æœåŠ¡äººå‘˜èº«ä»½è¯å· |
| `phone` | string | âŒ | æœåŠ¡äººå‘˜æ‰‹æœºå· |

#### å“åº”

```json
{
  "success": true,
  "data": [
    {
      "_id": "698549c7ff8bbd52fc75df76",
      "contractNumber": "CONTRACT_1770342853643_81ql5hl3v",
      "customerName": "å­™å­¦åš",
      "customerPhone": "18604592681",
      "customerAddress": "åŒ—äº¬å¸‚æœé˜³åŒºæœ›äº¬SOHO",
      "workerName": "èµµç‘¶å¦‚",
      "workerIdCard": "141034199605090042",
      "workerPhone": "18614058566",
      "contractType": "ä½å®¶è‚²å„¿å«‚",
      "servicePrice": 8800,
      "startDate": "2026-02-07T00:00:00.000Z",
      "endDate": "2026-03-06T00:00:00.000Z"
    }
  ],
  "message": "æŸ¥è¯¢æˆåŠŸ"
}
```

#### å°ç¨‹åºä½¿ç”¨ç¤ºä¾‹

```javascript
// 1. ç›‘å¬èº«ä»½è¯å·è¾“å…¥
onIdCardInput(e) {
  const idCard = e.detail.value;
  
  // èº«ä»½è¯å·æ»¡18ä½æ—¶è‡ªåŠ¨æœç´¢
  if (idCard.length === 18) {
    this.searchWorkerAndFill(idCard);
  }
},

// 2. æœç´¢å¹¶è‡ªåŠ¨å¡«å……
async searchWorkerAndFill(idCard) {
  wx.showLoading({ title: 'æŸ¥è¯¢ä¸­...' });
  
  try {
    const res = await wx.request({
      url: 'https://your-domain.com/api/contracts/miniprogram/search-worker',
      method: 'GET',
      data: { idCard }
    });
    
    if (res.data.success && res.data.data.length > 0) {
      const contract = res.data.data[0]; // å–æœ€æ–°çš„åˆåŒ
      
      // è‡ªåŠ¨å¡«å……è¡¨å•
      this.setData({
        'formData.customerName': contract.customerName,
        'formData.customerPhone': contract.customerPhone,
        'formData.customerAddress': contract.customerAddress,
        'formData.workerName': contract.workerName,
        'formData.workerPhone': contract.workerPhone,
        'formData.contractType': contract.contractType,
        'formData.servicePrice': contract.servicePrice
      });
      
      wx.showToast({ title: 'å·²è‡ªåŠ¨å¡«å……', icon: 'success' });
    }
  } catch (error) {
    console.error('æœç´¢å¤±è´¥:', error);
  } finally {
    wx.hideLoading();
  }
}
```

---

### æ¥å£2: æ£€æŸ¥å®¢æˆ·ç°æœ‰åˆåŒ

**ç”¨é€”**: åˆ¤æ–­å®¢æˆ·æ˜¯å¦æœ‰ç°æœ‰åˆåŒï¼Œå†³å®šæ˜¯åˆ›å»ºæ–°åˆåŒè¿˜æ˜¯æ¢äºº

#### è¯·æ±‚

```http
GET /api/contracts/miniprogram/check-customer/18604592681
```

**å‚æ•°**:

| å‚æ•° | ç±»å‹ | å¿…å¡« | è¯´æ˜ |
|------|------|------|------|
| `customerPhone` | string | âœ… | å®¢æˆ·æ‰‹æœºå·ï¼ˆè·¯å¾„å‚æ•°ï¼‰ |

#### å“åº”

**æƒ…å†µ1: å®¢æˆ·æœ‰åˆåŒ**

```json
{
  "success": true,
  "data": {
    "hasContract": true,
    "contract": {
      "_id": "698549c7ff8bbd52fc75df76",
      "contractNumber": "CONTRACT_1770342853643_81ql5hl3v",
      "customerName": "å­™å­¦åš",
      "customerPhone": "18604592681",
      "workerName": "èµµç‘¶å¦‚",
      "esignStatus": "2",
      "contractStatus": "active"
    },
    "contractCount": 1,
    "isSignedContract": true
  },
  "message": "å®¢æˆ·å·²æœ‰åˆåŒ"
}
```

**æƒ…å†µ2: å®¢æˆ·æ— åˆåŒ**

```json
{
  "success": true,
  "data": {
    "hasContract": false,
    "contractCount": 0,
    "isSignedContract": false
  },
  "message": "å®¢æˆ·æš‚æ— åˆåŒ"
}
```

#### å°ç¨‹åºä½¿ç”¨ç¤ºä¾‹

```javascript
// ç›‘å¬å®¢æˆ·æ‰‹æœºå·è¾“å…¥
onCustomerPhoneBlur(e) {
  const phone = e.detail.value;

  if (phone.length === 11) {
    this.checkCustomerContract(phone);
  }
},

// æ£€æŸ¥å®¢æˆ·åˆåŒ
async checkCustomerContract(phone) {
  try {
    const res = await wx.request({
      url: `https://your-domain.com/api/contracts/miniprogram/check-customer/${phone}`,
      method: 'GET'
    });

    if (res.data.success) {
      const { hasContract, contract } = res.data.data;

      if (hasContract) {
        // å®¢æˆ·æœ‰åˆåŒï¼Œæç¤ºå°†è¿›å…¥æ¢äººæ¨¡å¼
        this.setData({
          isChangeWorkerMode: true,
          originalContract: contract
        });

        wx.showModal({
          title: 'æ£€æµ‹åˆ°ç°æœ‰åˆåŒ',
          content: `å®¢æˆ· ${contract.customerName} å·²æœ‰åˆåŒï¼ˆ${contract.contractNumber}ï¼‰ï¼Œå°†è‡ªåŠ¨è¿›å…¥æ¢äººæ¨¡å¼`,
          showCancel: false
        });

        // è‡ªåŠ¨å¡«å……å®¢æˆ·ä¿¡æ¯ï¼ˆä»åŸåˆåŒç»§æ‰¿ï¼‰
        this.setData({
          'formData.customerName': contract.customerName,
          'formData.customerAddress': contract.customerAddress
        });
      } else {
        // å®¢æˆ·æ— åˆåŒï¼Œæ­£å¸¸åˆ›å»º
        this.setData({
          isChangeWorkerMode: false,
          originalContract: null
        });
      }
    }
  } catch (error) {
    console.error('æ£€æŸ¥å®¢æˆ·åˆåŒå¤±è´¥:', error);
  }
}
```

---

### æ¥å£3: åˆ›å»ºåˆåŒ

**ç”¨é€”**: åˆ›å»ºæ–°åˆåŒï¼ˆåç«¯ä¼šè‡ªåŠ¨åˆ¤æ–­æ˜¯å¦éœ€è¦æ¢äººï¼‰

#### è¯·æ±‚

```http
POST /api/contracts/miniprogram/create
Content-Type: application/json
```

**è¯·æ±‚ä½“**:

```json
{
  "customerName": "å­™å­¦åš",
  "customerPhone": "18604592681",
  "customerIdCard": "230623199105111630",
  "customerAddress": "åŒ—äº¬å¸‚æœé˜³åŒºæœ›äº¬SOHO T1-2301",
  "workerName": "èµµç‘¶å¦‚",
  "workerIdCard": "141034199605090042",
  "workerPhone": "18614058566",
  "contractType": "ä½å®¶è‚²å„¿å«‚",
  "servicePrice": 8800,
  "startDate": "2026-02-07",
  "endDate": "2026-03-06",
  "paymentMethod": "monthly",
  "remarks": "å®¢æˆ·è¦æ±‚å‘¨æœ«ä¼‘æ¯"
}
```

**å­—æ®µè¯´æ˜**:

| å­—æ®µ | ç±»å‹ | å¿…å¡« | è¯´æ˜ |
|------|------|------|------|
| `customerName` | string | âœ… | å®¢æˆ·å§“å |
| `customerPhone` | string | âœ… | å®¢æˆ·æ‰‹æœºå·ï¼ˆ11ä½ï¼‰ |
| `customerIdCard` | string | âŒ | å®¢æˆ·èº«ä»½è¯å· |
| `customerAddress` | string | âœ… | å®¢æˆ·åœ°å€ |
| `workerName` | string | âœ… | æœåŠ¡äººå‘˜å§“å |
| `workerIdCard` | string | âœ… | æœåŠ¡äººå‘˜èº«ä»½è¯å·ï¼ˆ18ä½ï¼‰ |
| `workerPhone` | string | âœ… | æœåŠ¡äººå‘˜æ‰‹æœºå· |
| `contractType` | string | âœ… | åˆåŒç±»å‹ï¼ˆå¦‚ï¼šä½å®¶è‚²å„¿å«‚ã€é’Ÿç‚¹å·¥ï¼‰ |
| `servicePrice` | number | âœ… | æœåŠ¡ä»·æ ¼ï¼ˆå…ƒ/æœˆï¼‰ |
| `startDate` | string | âœ… | å¼€å§‹æ—¥æœŸï¼ˆYYYY-MM-DDï¼‰ |
| `endDate` | string | âœ… | ç»“æŸæ—¥æœŸï¼ˆYYYY-MM-DDï¼‰ |
| `paymentMethod` | string | âŒ | æ”¯ä»˜æ–¹å¼ï¼ˆmonthly/quarterly/yearlyï¼‰ |
| `remarks` | string | âŒ | å¤‡æ³¨ |

#### å“åº”

```json
{
  "success": true,
  "data": {
    "_id": "69855462f92117b2d2455202",
    "contractNumber": "CONTRACT_1770344846144_mrvapl",
    "customerName": "å­™å­¦åš",
    "customerPhone": "18604592681",
    "workerName": "èµµç‘¶å¦‚",
    "esignContractNo": "2025020612345678",
    "esignStatus": "0",
    "contractStatus": "pending",
    "createdAt": "2026-02-06T10:27:26.411Z"
  },
  "message": "åˆåŒåˆ›å»ºæˆåŠŸ"
}
```

#### å°ç¨‹åºä½¿ç”¨ç¤ºä¾‹

```javascript
// æäº¤åˆ›å»ºåˆåŒ
async submitContract() {
  const { formData, isChangeWorkerMode, originalContract } = this.data;

  // è¡¨å•éªŒè¯
  if (!this.validateForm(formData)) {
    return;
  }

  wx.showLoading({ title: 'åˆ›å»ºä¸­...' });

  try {
    let res;

    if (isChangeWorkerMode && originalContract) {
      // æ¢äººæ¨¡å¼ï¼šè°ƒç”¨æ¢äººæ¥å£
      res = await wx.request({
        url: `https://your-domain.com/api/contracts/miniprogram/change-worker/${originalContract._id}`,
        method: 'POST',
        header: { 'Content-Type': 'application/json' },
        data: formData
      });
    } else {
      // æ­£å¸¸æ¨¡å¼ï¼šè°ƒç”¨åˆ›å»ºæ¥å£
      res = await wx.request({
        url: 'https://your-domain.com/api/contracts/miniprogram/create',
        method: 'POST',
        header: { 'Content-Type': 'application/json' },
        data: formData
      });
    }

    if (res.data.success) {
      const contract = res.data.data;

      wx.showToast({ title: 'åˆ›å»ºæˆåŠŸ', icon: 'success' });

      // è·³è½¬åˆ°åˆåŒè¯¦æƒ…é¡µ
      wx.navigateTo({
        url: `/pages/contract/detail?id=${contract._id}`
      });
    } else {
      wx.showModal({
        title: 'åˆ›å»ºå¤±è´¥',
        content: res.data.message,
        showCancel: false
      });
    }
  } catch (error) {
    console.error('åˆ›å»ºåˆåŒå¤±è´¥:', error);
    wx.showModal({
      title: 'é”™è¯¯',
      content: 'ç½‘ç»œè¯·æ±‚å¤±è´¥ï¼Œè¯·é‡è¯•',
      showCancel: false
    });
  } finally {
    wx.hideLoading();
  }
},

// è¡¨å•éªŒè¯
validateForm(data) {
  const required = [
    { field: 'customerName', name: 'å®¢æˆ·å§“å' },
    { field: 'customerPhone', name: 'å®¢æˆ·æ‰‹æœºå·' },
    { field: 'customerAddress', name: 'å®¢æˆ·åœ°å€' },
    { field: 'workerName', name: 'æœåŠ¡äººå‘˜å§“å' },
    { field: 'workerIdCard', name: 'æœåŠ¡äººå‘˜èº«ä»½è¯' },
    { field: 'workerPhone', name: 'æœåŠ¡äººå‘˜æ‰‹æœºå·' },
    { field: 'contractType', name: 'åˆåŒç±»å‹' },
    { field: 'servicePrice', name: 'æœåŠ¡ä»·æ ¼' },
    { field: 'startDate', name: 'å¼€å§‹æ—¥æœŸ' },
    { field: 'endDate', name: 'ç»“æŸæ—¥æœŸ' }
  ];

  for (const item of required) {
    if (!data[item.field]) {
      wx.showToast({
        title: `è¯·å¡«å†™${item.name}`,
        icon: 'none'
      });
      return false;
    }
  }

  // æ‰‹æœºå·éªŒè¯
  if (!/^1[3-9]\d{9}$/.test(data.customerPhone)) {
    wx.showToast({ title: 'å®¢æˆ·æ‰‹æœºå·æ ¼å¼é”™è¯¯', icon: 'none' });
    return false;
  }

  if (!/^1[3-9]\d{9}$/.test(data.workerPhone)) {
    wx.showToast({ title: 'æœåŠ¡äººå‘˜æ‰‹æœºå·æ ¼å¼é”™è¯¯', icon: 'none' });
    return false;
  }

  // èº«ä»½è¯å·éªŒè¯
  if (!/^\d{17}[\dXx]$/.test(data.workerIdCard)) {
    wx.showToast({ title: 'èº«ä»½è¯å·æ ¼å¼é”™è¯¯', icon: 'none' });
    return false;
  }

  return true;
}
```

---

## ğŸ’¡ å®Œæ•´ä»£ç ç¤ºä¾‹

### å°ç¨‹åºé¡µé¢å®Œæ•´å®ç°

**WXML (create-contract.wxml)**

```xml
<view class="container">
  <form bindsubmit="submitContract">
    <!-- æœåŠ¡äººå‘˜ä¿¡æ¯ -->
    <view class="section">
      <view class="section-title">æœåŠ¡äººå‘˜ä¿¡æ¯</view>

      <view class="form-item">
        <text class="label">èº«ä»½è¯å· *</text>
        <input
          class="input"
          type="idcard"
          placeholder="è¾“å…¥èº«ä»½è¯å·è‡ªåŠ¨å¡«å……"
          value="{{formData.workerIdCard}}"
          bindinput="onWorkerIdCardInput"
          maxlength="18"
        />
      </view>

      <view class="form-item">
        <text class="label">å§“å *</text>
        <input
          class="input"
          placeholder="è¯·è¾“å…¥å§“å"
          value="{{formData.workerName}}"
          bindinput="onInput"
          data-field="workerName"
        />
      </view>

      <view class="form-item">
        <text class="label">æ‰‹æœºå· *</text>
        <input
          class="input"
          type="number"
          placeholder="è¯·è¾“å…¥æ‰‹æœºå·"
          value="{{formData.workerPhone}}"
          bindinput="onInput"
          data-field="workerPhone"
          maxlength="11"
        />
      </view>
    </view>

    <!-- å®¢æˆ·ä¿¡æ¯ -->
    <view class="section">
      <view class="section-title">å®¢æˆ·ä¿¡æ¯</view>

      <view class="form-item">
        <text class="label">æ‰‹æœºå· *</text>
        <input
          class="input"
          type="number"
          placeholder="è¾“å…¥æ‰‹æœºå·æ£€æŸ¥ç°æœ‰åˆåŒ"
          value="{{formData.customerPhone}}"
          bindinput="onInput"
          bindblur="onCustomerPhoneBlur"
          data-field="customerPhone"
          maxlength="11"
        />
      </view>

      <view wx:if="{{isChangeWorkerMode}}" class="tip warning">
        <text>âš ï¸ æ£€æµ‹åˆ°å®¢æˆ·å·²æœ‰åˆåŒï¼Œå°†è‡ªåŠ¨è¿›å…¥æ¢äººæ¨¡å¼</text>
      </view>

      <view class="form-item">
        <text class="label">å§“å *</text>
        <input
          class="input"
          placeholder="è¯·è¾“å…¥å§“å"
          value="{{formData.customerName}}"
          bindinput="onInput"
          data-field="customerName"
        />
      </view>

      <view class="form-item">
        <text class="label">åœ°å€ *</text>
        <textarea
          class="textarea"
          placeholder="è¯·è¾“å…¥è¯¦ç»†åœ°å€"
          value="{{formData.customerAddress}}"
          bindinput="onInput"
          data-field="customerAddress"
          maxlength="200"
        />
      </view>
    </view>

    <!-- åˆåŒä¿¡æ¯ -->
    <view class="section">
      <view class="section-title">åˆåŒä¿¡æ¯</view>

      <view class="form-item">
        <text class="label">æœåŠ¡ç±»å‹ *</text>
        <picker
          mode="selector"
          range="{{contractTypes}}"
          value="{{contractTypeIndex}}"
          bindchange="onContractTypeChange"
        >
          <view class="picker">
            {{formData.contractType || 'è¯·é€‰æ‹©æœåŠ¡ç±»å‹'}}
          </view>
        </picker>
      </view>

      <view class="form-item">
        <text class="label">æœåŠ¡ä»·æ ¼ *</text>
        <input
          class="input"
          type="digit"
          placeholder="è¯·è¾“å…¥ä»·æ ¼ï¼ˆå…ƒ/æœˆï¼‰"
          value="{{formData.servicePrice}}"
          bindinput="onInput"
          data-field="servicePrice"
        />
      </view>

      <view class="form-item">
        <text class="label">å¼€å§‹æ—¥æœŸ *</text>
        <picker
          mode="date"
          value="{{formData.startDate}}"
          bindchange="onDateChange"
          data-field="startDate"
        >
          <view class="picker">
            {{formData.startDate || 'è¯·é€‰æ‹©å¼€å§‹æ—¥æœŸ'}}
          </view>
        </picker>
      </view>

      <view class="form-item">
        <text class="label">ç»“æŸæ—¥æœŸ *</text>
        <picker
          mode="date"
          value="{{formData.endDate}}"
          bindchange="onDateChange"
          data-field="endDate"
        >
          <view class="picker">
            {{formData.endDate || 'è¯·é€‰æ‹©ç»“æŸæ—¥æœŸ'}}
          </view>
        </picker>
      </view>

      <view class="form-item">
        <text class="label">å¤‡æ³¨</text>
        <textarea
          class="textarea"
          placeholder="è¯·è¾“å…¥å¤‡æ³¨ä¿¡æ¯"
          value="{{formData.remarks}}"
          bindinput="onInput"
          data-field="remarks"
          maxlength="500"
        />
      </view>
    </view>

    <!-- æäº¤æŒ‰é’® -->
    <view class="submit-section">
      <button class="submit-btn" formType="submit">
        {{isChangeWorkerMode ? 'åˆ›å»ºæ¢äººåˆåŒ' : 'åˆ›å»ºåˆåŒ'}}
      </button>
    </view>
  </form>
</view>
```

**JavaScript (create-contract.js)**

```javascript
const BASE_URL = 'https://your-domain.com/api';

Page({
  data: {
    formData: {
      workerIdCard: '',
      workerName: '',
      workerPhone: '',
      customerPhone: '',
      customerName: '',
      customerAddress: '',
      contractType: '',
      servicePrice: '',
      startDate: '',
      endDate: '',
      remarks: ''
    },
    contractTypes: ['ä½å®¶è‚²å„¿å«‚', 'ä½å®¶ä¿å§†', 'é’Ÿç‚¹å·¥', 'æœˆå«‚', 'è‚²å©´å¸ˆ', 'æŠ¤å·¥'],
    contractTypeIndex: -1,
    isChangeWorkerMode: false,
    originalContract: null
  },

  onLoad() {
    // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
    console.log('åˆ›å»ºåˆåŒé¡µé¢åŠ è½½');
  },

  // ==================== è¾“å…¥äº‹ä»¶å¤„ç† ====================

  // é€šç”¨è¾“å…¥å¤„ç†
  onInput(e) {
    const field = e.currentTarget.dataset.field;
    this.setData({
      [`formData.${field}`]: e.detail.value
    });
  },

  // æœåŠ¡äººå‘˜èº«ä»½è¯è¾“å…¥ï¼ˆè§¦å‘å¿«æ·æœç´¢ï¼‰
  onWorkerIdCardInput(e) {
    const idCard = e.detail.value;

    this.setData({
      'formData.workerIdCard': idCard
    });

    // èº«ä»½è¯å·æ»¡18ä½æ—¶è‡ªåŠ¨æœç´¢
    if (idCard.length === 18) {
      this.searchWorkerAndFill(idCard);
    }
  },

  // å®¢æˆ·æ‰‹æœºå·å¤±ç„¦ï¼ˆè§¦å‘å®¢æˆ·æ£€æŸ¥ï¼‰
  onCustomerPhoneBlur(e) {
    const phone = e.detail.value;

    if (phone.length === 11) {
      this.checkCustomerContract(phone);
    }
  },

  // åˆåŒç±»å‹é€‰æ‹©
  onContractTypeChange(e) {
    const index = e.detail.value;
    this.setData({
      contractTypeIndex: index,
      'formData.contractType': this.data.contractTypes[index]
    });
  },

  // æ—¥æœŸé€‰æ‹©
  onDateChange(e) {
    const field = e.currentTarget.dataset.field;
    this.setData({
      [`formData.${field}`]: e.detail.value
    });
  },

  // ==================== API è°ƒç”¨ ====================

  // å¿«æ·æœç´¢å¹¶è‡ªåŠ¨å¡«å……
  async searchWorkerAndFill(idCard) {
    wx.showLoading({ title: 'æŸ¥è¯¢ä¸­...' });

    try {
      const res = await wx.request({
        url: `${BASE_URL}/contracts/miniprogram/search-worker`,
        method: 'GET',
        data: { idCard }
      });

      if (res.data.success && res.data.data.length > 0) {
        const contract = res.data.data[0]; // å–æœ€æ–°çš„åˆåŒ

        // è‡ªåŠ¨å¡«å……è¡¨å•
        this.setData({
          'formData.customerName': contract.customerName,
          'formData.customerPhone': contract.customerPhone,
          'formData.customerAddress': contract.customerAddress,
          'formData.workerName': contract.workerName,
          'formData.workerPhone': contract.workerPhone,
          'formData.contractType': contract.contractType,
          'formData.servicePrice': contract.servicePrice
        });

        // æ›´æ–°åˆåŒç±»å‹é€‰æ‹©å™¨ç´¢å¼•
        const typeIndex = this.data.contractTypes.indexOf(contract.contractType);
        if (typeIndex !== -1) {
          this.setData({ contractTypeIndex: typeIndex });
        }

        wx.showToast({
          title: 'å·²è‡ªåŠ¨å¡«å……',
          icon: 'success',
          duration: 2000
        });
      } else {
        wx.showToast({
          title: 'æœªæ‰¾åˆ°å†å²åˆåŒ',
          icon: 'none',
          duration: 2000
        });
      }
    } catch (error) {
      console.error('æœç´¢å¤±è´¥:', error);
      wx.showToast({
        title: 'æœç´¢å¤±è´¥ï¼Œè¯·é‡è¯•',
        icon: 'none'
      });
    } finally {
      wx.hideLoading();
    }
  },

  // æ£€æŸ¥å®¢æˆ·ç°æœ‰åˆåŒ
  async checkCustomerContract(phone) {
    wx.showLoading({ title: 'æ£€æŸ¥ä¸­...' });

    try {
      const res = await wx.request({
        url: `${BASE_URL}/contracts/miniprogram/check-customer/${phone}`,
        method: 'GET'
      });

      if (res.data.success) {
        const { hasContract, contract } = res.data.data;

        if (hasContract) {
          // å®¢æˆ·æœ‰åˆåŒï¼Œè¿›å…¥æ¢äººæ¨¡å¼
          this.setData({
            isChangeWorkerMode: true,
            originalContract: contract
          });

          wx.showModal({
            title: 'æ£€æµ‹åˆ°ç°æœ‰åˆåŒ',
            content: `å®¢æˆ· ${contract.customerName} å·²æœ‰åˆåŒï¼ˆ${contract.contractNumber}ï¼‰ï¼Œå°†è‡ªåŠ¨è¿›å…¥æ¢äººæ¨¡å¼`,
            showCancel: false,
            confirmText: 'çŸ¥é“äº†'
          });

          // è‡ªåŠ¨å¡«å……å®¢æˆ·ä¿¡æ¯ï¼ˆä»åŸåˆåŒç»§æ‰¿ï¼‰
          this.setData({
            'formData.customerName': contract.customerName,
            'formData.customerAddress': contract.customerAddress || ''
          });
        } else {
          // å®¢æˆ·æ— åˆåŒï¼Œæ­£å¸¸åˆ›å»º
          this.setData({
            isChangeWorkerMode: false,
            originalContract: null
          });
        }
      }
    } catch (error) {
      console.error('æ£€æŸ¥å®¢æˆ·åˆåŒå¤±è´¥:', error);
      wx.showToast({
        title: 'æ£€æŸ¥å¤±è´¥ï¼Œè¯·é‡è¯•',
        icon: 'none'
      });
    } finally {
      wx.hideLoading();
    }
  },

  // ==================== è¡¨å•æäº¤ ====================

  // æäº¤åˆ›å»ºåˆåŒ
  async submitContract() {
    const { formData, isChangeWorkerMode, originalContract } = this.data;

    // è¡¨å•éªŒè¯
    if (!this.validateForm(formData)) {
      return;
    }

    wx.showLoading({ title: 'åˆ›å»ºä¸­...' });

    try {
      let res;

      if (isChangeWorkerMode && originalContract) {
        // æ¢äººæ¨¡å¼ï¼šè°ƒç”¨æ¢äººæ¥å£
        res = await wx.request({
          url: `${BASE_URL}/contracts/miniprogram/change-worker/${originalContract._id}`,
          method: 'POST',
          header: { 'Content-Type': 'application/json' },
          data: formData
        });
      } else {
        // æ­£å¸¸æ¨¡å¼ï¼šè°ƒç”¨åˆ›å»ºæ¥å£
        res = await wx.request({
          url: `${BASE_URL}/contracts/miniprogram/create`,
          method: 'POST',
          header: { 'Content-Type': 'application/json' },
          data: formData
        });
      }

      if (res.data.success) {
        const contract = res.data.data;

        wx.showToast({
          title: 'åˆ›å»ºæˆåŠŸ',
          icon: 'success',
          duration: 2000
        });

        // å»¶è¿Ÿè·³è½¬åˆ°åˆåŒè¯¦æƒ…é¡µ
        setTimeout(() => {
          wx.redirectTo({
            url: `/pages/contract/detail?id=${contract._id}`
          });
        }, 2000);
      } else {
        wx.showModal({
          title: 'åˆ›å»ºå¤±è´¥',
          content: res.data.message || 'æœªçŸ¥é”™è¯¯',
          showCancel: false
        });
      }
    } catch (error) {
      console.error('åˆ›å»ºåˆåŒå¤±è´¥:', error);
      wx.showModal({
        title: 'é”™è¯¯',
        content: 'ç½‘ç»œè¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œåé‡è¯•',
        showCancel: false
      });
    } finally {
      wx.hideLoading();
    }
  },

  // ==================== è¡¨å•éªŒè¯ ====================

  validateForm(data) {
    // å¿…å¡«å­—æ®µæ£€æŸ¥
    const required = [
      { field: 'customerName', name: 'å®¢æˆ·å§“å' },
      { field: 'customerPhone', name: 'å®¢æˆ·æ‰‹æœºå·' },
      { field: 'customerAddress', name: 'å®¢æˆ·åœ°å€' },
      { field: 'workerName', name: 'æœåŠ¡äººå‘˜å§“å' },
      { field: 'workerIdCard', name: 'æœåŠ¡äººå‘˜èº«ä»½è¯' },
      { field: 'workerPhone', name: 'æœåŠ¡äººå‘˜æ‰‹æœºå·' },
      { field: 'contractType', name: 'åˆåŒç±»å‹' },
      { field: 'servicePrice', name: 'æœåŠ¡ä»·æ ¼' },
      { field: 'startDate', name: 'å¼€å§‹æ—¥æœŸ' },
      { field: 'endDate', name: 'ç»“æŸæ—¥æœŸ' }
    ];

    for (const item of required) {
      if (!data[item.field] || data[item.field].toString().trim() === '') {
        wx.showToast({
          title: `è¯·å¡«å†™${item.name}`,
          icon: 'none',
          duration: 2000
        });
        return false;
      }
    }

    // æ‰‹æœºå·æ ¼å¼éªŒè¯
    const phoneRegex = /^1[3-9]\d{9}$/;
    if (!phoneRegex.test(data.customerPhone)) {
      wx.showToast({
        title: 'å®¢æˆ·æ‰‹æœºå·æ ¼å¼é”™è¯¯',
        icon: 'none'
      });
      return false;
    }

    if (!phoneRegex.test(data.workerPhone)) {
      wx.showToast({
        title: 'æœåŠ¡äººå‘˜æ‰‹æœºå·æ ¼å¼é”™è¯¯',
        icon: 'none'
      });
      return false;
    }

    // èº«ä»½è¯å·æ ¼å¼éªŒè¯
    const idCardRegex = /^\d{17}[\dXx]$/;
    if (!idCardRegex.test(data.workerIdCard)) {
      wx.showToast({
        title: 'èº«ä»½è¯å·æ ¼å¼é”™è¯¯',
        icon: 'none'
      });
      return false;
    }

    // ä»·æ ¼éªŒè¯
    const price = parseFloat(data.servicePrice);
    if (isNaN(price) || price <= 0) {
      wx.showToast({
        title: 'è¯·è¾“å…¥æœ‰æ•ˆçš„æœåŠ¡ä»·æ ¼',
        icon: 'none'
      });
      return false;
    }

    // æ—¥æœŸéªŒè¯
    const startDate = new Date(data.startDate);
    const endDate = new Date(data.endDate);

    if (endDate <= startDate) {
      wx.showToast({
        title: 'ç»“æŸæ—¥æœŸå¿…é¡»æ™šäºå¼€å§‹æ—¥æœŸ',
        icon: 'none'
      });
      return false;
    }

    return true;
  }
});
```

**WXSS (create-contract.wxss)**

```css
.container {
  padding: 20rpx;
  background-color: #f5f5f5;
  min-height: 100vh;
}

.section {
  background-color: #fff;
  border-radius: 16rpx;
  padding: 30rpx;
  margin-bottom: 20rpx;
}

.section-title {
  font-size: 32rpx;
  font-weight: bold;
  color: #333;
  margin-bottom: 30rpx;
  padding-bottom: 20rpx;
  border-bottom: 2rpx solid #e5e5e5;
}

.form-item {
  display: flex;
  align-items: center;
  margin-bottom: 30rpx;
}

.label {
  width: 180rpx;
  font-size: 28rpx;
  color: #666;
  flex-shrink: 0;
}

.input,
.picker {
  flex: 1;
  font-size: 28rpx;
  color: #333;
  padding: 20rpx;
  background-color: #f8f8f8;
  border-radius: 8rpx;
}

.textarea {
  width: 100%;
  min-height: 150rpx;
  font-size: 28rpx;
  color: #333;
  padding: 20rpx;
  background-color: #f8f8f8;
  border-radius: 8rpx;
  box-sizing: border-box;
}

.picker {
  display: flex;
  align-items: center;
  justify-content: space-between;
}

.picker::after {
  content: '>';
  color: #999;
  margin-left: 10rpx;
}

.tip {
  padding: 20rpx;
  border-radius: 8rpx;
  font-size: 26rpx;
  margin-bottom: 20rpx;
}

.tip.warning {
  background-color: #fff3e0;
  color: #f57c00;
  border-left: 4rpx solid #f57c00;
}

.submit-section {
  margin-top: 40rpx;
  padding: 0 30rpx 40rpx;
}

.submit-btn {
  width: 100%;
  height: 88rpx;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: #fff;
  font-size: 32rpx;
  font-weight: bold;
  border-radius: 44rpx;
  border: none;
  box-shadow: 0 8rpx 16rpx rgba(102, 126, 234, 0.3);
}

.submit-btn:active {
  opacity: 0.8;
}
```

---

## â“ å¸¸è§é—®é¢˜

### 1. å¿«æ·æœç´¢æ²¡æœ‰è‡ªåŠ¨å¡«å……ï¼Ÿ

**å¯èƒ½åŸå› **:
- èº«ä»½è¯å·è¾“å…¥é”™è¯¯
- è¯¥æœåŠ¡äººå‘˜æ²¡æœ‰å†å²åˆåŒè®°å½•
- ç½‘ç»œè¯·æ±‚å¤±è´¥

**è§£å†³æ–¹æ³•**:
```javascript
// æ£€æŸ¥æ§åˆ¶å°æ—¥å¿—
console.log('æœç´¢ç»“æœ:', res.data);

// ç¡®ä¿èº«ä»½è¯å·æ˜¯18ä½
if (idCard.length !== 18) {
  wx.showToast({ title: 'è¯·è¾“å…¥å®Œæ•´çš„18ä½èº«ä»½è¯å·', icon: 'none' });
  return;
}
```

### 2. æ¢äººæ¨¡å¼æ²¡æœ‰è§¦å‘ï¼Ÿ

**å¯èƒ½åŸå› **:
- å®¢æˆ·æ‰‹æœºå·è¾“å…¥é”™è¯¯
- å®¢æˆ·ç¡®å®æ²¡æœ‰ç°æœ‰åˆåŒ
- åç«¯æ£€æŸ¥é€»è¾‘æœªæ­£ç¡®æ‰§è¡Œ

**è§£å†³æ–¹æ³•**:
```javascript
// åœ¨ checkCustomerContract ä¸­æ·»åŠ è¯¦ç»†æ—¥å¿—
console.log('æ£€æŸ¥ç»“æœ:', res.data.data);
console.log('hasContract:', res.data.data.hasContract);
console.log('isChangeWorkerMode:', this.data.isChangeWorkerMode);
```

### 3. è¡¨å•éªŒè¯æ€»æ˜¯å¤±è´¥ï¼Ÿ

**æ£€æŸ¥æ¸…å•**:
- âœ… æ‰€æœ‰å¿…å¡«å­—æ®µéƒ½å·²å¡«å†™
- âœ… æ‰‹æœºå·æ˜¯11ä½æ•°å­—
- âœ… èº«ä»½è¯å·æ˜¯18ä½ï¼ˆæœ€åä¸€ä½å¯ä»¥æ˜¯Xï¼‰
- âœ… æœåŠ¡ä»·æ ¼å¤§äº0
- âœ… ç»“æŸæ—¥æœŸæ™šäºå¼€å§‹æ—¥æœŸ

### 4. åˆ›å»ºåˆåŒåæ²¡æœ‰è·³è½¬ï¼Ÿ

**å¯èƒ½åŸå› **:
- åˆåŒåˆ›å»ºæˆåŠŸä½†è¿”å›çš„æ•°æ®æ ¼å¼ä¸å¯¹
- é¡µé¢è·¯å¾„é…ç½®é”™è¯¯

**è§£å†³æ–¹æ³•**:
```javascript
// æ£€æŸ¥è¿”å›çš„åˆåŒå¯¹è±¡
console.log('åˆ›å»ºçš„åˆåŒ:', contract);
console.log('åˆåŒID:', contract._id);

// ç¡®ä¿é¡µé¢è·¯å¾„æ­£ç¡®
wx.redirectTo({
  url: `/pages/contract/detail?id=${contract._id}`
});
```

---

## ğŸ¯ æœ€ä½³å®è·µ

### 1. ç”¨æˆ·ä½“éªŒä¼˜åŒ–

```javascript
// é˜²æŠ–å¤„ç†èº«ä»½è¯è¾“å…¥
let searchTimer = null;

onWorkerIdCardInput(e) {
  const idCard = e.detail.value;
  this.setData({ 'formData.workerIdCard': idCard });

  // æ¸…é™¤ä¹‹å‰çš„å®šæ—¶å™¨
  if (searchTimer) clearTimeout(searchTimer);

  // å»¶è¿Ÿ500msæœç´¢ï¼Œé¿å…é¢‘ç¹è¯·æ±‚
  if (idCard.length === 18) {
    searchTimer = setTimeout(() => {
      this.searchWorkerAndFill(idCard);
    }, 500);
  }
}
```

### 2. é”™è¯¯å¤„ç†å¢å¼º

```javascript
async searchWorkerAndFill(idCard) {
  try {
    const res = await wx.request({
      url: `${BASE_URL}/contracts/miniprogram/search-worker`,
      method: 'GET',
      data: { idCard },
      timeout: 10000 // è®¾ç½®10ç§’è¶…æ—¶
    });

    // ... å¤„ç†é€»è¾‘
  } catch (error) {
    // åŒºåˆ†ä¸åŒçš„é”™è¯¯ç±»å‹
    if (error.errMsg.includes('timeout')) {
      wx.showToast({ title: 'è¯·æ±‚è¶…æ—¶ï¼Œè¯·é‡è¯•', icon: 'none' });
    } else if (error.errMsg.includes('fail')) {
      wx.showToast({ title: 'ç½‘ç»œè¿æ¥å¤±è´¥', icon: 'none' });
    } else {
      wx.showToast({ title: 'æœç´¢å¤±è´¥', icon: 'none' });
    }
  }
}
```

### 3. æ•°æ®æŒä¹…åŒ–

```javascript
// ä¿å­˜è‰ç¨¿
saveDraft() {
  wx.setStorageSync('contract_draft', this.data.formData);
  wx.showToast({ title: 'å·²ä¿å­˜è‰ç¨¿', icon: 'success' });
},

// åŠ è½½è‰ç¨¿
onLoad() {
  const draft = wx.getStorageSync('contract_draft');
  if (draft) {
    wx.showModal({
      title: 'å‘ç°è‰ç¨¿',
      content: 'æ˜¯å¦æ¢å¤ä¸Šæ¬¡æœªå®Œæˆçš„åˆåŒï¼Ÿ',
      success: (res) => {
        if (res.confirm) {
          this.setData({ formData: draft });
        }
      }
    });
  }
}
```

---

## ğŸ“ æŠ€æœ¯æ”¯æŒ

å¦‚æœ‰é—®é¢˜ï¼Œè¯·è”ç³»æŠ€æœ¯å›¢é˜Ÿæˆ–æŸ¥çœ‹å®Œæ•´APIæ–‡æ¡£ï¼š
- ğŸ“„ [å°ç¨‹åºAPIå®Œæ•´æ–‡æ¡£](./å°ç¨‹åºAPIå®Œæ•´æ–‡æ¡£.md)
- ğŸ”— API Base URL: `https://your-domain.com/api`
- ğŸ“§ æŠ€æœ¯æ”¯æŒ: tech@example.com


