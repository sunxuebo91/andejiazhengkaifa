# 大树保换人接口问题修复说明

## 问题描述

在使用大树保批改接口（换人功能）时，出现"保单号不存在"的错误：

```javascript
换人请求数据: {policyNo: '14527006800216447774', oldInsured: {…}, newInsured: {…}}
换人接口响应: {Success: 'false', OrderId: '0', Message: '保单号不存在!'}
```

## 问题原因

根据大树保API接口文档（第859-879行），批改接口的XML格式要求如下：

1. **使用 `PolicyRef` 而不是 `PolicyNo`**
2. **被保人信息需要 `type` 属性**来区分原被保人（old）和新被保人（new）
3. **需要包含 `Policy` 标签**包裹保单号
4. **原被保人和新被保人都需要完整信息**（包括 BirthDate 和 Gender）

### 原来的错误实现

```xml
<Body>
  <PolicyNo>14527006800216447774</PolicyNo>
  <OldInsured>
    <InsuredName>张三</InsuredName>
    <IdType>1</IdType>
    <IdNumber>110101199001011234</IdNumber>
  </OldInsured>
  <NewInsured>
    <InsuredName>李四</InsuredName>
    <IdType>1</IdType>
    <IdNumber>110101199002021234</IdNumber>
    <BirthDate>19900202000000</BirthDate>
    <Gender>M</Gender>
  </NewInsured>
</Body>
```

### 正确的实现

```xml
<Body>
  <Policy>
    <PolicyRef>14527006800216447774</PolicyRef>
  </Policy>
  <Insured type="old">
    <InsuredName>张三</InsuredName>
    <IdType>1</IdType>
    <IdNumber>110101199001011234</IdNumber>
    <BirthDate>19900101000000</BirthDate>
    <Gender>M</Gender>
  </Insured>
  <Insured type="new">
    <InsuredName>李四</InsuredName>
    <IdType>1</IdType>
    <IdNumber>110101199002021234</IdNumber>
    <BirthDate>19900202000000</BirthDate>
    <Gender>M</Gender>
  </Insured>
</Body>
```

## 修复内容

### 1. 后端修复 (`backend/src/modules/dashubao/dashubao.service.ts`)

修改了 `amendPolicy` 方法，使其符合大树保API文档要求：

- 使用 `<Policy><PolicyRef>` 替代 `<PolicyNo>`
- 使用 `<Insured type="old">` 和 `<Insured type="new">` 替代 `<OldInsured>` 和 `<NewInsured>`
- 确保原被保人和新被保人都包含完整的必填字段（BirthDate、Gender）
- 添加详细的日志记录，方便调试

### 2. 前端已正确实现

前端代码已经正确处理了所有必需字段：
- 从身份证号自动提取出生日期和性别
- 如果无法提取，则从保单的被保险人列表中获取
- 确保所有必填字段都有值

## 可能的其他原因

如果修复后仍然提示"保单号不存在"，可能是以下原因：

### 1. 保单号确实不存在
- 检查保单号是否正确
- 确认保单是否已在大树保系统中创建成功

### 2. 保单状态不允许批改
- 保单已注销（CANCELLED）
- 保单已退保（SURRENDERED）
- 保单未生效（PENDING）
- 保单已过期

### 3. 保单类型不支持批改
- 某些特殊产品可能不支持批改功能
- 需要联系大树保确认该产品是否支持换人

### 4. 环境配置问题
- 确认使用的是正确的环境（测试环境 vs 生产环境）
- 测试环境：http://fx.test.dasurebao.com.cn/remoting/ws
- 生产环境：https://api.dasurebao.com.cn/remoting/ws

## 测试建议

1. **先查询保单状态**
   ```javascript
   // 使用保单查询接口确认保单存在且状态正常
   await insuranceService.queryPolicy({ agencyPolicyRef: 'xxx' });
   ```

2. **检查保单详情**
   ```javascript
   // 查看保单的完整信息，包括状态、被保险人列表等
   const policy = await insuranceService.getPolicyByPolicyNo('14527006800216447774');
   console.log('保单状态:', policy.status);
   console.log('被保险人:', policy.insuredList);
   ```

3. **查看后端日志**
   ```bash
   pm2 logs backend-prod --lines 50
   ```
   日志中会显示完整的XML请求和响应，方便排查问题。

## 部署说明

修复已部署到生产环境：
- 后端已重新构建并重启
- 前端无需修改（已正确实现）

## 联系支持

如果问题仍然存在，请联系大树保技术支持，提供以下信息：
- 保单号
- 完整的XML请求（从后端日志获取）
- 错误响应
- 保单创建时间和状态

