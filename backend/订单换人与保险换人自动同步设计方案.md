# è®¢å•æ¢äººä¸ä¿é™©æ¢äººè‡ªåŠ¨åŒæ­¥ - æŠ€æœ¯è®¾è®¡æ–¹æ¡ˆ

## ğŸ“‹ ä¸šåŠ¡åœºæ™¯

**ç›®æ ‡**ï¼šå½“åˆåŒæ¢äººæˆåŠŸå¹¶ä¸”åŒæ–¹å®Œæˆç­¾çº¦ï¼ˆåˆåŒçŠ¶æ€å˜ä¸º"å·²ç­¾çº¦"ï¼‰åï¼Œç³»ç»Ÿè‡ªåŠ¨è§¦å‘ä¿é™©æ¢äººæ“ä½œã€‚

**ç¤ºä¾‹åœºæ™¯**ï¼š
- å¼ ä¸‰çš„åˆåŒï¼ŒåŸæœåŠ¡äººå‘˜æ˜¯æå››
- ç°åœ¨æ¢æˆç‹äºŒï¼Œå¼ ä¸‰å’Œç‹äºŒéƒ½ç­¾ç½²å®ŒåˆåŒ
- åˆåŒçŠ¶æ€å˜æˆ"å·²ç­¾çº¦"ï¼ˆactiveï¼‰
- ç³»ç»Ÿè‡ªåŠ¨æ‰§è¡Œä¿é™©æ¢äººï¼ŒæŠŠæå››çš„ä¿é™©æ¢æˆç‹äºŒ

## ğŸ¯ æ ¸å¿ƒè®¾è®¡æ€è·¯

### 1. æ•°æ®å…³è”è®¾è®¡

#### 1.1 åœ¨ InsurancePolicy æ¨¡å‹ä¸­æ·»åŠ åˆåŒå…³è”å­—æ®µ

```typescript
// backend/src/modules/dashubao/models/insurance-policy.model.ts

@ApiProperty({ description: 'å…³è”çš„åˆåŒID' })
@Prop({ type: Types.ObjectId, ref: 'Contract', index: true })
contractId?: Types.ObjectId;
```

#### 1.2 åœ¨ Contract æ¨¡å‹ä¸­æ·»åŠ ä¿é™©åŒæ­¥çŠ¶æ€å­—æ®µ

```typescript
// backend/src/modules/contracts/models/contract.model.ts

@Prop({ default: false })
insuranceSyncPending?: boolean; // æ˜¯å¦æœ‰å¾…åŒæ­¥çš„ä¿é™©æ¢äºº

@Prop()
insuranceSyncStatus?: string; // ä¿é™©åŒæ­¥çŠ¶æ€: pending, success, failed

@Prop()
insuranceSyncError?: string; // ä¿é™©åŒæ­¥å¤±è´¥åŸå› 

@Prop()
insuranceSyncedAt?: Date; // ä¿é™©åŒæ­¥å®Œæˆæ—¶é—´
```

### 2. åˆ›å»ºä¿é™©åŒæ­¥æ—¥å¿—æ¨¡å‹

```typescript
// backend/src/modules/dashubao/models/insurance-sync-log.model.ts

@Schema({ timestamps: true })
export class InsuranceSyncLog {
  @Prop({ type: Types.ObjectId, ref: 'Contract', required: true })
  contractId: Types.ObjectId;
  
  @Prop({ type: Types.ObjectId, ref: 'InsurancePolicy', required: true })
  policyId: Types.ObjectId;
  
  @Prop({ required: true })
  oldWorkerName: string;
  
  @Prop({ required: true })
  oldWorkerIdCard: string;
  
  @Prop({ required: true })
  newWorkerName: string;
  
  @Prop({ required: true })
  newWorkerIdCard: string;
  
  @Prop({ enum: ['pending', 'success', 'failed'], default: 'pending' })
  status: string;
  
  @Prop()
  errorMessage?: string;
  
  @Prop({ type: Object })
  dashubaoResponse?: Record<string, any>;
  
  @Prop()
  syncedAt?: Date;
}
```

## ğŸ”§ æ ¸å¿ƒåŠŸèƒ½å®ç°

### 3. åˆåŒæœåŠ¡ä¸­æ·»åŠ ä¿é™©åŒæ­¥æ–¹æ³•

```typescript
// backend/src/modules/contracts/contracts.service.ts

/**
 * å½“åˆåŒçŠ¶æ€å˜ä¸º active æ—¶ï¼Œè‡ªåŠ¨è§¦å‘ä¿é™©æ¢äºº
 */
async syncInsuranceOnContractActive(contractId: string): Promise<void> {
  const contract = await this.contractModel.findById(contractId).exec();
  
  if (!contract) {
    throw new NotFoundException('åˆåŒä¸å­˜åœ¨');
  }
  
  // åªå¤„ç†æ¢äººåˆåŒ
  if (!contract.replacesContractId) {
    this.logger.log('éæ¢äººåˆåŒï¼Œè·³è¿‡ä¿é™©åŒæ­¥');
    return;
  }
  
  // æŸ¥æ‰¾åŸåˆåŒå…³è”çš„ä¿é™©
  const originalContract = await this.contractModel.findById(contract.replacesContractId).exec();
  if (!originalContract) {
    this.logger.warn('åŸåˆåŒä¸å­˜åœ¨ï¼Œæ— æ³•åŒæ­¥ä¿é™©');
    return;
  }
  
  // é€šè¿‡åŸåˆåŒçš„ workerId æŸ¥æ‰¾ä¿é™©
  const policies = await this.insurancePolicyModel.find({
    resumeId: originalContract.workerId,
    status: 'active'
  }).exec();
  
  if (policies.length === 0) {
    this.logger.log('æœªæ‰¾åˆ°éœ€è¦åŒæ­¥çš„ä¿é™©');
    return;
  }
  
  // æ ‡è®°åˆåŒä¸ºå¾…åŒæ­¥çŠ¶æ€
  await this.contractModel.findByIdAndUpdate(contractId, {
    insuranceSyncPending: true,
    insuranceSyncStatus: 'pending'
  });
  
  // è°ƒç”¨ä¿é™©æ¢äººæœåŠ¡
  await this.dashubaoService.syncInsuranceAmendment({
    contractId: contract._id,
    policyIds: policies.map(p => p._id),
    oldWorker: {
      name: originalContract.workerName,
      idCard: originalContract.workerIdCard
    },
    newWorker: {
      name: contract.workerName,
      idCard: contract.workerIdCard,
      phone: contract.workerPhone
    }
  });
}
```

### 4. å¤§æ ‘ä¿æœåŠ¡ä¸­æ·»åŠ æ‰¹é‡åŒæ­¥æ–¹æ³•

```typescript
// backend/src/modules/dashubao/dashubao.service.ts

async syncInsuranceAmendment(params: {
  contractId: Types.ObjectId;
  policyIds: Types.ObjectId[];
  oldWorker: { name: string; idCard: string };
  newWorker: { name: string; idCard: string; phone: string };
}): Promise<void> {
  
  for (const policyId of params.policyIds) {
    const policy = await this.policyModel.findById(policyId).exec();
    
    if (!policy || !policy.policyNo) {
      this.logger.warn(`ä¿å• ${policyId} ä¸å­˜åœ¨æˆ–æ— ä¿å•å·`);
      continue;
    }
    
    // åˆ›å»ºåŒæ­¥æ—¥å¿—
    const syncLog = new this.insuranceSyncLogModel({
      contractId: params.contractId,
      policyId: policy._id,
      oldWorkerName: params.oldWorker.name,
      oldWorkerIdCard: params.oldWorker.idCard,
      newWorkerName: params.newWorker.name,
      newWorkerIdCard: params.newWorker.idCard,
      status: 'pending'
    });
    
    try {
      // è°ƒç”¨å¤§æ ‘ä¿æ¢äººAPI
      const response = await this.amendPolicy({
        policyNo: policy.policyNo,
        oldInsured: {
          insuredName: params.oldWorker.name,
          idType: '1',
          idNumber: params.oldWorker.idCard
        },
        newInsured: {
          insuredName: params.newWorker.name,
          idType: '1',
          idNumber: params.newWorker.idCard,
          birthDate: this.extractBirthDateFromIdCard(params.newWorker.idCard),
          gender: this.extractGenderFromIdCard(params.newWorker.idCard),
          mobile: params.newWorker.phone
        }
      });
      
      // æ›´æ–°åŒæ­¥æ—¥å¿—
      syncLog.status = response.Success === 'true' ? 'success' : 'failed';
      syncLog.errorMessage = response.Success !== 'true' ? response.Message : undefined;
      syncLog.dashubaoResponse = response;
      syncLog.syncedAt = new Date();
      
    } catch (error) {
      syncLog.status = 'failed';
      syncLog.errorMessage = error.message;
    }
    
    await syncLog.save();
  }
  
  // æ›´æ–°åˆåŒåŒæ­¥çŠ¶æ€
  await this.contractModel.findByIdAndUpdate(params.contractId, {
    insuranceSyncPending: false,
    insuranceSyncStatus: 'success',
    insuranceSyncedAt: new Date()
  });
}
```

## ğŸ“¡ è§¦å‘æœºåˆ¶è®¾è®¡

### 5. çˆ±ç­¾å›è°ƒä¸­è§¦å‘ä¿é™©åŒæ­¥

```typescript
// backend/src/modules/esign/esign.service.ts

async handleSignFlowCallback(callbackData: any): Promise<void> {
  // ... ç°æœ‰çš„å›è°ƒå¤„ç†é€»è¾‘ ...

  // å½“åˆåŒç­¾ç½²å®Œæˆæ—¶
  if (callbackData.status === 2) { // 2 = å·²å®Œæˆ
    const contract = await this.contractModel.findOne({
      esignContractNo: callbackData.contractNo
    }).exec();

    if (contract) {
      // æ›´æ–°åˆåŒçŠ¶æ€ä¸º active
      await this.contractModel.findByIdAndUpdate(contract._id, {
        contractStatus: ContractStatus.ACTIVE,
        esignSignedAt: new Date()
      });

      // ğŸ†• è§¦å‘ä¿é™©åŒæ­¥æ£€æŸ¥
      await this.contractsService.syncInsuranceOnContractActive(contract._id.toString());
    }
  }
}
```

### 6. æ‰‹åŠ¨è§¦å‘æ¥å£ï¼ˆå¤‡ç”¨æ–¹æ¡ˆï¼‰

```typescript
// backend/src/modules/contracts/contracts.controller.ts

@Post(':id/sync-insurance')
@UseGuards(JwtAuthGuard)
async syncInsurance(@Param('id') contractId: string) {
  try {
    await this.contractsService.syncInsuranceOnContractActive(contractId);
    return {
      success: true,
      message: 'ä¿é™©åŒæ­¥å·²è§¦å‘'
    };
  } catch (error) {
    return {
      success: false,
      message: error.message
    };
  }
}
```

## ğŸ¨ å‰ç«¯ç•Œé¢è®¾è®¡

### 7. åˆåŒè¯¦æƒ…é¡µæ˜¾ç¤ºä¿é™©åŒæ­¥çŠ¶æ€

```typescript
// frontend/src/pages/contracts/ContractDetail.tsx

// åœ¨åˆåŒè¯¦æƒ…å¡ç‰‡ä¸­æ·»åŠ ä¿é™©åŒæ­¥çŠ¶æ€æ˜¾ç¤º
{contract.replacesContractId && (
  <Card title="ä¿é™©åŒæ­¥çŠ¶æ€" style={{ marginTop: 16 }}>
    <Descriptions column={1}>
      <Descriptions.Item label="åŒæ­¥çŠ¶æ€">
        {contract.insuranceSyncStatus === 'success' && (
          <Tag color="success">å·²åŒæ­¥</Tag>
        )}
        {contract.insuranceSyncStatus === 'pending' && (
          <Tag color="processing">åŒæ­¥ä¸­</Tag>
        )}
        {contract.insuranceSyncStatus === 'failed' && (
          <Tag color="error">åŒæ­¥å¤±è´¥</Tag>
        )}
        {!contract.insuranceSyncStatus && (
          <Tag color="default">æœªåŒæ­¥</Tag>
        )}
      </Descriptions.Item>

      {contract.insuranceSyncError && (
        <Descriptions.Item label="å¤±è´¥åŸå› ">
          <Text type="danger">{contract.insuranceSyncError}</Text>
        </Descriptions.Item>
      )}

      {contract.insuranceSyncedAt && (
        <Descriptions.Item label="åŒæ­¥æ—¶é—´">
          {dayjs(contract.insuranceSyncedAt).format('YYYY-MM-DD HH:mm:ss')}
        </Descriptions.Item>
      )}
    </Descriptions>

    {contract.insuranceSyncStatus === 'failed' && (
      <Button
        type="primary"
        onClick={() => handleRetrySync(contract._id)}
        style={{ marginTop: 16 }}
      >
        é‡æ–°åŒæ­¥
      </Button>
    )}
  </Card>
)}
```

## ğŸ” è¾…åŠ©åŠŸèƒ½

### 8. ä»èº«ä»½è¯å·æå–ä¿¡æ¯çš„å·¥å…·æ–¹æ³•

```typescript
// backend/src/modules/dashubao/dashubao.service.ts

/**
 * ä»èº«ä»½è¯å·æå–å‡ºç”Ÿæ—¥æœŸ
 */
private extractBirthDateFromIdCard(idCard: string): string {
  if (idCard.length === 18) {
    const year = idCard.substring(6, 10);
    const month = idCard.substring(10, 12);
    const day = idCard.substring(12, 14);
    return `${year}${month}${day}000000`;
  } else if (idCard.length === 15) {
    const year = '19' + idCard.substring(6, 8);
    const month = idCard.substring(8, 10);
    const day = idCard.substring(10, 12);
    return `${year}${month}${day}000000`;
  }
  throw new BadRequestException('èº«ä»½è¯å·æ ¼å¼ä¸æ­£ç¡®');
}

/**
 * ä»èº«ä»½è¯å·æå–æ€§åˆ«
 */
private extractGenderFromIdCard(idCard: string): string {
  let genderCode: number;
  if (idCard.length === 18) {
    genderCode = parseInt(idCard.charAt(16));
  } else if (idCard.length === 15) {
    genderCode = parseInt(idCard.charAt(14));
  } else {
    throw new BadRequestException('èº«ä»½è¯å·æ ¼å¼ä¸æ­£ç¡®');
  }
  return genderCode % 2 === 0 ? 'F' : 'M';
}
```

## ğŸ“Š æ•°æ®åº“è¿ç§»è„šæœ¬

### 9. æ·»åŠ æ–°å­—æ®µçš„è¿ç§»è„šæœ¬

```javascript
// backend/migrations/add-insurance-sync-fields.js

const mongoose = require('mongoose');

async function migrate() {
  const db = mongoose.connection;

  // ä¸ºç°æœ‰åˆåŒæ·»åŠ ä¿é™©åŒæ­¥å­—æ®µ
  await db.collection('contracts').updateMany(
    {},
    {
      $set: {
        insuranceSyncPending: false,
        insuranceSyncStatus: null,
        insuranceSyncError: null,
        insuranceSyncedAt: null
      }
    }
  );

  // ä¸ºç°æœ‰ä¿å•æ·»åŠ åˆåŒå…³è”å­—æ®µ
  await db.collection('insurance_policies').updateMany(
    {},
    {
      $set: {
        contractId: null
      }
    }
  );

  console.log('âœ… è¿ç§»å®Œæˆ');
}

module.exports = { migrate };
```

## ğŸš€ å®æ–½æ­¥éª¤

### ç¬¬ä¸€é˜¶æ®µï¼šæ•°æ®æ¨¡å‹å‡†å¤‡
1. âœ… æ›´æ–° InsurancePolicy æ¨¡å‹ï¼Œæ·»åŠ  contractId å­—æ®µ
2. âœ… æ›´æ–° Contract æ¨¡å‹ï¼Œæ·»åŠ ä¿é™©åŒæ­¥çŠ¶æ€å­—æ®µ
3. âœ… åˆ›å»º InsuranceSyncLog æ¨¡å‹
4. âœ… è¿è¡Œæ•°æ®åº“è¿ç§»è„šæœ¬

### ç¬¬äºŒé˜¶æ®µï¼šåç«¯æœåŠ¡å®ç°
5. âœ… åœ¨ DashubaoService ä¸­å®ç° syncInsuranceAmendment æ–¹æ³•
6. âœ… åœ¨ ContractsService ä¸­å®ç° syncInsuranceOnContractActive æ–¹æ³•
7. âœ… æ·»åŠ èº«ä»½è¯ä¿¡æ¯æå–å·¥å…·æ–¹æ³•
8. âœ… åœ¨çˆ±ç­¾å›è°ƒä¸­æ·»åŠ è§¦å‘é€»è¾‘
9. âœ… æ·»åŠ æ‰‹åŠ¨è§¦å‘æ¥å£

### ç¬¬ä¸‰é˜¶æ®µï¼šå‰ç«¯ç•Œé¢å¼€å‘
10. âœ… åœ¨åˆåŒè¯¦æƒ…é¡µæ·»åŠ ä¿é™©åŒæ­¥çŠ¶æ€æ˜¾ç¤º
11. âœ… æ·»åŠ æ‰‹åŠ¨é‡è¯•åŒæ­¥æŒ‰é’®
12. âœ… æ·»åŠ åŒæ­¥æ—¥å¿—æŸ¥çœ‹åŠŸèƒ½

### ç¬¬å››é˜¶æ®µï¼šæµ‹è¯•ä¸ä¼˜åŒ–
13. âœ… å•å…ƒæµ‹è¯•ï¼šæµ‹è¯•æ•°æ®æå–æ–¹æ³•
14. âœ… é›†æˆæµ‹è¯•ï¼šæµ‹è¯•å®Œæ•´çš„æ¢äºº+ä¿é™©åŒæ­¥æµç¨‹
15. âœ… é”™è¯¯åœºæ™¯æµ‹è¯•ï¼šä¿å•ä¸å­˜åœ¨ã€APIå¤±è´¥ç­‰
16. âœ… æ€§èƒ½ä¼˜åŒ–ï¼šæ‰¹é‡å¤„ç†ã€å¼‚æ­¥é˜Ÿåˆ—

## âš ï¸ æ³¨æ„äº‹é¡¹

### é”™è¯¯å¤„ç†ç­–ç•¥
- **ä¿å•ä¸å­˜åœ¨**ï¼šè®°å½•æ—¥å¿—ï¼Œä¸é˜»å¡åˆåŒæµç¨‹
- **APIè°ƒç”¨å¤±è´¥**ï¼šè®°å½•å¤±è´¥åŸå› ï¼Œæä¾›æ‰‹åŠ¨é‡è¯•
- **éƒ¨åˆ†æˆåŠŸ**ï¼šä¸€ä¸ªå®¢æˆ·å¯èƒ½æœ‰å¤šä¸ªä¿å•ï¼Œéƒ¨åˆ†æˆåŠŸä¹Ÿè¦è®°å½•

### æ•°æ®ä¸€è‡´æ€§
- ä¿é™©åŒæ­¥å¤±è´¥ä¸åº”å½±å“åˆåŒçŠ¶æ€
- æä¾›æ‰‹åŠ¨åŒæ­¥æ¥å£ä½œä¸ºå…œåº•æ–¹æ¡ˆ
- è®°å½•è¯¦ç»†çš„åŒæ­¥æ—¥å¿—ä¾¿äºæ’æŸ¥é—®é¢˜

### æ€§èƒ½è€ƒè™‘
- ä½¿ç”¨å¼‚æ­¥å¤„ç†ï¼Œä¸é˜»å¡åˆåŒç­¾çº¦æµç¨‹
- è€ƒè™‘ä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆå¦‚ Bullï¼‰å¤„ç†å¤§é‡åŒæ­¥ä»»åŠ¡
- æ·»åŠ é‡è¯•æœºåˆ¶å’Œå¤±è´¥å‘Šè­¦

## ğŸ“ˆ åç»­ä¼˜åŒ–æ–¹å‘

1. **æ¶ˆæ¯é˜Ÿåˆ—é›†æˆ**ï¼šä½¿ç”¨ Bull æˆ– RabbitMQ å¤„ç†å¼‚æ­¥ä»»åŠ¡
2. **é€šçŸ¥æœºåˆ¶**ï¼šåŒæ­¥æˆåŠŸ/å¤±è´¥åå‘é€é€šçŸ¥ç»™ç›¸å…³äººå‘˜
3. **æ‰¹é‡æ“ä½œ**ï¼šæ”¯æŒæ‰¹é‡é‡è¯•å¤±è´¥çš„åŒæ­¥ä»»åŠ¡
4. **ç›‘æ§å‘Šè­¦**ï¼šåŒæ­¥å¤±è´¥ç‡è¶…è¿‡é˜ˆå€¼æ—¶å‘é€å‘Šè­¦
5. **æ•°æ®æŠ¥è¡¨**ï¼šç»Ÿè®¡ä¿é™©åŒæ­¥æˆåŠŸç‡ã€å¤±è´¥åŸå› åˆ†å¸ƒç­‰


