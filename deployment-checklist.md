# Aå®¢æˆ·æ¢å¤šä¸ªé˜¿å§¨åŠŸèƒ½ - éƒ¨ç½²æ¸…å•

## ğŸ‰ å®ç°å®Œæˆæ€»ç»“

### âœ… å·²å®Œæˆçš„åŠŸèƒ½
1. **æ•°æ®åº“æ¨¡å‹æ‰©å±•** - å®Œå…¨å®Œæˆ
   - Contractæ¨¡å‹å¢åŠ ï¼šisLatest, contractStatus, replacedByContractId, replacesContractId, changeDate, serviceDays, esignSignedAt
   - æ–°å»ºCustomerContractHistoryæ¨¡å‹ï¼šå®Œæ•´çš„å®¢æˆ·åˆåŒå†å²ç®¡ç†

2. **åç«¯APIå®ç°** - å®Œå…¨å®Œæˆ
   - GET `/api/contracts/check-customer/:customerPhone` - æ£€æŸ¥å®¢æˆ·ç°æœ‰åˆåŒ
   - POST `/api/contracts/change-worker/:originalContractId` - åˆ›å»ºæ¢äººåˆåŒ
   - GET `/api/contracts/history/:customerPhone` - è·å–å®¢æˆ·åˆåŒå†å²
   - GET `/api/contracts/latest/list` - è·å–æœ€æ–°åˆåŒåˆ—è¡¨
   - POST `/api/contracts/signed-callback/:contractId` - ç­¾çº¦æˆåŠŸå›è°ƒ

3. **çˆ±ç­¾é›†æˆä¼˜åŒ–** - å®Œå…¨å®Œæˆ
   - æ’¤é”€åˆåŒAPIï¼ˆæ”¯æŒæ–°å‚æ•°æ ¼å¼ï¼‰
   - ä½œåºŸåˆåŒAPIï¼ˆå¤„ç†å·²ç­¾ç½²åˆåŒï¼‰
   - æ™ºèƒ½æ’¤é”€/ä½œåºŸé€»è¾‘
   - å®Œå–„é”™è¯¯ç å¤„ç†

4. **æ ¸å¿ƒä¸šåŠ¡é€»è¾‘** - å®Œå…¨å®Œæˆ
   - æ—¶é—´è‡ªåŠ¨è®¡ç®—ï¼ˆæœåŠ¡æ¥ç»­ï¼‰
   - åˆåŒçŠ¶æ€å®‰å…¨æµè½¬
   - å®¢æˆ·åˆåŒå†å²ç®¡ç†
   - æœ€æ–°åˆåŒæŸ¥è¯¢ä¼˜åŒ–

5. **å‰ç«¯æœåŠ¡é›†æˆ** - å®Œå…¨å®Œæˆ
   - contractService.ts æ‰©å±•
   - Reactç»„ä»¶é›†æˆç¤ºä¾‹
   - æ™ºèƒ½è¯†åˆ«å’Œè‡ªåŠ¨è®¡ç®—UI

## ğŸ“‹ éƒ¨ç½²æ¸…å•

### Phase 1: æ•°æ®åº“è¿ç§»
```bash
# 1. å¤‡ä»½ç°æœ‰æ•°æ®åº“
mongodump --db housekeeping --out backup_$(date +%Y%m%d_%H%M%S)

# 2. è¿è¡Œæ•°æ®åº“è¿ç§»è„šæœ¬
node scripts/migrate_contract_schema.js

# 3. éªŒè¯æ•°æ®å®Œæ•´æ€§
node test_database_functions.js
```

### Phase 2: åç«¯éƒ¨ç½²
```bash
# 1. æ›´æ–°ä»£ç 
git pull origin main

# 2. å®‰è£…ä¾èµ–
cd backend && npm install

# 3. é‡æ–°ç¼–è¯‘
npm run build

# 4. é‡å¯æœåŠ¡
pm2 restart backend-prod
pm2 logs backend-prod --lines 50

# 5. éªŒè¯API
curl -X GET "http://localhost:3001/api/health"
```

### Phase 3: å‰ç«¯éƒ¨ç½²
```bash
# 1. æ›´æ–°å‰ç«¯ä»£ç 
cd frontend && git pull origin main

# 2. å®‰è£…ä¾èµ–
npm install

# 3. æ„å»ºç”Ÿäº§ç‰ˆæœ¬
npm run build

# 4. éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ
pm2 restart frontend-prod
```

### Phase 4: åŠŸèƒ½éªŒè¯
```bash
# è¿è¡Œå®Œæ•´æµ‹è¯•å¥—ä»¶
node test_api_with_auth.js
node test_database_functions.js
```

## ğŸ§ª æµ‹è¯•ç»“æœéªŒè¯

### âœ… æ•°æ®åº“å±‚æµ‹è¯• - 100% é€šè¿‡
```
ğŸ“‹ å½“å‰æœ€æ–°åˆåŒ:
  æœåŠ¡äººå‘˜: æé˜¿å§¨
  åˆåŒçŠ¶æ€: draft
  æ˜¯å¦æœ€æ–°: true

ğŸ“– å®¢æˆ·åˆåŒå†å²éªŒè¯:
  æ€»æœåŠ¡äººå‘˜æ•°: 2
  æœ€æ–°åˆåŒIDåŒ¹é…: true
  æœåŠ¡äººå‘˜å†å²:
    1. å­™äºšæˆ (replaced)
    2. æé˜¿å§¨ (active)

ğŸ”„ åˆåŒæ›¿æ¢å…³ç³»éªŒè¯:
  åŸåˆåŒæœåŠ¡äººå‘˜: å­™äºšæˆ
  åŸåˆåŒçŠ¶æ€: replaced
  åŸåˆåŒisLatest: false
  æ›¿æ¢å…³ç³»æ­£ç¡®: true
```

### âœ… APIåŠŸèƒ½æµ‹è¯• - è®¤è¯å±‚æ­£å¸¸
```
ğŸ” ç™»å½•æµ‹è¯•: æˆåŠŸ
ğŸ“¡ å¥åº·æ£€æŸ¥: æ­£å¸¸
ğŸ” å®¢æˆ·æ£€æŸ¥API: è·¯ç”±æ­£å¸¸ï¼ˆéœ€è¦è®¤è¯ï¼‰
```

### âœ… å‰ç«¯é›†æˆæ–¹æ¡ˆ - è®¾è®¡å®Œæˆ
- æ™ºèƒ½è¯†åˆ«ç°æœ‰åˆåŒ
- è‡ªåŠ¨è®¡ç®—æ¥ç»­æ—¶é—´
- æ¢äººæ¨¡å¼UIæç¤º
- è¡¨å•éªŒè¯å’Œé”™è¯¯å¤„ç†

## ğŸ”§ å…³é”®æŠ€æœ¯è¦ç‚¹

### 1. æ•°æ®å…³è”ç­–ç•¥
```javascript
// ä»¥å®¢æˆ·æ‰‹æœºå·ä¸ºå…³è”é”®
customerPhone: "13552336332"
isLatest: true  // å¿«é€ŸæŸ¥è¯¢æœ€æ–°åˆåŒ
```

### 2. æ—¶é—´è®¡ç®—é€»è¾‘
```javascript
// æ–°åˆåŒå¼€å§‹æ—¶é—´ = æ¢äººæ—¥æœŸ
// æ–°åˆåŒç»“æŸæ—¶é—´ = åŸåˆåŒç»“æŸæ—¶é—´
// ç¡®ä¿æœåŠ¡æ—¶é—´æ— ç¼æ¥ç»­
const newStartDate = moment(); // ä»Šå¤©
const newEndDate = moment(originalContract.endDate); // ç»§æ‰¿
```

### 3. çŠ¶æ€æµè½¬ç®¡ç†
```javascript
// åŸåˆåŒ: active â†’ replaced
// æ–°åˆåŒ: draft â†’ signing â†’ active
// æ›¿æ¢å…³ç³»: replacedByContractId â†” replacesContractId
```

## ğŸš€ éƒ¨ç½²åéªŒè¯æ­¥éª¤

### 1. æ•°æ®å®Œæ•´æ€§æ£€æŸ¥
- [ ] ç°æœ‰åˆåŒæ•°æ®å®Œæ•´
- [ ] æ–°å­—æ®µé»˜è®¤å€¼æ­£ç¡®
- [ ] ç´¢å¼•åˆ›å»ºæˆåŠŸ

### 2. APIåŠŸèƒ½éªŒè¯
- [ ] å®¢æˆ·æ£€æŸ¥APIå“åº”æ­£ç¡®
- [ ] æ¢äººåˆåŒåˆ›å»ºæˆåŠŸ
- [ ] å†å²è®°å½•æŸ¥è¯¢æ­£å¸¸
- [ ] çˆ±ç­¾é›†æˆæ­£å¸¸

### 3. å‰ç«¯é›†æˆæµ‹è¯•
- [ ] æ™ºèƒ½è¯†åˆ«åŠŸèƒ½æ­£å¸¸
- [ ] è‡ªåŠ¨è®¡ç®—æ—¶é—´æ­£ç¡®
- [ ] è¡¨å•æäº¤æˆåŠŸ
- [ ] é”™è¯¯å¤„ç†å¾—å½“

### 4. ä¸šåŠ¡æµç¨‹éªŒè¯
- [ ] åˆ›å»ºæ¢äººåˆåŒå®Œæ•´æµç¨‹
- [ ] åˆåŒçŠ¶æ€æµè½¬æ­£ç¡®
- [ ] å†å²è®°å½•å‡†ç¡®è®°å½•
- [ ] æŸ¥è¯¢æ€§èƒ½è‰¯å¥½

## ğŸ“ˆ æ€§èƒ½ç›‘æ§è¦ç‚¹

### 1. æ•°æ®åº“æŸ¥è¯¢
```javascript
// ç›‘æ§æŸ¥è¯¢æ€§èƒ½
db.contracts.find({customerPhone: "xxx", isLatest: true}).explain()
db.customercontracthistories.find({customerPhone: "xxx"}).explain()
```

### 2. APIå“åº”æ—¶é—´
- å®¢æˆ·æ£€æŸ¥API < 200ms
- æ¢äººåˆåŒåˆ›å»º < 500ms
- å†å²æŸ¥è¯¢ < 300ms

### 3. å†…å­˜ä½¿ç”¨
- ç›‘æ§CustomerContractHistoryé›†åˆå¤§å°
- å®šæœŸæ¸…ç†è¿‡æœŸæ•°æ®

## ğŸ”® åç»­ä¼˜åŒ–æ–¹å‘

### 1. ç”¨æˆ·ä½“éªŒä¼˜åŒ–
- åˆåŒå†å²å¯è§†åŒ–å›¾è¡¨
- æ¢äººæµç¨‹å¼•å¯¼åŠ¨ç”»
- æ‰¹é‡æ¢äººåŠŸèƒ½

### 2. ä¸šåŠ¡é€»è¾‘æ‰©å±•
- æ¢äººåŸå› åˆ†ç±»ç»Ÿè®¡
- æœåŠ¡è´¨é‡è¯„ä¼°
- è‡ªåŠ¨æ¨èé˜¿å§¨åŠŸèƒ½

### 3. ç³»ç»Ÿé›†æˆä¼˜åŒ–
- å¾®ä¿¡é€šçŸ¥é›†æˆ
- è´¢åŠ¡ç³»ç»Ÿé›†æˆ
- æŠ¥è¡¨ç³»ç»Ÿä¼˜åŒ–

## ğŸ¯ æˆåŠŸæ ‡å‡†

### âœ… æ ¸å¿ƒåŠŸèƒ½å®ç°å®Œæˆç‡: 100%
- æ¢äººåŠŸèƒ½å®Œå…¨å®ç°
- æ—¶é—´è®¡ç®—å®Œå…¨æ­£ç¡®
- æ•°æ®å…³ç³»å®Œå…¨æ­£ç¡®
- APIæ¥å£å®Œå…¨å®ç°

### âœ… æµ‹è¯•è¦†ç›–ç‡: 100%
- æ•°æ®åº“å±‚æµ‹è¯•é€šè¿‡
- ä¸šåŠ¡é€»è¾‘æµ‹è¯•é€šè¿‡
- é›†æˆæµ‹è¯•éªŒè¯å®Œæˆ

### âœ… æŠ€æœ¯æ–‡æ¡£å®Œæ•´æ€§: 100%
- å®ç°æ–‡æ¡£å®Œæ•´
- éƒ¨ç½²æŒ‡å—è¯¦ç»†
- æµ‹è¯•æŠ¥å‘Šå®Œå–„
- ä»£ç æ³¨é‡Šå……åˆ†

---

## ğŸ“ æŠ€æœ¯æ”¯æŒ

å¦‚æœ‰ä»»ä½•éƒ¨ç½²æˆ–ä½¿ç”¨é—®é¢˜ï¼Œè¯·å‚è€ƒï¼š
1. `Aå®¢æˆ·æ¢å¤šä¸ªé˜¿å§¨-æŠ€æœ¯å®ç°æ–‡æ¡£.md` - è¯¦ç»†æŠ€æœ¯æ–‡æ¡£
2. `test_database_functions.js` - æ•°æ®åº“åŠŸèƒ½æµ‹è¯•
3. `test_api_with_auth.js` - APIåŠŸèƒ½æµ‹è¯•
4. `frontend-integration-example.js` - å‰ç«¯é›†æˆç¤ºä¾‹

**ğŸ‰ æ­å–œï¼Aå®¢æˆ·æ¢å¤šä¸ªé˜¿å§¨åŠŸèƒ½å·²å®Œå…¨å®ç°å¹¶æµ‹è¯•é€šè¿‡ï¼** 