# 通知系统测试指南

## 🎯 测试目标

验证站内通知系统的完整功能，包括：
- 通知发送
- WebSocket实时推送
- 前端通知显示
- 标记已读功能

## 📋 测试前准备

### 1. 确认服务运行状态

```bash
# 检查后端服务
pm2 list

# 应该看到 backend-dev 和 frontend-dev 都在运行
```

### 2. 确认数据库连接

```bash
# 连接MongoDB
mongosh mongodb://127.0.0.1:27017/housekeeping

# 查看通知模板是否初始化
db.notificationtemplates.countDocuments()
# 应该返回 15+ 个模板
```

## 🧪 测试场景

### 场景1：客户分配通知

**测试步骤：**

1. **准备测试账号**
   - 管理员账号（用于分配客户）
   - 普通员工账号（接收通知）

2. **登录管理员账号**
   ```
   访问：http://localhost:5173
   使用管理员账号登录
   ```

3. **分配客户**
   - 进入"客户管理" -> "客户列表"
   - 选择一个客户
   - 点击"分配"按钮
   - 选择目标员工
   - 填写分配原因
   - 确认分配

4. **验证通知发送**
   - 检查后端日志：
   ```bash
   pm2 logs backend-dev --lines 50 | grep "通知"
   ```
   - 应该看到类似：`成功发送 1 条通知，类型: CUSTOMER_ASSIGNED`

5. **登录员工账号验证**
   - 打开新的浏览器窗口（或无痕模式）
   - 登录被分配的员工账号
   - 查看右上角通知铃铛
   - 应该显示红色徽章（未读数量）

6. **查看通知详情**
   - 点击通知铃铛
   - 应该看到通知列表
   - 通知内容：`您有新的客户【xxx】，电话：138****1234，来源：xxx，请及时跟进！`
   - 点击通知应该跳转到客户详情页

7. **标记已读**
   - 点击通知后，徽章数量应该减1
   - 通知状态变为已读（灰色背景）

### 场景2：公海分配通知

**测试步骤：**

1. **登录管理员账号**

2. **从公海分配客户**
   - 进入"客户管理" -> "公海客户"
   - 选择一个公海客户
   - 点击"分配"按钮
   - 选择目标员工
   - 确认分配

3. **验证通知**
   - 员工账号应该收到通知
   - 通知内容：`管理员从公海分配了客户 xxx 给您，请及时跟进`

### 场景3：WebSocket实时推送测试

**测试步骤：**

1. **同时打开两个浏览器窗口**
   - 窗口A：管理员账号
   - 窗口B：员工账号

2. **在窗口B观察通知铃铛**

3. **在窗口A执行分配操作**
   - 分配客户给窗口B的员工

4. **验证实时推送**
   - 窗口B的通知铃铛应该**立即**显示新通知
   - 无需刷新页面

5. **检查WebSocket连接**
   - 打开浏览器开发者工具（F12）
   - 切换到Console标签
   - 应该看到：`✅ WebSocket connected`
   - 收到通知时应该看到：`📬 New notification: ...`

## 🔍 调试技巧

### 1. 检查WebSocket连接

```javascript
// 在浏览器Console中执行
console.log('WebSocket状态:', notificationSocketService.isConnected())
```

### 2. 查看后端日志

```bash
# 实时查看日志
pm2 logs backend-dev

# 只看通知相关日志
pm2 logs backend-dev | grep -i "notification"
```

### 3. 查看数据库记录

```javascript
// 在MongoDB中查询通知记录
db.notifications.find().sort({createdAt: -1}).limit(10).pretty()

// 查询某个用户的通知
db.notifications.find({userId: ObjectId("用户ID")}).pretty()

// 查询未读通知数量
db.notifications.countDocuments({status: "SENT"})
```

### 4. 检查网络请求

- 打开浏览器开发者工具（F12）
- 切换到Network标签
- 筛选WS（WebSocket）连接
- 应该看到 `/notifications` 的WebSocket连接

## ❌ 常见问题

### 问题1：通知铃铛不显示

**可能原因：**
- WebSocket连接失败
- Token过期

**解决方法：**
```javascript
// 检查Console是否有错误
// 重新登录获取新token
```

### 问题2：通知不实时更新

**可能原因：**
- WebSocket断开
- 后端服务未启动

**解决方法：**
```bash
# 检查后端服务
pm2 list

# 重启后端
pm2 restart backend-dev
```

### 问题3：点击通知无反应

**可能原因：**
- actionUrl配置错误
- 路由不存在

**解决方法：**
- 检查通知模板中的actionUrl配置
- 确认前端路由已配置

## ✅ 测试检查清单

- [ ] 后端服务正常运行
- [ ] 前端服务正常运行
- [ ] MongoDB连接正常
- [ ] 通知模板已初始化
- [ ] WebSocket连接成功
- [ ] 客户分配通知发送成功
- [ ] 通知实时推送成功
- [ ] 通知列表显示正常
- [ ] 标记已读功能正常
- [ ] 点击通知跳转正常
- [ ] 未读数量统计正确

## 📊 性能测试

### 批量通知测试

```bash
# 批量分配客户，测试通知性能
# 观察：
# 1. 通知发送速度
# 2. WebSocket推送延迟
# 3. 前端渲染性能
```

## 📝 测试报告模板

```markdown
## 测试报告

**测试日期**: 2025-11-24
**测试人员**: [姓名]
**测试环境**: 开发环境

### 测试结果

| 测试场景 | 预期结果 | 实际结果 | 状态 |
|---------|---------|---------|------|
| 客户分配通知 | 实时收到通知 | ✅ 正常 | 通过 |
| 公海分配通知 | 实时收到通知 | ✅ 正常 | 通过 |
| WebSocket连接 | 自动连接成功 | ✅ 正常 | 通过 |
| 标记已读 | 状态更新正确 | ✅ 正常 | 通过 |

### 发现的问题

1. [问题描述]
2. [问题描述]

### 建议

1. [改进建议]
2. [改进建议]
```

---

**文档版本**: v1.0.0  
**更新日期**: 2025-11-24

