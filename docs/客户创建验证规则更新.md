# 客户创建验证规则更新

## 更新日期
2025-12-22

## 更新内容

### 新增验证规则
**手机号和微信号至少填写一个**

在创建或更新客户时，手机号（`phone`）和微信号（`wechatId`）必须至少填写一个。如果两者都为空，系统将提示：**"请填写手机号或微信号"**

## 修改的文件

### 后端修改

#### 1. `backend/src/modules/customers/dto/create-customer.dto.ts`
- 添加了自定义验证装饰器 `IsPhoneOrWechatRequired`
- 该装饰器验证 `phone` 或 `wechatId` 至少有一个不为空
- 修改了 `phone` 字段的验证规则，只在填写时验证格式

#### 2. `backend/src/modules/customers/customers.service.ts`
- 在 `create` 方法中添加验证逻辑，确保手机号或微信号至少填一个
- 在 `update` 方法中添加验证逻辑，考虑更新后的值，确保至少保留一个联系方式

### 前端修改

#### 3. `frontend/src/pages/customers/CreateCustomer.tsx`
- 为 `phone` 和 `wechatId` 字段添加自定义验证器
- 验证器会检查另一个字段是否已填写
- 更新了占位符文本，移除"可选"标识

#### 4. `frontend/src/pages/customers/EditCustomer.tsx`
- 添加与创建页面相同的验证逻辑
- 确保编辑时也遵循相同的验证规则

#### 5. `frontend/src/utils/miniprogramUtils.ts`
- 更新 `validateCustomerForm` 函数
- 添加手机号或微信号至少填一个的验证
- 如果两者都为空，会为两个字段都添加错误信息

#### 6. `frontend/src/utils/__tests__/miniprogramUtils.test.js`
- 更新测试用例以反映新的验证规则
- 添加测试：只有手机号、只有微信号、两者都没有的情况

### 小程序示例更新

#### 7. `docs/小程序端客户管理示例/pages/customer/create.wxml`
- 移除客户电话的 `required` 标记
- 为微信号字段添加错误提示显示
- 添加提示文本："手机号和微信号至少填写一个"

## 验证规则详情

### 必填字段（共4个）
1. **客户姓名** (`name`) - 必填
2. **线索来源** (`leadSource`) - 必填
3. **客户状态** (`contractStatus`) - 必填
4. **线索等级** (`leadLevel`) - 必填

### 联系方式规则
- **手机号** (`phone`) 和 **微信号** (`wechatId`) 至少填写一个
- 如果填写手机号，必须是有效的11位中国手机号（1开头）
- 微信号无格式限制

### 可选字段
所有其他字段均为可选，但部分字段如果填写需要符合特定格式或范围要求。

## 错误提示

### 前端表单验证
- 当两个字段都为空时，两个字段都会显示红色错误提示："请填写手机号或微信号"
- 当填写了手机号但格式不正确时，显示："请输入有效的手机号码"

### 后端API响应
- 状态码：400 Bad Request
- 错误消息：`"请填写手机号或微信号"`

## 测试建议

### 测试场景
1. ✅ 只填写手机号（有效格式）- 应该成功
2. ✅ 只填写微信号 - 应该成功
3. ✅ 同时填写手机号和微信号 - 应该成功
4. ❌ 两者都不填写 - 应该失败，提示"请填写手机号或微信号"
5. ❌ 只填写手机号（无效格式）- 应该失败，提示"请输入有效的手机号码"
6. ✅ 编辑时清空手机号但保留微信号 - 应该成功
7. ❌ 编辑时同时清空手机号和微信号 - 应该失败

## 向后兼容性

此更改可能影响现有数据：
- 如果数据库中存在既没有手机号也没有微信号的客户记录，编辑这些记录时需要至少填写一个联系方式
- 建议在部署前检查数据库，确保所有客户至少有一个联系方式

## 小程序API接口

### 自动适配
小程序的客户创建和更新接口**已自动适配新规则**，无需修改：

- `POST /api/customers/miniprogram/create` - 创建客户
- `PATCH /api/customers/miniprogram/:id` - 更新客户

这两个接口使用相同的 DTO 和 Service，验证规则已自动生效。

### 错误码
小程序接口新增错误码：
- `MISSING_CONTACT` - 手机号和微信号都未填写

**错误响应示例：**
```json
{
  "success": false,
  "message": "请填写手机号或微信号",
  "data": null,
  "error": "MISSING_CONTACT"
}
```

## 部署注意事项

1. 先部署后端代码，确保API验证生效
2. 再部署前端代码，确保表单验证与后端一致
3. 更新小程序代码（如果使用），处理新的错误码 `MISSING_CONTACT`
4. 通知用户新的验证规则

