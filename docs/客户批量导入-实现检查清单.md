# 客户批量导入功能 - 实现检查清单

## 📋 总览

本清单用于跟踪客户批量导入功能的实现进度。

**功能描述**: 支持通过Excel文件批量导入客户数据  
**必填字段**: 姓名、电话、线索来源  
**预计工时**: 10小时

---

## 🔧 后端实现清单

### 阶段1: 准备工作

- [ ] **1.1** 确认 ExcelJS 依赖已安装
  - 检查 `backend/package.json` 中是否有 `"exceljs": "^4.4.0"`
  - 如未安装，运行: `npm install exceljs`

- [ ] **1.2** 确认临时文件目录存在
  - 检查 `./uploads/temp` 目录是否存在
  - 如不存在，创建目录: `mkdir -p uploads/temp`
  - 确保目录有写权限

- [ ] **1.3** 确认 Multer 配置正常
  - 检查文件上传中间件是否正常工作
  - 参考简历导入的配置

### 阶段2: Controller 层实现

**文件**: `backend/src/modules/customers/customers.controller.ts`

- [ ] **2.1** 添加必要的导入语句
  ```typescript
  import { FileInterceptor } from '@nestjs/platform-express';
  import { UploadedFile } from '@nestjs/common';
  import { diskStorage } from 'multer';
  import { extname } from 'path';
  ```

- [ ] **2.2** 实现 `importExcel` 接口方法
  - [ ] 添加 `@Post('import-excel')` 装饰器
  - [ ] 添加 `@ApiOperation` Swagger文档
  - [ ] 添加 `@ApiConsumes('multipart/form-data')`
  - [ ] 添加 `@ApiBody` 定义文件上传schema
  - [ ] 配置 `@UseInterceptors(FileInterceptor(...))`
  - [ ] 实现文件存储配置（diskStorage）
  - [ ] 实现文件类型验证（fileFilter）
  - [ ] 实现接口处理逻辑

- [ ] **2.3** 添加错误处理
  - [ ] 处理文件未上传的情况
  - [ ] 处理文件格式错误
  - [ ] 记录日志（开始、成功、失败）
  - [ ] 返回统一的响应格式

- [ ] **2.4** 测试 Controller 接口
  - [ ] 使用 Postman 测试上传
  - [ ] 验证文件类型限制
  - [ ] 验证错误响应格式

### 阶段3: Service 层实现

**文件**: `backend/src/modules/customers/customers.service.ts`

- [ ] **3.1** 添加必要的导入语句
  ```typescript
  import * as ExcelJS from 'exceljs';
  import * as fs from 'fs';
  ```

- [ ] **3.2** 实现 `importFromExcel` 方法
  - [ ] 定义返回类型: `{ success: number; fail: number; errors: string[] }`
  - [ ] 使用 ExcelJS 读取文件
  - [ ] 获取第一个工作表
  - [ ] 验证工作表是否存在
  - [ ] 验证是否有数据行

- [ ] **3.3** 实现表头解析和验证
  - [ ] 读取第一行作为表头
  - [ ] 定义必需列: `['姓名', '电话', '线索来源']`
  - [ ] 验证必需列是否存在
  - [ ] 如缺少必需列，抛出异常

- [ ] **3.4** 实现数据行解析
  - [ ] 从第2行开始遍历
  - [ ] 提取每行的单元格数据
  - [ ] 验证必填字段是否存在
  - [ ] 调用 `mapExcelRowToCustomerDto` 映射数据

- [ ] **3.5** 实现批量创建逻辑
  - [ ] 使用 Promise.all 并发创建
  - [ ] 成功时增加 success 计数
  - [ ] 失败时增加 fail 计数并记录错误
  - [ ] 等待所有操作完成

- [ ] **3.6** 实现清理和返回
  - [ ] 删除临时文件
  - [ ] 记录导入结果日志
  - [ ] 返回统计结果

- [ ] **3.7** 实现 `mapExcelRowToCustomerDto` 方法
  - [ ] 映射必填字段: 姓名、电话、线索来源
  - [ ] 映射可选字段: 微信号、身份证号等
  - [ ] 处理枚举字段映射
  - [ ] 处理数字字段转换
  - [ ] 处理日期字段转换
  - [ ] 设置默认值（如客户状态默认为"待定"）

- [ ] **3.8** 实现数据验证
  - [ ] 手机号格式验证（利用 DTO 的 @IsPhoneNumber）
  - [ ] 手机号去重检查（利用现有的 create 方法）
  - [ ] 枚举值验证（利用 DTO 的 @IsEnum）
  - [ ] 数字范围验证（利用 DTO 的 @Min/@Max）

- [ ] **3.9** 测试 Service 方法
  - [ ] 单元测试: 正常数据导入
  - [ ] 单元测试: 缺少必需列
  - [ ] 单元测试: 手机号重复
  - [ ] 单元测试: 数据验证失败
  - [ ] 单元测试: 临时文件清理

---

## 🎨 前端实现清单

### 阶段4: 组件准备

**文件**: `frontend/src/pages/customers/CustomerList.tsx`

- [ ] **4.1** 添加必要的导入
  ```typescript
  import { UploadOutlined, InboxOutlined } from '@ant-design/icons';
  import { Upload, Modal, UploadProps } from 'antd';
  ```

- [ ] **4.2** 添加状态管理
  - [ ] `importModalVisible`: 控制弹窗显示
  - [ ] `importLoading`: 控制上传加载状态
  - [ ] `importResult`: 存储导入结果

### 阶段5: 功能实现

- [ ] **5.1** 实现 `handleExcelImport` 方法
  - [ ] 获取上传的文件
  - [ ] 验证文件类型（.xlsx, .xls）
  - [ ] 创建 FormData
  - [ ] 调用 API 上传文件
  - [ ] 处理成功响应
  - [ ] 刷新客户列表
  - [ ] 全部成功时自动关闭弹窗
  - [ ] 处理错误情况

- [ ] **5.2** 实现 `downloadExcelTemplate` 方法
  - [ ] 定义表头列
  - [ ] 定义示例数据
  - [ ] 生成 CSV 内容（添加 BOM）
  - [ ] 创建 Blob 对象
  - [ ] 触发下载

- [ ] **5.3** 实现 `handleCloseImport` 方法
  - [ ] 关闭弹窗
  - [ ] 重置导入结果

### 阶段6: UI 实现

- [ ] **6.1** 添加"批量导入"按钮
  - [ ] 在客户列表顶部操作区添加
  - [ ] 使用 UploadOutlined 图标
  - [ ] 点击时打开导入弹窗

- [ ] **6.2** 实现导入弹窗
  - [ ] 设置标题: "批量导入客户"
  - [ ] 添加"下载模板"按钮
  - [ ] 添加"关闭"按钮
  - [ ] 根据 importResult 切换显示内容

- [ ] **6.3** 实现上传区域
  - [ ] 使用 Upload.Dragger 组件
  - [ ] 显示上传提示文本
  - [ ] 显示支持的文件格式
  - [ ] 添加模板下载链接
  - [ ] 禁用多文件上传
  - [ ] 隐藏上传列表

- [ ] **6.4** 实现结果展示区
  - [ ] 显示"导入结果"标题
  - [ ] 显示成功数量（绿色加粗）
  - [ ] 显示失败数量（红色加粗）
  - [ ] 显示错误详情列表
  - [ ] 错误列表可滚动（最大高度200px）

- [ ] **6.5** 测试前端功能
  - [ ] 测试按钮点击
  - [ ] 测试弹窗打开/关闭
  - [ ] 测试模板下载
  - [ ] 测试文件上传
  - [ ] 测试结果展示
  - [ ] 测试错误提示

---

## 🧪 集成测试清单

### 阶段7: 端到端测试

- [ ] **7.1** 准备测试数据
  - [ ] 创建正常数据Excel（5条）
  - [ ] 创建包含错误的Excel（手机号重复）
  - [ ] 创建缺少必需列的Excel
  - [ ] 创建手机号格式错误的Excel

- [ ] **7.2** 测试正常流程
  - [ ] 下载模板
  - [ ] 填写正常数据
  - [ ] 上传导入
  - [ ] 验证导入成功
  - [ ] 检查数据库记录
  - [ ] 验证列表刷新

- [ ] **7.3** 测试异常流程
  - [ ] 上传非Excel文件（如.txt）
  - [ ] 上传空Excel文件
  - [ ] 上传缺少必需列的Excel
  - [ ] 上传手机号重复的数据
  - [ ] 上传手机号格式错误的数据
  - [ ] 验证错误提示正确

- [ ] **7.4** 测试边界情况
  - [ ] 上传大文件（100条数据）
  - [ ] 上传只有表头的Excel
  - [ ] 上传包含空行的Excel
  - [ ] 上传包含特殊字符的数据

- [ ] **7.5** 测试性能
  - [ ] 测试100条数据导入时间
  - [ ] 测试500条数据导入时间
  - [ ] 验证临时文件是否清理
  - [ ] 验证内存使用情况

---

## 📝 文档清单

- [ ] **8.1** 更新API文档
  - [ ] 在 Swagger 中验证接口文档
  - [ ] 添加请求示例
  - [ ] 添加响应示例

- [ ] **8.2** 编写用户手册
  - [ ] 如何下载模板
  - [ ] 如何填写数据
  - [ ] 如何上传导入
  - [ ] 常见问题解答

- [ ] **8.3** 编写开发文档
  - [ ] 架构设计说明
  - [ ] 数据流程说明
  - [ ] 字段映射说明
  - [ ] 错误处理说明

---

## 🚀 部署清单

- [ ] **9.1** 后端部署
  - [ ] 确认依赖已安装
  - [ ] 确认临时目录存在
  - [ ] 重启后端服务
  - [ ] 验证接口可访问

- [ ] **9.2** 前端部署
  - [ ] 构建生产版本
  - [ ] 部署到服务器
  - [ ] 验证功能正常

- [ ] **9.3** 数据库检查
  - [ ] 验证手机号唯一索引
  - [ ] 验证数据完整性

---

## ✅ 验收标准

### 功能验收

- [ ] ✅ 可以下载Excel模板
- [ ] ✅ 可以上传Excel文件
- [ ] ✅ 必填字段验证正确
- [ ] ✅ 手机号去重正常
- [ ] ✅ 枚举值验证正确
- [ ] ✅ 导入结果统计准确
- [ ] ✅ 错误信息详细明确
- [ ] ✅ 临时文件自动清理
- [ ] ✅ 列表自动刷新

### 性能验收

- [ ] ✅ 100条数据导入时间 < 10秒
- [ ] ✅ 500条数据导入时间 < 30秒
- [ ] ✅ 内存使用正常
- [ ] ✅ 无内存泄漏

### 安全验收

- [ ] ✅ 文件类型限制有效
- [ ] ✅ 文件大小限制有效
- [ ] ✅ 需要登录认证
- [ ] ✅ 需要角色权限
- [ ] ✅ 临时文件及时清理

### 用户体验验收

- [ ] ✅ 操作流程简单明了
- [ ] ✅ 错误提示清晰友好
- [ ] ✅ 加载状态显示正常
- [ ] ✅ 成功提示及时
- [ ] ✅ 模板下载方便

---

## 📊 进度跟踪

| 阶段 | 任务数 | 已完成 | 进度 |
|------|--------|--------|------|
| 后端准备 | 3 | 0 | 0% |
| Controller层 | 4 | 0 | 0% |
| Service层 | 9 | 0 | 0% |
| 前端准备 | 2 | 0 | 0% |
| 前端功能 | 3 | 0 | 0% |
| 前端UI | 5 | 0 | 0% |
| 集成测试 | 5 | 0 | 0% |
| 文档编写 | 3 | 0 | 0% |
| 部署上线 | 3 | 0 | 0% |
| **总计** | **37** | **0** | **0%** |

---

## 📅 时间规划

| 日期 | 计划任务 | 预计工时 |
|------|---------|---------|
| Day 1 | 后端实现（阶段1-3） | 5小时 |
| Day 2 | 前端实现（阶段4-6） | 3小时 |
| Day 3 | 测试和文档（阶段7-8） | 2小时 |

---

**文档版本**: 1.0  
**创建时间**: 2025-01-11  
**维护人**: AI Assistant  
**状态**: 📋 待开始

