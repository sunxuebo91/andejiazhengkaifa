# å®¢æˆ·æ‰¹é‡å¯¼å…¥ - å¿«é€Ÿå¼€å§‹æŒ‡å—

## ğŸš€ 5åˆ†é’Ÿå¿«é€Ÿå®ç°

æœ¬æŒ‡å—å°†å¸®åŠ©ä½ å¿«é€Ÿå®ç°å®¢æˆ·æ‰¹é‡å¯¼å…¥åŠŸèƒ½ã€‚

## ğŸ“‹ å‰ç½®æ¡ä»¶

- âœ… åç«¯å·²å®‰è£… `exceljs` ä¾èµ–ï¼ˆå·²åœ¨ package.json ä¸­ï¼‰
- âœ… å‰ç«¯å·²å®‰è£… Ant Design ç»„ä»¶åº“
- âœ… å·²æœ‰å®¢æˆ·ç®¡ç†æ¨¡å—ï¼ˆcustomersï¼‰
- âœ… å·²æœ‰æ–‡ä»¶ä¸Šä¼ é…ç½®ï¼ˆmulterï¼‰

## ğŸ¯ å®ç°æ­¥éª¤

### æ­¥éª¤1: åç«¯ - æ·»åŠ å¯¼å…¥æ¥å£ï¼ˆ5åˆ†é’Ÿï¼‰

#### 1.1 åœ¨ `backend/src/modules/customers/customers.controller.ts` æ·»åŠ å¯¼å…¥

åœ¨æ–‡ä»¶é¡¶éƒ¨æ·»åŠ å¯¼å…¥ï¼š

```typescript
import { FileInterceptor } from '@nestjs/platform-express';
import { UploadedFile } from '@nestjs/common';
import { diskStorage } from 'multer';
import { extname } from 'path';
```

åœ¨ Controller ç±»ä¸­æ·»åŠ å¯¼å…¥æ¥å£ï¼š

```typescript
@Post('import-excel')
@ApiOperation({ summary: 'æ‰¹é‡å¯¼å…¥å®¢æˆ·ï¼ˆExcelæ ¼å¼ï¼‰' })
@ApiConsumes('multipart/form-data')
@ApiBody({
  schema: {
    type: 'object',
    properties: {
      file: {
        type: 'string',
        format: 'binary',
        description: 'Excelæ–‡ä»¶',
      },
    },
  },
})
@UseInterceptors(FileInterceptor('file', {
  storage: diskStorage({
    destination: './uploads/temp',
    filename: (req, file, callback) => {
      const uniqueSuffix = Date.now() + '-' + Math.round(Math.random() * 1e9);
      const extension = extname(file.originalname);
      callback(null, `customer-excel-${uniqueSuffix}${extension}`);
    },
  }),
  fileFilter: (req, file, callback) => {
    const ext = extname(file.originalname).toLowerCase();
    if (!['.xlsx', '.xls'].includes(ext)) {
      return callback(new BadRequestException('ä»…æ”¯æŒ .xlsx æˆ– .xls æ ¼å¼çš„Excelæ–‡ä»¶'), false);
    }
    callback(null, true);
  },
}))
async importExcel(
  @UploadedFile() file: Express.Multer.File,
  @Req() req,
) {
  try {
    if (!file) {
      throw new BadRequestException('è¯·ä¸Šä¼ Excelæ–‡ä»¶');
    }

    this.logger.log(`å¼€å§‹å¤„ç†å®¢æˆ·Excelå¯¼å…¥ï¼Œæ–‡ä»¶å: ${file.originalname}`);
    const importResults = await this.customersService.importFromExcel(file.path, req.user.userId);

    return {
      success: true,
      data: importResults,
      message: `æˆåŠŸå¯¼å…¥ ${importResults.success} æ¡å®¢æˆ·ï¼Œå¤±è´¥ ${importResults.fail} æ¡`
    };
  } catch (error) {
    this.logger.error(`å®¢æˆ·Excelå¯¼å…¥å¤±è´¥: ${error.message}`);
    return {
      success: false,
      data: null,
      message: `Excelå¯¼å…¥å¤±è´¥: ${error.message}`
    };
  }
}
```

### æ­¥éª¤2: åç«¯ - å®ç°å¯¼å…¥æœåŠ¡ï¼ˆ10åˆ†é’Ÿï¼‰

#### 2.1 åœ¨ `backend/src/modules/customers/customers.service.ts` æ·»åŠ å¯¼å…¥

åœ¨æ–‡ä»¶é¡¶éƒ¨æ·»åŠ å¯¼å…¥ï¼š

```typescript
import * as ExcelJS from 'exceljs';
import * as fs from 'fs';
```

åœ¨ Service ç±»ä¸­æ·»åŠ å¯¼å…¥æ–¹æ³•ï¼š

```typescript
/**
 * ä»Excelæ–‡ä»¶å¯¼å…¥å®¢æˆ·æ•°æ®
 */
async importFromExcel(filePath: string, userId: string): Promise<{ success: number; fail: number; errors: string[] }> {
  this.logger.log(`å¼€å§‹å¤„ç†å®¢æˆ·Excelæ–‡ä»¶å¯¼å…¥: ${filePath}`);

  const result = {
    success: 0,
    fail: 0,
    errors: [] as string[]
  };

  try {
    const workbook = new ExcelJS.Workbook();
    await workbook.xlsx.readFile(filePath);

    const worksheet = workbook.getWorksheet(1);
    if (!worksheet) {
      throw new BadRequestException('Excelæ–‡ä»¶ä¸­æ²¡æœ‰æ‰¾åˆ°å·¥ä½œè¡¨');
    }

    if (worksheet.rowCount <= 1) {
      throw new BadRequestException('Excelæ–‡ä»¶ä¸­æ²¡æœ‰æ•°æ®');
    }

    // è·å–è¡¨å¤´
    const headerRow = worksheet.getRow(1);
    const headers: string[] = [];
    headerRow.eachCell((cell, colNumber) => {
      headers[colNumber - 1] = cell.value?.toString().trim() || '';
    });

    // æ£€æŸ¥å¿…éœ€çš„åˆ—
    const requiredColumns = ['å§“å', 'ç”µè¯', 'çº¿ç´¢æ¥æº'];
    const missingColumns = requiredColumns.filter(col => !headers.includes(col));

    if (missingColumns.length > 0) {
      throw new BadRequestException(`Excelæ–‡ä»¶ç¼ºå°‘å¿…éœ€çš„åˆ—: ${missingColumns.join(', ')}`);
    }

    // è§£ææ¯ä¸€è¡Œæ•°æ®
    const promises = [];

    for (let rowNumber = 2; rowNumber <= worksheet.rowCount; rowNumber++) {
      const row = worksheet.getRow(rowNumber);
      const rowData: Record<string, any> = {};

      row.eachCell((cell, colNumber) => {
        const header = headers[colNumber - 1];
        if (header) {
          rowData[header] = cell.value;
        }
      });

      // æ£€æŸ¥å¿…å¡«å­—æ®µ
      if (!rowData['å§“å'] || !rowData['ç”µè¯'] || !rowData['çº¿ç´¢æ¥æº']) {
        result.fail++;
        result.errors.push(`ç¬¬ ${rowNumber} è¡Œç¼ºå°‘å¿…å¡«å­—æ®µ`);
        continue;
      }

      // è½¬æ¢æ•°æ®ä¸ºDTOæ ¼å¼
      const customerData = this.mapExcelRowToCustomerDto(rowData, userId);

      // åˆ›å»ºå®¢æˆ·(å¼‚æ­¥)
      promises.push(
        this.create(customerData, userId)
          .then(() => {
            result.success++;
          })
          .catch(error => {
            result.fail++;
            const errorMsg = error.message || 'æœªçŸ¥é”™è¯¯';
            result.errors.push(`ç¬¬ ${rowNumber} è¡Œå¯¼å…¥å¤±è´¥: ${errorMsg}`);
          })
      );
    }

    // ç­‰å¾…æ‰€æœ‰åˆ›å»ºæ“ä½œå®Œæˆ
    await Promise.all(promises);

    // æ¸…ç†ä¸´æ—¶æ–‡ä»¶
    fs.unlinkSync(filePath);

    this.logger.log(`å®¢æˆ·Excelå¯¼å…¥å®Œæˆï¼ŒæˆåŠŸ: ${result.success}, å¤±è´¥: ${result.fail}`);
    return result;
  } catch (error) {
    // æ¸…ç†ä¸´æ—¶æ–‡ä»¶
    if (fs.existsSync(filePath)) {
      fs.unlinkSync(filePath);
    }

    this.logger.error(`å®¢æˆ·Excelå¯¼å…¥è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯: ${error.message}`);
    throw error;
  }
}

/**
 * å°†Excelè¡Œæ•°æ®æ˜ å°„åˆ°å®¢æˆ·DTO
 */
private mapExcelRowToCustomerDto(rowData: Record<string, any>, userId: string): CreateCustomerDto {
  const dto: any = {
    name: rowData['å§“å']?.toString().trim(),
    phone: rowData['ç”µè¯']?.toString().trim(),
    leadSource: rowData['çº¿ç´¢æ¥æº']?.toString().trim(),
    contractStatus: rowData['å®¢æˆ·çŠ¶æ€']?.toString().trim() || 'å¾…å®š',
  };

  // å¯é€‰å­—æ®µ
  if (rowData['å¾®ä¿¡å·']) {
    dto.wechatId = rowData['å¾®ä¿¡å·']?.toString().trim();
  }

  if (rowData['èº«ä»½è¯å·']) {
    dto.idCardNumber = rowData['èº«ä»½è¯å·']?.toString().trim();
  }

  if (rowData['éœ€æ±‚å“ç±»']) {
    dto.serviceCategory = rowData['éœ€æ±‚å“ç±»']?.toString().trim();
  }

  if (rowData['çº¿ç´¢ç­‰çº§']) {
    dto.leadLevel = rowData['çº¿ç´¢ç­‰çº§']?.toString().trim();
  }

  if (rowData['è–ªèµ„é¢„ç®—']) {
    dto.salaryBudget = Number(rowData['è–ªèµ„é¢„ç®—']) || undefined;
  }

  if (rowData['æœŸæœ›ä¸Šæˆ·æ—¥æœŸ']) {
    dto.expectedStartDate = rowData['æœŸæœ›ä¸Šæˆ·æ—¥æœŸ']?.toString().trim();
  }

  if (rowData['å®¶åº­é¢ç§¯']) {
    dto.homeArea = Number(rowData['å®¶åº­é¢ç§¯']) || undefined;
  }

  if (rowData['å®¶åº­äººå£']) {
    dto.familySize = Number(rowData['å®¶åº­äººå£']) || undefined;
  }

  if (rowData['ä¼‘æ¯åˆ¶åº¦']) {
    dto.restSchedule = rowData['ä¼‘æ¯åˆ¶åº¦']?.toString().trim();
  }

  if (rowData['åœ°å€']) {
    dto.address = rowData['åœ°å€']?.toString().trim();
  }

  if (rowData['å¤‡æ³¨']) {
    dto.remarks = rowData['å¤‡æ³¨']?.toString().trim();
  }

  return dto as CreateCustomerDto;
}
```

### æ­¥éª¤3: å‰ç«¯ - æ·»åŠ å¯¼å…¥åŠŸèƒ½ï¼ˆ10åˆ†é’Ÿï¼‰

#### 3.1 åœ¨ `frontend/src/pages/customers/CustomerList.tsx` æ·»åŠ å¯¼å…¥åŠŸèƒ½

åœ¨æ–‡ä»¶é¡¶éƒ¨æ·»åŠ å¯¼å…¥ï¼š

```typescript
import { UploadOutlined, InboxOutlined } from '@ant-design/icons';
import { Upload, Modal, UploadProps } from 'antd';
```

åœ¨ç»„ä»¶ä¸­æ·»åŠ çŠ¶æ€ï¼š

```typescript
const [importModalVisible, setImportModalVisible] = useState(false);
const [importLoading, setImportLoading] = useState(false);
const [importResult, setImportResult] = useState<{
  success: number;
  fail: number;
  errors: string[];
} | null>(null);
```

æ·»åŠ å¤„ç†å‡½æ•°ï¼š

```typescript
// å¤„ç†Excelå¯¼å…¥
const handleExcelImport: UploadProps['customRequest'] = async (options) => {
  setImportLoading(true);
  setImportResult(null);
  
  try {
    const { file } = options;
    const uploadFile = file as File;
    
    const isExcel = 
      uploadFile.name.endsWith('.xlsx') || 
      uploadFile.name.endsWith('.xls');
    
    if (!isExcel) {
      message.error('åªæ”¯æŒExcelæ–‡ä»¶(.xlsx, .xls)');
      setImportLoading(false);
      return;
    }
    
    const formData = new FormData();
    formData.append('file', uploadFile);
    
    const response = await apiService.upload('/api/customers/import-excel', formData);
    
    if (response.success) {
      message.success(response.message || 'å¯¼å…¥æˆåŠŸ');
      setImportResult(response.data);
      loadCustomers(1, pageSize);
      
      if (response.data.success > 0 && response.data.fail === 0) {
        setTimeout(() => setImportModalVisible(false), 2000);
      }
    }
  } catch (error) {
    message.error('å¯¼å…¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æ ¼å¼');
  } finally {
    setImportLoading(false);
  }
};

// ä¸‹è½½æ¨¡æ¿
const downloadExcelTemplate = () => {
  const csv = '\ufeffå§“å,ç”µè¯,çº¿ç´¢æ¥æº,å¾®ä¿¡å·,éœ€æ±‚å“ç±»,å®¢æˆ·çŠ¶æ€,è–ªèµ„é¢„ç®—,åœ°å€,å¤‡æ³¨\n' +
    'å¼ ä¸‰,13800138000,ç¾å›¢,wx123,æœˆå«‚,å¾…å®š,8000,åŒ—äº¬å¸‚æœé˜³åŒº,å¤‡æ³¨ä¿¡æ¯\n' +
    'æå››,13900139000,æŠ–éŸ³,,ä½å®¶è‚²å„¿å«‚,åŒ¹é…ä¸­,9000,ä¸Šæµ·å¸‚æµ¦ä¸œæ–°åŒº,\n';
  
  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const link = document.createElement('a');
  link.href = URL.createObjectURL(blob);
  link.download = 'å®¢æˆ·å¯¼å…¥æ¨¡æ¿.csv';
  link.click();
};
```

åœ¨é¡µé¢ä¸­æ·»åŠ å¯¼å…¥æŒ‰é’®ï¼ˆåœ¨"æ–°å¢å®¢æˆ·"æŒ‰é’®æ—è¾¹ï¼‰ï¼š

```tsx
<Button 
  type="default" 
  icon={<UploadOutlined />}
  onClick={() => setImportModalVisible(true)}
>
  æ‰¹é‡å¯¼å…¥
</Button>
```

åœ¨é¡µé¢åº•éƒ¨æ·»åŠ å¯¼å…¥å¼¹çª—ï¼š

```tsx
{/* Excelå¯¼å…¥å¼¹çª— */}
<Modal
  title="æ‰¹é‡å¯¼å…¥å®¢æˆ·"
  open={importModalVisible}
  onCancel={() => {
    setImportModalVisible(false);
    setImportResult(null);
  }}
  footer={[
    <Button key="download" onClick={downloadExcelTemplate}>
      ä¸‹è½½æ¨¡æ¿
    </Button>,
    <Button key="cancel" onClick={() => setImportModalVisible(false)}>
      å…³é—­
    </Button>,
  ]}
>
  {!importResult ? (
    <div>
      <p>è¯·ä¸Šä¼ Excelæ–‡ä»¶ï¼Œæ–‡ä»¶ç¬¬ä¸€è¡Œå¿…é¡»åŒ…å«ä»¥ä¸‹åˆ—ï¼šå§“åã€ç”µè¯ã€çº¿ç´¢æ¥æº</p>
      <p>å…¶ä»–å¯é€‰åˆ—ï¼šå¾®ä¿¡å·ã€éœ€æ±‚å“ç±»ã€å®¢æˆ·çŠ¶æ€ã€è–ªèµ„é¢„ç®—ã€åœ°å€ã€å¤‡æ³¨ç­‰</p>
      <p><a onClick={downloadExcelTemplate} style={{ color: '#1890ff', cursor: 'pointer' }}>ç‚¹å‡»ä¸‹è½½æ¨¡æ¿</a></p>
      
      <Upload.Dragger
        name="file"
        multiple={false}
        showUploadList={false}
        customRequest={handleExcelImport}
        disabled={importLoading}
      >
        <p className="ant-upload-drag-icon">
          <InboxOutlined />
        </p>
        <p className="ant-upload-text">ç‚¹å‡»æˆ–æ‹–æ‹½æ–‡ä»¶åˆ°æ­¤åŒºåŸŸä¸Šä¼ </p>
        <p className="ant-upload-hint">æ”¯æŒ .xlsx, .xls æ ¼å¼</p>
      </Upload.Dragger>
    </div>
  ) : (
    <div>
      <h3>å¯¼å…¥ç»“æœ</h3>
      <p>æˆåŠŸå¯¼å…¥: <span style={{ color: 'green', fontWeight: 'bold' }}>{importResult.success}</span> æ¡</p>
      <p>å¯¼å…¥å¤±è´¥: <span style={{ color: 'red', fontWeight: 'bold' }}>{importResult.fail}</span> æ¡</p>
      
      {importResult.errors.length > 0 && (
        <div>
          <h4>é”™è¯¯è¯¦æƒ…ï¼š</h4>
          <ul style={{ color: 'red', maxHeight: '200px', overflow: 'auto' }}>
            {importResult.errors.map((error, index) => (
              <li key={index}>{error}</li>
            ))}
          </ul>
        </div>
      )}
    </div>
  )}
</Modal>
```

## âœ… éªŒè¯æ­¥éª¤

### 1. åç«¯éªŒè¯

```bash
# é‡å¯åç«¯æœåŠ¡
cd backend
npm run start:dev

# æ£€æŸ¥æ—¥å¿—ï¼Œç¡®è®¤æ¥å£åŠ è½½æˆåŠŸ
```

### 2. å‰ç«¯éªŒè¯

```bash
# é‡æ–°æ„å»ºå‰ç«¯
cd frontend
npm run build

# æˆ–å¼€å‘æ¨¡å¼
npm run dev
```

### 3. åŠŸèƒ½æµ‹è¯•

1. è®¿é—®å®¢æˆ·åˆ—è¡¨é¡µé¢
2. ç‚¹å‡»"æ‰¹é‡å¯¼å…¥"æŒ‰é’®
3. ç‚¹å‡»"ä¸‹è½½æ¨¡æ¿"è·å–ç¤ºä¾‹æ–‡ä»¶
4. å¡«å†™æ•°æ®åä¸Šä¼ 
5. æŸ¥çœ‹å¯¼å…¥ç»“æœ

## ğŸ“ Excelæ¨¡æ¿ç¤ºä¾‹

| å§“å | ç”µè¯ | çº¿ç´¢æ¥æº | å¾®ä¿¡å· | éœ€æ±‚å“ç±» | å®¢æˆ·çŠ¶æ€ | è–ªèµ„é¢„ç®— | åœ°å€ | å¤‡æ³¨ |
|------|------|---------|--------|---------|---------|---------|------|------|
| å¼ ä¸‰ | 13800138000 | ç¾å›¢ | wx123 | æœˆå«‚ | å¾…å®š | 8000 | åŒ—äº¬å¸‚æœé˜³åŒº | å¤‡æ³¨ä¿¡æ¯ |
| æå›› | 13900139000 | æŠ–éŸ³ |  | ä½å®¶è‚²å„¿å«‚ | åŒ¹é…ä¸­ | 9000 | ä¸Šæµ·å¸‚æµ¦ä¸œæ–°åŒº |  |

## ğŸ› å¸¸è§é—®é¢˜

### Q1: ä¸Šä¼ åæç¤º"æ–‡ä»¶æ ¼å¼é”™è¯¯"
**A**: ç¡®ä¿æ–‡ä»¶æ˜¯ .xlsx æˆ– .xls æ ¼å¼ï¼Œä¸è¦ä½¿ç”¨ .csv æ ¼å¼

### Q2: å¯¼å…¥å¤±è´¥æç¤º"ç¼ºå°‘å¿…éœ€çš„åˆ—"
**A**: æ£€æŸ¥Excelç¬¬ä¸€è¡Œè¡¨å¤´æ˜¯å¦åŒ…å«ï¼šå§“åã€ç”µè¯ã€çº¿ç´¢æ¥æº

### Q3: éƒ¨åˆ†æ•°æ®å¯¼å…¥å¤±è´¥
**A**: æŸ¥çœ‹é”™è¯¯è¯¦æƒ…ï¼Œå¸¸è§åŸå› ï¼š
- æ‰‹æœºå·æ ¼å¼ä¸æ­£ç¡®ï¼ˆå¿…é¡»æ˜¯11ä½æ•°å­—ï¼‰
- æ‰‹æœºå·å·²å­˜åœ¨ï¼ˆæ•°æ®åº“ä¸­å·²æœ‰ç›¸åŒæ‰‹æœºå·ï¼‰
- çº¿ç´¢æ¥æºä¸åœ¨æšä¸¾å€¼å†…

### Q4: ä¸´æ—¶æ–‡ä»¶å ç”¨ç£ç›˜ç©ºé—´
**A**: ä¸´æ—¶æ–‡ä»¶ä¼šåœ¨å¤„ç†å®Œæˆåè‡ªåŠ¨åˆ é™¤ï¼Œå¦‚æœå¼‚å¸¸é€€å‡ºå¯æ‰‹åŠ¨æ¸…ç† `./uploads/temp` ç›®å½•

## ğŸ‰ å®Œæˆï¼

ç°åœ¨ä½ å·²ç»æˆåŠŸå®ç°äº†å®¢æˆ·æ‰¹é‡å¯¼å…¥åŠŸèƒ½ï¼

---

**æ–‡æ¡£ç‰ˆæœ¬**: 1.0  
**æœ€åæ›´æ–°**: 2025-01-11  
**ç»´æŠ¤äºº**: AI Assistant

