# å®¢æˆ·æ‰¹é‡å¯¼å…¥åŠŸèƒ½æ·±åº¦è§„åˆ’

## ğŸ“‹ éœ€æ±‚æ¦‚è¿°

å®ç°å®¢æˆ·æ‰¹é‡å¯¼å…¥åŠŸèƒ½ï¼Œæ”¯æŒé€šè¿‡Excelæ–‡ä»¶æ‰¹é‡å¯¼å…¥å®¢æˆ·æ•°æ®ã€‚

### å¯¼å…¥è¡¨å¤´è¦æ±‚
- **å§“å**ï¼ˆå¿…å¡«ï¼‰
- **ç”µè¯**ï¼ˆå¿…å¡«ï¼‰
- **çº¿ç´¢æ¥æº**ï¼ˆå¿…å¡«ï¼‰

## ğŸ¯ åŠŸèƒ½ç›®æ ‡

1. æ”¯æŒExcelæ–‡ä»¶ï¼ˆ.xlsx, .xlsï¼‰æ‰¹é‡å¯¼å…¥å®¢æˆ·
2. æä¾›æ ‡å‡†æ¨¡æ¿ä¸‹è½½
3. æ•°æ®éªŒè¯å’Œé”™è¯¯æç¤º
4. å¯¼å…¥ç»“æœç»Ÿè®¡ï¼ˆæˆåŠŸ/å¤±è´¥ï¼‰
5. æ‰‹æœºå·å»é‡å¤„ç†
6. è‡ªåŠ¨åˆ†é…ç»™åˆ›å»ºäºº

## ğŸ“ æŠ€æœ¯æ¶æ„è®¾è®¡

### 1. åç«¯æ¶æ„

#### 1.1 æŠ€æœ¯æ ˆ
- **Excelè§£æåº“**: ExcelJSï¼ˆå·²å®‰è£…åœ¨ backend/package.jsonï¼‰
- **æ–‡ä»¶ä¸Šä¼ **: Multer + FileInterceptor
- **æ•°æ®éªŒè¯**: class-validator
- **æ•°æ®åº“**: MongoDB + Mongoose

#### 1.2 æ ¸å¿ƒæ¨¡å—

```
backend/src/modules/customers/
â”œâ”€â”€ customers.controller.ts      # æ·»åŠ å¯¼å…¥æ¥å£
â”œâ”€â”€ customers.service.ts         # æ·»åŠ å¯¼å…¥é€»è¾‘
â””â”€â”€ dto/
    â””â”€â”€ create-customer.dto.ts   # å·²æœ‰éªŒè¯è§„åˆ™
```

### 2. å‰ç«¯æ¶æ„

#### 2.1 æŠ€æœ¯æ ˆ
- **UIç»„ä»¶**: Ant Design (Upload.Dragger, Modal, Button)
- **HTTPè¯·æ±‚**: apiService
- **çŠ¶æ€ç®¡ç†**: React Hooks (useState)

#### 2.2 æ ¸å¿ƒç»„ä»¶

```
frontend/src/pages/customers/
â””â”€â”€ CustomerList.tsx             # æ·»åŠ å¯¼å…¥åŠŸèƒ½
```

## ğŸ”§ è¯¦ç»†å®ç°æ–¹æ¡ˆ

### é˜¶æ®µä¸€ï¼šåç«¯å®ç°

#### 1. åˆ›å»ºå¯¼å…¥æ¥å£ï¼ˆcustomers.controller.tsï¼‰

**æ¥å£è·¯å¾„**: `POST /api/customers/import-excel`

**åŠŸèƒ½ç‰¹æ€§**:
- ä½¿ç”¨ `FileInterceptor` å¤„ç†æ–‡ä»¶ä¸Šä¼ 
- æ–‡ä»¶å­˜å‚¨åœ¨ `./uploads/temp` ä¸´æ—¶ç›®å½•
- æ–‡ä»¶ç±»å‹éªŒè¯ï¼ˆä»…æ”¯æŒ .xlsx, .xlsï¼‰
- æ–‡ä»¶å¤§å°é™åˆ¶ï¼ˆå»ºè®®10MBï¼‰
- æ”¯æŒJWTè®¤è¯å’Œè§’è‰²æƒé™æ§åˆ¶

**å‚è€ƒå®ç°**: 
- ç®€å†å¯¼å…¥æ¥å£: `backend/src/modules/resume/resume.controller.ts` (247-304è¡Œ)

#### 2. å®ç°å¯¼å…¥æœåŠ¡ï¼ˆcustomers.service.tsï¼‰

**æ ¸å¿ƒæ–¹æ³•**: `importFromExcel(filePath: string, userId: string)`

**å¤„ç†æµç¨‹**:

```typescript
1. ä½¿ç”¨ ExcelJS è¯»å–æ–‡ä»¶
   â”œâ”€â”€ è¯»å–ç¬¬ä¸€ä¸ªå·¥ä½œè¡¨
   â”œâ”€â”€ éªŒè¯å·¥ä½œè¡¨æ˜¯å¦å­˜åœ¨
   â””â”€â”€ éªŒè¯æ˜¯å¦æœ‰æ•°æ®è¡Œ

2. è§£æè¡¨å¤´
   â”œâ”€â”€ è¯»å–ç¬¬ä¸€è¡Œä½œä¸ºè¡¨å¤´
   â”œâ”€â”€ éªŒè¯å¿…éœ€åˆ—: ['å§“å', 'ç”µè¯', 'çº¿ç´¢æ¥æº']
   â””â”€â”€ å¦‚æœç¼ºå°‘å¿…éœ€åˆ—ï¼ŒæŠ›å‡ºå¼‚å¸¸

3. é€è¡Œè§£ææ•°æ®
   â”œâ”€â”€ ä»ç¬¬2è¡Œå¼€å§‹éå†ï¼ˆè·³è¿‡è¡¨å¤´ï¼‰
   â”œâ”€â”€ æå–æ¯è¡Œçš„å•å…ƒæ ¼æ•°æ®
   â”œâ”€â”€ éªŒè¯å¿…å¡«å­—æ®µ
   â”œâ”€â”€ æ˜ å°„ä¸º CreateCustomerDto
   â””â”€â”€ å¼‚æ­¥åˆ›å»ºå®¢æˆ·è®°å½•

4. ç»Ÿè®¡ç»“æœ
   â”œâ”€â”€ æˆåŠŸæ•°é‡
   â”œâ”€â”€ å¤±è´¥æ•°é‡
   â””â”€â”€ é”™è¯¯è¯¦æƒ…åˆ—è¡¨

5. æ¸…ç†ä¸´æ—¶æ–‡ä»¶
   â””â”€â”€ åˆ é™¤ä¸Šä¼ çš„Excelæ–‡ä»¶
```

**æ•°æ®æ˜ å°„æ–¹æ³•**: `mapExcelRowToCustomerDto(rowData, userId)`

**å­—æ®µæ˜ å°„è§„åˆ™**:

| Excelåˆ—å | DTOå­—æ®µ | ç±»å‹ | å¿…å¡« | é»˜è®¤å€¼ | è¯´æ˜ |
|----------|---------|------|------|--------|------|
| å§“å | name | string | âœ… | - | å®¢æˆ·å§“å |
| ç”µè¯ | phone | string | âœ… | - | æ‰‹æœºå·ï¼Œéœ€éªŒè¯æ ¼å¼ |
| çº¿ç´¢æ¥æº | leadSource | string | âœ… | - | å¿…é¡»åœ¨æšä¸¾å€¼å†… |
| å¾®ä¿¡å· | wechatId | string | âŒ | - | å¯é€‰ |
| èº«ä»½è¯å· | idCardNumber | string | âŒ | - | å¯é€‰ |
| éœ€æ±‚å“ç±» | serviceCategory | string | âŒ | - | å¯é€‰ï¼Œéœ€æ˜ å°„æšä¸¾ |
| å®¢æˆ·çŠ¶æ€ | contractStatus | string | âŒ | 'å¾…å®š' | é»˜è®¤ä¸ºå¾…å®š |
| çº¿ç´¢ç­‰çº§ | leadLevel | string | âŒ | - | å¯é€‰ |
| è–ªèµ„é¢„ç®— | salaryBudget | number | âŒ | - | éœ€è½¬æ¢ä¸ºæ•°å­— |
| æœŸæœ›ä¸Šæˆ·æ—¥æœŸ | expectedStartDate | string | âŒ | - | æ—¥æœŸæ ¼å¼ |
| å®¶åº­é¢ç§¯ | homeArea | number | âŒ | - | éœ€è½¬æ¢ä¸ºæ•°å­— |
| å®¶åº­äººå£ | familySize | number | âŒ | - | éœ€è½¬æ¢ä¸ºæ•°å­— |
| ä¼‘æ¯åˆ¶åº¦ | restSchedule | string | âŒ | - | å¯é€‰ï¼Œéœ€æ˜ å°„æšä¸¾ |
| åœ°å€ | address | string | âŒ | - | å¯é€‰ |
| å¤‡æ³¨ | remarks | string | âŒ | - | å¯é€‰ |

**çº¿ç´¢æ¥æºæšä¸¾æ˜ å°„**:
```typescript
const leadSourceMap = {
  'ç¾å›¢': 'ç¾å›¢',
  'æŠ–éŸ³': 'æŠ–éŸ³',
  'å¿«æ‰‹': 'å¿«æ‰‹',
  'å°çº¢ä¹¦': 'å°çº¢ä¹¦',
  'è½¬ä»‹ç»': 'è½¬ä»‹ç»',
  'æ­å·åŒé¦¨': 'æ­å·åŒé¦¨',
  'æ¡ä¸ªæ‰‹å¹³å°': 'æ¡ä¸ªæ‰‹å¹³å°',
  'çº¿ç´¢è´­ä¹°': 'çº¿ç´¢è´­ä¹°',
  'å…¶ä»–': 'å…¶ä»–'
};
```

**éœ€æ±‚å“ç±»æšä¸¾æ˜ å°„**:
```typescript
const serviceCategoryMap = {
  'æœˆå«‚': 'æœˆå«‚',
  'ä½å®¶è‚²å„¿å«‚': 'ä½å®¶è‚²å„¿å«‚',
  'ä¿æ´': 'ä¿æ´',
  'ä½å®¶ä¿å§†': 'ä½å®¶ä¿å§†',
  'å…»å® ': 'å…»å® ',
  'å°æ—¶å·¥': 'å°æ—¶å·¥',
  'ç™½ç­è‚²å„¿': 'ç™½ç­è‚²å„¿',
  'ç™½ç­ä¿å§†': 'ç™½ç­ä¿å§†',
  'ä½å®¶æŠ¤è€': 'ä½å®¶æŠ¤è€'
};
```

**å®¢æˆ·çŠ¶æ€æšä¸¾æ˜ å°„**:
```typescript
const contractStatusMap = {
  'å·²ç­¾çº¦': 'å·²ç­¾çº¦',
  'åŒ¹é…ä¸­': 'åŒ¹é…ä¸­',
  'æµå¤±å®¢æˆ·': 'æµå¤±å®¢æˆ·',
  'å·²é€€æ¬¾': 'å·²é€€æ¬¾',
  'é€€æ¬¾ä¸­': 'é€€æ¬¾ä¸­',
  'å¾…å®š': 'å¾…å®š'
};
```

**ä¼‘æ¯åˆ¶åº¦æšä¸¾æ˜ å°„**:
```typescript
const restScheduleMap = {
  'å•ä¼‘': 'å•ä¼‘',
  'åŒä¼‘': 'åŒä¼‘',
  'æ— ä¼‘': 'æ— ä¼‘',
  'è°ƒä¼‘': 'è°ƒä¼‘',
  'å¾…å®š': 'å¾…å®š'
};
```

**çº¿ç´¢ç­‰çº§æšä¸¾æ˜ å°„**:
```typescript
const leadLevelMap = {
  'Aç±»': 'Aç±»',
  'Bç±»': 'Bç±»',
  'Cç±»': 'Cç±»',
  'Dç±»': 'Dç±»'
};
```

#### 3. æ•°æ®éªŒè¯è§„åˆ™

**æ‰‹æœºå·éªŒè¯**:
- ä½¿ç”¨ `@IsPhoneNumber('CN')` éªŒè¯ä¸­å›½æ‰‹æœºå·
- æ ¼å¼: 11ä½æ•°å­—ï¼Œ1å¼€å¤´

**æ‰‹æœºå·å»é‡**:
- åœ¨åˆ›å»ºå‰æ£€æŸ¥æ‰‹æœºå·æ˜¯å¦å·²å­˜åœ¨
- å¦‚æœå­˜åœ¨ï¼Œè®°å½•ä¸ºå¤±è´¥ï¼Œé”™è¯¯ä¿¡æ¯: "æ‰‹æœºå·å·²å­˜åœ¨"

**çº¿ç´¢æ¥æºéªŒè¯**:
- å¿…é¡»åœ¨æšä¸¾å€¼å†…: ['ç¾å›¢', 'æŠ–éŸ³', 'å¿«æ‰‹', 'å°çº¢ä¹¦', 'è½¬ä»‹ç»', 'æ­å·åŒé¦¨', 'æ¡ä¸ªæ‰‹å¹³å°', 'çº¿ç´¢è´­ä¹°', 'å…¶ä»–']
- å¦‚æœä¸åœ¨æšä¸¾å†…ï¼Œè®°å½•ä¸ºå¤±è´¥

**æ•°å­—å­—æ®µéªŒè¯**:
- salaryBudget: 1000-50000
- homeArea: 10-1000
- familySize: 1-20

#### 4. é”™è¯¯å¤„ç†

**é”™è¯¯ç±»å‹**:
1. æ–‡ä»¶æ ¼å¼é”™è¯¯: "ä»…æ”¯æŒ .xlsx æˆ– .xls æ ¼å¼çš„Excelæ–‡ä»¶"
2. ç¼ºå°‘å¿…éœ€åˆ—: "Excelæ–‡ä»¶ç¼ºå°‘å¿…éœ€çš„åˆ—: xxx"
3. ç¼ºå°‘å¿…å¡«å­—æ®µ: "ç¬¬ X è¡Œç¼ºå°‘å¿…å¡«å­—æ®µ"
4. æ‰‹æœºå·é‡å¤: "ç¬¬ X è¡Œå¯¼å…¥å¤±è´¥: æ‰‹æœºå·å·²å­˜åœ¨"
5. æ•°æ®éªŒè¯å¤±è´¥: "ç¬¬ X è¡Œå¯¼å…¥å¤±è´¥: xxx"

**è¿”å›æ ¼å¼**:
```typescript
{
  success: true,
  data: {
    success: 10,  // æˆåŠŸå¯¼å…¥æ•°é‡
    fail: 2,      // å¤±è´¥æ•°é‡
    errors: [     // é”™è¯¯è¯¦æƒ…
      "ç¬¬ 3 è¡Œå¯¼å…¥å¤±è´¥: æ‰‹æœºå·å·²å­˜åœ¨",
      "ç¬¬ 5 è¡Œç¼ºå°‘å¿…å¡«å­—æ®µ"
    ]
  },
  message: "æˆåŠŸå¯¼å…¥ 10 æ¡å®¢æˆ·ï¼Œå¤±è´¥ 2 æ¡"
}
```

### é˜¶æ®µäºŒï¼šå‰ç«¯å®ç°

#### 1. æ·»åŠ å¯¼å…¥æŒ‰é’®ï¼ˆCustomerList.tsxï¼‰

**ä½ç½®**: å®¢æˆ·åˆ—è¡¨é¡µé¢é¡¶éƒ¨æ“ä½œåŒº

**æŒ‰é’®è®¾è®¡**:
```tsx
<Button 
  type="default" 
  icon={<UploadOutlined />}
  onClick={() => setImportModalVisible(true)}
>
  æ‰¹é‡å¯¼å…¥
</Button>
```

#### 2. å®ç°å¯¼å…¥å¼¹çª—

**çŠ¶æ€ç®¡ç†**:
```typescript
const [importModalVisible, setImportModalVisible] = useState(false);
const [importLoading, setImportLoading] = useState(false);
const [importResult, setImportResult] = useState<{
  success: number;
  fail: number;
  errors: string[];
} | null>(null);
```

**å¼¹çª—ç»“æ„**:
```tsx
<Modal
  title="æ‰¹é‡å¯¼å…¥å®¢æˆ·"
  open={importModalVisible}
  onCancel={handleCloseImport}
  footer={[
    <Button key="download" onClick={downloadExcelTemplate}>
      ä¸‹è½½æ¨¡æ¿
    </Button>,
    <Button key="cancel" onClick={handleCloseImport}>
      å…³é—­
    </Button>,
  ]}
>
  {!importResult ? (
    // ä¸Šä¼ åŒºåŸŸ
  ) : (
    // ç»“æœå±•ç¤º
  )}
</Modal>
```

#### 3. å®ç°æ–‡ä»¶ä¸Šä¼ 

**ä¸Šä¼ ç»„ä»¶**:
```tsx
<Upload.Dragger
  name="file"
  multiple={false}
  showUploadList={false}
  customRequest={handleExcelImport}
  disabled={importLoading}
>
  <p className="ant-upload-drag-icon">
    <InboxOutlined />
  </p>
  <p className="ant-upload-text">ç‚¹å‡»æˆ–æ‹–æ‹½æ–‡ä»¶åˆ°æ­¤åŒºåŸŸä¸Šä¼ </p>
  <p className="ant-upload-hint">
    æ”¯æŒ .xlsx, .xls æ ¼å¼
  </p>
</Upload.Dragger>
```

**ä¸Šä¼ å¤„ç†**:
```typescript
const handleExcelImport = async (options) => {
  setImportLoading(true);
  setImportResult(null);
  
  try {
    const { file } = options;
    
    // éªŒè¯æ–‡ä»¶ç±»å‹
    const isExcel = 
      file.name.endsWith('.xlsx') || 
      file.name.endsWith('.xls');
    
    if (!isExcel) {
      message.error('åªæ”¯æŒExcelæ–‡ä»¶(.xlsx, .xls)');
      return;
    }
    
    // å‡†å¤‡è¡¨å•æ•°æ®
    const formData = new FormData();
    formData.append('file', file);
    
    // å‘é€è¯·æ±‚
    const response = await apiService.upload(
      '/api/customers/import-excel', 
      formData
    );
    
    if (response.success) {
      message.success(response.message);
      setImportResult(response.data);
      
      // åˆ·æ–°åˆ—è¡¨
      loadCustomers(1, pageSize);
      
      // å…¨éƒ¨æˆåŠŸè‡ªåŠ¨å…³é—­
      if (response.data.success > 0 && response.data.fail === 0) {
        setTimeout(() => {
          setImportModalVisible(false);
        }, 2000);
      }
    }
  } catch (error) {
    message.error('å¯¼å…¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æ ¼å¼');
  } finally {
    setImportLoading(false);
  }
};
```

#### 4. å®ç°æ¨¡æ¿ä¸‹è½½

**æ¨¡æ¿ç»“æ„**:
```typescript
const downloadExcelTemplate = () => {
  const columns = ['å§“å', 'ç”µè¯', 'çº¿ç´¢æ¥æº', 'å¾®ä¿¡å·', 'éœ€æ±‚å“ç±»', 'å®¢æˆ·çŠ¶æ€', 'è–ªèµ„é¢„ç®—', 'åœ°å€', 'å¤‡æ³¨'];
  const data = [
    ['å¼ ä¸‰', '13800138000', 'ç¾å›¢', 'wx123', 'æœˆå«‚', 'å¾…å®š', '8000', 'åŒ—äº¬å¸‚æœé˜³åŒº', 'å¤‡æ³¨ä¿¡æ¯'],
    ['æå››', '13900139000', 'æŠ–éŸ³', '', 'ä½å®¶è‚²å„¿å«‚', 'åŒ¹é…ä¸­', '9000', 'ä¸Šæµ·å¸‚æµ¦ä¸œæ–°åŒº', '']
  ];
  
  // åˆ›å»ºCSVå†…å®¹
  let csv = columns.join(',') + '\n';
  data.forEach(row => {
    csv += row.join(',') + '\n';
  });
  
  // åˆ›å»ºBlobå¹¶ä¸‹è½½
  const blob = new Blob(['\ufeff' + csv], { 
    type: 'text/csv;charset=utf-8;' 
  });
  const link = document.createElement('a');
  const url = URL.createObjectURL(blob);
  link.setAttribute('href', url);
  link.setAttribute('download', 'å®¢æˆ·å¯¼å…¥æ¨¡æ¿.csv');
  link.style.visibility = 'hidden';
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
};
```

#### 5. å®ç°ç»“æœå±•ç¤º

**ç»“æœUI**:
```tsx
{importResult && (
  <div>
    <h3>å¯¼å…¥ç»“æœ</h3>
    <p>
      æˆåŠŸå¯¼å…¥: 
      <span style={{ color: 'green', fontWeight: 'bold' }}>
        {importResult.success}
      </span> æ¡
    </p>
    <p>
      å¯¼å…¥å¤±è´¥: 
      <span style={{ color: 'red', fontWeight: 'bold' }}>
        {importResult.fail}
      </span> æ¡
    </p>
    
    {importResult.errors.length > 0 && (
      <div>
        <h4>é”™è¯¯è¯¦æƒ…ï¼š</h4>
        <ul style={{ color: 'red', maxHeight: '200px', overflow: 'auto' }}>
          {importResult.errors.map((error, index) => (
            <li key={index}>{error}</li>
          ))}
        </ul>
      </div>
    )}
  </div>
)}
```

## ğŸ“ å®ç°æ­¥éª¤æ¸…å•

### åç«¯ä»»åŠ¡

- [ ] 1. åœ¨ `customers.controller.ts` æ·»åŠ å¯¼å…¥æ¥å£
  - [ ] é…ç½® FileInterceptor
  - [ ] æ·»åŠ æ–‡ä»¶éªŒè¯
  - [ ] æ·»åŠ æƒé™æ§åˆ¶
  - [ ] æ·»åŠ  Swagger æ–‡æ¡£

- [ ] 2. åœ¨ `customers.service.ts` å®ç°å¯¼å…¥é€»è¾‘
  - [ ] å®ç° `importFromExcel` æ–¹æ³•
  - [ ] å®ç° `mapExcelRowToCustomerDto` æ–¹æ³•
  - [ ] æ·»åŠ æ‰‹æœºå·å»é‡æ£€æŸ¥
  - [ ] æ·»åŠ æ•°æ®éªŒè¯
  - [ ] æ·»åŠ é”™è¯¯æ”¶é›†

- [ ] 3. æµ‹è¯•åç«¯æ¥å£
  - [ ] æµ‹è¯•æ­£å¸¸å¯¼å…¥
  - [ ] æµ‹è¯•æ–‡ä»¶æ ¼å¼é”™è¯¯
  - [ ] æµ‹è¯•ç¼ºå°‘å¿…éœ€åˆ—
  - [ ] æµ‹è¯•æ‰‹æœºå·é‡å¤
  - [ ] æµ‹è¯•æ•°æ®éªŒè¯å¤±è´¥

### å‰ç«¯ä»»åŠ¡

- [ ] 4. åœ¨ `CustomerList.tsx` æ·»åŠ å¯¼å…¥åŠŸèƒ½
  - [ ] æ·»åŠ å¯¼å…¥æŒ‰é’®
  - [ ] å®ç°å¯¼å…¥å¼¹çª—
  - [ ] å®ç°æ–‡ä»¶ä¸Šä¼ 
  - [ ] å®ç°æ¨¡æ¿ä¸‹è½½
  - [ ] å®ç°ç»“æœå±•ç¤º

- [ ] 5. æµ‹è¯•å‰ç«¯åŠŸèƒ½
  - [ ] æµ‹è¯•ä¸Šä¼ æµç¨‹
  - [ ] æµ‹è¯•æ¨¡æ¿ä¸‹è½½
  - [ ] æµ‹è¯•ç»“æœå±•ç¤º
  - [ ] æµ‹è¯•é”™è¯¯æç¤º

### é›†æˆæµ‹è¯•

- [ ] 6. ç«¯åˆ°ç«¯æµ‹è¯•
  - [ ] ä¸‹è½½æ¨¡æ¿
  - [ ] å¡«å†™æ•°æ®
  - [ ] ä¸Šä¼ å¯¼å…¥
  - [ ] éªŒè¯ç»“æœ
  - [ ] æ£€æŸ¥æ•°æ®åº“

## ğŸ¨ ç”¨æˆ·ä½“éªŒä¼˜åŒ–

1. **åŠ è½½çŠ¶æ€**: ä¸Šä¼ æ—¶æ˜¾ç¤º loading åŠ¨ç”»
2. **è¿›åº¦æç¤º**: æ˜¾ç¤º"æ­£åœ¨å¤„ç†..."
3. **æˆåŠŸæç¤º**: å…¨éƒ¨æˆåŠŸè‡ªåŠ¨å…³é—­å¼¹çª—
4. **é”™è¯¯æç¤º**: è¯¦ç»†åˆ—å‡ºæ¯è¡Œé”™è¯¯
5. **æ¨¡æ¿ä¸‹è½½**: æä¾›ç¤ºä¾‹æ•°æ®
6. **æ–‡ä»¶éªŒè¯**: å‰ç«¯é¢„éªŒè¯æ–‡ä»¶ç±»å‹

## ğŸ”’ å®‰å…¨è€ƒè™‘

1. **æ–‡ä»¶å¤§å°é™åˆ¶**: æœ€å¤§10MB
2. **æ–‡ä»¶ç±»å‹é™åˆ¶**: ä»…æ”¯æŒ .xlsx, .xls
3. **æƒé™æ§åˆ¶**: éœ€è¦ç™»å½•å’Œç›¸åº”è§’è‰²æƒé™
4. **ä¸´æ—¶æ–‡ä»¶æ¸…ç†**: å¤„ç†å®Œç«‹å³åˆ é™¤
5. **æ•°æ®éªŒè¯**: åç«¯ä¸¥æ ¼éªŒè¯æ‰€æœ‰å­—æ®µ

## ğŸ“Š æ€§èƒ½ä¼˜åŒ–

1. **å¼‚æ­¥å¤„ç†**: ä½¿ç”¨ Promise.all å¹¶å‘åˆ›å»º
2. **æ‰¹é‡æ“ä½œ**: ä¸€æ¬¡æ€§å¤„ç†æ‰€æœ‰è¡Œ
3. **é”™è¯¯æ”¶é›†**: ä¸ä¸­æ–­å¤„ç†æµç¨‹
4. **å†…å­˜ç®¡ç†**: åŠæ—¶æ¸…ç†ä¸´æ—¶æ–‡ä»¶

## ğŸ§ª æµ‹è¯•ç”¨ä¾‹

### æµ‹è¯•æ•°æ®

**æ­£å¸¸æ•°æ®**:
```csv
å§“å,ç”µè¯,çº¿ç´¢æ¥æº
å¼ ä¸‰,13800138000,ç¾å›¢
æå››,13900139000,æŠ–éŸ³
```

**å¼‚å¸¸æ•°æ®**:
```csv
å§“å,ç”µè¯,çº¿ç´¢æ¥æº
ç‹äº”,138001380,ç¾å›¢          # æ‰‹æœºå·æ ¼å¼é”™è¯¯
èµµå…­,13800138001,æœªçŸ¥æ¥æº    # çº¿ç´¢æ¥æºä¸åœ¨æšä¸¾å†…
,13800138002,å¿«æ‰‹            # ç¼ºå°‘å§“å
```

## ğŸ“… å¼€å‘æ—¶é—´ä¼°ç®—

- åç«¯å¼€å‘: 4å°æ—¶
- å‰ç«¯å¼€å‘: 3å°æ—¶
- æµ‹è¯•è°ƒè¯•: 2å°æ—¶
- æ–‡æ¡£ç¼–å†™: 1å°æ—¶
- **æ€»è®¡**: 10å°æ—¶

## ğŸš€ éƒ¨ç½²è¯´æ˜

1. ç¡®ä¿ `./uploads/temp` ç›®å½•å­˜åœ¨ä¸”æœ‰å†™æƒé™
2. åç«¯é‡å¯ä»¥åŠ è½½æ–°æ¥å£
3. å‰ç«¯é‡æ–°æ„å»ºå¹¶éƒ¨ç½²
4. éªŒè¯åŠŸèƒ½æ­£å¸¸

## ğŸ¯ æ ¸å¿ƒä»£ç ç¤ºä¾‹

### åç«¯æ ¸å¿ƒä»£ç 

#### customers.controller.ts - å¯¼å…¥æ¥å£

```typescript
@Post('import-excel')
@ApiOperation({ summary: 'æ‰¹é‡å¯¼å…¥å®¢æˆ·ï¼ˆExcelæ ¼å¼ï¼‰' })
@ApiConsumes('multipart/form-data')
@ApiBody({
  schema: {
    type: 'object',
    properties: {
      file: {
        type: 'string',
        format: 'binary',
        description: 'Excelæ–‡ä»¶',
      },
    },
  },
})
@UseInterceptors(FileInterceptor('file', {
  storage: diskStorage({
    destination: './uploads/temp',
    filename: (req, file, callback) => {
      const uniqueSuffix = Date.now() + '-' + Math.round(Math.random() * 1e9);
      const extension = extname(file.originalname);
      callback(null, `customer-excel-${uniqueSuffix}${extension}`);
    },
  }),
  fileFilter: (req, file, callback) => {
    const ext = extname(file.originalname).toLowerCase();
    if (!['.xlsx', '.xls'].includes(ext)) {
      return callback(new BadRequestException('ä»…æ”¯æŒ .xlsx æˆ– .xls æ ¼å¼çš„Excelæ–‡ä»¶'), false);
    }
    callback(null, true);
  },
}))
async importExcel(
  @UploadedFile() file: Express.Multer.File,
  @Req() req,
) {
  try {
    if (!file) {
      throw new BadRequestException('è¯·ä¸Šä¼ Excelæ–‡ä»¶');
    }

    this.logger.log(`å¼€å§‹å¤„ç†å®¢æˆ·Excelå¯¼å…¥ï¼Œæ–‡ä»¶å: ${file.originalname}`);
    const importResults = await this.customersService.importFromExcel(file.path, req.user.userId);

    return {
      success: true,
      data: importResults,
      message: `æˆåŠŸå¯¼å…¥ ${importResults.success} æ¡å®¢æˆ·ï¼Œå¤±è´¥ ${importResults.fail} æ¡`
    };
  } catch (error) {
    this.logger.error(`å®¢æˆ·Excelå¯¼å…¥å¤±è´¥: ${error.message}`);
    return {
      success: false,
      data: null,
      message: `Excelå¯¼å…¥å¤±è´¥: ${error.message}`
    };
  }
}
```

#### customers.service.ts - å¯¼å…¥é€»è¾‘

```typescript
async importFromExcel(filePath: string, userId: string): Promise<{ success: number; fail: number; errors: string[] }> {
  this.logger.log(`å¼€å§‹å¤„ç†å®¢æˆ·Excelæ–‡ä»¶å¯¼å…¥: ${filePath}`);

  const result = {
    success: 0,
    fail: 0,
    errors: [] as string[]
  };

  try {
    const workbook = new ExcelJS.Workbook();
    await workbook.xlsx.readFile(filePath);

    const worksheet = workbook.getWorksheet(1);
    if (!worksheet) {
      throw new BadRequestException('Excelæ–‡ä»¶ä¸­æ²¡æœ‰æ‰¾åˆ°å·¥ä½œè¡¨');
    }

    if (worksheet.rowCount <= 1) {
      throw new BadRequestException('Excelæ–‡ä»¶ä¸­æ²¡æœ‰æ•°æ®');
    }

    // è·å–è¡¨å¤´
    const headerRow = worksheet.getRow(1);
    const headers: string[] = [];
    headerRow.eachCell((cell, colNumber) => {
      headers[colNumber - 1] = cell.value?.toString().trim() || '';
    });

    // æ£€æŸ¥å¿…éœ€çš„åˆ—
    const requiredColumns = ['å§“å', 'ç”µè¯', 'çº¿ç´¢æ¥æº'];
    const missingColumns = requiredColumns.filter(col => !headers.includes(col));

    if (missingColumns.length > 0) {
      throw new BadRequestException(`Excelæ–‡ä»¶ç¼ºå°‘å¿…éœ€çš„åˆ—: ${missingColumns.join(', ')}`);
    }

    // è§£ææ¯ä¸€è¡Œæ•°æ®
    const promises = [];

    for (let rowNumber = 2; rowNumber <= worksheet.rowCount; rowNumber++) {
      const row = worksheet.getRow(rowNumber);
      const rowData: Record<string, any> = {};

      row.eachCell((cell, colNumber) => {
        const header = headers[colNumber - 1];
        if (header) {
          rowData[header] = cell.value;
        }
      });

      // æ£€æŸ¥å¿…å¡«å­—æ®µ
      if (!rowData['å§“å'] || !rowData['ç”µè¯'] || !rowData['çº¿ç´¢æ¥æº']) {
        result.fail++;
        result.errors.push(`ç¬¬ ${rowNumber} è¡Œç¼ºå°‘å¿…å¡«å­—æ®µ`);
        continue;
      }

      // è½¬æ¢æ•°æ®ä¸ºDTOæ ¼å¼
      const customerData = this.mapExcelRowToCustomerDto(rowData, userId);

      // åˆ›å»ºå®¢æˆ·(å¼‚æ­¥)
      promises.push(
        this.create(customerData, userId)
          .then(() => {
            result.success++;
          })
          .catch(error => {
            result.fail++;
            const errorMsg = error.message || 'æœªçŸ¥é”™è¯¯';
            result.errors.push(`ç¬¬ ${rowNumber} è¡Œå¯¼å…¥å¤±è´¥: ${errorMsg}`);
          })
      );
    }

    // ç­‰å¾…æ‰€æœ‰åˆ›å»ºæ“ä½œå®Œæˆ
    await Promise.all(promises);

    // æ¸…ç†ä¸´æ—¶æ–‡ä»¶
    fs.unlinkSync(filePath);

    this.logger.log(`å®¢æˆ·Excelå¯¼å…¥å®Œæˆï¼ŒæˆåŠŸ: ${result.success}, å¤±è´¥: ${result.fail}`);
    return result;
  } catch (error) {
    // æ¸…ç†ä¸´æ—¶æ–‡ä»¶
    if (fs.existsSync(filePath)) {
      fs.unlinkSync(filePath);
    }

    this.logger.error(`å®¢æˆ·Excelå¯¼å…¥è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯: ${error.message}`);
    throw error;
  }
}

private mapExcelRowToCustomerDto(rowData: Record<string, any>, userId: string): CreateCustomerDto {
  const dto: any = {
    name: rowData['å§“å']?.toString().trim(),
    phone: rowData['ç”µè¯']?.toString().trim(),
    leadSource: rowData['çº¿ç´¢æ¥æº']?.toString().trim(),
    contractStatus: rowData['å®¢æˆ·çŠ¶æ€']?.toString().trim() || 'å¾…å®š',
  };

  // å¯é€‰å­—æ®µ
  if (rowData['å¾®ä¿¡å·']) {
    dto.wechatId = rowData['å¾®ä¿¡å·']?.toString().trim();
  }

  if (rowData['èº«ä»½è¯å·']) {
    dto.idCardNumber = rowData['èº«ä»½è¯å·']?.toString().trim();
  }

  if (rowData['éœ€æ±‚å“ç±»']) {
    dto.serviceCategory = rowData['éœ€æ±‚å“ç±»']?.toString().trim();
  }

  if (rowData['çº¿ç´¢ç­‰çº§']) {
    dto.leadLevel = rowData['çº¿ç´¢ç­‰çº§']?.toString().trim();
  }

  if (rowData['è–ªèµ„é¢„ç®—']) {
    dto.salaryBudget = Number(rowData['è–ªèµ„é¢„ç®—']) || undefined;
  }

  if (rowData['æœŸæœ›ä¸Šæˆ·æ—¥æœŸ']) {
    dto.expectedStartDate = rowData['æœŸæœ›ä¸Šæˆ·æ—¥æœŸ']?.toString().trim();
  }

  if (rowData['å®¶åº­é¢ç§¯']) {
    dto.homeArea = Number(rowData['å®¶åº­é¢ç§¯']) || undefined;
  }

  if (rowData['å®¶åº­äººå£']) {
    dto.familySize = Number(rowData['å®¶åº­äººå£']) || undefined;
  }

  if (rowData['ä¼‘æ¯åˆ¶åº¦']) {
    dto.restSchedule = rowData['ä¼‘æ¯åˆ¶åº¦']?.toString().trim();
  }

  if (rowData['åœ°å€']) {
    dto.address = rowData['åœ°å€']?.toString().trim();
  }

  if (rowData['å¤‡æ³¨']) {
    dto.remarks = rowData['å¤‡æ³¨']?.toString().trim();
  }

  return dto as CreateCustomerDto;
}
```

### å‰ç«¯æ ¸å¿ƒä»£ç 

#### CustomerList.tsx - å¯¼å…¥åŠŸèƒ½

```typescript
// çŠ¶æ€å®šä¹‰
const [importModalVisible, setImportModalVisible] = useState(false);
const [importLoading, setImportLoading] = useState(false);
const [importResult, setImportResult] = useState<{
  success: number;
  fail: number;
  errors: string[];
} | null>(null);

// å¤„ç†Excelå¯¼å…¥
const handleExcelImport: UploadProps['customRequest'] = async (options) => {
  setImportLoading(true);
  setImportResult(null);

  try {
    const { file } = options;
    const uploadFile = file as File;

    // éªŒè¯æ–‡ä»¶ç±»å‹
    const isExcel =
      uploadFile.name.endsWith('.xlsx') ||
      uploadFile.name.endsWith('.xls') ||
      uploadFile.type === 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' ||
      uploadFile.type === 'application/vnd.ms-excel';

    if (!isExcel) {
      message.error('åªæ”¯æŒExcelæ–‡ä»¶(.xlsx, .xls)');
      setImportLoading(false);
      return;
    }

    // å‡†å¤‡è¡¨å•æ•°æ®
    const formData = new FormData();
    formData.append('file', uploadFile);

    // å‘é€è¯·æ±‚
    const response = await apiService.upload('/api/customers/import-excel', formData);

    if (response.success) {
      message.success(response.message || 'å¯¼å…¥æˆåŠŸ');
      setImportResult(response.data);

      // åˆ·æ–°åˆ—è¡¨
      loadCustomers(1, pageSize);

      // å¦‚æœå¯¼å…¥å…¨éƒ¨æˆåŠŸä¸”æ²¡æœ‰é”™è¯¯ï¼Œè‡ªåŠ¨å…³é—­å¼¹çª—
      if (response.data.success > 0 && response.data.fail === 0) {
        setTimeout(() => {
          setImportModalVisible(false);
        }, 2000);
      }
    } else {
      message.error(response.message || 'å¯¼å…¥å¤±è´¥');
    }
  } catch (error) {
    console.error('å¯¼å…¥Excelå¤±è´¥:', error);
    message.error('å¯¼å…¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æ ¼å¼æˆ–ç½‘ç»œè¿æ¥');
  } finally {
    setImportLoading(false);
  }
};

// ä¸‹è½½Excelå¯¼å…¥æ¨¡æ¿
const downloadExcelTemplate = () => {
  const columns = ['å§“å', 'ç”µè¯', 'çº¿ç´¢æ¥æº', 'å¾®ä¿¡å·', 'éœ€æ±‚å“ç±»', 'å®¢æˆ·çŠ¶æ€', 'è–ªèµ„é¢„ç®—', 'åœ°å€', 'å¤‡æ³¨'];
  const data = [
    ['å¼ ä¸‰', '13800138000', 'ç¾å›¢', 'wx123', 'æœˆå«‚', 'å¾…å®š', '8000', 'åŒ—äº¬å¸‚æœé˜³åŒº', 'å¤‡æ³¨ä¿¡æ¯'],
    ['æå››', '13900139000', 'æŠ–éŸ³', '', 'ä½å®¶è‚²å„¿å«‚', 'åŒ¹é…ä¸­', '9000', 'ä¸Šæµ·å¸‚æµ¦ä¸œæ–°åŒº', '']
  ];

  // åˆ›å»ºCSVå†…å®¹ï¼ˆæ·»åŠ BOMä»¥æ”¯æŒä¸­æ–‡ï¼‰
  let csv = '\ufeff' + columns.join(',') + '\n';
  data.forEach(row => {
    csv += row.join(',') + '\n';
  });

  // åˆ›å»ºBlobå¹¶ä¸‹è½½
  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const link = document.createElement('a');
  const url = URL.createObjectURL(blob);
  link.setAttribute('href', url);
  link.setAttribute('download', 'å®¢æˆ·å¯¼å…¥æ¨¡æ¿.csv');
  link.style.visibility = 'hidden';
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
};

// å…³é—­å¯¼å…¥ç»“æœå¹¶é‡ç½®çŠ¶æ€
const handleCloseImport = () => {
  setImportModalVisible(false);
  setImportResult(null);
};
```

## ğŸ“Š ä¸ç®€å†å¯¼å…¥åŠŸèƒ½å¯¹æ¯”

| ç‰¹æ€§ | ç®€å†å¯¼å…¥ | å®¢æˆ·å¯¼å…¥ |
|------|---------|---------|
| å¿…å¡«å­—æ®µ | å§“åã€æ‰‹æœºå·ã€å·¥ç§ | å§“åã€ç”µè¯ã€çº¿ç´¢æ¥æº |
| æ‰‹æœºå·å»é‡ | âœ… æ”¯æŒ | âœ… æ”¯æŒ |
| æšä¸¾æ˜ å°„ | å·¥ç§ã€æ€§åˆ«ã€å­¦å†ç­‰ | çº¿ç´¢æ¥æºã€éœ€æ±‚å“ç±»ã€å®¢æˆ·çŠ¶æ€ç­‰ |
| æ•°å­—å­—æ®µ | å¹´é¾„ã€æœŸæœ›è–ªèµ„ã€å·¥ä½œç»éªŒ | è–ªèµ„é¢„ç®—ã€å®¶åº­é¢ç§¯ã€å®¶åº­äººå£ |
| æ—¥æœŸå­—æ®µ | æ—  | æœŸæœ›ä¸Šæˆ·æ—¥æœŸ |
| è‡ªåŠ¨åˆ†é… | åˆ†é…ç»™åˆ›å»ºäºº | åˆ†é…ç»™åˆ›å»ºäºº |
| é”™è¯¯å¤„ç† | è¯¦ç»†é”™è¯¯åˆ—è¡¨ | è¯¦ç»†é”™è¯¯åˆ—è¡¨ |
| ä¸´æ—¶æ–‡ä»¶æ¸…ç† | âœ… è‡ªåŠ¨æ¸…ç† | âœ… è‡ªåŠ¨æ¸…ç† |

---

**åˆ›å»ºæ—¶é—´**: 2025-01-11
**åˆ›å»ºäºº**: AI Assistant
**çŠ¶æ€**: ğŸ“‹ è§„åˆ’å®Œæˆï¼Œå¾…å¼€å‘

