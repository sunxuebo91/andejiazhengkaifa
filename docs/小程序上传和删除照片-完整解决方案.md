# å°ç¨‹åºä¸Šä¼ å’Œåˆ é™¤ç…§ç‰‡ - å®Œæ•´è§£å†³æ–¹æ¡ˆ

## ğŸ“‹ é—®é¢˜æ±‡æ€»

### é—®é¢˜1ï¼šåˆ é™¤ç…§ç‰‡åä»ç„¶å­˜åœ¨ âœ… å·²è§£å†³

**åŸå› **ï¼šå°ç¨‹åºç«¯ä½¿ç”¨äº†é”™è¯¯çš„åˆ é™¤æ–¹å¼ï¼ˆæäº¤ç©ºæ•°ç»„ï¼‰

**è§£å†³æ–¹æ¡ˆ**ï¼šä½¿ç”¨ä¸“é—¨çš„åˆ é™¤ API

```
DELETE /api/resumes/miniprogram/:id/delete-file
```

### é—®é¢˜2ï¼šä¸Šä¼ ä¸€å¼ ç…§ç‰‡æ˜¾ç¤ºä¸¤å¼  âœ… å·²è¯Šæ–­

**åŸå› **ï¼šå°ç¨‹åºç«¯çš„è°ƒç”¨é€»è¾‘æœ‰é—®é¢˜ï¼ˆé‡å¤è°ƒç”¨æˆ–é‡å¤æ·»åŠ åˆ°æœ¬åœ°çŠ¶æ€ï¼‰

**è§£å†³æ–¹æ¡ˆ**ï¼šå‚è€ƒ CRM ç«¯çš„æ­£ç¡®é€»è¾‘ï¼Œåªè°ƒç”¨ä¸€æ¬¡ä¸Šä¼ æ¥å£ï¼Œåªæ›´æ–°ä¸€æ¬¡æœ¬åœ°çŠ¶æ€

## âœ… åç«¯é€»è¾‘ç¡®è®¤

### æµ‹è¯•ç»“æœ

æˆ‘ä»¬å¯¹ CRM åç«¯è¿›è¡Œäº†å®Œæ•´æµ‹è¯•ï¼š

1. **åˆ é™¤ API æµ‹è¯•**ï¼šâœ… é€šè¿‡
   ```bash
   cd backend
   node test-delete-api.js
   ```
   ç»“æœï¼šåˆ é™¤åŠŸèƒ½æ­£å¸¸ï¼Œå­—æ®µåŒæ­¥æ­£ç¡®

2. **ä¸Šä¼  API æµ‹è¯•**ï¼šâœ… é€šè¿‡
   ```bash
   cd backend
   node test-upload-duplicate.js
   ```
   ç»“æœï¼šä¸Šä¼ ä¸€æ¬¡åªæ·»åŠ ä¸€æ¬¡ï¼Œä¸ä¼šäº§ç”Ÿé‡å¤

### ç»“è®º

**CRM åç«¯çš„é€»è¾‘æ˜¯æ­£ç¡®çš„ï¼Œå°ç¨‹åºç«¯å’Œ CRM ç«¯ä½¿ç”¨ç›¸åŒçš„åº•å±‚æ–¹æ³•ï¼Œä¸ä¼šäº§ç”Ÿé‡å¤ã€‚**

## ğŸ¯ API æ¥å£è¯´æ˜

### 1. ä¸Šä¼ æ–‡ä»¶

```
POST /api/resumes/miniprogram/:id/upload-file
```

**å‚æ•°**ï¼š
- `id`ï¼ˆURLè·¯å¾„ï¼‰ï¼šç®€å†ID
- `file`ï¼ˆFormDataï¼‰ï¼šæ–‡ä»¶
- `type`ï¼ˆFormDataï¼‰ï¼šæ–‡ä»¶ç±»å‹

**æ–‡ä»¶ç±»å‹**ï¼š
- `certificate` - æŠ€èƒ½è¯ä¹¦
- `personalPhoto` - ä¸ªäººç…§ç‰‡
- `medicalReport` - ä½“æ£€æŠ¥å‘Š
- `idCardFront` - èº«ä»½è¯æ­£é¢
- `idCardBack` - èº«ä»½è¯èƒŒé¢

**å“åº”**ï¼š
```json
{
  "success": true,
  "data": {
    "fileUrl": "https://...",
    "fileType": "certificate",
    "fileName": "photo.jpg",
    "fileSize": 123456,
    "resumeId": "xxx"
  },
  "message": "æ–‡ä»¶ä¸Šä¼ æˆåŠŸ"
}
```

### 2. åˆ é™¤æ–‡ä»¶

```
DELETE /api/resumes/miniprogram/:id/delete-file
```

**å‚æ•°**ï¼š
```json
{
  "fileUrl": "https://...",
  "fileType": "certificate"
}
```

**å“åº”**ï¼š
```json
{
  "success": true,
  "data": {
    "resumeId": "xxx",
    "deletedFileUrl": "https://...",
    "fileType": "certificate"
  },
  "message": "æ–‡ä»¶åˆ é™¤æˆåŠŸ"
}
```

## ğŸ’» å°ç¨‹åºç«¯å®Œæ•´å®ç°

```javascript
// pages/resume/edit.js
Page({
  data: {
    resumeId: '',
    certificateUrls: [],
    uploading: false
  },

  onLoad(options) {
    this.setData({ resumeId: options.id });
    this.loadResume();
  },

  // åŠ è½½ç®€å†
  async loadResume() {
    try {
      const res = await wx.request({
        url: `${API_BASE_URL}/api/resumes/miniprogram/${this.data.resumeId}`,
        method: 'GET',
        header: {
          'Authorization': `Bearer ${wx.getStorageSync('token')}`
        }
      });

      if (res.data.success) {
        this.setData({
          certificateUrls: res.data.data.certificateUrls || []
        });
      }
    } catch (error) {
      console.error('åŠ è½½ç®€å†å¤±è´¥:', error);
    }
  },

  // ä¸Šä¼ è¯ä¹¦
  async onUploadCertificate() {
    if (this.data.uploading) {
      wx.showToast({ title: 'æ­£åœ¨ä¸Šä¼ ä¸­...', icon: 'none' });
      return;
    }

    try {
      const res = await wx.chooseImage({
        count: 1,
        sizeType: ['compressed'],
        sourceType: ['album', 'camera']
      });

      await this.uploadFile(res.tempFilePaths[0], 'certificate');
    } catch (error) {
      console.error('é€‰æ‹©å›¾ç‰‡å¤±è´¥:', error);
    }
  },

  // ä¸Šä¼ æ–‡ä»¶
  async uploadFile(filePath, fileType) {
    this.setData({ uploading: true });
    wx.showLoading({ title: 'ä¸Šä¼ ä¸­...', mask: true });

    try {
      const uploadRes = await wx.uploadFile({
        url: `${API_BASE_URL}/api/resumes/miniprogram/${this.data.resumeId}/upload-file`,
        filePath: filePath,
        name: 'file',
        formData: { type: fileType },
        header: {
          'Authorization': `Bearer ${wx.getStorageSync('token')}`
        }
      });

      const data = JSON.parse(uploadRes.data);
      wx.hideLoading();

      if (data.success) {
        wx.showToast({ title: 'ä¸Šä¼ æˆåŠŸ', icon: 'success' });
        
        // âœ… åªæ·»åŠ ä¸€æ¬¡åˆ°æœ¬åœ°çŠ¶æ€
        this.setData({
          certificateUrls: [...this.data.certificateUrls, data.data.fileUrl]
        });
      } else {
        wx.showToast({ title: data.message, icon: 'none' });
      }
    } catch (error) {
      wx.hideLoading();
      console.error('ä¸Šä¼ å¤±è´¥:', error);
      wx.showToast({ title: 'ä¸Šä¼ å¤±è´¥', icon: 'none' });
    } finally {
      this.setData({ uploading: false });
    }
  },

  // åˆ é™¤è¯ä¹¦
  async onDeleteCertificate(e) {
    const { url } = e.currentTarget.dataset;

    try {
      const confirmRes = await wx.showModal({
        title: 'ç¡®è®¤åˆ é™¤',
        content: 'ç¡®å®šè¦åˆ é™¤è¿™å¼ è¯ä¹¦ç…§ç‰‡å—ï¼Ÿ'
      });

      if (!confirmRes.confirm) return;

      wx.showLoading({ title: 'åˆ é™¤ä¸­...', mask: true });

      const res = await wx.request({
        url: `${API_BASE_URL}/api/resumes/miniprogram/${this.data.resumeId}/delete-file`,
        method: 'DELETE',
        header: {
          'Authorization': `Bearer ${wx.getStorageSync('token')}`,
          'Content-Type': 'application/json'
        },
        data: {
          fileUrl: url,
          fileType: 'certificate'
        }
      });

      wx.hideLoading();

      if (res.data.success) {
        wx.showToast({ title: 'åˆ é™¤æˆåŠŸ', icon: 'success' });
        
        // ä»æœ¬åœ°çŠ¶æ€ä¸­ç§»é™¤
        this.setData({
          certificateUrls: this.data.certificateUrls.filter(u => u !== url)
        });
      } else {
        wx.showToast({ title: res.data.message, icon: 'none' });
      }
    } catch (error) {
      wx.hideLoading();
      console.error('åˆ é™¤å¤±è´¥:', error);
      wx.showToast({ title: 'åˆ é™¤å¤±è´¥', icon: 'none' });
    }
  },

  // é¢„è§ˆå›¾ç‰‡
  onPreviewImage(e) {
    const { url } = e.currentTarget.dataset;
    wx.previewImage({
      current: url,
      urls: this.data.certificateUrls
    });
  }
});
```

## ğŸ¨ WXML æ¨¡æ¿

```xml
<view class="container">
  <view class="section">
    <view class="section-title">æŠ€èƒ½è¯ä¹¦</view>
    
    <view class="image-list">
      <!-- å·²ä¸Šä¼ çš„è¯ä¹¦ -->
      <block wx:for="{{certificateUrls}}" wx:key="index">
        <view class="image-item">
          <image 
            src="{{item}}" 
            mode="aspectFill"
            bindtap="onPreviewImage"
            data-url="{{item}}"
          />
          <view 
            class="delete-btn" 
            bindtap="onDeleteCertificate"
            data-url="{{item}}"
          >
            <text>Ã—</text>
          </view>
        </view>
      </block>
      
      <!-- ä¸Šä¼ æŒ‰é’® -->
      <view 
        class="upload-btn" 
        bindtap="onUploadCertificate"
        wx:if="{{!uploading}}"
      >
        <text class="icon">+</text>
        <text class="text">æ·»åŠ è¯ä¹¦</text>
      </view>
    </view>
  </view>
</view>
```

## âš ï¸ é‡è¦æ³¨æ„äº‹é¡¹

### 1. é˜²æ­¢é‡å¤ä¸Šä¼ 

```javascript
// âœ… ä½¿ç”¨ uploading æ ‡å¿—ä½
if (this.data.uploading) {
  wx.showToast({ title: 'æ­£åœ¨ä¸Šä¼ ä¸­...', icon: 'none' });
  return;
}
```

### 2. åªè°ƒç”¨ä¸€æ¬¡ä¸Šä¼ æ¥å£

```javascript
// âœ… æ­£ç¡®
async onUploadCertificate() {
  const res = await wx.chooseImage({...});
  await this.uploadFile(res.tempFilePaths[0], 'certificate');  // åªè°ƒç”¨ä¸€æ¬¡
}

// âŒ é”™è¯¯
async onUploadCertificate() {
  const res = await wx.chooseImage({...});
  await this.uploadFile(res.tempFilePaths[0], 'certificate');  // ç¬¬ä¸€æ¬¡
  await this.uploadFile(res.tempFilePaths[0], 'certificate');  // ç¬¬äºŒæ¬¡ï¼ˆé”™è¯¯ï¼ï¼‰
}
```

### 3. åªæ›´æ–°ä¸€æ¬¡æœ¬åœ°çŠ¶æ€

```javascript
// âœ… æ­£ç¡®
if (data.success) {
  this.setData({
    certificateUrls: [...this.data.certificateUrls, data.data.fileUrl]
  });
}

// âŒ é”™è¯¯
if (data.success) {
  this.setData({
    certificateUrls: [...this.data.certificateUrls, data.data.fileUrl]
  });
  this.setData({
    certificateUrls: [...this.data.certificateUrls, data.data.fileUrl]  // é‡å¤ï¼
  });
}
```

### 4. ä¸è¦åœ¨ä¸Šä¼ åè°ƒç”¨æ›´æ–°æ¥å£

```javascript
// âœ… æ­£ç¡®ï¼šä¸Šä¼ æ¥å£å·²ç»ä¿å­˜åˆ°æ•°æ®åº“äº†
async uploadFile(filePath, fileType) {
  const uploadRes = await wx.uploadFile({...});
  const data = JSON.parse(uploadRes.data);
  
  if (data.success) {
    // åªæ›´æ–°æœ¬åœ°çŠ¶æ€
    this.setData({
      certificateUrls: [...this.data.certificateUrls, data.data.fileUrl]
    });
  }
}

// âŒ é”™è¯¯ï¼šä¸è¦å†è°ƒç”¨æ›´æ–°æ¥å£
async uploadFile(filePath, fileType) {
  const uploadRes = await wx.uploadFile({...});
  
  // åˆè°ƒç”¨æ›´æ–°æ¥å£ï¼ˆé”™è¯¯ï¼ä¼šå¯¼è‡´é‡å¤ï¼‰
  await wx.request({
    url: `/api/resumes/miniprogram/${this.data.resumeId}`,
    method: 'PATCH',
    data: { certificateUrls: [...] }  // âŒ ä¸è¦è¿™æ ·åš
  });
}
```

## ğŸ“š ç›¸å…³æ–‡æ¡£

1. **å°ç¨‹åºç«¯ä½¿ç”¨æŒ‡å—**
   - `docs/ç»™å°ç¨‹åºAIçš„ä¸Šä¼ APIä½¿ç”¨æŒ‡å—-ç®€æ´ç‰ˆ.md` - å¿«é€Ÿå¼€å§‹
   - `docs/å°ç¨‹åºç«¯æ–‡ä»¶ä¸Šä¼ APIä½¿ç”¨æ–¹æ³•.md` - å®Œæ•´æ–‡æ¡£
   - `docs/ç»™å°ç¨‹åºAIçš„åˆ é™¤ç…§ç‰‡æŒ‡å—.md` - åˆ é™¤åŠŸèƒ½

2. **é—®é¢˜è¯Šæ–­**
   - `docs/å°ç¨‹åºä¸Šä¼ ç…§ç‰‡é‡å¤é—®é¢˜-è¯Šæ–­æŠ¥å‘Š.md` - é—®é¢˜åˆ†æ
   - `docs/å°ç¨‹åºåˆ é™¤ç…§ç‰‡é—®é¢˜-æœ€ç»ˆè§£å†³æ–¹æ¡ˆ.md` - åˆ é™¤é—®é¢˜

3. **æµ‹è¯•è„šæœ¬**
   - `backend/test-upload-duplicate.js` - ä¸Šä¼ é‡å¤æµ‹è¯•
   - `backend/test-delete-api.js` - åˆ é™¤åŠŸèƒ½æµ‹è¯•

## ğŸ¯ æ€»ç»“

| åŠŸèƒ½ | API æ¥å£ | çŠ¶æ€ |
|------|---------|------|
| ä¸Šä¼ æ–‡ä»¶ | `POST /api/resumes/miniprogram/:id/upload-file` | âœ… æ­£å¸¸ |
| åˆ é™¤æ–‡ä»¶ | `DELETE /api/resumes/miniprogram/:id/delete-file` | âœ… æ­£å¸¸ |
| åç«¯é€»è¾‘ | ä¸ CRM ç«¯ä¸€è‡´ | âœ… å·²éªŒè¯ |
| æµ‹è¯•ç»“æœ | ä¸ä¼šäº§ç”Ÿé‡å¤ | âœ… å·²é€šè¿‡ |

**é—®é¢˜æ ¹æº**ï¼šå°ç¨‹åºç«¯çš„è°ƒç”¨é€»è¾‘æœ‰é—®é¢˜ï¼Œä¸æ˜¯ CRM åç«¯çš„é—®é¢˜ã€‚

**è§£å†³æ–¹æ¡ˆ**ï¼šå‚è€ƒä¸Šé¢çš„å®Œæ•´ä»£ç ç¤ºä¾‹ï¼Œä¿®å¤å°ç¨‹åºç«¯çš„ä¸Šä¼ å’Œåˆ é™¤é€»è¾‘ã€‚

---

**æœ€åæ›´æ–°**ï¼š2025-01-11  
**æµ‹è¯•çŠ¶æ€**ï¼šâœ… å·²é€šè¿‡  
**å¯ç”¨æ€§**ï¼šâœ… ç”Ÿäº§ç¯å¢ƒå¯ç”¨

