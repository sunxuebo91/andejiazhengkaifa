# 小程序上传照片重复问题 - 诊断报告

## 🔍 问题描述

**现象**：小程序端上传一张技能证书照片，显示两张相同的照片。

**截图证据**：用户提供的截图显示，上传一张照片后，界面上显示了两张相同的"安得家政"logo图片。

## 🧪 测试结果

### 后端测试

我们对 CRM 后端的上传接口进行了完整测试：

```bash
cd backend
node test-upload-duplicate.js
```

**测试结果**：✅ **后端逻辑正常，不会产生重复**

```
📊 第一次上传后：
   certificateUrls: 1 项
   certificates: 1 项

📊 第二次上传后：
   certificateUrls: 2 项
   certificates: 2 项
```

### 结论

**问题出在小程序端，不是 CRM 后端的问题。**

## 📋 CRM 后端逻辑（正确的参考）

### 上传接口

```
POST /api/resumes/miniprogram/:id/upload-file
```

### 后端处理逻辑

<augment_code_snippet path="backend/src/modules/resume/resume.service.ts" mode="EXCERPT">
````typescript
case 'certificate':
  if (!resumeDoc.certificates) resumeDoc.certificates = [];
  resumeDoc.certificates.push(uploadedFileInfo);  // 添加到 certificates
  if (!resumeDoc.certificateUrls) resumeDoc.certificateUrls = [];
  resumeDoc.certificateUrls.push(fileUrl);  // 添加到 certificateUrls
  break;
````
</augment_code_snippet>

**逻辑说明**：
1. 每次上传，只添加一次到 `certificates` 数组
2. 同时添加一次到 `certificateUrls` 数组
3. 保存到数据库
4. **不会产生重复**

### CRM 前端逻辑（正确的参考）

<augment_code_snippet path="frontend/src/pages/aunt/CreateResume.tsx" mode="EXCERPT">
````typescript
// 编辑模式下，在 beforeUpload 中直接上传
if (editingResume?._id) {
  const response = await apiService.upload(`/api/resumes/${editingResume._id}/upload`, formData);
  if (response.success) {
    // 上传成功后，添加到本地状态
    setCertificateFiles(prev => [...prev, newFile]);
  }
}
````
</augment_code_snippet>

**CRM 前端逻辑**：
1. 在 `beforeUpload` 中调用上传接口
2. 上传成功后，将文件添加到本地状态 **一次**
3. **不会重复调用上传接口**
4. **不会在提交时再次上传**

## 🐛 小程序端可能的问题

根据测试结果和 CRM 端的正确逻辑，小程序端可能存在以下问题：

### 问题1：重复调用上传接口

```javascript
// ❌ 错误示例：可能重复调用了上传接口
async function uploadImage(file) {
  // 第一次调用
  await wx.request({
    url: '/api/resumes/miniprogram/${resumeId}/upload-file',
    method: 'POST',
    ...
  });
  
  // 第二次调用（可能在某个回调或事件中）
  await wx.request({
    url: '/api/resumes/miniprogram/${resumeId}/upload-file',
    method: 'POST',
    ...
  });
}
```

### 问题2：上传后又调用更新接口

```javascript
// ❌ 错误示例：上传后又调用更新接口
async function uploadImage(file) {
  // 1. 调用上传接口
  const res1 = await wx.request({
    url: '/api/resumes/miniprogram/${resumeId}/upload-file',
    method: 'POST',
    ...
  });
  
  // 2. 又调用更新接口，传入相同的 URL
  const res2 = await wx.request({
    url: '/api/resumes/miniprogram/${resumeId}',
    method: 'PATCH',
    data: {
      certificateUrls: [res1.data.fileUrl]  // ❌ 这会导致重复
    }
  });
}
```

### 问题3：本地状态重复添加

```javascript
// ❌ 错误示例：在多个地方添加到本地状态
async function uploadImage(file) {
  const res = await wx.request({...});
  
  // 第一次添加
  this.setData({
    certificateUrls: [...this.data.certificateUrls, res.data.fileUrl]
  });
  
  // 第二次添加（可能在 success 回调中）
  this.setData({
    certificateUrls: [...this.data.certificateUrls, res.data.fileUrl]
  });
}
```

### 问题4：wx.chooseImage 的 success 回调中重复处理

```javascript
// ❌ 错误示例：在 success 回调中重复处理
wx.chooseImage({
  count: 1,
  success: (res) => {
    const tempFilePaths = res.tempFilePaths;
    
    // 可能在这里上传了一次
    tempFilePaths.forEach(path => {
      this.uploadFile(path);
    });
    
    // 又在这里上传了一次
    this.uploadFile(tempFilePaths[0]);
  }
});
```

## ✅ 正确的小程序端实现

### 方案1：参考 CRM 端逻辑

```javascript
Page({
  data: {
    resumeId: '',
    certificateUrls: []
  },

  // 选择图片
  async onChooseImage() {
    try {
      const res = await wx.chooseImage({
        count: 1,
        sizeType: ['compressed'],
        sourceType: ['album', 'camera']
      });

      const tempFilePath = res.tempFilePaths[0];
      
      // 立即上传
      await this.uploadCertificate(tempFilePath);
      
    } catch (error) {
      console.error('选择图片失败:', error);
    }
  },

  // 上传证书照片
  async uploadCertificate(filePath) {
    wx.showLoading({ title: '上传中...', mask: true });

    try {
      const res = await wx.uploadFile({
        url: `${API_BASE_URL}/api/resumes/miniprogram/${this.data.resumeId}/upload-file`,
        filePath: filePath,
        name: 'file',
        formData: {
          type: 'certificate'
        },
        header: {
          'Authorization': `Bearer ${wx.getStorageSync('token')}`
        }
      });

      wx.hideLoading();

      const data = JSON.parse(res.data);
      if (data.success) {
        wx.showToast({ title: '上传成功', icon: 'success' });
        
        // ✅ 只添加一次到本地状态
        this.setData({
          certificateUrls: [...this.data.certificateUrls, data.data.fileUrl]
        });
      } else {
        wx.showToast({ title: data.message, icon: 'none' });
      }
    } catch (error) {
      wx.hideLoading();
      console.error('上传失败:', error);
      wx.showToast({ title: '上传失败', icon: 'none' });
    }
  }
});
```

### 方案2：上传后重新加载简历数据

```javascript
Page({
  // 上传证书照片
  async uploadCertificate(filePath) {
    wx.showLoading({ title: '上传中...', mask: true });

    try {
      const res = await wx.uploadFile({
        url: `${API_BASE_URL}/api/resumes/miniprogram/${this.data.resumeId}/upload-file`,
        filePath: filePath,
        name: 'file',
        formData: {
          type: 'certificate'
        },
        header: {
          'Authorization': `Bearer ${wx.getStorageSync('token')}`
        }
      });

      const data = JSON.parse(res.data);
      if (data.success) {
        wx.showToast({ title: '上传成功', icon: 'success' });
        
        // ✅ 重新加载简历数据，避免本地状态不一致
        await this.loadResumeDetail();
      }
    } catch (error) {
      wx.hideLoading();
      console.error('上传失败:', error);
      wx.showToast({ title: '上传失败', icon: 'none' });
    }
  },

  // 加载简历详情
  async loadResumeDetail() {
    try {
      const res = await wx.request({
        url: `${API_BASE_URL}/api/resumes/miniprogram/${this.data.resumeId}`,
        method: 'GET',
        header: {
          'Authorization': `Bearer ${wx.getStorageSync('token')}`
        }
      });

      if (res.data.success) {
        this.setData({
          certificateUrls: res.data.data.certificateUrls || []
        });
      }
    } catch (error) {
      console.error('加载简历失败:', error);
    }
  }
});
```

## 🔍 排查步骤

### 步骤1：检查上传接口调用次数

在小程序端添加日志：

```javascript
async uploadCertificate(filePath) {
  console.log('🚀 开始上传，时间:', new Date().toISOString());
  console.log('📁 文件路径:', filePath);
  
  const res = await wx.uploadFile({...});
  
  console.log('✅ 上传完成，时间:', new Date().toISOString());
  console.log('📊 响应数据:', res.data);
}
```

**检查**：上传一张照片时，`开始上传` 和 `上传完成` 应该各只出现一次。

### 步骤2：检查本地状态更新次数

```javascript
setData({
  certificateUrls: [...this.data.certificateUrls, newUrl]
}, () => {
  console.log('📊 更新后的 certificateUrls:', this.data.certificateUrls);
  console.log('📊 数量:', this.data.certificateUrls.length);
});
```

**检查**：上传一张照片后，数量应该增加 1，不是 2。

### 步骤3：检查服务器返回的数据

```javascript
const data = JSON.parse(res.data);
console.log('🔍 服务器返回:', JSON.stringify(data, null, 2));
```

**检查**：服务器返回的 `data.data.fileUrl` 应该只有一个 URL。

### 步骤4：检查是否有多个上传按钮

```xml
<!-- 检查 WXML 中是否有重复的上传按钮 -->
<button bindtap="onChooseImage">上传证书</button>
<!-- 确保没有重复绑定 -->
```

## 📝 给小程序 AI 的建议

1. **检查上传流程**
   - 确保只调用一次上传接口
   - 确保不在上传后再调用更新接口
   - 确保本地状态只更新一次

2. **参考 CRM 端逻辑**
   - CRM 端的逻辑是正确的，可以参考
   - 在 `beforeUpload` 或选择图片后立即上传
   - 上传成功后只添加一次到本地状态

3. **添加调试日志**
   - 在关键位置添加 `console.log`
   - 记录上传次数、状态更新次数
   - 检查是否有重复调用

4. **测试验证**
   - 上传一张照片，检查界面显示数量
   - 检查服务器数据库中的数量
   - 确保两者一致

## 🎯 总结

| 项目 | 状态 | 说明 |
|------|------|------|
| CRM 后端逻辑 | ✅ 正常 | 测试通过，不会产生重复 |
| CRM 前端逻辑 | ✅ 正常 | 只上传一次，只添加一次到状态 |
| 小程序端逻辑 | ❌ 有问题 | 需要检查和修复 |

**问题根源**：小程序端的调用逻辑有问题，不是 CRM 后端的问题。

**解决方案**：参考 CRM 端的正确逻辑，修复小程序端的上传流程。

---

**测试脚本**：`backend/test-upload-duplicate.js`  
**测试时间**：2025-01-11  
**测试结果**：✅ 后端正常

