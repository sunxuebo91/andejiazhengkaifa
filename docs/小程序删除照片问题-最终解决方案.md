# 小程序删除照片问题 - 最终解决方案

## 📋 问题总结

**原始问题**：小程序端删除技能证书照片后保存，服务器返回成功，但重新加载简历时照片仍然存在。

**根本原因**：小程序端使用了错误的删除方式（提交空数组），而 CRM 后端已经提供了专门的删除 API。

## ✅ 解决方案

### 方案概述

**不要通过提交空数组删除照片**，而是使用 CRM 后端提供的专门删除 API：

```
DELETE /api/resumes/miniprogram/:id/delete-file
```

### 为什么不用空数组方式？

1. **数据同步问题**：数据库中有两套字段（`certificateUrls` 和 `certificates`），提交空数组可能导致同步不一致
2. **物理文件残留**：空数组方式不会删除 COS 上的物理文件
3. **不够精确**：无法删除单张照片，只能全部删除
4. **维护困难**：需要后端额外处理空数组的同步逻辑

### 正确的删除方式

使用专门的删除 API，它会：

✅ 自动同步 `certificateUrls` 和 `certificates` 字段  
✅ 删除 COS 上的物理文件  
✅ 支持删除单张照片  
✅ 提供清晰的错误提示  

## 💻 小程序端实现

### 快速示例

```javascript
// 删除技能证书照片
async function deleteCertificate(resumeId, fileUrl) {
  const res = await wx.request({
    url: `https://crm.andejiazheng.com/api/resumes/miniprogram/${resumeId}/delete-file`,
    method: 'DELETE',
    header: {
      'Authorization': `Bearer ${wx.getStorageSync('token')}`,
      'Content-Type': 'application/json'
    },
    data: {
      fileUrl: fileUrl,
      fileType: 'certificate'
    }
  });

  if (res.data.success) {
    wx.showToast({ title: '删除成功', icon: 'success' });
    return true;
  } else {
    wx.showToast({ title: res.data.message, icon: 'none' });
    return false;
  }
}
```

### 支持的文件类型

| fileType | 说明 | 对应字段 |
|----------|------|---------|
| `certificate` | 技能证书 | `certificateUrls` / `certificates` |
| `personalPhoto` | 个人照片 | `photoUrls` / `personalPhoto` |
| `medicalReport` | 体检报告 | `medicalReportUrls` / `reports` |
| `idCardFront` | 身份证正面 | `idCardFront` |
| `idCardBack` | 身份证背面 | `idCardBack` |

## 🔧 后端改进

虽然主要解决方案是使用删除 API，但我也改进了后端的 `update` 方法，使其能够正确处理空数组：

### 改进内容

在 `backend/src/modules/resume/resume.service.ts` 的 `update` 方法中添加了字段同步逻辑：

```typescript
// 当小程序提交 certificateUrls 时，自动同步 certificates
if (updateResumeDto.certificateUrls !== undefined) {
  updateData.certificateUrls = updateResumeDto.certificateUrls;
  if (Array.isArray(updateResumeDto.certificateUrls)) {
    if (updateResumeDto.certificateUrls.length === 0) {
      updateData.certificates = [];  // 清空
    } else {
      updateData.certificates = updateResumeDto.certificateUrls.map(url => ({
        url: url,
        filename: url.split('/').pop() || '',
        mimetype: 'image/jpeg',
        size: 0
      }));
    }
  }
}
```

这样即使小程序端使用空数组方式，也能正确同步两个字段。

## 🧪 测试验证

### 测试1：删除 API 测试

```bash
cd backend
node test-delete-api.js
```

**结果**：✅ 通过

```
✅ 登录成功
✅ 找到简历
✅ 证书添加成功
✅ 验证证书存在
✅ 删除请求成功
✅ 验证证书已删除
```

### 测试2：空数组同步测试

```bash
cd backend
node test-delete-simple.js
```

**结果**：✅ 通过

```
✅ 证书添加成功
✅ 删除请求成功 (提交空数组)
✅ certificateUrls: 0 项
✅ certificates: 0 项 (已同步)
```

## 📚 相关文档

1. **小程序端使用指南**
   - `docs/给小程序AI的删除照片指南.md` - 快速开始指南
   - `docs/小程序端删除照片API使用指南.md` - 完整 API 文档

2. **后端实现**
   - `backend/src/modules/resume/resume.controller.ts` (第 1048-1100 行) - 删除接口
   - `backend/src/modules/resume/resume.service.ts` (第 679-795 行) - 删除逻辑
   - `backend/src/modules/resume/resume.service.ts` (第 325-424 行) - 更新逻辑改进

3. **测试脚本**
   - `backend/test-delete-api.js` - 删除 API 测试
   - `backend/test-delete-simple.js` - 空数组同步测试

## 🎯 推荐方案

### 优先级 1：使用删除 API（强烈推荐）

```javascript
// ✅ 推荐：使用专门的删除 API
wx.request({
  url: `/api/resumes/miniprogram/${resumeId}/delete-file`,
  method: 'DELETE',
  data: {
    fileUrl: url,
    fileType: 'certificate'
  }
});
```

**优点**：
- ✅ 功能完整（删除数据库记录 + 物理文件）
- ✅ 支持单张删除
- ✅ 错误提示清晰
- ✅ 代码语义明确

### 优先级 2：提交空数组（备选方案）

```javascript
// ⚠️ 备选：提交空数组（现在也能正常工作）
wx.request({
  url: `/api/resumes/miniprogram/${resumeId}`,
  method: 'PATCH',
  data: {
    certificateUrls: []
  }
});
```

**缺点**：
- ❌ 不删除物理文件
- ❌ 只能全部删除
- ❌ 语义不清晰

## 📞 给小程序 AI 的建议

1. **立即修改**：将所有删除照片的代码改为使用删除 API
2. **用户体验**：添加删除确认对话框
3. **错误处理**：显示友好的错误提示
4. **数据刷新**：删除后刷新页面数据

### 示例代码

```javascript
Page({
  // 删除证书照片
  async onDeleteCertificate(e) {
    const { url } = e.currentTarget.dataset;
    
    // 1. 确认删除
    const confirmRes = await wx.showModal({
      title: '确认删除',
      content: '确定要删除这张证书照片吗？'
    });
    if (!confirmRes.confirm) return;

    // 2. 显示加载
    wx.showLoading({ title: '删除中...', mask: true });

    try {
      // 3. 调用删除 API
      const res = await wx.request({
        url: `${API_BASE_URL}/api/resumes/miniprogram/${this.data.resumeId}/delete-file`,
        method: 'DELETE',
        header: {
          'Authorization': `Bearer ${wx.getStorageSync('token')}`,
          'Content-Type': 'application/json'
        },
        data: {
          fileUrl: url,
          fileType: 'certificate'
        }
      });

      wx.hideLoading();

      // 4. 处理结果
      if (res.data.success) {
        wx.showToast({ title: '删除成功', icon: 'success' });
        
        // 5. 刷新数据
        const newUrls = this.data.certificateUrls.filter(u => u !== url);
        this.setData({ certificateUrls: newUrls });
      } else {
        wx.showToast({ 
          title: res.data.message || '删除失败', 
          icon: 'none' 
        });
      }
    } catch (error) {
      wx.hideLoading();
      console.error('删除失败:', error);
      wx.showToast({ title: '删除失败', icon: 'none' });
    }
  }
});
```

## 🎉 总结

1. **问题已解决**：后端提供了完整的删除 API
2. **测试已通过**：所有功能都经过验证
3. **文档已完善**：提供了详细的使用指南
4. **向后兼容**：改进了 update 方法，空数组方式也能工作

**小程序端只需要修改代码，使用正确的删除 API 即可。**

---

**最后更新**：2025-01-11  
**状态**：✅ 已解决  
**测试**：✅ 已通过  
**文档**：✅ 已完善

