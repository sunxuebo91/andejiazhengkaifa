# 小程序端 - 接口快速参考

**版本**: v1.0.0  
**生产环境**: `https://crm.andejiazheng.com/api`

---

## 📋 接口列表

| 接口 | 路径 | 方法 | 认证 | 用途 |
|------|------|------|------|------|
| 获取枚举字典 | `/api/resumes/enums` | GET | ❌ 无需 | 获取工种、性别等枚举值 |
| OCR识别 | `/api/ocr/idcard` | POST | ❌ 无需 | 识别身份证信息 |
| 自助注册 | `/api/resumes/miniprogram/self-register` | POST | ❌ 无需 | 创建简历 |

---

## 1️⃣ 获取枚举字典接口

### 基本信息

```
GET /api/resumes/enums
认证: 无需登录
```

### 用途

获取前端需要的所有枚举值（工种、性别、学历、技能等），避免硬编码。

### 请求示例

```javascript
// 小程序端
const { publicRequest } = require('./request');

async function getEnums() {
  const response = await publicRequest({
    url: '/resumes/enums',
    method: 'GET'
  });
  return response.data;
}
```

### 响应示例

```json
{
  "success": true,
  "data": {
    "gender": [
      { "value": "female", "label": "女" },
      { "value": "male", "label": "男" }
    ],
    "jobType": [
      { "value": "yuexin", "label": "月嫂" },
      { "value": "zhujia-yuer", "label": "住家育儿" },
      { "value": "baiban-yuer", "label": "白班育儿" },
      { "value": "baojie", "label": "保洁" },
      { "value": "baiban-baomu", "label": "白班保姆" },
      { "value": "zhujia-baomu", "label": "住家保姆" },
      { "value": "yangchong", "label": "养宠" },
      { "value": "xiaoshi", "label": "小时工" },
      { "value": "zhujia-hulao", "label": "住家护老" }
    ],
    "education": [
      { "value": "no", "label": "无学历" },
      { "value": "primary", "label": "小学" },
      { "value": "middle", "label": "初中" },
      { "value": "secondary", "label": "中专" },
      { "value": "vocational", "label": "职高" },
      { "value": "high", "label": "高中" },
      { "value": "college", "label": "大专" },
      { "value": "bachelor", "label": "本科" },
      { "value": "graduate", "label": "研究生" }
    ],
    "skills": [
      { "value": "muying", "label": "母婴护理师" },
      { "value": "cuiru", "label": "高级催乳师" },
      { "value": "yuezican", "label": "月子餐营养师" },
      { "value": "chanhou", "label": "产后修复师" },
      { "value": "teshu-yinger", "label": "特殊婴儿护理" },
      { "value": "yiliaobackground", "label": "医疗背景" },
      { "value": "yuying", "label": "高级育婴师" },
      { "value": "zaojiao", "label": "早教师" },
      { "value": "fushi", "label": "辅食营养师" },
      { "value": "ertui", "label": "小儿推拿师" },
      { "value": "waiyu", "label": "外语" },
      { "value": "zhongcan", "label": "中餐" },
      { "value": "xican", "label": "西餐" },
      { "value": "mianshi", "label": "面食" },
      { "value": "jiashi", "label": "驾驶" },
      { "value": "shouyi", "label": "整理收纳" }
    ],
    "orderStatus": [
      { "value": "accepting", "label": "想接单" },
      { "value": "not-accepting", "label": "不接单" },
      { "value": "on-service", "label": "已上户" }
    ]
  }
}
```

### 使用建议

1. **小程序启动时调用一次**，缓存到本地存储
2. **定期更新**（如每天或每周）
3. **避免硬编码**枚举值，使用接口返回的数据

---

## 2️⃣ OCR识别接口

### 基本信息

```
POST /api/ocr/idcard
Content-Type: multipart/form-data
认证: 无需登录
```

### 请求参数

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| file | File | ✅ | 身份证图片（JPG/PNG，最大5MB） |

### 小程序示例

```javascript
wx.chooseImage({
  count: 1,
  success: (res) => {
    wx.uploadFile({
      url: 'https://crm.andejiazheng.com/api/ocr/idcard',
      filePath: res.tempFilePaths[0],
      name: 'file',
      success: (uploadRes) => {
        const data = JSON.parse(uploadRes.data);
        if (data.success) {
          const result = data.data.words_result;
          console.log('姓名:', result.姓名.words);
          console.log('身份证号:', result.公民身份号码.words);
          console.log('性别:', result.性别.words);
          console.log('出生日期:', result.出生.words);
        }
      }
    });
  }
});
```

### 响应字段

| 字段 | 说明 | 示例 |
|------|------|------|
| 姓名 | 姓名 | "张三" |
| 公民身份号码 | 身份证号 | "110101198901011234" |
| 性别 | 性别 | "女" |
| 出生 | 出生日期（YYYYMMDD） | "19890101" |
| 民族 | 民族 | "汉" |
| 住址 | 住址 | "北京市朝阳区xxx" |

---

## 3️⃣ 自助注册接口

### 基本信息

```
POST /api/resumes/miniprogram/self-register
Content-Type: application/json
认证: 无需登录
```

### 必填字段

| 字段 | 类型 | 验证规则 | 示例 |
|------|------|----------|------|
| name | string | 2-20字符 | "张三" |
| phone | string | 11位手机号 | "13800138000" |
| age | number | 18-65 | 35 |
| gender | string | male/female | "female" |
| jobType | string | 见工种枚举 | "yuexin" |

### 可选字段

| 字段 | 类型 | 说明 |
|------|------|------|
| idNumber | string | 身份证号（18位） |
| birthDate | string | 出生日期（YYYY-MM-DD） |
| ethnicity | string | 民族 |
| nativePlace | string | 籍贯 |
| hukouAddress | string | 户口地址 |
| education | string | 学历（默认middle） |
| expectedSalary | number | 期望薪资 |
| experienceYears | number | 工作年限 |
| skills | array | 技能列表 |

### 小程序示例

```javascript
const { publicRequest } = require('./request');

async function selfRegister(data) {
  return await publicRequest({
    url: '/resumes/miniprogram/self-register',
    method: 'POST',
    data: {
      name: data.name,
      phone: data.phone,
      age: data.age,
      gender: data.gender,
      jobType: data.jobType,
      idNumber: data.idNumber,
      birthDate: data.birthDate,
      ethnicity: data.ethnicity,
      nativePlace: data.nativePlace,
      hukouAddress: data.hukouAddress
    }
  });
}
```

### 成功响应

```json
{
  "success": true,
  "message": "简历创建成功",
  "data": {
    "_id": "68f1b225d51f9afd7181f23b",
    "id": "68f1b225d51f9afd7181f23b",
    "name": "张三",
    "phone": "13800138000",
    "status": "draft",
    "leadSource": "self-registration",
    "createdAt": "2025-10-17T03:04:05.276Z"
  }
}
```

### 错误响应

| HTTP状态码 | 错误码 | 说明 | 处理方式 |
|-----------|--------|------|---------|
| 400 | VALIDATION_ERROR | 数据验证失败 | 检查字段格式 |
| 409 | DUPLICATE_ERROR | 手机号已注册 | 提示用户 |
| 409 | DUPLICATE_ID_NUMBER | 身份证号已注册 | 提示用户 |
| 429 | RATE_LIMIT_EXCEEDED | 请求过于频繁 | 稍后重试 |
| 500 | INTERNAL_ERROR | 服务器错误 | 稍后重试 |

---

## 🔄 完整流程示例

```javascript
// 1. 小程序启动时获取枚举值
async function onLaunch() {
  try {
    const enums = await getEnums();
    wx.setStorageSync('enums', enums);
  } catch (error) {
    console.error('获取枚举失败:', error);
  }
}

// 2. OCR识别身份证
async function handleOCR() {
  wx.chooseImage({
    count: 1,
    success: (res) => {
      wx.showLoading({ title: '识别中...' });
      
      wx.uploadFile({
        url: 'https://crm.andejiazheng.com/api/ocr/idcard',
        filePath: res.tempFilePaths[0],
        name: 'file',
        success: (uploadRes) => {
          wx.hideLoading();
          const data = JSON.parse(uploadRes.data);
          
          if (data.success) {
            const result = data.data.words_result;
            
            // 自动填充表单
            this.setData({
              name: result.姓名.words,
              idNumber: result.公民身份号码.words,
              birthDate: formatBirthDate(result.出生.words),
              gender: result.性别.words === '女' ? 'female' : 'male',
              ethnicity: result.民族.words,
              hukouAddress: result.住址.words
            });
            
            wx.showToast({ title: '识别成功', icon: 'success' });
          }
        }
      });
    }
  });
}

// 3. 提交注册
async function handleSubmit() {
  try {
    wx.showLoading({ title: '提交中...' });
    
    const result = await selfRegister({
      name: this.data.name,
      phone: this.data.phone,
      age: parseInt(this.data.age),
      gender: this.data.gender,
      jobType: this.data.jobType,
      idNumber: this.data.idNumber,
      birthDate: this.data.birthDate,
      ethnicity: this.data.ethnicity,
      hukouAddress: this.data.hukouAddress
    });
    
    wx.hideLoading();
    
    if (result.success) {
      wx.showToast({ title: '注册成功', icon: 'success' });
      setTimeout(() => wx.navigateBack(), 2000);
    }
  } catch (error) {
    wx.hideLoading();
    
    let message = '注册失败，请重试';
    if (error.response?.data?.error === 'DUPLICATE_ERROR') {
      message = '该手机号已注册';
    } else if (error.response?.data?.error === 'RATE_LIMIT_EXCEEDED') {
      message = '提交过于频繁，请稍后再试';
    }
    
    wx.showToast({ title: message, icon: 'none' });
  }
}

// 辅助函数：格式化出生日期
function formatBirthDate(dateStr) {
  if (!dateStr || dateStr.length !== 8) return '';
  return `${dateStr.substr(0, 4)}-${dateStr.substr(4, 2)}-${dateStr.substr(6, 2)}`;
}
```

---

## 📝 注意事项

### 1. 限流保护

- **自助注册接口**: 每分钟最多3次请求/IP
- **OCR接口**: 无限流（但建议合理使用）

### 2. 数据验证

- 手机号必须是11位数字
- 年龄必须在18-65岁之间
- 身份证号必须是18位（如果提供）
- 工种必须是枚举值中的一个

### 3. 错误处理

- 始终检查 `success` 字段
- 根据 `error` 字段显示不同提示
- 429错误时提示用户稍后重试

### 4. 性能优化

- 枚举值缓存到本地存储
- OCR识别前压缩图片
- 表单提交前做前端验证

---

## 🔗 相关文档

- [详细使用文档](./小程序端-自助注册接口使用文档.md)
- [后端实现说明](./阿姨自助注册接口实现说明.md)
- [交付报告](./阿姨自助注册接口-交付报告.md)

---

**文档版本**: v1.0.0  
**最后更新**: 2025-10-17

