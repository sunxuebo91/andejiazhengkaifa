# 小程序端 - 自助注册集成指南

**版本**: v1.0.0  
**更新日期**: 2025-10-17  
**目标受众**: 小程序前端开发者

---

## 📋 集成步骤

### 第1步：理解创建来源概念

**创建来源** = 这条简历是谁创建的

```
自助注册 ← 你通过小程序创建（本接口）
员工创建 ← 销售/HR通过CRM创建（不涉及小程序）
```

**关键点**:
- ✅ 后端会自动标记为"自助注册"
- ✅ 你只需提供基本信息
- ❌ 不要尝试传递 userId、createdBy 或 leadSource

### 第2步：准备请求数据

```javascript
// 需要收集的字段
const formData = {
  name: '张三',              // 姓名（必填）
  phone: '13900000000',      // 手机号（必填）
  age: 25,                   // 年龄（必填）
  gender: 'female',          // 性别（必填）
  jobType: 'yuer'            // 工种（必填）
};

// 可选字段
const optionalData = {
  idNumber: '110101199001011234',  // 身份证号（可选）
  wechat: 'wechat_id',             // 微信（可选）
  expectedPosition: '育儿嫂',       // 期望职位（可选）
  expectedSalary: 5000,            // 期望薪资（可选）
  serviceArea: '北京市朝阳区',     // 接单地址（可选）
  experienceYears: 3               // 工作经验（可选）
};
```

### 第3步：调用自助注册接口

```javascript
async function registerResume(formData) {
  try {
    const response = await wx.request({
      url: 'https://crm.andejiazheng.com/api/resumes/miniprogram/self-register',
      method: 'POST',
      header: {
        'Content-Type': 'application/json'
      },
      data: formData
    });

    if (response.data.success) {
      console.log('✅ 注册成功！');
      console.log('简历ID:', response.data.data.id);
      return response.data.data;
    } else {
      console.error('❌ 注册失败:', response.data.message);
      throw new Error(response.data.message);
    }
  } catch (error) {
    console.error('❌ 请求失败:', error);
    throw error;
  }
}
```

### 第4步：处理响应

```javascript
// 成功响应
{
  "success": true,
  "data": {
    "id": "68f1c28f73132600cc263f04",
    "createdAt": "2025-10-17T12:00:00Z"
  }
}

// 失败响应
{
  "success": false,
  "error": "DUPLICATE_ERROR",
  "message": "该手机号已注册"
}
```

### 第5步：处理错误

```javascript
async function handleRegistration(formData) {
  try {
    const result = await registerResume(formData);
    
    // 显示成功提示
    wx.showToast({
      title: '注册成功！',
      icon: 'success',
      duration: 2000
    });
    
    // 返回上一页
    setTimeout(() => {
      wx.navigateBack();
    }, 2000);
    
  } catch (error) {
    let message = '注册失败，请重试';
    
    if (error.response?.data?.error === 'DUPLICATE_ERROR') {
      message = '该手机号已注册';
    } else if (error.response?.data?.error === 'DUPLICATE_ID_NUMBER') {
      message = '该身份证号已注册';
    } else if (error.response?.data?.error === 'RATE_LIMIT_EXCEEDED') {
      message = '提交过于频繁，请稍后再试';
    }
    
    wx.showToast({
      title: message,
      icon: 'error',
      duration: 2000
    });
  }
}
```

---

## 🔍 验证清单

### 请求验证

- [ ] URL 正确: `https://crm.andejiazheng.com/api/resumes/miniprogram/self-register`
- [ ] 方法正确: `POST`
- [ ] Content-Type 正确: `application/json`
- [ ] 必填字段完整: name, phone, age, gender, jobType
- [ ] 没有传递 userId、createdBy、leadSource

### 响应验证

- [ ] 成功时返回 `success: true`
- [ ] 成功时返回简历 ID
- [ ] 失败时返回错误信息
- [ ] 错误处理正确

### CRM端验证

- [ ] 简历在CRM中显示为"自助注册"（蓝色标签）
- [ ] 简历状态为"draft"
- [ ] 简历在列表中可见

---

## 📊 工种枚举值

```javascript
const jobTypes = {
  'yuexin': '月嫂',
  'yuer': '育儿嫂',
  'zhujia': '住家保姆',
  'bujia': '不住家保姆',
  'zhujia-yuer': '住家育儿',
  'baiban-yuer': '不住家育儿',
  'laoren': '老人护理',
  'bingren': '病人护理',
  'jiazhenggong': '家政工',
  'other': '其他'
};
```

## 📊 性别枚举值

```javascript
const genders = {
  'male': '男',
  'female': '女'
};
```

---

## 🎯 完整代码示例

```javascript
// pages/register/register.js

Page({
  data: {
    formData: {
      name: '',
      phone: '',
      age: '',
      gender: 'female',
      jobType: 'yuer'
    },
    loading: false
  },

  // 表单输入
  onInputChange(e) {
    const { field } = e.currentTarget.dataset;
    this.setData({
      [`formData.${field}`]: e.detail.value
    });
  },

  // 提交表单
  async onSubmit() {
    const { formData } = this.data;

    // 验证必填字段
    if (!formData.name || !formData.phone || !formData.age || !formData.gender || !formData.jobType) {
      wx.showToast({
        title: '请填写所有必填字段',
        icon: 'error'
      });
      return;
    }

    this.setData({ loading: true });

    try {
      const response = await new Promise((resolve, reject) => {
        wx.request({
          url: 'https://crm.andejiazheng.com/api/resumes/miniprogram/self-register',
          method: 'POST',
          header: {
            'Content-Type': 'application/json'
          },
          data: formData,
          success: resolve,
          fail: reject
        });
      });

      if (response.data.success) {
        wx.showToast({
          title: '注册成功！',
          icon: 'success',
          duration: 2000
        });

        setTimeout(() => {
          wx.navigateBack();
        }, 2000);
      } else {
        let message = response.data.message || '注册失败';
        
        if (response.data.error === 'DUPLICATE_ERROR') {
          message = '该手机号已注册';
        } else if (response.data.error === 'DUPLICATE_ID_NUMBER') {
          message = '该身份证号已注册';
        } else if (response.data.error === 'RATE_LIMIT_EXCEEDED') {
          message = '提交过于频繁，请稍后再试';
        }

        wx.showToast({
          title: message,
          icon: 'error',
          duration: 2000
        });
      }
    } catch (error) {
      wx.showToast({
        title: '网络错误，请重试',
        icon: 'error',
        duration: 2000
      });
    } finally {
      this.setData({ loading: false });
    }
  }
});
```

---

## ⚠️ 常见问题

### Q1: 我需要传递 userId 吗？

**A**: 不需要！后端会自动设置为 null，表示自助注册。

### Q2: 我需要传递 leadSource 吗？

**A**: 不需要！后端会自动设置为 'self-registration'。

### Q3: 我需要传递 createdBy 吗？

**A**: 不需要！后端会自动处理。

### Q4: 如果我传递了这些字段会怎样？

**A**: 后端会忽略它们，自动设置正确的值。

### Q5: 我的简历在CRM中如何显示？

**A**: 显示为蓝色标签"自助注册"，表示是自助创建的。

### Q6: 为什么后端要强制设置这些字段？

**A**: 防止前端篡改，确保数据准确性和安全性。

---

## 📞 技术支持

如有问题，请参考以下文档：

1. **小程序端-自助注册接口使用文档.md** - 详细的接口文档
2. **小程序端-创建来源快速参考.md** - 创建来源快速参考
3. **小程序端-接口快速参考.md** - 接口快速参考

---

**版本**: v1.0.0  
**最后更新**: 2025-10-17  
**状态**: ✅ 生产环境已部署

