# 📱 小程序视频面试解决方案

> **创建日期**: 2025-11-08  
> **问题**: 小程序 WebView 不支持 WebRTC，无法使用视频功能  
> **解决方案**: 在外部浏览器中打开 H5 页面

---

## 🔍 问题分析

### 核心问题

**小程序的 `<web-view>` 组件不支持 WebRTC API**

- ❌ 小程序 WebView 是受限的浏览器环境
- ❌ 不支持 `getUserMedia()`、`RTCPeerConnection` 等 WebRTC API
- ❌ ZEGO Express SDK（Web 版）无法在 WebView 中初始化
- ❌ 所有基于 WebRTC 的视频通话功能都无法使用

### 为什么之前没有日志？

因为 ZEGO Express SDK 在初始化时就失败了，连错误都没抛出，所以看不到任何日志。

---

## 💡 解决方案对比

### 方案 A：小程序原生 SDK（需要资质）❌

**优点**：
- ✅ 性能最好
- ✅ 用户体验最好
- ✅ 功能最完整

**缺点**：
- ❌ **需要申请"招聘-在线面试"类目**
- ❌ **需要 `<live-pusher>` 和 `<live-player>` 权限**
- ❌ **审核时间：3-7 个工作日**
- ❌ **需要重写整个小程序视频功能**

**所需资质**：
- 营业执照 ✅
- ICP 备案 ✅
- 人力资源服务许可证（可选）

**参考文档**: `docs/小程序资质申请指南.md`

---

### 方案 B：在外部浏览器打开（已实施）✅

**优点**：
- ✅ **无需任何资质审核**
- ✅ **立即可用**
- ✅ **支持 WebRTC**（微信内置浏览器支持）
- ✅ **只需改几行代码**
- ✅ **H5 页面已优化好**（Express SDK + 自定义移动端 UI）

**缺点**：
- ⚠️ 用户需要跳出小程序
- ⚠️ 体验稍差于原生

**实施状态**: ✅ 已完成

---

## 🔧 实施细节

### 修改的文件

**文件**: `miniprogram-pages/interview/interview.js`

**修改内容**:

```javascript
onLoad(options) {
  // ... 获取 roomId、token、userName ...

  // 构建 H5 页面 URL
  let h5Url = `https://crm.andejiazheng.com/interview/h5-entry?roomId=${roomId}&token=${token}&userName=${userName}`;

  // 🔥 关键修改：直接在外部浏览器中打开
  wx.showModal({
    title: '视频面试',
    content: '即将在浏览器中打开视频面试页面',
    confirmText: '打开',
    cancelText: '取消',
    success: (res) => {
      if (res.confirm) {
        // 使用 wx.openUrl 在外部浏览器中打开
        wx.openUrl({
          url: h5Url,
          success: () => {
            console.log('✅ 成功打开外部浏览器');
            wx.navigateBack();
          },
          fail: (err) => {
            // 降级方案：复制链接
            wx.setClipboardData({
              data: h5Url,
              success: () => {
                wx.showModal({
                  title: '链接已复制',
                  content: '请在浏览器中粘贴打开',
                  showCancel: false
                });
              }
            });
          }
        });
      } else {
        wx.navigateBack();
      }
    }
  });
}
```

---

## 📱 用户体验流程

### 当前流程（方案 B）

1. 用户在小程序中点击"创建面试间"或"加入面试"
2. 小程序弹出提示："即将在浏览器中打开视频面试页面"
3. 用户点击"打开"
4. 自动跳转到微信内置浏览器
5. H5 页面加载（已优化的移动端 UI）
6. 用户进行视频面试
7. 面试结束后，用户可以返回小程序

### 降级流程

如果 `wx.openUrl()` 失败（极少数情况）：
1. 自动复制链接到剪贴板
2. 提示用户："链接已复制，请在浏览器中粘贴打开"
3. 用户手动打开浏览器并粘贴链接

---

## 🎨 H5 页面优化

### 已完成的优化

**文件**: `frontend/src/pages/interview/H5Entry.tsx`

1. ✅ **替换 SDK**: 从 `ZegoUIKitPrebuilt` 改为 `ZegoExpressEngine`
2. ✅ **自定义 UI**: 完全自定义的移动端友好界面
3. ✅ **视频布局**: 响应式网格布局（1-6 人自动适配）
4. ✅ **底部控制栏**: 
   - 麦克风开关（大按钮，56x56px）
   - 摄像头开关
   - 挂断按钮
5. ✅ **悬浮按钮**: 邀请、提词器、美颜、离开、解散
6. ✅ **保留所有功能**: 美颜、提词器、聊天、房间管理

### UI 特点

- **移动端优化**: 大按钮、触摸友好
- **视频网格**: 自动适配 1-6 人
- **底部控制栏**: 80px 高度，半透明黑色背景
- **视频窗口**: 圆角 8px，用户名标签

---

## 🚀 部署状态

### 已部署

- ✅ 前端 H5 页面（Express SDK + 自定义 UI）
- ✅ 小程序代码修改（在外部浏览器打开）
- ✅ Nginx 配置（已重启）

### 测试步骤

1. 在小程序中点击"创建面试间"
2. 确认弹出提示："即将在浏览器中打开视频面试页面"
3. 点击"打开"
4. 确认跳转到微信内置浏览器
5. 确认 H5 页面加载成功
6. 确认视频功能正常（摄像头、麦克风、视频通话）

---

## 📊 方案对比总结

| 特性 | 方案 A（原生 SDK） | 方案 B（外部浏览器）✅ |
|------|-------------------|---------------------|
| **资质要求** | ❌ 需要审核 | ✅ 无需审核 |
| **实施时间** | ❌ 3-7 天 + 开发时间 | ✅ 立即可用 |
| **开发工作量** | ❌ 重写整个功能 | ✅ 只改几行代码 |
| **视频功能** | ✅ 完全支持 | ✅ 完全支持 |
| **用户体验** | ✅ 最好（原生） | ⚠️ 稍差（需跳转） |
| **维护成本** | ❌ 高（两套代码） | ✅ 低（共用 H5） |
| **风险** | ⚠️ 审核可能不通过 | ✅ 无风险 |

---

## 🎯 推荐

### 短期方案（当前）

**使用方案 B**：在外部浏览器打开

- ✅ 立即可用
- ✅ 无需资质
- ✅ 功能完整

### 长期方案（可选）

如果未来需要更好的用户体验，可以考虑：

1. **申请小程序资质**（参考 `docs/小程序资质申请指南.md`）
2. **开发小程序原生版本**（使用 ZEGO 小程序 SDK）
3. **保留 H5 版本作为降级方案**

---

## 📝 相关文档

- `docs/小程序资质申请指南.md` - 如何申请小程序视频权限
- `frontend/src/pages/interview/H5Entry.tsx` - H5 视频面试页面
- `miniprogram-pages/interview/interview.js` - 小程序视频面试页面

---

## ❓ 常见问题

### Q1: 为什么不在小程序 WebView 中使用？

**A**: 小程序 WebView 不支持 WebRTC API，无法使用视频功能。

### Q2: 微信内置浏览器支持 WebRTC 吗？

**A**: 是的，微信内置浏览器（iOS 和 Android）都支持 WebRTC。

### Q3: 用户体验会很差吗？

**A**: 会有一次跳转，但 H5 页面已经过移动端优化，视频功能完全正常。

### Q4: 可以不跳转吗？

**A**: 不可以，除非申请小程序资质并使用原生 SDK。

### Q5: 申请资质需要多久？

**A**: 通常 3-7 个工作日，需要营业执照和 ICP 备案。

---

## ✅ 总结

**当前方案（方案 B）是最佳选择**：

1. ✅ 无需资质审核
2. ✅ 立即可用
3. ✅ 功能完整
4. ✅ 开发成本低
5. ✅ 维护成本低

**如果未来需要更好的用户体验，可以考虑申请资质并开发原生版本。**

---

**文档更新日期**: 2025-11-08

