# 批量分配客户功能测试指南

## 测试环境

- **后端服务**: http://localhost:3001 或 https://crm.andejiazheng.com
- **前端应用**: https://crm.andejiazheng.com
- **测试账号**: 需要管理员或经理权限的账号

## 测试前准备

1. 确保后端服务正常运行
2. 确保前端应用已部署最新代码
3. 准备测试账号（管理员或经理角色）
4. 准备至少3个测试客户数据

## 功能测试用例

### 测试用例1：基本批量分配功能

**测试步骤**:
1. 使用管理员账号登录系统
2. 进入"客户管理" -> "客户列表"页面
3. 勾选2-3个客户
4. 观察页面是否显示批量操作按钮区域
5. 点击"批量分配"按钮
6. 在弹出的模态框中选择一个员工
7. 填写分配原因（可选）
8. 点击"确认分配"
9. 观察分配结果提示

**预期结果**:
- 选择客户后，显示"已选择 X 个客户"和批量操作按钮
- 模态框正确显示已选择的客户数量
- 分配成功后显示"批量分配完成：成功 X 个，失败 0 个"
- 客户列表自动刷新
- 选择状态被清空

### 测试用例2：表格选择功能

**测试步骤**:
1. 进入客户列表页面
2. 测试单个客户选择
3. 测试"全选"功能
4. 测试"反选"功能
5. 测试"取消选择"按钮

**预期结果**:
- 所有选择操作正常工作
- 选择数量正确显示
- 取消选择后批量操作区域消失

### 测试用例3：权限控制测试

**测试步骤**:
1. 使用普通员工账号登录
2. 进入客户列表页面
3. 勾选客户
4. 观察是否显示批量分配按钮

**预期结果**:
- 普通员工看不到批量分配按钮
- 只有管理员和经理可以看到批量分配功能

### 测试用例4：部分失败处理

**测试步骤**:
1. 选择多个客户（包括一些可能已被删除或无效的客户ID）
2. 执行批量分配
3. 观察错误提示

**预期结果**:
- 显示成功和失败的数量
- 弹出详细的错误信息窗口
- 列出失败的客户和原因

### 测试用例5：表单验证

**测试步骤**:
1. 选择客户后点击批量分配
2. 不选择负责人，直接点击确认
3. 观察验证提示

**预期结果**:
- 显示"请选择负责人"的验证错误
- 不会提交请求

### 测试用例6：大量客户批量分配

**测试步骤**:
1. 使用"全选"功能选择当前页的所有客户（10个）
2. 执行批量分配
3. 观察处理时间和结果

**预期结果**:
- 能够成功处理10个客户的批量分配
- 响应时间在合理范围内（< 5秒）
- 所有客户都成功分配

## API测试

### 使用curl测试批量分配API

```bash
# 1. 先登录获取token
curl -X POST http://localhost:3001/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{
    "username": "admin",
    "password": "your_password"
  }'

# 2. 使用token调用批量分配API
curl -X POST http://localhost:3001/api/customers/batch-assign \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_TOKEN_HERE" \
  -d '{
    "customerIds": ["客户ID1", "客户ID2", "客户ID3"],
    "assignedTo": "员工ID",
    "assignmentReason": "测试批量分配"
  }'
```

### 预期API响应

**成功响应**:
```json
{
  "success": true,
  "message": "批量分配完成：成功 3 个，失败 0 个",
  "data": {
    "success": 3,
    "failed": 0,
    "errors": []
  },
  "timestamp": 1700000000000
}
```

**部分失败响应**:
```json
{
  "success": true,
  "message": "批量分配完成：成功 2 个，失败 1 个",
  "data": {
    "success": 2,
    "failed": 1,
    "errors": [
      {
        "customerId": "无效的客户ID",
        "error": "客户不存在"
      }
    ]
  },
  "timestamp": 1700000000000
}
```

## 数据库验证

### 验证分配记录

```sql
-- 查看客户的分配信息
SELECT _id, name, phone, assignedTo, assignedBy, assignedAt, assignmentReason
FROM customers
WHERE _id IN ('客户ID1', '客户ID2', '客户ID3');

-- 查看分配审计日志
SELECT *
FROM customer_assignment_logs
WHERE customerId IN ('客户ID1', '客户ID2', '客户ID3')
ORDER BY assignedAt DESC;

-- 查看系统跟进记录
SELECT *
FROM customer_follow_ups
WHERE customerId IN ('客户ID1', '客户ID2', '客户ID3')
  AND type = 'other'
  AND content LIKE '%负责人由%变更为%'
ORDER BY createdAt DESC;
```

## 性能测试

### 测试场景

1. **小批量**: 5个客户
2. **中批量**: 20个客户
3. **大批量**: 50个客户

### 性能指标

- **响应时间**: 应在5秒内完成
- **成功率**: 应达到100%（在客户数据有效的情况下）
- **系统稳定性**: 不应出现内存泄漏或服务崩溃

## 常见问题排查

### 问题1：批量分配按钮不显示

**可能原因**:
- 用户权限不足（不是管理员或经理）
- 前端代码未正确部署
- 权限组件配置错误

**排查方法**:
1. 检查用户角色
2. 检查浏览器控制台是否有错误
3. 检查前端代码是否包含 `<Authorized>` 组件

### 问题2：批量分配失败

**可能原因**:
- 目标负责人不存在或未激活
- 客户ID无效
- 权限验证失败

**排查方法**:
1. 检查后端日志
2. 验证目标负责人的状态
3. 验证客户ID的有效性

### 问题3：部分客户分配失败

**可能原因**:
- 某些客户已被删除
- 某些客户的负责人已经是目标负责人

**排查方法**:
1. 查看错误详情
2. 检查失败的客户数据
3. 验证业务逻辑

## 测试报告模板

```
测试日期: YYYY-MM-DD
测试人员: [姓名]
测试环境: [开发/测试/生产]

测试结果:
- 基本功能: [通过/失败]
- 权限控制: [通过/失败]
- 错误处理: [通过/失败]
- 性能测试: [通过/失败]

发现的问题:
1. [问题描述]
2. [问题描述]

建议:
1. [改进建议]
2. [改进建议]
```

## 测试完成标准

- [ ] 所有功能测试用例通过
- [ ] 权限控制正常工作
- [ ] 错误处理符合预期
- [ ] 性能满足要求
- [ ] 数据库记录正确
- [ ] 用户体验良好
- [ ] 无明显bug

## 联系方式

如有问题，请联系开发团队。

