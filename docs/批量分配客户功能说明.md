# 批量分配客户功能说明

## 功能概述

为客户列表页面添加了批量分配功能，允许管理员和经理一次性将多个客户分配给指定的员工。

## 实现内容

### 1. 后端实现

#### 1.1 DTO定义
- **文件**: `backend/src/modules/customers/dto/batch-assign-customer.dto.ts`
- **功能**: 定义批量分配请求的数据结构
- **字段**:
  - `customerIds`: 客户ID数组（必填，至少1个）
  - `assignedTo`: 目标负责人ID（必填）
  - `assignmentReason`: 分配原因（可选，最多200字）

#### 1.2 服务层实现
- **文件**: `backend/src/modules/customers/customers.service.ts`
- **方法**: `batchAssignCustomers()`
- **功能**:
  - 验证管理员/经理权限
  - 验证目标负责人的有效性和状态
  - 批量处理每个客户的分配
  - 记录分配审计日志
  - 记录系统跟进记录
  - 发送批量分配通知
  - 返回成功和失败的统计信息

#### 1.3 控制器实现
- **文件**: `backend/src/modules/customers/customers.controller.ts`
- **路由**: `POST /api/customers/batch-assign`
- **权限**: 仅管理员和经理可访问
- **响应**: 返回批量分配的结果统计

### 2. 前端实现

#### 2.1 服务方法
- **文件**: `frontend/src/services/customerService.ts`
- **方法**: `batchAssignCustomers()`
- **功能**: 调用后端批量分配API

#### 2.2 批量分配模态框组件
- **文件**: `frontend/src/components/BatchAssignCustomerModal.tsx`
- **功能**:
  - 显示已选择的客户数量
  - 选择目标负责人（支持搜索）
  - 输入分配原因
  - 显示分配结果
  - 处理部分失败的情况

#### 2.3 客户列表页面更新
- **文件**: `frontend/src/pages/customers/CustomerList.tsx`
- **新增功能**:
  - 表格行选择功能（支持多选、全选、反选）
  - 批量操作按钮区域
  - 显示已选择的客户数量
  - 批量分配按钮（仅管理员和经理可见）
  - 取消选择按钮

## 使用流程

### 管理员/经理操作步骤：

1. **登录系统**
   - 使用管理员或经理账号登录

2. **进入客户列表页面**
   - 导航到"客户管理" -> "客户列表"

3. **选择客户**
   - 勾选需要分配的客户（可多选）
   - 可使用表格上方的"全选"、"反选"等快捷操作

4. **点击批量分配**
   - 选择客户后，页面会显示批量操作按钮区域
   - 点击"批量分配"按钮

5. **填写分配信息**
   - 在弹出的模态框中选择目标负责人
   - 可选填写分配原因或备注
   - 点击"确认分配"

6. **查看分配结果**
   - 系统会显示分配结果：成功X个，失败X个
   - 如有失败，会显示详细的错误信息
   - 分配成功后，客户列表会自动刷新

## 技术特点

### 1. 权限控制
- 仅管理员和经理可以使用批量分配功能
- 前端和后端都进行了权限验证

### 2. 数据验证
- 验证客户ID的有效性
- 验证目标负责人的状态（必须是激活状态）
- 验证目标负责人的角色（必须是员工或经理）

### 3. 错误处理
- 批量处理时，单个客户失败不影响其他客户
- 详细记录每个失败的原因
- 返回完整的成功/失败统计

### 4. 审计日志
- 每次分配都会记录到分配审计日志表
- 记录旧负责人、新负责人、分配人、分配时间和原因
- 同时在客户跟进记录中添加系统记录

### 5. 通知功能
- 批量分配完成后发送汇总通知给目标负责人
- 避免单个客户分配时的重复通知

## API文档

### 批量分配客户

**请求**:
```http
POST /api/customers/batch-assign
Authorization: Bearer <token>
Content-Type: application/json

{
  "customerIds": ["客户ID1", "客户ID2", "客户ID3"],
  "assignedTo": "目标负责人ID",
  "assignmentReason": "批量分配原因"
}
```

**响应**:
```json
{
  "success": true,
  "message": "批量分配完成：成功 3 个，失败 0 个",
  "data": {
    "success": 3,
    "failed": 0,
    "errors": []
  }
}
```

**错误响应**（部分失败）:
```json
{
  "success": true,
  "message": "批量分配完成：成功 2 个，失败 1 个",
  "data": {
    "success": 2,
    "failed": 1,
    "errors": [
      {
        "customerId": "客户ID3",
        "error": "客户不存在"
      }
    ]
  }
}
```

## 测试建议

1. **功能测试**:
   - 测试选择单个客户批量分配
   - 测试选择多个客户批量分配
   - 测试全选功能
   - 测试取消选择功能

2. **权限测试**:
   - 验证普通员工无法看到批量分配按钮
   - 验证管理员和经理可以使用批量分配功能

3. **异常测试**:
   - 测试分配给不存在的用户
   - 测试分配给未激活的用户
   - 测试分配不存在的客户
   - 测试部分客户分配失败的情况

4. **性能测试**:
   - 测试批量分配大量客户（如50个、100个）
   - 验证响应时间和系统稳定性

## 后续优化建议

1. **性能优化**:
   - 对于大量客户的批量分配，可以考虑使用异步任务队列
   - 添加进度条显示批量分配进度

2. **功能增强**:
   - 支持按筛选条件批量分配（如分配所有某个来源的客户）
   - 支持批量分配时的负载均衡（自动分配给工作量较少的员工）

3. **通知优化**:
   - 完善微信通知模板，包含批量分配的详细信息
   - 支持邮件通知

## 相关文件清单

### 后端文件
- `backend/src/modules/customers/dto/batch-assign-customer.dto.ts` - DTO定义
- `backend/src/modules/customers/customers.service.ts` - 服务层实现
- `backend/src/modules/customers/customers.controller.ts` - 控制器实现

### 前端文件
- `frontend/src/services/customerService.ts` - API服务
- `frontend/src/components/BatchAssignCustomerModal.tsx` - 批量分配模态框
- `frontend/src/pages/customers/CustomerList.tsx` - 客户列表页面

## 部署说明

1. 后端服务已自动重启并加载新功能
2. 前端需要重新构建并部署
3. 无需数据库迁移（使用现有的表结构）

## 完成时间

2025-11-20

