# 数据库迁移：手机号改为可选

## 背景

将客户表的 `phone` 字段从必填改为可选，同时保持唯一性约束。

## 问题

原有的唯一索引不是稀疏索引，导致：
- 不允许多个文档的 `phone` 字段为 `null`
- 创建没有手机号的客户时报错：`E11000 duplicate key error`

## 解决方案

删除旧的唯一索引，创建新的**稀疏唯一索引**。

## 迁移步骤

### 1. 查看现有索引

```bash
mongosh housekeeping --eval "db.customers.getIndexes()"
```

### 2. 删除旧索引

```bash
mongosh housekeeping --eval "db.customers.dropIndex('phone_1')"
```

### 3. 创建稀疏唯一索引

```bash
mongosh housekeeping --eval "db.customers.createIndex({ phone: 1 }, { unique: true, sparse: true })"
```

### 4. 验证新索引

```bash
mongosh housekeeping --eval "db.customers.getIndexes().forEach(index => { if (index.key.phone) { printjson(index); } })"
```

预期输出：
```json
{
  "v": 2,
  "key": {
    "phone": 1
  },
  "name": "phone_1",
  "unique": true,
  "sparse": true
}
```

## 技术说明

### 普通唯一索引 vs 稀疏唯一索引

**普通唯一索引**：
```javascript
{ unique: true }
```
- 不允许多个文档的字段为 `null` 或 `undefined`
- `null` 也被视为一个唯一值

**稀疏唯一索引**：
```javascript
{ unique: true, sparse: true }
```
- 只索引包含该字段的文档
- 允许多个文档的字段为 `null` 或 `undefined`
- 有值的文档必须唯一

### 示例

```javascript
// ✅ 允许（稀疏唯一索引）
{ name: "张三", phone: null }
{ name: "李四", phone: null }
{ name: "王五", phone: null }
{ name: "赵六", phone: "13800138000" }

// ❌ 不允许（重复的手机号）
{ name: "孙七", phone: "13800138000" }  // 报错：手机号重复
```

## 影响

- ✅ 允许创建多个没有手机号的客户
- ✅ 如果填写手机号，仍然会检查唯一性
- ✅ 符合业务需求：手机号可选但不能重复

## 执行时间

2025-11-20 17:45:00

## 执行人

系统管理员

## 验证

```bash
# 查看统计
mongosh housekeeping --eval "
print('总客户数: ' + db.customers.countDocuments({}));
print('有手机号的客户: ' + db.customers.countDocuments({ phone: { \$exists: true, \$ne: null, \$ne: '' } }));
print('没有手机号的客户: ' + db.customers.countDocuments({ \$or: [{ phone: null }, { phone: '' }, { phone: { \$exists: false } }] }));
"
```

## 回滚方案

如果需要回滚到必填状态：

```bash
# 1. 删除稀疏索引
mongosh housekeeping --eval "db.customers.dropIndex('phone_1')"

# 2. 创建普通唯一索引
mongosh housekeeping --eval "db.customers.createIndex({ phone: 1 }, { unique: true })"
```

**注意**：回滚前需要确保所有客户都有手机号，否则会失败。

