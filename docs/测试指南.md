# 客户批量导入功能 - 测试指南

## 📋 测试准备

### 1. 环境检查

**后端服务**:
- ✅ 后端已启动在端口 3001
- ✅ 导入接口已注册: `POST /api/customers/import-excel`
- ✅ ExcelJS 已安装 (4.4.0)
- ✅ uploads/temp 目录已创建

**前端服务**:
- 前端开发服务器应运行在端口 5173
- 或者访问生产环境

### 2. 测试数据准备

已提供测试模板: `docs/客户导入模板示例.csv`

包含5条测试数据：
1. 张三 - 完整数据
2. 李四 - 部分数据
3. 王五 - 最少必填字段
4. 赵六 - 完整数据
5. 孙七 - 完整数据

---

## 🧪 测试用例

### 测试用例 1: 正常导入（完整数据）

**目的**: 验证完整数据的正常导入流程

**步骤**:
1. 登录系统
2. 进入"客户管理"页面
3. 点击"批量导入"按钮
4. 点击"下载模板"获取模板
5. 填写完整的客户数据（包含所有字段）
6. 上传Excel文件
7. 等待导入完成

**预期结果**:
- ✅ 导入成功
- ✅ 显示"成功导入 X 条客户，失败 0 条"
- ✅ 客户列表自动刷新
- ✅ 新客户出现在列表中
- ✅ 所有字段数据正确

---

### 测试用例 2: 部分字段导入

**目的**: 验证只填写必填字段的导入

**步骤**:
1. 准备Excel文件，只填写：姓名、电话、线索来源
2. 上传文件
3. 查看导入结果

**预期结果**:
- ✅ 导入成功
- ✅ 必填字段正确
- ✅ 可选字段为空或默认值
- ✅ 客户状态默认为"待定"

---

### 测试用例 3: 手机号重复

**目的**: 验证手机号去重功能

**步骤**:
1. 先导入一个客户（手机号：13800138000）
2. 再次导入相同手机号的客户
3. 查看导入结果

**预期结果**:
- ✅ 第一次导入成功
- ❌ 第二次导入失败
- ✅ 错误信息："该手机号已存在客户记录"
- ✅ 显示失败统计

---

### 测试用例 4: 缺少必填字段

**目的**: 验证必填字段验证

**步骤**:
1. 准备Excel文件，缺少"姓名"列
2. 上传文件

**预期结果**:
- ❌ 导入失败
- ✅ 错误信息："Excel文件缺少必需的列: 姓名"

**变体测试**:
- 缺少"电话"列
- 缺少"线索来源"列
- 某行的必填字段为空

---

### 测试用例 5: 枚举值错误

**目的**: 验证枚举值验证

**步骤**:
1. 准备Excel文件，线索来源填写"百度"（不在枚举值中）
2. 上传文件

**预期结果**:
- ❌ 该行导入失败
- ✅ 错误信息包含枚举值验证失败
- ✅ 其他正确的行导入成功

---

### 测试用例 6: 手机号格式错误

**目的**: 验证手机号格式验证

**步骤**:
1. 准备Excel文件，电话填写"12345"（无效手机号）
2. 上传文件

**预期结果**:
- ❌ 该行导入失败
- ✅ 错误信息："请输入有效的中国手机号码"

---

### 测试用例 7: 数字范围错误

**目的**: 验证数字字段范围验证

**步骤**:
1. 准备Excel文件，薪资预算填写"100"（低于最小值1000）
2. 上传文件

**预期结果**:
- ❌ 该行导入失败
- ✅ 错误信息："薪资预算不能低于1000元"

**变体测试**:
- 薪资预算 > 50000
- 家庭面积 < 10
- 家庭面积 > 1000
- 家庭人口 < 1
- 家庭人口 > 20

---

### 测试用例 8: 错误文件类型

**目的**: 验证文件类型验证

**步骤**:
1. 尝试上传 .txt 文件
2. 尝试上传 .pdf 文件
3. 尝试上传 .doc 文件

**预期结果**:
- ❌ 上传失败
- ✅ 错误信息："仅支持 .xlsx 或 .xls 格式的Excel文件"

---

### 测试用例 9: 空文件

**目的**: 验证空文件处理

**步骤**:
1. 准备只有表头没有数据的Excel文件
2. 上传文件

**预期结果**:
- ❌ 导入失败
- ✅ 错误信息："Excel文件中没有数据"

---

### 测试用例 10: 批量导入（性能测试）

**目的**: 验证批量导入性能

**步骤**:
1. 准备包含100条数据的Excel文件
2. 上传文件
3. 记录导入时间

**预期结果**:
- ✅ 导入成功
- ✅ 导入时间 < 10秒
- ✅ 所有数据正确导入

**变体测试**:
- 10条数据（预期 < 2秒）
- 500条数据（预期 < 30秒）

---

### 测试用例 11: 混合成功失败

**目的**: 验证部分成功部分失败的情况

**步骤**:
1. 准备Excel文件，包含：
   - 3条正确数据
   - 2条手机号重复数据
   - 1条枚举值错误数据
2. 上传文件

**预期结果**:
- ✅ 成功导入 3 条
- ❌ 失败 3 条
- ✅ 显示详细错误信息
- ✅ 错误信息包含行号和原因

---

### 测试用例 12: 模板下载

**目的**: 验证模板下载功能

**步骤**:
1. 点击"批量导入"按钮
2. 点击"下载模板"按钮
3. 打开下载的文件

**预期结果**:
- ✅ 文件成功下载
- ✅ 文件名为"客户导入模板.csv"
- ✅ 包含正确的表头
- ✅ 包含示例数据
- ✅ 中文显示正常（无乱码）

---

### 测试用例 13: 导入后列表刷新

**目的**: 验证导入后列表自动刷新

**步骤**:
1. 记录当前客户列表的数量
2. 导入5条新客户
3. 观察列表变化

**预期结果**:
- ✅ 列表自动刷新
- ✅ 客户数量增加5条
- ✅ 新客户出现在列表中
- ✅ 无需手动刷新页面

---

### 测试用例 14: 导入结果显示

**目的**: 验证导入结果的显示

**步骤**:
1. 导入包含成功和失败的数据
2. 查看导入结果弹窗

**预期结果**:
- ✅ 显示成功数量（绿色）
- ✅ 显示失败数量（红色）
- ✅ 显示错误详情列表
- ✅ 错误信息包含行号
- ✅ 错误信息包含失败原因
- ✅ 错误列表可滚动查看

---

### 测试用例 15: 权限控制

**目的**: 验证导入功能的权限控制

**步骤**:
1. 使用不同角色的账号登录
2. 尝试访问批量导入功能

**预期结果**:
- ✅ 已登录用户可以看到"批量导入"按钮
- ✅ 未登录用户无法访问
- ✅ 导入的客户自动关联到当前用户

---

## 📊 测试结果记录表

| 测试用例 | 测试时间 | 测试人 | 结果 | 备注 |
|---------|---------|--------|------|------|
| 1. 正常导入 | | | ⏳ | |
| 2. 部分字段导入 | | | ⏳ | |
| 3. 手机号重复 | | | ⏳ | |
| 4. 缺少必填字段 | | | ⏳ | |
| 5. 枚举值错误 | | | ⏳ | |
| 6. 手机号格式错误 | | | ⏳ | |
| 7. 数字范围错误 | | | ⏳ | |
| 8. 错误文件类型 | | | ⏳ | |
| 9. 空文件 | | | ⏳ | |
| 10. 批量导入 | | | ⏳ | |
| 11. 混合成功失败 | | | ⏳ | |
| 12. 模板下载 | | | ⏳ | |
| 13. 导入后列表刷新 | | | ⏳ | |
| 14. 导入结果显示 | | | ⏳ | |
| 15. 权限控制 | | | ⏳ | |

**结果说明**:
- ✅ 通过
- ❌ 失败
- ⏳ 待测试
- ⚠️ 部分通过

---

## 🐛 Bug 报告模板

如果发现问题，请使用以下模板报告：

```
### Bug 标题
简短描述问题

### 重现步骤
1. 步骤1
2. 步骤2
3. 步骤3

### 预期结果
应该发生什么

### 实际结果
实际发生了什么

### 环境信息
- 浏览器：
- 操作系统：
- 测试数据：

### 截图/日志
（如有）

### 优先级
- [ ] 高（阻塞功能）
- [ ] 中（影响体验）
- [ ] 低（小问题）
```

---

## 🔍 手动测试 Checklist

### 前端测试
- [ ] 批量导入按钮显示正常
- [ ] 点击按钮弹窗正常打开
- [ ] 导入说明文字清晰
- [ ] 下载模板按钮可用
- [ ] 拖拽上传区域显示正常
- [ ] 文件选择功能正常
- [ ] 上传过程显示加载状态
- [ ] 导入结果显示正确
- [ ] 成功/失败数量统计正确
- [ ] 错误详情列表显示正确
- [ ] 关闭按钮功能正常
- [ ] 导入成功后列表刷新

### 后端测试
- [ ] 接口路由注册成功
- [ ] 文件上传功能正常
- [ ] 文件类型验证正确
- [ ] Excel解析功能正常
- [ ] 表头验证正确
- [ ] 数据验证正确
- [ ] 批量创建功能正常
- [ ] 错误收集功能正常
- [ ] 临时文件清理正常
- [ ] 日志记录正常

### 数据验证测试
- [ ] 姓名必填验证
- [ ] 电话必填验证
- [ ] 线索来源必填验证
- [ ] 手机号格式验证
- [ ] 手机号去重验证
- [ ] 线索来源枚举验证
- [ ] 客户状态枚举验证
- [ ] 需求品类枚举验证
- [ ] 线索等级枚举验证
- [ ] 休息制度枚举验证
- [ ] 薪资预算范围验证
- [ ] 家庭面积范围验证
- [ ] 家庭人口范围验证

---

## 🚀 快速测试步骤

### 最小测试（5分钟）

1. **下载模板**
   - 点击"批量导入" → "下载模板"
   - 打开文件检查格式

2. **导入测试数据**
   - 使用 `docs/客户导入模板示例.csv`
   - 上传文件
   - 查看结果

3. **验证数据**
   - 在客户列表中查找新导入的客户
   - 检查数据是否正确

### 完整测试（30分钟）

1. 执行所有15个测试用例
2. 记录测试结果
3. 报告发现的问题
4. 验证修复后的问题

---

## 📞 测试支持

### 遇到问题？

1. **查看日志**
   ```bash
   # 后端日志
   cd backend && pm2 logs backend-dev
   
   # 查看错误日志
   cd backend && pm2 logs backend-dev --err
   ```

2. **检查网络请求**
   - 打开浏览器开发者工具
   - 查看 Network 标签
   - 检查 `/api/customers/import-excel` 请求

3. **查看控制台错误**
   - 打开浏览器开发者工具
   - 查看 Console 标签
   - 检查是否有 JavaScript 错误

### 常见问题排查

**问题1: 上传后没有反应**
- 检查网络请求是否发送
- 检查后端服务是否运行
- 查看浏览器控制台错误

**问题2: 导入失败但没有错误信息**
- 查看后端日志
- 检查文件格式是否正确
- 验证数据是否符合要求

**问题3: 部分数据导入失败**
- 查看错误详情列表
- 根据错误信息修正数据
- 重新导入失败的数据

---

## ✅ 测试完成标准

### 功能测试通过标准
- ✅ 所有15个测试用例通过
- ✅ 无阻塞性Bug
- ✅ 用户体验良好

### 性能测试通过标准
- ✅ 10条数据 < 2秒
- ✅ 100条数据 < 10秒
- ✅ 500条数据 < 30秒

### 安全测试通过标准
- ✅ 文件类型验证有效
- ✅ 权限控制正常
- ✅ 数据验证严格

---

**测试指南版本**: 1.0  
**创建时间**: 2025-01-11  
**维护人**: AI Assistant

**祝测试顺利！** 🎉

