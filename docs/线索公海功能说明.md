# 线索公海功能说明文档

## 📋 功能概述

线索公海是一个共享的客户资源池，用于管理暂时无人跟进或需要重新分配的客户线索。通过公海机制，可以实现客户资源的合理分配和高效利用。

## 🎯 核心功能

### 1. 公海客户列表

**访问路径**：客户管理 → 线索公海

**功能特性**：
- 展示所有在公海中的客户
- 支持按线索来源、服务类别、线索等级筛选
- 支持客户姓名和电话搜索
- 显示客户进入公海的时间和原因
- 显示客户被领取的次数

**统计信息**：
- 公海客户总数
- 我的客户数量（当前持有/上限）
- 可领取数量

### 2. 员工领取客户

**操作方式**：
1. 在公海列表中勾选要领取的客户
2. 点击"领取客户"按钮
3. 系统自动分配给当前用户

**限制规则**：
- 每个员工最多持有 50 个客户
- 超过上限无法继续领取
- 系统会提示剩余可领取数量

**领取后**：
- 客户从公海移除
- 客户归属人设置为当前用户
- 记录领取操作日志
- 创建系统跟进记录

### 3. 管理员分配客户

**权限要求**：仅管理员（admin）和经理（manager）可用

**操作方式**：
1. 在公海列表中勾选要分配的客户
2. 点击"分配客户"按钮
3. 选择目标负责人
4. 填写分配原因（可选）
5. 确认分配

**分配后**：
- 客户从公海移除
- 客户归属人设置为指定用户
- 记录分配操作日志
- 创建系统跟进记录
- 发送通知给目标用户

### 4. 释放客户到公海

#### 4.1 单个释放

**操作位置**：客户列表 → 操作列 → 释放按钮

**操作方式**：
1. 点击客户行的"释放"按钮
2. 填写释放原因（必填）
3. 确认释放

**权限规则**：
- 客户负责人可以释放自己的客户
- 管理员和经理可以释放任何客户

#### 4.2 批量释放

**操作位置**：客户列表 → 批量操作区

**操作方式**：
1. 勾选要释放的客户
2. 点击"批量释放到公海"按钮
3. 填写释放原因（必填）
4. 确认释放

**释放后**：
- 客户进入公海
- 清除客户归属人
- 记录释放时间和原因
- 记录释放操作日志
- 创建系统跟进记录

### 5. 公海历史记录

**查看方式**：客户详情页 → 公海历史标签

**记录内容**：
- 操作类型（进入、领取、分配、释放）
- 操作人
- 原负责人（如有）
- 新负责人（如有）
- 操作原因
- 操作时间

## 🔧 技术实现

### 数据模型

#### Customer 模型扩展
```typescript
inPublicPool: boolean;           // 是否在公海中
publicPoolEntryTime: Date;       // 进入公海的时间
publicPoolEntryReason: string;   // 进入公海的原因
lastFollowUpBy: ObjectId;        // 最后跟进人
lastFollowUpTime: Date;          // 最后跟进时间
claimCount: number;              // 被领取次数
```

#### PublicPoolLog 模型
```typescript
customerId: ObjectId;            // 客户ID
action: string;                  // 操作类型
operatorId: ObjectId;            // 操作人ID
fromUserId: ObjectId;            // 原负责人ID
toUserId: ObjectId;              // 新负责人ID
reason: string;                  // 操作原因
operatedAt: Date;                // 操作时间
```

### API 端点

| 方法 | 路径 | 说明 | 权限 |
|------|------|------|------|
| GET | /api/customers/public-pool | 获取公海客户列表 | 所有用户 |
| POST | /api/customers/public-pool/claim | 员工领取客户 | 所有用户 |
| POST | /api/customers/public-pool/assign | 管理员分配客户 | admin, manager |
| POST | /api/customers/:id/release-to-pool | 释放单个客户 | 负责人或管理员 |
| POST | /api/customers/batch-release-to-pool | 批量释放客户 | 负责人或管理员 |
| GET | /api/customers/public-pool/statistics | 获取公海统计 | admin, manager |
| GET | /api/customers/:id/public-pool-logs | 获取公海历史 | 所有用户 |
| GET | /api/customers/my-customer-count | 获取我的客户数量 | 所有用户 |

## 📊 使用场景

### 场景1：新客户暂不分配
创建客户时可以选择不分配负责人，客户直接进入公海，由员工自主领取。

### 场景2：员工主动释放
员工发现客户不适合自己跟进，可以主动释放到公海，让其他员工领取。

### 场景3：管理员调配资源
管理员可以从公海中挑选合适的客户分配给特定员工，实现资源优化配置。

### 场景4：客户重新分配
当客户需要更换负责人时，可以先释放到公海，再由新负责人领取或管理员分配。

## ⚠️ 注意事项

1. **客户数量限制**：每个员工最多持有 50 个客户，超过限制无法继续领取
2. **释放原因必填**：释放客户到公海时必须填写原因，便于追溯
3. **权限控制**：只有客户负责人或管理员可以释放客户
4. **操作记录**：所有公海操作都会记录日志，可追溯查询
5. **系统跟进**：每次公海操作都会自动创建系统跟进记录

## 🚀 部署信息

- **部署时间**：2025-11-20
- **Git Commit**：a87771d
- **后端服务**：已重启（backend-prod）
- **前端服务**：已重启（frontend-prod）
- **访问地址**：https://crm.andejiazheng.com/customers/public-pool

## ✅ 测试建议

1. **功能测试**：
   - 测试员工领取客户
   - 测试管理员分配客户
   - 测试单个释放到公海
   - 测试批量释放到公海
   - 测试客户数量限制

2. **权限测试**：
   - 测试普通员工权限
   - 测试管理员权限
   - 测试经理权限

3. **边界测试**：
   - 测试达到客户上限时的提示
   - 测试释放原因必填验证
   - 测试并发领取同一客户

4. **数据验证**：
   - 验证公海统计数据准确性
   - 验证公海历史记录完整性
   - 验证系统跟进记录生成

## 📝 后续优化建议

1. **自动回收机制**：实现定时任务，自动回收长期未跟进的客户
2. **提前提醒**：客户即将被回收时，提前通知负责人
3. **公海规则配置**：允许管理员配置客户上限、回收规则等
4. **数据分析**：增加公海数据分析报表，优化资源分配策略

