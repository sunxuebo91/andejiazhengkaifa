# 线索归属人列表修复 - 2025-11-20

## 🐛 问题描述

在客户列表的"线索归属人"筛选下拉框中，管理员（admin）角色的用户没有显示在列表中，导致无法筛选管理员负责的客户。

## 🔍 问题原因

后端 `getAssignableUsers` 方法在查询可分配用户时，只包含了 `employee` 和 `manager` 角色，遗漏了 `admin` 角色。

**问题代码**：
```typescript
// backend/src/modules/customers/customers.service.ts (第533行)
const users = await this.userModel
  .find({ active: true, role: { $in: ['employee', 'manager'] } })  // ❌ 缺少 'admin'
  .select('_id name username role department')
  .sort({ name: 1 })
  .lean();
```

## ✅ 修复方案

在查询条件中添加 `admin` 角色，使管理员也能出现在可分配用户列表中。

**修复后代码**：
```typescript
// backend/src/modules/customers/customers.service.ts (第533行)
const users = await this.userModel
  .find({ active: true, role: { $in: ['admin', 'employee', 'manager'] } })  // ✅ 添加 'admin'
  .select('_id name username role department')
  .sort({ name: 1 })
  .lean();
```

## 📝 修改详情

### 修改文件
- `backend/src/modules/customers/customers.service.ts`

### 修改内容
- 第533行：在角色查询条件中添加 `'admin'`
- 修改前：`role: { $in: ['employee', 'manager'] }`
- 修改后：`role: { $in: ['admin', 'employee', 'manager'] }`

## 🎯 影响范围

此修复会影响以下功能：

1. **客户列表 - 线索归属人筛选**
   - 下拉列表现在会显示管理员用户
   - 可以筛选管理员负责的客户

2. **客户分配功能**
   - 可以将客户分配给管理员
   - 批量分配时也可以选择管理员

3. **用户列表显示顺序**
   - 按姓名排序：admin、employee、manager 混合显示
   - 所有活跃用户都会出现在列表中

## 🚀 部署信息

### 部署时间
2025-11-20 10:36

### Git 提交
- **Commit**: `6b9b722`
- **消息**: fix: 线索归属人列表添加管理员角色

### 部署步骤

1. ✅ 修改后端 customers.service.ts
2. ✅ 提交代码到 Git
3. ✅ 推送到远程仓库
4. ✅ 重启后端生产服务
5. ✅ 重启前端生产服务（确保服务正常）

### 验证结果

- ✅ 后端服务启动成功
- ✅ 前端服务启动成功
- ✅ 所有服务运行正常

## 🌐 访问地址

- **生产环境**: https://crm.andejiazheng.com
- **客户列表**: https://crm.andejiazheng.com/customers

## ✅ 测试建议

1. **验证管理员显示**
   - 打开客户列表页面
   - 点击"线索归属人"下拉框
   - 确认管理员用户出现在列表中

2. **验证筛选功能**
   - 选择管理员用户
   - 点击"搜索"按钮
   - 确认显示该管理员负责的客户

3. **验证分配功能**
   - 在客户详情页面点击"分配"按钮
   - 确认可以选择管理员作为分配对象
   - 测试分配功能是否正常

4. **验证批量分配**
   - 在客户列表勾选多个客户
   - 点击"批量分配"按钮
   - 确认可以选择管理员作为分配对象

## 📊 完整的用户角色列表

修复后，以下角色的用户都会出现在"线索归属人"列表中：

1. **admin（系统管理员）** ⭐ 新增
2. **manager（经理）**
3. **employee（员工）**

**注意**：只显示 `active: true`（活跃）的用户。

## 📌 相关功能

此修复同时影响以下使用 `getAssignableUsers` 方法的功能：

1. **客户分配**（单个分配）
2. **批量分配客户**
3. **线索归属人筛选**（本次修复的主要功能）

## 🔄 后续优化建议

1. **角色配置化**
   - 考虑将可分配角色配置化，便于后续扩展
   - 可以在配置文件中定义哪些角色可以被分配客户

2. **权限细化**
   - 考虑是否需要限制某些角色只能分配给特定角色
   - 例如：普通员工不能将客户分配给管理员

3. **用户状态标识**
   - 在下拉列表中显示用户的角色标识
   - 例如：`张三 (zhangsan) [管理员]`

---

**修复完成时间**: 2025-11-20 10:37
**修复人员**: AI Assistant
**状态**: ✅ 已部署到生产环境

