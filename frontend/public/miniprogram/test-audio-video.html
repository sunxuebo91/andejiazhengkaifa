<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>éŸ³è§†é¢‘æµ‹è¯•é¡µé¢</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
      background: linear-gradient(180deg, #5fb3a3 0%, #4a9d8e 100%);
      padding: 20px;
      min-height: 100vh;
    }
    
    .container {
      max-width: 800px;
      margin: 0 auto;
      background: white;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    
    h1 {
      color: #333;
      margin-bottom: 20px;
      text-align: center;
    }
    
    .test-section {
      margin-bottom: 30px;
      padding: 20px;
      background: #f5f5f5;
      border-radius: 8px;
    }
    
    .test-section h2 {
      color: #5fb3a3;
      margin-bottom: 15px;
      font-size: 18px;
    }
    
    .test-item {
      margin-bottom: 15px;
      padding: 15px;
      background: white;
      border-radius: 6px;
      border-left: 4px solid #5fb3a3;
    }
    
    .test-item h3 {
      color: #333;
      font-size: 16px;
      margin-bottom: 10px;
    }
    
    .test-item p {
      color: #666;
      font-size: 14px;
      line-height: 1.6;
      margin-bottom: 10px;
    }
    
    .status {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: 500;
    }
    
    .status.pending {
      background: #ffeaa7;
      color: #d63031;
    }
    
    .status.success {
      background: #55efc4;
      color: #00b894;
    }
    
    .status.error {
      background: #fab1a0;
      color: #d63031;
    }
    
    button {
      background: #5fb3a3;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    button:hover {
      background: #4a9d8e;
      transform: translateY(-1px);
    }
    
    button:active {
      transform: translateY(0);
    }
    
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
    }
    
    .video-container {
      margin-top: 15px;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    
    .video-box {
      width: 200px;
      height: 150px;
      background: #000;
      border-radius: 8px;
      overflow: hidden;
      position: relative;
    }
    
    .video-box video {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    .video-box.mirror video {
      transform: scaleX(-1);
    }
    
    .video-label {
      position: absolute;
      bottom: 5px;
      left: 5px;
      background: rgba(0,0,0,0.7);
      color: white;
      padding: 3px 8px;
      border-radius: 4px;
      font-size: 12px;
    }
    
    .log {
      margin-top: 15px;
      padding: 10px;
      background: #2d3436;
      color: #dfe6e9;
      border-radius: 6px;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      max-height: 200px;
      overflow-y: auto;
    }
    
    .log-item {
      margin-bottom: 5px;
    }
    
    .log-item.success {
      color: #55efc4;
    }
    
    .log-item.error {
      color: #fab1a0;
    }
    
    .log-item.info {
      color: #74b9ff;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ¥ éŸ³è§†é¢‘åŠŸèƒ½æµ‹è¯•</h1>
    
    <!-- æµ‹è¯•1: éº¦å…‹é£æƒé™ -->
    <div class="test-section">
      <h2>æµ‹è¯•1: éº¦å…‹é£æƒé™æ£€æŸ¥</h2>
      <div class="test-item">
        <h3>æ£€æŸ¥æµè§ˆå™¨æ˜¯å¦æˆäºˆéº¦å…‹é£æƒé™</h3>
        <p>ç‚¹å‡»æŒ‰é’®åï¼Œæµè§ˆå™¨ä¼šå¼¹å‡ºæƒé™è¯·æ±‚ï¼Œè¯·ç‚¹å‡»"å…è®¸"</p>
        <button onclick="testMicrophonePermission()">å¼€å§‹æµ‹è¯•</button>
        <span id="mic-status" class="status pending">æœªæµ‹è¯•</span>
        <div id="mic-log" class="log" style="display:none;"></div>
      </div>
    </div>
    
    <!-- æµ‹è¯•2: éŸ³é¢‘è®¾å¤‡æ£€æµ‹ -->
    <div class="test-section">
      <h2>æµ‹è¯•2: éŸ³é¢‘è®¾å¤‡æ£€æµ‹</h2>
      <div class="test-item">
        <h3>æ£€æµ‹ç³»ç»Ÿä¸­å¯ç”¨çš„éº¦å…‹é£è®¾å¤‡</h3>
        <p>éœ€è¦å…ˆé€šè¿‡æµ‹è¯•1çš„æƒé™æ£€æŸ¥</p>
        <button onclick="testAudioDevices()">å¼€å§‹æµ‹è¯•</button>
        <span id="device-status" class="status pending">æœªæµ‹è¯•</span>
        <div id="device-log" class="log" style="display:none;"></div>
      </div>
    </div>
    
    <!-- æµ‹è¯•3: è§†é¢‘é•œåƒ -->
    <div class="test-section">
      <h2>æµ‹è¯•3: è§†é¢‘é•œåƒæ•ˆæœ</h2>
      <div class="test-item">
        <h3>æµ‹è¯•å‰ç½®æ‘„åƒå¤´çš„é•œåƒæ•ˆæœ</h3>
        <p>å·¦è¾¹æ˜¯æ­£å¸¸è§†é¢‘ï¼Œå³è¾¹æ˜¯é•œåƒè§†é¢‘ã€‚è¯·ä¸¾èµ·å³æ‰‹ï¼Œè§‚å¯Ÿä¸¤ä¸ªè§†é¢‘çš„åŒºåˆ«ã€‚</p>
        <button onclick="testVideoMirror()">å¼€å§‹æµ‹è¯•</button>
        <span id="mirror-status" class="status pending">æœªæµ‹è¯•</span>
        <div class="video-container">
          <div class="video-box">
            <video id="video-normal" autoplay playsinline muted></video>
            <div class="video-label">æ­£å¸¸è§†é¢‘</div>
          </div>
          <div class="video-box mirror">
            <video id="video-mirror" autoplay playsinline muted></video>
            <div class="video-label">é•œåƒè§†é¢‘</div>
          </div>
        </div>
        <div id="mirror-log" class="log" style="display:none;"></div>
      </div>
    </div>
    
    <!-- æµ‹è¯•4: éŸ³é¢‘é‡‡é›† -->
    <div class="test-section">
      <h2>æµ‹è¯•4: éŸ³é¢‘é‡‡é›†æµ‹è¯•</h2>
      <div class="test-item">
        <h3>æµ‹è¯•éº¦å…‹é£æ˜¯å¦èƒ½æ­£å¸¸é‡‡é›†å£°éŸ³</h3>
        <p>ç‚¹å‡»å¼€å§‹åï¼Œå¯¹ç€éº¦å…‹é£è¯´è¯ï¼Œè§‚å¯ŸéŸ³é‡æ¡çš„å˜åŒ–</p>
        <button onclick="testAudioCapture()">å¼€å§‹æµ‹è¯•</button>
        <button onclick="stopAudioCapture()" style="background:#e74c3c;">åœæ­¢æµ‹è¯•</button>
        <span id="audio-status" class="status pending">æœªæµ‹è¯•</span>
        <div style="margin-top:10px;">
          <div style="background:#ddd;height:20px;border-radius:4px;overflow:hidden;">
            <div id="audio-level" style="background:#5fb3a3;height:100%;width:0%;transition:width 0.1s;"></div>
          </div>
          <p style="margin-top:5px;font-size:12px;color:#666;">éŸ³é‡: <span id="audio-value">0</span>%</p>
        </div>
        <div id="audio-log" class="log" style="display:none;"></div>
      </div>
    </div>
    
    <!-- æµ‹è¯•ç»“æœæ€»ç»“ -->
    <div class="test-section">
      <h2>ğŸ“Š æµ‹è¯•ç»“æœæ€»ç»“</h2>
      <div class="test-item">
        <p>âœ… æ‰€æœ‰æµ‹è¯•é€šè¿‡åï¼Œè§†é¢‘é¢è¯•åŠŸèƒ½åº”è¯¥å¯ä»¥æ­£å¸¸ä½¿ç”¨</p>
        <p>âŒ å¦‚æœæœ‰æµ‹è¯•å¤±è´¥ï¼Œè¯·æ£€æŸ¥æµè§ˆå™¨æƒé™è®¾ç½®å’Œè®¾å¤‡è¿æ¥</p>
      </div>
    </div>
  </div>

  <script>
    let audioContext = null;
    let analyser = null;
    let microphone = null;
    let audioStream = null;

    // æ—¥å¿—å‡½æ•°
    function log(elementId, message, type = 'info') {
      const logElement = document.getElementById(elementId);
      logElement.style.display = 'block';
      const logItem = document.createElement('div');
      logItem.className = `log-item ${type}`;
      logItem.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
      logElement.appendChild(logItem);
      logElement.scrollTop = logElement.scrollHeight;
    }

    // æµ‹è¯•1: éº¦å…‹é£æƒé™
    async function testMicrophonePermission() {
      const statusEl = document.getElementById('mic-status');
      const logId = 'mic-log';
      
      try {
        log(logId, 'ğŸ¤ å¼€å§‹æ£€æŸ¥éº¦å…‹é£æƒé™...', 'info');
        
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        
        log(logId, 'âœ… éº¦å…‹é£æƒé™å·²æˆäºˆ', 'success');
        
        // ç«‹å³åœæ­¢
        stream.getTracks().forEach(track => track.stop());
        log(logId, 'âœ… æµ‹è¯•å®Œæˆï¼Œå·²é‡Šæ”¾éº¦å…‹é£', 'success');
        
        statusEl.textContent = 'âœ… é€šè¿‡';
        statusEl.className = 'status success';
      } catch (error) {
        log(logId, `âŒ éº¦å…‹é£æƒé™è¢«æ‹’ç»: ${error.message}`, 'error');
        statusEl.textContent = 'âŒ å¤±è´¥';
        statusEl.className = 'status error';
        alert('è¯·å…è®¸ä½¿ç”¨éº¦å…‹é£ï¼Œå¦åˆ™æ— æ³•è¿›è¡Œè¯­éŸ³é€šè¯');
      }
    }

    // æµ‹è¯•2: éŸ³é¢‘è®¾å¤‡æ£€æµ‹
    async function testAudioDevices() {
      const statusEl = document.getElementById('device-status');
      const logId = 'device-log';
      
      try {
        log(logId, 'ğŸ” å¼€å§‹æ£€æµ‹éŸ³é¢‘è®¾å¤‡...', 'info');
        
        const devices = await navigator.mediaDevices.enumerateDevices();
        const microphones = devices.filter(device => device.kind === 'audioinput');
        
        if (microphones.length === 0) {
          log(logId, 'âŒ æœªæ£€æµ‹åˆ°éº¦å…‹é£è®¾å¤‡', 'error');
          statusEl.textContent = 'âŒ å¤±è´¥';
          statusEl.className = 'status error';
          alert('æœªæ£€æµ‹åˆ°éº¦å…‹é£ï¼Œè¯·æ£€æŸ¥è®¾å¤‡è¿æ¥');
          return;
        }
        
        log(logId, `âœ… æ£€æµ‹åˆ° ${microphones.length} ä¸ªéº¦å…‹é£è®¾å¤‡:`, 'success');
        microphones.forEach((mic, index) => {
          log(logId, `  ${index + 1}. ${mic.label || 'æœªå‘½åè®¾å¤‡'}`, 'info');
        });
        
        statusEl.textContent = 'âœ… é€šè¿‡';
        statusEl.className = 'status success';
      } catch (error) {
        log(logId, `âŒ æ£€æµ‹å¤±è´¥: ${error.message}`, 'error');
        statusEl.textContent = 'âŒ å¤±è´¥';
        statusEl.className = 'status error';
      }
    }

    // æµ‹è¯•3: è§†é¢‘é•œåƒ
    async function testVideoMirror() {
      const statusEl = document.getElementById('mirror-status');
      const logId = 'mirror-log';
      
      try {
        log(logId, 'ğŸ“¹ å¼€å§‹æµ‹è¯•è§†é¢‘é•œåƒ...', 'info');
        
        const stream = await navigator.mediaDevices.getUserMedia({ 
          video: { facingMode: 'user' },
          audio: false 
        });
        
        log(logId, 'âœ… æ‘„åƒå¤´å·²æ‰“å¼€', 'success');
        
        // æ­£å¸¸è§†é¢‘
        const videoNormal = document.getElementById('video-normal');
        videoNormal.srcObject = stream;
        
        // é•œåƒè§†é¢‘
        const videoMirror = document.getElementById('video-mirror');
        videoMirror.srcObject = stream;
        
        log(logId, 'âœ… è§†é¢‘å·²æ˜¾ç¤º', 'success');
        log(logId, 'ğŸ’¡ è¯·ä¸¾èµ·å³æ‰‹ï¼Œè§‚å¯Ÿä¸¤ä¸ªè§†é¢‘çš„åŒºåˆ«', 'info');
        log(logId, 'ğŸ’¡ å·¦è¾¹è§†é¢‘ï¼šä¸¾å³æ‰‹æ˜¾ç¤ºå·¦æ‰‹ï¼ˆæ­£å¸¸ï¼‰', 'info');
        log(logId, 'ğŸ’¡ å³è¾¹è§†é¢‘ï¼šä¸¾å³æ‰‹æ˜¾ç¤ºå³æ‰‹ï¼ˆé•œåƒï¼‰', 'info');
        
        statusEl.textContent = 'âœ… é€šè¿‡';
        statusEl.className = 'status success';
      } catch (error) {
        log(logId, `âŒ æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
        statusEl.textContent = 'âŒ å¤±è´¥';
        statusEl.className = 'status error';
      }
    }

    // æµ‹è¯•4: éŸ³é¢‘é‡‡é›†
    async function testAudioCapture() {
      const statusEl = document.getElementById('audio-status');
      const logId = 'audio-log';
      
      try {
        log(logId, 'ğŸ¤ å¼€å§‹æµ‹è¯•éŸ³é¢‘é‡‡é›†...', 'info');
        
        audioStream = await navigator.mediaDevices.getUserMedia({ audio: true });
        
        log(logId, 'âœ… éº¦å…‹é£å·²æ‰“å¼€', 'success');
        
        // åˆ›å»ºéŸ³é¢‘ä¸Šä¸‹æ–‡
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
        analyser = audioContext.createAnalyser();
        microphone = audioContext.createMediaStreamSource(audioStream);
        
        analyser.fftSize = 256;
        microphone.connect(analyser);
        
        log(logId, 'âœ… éŸ³é¢‘åˆ†æå™¨å·²åˆ›å»º', 'success');
        log(logId, 'ğŸ’¡ è¯·å¯¹ç€éº¦å…‹é£è¯´è¯ï¼Œè§‚å¯ŸéŸ³é‡æ¡å˜åŒ–', 'info');
        
        // å¼€å§‹ç›‘å¬éŸ³é‡
        const dataArray = new Uint8Array(analyser.frequencyBinCount);
        
        function updateVolume() {
          if (!analyser) return;
          
          analyser.getByteFrequencyData(dataArray);
          const average = dataArray.reduce((a, b) => a + b) / dataArray.length;
          const volume = Math.round((average / 255) * 100);
          
          document.getElementById('audio-level').style.width = volume + '%';
          document.getElementById('audio-value').textContent = volume;
          
          requestAnimationFrame(updateVolume);
        }
        
        updateVolume();
        
        statusEl.textContent = 'âœ… è¿è¡Œä¸­';
        statusEl.className = 'status success';
      } catch (error) {
        log(logId, `âŒ æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
        statusEl.textContent = 'âŒ å¤±è´¥';
        statusEl.className = 'status error';
      }
    }

    // åœæ­¢éŸ³é¢‘é‡‡é›†
    function stopAudioCapture() {
      if (audioStream) {
        audioStream.getTracks().forEach(track => track.stop());
        audioStream = null;
      }
      
      if (audioContext) {
        audioContext.close();
        audioContext = null;
      }
      
      analyser = null;
      microphone = null;
      
      document.getElementById('audio-level').style.width = '0%';
      document.getElementById('audio-value').textContent = '0';
      document.getElementById('audio-status').textContent = 'â¹ï¸ å·²åœæ­¢';
      document.getElementById('audio-status').className = 'status pending';
      
      log('audio-log', 'â¹ï¸ éŸ³é¢‘é‡‡é›†å·²åœæ­¢', 'info');
    }
  </script>
</body>
</html>

