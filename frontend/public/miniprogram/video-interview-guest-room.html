<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>è§†é¢‘é¢è¯• - è®¿å®¢</title>
  <!-- ç‰ˆæœ¬: v2024.01.20.002 - æ·»åŠ è°ƒè¯•æµ®çª— -->

  <!-- ğŸ¯ å¾®ä¿¡ç¯å¢ƒæ£€æµ‹ï¼ˆæœ€å…ˆæ‰§è¡Œï¼‰ -->
  <script>
    // ğŸ¯ å…¨å±€ç¯å¢ƒæ£€æµ‹å˜é‡ï¼ˆä¾›åç»­ä½¿ç”¨ï¼‰
    var IS_IN_MINIPROGRAM = false;
    var IS_WECHAT = false;

    (function() {
      // æ£€æµ‹æ˜¯å¦åœ¨å¾®ä¿¡ä¸­
      function isWechat() {
        return /MicroMessenger/i.test(navigator.userAgent);
      }

      // æ£€æµ‹æ˜¯å¦åœ¨å°ç¨‹åº WebView ä¸­ï¼ˆå¾®ä¿¡å®˜æ–¹æ¨èæ–¹æ³•ï¼‰
      function isInMiniProgram() {
        // æ–¹æ³•1ï¼šé€šè¿‡ window.__wxjs_environment åˆ¤æ–­ï¼ˆæœ€å¯é ï¼‰
        if (window.__wxjs_environment === 'miniprogram') {
          return true;
        }

        // æ–¹æ³•2ï¼šé€šè¿‡ userAgent åˆ¤æ–­ï¼ˆå¾®ä¿¡ 7.0.0+ æ”¯æŒï¼‰
        if (/miniProgram/i.test(navigator.userAgent)) {
          return true;
        }

        return false;
      }

      // è®¾ç½®å…¨å±€å˜é‡
      IS_WECHAT = isWechat();
      IS_IN_MINIPROGRAM = isInMiniProgram();

      console.log('ğŸ” ç¯å¢ƒæ£€æµ‹:');
      console.log('  - æ˜¯å¦åœ¨å¾®ä¿¡ä¸­:', IS_WECHAT);
      console.log('  - æ˜¯å¦åœ¨å°ç¨‹åº WebView ä¸­:', IS_IN_MINIPROGRAM);
      console.log('  - UserAgent:', navigator.userAgent);
      console.log('  - __wxjs_environment:', window.__wxjs_environment);

      if (IS_IN_MINIPROGRAM) {
        console.log('âœ… å·²åœ¨å°ç¨‹åº WebView ä¸­ï¼Œæ­£å¸¸åŠ è½½ H5 é¡µé¢');
        console.log('ğŸ’¡ é‚€è¯·åŠŸèƒ½å°†è¢«éšè—ï¼ˆå°ç¨‹åºç¯å¢ƒä½¿ç”¨åˆ†äº«åŠŸèƒ½ï¼‰');
      } else if (!IS_WECHAT) {
        console.log('ğŸŒ æµè§ˆå™¨ç¯å¢ƒï¼Œæ­£å¸¸åŠ è½½ H5 é¡µé¢');
      } else if (IS_WECHAT && !IS_IN_MINIPROGRAM) {
        console.log('âš ï¸ å¾®ä¿¡æµè§ˆå™¨ç¯å¢ƒï¼Œä½†ä¸åœ¨å°ç¨‹åºä¸­');
      }
    })();


  </script>

  <!-- ZEGO Token ç”Ÿæˆåº“ï¼ˆå†…åµŒå®ç°ï¼‰ -->
  <script>
    // Token ç”Ÿæˆå‡½æ•°ï¼ˆå†…åµŒå®ç°ï¼Œé¿å… CDN åŠ è½½é—®é¢˜ï¼‰
    function generateToken04(appId, userId, secret, effectiveTimeInSeconds, payload) {
      if (!payload) {
        payload = '';
      }

      // HMAC-SHA256 å®ç°
      async function hmacSHA256(key, message) {
        const encoder = new TextEncoder();
        const keyData = encoder.encode(key);
        const messageData = encoder.encode(message);

        const cryptoKey = await crypto.subtle.importKey(
          'raw',
          keyData,
          { name: 'HMAC', hash: 'SHA-256' },
          false,
          ['sign']
        );

        const signature = await crypto.subtle.sign('HMAC', cryptoKey, messageData);
        return new Uint8Array(signature);
      }

      // Base64 ç¼–ç 
      function base64Encode(bytes) {
        let binary = '';
        for (let i = 0; i < bytes.length; i++) {
          binary += String.fromCharCode(bytes[i]);
        }
        return btoa(binary).replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
      }

      // ç”Ÿæˆ Token
      const expire = Math.floor(Date.now() / 1000) + effectiveTimeInSeconds;
      const body = {
        app_id: appId,
        user_id: userId,
        nonce: Math.floor(Math.random() * 2147483647),
        ctime: Math.floor(Date.now() / 1000),
        expire: expire
      };

      if (payload) {
        body.payload = payload;
      }

      const header = { alg: 'HS256', typ: 'JWT' };
      const headerStr = JSON.stringify(header);
      const bodyStr = JSON.stringify(body);

      const encoder = new TextEncoder();
      const headerBase64 = base64Encode(encoder.encode(headerStr));
      const bodyBase64 = base64Encode(encoder.encode(bodyStr));
      const toSign = headerBase64 + '.' + bodyBase64;

      // è¿”å› Promise
      return hmacSHA256(secret, toSign).then(signature => {
        const signatureBase64 = base64Encode(signature);
        return '04' + toSign + '.' + signatureBase64;
      });
    }
  </script>

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica', 'Arial', sans-serif;
      background: linear-gradient(180deg, #5fb3a3 0%, #4a9d8e 100%);
      overflow: hidden;
    }

    .container {
      width: 100vw;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* å¤´éƒ¨ä¿¡æ¯æ  */
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 12px;
      background: rgba(255, 255, 255, 0.95);
      border-radius: 8px;
      margin: 8px 8px 0 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15), 0 2px 4px rgba(0, 0, 0, 0.1);
      flex-shrink: 0;
    }

    .header-left,
    .header-right {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .info-item {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .room-label,
    .time-label {
      font-size: 12px;
      color: #666;
    }

    .room-value,
    .time-value {
      font-size: 13px;
      color: #333;
      font-weight: 500;
    }

    /* è§†é¢‘ç½‘æ ¼ - ä¸ä¸»æŒäººç«¯ä¿æŒä¸€è‡´ï¼ˆ2è¡Œ3åˆ—ï¼Œå…±6ä¸ªä½ç½®ï¼‰ */
    .video-grid {
      flex: 1;
      display: grid;
      grid-template-columns: 1fr 1fr;
      grid-auto-rows: calc((100% - 8px) / 2);
      gap: 8px;
      padding: 8px;
      background: transparent;
      overflow-y: auto;
      overflow-x: hidden;
      position: relative; /* ä¸ºæè¯å™¨æä¾›å®šä½ä¸Šä¸‹æ–‡ */
    }

    /* éšè—æ»šåŠ¨æ¡ */
    .video-grid::-webkit-scrollbar {
      display: none;
    }

    .video-grid {
      -ms-overflow-style: none;
      scrollbar-width: none;
    }

    .video-item {
      position: relative;
      background: #000;
      border-radius: 12px;
      overflow: hidden;
      min-height: 0;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3), 0 4px 8px rgba(0, 0, 0, 0.2);
      transition: box-shadow 0.3s ease;
    }

    .video-item:hover {
      box-shadow: 0 12px 32px rgba(0, 0, 0, 0.4), 0 6px 12px rgba(0, 0, 0, 0.25);
    }

    .video-box {
      width: 100%;
      height: 100%;
      position: relative;
    }

    .video-player {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }

    /* âœ… æœ¬åœ°è§†é¢‘é•œåƒï¼šè®©å‰ç½®æ‘„åƒå¤´çš„ç”»é¢ç¬¦åˆè‡ªæ‹ä¹ æƒ¯ï¼ˆå·¦å³ç¿»è½¬ï¼‰
     * æ³¨æ„ï¼šåªå¯¹æœ¬åœ°é¢„è§ˆé•œåƒï¼Œæ¨æµç»™å¯¹æ–¹çš„ç”»é¢æ˜¯æ­£å¸¸çš„ï¼ˆä¸é•œåƒï¼‰
     */
    #localVideo {
      transform: scaleX(-1);  /* æ°´å¹³ç¿»è½¬æœ¬åœ°è§†é¢‘ */
    }

    .video-label {
      position: absolute;
      bottom: 8px;
      left: 8px;
      background: rgba(0, 0, 0, 0.7);
      color: #fff;
      padding: 4px 10px;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 500;
      z-index: 1;
    }

    /* å ä½ç¬¦ */
    .video-placeholder {
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: linear-gradient(135deg, #1a1a1a 0%, #2a2a2a 100%);
      color: #666;
    }

    /* ç©ºä½å ä½ç¬¦æ ·å¼ - é•¶åµŒæ•ˆæœç‰ˆ */
    .empty-slot {
      background: linear-gradient(135deg, #1a1a1a 0%, #2a2a2a 100%);
      border: 1px solid #333;
    }

    .empty-slot .placeholder-icon {
      /* ğŸ”¥ é•¶åµŒæ•ˆæœï¼šåœ†å½¢å‡¹é™·å®¹å™¨ */
      width: 80px;
      height: 80px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 16px;
      position: relative;

      /* ğŸ”¥ æ·±è‰²èƒŒæ™¯ï¼Œä¸å®¹å™¨èä¸ºä¸€ä½“ */
      background: linear-gradient(145deg, #151515, #1f1f1f);

      /* ğŸ”¥ å†…é˜´å½±ï¼šè¥é€ "å‡¹é™·"æ•ˆæœ */
      box-shadow:
        inset 5px 5px 10px rgba(0, 0, 0, 0.8),      /* å·¦ä¸Šæ·±è‰²é˜´å½±ï¼ˆå‡¹é™·ï¼‰ */
        inset -5px -5px 10px rgba(255, 255, 255, 0.03), /* å³ä¸‹æµ…è‰²é«˜å…‰ï¼ˆæ·±åº¦ï¼‰ */
        inset 0 0 20px rgba(0, 0, 0, 0.4),          /* æ•´ä½“å†…é˜´å½± */
        0 1px 2px rgba(0, 0, 0, 0.3);               /* è½»å¾®å¤–é˜´å½±å¢åŠ å±‚æ¬¡ */

      /* ğŸ”¥ Logoå›¾æ ‡ï¼ˆä¸ä½¿ç”¨emojiï¼Œæ”¹ç”¨èƒŒæ™¯å›¾ï¼‰ */
      font-size: 0; /* éšè—emoji */

      /* æ·»åŠ å¾®å¦™çš„è¿‡æ¸¡æ•ˆæœ */
      transition: all 0.3s ease;
    }

    /* ğŸ”¥ LogoèƒŒæ™¯å›¾ */
    .empty-slot .placeholder-icon::before {
      content: '';
      position: absolute;
      width: 50px;
      height: 50px;
      background-image: url('./assets/logo-dove.svg');
      background-size: contain;
      background-position: center;
      background-repeat: no-repeat;
      opacity: 0.4; /* åŠé€æ˜ï¼Œåƒ"åˆ»"åœ¨é‡Œé¢ */
      filter: brightness(1.2) contrast(1.1); /* è½»å¾®æäº® */
    }

    /* æ‚¬åœæ•ˆæœï¼šè½»å¾®"æµ®èµ·" */
    .empty-slot .placeholder-icon:hover {
      box-shadow:
        inset 3px 3px 8px rgba(0, 0, 0, 0.7),
        inset -3px -3px 8px rgba(255, 255, 255, 0.04),
        inset 0 0 15px rgba(0, 0, 0, 0.3),
        0 2px 4px rgba(0, 0, 0, 0.4);
    }

    .empty-slot .placeholder-icon:hover::before {
      opacity: 0.5; /* æ‚¬åœæ—¶logoç¨å¾®äº®ä¸€ç‚¹ */
    }

    .empty-slot .placeholder-text {
      color: #888;
      font-size: 14px;
      font-weight: 400;
      margin-top: 4px;
    }

    .placeholder-icon {
      font-size: 48px;
      margin-bottom: 8px;
      opacity: 0.5;
    }

    .placeholder-text {
      font-size: 13px;
    }

    /* æ§åˆ¶æŒ‰é’® */
    .controls {
      padding: 10px 6px;
      margin: 10px;
      background: rgba(255, 255, 255, 0.98);
      border-radius: 12px;
      display: flex;
      justify-content: space-around;
      align-items: center;
      box-shadow: 0 -2px 10px rgba(95, 179, 163, 0.15);
    }

    .control-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 6px;
      cursor: pointer;
      padding: 8px 16px;
      border-radius: 12px;
      transition: all 0.2s;
      min-width: 70px;
    }

    .control-item:active {
      transform: scale(0.95);
      background: rgba(0, 0, 0, 0.05);
    }

    .control-icon-text {
      font-size: 28px;
      line-height: 1;
    }

    .control-label {
      font-size: 12px;
      color: #666;
      font-weight: 400;
    }

    /* å…³é—­çŠ¶æ€æ ·å¼ */
    .control-item.disabled {
      opacity: 0.5;
    }

    .control-item.disabled .control-icon-text {
      color: #999;
    }

    .control-item.disabled .control-label {
      color: #999;
    }

    .control-item-danger:active {
      background: rgba(255, 68, 68, 0.1);
    }

    .control-item-danger .control-icon-text {
      color: #f44;
    }

    .control-item-danger .control-label {
      color: #f44;
    }

    /* åŠ è½½æç¤º */
    .loading {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0, 0, 0, 0.8);
      color: #fff;
      padding: 20px 30px;
      border-radius: 8px;
      font-size: 16px;
      z-index: 2000;
    }

    /* é‚€è¯·å¼¹çª—æ ·å¼ */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.6);
      z-index: 3000;
      justify-content: center;
      align-items: center;
    }

    .modal.show {
      display: flex;
    }

    .modal-content {
      background: #fff;
      border-radius: 16px;
      width: 90%;
      max-width: 450px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      animation: modalSlideIn 0.3s ease;
    }

    @keyframes modalSlideIn {
      from {
        transform: translateY(-50px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px 24px;
      border-bottom: 1px solid #eee;
    }

    .modal-header h3 {
      margin: 0;
      font-size: 18px;
      color: #333;
    }

    .modal-close {
      font-size: 28px;
      color: #999;
      cursor: pointer;
      line-height: 1;
      transition: color 0.3s;
    }

    .modal-close:hover {
      color: #333;
    }

    .modal-body {
      padding: 24px;
    }

    .modal-tip {
      margin: 0 0 12px 0;
      color: #666;
      font-size: 14px;
    }

    .invite-link-box {
      background: #f5f5f5;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 16px;
    }

    .invite-link-input {
      width: 100%;
      border: none;
      background: transparent;
      color: #333;
      font-size: 13px;
      outline: none;
      word-break: break-all;
    }

    .invite-copy-btn {
      width: 100%;
      padding: 14px;
      background: linear-gradient(135deg, #5fb3a3 0%, #4a9d8e 100%);
      color: #fff;
      border: none;
      border-radius: 10px;
      font-size: 16px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s;
      box-shadow: 0 4px 16px rgba(95, 179, 163, 0.3);
    }

    .invite-copy-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(95, 179, 163, 0.4);
    }

    .invite-copy-btn:active {
      transform: translateY(0);
    }

    .modal-hint {
      margin: 16px 0 0 0;
      text-align: center;
      color: #999;
      font-size: 13px;
    }

    /* âœ… é‡è¿æç¤ºæ ·å¼ */
    .reconnect-toast {
      position: fixed;
      top: 80px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.85);
      color: #fff;
      padding: 12px 24px;
      border-radius: 20px;
      font-size: 14px;
      z-index: 10000;
      display: none;
      align-items: center;
      gap: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }

    .reconnect-toast.show {
      display: flex;
    }

    .reconnect-spinner {
      width: 16px;
      height: 16px;
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-top-color: #fff;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* âœ… é¡µé¢åå°æç¤ºæ ·å¼ */
    .background-toast {
      position: fixed;
      top: 80px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(255, 152, 0, 0.95);
      color: #fff;
      padding: 12px 24px;
      border-radius: 20px;
      font-size: 14px;
      z-index: 10000;
      display: none;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }

    .background-toast.show {
      display: block;
    }

    /* ğŸ”¥ èº«ä»½é€‰æ‹©æµ®çª—æ ·å¼ - åŠé€æ˜èƒŒæ™¯,æ˜¾ç¤ºåœ¨è§†é¢‘ç•Œé¢ä¸Š */
    .identity-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(10px);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10000;
      padding: 20px 0;
    }

    .identity-modal {
      background: #fff;
      border-radius: 20px;
      padding: 40px 30px;
      width: calc(100% - 20px);
      max-width: 400px;
      box-shadow: 0 24px 64px rgba(0, 0, 0, 0.4), 0 12px 24px rgba(0, 0, 0, 0.3);
    }

    .identity-header {
      text-align: center;
      margin-bottom: 30px;
    }

    .identity-header h1 {
      font-size: 24px;
      color: #333;
      margin-bottom: 8px;
    }

    .identity-form {
      display: flex;
      flex-direction: column;
    }

    .form-group {
      margin-bottom: 24px;
    }

    .form-group label {
      display: block;
      font-size: 14px;
      color: #666;
      margin-bottom: 8px;
    }

    .form-group input {
      width: 100%;
      padding: 14px 16px;
      border: 1px solid #ddd;
      border-radius: 10px;
      font-size: 15px;
      transition: border-color 0.3s;
    }

    .form-group input:focus {
      outline: none;
      border-color: #5fb3a3;
    }

    .role-group {
      margin-bottom: 30px;
    }

    .role-group label {
      display: block;
      font-size: 14px;
      color: #666;
      margin-bottom: 12px;
    }

    .role-options {
      display: flex;
      gap: 12px;
    }

    .role-option {
      flex: 1;
      position: relative;
    }

    .role-option input[type="radio"] {
      position: absolute;
      opacity: 0;
    }

    .role-option label {
      display: block;
      padding: 16px;
      border: 2px solid #e0e0e0;
      border-radius: 10px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s;
      font-size: 15px;
      color: #666;
    }

    .role-option input[type="radio"]:checked + label {
      border-color: #5fb3a3;
      background: rgba(95, 179, 163, 0.1);
      color: #5fb3a3;
      font-weight: 600;
    }

    .role-option label:hover {
      border-color: #5fb3a3;
    }

    .join-btn {
      width: 100%;
      padding: 16px;
      background: linear-gradient(135deg, #5fb3a3 0%, #4a9d8e 100%);
      color: #fff;
      border: none;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      box-shadow: 0 4px 16px rgba(95, 179, 163, 0.3);
    }

    .join-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(95, 179, 163, 0.4);
    }

    .join-btn:active {
      transform: translateY(0);
    }

    .join-btn:disabled {
      background: linear-gradient(135deg, #b0b0b0 0%, #909090 100%);
      cursor: not-allowed;
      box-shadow: none;
      opacity: 0.7;
      position: relative;
    }

    /* åŠ è½½åŠ¨ç”» */
    .join-btn:disabled::after {
      content: '';
      position: absolute;
      right: 20px;
      top: 50%;
      transform: translateY(-50%);
      width: 16px;
      height: 16px;
      border: 2px solid #fff;
      border-top-color: transparent;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      0% { transform: translateY(-50%) rotate(0deg); }
      100% { transform: translateY(-50%) rotate(360deg); }
    }

    /* ==================== æè¯å™¨æ ·å¼ ==================== */
    .teleprompter-container {
      position: absolute !important;
      /* è¦†ç›–ä¸Šé¢ä¸¤ä¸ªè§†é¢‘å®¹å™¨ï¼ˆç¬¬ä¸€è¡Œï¼‰ï¼Œè€ƒè™‘paddingå’Œgap */
      top: 8px !important; /* è·³è¿‡padding */
      left: 8px !important; /* è·³è¿‡padding */
      right: 8px !important; /* è·³è¿‡padding */
      /* é«˜åº¦ç­‰äºç¬¬ä¸€è¡Œçš„é«˜åº¦ï¼ˆä¸åŒ…å«gapï¼‰ */
      height: calc((100% - 8px - 16px) / 2) !important; /* å‡å»ä¸Šä¸‹padding(16px)å’Œgap(8px) */
      background: rgba(0, 0, 0, 0.92) !important;
      color: #fff !important;
      z-index: 100 !important; /* è¦†ç›–è§†é¢‘å®¹å™¨ */
      display: none !important;
      flex-direction: column !important;
      border-radius: 12px !important; /* ä¸è§†é¢‘å®¹å™¨ä¸€è‡´çš„åœ†è§’ */
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.8) !important;
      border: 2px solid rgba(255, 255, 255, 0.1) !important;
      transition: all 0.3s ease !important;
      overflow: hidden !important;
      pointer-events: auto !important;
      margin: 0 !important;
      padding: 0 !important;
    }

    .teleprompter-container.show {
      display: flex !important;
    }

    .teleprompter-content {
      padding: 30px 20px !important;
      overflow-y: auto !important;
      font-size: 22px !important;
      line-height: 2.2 !important;
      text-align: left !important;
      white-space: pre-wrap !important;
      word-wrap: break-word !important;
      flex: 1 !important;
      font-weight: 500 !important;
      /* éšè—æ»šåŠ¨æ¡ */
      scrollbar-width: none !important; /* Firefox */
      -ms-overflow-style: none !important; /* IE/Edge */
    }

    /* éšè—æ»šåŠ¨æ¡ - Webkitæµè§ˆå™¨ */
    .teleprompter-content::-webkit-scrollbar {
      display: none !important;
    }

    .teleprompter-content.scrolling {
      /* ä¸ä½¿ç”¨CSSåŠ¨ç”»ï¼Œæ”¹ç”¨JavaScriptå¹³æ»‘æ»šåŠ¨ */
    }

    /* ğŸ” è°ƒè¯•æµ®çª—æ ·å¼ */
    #debugPanel {
      position: fixed !important;
      top: 60px !important;
      left: 10px !important;
      background: rgba(255, 0, 0, 0.95) !important;
      color: #fff !important;
      font-family: 'Courier New', monospace;
      font-size: 12px !important;
      padding: 15px !important;
      border-radius: 8px;
      z-index: 9999999 !important;
      max-width: 90vw !important;
      max-height: 70vh !important;
      overflow-y: auto;
      box-shadow: 0 8px 24px rgba(255, 0, 0, 0.8) !important;
      border: 3px solid #ff0 !important;
      pointer-events: auto !important;
    }

    #debugPanel.hidden {
      display: none;
    }

    #debugPanel .debug-title {
      color: #fff !important;
      font-weight: bold;
      margin-bottom: 8px;
      border-bottom: 2px solid #ff0 !important;
      padding-bottom: 5px;
      font-size: 14px !important;
    }

    #debugPanel .debug-item {
      margin: 8px 0 !important;
      line-height: 1.6 !important;
    }

    #debugPanel .debug-label {
      color: #ff0 !important;
      font-weight: bold;
    }

    #debugPanel .debug-value {
      color: #fff !important;
    }

    #debugPanel .debug-value.error {
      color: #ff0 !important;
      background: #800 !important;
      padding: 2px 5px;
      border-radius: 3px;
    }

    #debugPanel .debug-value.success {
      color: #0f0 !important;
      background: #080 !important;
      padding: 2px 5px;
      border-radius: 3px;
    }

    #debugPanel .debug-toggle {
      position: absolute;
      top: 8px;
      right: 8px;
      background: #fff !important;
      color: #f00 !important;
      border: 2px solid #ff0 !important;
      border-radius: 5px;
      padding: 5px 10px !important;
      cursor: pointer;
      font-size: 14px !important;
      font-weight: bold;
    }

    #debugPanel .debug-section {
      margin-top: 12px !important;
      padding-top: 10px !important;
      border-top: 2px dashed #ff0 !important;
    }
  </style>
</head>
<body>
  <!-- âœ… é‡è¿æç¤º -->
  <div class="reconnect-toast" id="reconnectToast">
    <div class="reconnect-spinner"></div>
    <span>æ­£åœ¨é‡æ–°è¿æ¥...</span>
  </div>

  <!-- âœ… é¡µé¢åå°æç¤º -->
  <div class="background-toast" id="backgroundToast">
    ğŸ“± é¡µé¢å·²è¿›å…¥åå°
  </div>

  <!-- ğŸ”¥ èº«ä»½é€‰æ‹©æµ®çª— - ç»Ÿä¸€æ‰€æœ‰å¹³å°çš„å…¥å£ -->
  <div id="identityOverlay" class="identity-overlay">
    <div class="identity-modal">
      <div class="identity-header">
        <h1>ğŸ¥ åŠ å…¥è§†é¢‘é¢è¯•</h1>
      </div>

      <form id="joinForm" class="identity-form" action="javascript:void(0);" onsubmit="return false;">
        <div class="form-group">
          <label id="nameLabel">æ‚¨çš„å§“åï¼ˆé€‰å¡«ï¼‰</label>
          <input type="text" id="nameInput" placeholder="è¯·è¾“å…¥æ‚¨çš„å§“å" maxlength="20" />
        </div>

        <div class="role-group">
          <label>é€‰æ‹©æ‚¨çš„è§’è‰² <span style="color: #f44;">*</span></label>
          <div class="role-options">
            <div class="role-option">
              <input type="radio" id="roleCustomer" name="role" value="customer" checked />
              <label for="roleCustomer">ğŸ‘¤ æˆ‘æ˜¯å®¢æˆ·</label>
            </div>
            <div class="role-option">
              <input type="radio" id="roleHelper" name="role" value="helper" />
              <label for="roleHelper">ğŸ‘© æˆ‘æ˜¯é˜¿å§¨</label>
            </div>
          </div>
        </div>

        <button type="submit" id="joinBtn" class="join-btn" disabled>
          æ­£åœ¨åŠ è½½èµ„æº...
        </button>
      </form>
    </div>
  </div>

  <div class="container">
    <!-- é¡¶éƒ¨ä¿¡æ¯ -->
    <div class="header">
      <div class="header-left">
        <div class="info-item">
          <span class="room-label">æˆ¿é—´å·ï¼š</span>
          <span class="room-value" id="roomIdDisplay">-</span>
        </div>
      </div>
      <div class="header-right">
        <div class="info-item">
          <span class="time-label">é¢è¯•æ—¶é—´ï¼š</span>
          <span class="time-value" id="timer">00:00</span>
        </div>
      </div>
    </div>

    <!-- è§†é¢‘ç½‘æ ¼ - 6ä¸ªä½ç½® -->
    <div class="video-grid">
      <!-- æè¯å™¨å®¹å™¨ - è¦†ç›–ä¸Šé¢ä¸¤ä¸ªè§†é¢‘å®¹å™¨ -->
      <div id="teleprompterContainer" class="teleprompter-container">
        <div id="teleprompterContent" class="teleprompter-content"></div>
      </div>

      <!-- ä½ç½®1ï¼šæœ¬åœ°è§†é¢‘ -->
      <div class="video-item">
        <div class="video-box" id="localBox">
          <video id="localVideo" class="video-player" autoplay muted playsinline></video>
          <div class="video-label" id="localLabel">æˆ‘</div>
        </div>
      </div>

      <!-- ä½ç½®2ï¼šä¸»æŒäºº -->
      <div class="video-item">
        <div class="video-box" id="remoteBox1">
          <div class="video-placeholder">
            <div class="placeholder-icon">ğŸ‘¤</div>
            <div class="placeholder-text">ç­‰å¾…ä¸»æŒäºº...</div>
          </div>
        </div>
      </div>

      <!-- ä½ç½®3ï¼šå…¶ä»–å‚ä¸è€… -->
      <div class="video-item">
        <div class="video-box" id="remoteBox2">
          <div class="video-placeholder empty-slot">
            <div class="placeholder-icon">ğŸ‘¤</div>
            <div class="placeholder-text">ç­‰å¾…åŠ å…¥</div>
          </div>
        </div>
      </div>

      <!-- ä½ç½®4ï¼šå…¶ä»–å‚ä¸è€… -->
      <div class="video-item">
        <div class="video-box" id="remoteBox3">
          <div class="video-placeholder empty-slot">
            <div class="placeholder-icon">ğŸ‘¤</div>
            <div class="placeholder-text">ç­‰å¾…åŠ å…¥</div>
          </div>
        </div>
      </div>

      <!-- ä½ç½®5ï¼šå…¶ä»–å‚ä¸è€… -->
      <div class="video-item">
        <div class="video-box" id="remoteBox4">
          <div class="video-placeholder empty-slot">
            <div class="placeholder-icon">ğŸ‘¤</div>
            <div class="placeholder-text">ç­‰å¾…åŠ å…¥</div>
          </div>
        </div>
      </div>

      <!-- ä½ç½®6ï¼šå…¶ä»–å‚ä¸è€… -->
      <div class="video-item">
        <div class="video-box" id="remoteBox5">
          <div class="video-placeholder empty-slot">
            <div class="placeholder-icon">ğŸ‘¤</div>
            <div class="placeholder-text">ç­‰å¾…åŠ å…¥</div>
          </div>
        </div>
      </div>
    </div>

    <!-- æ§åˆ¶æŒ‰é’® -->
    <div class="controls">
      <div class="control-item" id="micBtn" onclick="toggleMic()">
        <div class="control-icon-text">ğŸ¤</div>
        <div class="control-label">éº¦å…‹é£</div>
      </div>
      <div class="control-item" id="cameraBtn" onclick="toggleCamera()">
        <div class="control-icon-text">ğŸ“¹</div>
        <div class="control-label">æ‘„åƒå¤´</div>
      </div>
      <div class="control-item" id="flipBtn" onclick="flipCamera()">
        <div class="control-icon-text">ğŸ”„</div>
        <div class="control-label">ç¿»è½¬</div>
      </div>
      <div class="control-item control-item-danger" onclick="leaveRoom()">
        <div class="control-icon-text">ğŸ“</div>
        <div class="control-label">ç¦»å¼€æˆ¿é—´</div>
      </div>
    </div>
  </div>

  <div id="loading" class="loading" style="display: none;">æ­£åœ¨è¿æ¥...</div>

  <!-- é‚€è¯·å¼¹çª— -->
  <div id="inviteModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>é‚€è¯·ç”¨æˆ·</h3>
        <span class="modal-close" onclick="closeInviteModal()">&times;</span>
      </div>
      <div class="modal-body">
        <p class="modal-tip">å¤åˆ¶ä»¥ä¸‹é“¾æ¥å‘é€ç»™å…¶ä»–äººï¼š</p>
        <div class="invite-link-box">
          <input type="text" id="inviteLink" class="invite-link-input" readonly>
        </div>
        <button class="invite-copy-btn" onclick="copyInviteLink()">
          ğŸ“‹ å¤åˆ¶é“¾æ¥å¹¶é‚€è¯·
        </button>
        <p class="modal-hint">ğŸ’¡ å¯¹æ–¹ç‚¹å‡»é“¾æ¥å³å¯åŠ å…¥</p>
      </div>
    </div>
  </div>

  <script>
    // ğŸ”¥ æœ€æ—©çš„è°ƒè¯•æ—¥å¿— - ç¡®è®¤é¡µé¢å·²åŠ è½½
    console.log('ğŸ¬ video-interview-guest-room.html é¡µé¢å¼€å§‹åŠ è½½');
    console.log('ğŸŒ å½“å‰URL:', window.location.href);
    console.log('ğŸ” URL searchéƒ¨åˆ†:', window.location.search);

    // è·å–URLå‚æ•° - ğŸ”¥ åªéœ€è¦roomId
    const urlParams = new URLSearchParams(window.location.search);
    const roomId = urlParams.get('roomId');

    // ğŸ”¥ userNameå’Œroleå°†åœ¨æµ®çª—ä¸­è¾“å…¥
    let userName = '';
    let userRole = '';

    console.log('ğŸ“‹ URLå‚æ•°:', {
      roomId: roomId,
      allParams: Array.from(urlParams.entries())
    });

    if (!roomId) {
      console.error('âŒ ç¼ºå°‘æˆ¿é—´å·å‚æ•°!');
      console.error('å½“å‰URL:', window.location.href);
      console.error('URL search:', window.location.search);
      console.error('æ‰€æœ‰å‚æ•°:', Array.from(urlParams.entries()));
      console.error('Referrer:', document.referrer);

      // ğŸ”¥ åˆ›å»ºä¸€ä¸ªè‡ªå®šä¹‰çš„é”™è¯¯é¡µé¢ï¼Œè€Œä¸æ˜¯ç”¨alert
      document.body.innerHTML = `
        <div style="
          position: fixed;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          display: flex;
          align-items: center;
          justify-content: center;
          font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
          padding: 20px;
          z-index: 999999;
        ">
          <div style="
            background: white;
            border-radius: 20px;
            padding: 40px;
            max-width: 600px;
            width: 100%;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
          ">
            <div style="text-align: center; margin-bottom: 30px;">
              <div style="font-size: 60px; margin-bottom: 20px;">âš ï¸</div>
              <h1 style="color: #333; margin: 0 0 10px 0; font-size: 24px;">æ— æ³•åŠ å…¥é¢è¯•é—´</h1>
              <p style="color: #666; margin: 0; font-size: 16px;">ç¼ºå°‘æˆ¿é—´å·å‚æ•°</p>
            </div>

            <div style="background: #f5f5f5; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
              <h3 style="color: #333; margin: 0 0 15px 0; font-size: 16px;">ğŸ“‹ è°ƒè¯•ä¿¡æ¯</h3>
              <div style="font-size: 13px; color: #666; line-height: 1.8; word-break: break-all;">
                <p style="margin: 5px 0;"><strong>å½“å‰URL:</strong><br>${window.location.href}</p>
                <p style="margin: 5px 0;"><strong>URLå‚æ•°:</strong><br>${window.location.search || '(æ— )'}</p>
                <p style="margin: 5px 0;"><strong>æ¥æºé¡µé¢:</strong><br>${document.referrer || '(ç›´æ¥è®¿é—®)'}</p>
                <p style="margin: 5px 0;"><strong>æ‰€æœ‰å‚æ•°:</strong><br>${JSON.stringify(Array.from(urlParams.entries()))}</p>
              </div>
            </div>

            <div style="background: #fff3cd; padding: 20px; border-radius: 10px; border-left: 4px solid #ffc107; margin-bottom: 20px;">
              <h3 style="color: #856404; margin: 0 0 10px 0; font-size: 14px;">ğŸ’¡ å¯èƒ½çš„åŸå› </h3>
              <ul style="margin: 0; padding-left: 20px; color: #856404; font-size: 13px; line-height: 1.8;">
                <li>ç›´æ¥åˆ†äº«äº†å½“å‰é¡µé¢çš„URLï¼ˆé”™è¯¯âŒï¼‰</li>
                <li>ä½¿ç”¨äº†è¿‡æœŸæˆ–æ— æ•ˆçš„é“¾æ¥</li>
                <li>æµè§ˆå™¨ç¼“å­˜äº†æ—§ç‰ˆæœ¬çš„é¡µé¢</li>
              </ul>
            </div>

            <div style="background: #d1ecf1; padding: 20px; border-radius: 10px; border-left: 4px solid #17a2b8; margin-bottom: 20px;">
              <h3 style="color: #0c5460; margin: 0 0 10px 0; font-size: 14px;">âœ… æ­£ç¡®åšæ³•</h3>
              <ol style="margin: 0; padding-left: 20px; color: #0c5460; font-size: 13px; line-height: 1.8;">
                <li>ç‚¹å‡»é¢è¯•é—´å³ä¸Šè§’çš„"+"æŒ‰é’®</li>
                <li>ç‚¹å‡»"å¤åˆ¶é“¾æ¥å¹¶é‚€è¯·"</li>
                <li>å°†å¤åˆ¶çš„é“¾æ¥å‘é€ç»™å¯¹æ–¹</li>
              </ol>
            </div>

            <button onclick="navigator.clipboard.writeText('${window.location.href}').then(() => alert('URLå·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼'))"
              style="
                width: 100%;
                padding: 15px;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                border: none;
                border-radius: 10px;
                font-size: 16px;
                font-weight: bold;
                cursor: pointer;
                margin-bottom: 10px;
              ">
              ğŸ“‹ å¤åˆ¶å½“å‰URLï¼ˆç”¨äºåé¦ˆé—®é¢˜ï¼‰
            </button>

            <button onclick="window.close()"
              style="
                width: 100%;
                padding: 15px;
                background: #6c757d;
                color: white;
                border: none;
                border-radius: 10px;
                font-size: 16px;
                cursor: pointer;
              ">
              å…³é—­é¡µé¢
            </button>
          </div>
        </div>
      `;

      throw new Error('ç¼ºå°‘æˆ¿é—´å·å‚æ•°');
    }

    // ğŸ”’ é˜²æ­¢å¾®ä¿¡åˆ†äº«ç›´æ¥è¿›å…¥æˆ¿é—´ï¼šæ£€æµ‹æ˜¯å¦æ˜¯æ­£å¸¸æµç¨‹è¿›å…¥
    // ä½¿ç”¨ sessionStorage æ ‡è®°æ˜¯å¦ä»é€‰æ‹©èº«ä»½é¡µé¢è·³è½¬è¿‡æ¥
    const fromGuestPage = sessionStorage.getItem('fromGuestPage');

    // ğŸ¯ å…³é”®ï¼šæ£€æŸ¥ localStorage ä¸­æ˜¯å¦æœ‰è¯¥æˆ¿é—´çš„ç”¨æˆ·ä¿¡æ¯ï¼ˆç”¨äºé‡æ–°è¿›å…¥ï¼‰
    // ä½¿ç”¨ roomId ä½œä¸ºé”®åï¼Œå€¼ä¸­åŒ…å« userIdã€userNameã€userRole
    const savedUserInfoKey = `guest_user_info_${roomId}`;
    const savedUserInfo = localStorage.getItem(savedUserInfoKey);

    console.log('ğŸ” æ£€æŸ¥è®¿é—®æ¥æº:', {
      fromGuestPage: !!fromGuestPage,
      savedUserInfo: !!savedUserInfo,
      savedUserInfoContent: savedUserInfo
    });

    // ğŸ¯ å¦‚æœæœ‰ä¿å­˜çš„ç”¨æˆ·ä¿¡æ¯ï¼Œè¯´æ˜æ˜¯ç¬¬äºŒæ¬¡è¿›å…¥ï¼Œç›´æ¥ä½¿ç”¨ä¿å­˜çš„ä¿¡æ¯
    if (savedUserInfo) {
      try {
        const userInfo = JSON.parse(savedUserInfo);
        userName = userInfo.userName;
        userRole = userInfo.userRole;

        // ğŸ¯ æ¢å¤ userId åˆ° sessionStorageï¼ˆè¿™æ · loginRoom æ—¶ä¼šä½¿ç”¨åŒä¸€ä¸ª userIdï¼‰
        const sessionKey = `zego_user_${roomId}`;
        if (userInfo.userId) {
          sessionStorage.setItem(sessionKey, userInfo.userId);
          console.log('âœ… æ£€æµ‹åˆ°ç¬¬äºŒæ¬¡è¿›å…¥ï¼Œæ¢å¤ç”¨æˆ·ä¿¡æ¯:', { userName, userRole, userId: userInfo.userId });
        } else {
          console.log('âœ… æ£€æµ‹åˆ°ç¬¬äºŒæ¬¡è¿›å…¥ï¼Œä½¿ç”¨ä¿å­˜çš„ç”¨æˆ·ä¿¡æ¯:', { userName, userRole });
        }
        // ğŸ¯ æ ‡è®°ä¸ºå·²ç™»è®°ï¼Œåç»­ä¼šè‡ªåŠ¨åŠ å…¥æˆ¿é—´
      } catch (e) {
        console.error('âŒ è§£æä¿å­˜çš„ç”¨æˆ·ä¿¡æ¯å¤±è´¥:', e);
        // è§£æå¤±è´¥ï¼Œæ¸…é™¤æ— æ•ˆæ•°æ®ï¼Œé‡å®šå‘åˆ°é€‰æ‹©èº«ä»½é¡µé¢
        localStorage.removeItem(savedUserInfoKey);
        window.location.href = `video-interview-guest.html?roomId=${roomId}`;
        throw new Error('Invalid saved user info');
      }
    } else if (!fromGuestPage) {
      // æ—¢ä¸æ˜¯ä»é€‰æ‹©èº«ä»½é¡µé¢è·³è½¬è¿‡æ¥ï¼Œä¹Ÿæ²¡æœ‰ä¿å­˜çš„ç”¨æˆ·ä¿¡æ¯ï¼ˆå¯èƒ½æ˜¯å¾®ä¿¡åˆ†äº«çš„é“¾æ¥ï¼‰
      console.log('âš ï¸ æ£€æµ‹åˆ°éæ­£å¸¸æµç¨‹è®¿é—®ï¼Œé‡å®šå‘åˆ°é€‰æ‹©èº«ä»½é¡µé¢');
      // é‡å®šå‘åˆ°é€‰æ‹©èº«ä»½é¡µé¢
      window.location.href = `video-interview-guest.html?roomId=${roomId}`;
      // é˜»æ­¢åç»­ä»£ç æ‰§è¡Œ
      throw new Error('Redirecting to guest page');
    }

    // ğŸ”¥ ä¸è¦ç«‹å³åˆ é™¤æ ‡è®°ï¼ä¿ç•™å®ƒç›´åˆ°ç”¨æˆ·æˆåŠŸè¿›å…¥æˆ¿é—´
    // è¿™æ ·å¯ä»¥é˜²æ­¢åœ¨åˆå§‹åŒ–è¿‡ç¨‹ä¸­é¡µé¢åˆ·æ–°å¯¼è‡´çš„é‡å®šå‘å¾ªç¯
    console.log('âœ… è®¿é—®éªŒè¯é€šè¿‡ï¼Œä¿ç•™æ ‡è®°ç›´åˆ°æˆåŠŸè¿›å…¥æˆ¿é—´');

    // è§’è‰²è½¬æ¢ï¼ˆè‹±æ–‡ -> ä¸­æ–‡æ˜¾ç¤ºï¼‰
    const roleDisplayMap = {
      'customer': 'å®¢æˆ·',
      'helper': 'é˜¿å§¨'
    };
    const roleDisplay = roleDisplayMap[userRole] || 'è®¿å®¢';

    // æ ¼å¼åŒ–æˆ¿é—´å·æ˜¾ç¤ºï¼ˆä¸ä¸»æŒäººç«¯ä¿æŒä¸€è‡´ï¼‰
    const displayRoomId = roomId ? roomId.replace(/^room_/, 'AD-').split('_')[0] : '-';

    // æ˜¾ç¤ºä¿¡æ¯
    document.getElementById('roomIdDisplay').textContent = displayRoomId;
    document.getElementById('localLabel').textContent = userName || roleDisplay;

    if (!roomId) {
      alert('æ— æ•ˆçš„æˆ¿é—´å·');
      window.location.href = 'video-interview-guest.html';
    }

    // ZEGOé…ç½®ï¼ˆä¸ä¸»æŒäººç«¯ä¿æŒä¸€è‡´ï¼‰
    const appID = 1279160453;
    const server = 'wss://webliveroom-api.zego.im/ws';
    const serverSecret = 'e18cc600e2939d412c48f152e157f01d';

    let zg = null;
    let localStream = null;
    let currentUserId = ''; // å½“å‰ç”¨æˆ·ID
    let currentStreamId = ''; // å½“å‰æµID
    let isMicOn = true;
    let isCameraOn = true;
    let isFrontCamera = true; // é»˜è®¤å‰ç½®æ‘„åƒå¤´
    let timerInterval = null;
    let startTime = null;
    let remoteControlPolling = null; // è¿œç¨‹æ§åˆ¶è½®è¯¢å®šæ—¶å™¨
    let lastRemoteControlTimestamp = 0; // æœ€åæ¥æ”¶çš„è¿œç¨‹æ§åˆ¶æ¶ˆæ¯æ—¶é—´æˆ³
    let isKickedOut = false; // æ ‡è®°ç”¨æˆ·æ˜¯å¦å·²è¢«è¸¢å‡º
    let hasLeftRoom = false; // æ ‡è®°ç”¨æˆ·æ˜¯å¦å·²ä¸»åŠ¨ç¦»å¼€æˆ¿é—´
    let roomStatusPolling = null; // æˆ¿é—´çŠ¶æ€è½®è¯¢å®šæ—¶å™¨
    let isRoomDismissed = false; // æ ‡è®°æˆ¿é—´æ˜¯å¦å·²è§£æ•£

    // ç”ŸæˆTokenï¼ˆè®¿å®¢æ¨¡å¼ï¼šè°ƒç”¨åç«¯å…¬å¼€æ¥å£ï¼‰
    async function generateToken(userID, roomID) {
      try {
        console.log('ğŸ”‘ æ­£åœ¨è·å–è®¿å®¢Token...');
        console.log('ğŸ“± AppID:', appID);
        console.log('ğŸ‘¤ UserID:', userID);
        console.log('ğŸ  RoomID:', roomID);
        console.log('ğŸ‘¨ UserName:', userName);
        console.log('ğŸ­ Role:', userRole);

        // è®¿å®¢æ¨¡å¼ï¼šè°ƒç”¨åç«¯å…¬å¼€æ¥å£ï¼ˆæ— éœ€JWTè®¤è¯ï¼‰
        const requestBody = {
          userId: userID,
          roomId: roomID,
          userName: userName,
          role: userRole,
          expireTime: 7200
        };

        console.log('ğŸ“¤ è¯·æ±‚å‚æ•°:', requestBody);

        const response = await fetch('https://crm.andejiazheng.com/api/zego/generate-guest-token', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(requestBody)
        });

        console.log('ğŸ“¥ å“åº”çŠ¶æ€:', response.status, response.statusText);

        if (!response.ok) {
          const errorText = await response.text();
          console.error('âŒ é”™è¯¯å“åº”:', errorText);

          let errorData;
          try {
            errorData = JSON.parse(errorText);
          } catch (e) {
            throw new Error(`HTTP ${response.status}: ${errorText}`);
          }

          throw new Error(errorData.message || `HTTP error! status: ${response.status}`);
        }

        const result = await response.json();
        console.log('ğŸ“¥ å“åº”æ•°æ®:', result);

        if (result.success && result.data && result.data.token) {
          console.log('âœ… Token è·å–æˆåŠŸ');
          return result.data.token;
        } else {
          throw new Error(result.message || 'è·å–Tokenå¤±è´¥');
        }
      } catch (error) {
        console.error('âŒ Token è·å–å¤±è´¥:', error);
        console.error('âŒ é”™è¯¯è¯¦æƒ…:', error.message);
        throw error;
      }
    }

    // ğŸ”¥ å…¨å±€åˆå§‹åŒ–é”ï¼Œé˜²æ­¢å¹¶å‘åˆå§‹åŒ–
    let isInitializing = false;

    // ğŸ”¥ ç»Ÿä¸€çš„åˆå§‹åŒ–æµç¨‹ - åœ¨ç”¨æˆ·ç‚¹å‡»"ç¡®å®šè¿›å…¥é¢è¯•é—´"åæ‰§è¡Œ
    async function init() {
      // ğŸ”¥ é˜²æ­¢å¹¶å‘åˆå§‹åŒ–
      if (isInitializing) {
        console.warn('âš ï¸ æ­£åœ¨åˆå§‹åŒ–ä¸­ï¼Œå¿½ç•¥é‡å¤è¯·æ±‚');
        return;
      }

      isInitializing = true;
      console.log('ğŸš€ ç”¨æˆ·ç‚¹å‡»ç¡®å®šï¼Œåœ¨äº¤äº’ä¸Šä¸‹æ–‡ä¸­å¼€å§‹åˆå§‹åŒ–');
      showLoading('æ­£åœ¨åˆå§‹åŒ–...');

      try {
        // ğŸ”¥ æ£€æµ‹æ˜¯å¦æ˜¯é‡æ–°è¿›å…¥ï¼ˆç”¨æˆ·ä¹‹å‰ç‚¹å‡»Xå…³é—­è¿‡ï¼‰
        const userLeftTime = sessionStorage.getItem(`user_left_${roomId}`);
        if (userLeftTime) {
          const leftTimestamp = parseInt(userLeftTime);
          const now = Date.now();
          const timeSinceLeft = now - leftTimestamp;

          console.log('âš ï¸ æ£€æµ‹åˆ°ç”¨æˆ·ä¹‹å‰ç¦»å¼€è¿‡æˆ¿é—´');
          console.log(`â±ï¸ è·ç¦»ä¸Šæ¬¡ç¦»å¼€: ${Math.round(timeSinceLeft / 1000)}ç§’`);

          // ğŸ”¥ é˜²æŠ–æœºåˆ¶ï¼šå¦‚æœè·ç¦»ä¸Šæ¬¡ç¦»å¼€ä¸åˆ°2ç§’ï¼Œæç¤ºç”¨æˆ·ç¨ç­‰
          if (timeSinceLeft < 2000) {
            const waitTime = Math.ceil((2000 - timeSinceLeft) / 1000);
            hideLoading();
            alert(`è¯·ç¨ç­‰${waitTime}ç§’åå†è¿›å…¥ï¼Œä»¥ç¡®ä¿èµ„æºå®Œå…¨é‡Šæ”¾`);
            // é‡æ–°æ˜¾ç¤ºæµ®çª—
            const identityOverlay = document.getElementById('identityOverlay');
            identityOverlay.style.display = 'flex';
            const joinBtn = document.getElementById('joinBtn');
            joinBtn.disabled = false;
            joinBtn.textContent = 'è¿›å…¥é¢è¯•é—´';
            return;
          }

          // æ¸…é™¤æ—§æ ‡è®°
          sessionStorage.removeItem(`user_left_${roomId}`);
          // æ¸…é™¤æ—§çš„userIdï¼Œå¼ºåˆ¶ç”Ÿæˆæ–°çš„
          sessionStorage.removeItem(`zego_user_${roomId}`);
          console.log('âœ… å·²æ¸…ç†æ—§ä¼šè¯æ ‡è®°ï¼Œå°†ä½¿ç”¨æ–°çš„userId');
        }

        // æ›´æ–°æœ¬åœ°è§†é¢‘æ ‡ç­¾ä¸ºä¸­æ–‡è§’è‰²åç§°
        const localLabel = document.getElementById('localLabel');
        let displayName = userName;
        // å¤„ç†ä¸¤ç§æƒ…å†µï¼š1. "customer-å¼ ä¸‰" 2. "customer"ï¼ˆæ²¡æœ‰å§“åï¼‰
        if (displayName === 'customer') {
          displayName = 'å®¢æˆ·';
        } else if (displayName === 'helper') {
          displayName = 'é˜¿å§¨';
        } else {
          displayName = displayName.replace(/^customer-/, 'å®¢æˆ·-').replace(/^helper-/, 'é˜¿å§¨-');
        }
        localLabel.textContent = displayName;

        // åˆ›å»ºZegoExpressEngineå®ä¾‹
        zg = new ZegoExpressEngine(appID, server);

        // å…³é—­è¯¦ç»†æ—¥å¿—
        zg.setLogConfig({
          logLevel: 'error', // åªæ˜¾ç¤ºé”™è¯¯æ—¥å¿—
          remoteLogLevel: 'disable' // ç¦ç”¨è¿œç¨‹æ—¥å¿—
        });

        console.log('âœ… ZEGO SDK åˆå§‹åŒ–æˆåŠŸ');

        // âš ï¸ é‡è¦ï¼šåœ¨ç™»å½•æˆ¿é—´ä¹‹å‰è®¾ç½®äº‹ä»¶ç›‘å¬
        listenRemoteStream();

        // ğŸ”¥ ä¼˜åŒ–é¡ºåºï¼šå…ˆè¯·æ±‚æƒé™ â†’ å†ç™»å½•æˆ¿é—´ â†’ æœ€åæ¨æµ
        // è¿™æ ·å¯ä»¥ç¡®ä¿åœ¨ç”¨æˆ·äº¤äº’ä¸Šä¸‹æ–‡ä¸­å®Œæˆæƒé™è¯·æ±‚ï¼Œé¿å…iOSè‡ªåŠ¨æ’­æ”¾é™åˆ¶

        // 1ï¸âƒ£ å…ˆè¯·æ±‚éº¦å…‹é£/æ‘„åƒå¤´æƒé™å¹¶åˆ›å»ºæœ¬åœ°æµï¼ˆåœ¨äº¤äº’ä¸Šä¸‹æ–‡ä¸­ï¼‰
        console.log('ğŸ“ æ­¥éª¤1: åœ¨äº¤äº’ä¸Šä¸‹æ–‡ä¸­ç«‹å³è¯·æ±‚éº¦å…‹é£/æ‘„åƒå¤´æƒé™...');

        // ğŸ¯ æ£€æŸ¥æƒé™çŠ¶æ€ï¼ˆå¦‚æœå·²æˆæƒï¼Œä¸ä¼šå¼¹å‡ºæˆæƒæç¤ºï¼‰
        const hasUserInfo = userName && userRole;
        if (hasUserInfo) {
          console.log('ğŸ”„ æ£€æµ‹åˆ°äºŒæ¬¡è¿›å…¥ï¼Œæƒé™åº”è¯¥å·²æˆæƒ');
          showLoading('æ­£åœ¨å‡†å¤‡æ‘„åƒå¤´å’Œéº¦å…‹é£...');
        } else {
          console.log('ğŸ†• é¦–æ¬¡è¿›å…¥ï¼Œè¯·æ±‚æ‘„åƒå¤´å’Œéº¦å…‹é£æƒé™...');
          showLoading('æ­£åœ¨è¯·æ±‚æ‘„åƒå¤´å’Œéº¦å…‹é£æƒé™...');
        }

        localStream = await zg.createStream({
          camera: {
            video: true,  // ç®€åŒ–é…ç½®ï¼Œä½¿ç”¨é»˜è®¤å€¼
            audio: true   // ç®€åŒ–é…ç½®ï¼Œä½¿ç”¨é»˜è®¤å€¼
          }
        });

        console.log('âœ… æƒé™æˆæƒæˆåŠŸï¼Œæœ¬åœ°æµåˆ›å»ºæˆåŠŸ', localStream);

        // ğŸ¨ å¯ç”¨åŸºç¡€ç¾é¢œï¼ˆè‡ªç„¶æ•ˆæœï¼Œä¸å¤¸å¼ ï¼‰
        if (zg.setEffectsBeauty && typeof zg.setEffectsBeauty === 'function') {
          try {
            await zg.setEffectsBeauty(localStream, true, {
              smoothIntensity: 35,   // é€‚åº¦ç£¨çš®
              whitenIntensity: 25,   // é€‚åº¦ç¾ç™½
              rosyIntensity: 20,     // é€‚åº¦çº¢æ¶¦
              sharpenIntensity: 30   // é€‚åº¦é”åŒ–
            });
            console.log('âœ… åŸºç¡€ç¾é¢œå·²å¯ç”¨ - è‡ªç„¶ä¸å¤¸å¼ çš„ç¾é¢œæ•ˆæœ');
            showLoading('æ™ºèƒ½ç¾é¢œå·²å¼€å¯ï¼Œç”»é¢æ›´æ¸…æ™°è‡ªç„¶ âœ¨');
            setTimeout(hideLoading, 2000);
          } catch (error) {
            console.warn('âš ï¸ ç¾é¢œå¯ç”¨å¤±è´¥:', error);
            // ç¾é¢œå¤±è´¥ä¸å½±å“æ­£å¸¸é€šè¯ï¼Œç»§ç»­æ‰§è¡Œ
          }
        } else {
          console.log('â„¹ï¸ å½“å‰ SDK ç‰ˆæœ¬ä¸æ”¯æŒç¾é¢œåŠŸèƒ½');
        }

        // è®¾ç½®æœ¬åœ°è§†é¢‘
        const localVideo = document.getElementById('localVideo');
        localVideo.srcObject = localStream;

        // ğŸ”¥ iOSä¿®å¤ï¼šæ˜¾å¼è°ƒç”¨play()ç¡®ä¿æœ¬åœ°è§†é¢‘æ˜¾ç¤º
        try {
          await localVideo.play();
          console.log('âœ… æœ¬åœ°è§†é¢‘æ’­æ”¾æˆåŠŸ');
        } catch (error) {
          console.warn('âš ï¸ æœ¬åœ°è§†é¢‘æ’­æ”¾å¤±è´¥:', error);
          // æœ¬åœ°è§†é¢‘é€šå¸¸æ˜¯mutedçš„ï¼Œåº”è¯¥å¯ä»¥è‡ªåŠ¨æ’­æ”¾
          // å¦‚æœå¤±è´¥ï¼Œå¯èƒ½æ˜¯å…¶ä»–é—®é¢˜
        }

        // ğŸ”¥ iOSå…³é”®ä¿®å¤ï¼šåœ¨äº¤äº’ä¸Šä¸‹æ–‡ä¸­é¢„å…ˆ"æ¿€æ´»"æ‰€æœ‰è¿œç¨‹videoå…ƒç´ 
        // è¿™æ ·å³ä½¿åé¢å¼‚æ­¥åŠ è½½æµï¼Œvideoå…ƒç´ ä¹Ÿèƒ½æ’­æ”¾
        console.log('ğŸ“ é¢„æ¿€æ´»æ‰€æœ‰è¿œç¨‹videoå…ƒç´ ...');
        const remoteBoxes = ['remoteBox1', 'remoteBox2', 'remoteBox3', 'remoteBox4', 'remoteBox5'];
        for (const boxId of remoteBoxes) {
          const box = document.getElementById(boxId);
          const video = box.querySelector('video');
          if (video) {
            // å°è¯•æ’­æ”¾ï¼ˆå³ä½¿æ²¡æœ‰æµï¼‰ï¼Œè¿™æ ·å¯ä»¥"æ¿€æ´»"videoå…ƒç´ 
            video.muted = true; // é™éŸ³ä»¥æé«˜æˆåŠŸç‡
            video.play().catch(() => {
              console.log('é¢„æ¿€æ´»videoå¤±è´¥ï¼ˆæ­£å¸¸ï¼‰:', boxId);
            });
          }
        }
        console.log('âœ… è¿œç¨‹videoå…ƒç´ é¢„æ¿€æ´»å®Œæˆ');

        // 2ï¸âƒ£ ç™»å½•æˆ¿é—´ï¼ˆä¼šè‡ªåŠ¨è·å–å·²å­˜åœ¨çš„æµï¼‰
        console.log('ğŸ“ æ­¥éª¤2: ç™»å½•æˆ¿é—´...');
        showLoading('æ­£åœ¨è¿æ¥é¢è¯•é—´...');
        await loginRoom();
        console.log('âœ… ç™»å½•æˆ¿é—´æˆåŠŸ');

        // 3ï¸âƒ£ æ¨æµï¼ˆåœ¨æƒé™å·²æˆæƒçš„æƒ…å†µä¸‹æ¨æµï¼‰
        console.log('ğŸ“ æ­¥éª¤3: å¼€å§‹æ¨æµ...');
        showLoading('æ­£åœ¨å‘å¸ƒè§†é¢‘æµ...');
        currentStreamId = 'stream_' + currentUserId;
        await zg.startPublishingStream(currentStreamId, localStream);
        console.log('âœ… æ¨æµæˆåŠŸ, StreamID:', currentStreamId);

        // å¯åŠ¨è¿œç¨‹æ§åˆ¶æ¶ˆæ¯è½®è¯¢
        startRemoteControlPolling();

        // å¯åŠ¨æˆ¿é—´çŠ¶æ€æ£€æŸ¥è½®è¯¢
        startRoomStatusPolling();

        hideLoading();
        startTimer();

        console.log('âœ… æˆåŠŸè¿›å…¥é¢è¯•é—´');

        // ğŸ”¥ æˆåŠŸè¿›å…¥æˆ¿é—´åï¼Œæ¸…é™¤ fromGuestPage æ ‡è®°
        // è¿™æ ·å¦‚æœç”¨æˆ·åˆ·æ–°é¡µé¢ï¼Œä¼šé‡æ–°èµ°ä¸€éæ­£å¸¸æµç¨‹
        sessionStorage.removeItem('fromGuestPage');
        console.log('âœ… å·²æ¸…é™¤ fromGuestPage æ ‡è®°');

        // ğŸ”¥ æˆåŠŸè¿›å…¥åï¼Œæ¸…é›¶é‡æ–°è¿›å…¥è®¡æ•°å™¨
        sessionStorage.removeItem('reentryCount');
        console.log('âœ… å·²æ¸…é›¶é‡æ–°è¿›å…¥è®¡æ•°å™¨');

        // ğŸ”¥ é‡Šæ”¾åˆå§‹åŒ–é”
        isInitializing = false;

      } catch (error) {
        console.error('âŒ åˆå§‹åŒ–å¤±è´¥:', error);
        hideLoading();
        alert('è¿æ¥å¤±è´¥: ' + (error.message || 'æœªçŸ¥é”™è¯¯'));

        // ğŸ”¥ åˆå§‹åŒ–å¤±è´¥æ—¶ä¹Ÿæ¸…é™¤æ ‡è®°ï¼Œå…è®¸ç”¨æˆ·é‡æ–°å°è¯•
        sessionStorage.removeItem('fromGuestPage');

        // ğŸ”¥ é‡Šæ”¾åˆå§‹åŒ–é”
        isInitializing = false;
      }
    }

    // ç™»å½•æˆ¿é—´
    async function loginRoom() {
      showLoading('æ­£åœ¨åŠ å…¥æˆ¿é—´...');

      // ğŸ”¥ ç”Ÿæˆç¨³å®šçš„ç”¨æˆ·ID - ä½¿ç”¨sessionStorageä¿æŒåŒä¸€ä¼šè¯çš„ID
      // è¿™æ ·å³ä½¿é¡µé¢åˆ·æ–°ï¼Œä¹Ÿä¼šä½¿ç”¨åŒä¸€ä¸ªIDï¼Œé¿å…é‡å¤è¿æ¥
      const sessionKey = `zego_user_${roomId}`;
      let storedUserId = sessionStorage.getItem(sessionKey);

      if (!storedUserId) {
        // ç¬¬ä¸€æ¬¡è¿›å…¥ï¼Œç”Ÿæˆæ–°ID
        storedUserId = 'guest_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        sessionStorage.setItem(sessionKey, storedUserId);
        console.log('ğŸ†• ç”Ÿæˆæ–°ç”¨æˆ·ID:', storedUserId);
      } else {
        console.log('â™»ï¸ ä½¿ç”¨å·²æœ‰ç”¨æˆ·ID:', storedUserId);
      }

      currentUserId = storedUserId;

      // è·å–Token
      const token = await generateToken(currentUserId, roomId);

      const result = await zg.loginRoom(roomId, token, {
        userID: currentUserId,
        userName: userName
      });

      console.log('âœ… ç™»å½•æˆ¿é—´æˆåŠŸ, result:', result);

      // ğŸ”¥ å¯åŠ¨æè¯å™¨è½®è¯¢
      startTeleprompterPolling();

      // ğŸ”¥ å…³é”®ä¿®å¤ï¼šç¬¬äºŒæ¬¡è¿›å…¥æ—¶ï¼Œä¸»åŠ¨æ‹‰å–å¹¶æ’­æ”¾å·²å­˜åœ¨çš„æµ
      // ZEGOçš„roomStreamUpdateäº‹ä»¶åœ¨æŸäº›æƒ…å†µä¸‹ä¸ä¼šè‡ªåŠ¨è§¦å‘å·²å­˜åœ¨çš„æµ
      // æ‰€ä»¥æˆ‘ä»¬éœ€è¦ä¸»åŠ¨å¤„ç†loginRoomè¿”å›çš„streamList

      const streamList = result.streamList || [];
      console.log('ğŸ“‹ æˆ¿é—´å†…å·²å­˜åœ¨çš„æµæ•°é‡:', streamList.length);

      if (streamList.length > 0) {
        console.log('ğŸ”¥ æ£€æµ‹åˆ°æˆ¿é—´å†…å·²å­˜åœ¨çš„æµï¼Œä¸»åŠ¨æ’­æ”¾...');
        // ğŸ”¥ ä¸»åŠ¨æ’­æ”¾å·²å­˜åœ¨çš„æµ
        for (const stream of streamList) {
          console.log('ğŸ¬ å‡†å¤‡æ’­æ”¾å·²å­˜åœ¨çš„æµ:', stream.streamID, stream.user);
          try {
            await playRemoteStream(stream);
          } catch (error) {
            console.error('âŒ æ’­æ”¾å·²å­˜åœ¨çš„æµå¤±è´¥:', stream.streamID, error);
          }
        }
        console.log('âœ… å·²å­˜åœ¨çš„æµæ’­æ”¾å®Œæˆ');
      } else {
        console.log('ğŸ“‹ æˆ¿é—´å†…æš‚æ— å…¶ä»–æµ');
      }
    }

    // ==================== æ£€æŸ¥éº¦å…‹é£æƒé™ ====================
    async function checkMicrophonePermission() {
      try {
        console.log('ğŸ¤ æ£€æŸ¥éº¦å…‹é£æƒé™...');
        // è¯·æ±‚éº¦å…‹é£æƒé™ï¼ˆä¼šè§¦å‘æµè§ˆå™¨æƒé™æç¤ºï¼‰
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        // ç«‹å³åœæ­¢ï¼Œåªæ˜¯ä¸ºäº†è§¦å‘æƒé™è¯·æ±‚
        stream.getTracks().forEach(track => track.stop());
        console.log('âœ… éº¦å…‹é£æƒé™å·²æˆäºˆ');
        return true;
      } catch (error) {
        console.error('âŒ éº¦å…‹é£æƒé™è¢«æ‹’ç»:', error);
        alert('è¯·å…è®¸ä½¿ç”¨éº¦å…‹é£ï¼Œå¦åˆ™æ— æ³•è¿›è¡Œè¯­éŸ³é€šè¯');
        return false;
      }
    }

    // ==================== æ£€æŸ¥éŸ³é¢‘è®¾å¤‡ ====================
    async function checkAudioDevices() {
      try {
        console.log('ğŸ” æ£€æµ‹éŸ³é¢‘è®¾å¤‡...');
        const devices = await zg.enumDevices();
        const microphones = devices.microphones;

        if (microphones.length === 0) {
          console.error('âŒ æœªæ£€æµ‹åˆ°éº¦å…‹é£è®¾å¤‡');
          alert('æœªæ£€æµ‹åˆ°éº¦å…‹é£ï¼Œè¯·æ£€æŸ¥è®¾å¤‡è¿æ¥');
          return false;
        }

        console.log('âœ… å¯ç”¨çš„éº¦å…‹é£:', microphones);
        return true;
      } catch (error) {
        console.error('âŒ æ£€æµ‹éŸ³é¢‘è®¾å¤‡å¤±è´¥:', error);
        return false;
      }
    }



    // ==================== è¿œç¨‹æ§åˆ¶åŠŸèƒ½ ====================
    // å¯åŠ¨è¿œç¨‹æ§åˆ¶æ¶ˆæ¯è½®è¯¢
    function startRemoteControlPolling() {
      // æ¯2ç§’è½®è¯¢ä¸€æ¬¡
      remoteControlPolling = setInterval(async () => {
        // å¦‚æœç”¨æˆ·å·²è¢«è¸¢å‡ºï¼Œåœæ­¢è½®è¯¢
        if (isKickedOut) {
          stopRemoteControlPolling();
          return;
        }

        try {
          const response = await fetch('/api/zego/get-remote-control', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              roomId: roomId,
              userId: currentUserId,
              lastTimestamp: lastRemoteControlTimestamp
            })
          });

          const result = await response.json();
          if (result.success && result.data && result.data.length > 0) {
            // å¤„ç†è¿œç¨‹æ§åˆ¶æ¶ˆæ¯
            for (const message of result.data) {
              handleRemoteControl(message);
              lastRemoteControlTimestamp = Math.max(lastRemoteControlTimestamp, message.timestamp);
            }
          }
        } catch (error) {
          // å¦‚æœç”¨æˆ·å·²è¢«è¸¢å‡ºï¼Œä¸æ˜¾ç¤ºé”™è¯¯æç¤º
          if (!isKickedOut) {
            console.error('âŒ è½®è¯¢è¿œç¨‹æ§åˆ¶æ¶ˆæ¯å¤±è´¥:', error);
          }
        }
      }, 2000);

      console.log('âœ… è¿œç¨‹æ§åˆ¶æ¶ˆæ¯è½®è¯¢å·²å¯åŠ¨');
    }

    // åœæ­¢è¿œç¨‹æ§åˆ¶æ¶ˆæ¯è½®è¯¢
    function stopRemoteControlPolling() {
      if (remoteControlPolling) {
        clearInterval(remoteControlPolling);
        remoteControlPolling = null;
        console.log('âœ… è¿œç¨‹æ§åˆ¶æ¶ˆæ¯è½®è¯¢å·²åœæ­¢');
      }
    }

    // âœ… å¯åŠ¨æˆ¿é—´çŠ¶æ€æ£€æŸ¥è½®è¯¢
    function startRoomStatusPolling() {
      // æ¯3ç§’æ£€æŸ¥ä¸€æ¬¡æˆ¿é—´çŠ¶æ€
      roomStatusPolling = setInterval(async () => {
        // å¦‚æœç”¨æˆ·å·²è¢«è¸¢å‡ºæˆ–æˆ¿é—´å·²è§£æ•£ï¼Œåœæ­¢è½®è¯¢
        if (isKickedOut || isRoomDismissed) {
          stopRoomStatusPolling();
          return;
        }

        try {
          const response = await fetch('/api/zego/check-room', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({ roomId: roomId })
          });

          const result = await response.json();
          console.log('ğŸ” æˆ¿é—´çŠ¶æ€æ£€æŸ¥:', result);

          if (result.success && result.data.isDismissed) {
            console.log('âš ï¸ æˆ¿é—´å·²è¢«è§£æ•£');
            isRoomDismissed = true;
            stopRoomStatusPolling();
            stopRemoteControlPolling();
            stopTimer();

            // æ˜¾ç¤º"é¢è¯•å·²ç»“æŸ"æç¤º
            showInterviewEndedModal();
          }
        } catch (error) {
          console.error('âŒ æ£€æŸ¥æˆ¿é—´çŠ¶æ€å¤±è´¥:', error);
        }
      }, 3000);

      console.log('âœ… æˆ¿é—´çŠ¶æ€æ£€æŸ¥è½®è¯¢å·²å¯åŠ¨');
    }

    // åœæ­¢æˆ¿é—´çŠ¶æ€æ£€æŸ¥è½®è¯¢
    function stopRoomStatusPolling() {
      if (roomStatusPolling) {
        clearInterval(roomStatusPolling);
        roomStatusPolling = null;
        console.log('âœ… æˆ¿é—´çŠ¶æ€æ£€æŸ¥è½®è¯¢å·²åœæ­¢');
      }
    }

    // å¤„ç†è¿œç¨‹æ§åˆ¶æ¶ˆæ¯
    function handleRemoteControl(message) {
      console.log('ğŸ“© æ”¶åˆ°è¿œç¨‹æ§åˆ¶æ¶ˆæ¯:', message);

      if (message.controlType === 'camera') {
        // è¿œç¨‹æ§åˆ¶æ‘„åƒå¤´
        if (message.enabled && !isCameraOn) {
          // å¼€å¯æ‘„åƒå¤´
          isCameraOn = true;
          zg.mutePublishStreamVideo(localStream, false);
          updateCameraButton();
          alert('ä¸»æŒäººå·²å¼€å¯æ‚¨çš„æ‘„åƒå¤´');
        } else if (!message.enabled && isCameraOn) {
          // å…³é—­æ‘„åƒå¤´
          isCameraOn = false;
          zg.mutePublishStreamVideo(localStream, true);
          updateCameraButton();
          alert('ä¸»æŒäººå·²å…³é—­æ‚¨çš„æ‘„åƒå¤´');
        }
      } else if (message.controlType === 'microphone') {
        // è¿œç¨‹æ§åˆ¶éº¦å…‹é£
        if (message.enabled && !isMicOn) {
          // å¼€å¯éº¦å…‹é£
          isMicOn = true;
          zg.muteMicrophone(false);
          updateMicButton();
          alert('ä¸»æŒäººå·²å¼€å¯æ‚¨çš„éº¦å…‹é£');
        } else if (!message.enabled && isMicOn) {
          // å…³é—­éº¦å…‹é£
          isMicOn = false;
          zg.muteMicrophone(true);
          updateMicButton();
          alert('ä¸»æŒäººå·²å…³é—­æ‚¨çš„éº¦å…‹é£');
        }
      }
    }

    // æ›´æ–°éº¦å…‹é£æŒ‰é’®çŠ¶æ€
    function updateMicButton() {
      const btn = document.getElementById('micBtn');
      const iconText = btn.querySelector('.control-icon-text');
      const label = btn.querySelector('.control-label');

      if (isMicOn) {
        btn.classList.remove('disabled');
        iconText.textContent = 'ğŸ¤';
        label.textContent = 'éº¦å…‹é£';
      } else {
        btn.classList.add('disabled');
        iconText.textContent = 'ğŸ¤';
        label.textContent = 'å·²é™éŸ³';
      }
    }

    // æ›´æ–°æ‘„åƒå¤´æŒ‰é’®çŠ¶æ€
    function updateCameraButton() {
      const btn = document.getElementById('cameraBtn');
      const iconText = btn.querySelector('.control-icon-text');
      const label = btn.querySelector('.control-label');

      if (isCameraOn) {
        btn.classList.remove('disabled');
        iconText.textContent = 'ğŸ“¹';
        label.textContent = 'æ‘„åƒå¤´';
      } else {
        btn.classList.add('disabled');
        iconText.textContent = 'ğŸ“¹';
        label.textContent = 'å·²å…³é—­';
      }
    }

    // è¿œç¨‹æµç®¡ç†
    let remoteStreams = {}; // å­˜å‚¨è¿œç¨‹æµä¿¡æ¯ { streamID: { boxId, stream } }
    const availableBoxes = ['remoteBox1', 'remoteBox2', 'remoteBox3', 'remoteBox4', 'remoteBox5'];

    // ğŸ”¥ æ’­æ”¾å•ä¸ªè¿œç¨‹æµçš„å‡½æ•° - æå–å‡ºæ¥å¤ç”¨
    async function playRemoteStream(stream) {
      console.log('ğŸ“º å‡†å¤‡æ’­æ”¾æµ:', stream.streamID, 'ç”¨æˆ·:', stream.user);

      // æ£€æŸ¥æ˜¯å¦å·²ç»åœ¨æ’­æ”¾è¿™ä¸ªæµ
      if (remoteStreams[stream.streamID]) {
        console.log('âš ï¸ æµå·²å­˜åœ¨ï¼Œè·³è¿‡:', stream.streamID);
        return;
      }

      // ğŸ”¥ å…³é”®ä¿®å¤ï¼šæ‰¾åˆ°çœŸæ­£ç©ºé—²çš„è§†é¢‘ä½ç½®
      // æ£€æŸ¥ DOM çš„ data-stream-id å±æ€§æ¥åˆ¤æ–­å®¹å™¨æ˜¯å¦è¢«å ç”¨
      let emptyBoxId = null;
      for (const boxId of availableBoxes) {
        const box = document.getElementById(boxId);
        // æ£€æŸ¥è¿™ä¸ªå®¹å™¨æ˜¯å¦å·²ç»æœ‰ data-stream-id å±æ€§
        const streamId = box.getAttribute('data-stream-id');

        if (!streamId || streamId === '') {
          // è¿™ä¸ªå®¹å™¨æ²¡æœ‰ data-stream-idï¼Œè¯´æ˜æ˜¯ç©ºçš„
          emptyBoxId = boxId;
          console.log(`âœ… æ‰¾åˆ°ç©ºä½: ${boxId}`);
          break;
        } else {
          console.log(`âš ï¸ ${boxId} å·²è¢«å ç”¨ï¼ŒstreamId: ${streamId}`);
        }
      }

      if (!emptyBoxId) {
        console.warn('âš ï¸ æ²¡æœ‰ç©ºä½äº†');
        return;
      }

      try {
        const remoteStream = await zg.startPlayingStream(stream.streamID);
        console.log('âœ… å¼€å§‹æ’­æ”¾è¿œç¨‹æµ:', stream.streamID);

        // æ˜¾ç¤ºè¿œç¨‹è§†é¢‘
        const box = document.getElementById(emptyBoxId);
        // è½¬æ¢ç”¨æˆ·åæ˜¾ç¤º
        let displayName = stream.user.userName || 'å‚ä¸è€…';

        // å¦‚æœæ˜¯ä¸»æŒäººï¼ˆHRï¼‰ï¼Œæ˜¾ç¤ºä¸º"ä¸»æŒäºº"
        if (displayName === 'HR') {
          displayName = 'ä¸»æŒäºº';
        } else if (displayName === 'customer') {
          displayName = 'å®¢æˆ·';
        } else if (displayName === 'helper') {
          displayName = 'é˜¿å§¨';
        } else {
          // è½¬æ¢è®¿å®¢è§’è‰²ï¼šcustomer-å¼ ä¸‰ -> å®¢æˆ·-å¼ ä¸‰
          displayName = displayName.replace(/^customer-/, 'å®¢æˆ·-').replace(/^helper-/, 'é˜¿å§¨-');
        }

        // âœ… è¿œç¨‹è§†é¢‘ä¸åº”è¯¥é™éŸ³ï¼åªæœ‰æœ¬åœ°é¢„è§ˆæ‰éœ€è¦é™éŸ³
        box.innerHTML = `
          <video class="video-player" autoplay playsinline webkit-playsinline x5-playsinline x5-video-player-type="h5"></video>
          <div class="video-label">${displayName}</div>
        `;

        const remoteVideo = box.querySelector('video');
        remoteVideo.srcObject = remoteStream;

        // ğŸ”¥ è®¾ç½® data-stream-id å±æ€§ï¼Œæ ‡è®°å®¹å™¨è¢«å ç”¨
        box.setAttribute('data-stream-id', stream.streamID);
        box.setAttribute('data-user-id', stream.user.userID);

        // ğŸ”¥ iOSå…¼å®¹æ€§ï¼šå°è¯•æ­£å¸¸æ’­æ”¾ï¼ˆä¸é™éŸ³ï¼‰
        try {
          await remoteVideo.play();
          console.log('âœ… è¿œç¨‹è§†é¢‘æ’­æ”¾æˆåŠŸ:', stream.streamID);
        } catch (error) {
          console.warn('âš ï¸ è¿œç¨‹è§†é¢‘æ’­æ”¾å¤±è´¥ï¼Œå°è¯•é™éŸ³æ’­æ”¾:', error);
          // iOSå¯èƒ½éœ€è¦é™éŸ³æ‰èƒ½è‡ªåŠ¨æ’­æ”¾
          remoteVideo.muted = true;
          try {
            await remoteVideo.play();
            console.log('âœ… è¿œç¨‹è§†é¢‘é™éŸ³æ’­æ”¾æˆåŠŸ:', stream.streamID);

            // ğŸ”¥ æ™ºèƒ½å–æ¶ˆé™éŸ³ç­–ç•¥ï¼š
            // 1. ç«‹å³å°è¯•å–æ¶ˆé™éŸ³ï¼ˆå¯èƒ½æˆåŠŸï¼Œå› ä¸ºé¢„æ¿€æ´»ï¼‰
            // 2. å¦‚æœå¤±è´¥ï¼Œå»¶è¿Ÿ2ç§’åå†æ¬¡å°è¯•ï¼ˆåˆ©ç”¨ç”¨æˆ·å¯èƒ½çš„äº¤äº’ï¼‰
            // 3. å¦‚æœè¿˜æ˜¯å¤±è´¥ï¼Œæ˜¾ç¤º"ç‚¹å‡»å–æ¶ˆé™éŸ³"æç¤º

            const label = box.querySelector('.video-label');
            let unmuted = false;

            // å°è¯•1: ç«‹å³å–æ¶ˆé™éŸ³
            try {
              remoteVideo.muted = false;
              await remoteVideo.play();
              console.log('âœ… ç«‹å³å–æ¶ˆé™éŸ³æˆåŠŸ:', stream.streamID);
              unmuted = true;
            } catch (e) {
              console.warn('âš ï¸ ç«‹å³å–æ¶ˆé™éŸ³å¤±è´¥ï¼Œå°†å»¶è¿Ÿé‡è¯•:', e);
              remoteVideo.muted = true; // æ¢å¤é™éŸ³
            }

            // å°è¯•2: å»¶è¿Ÿ2ç§’åå–æ¶ˆé™éŸ³
            if (!unmuted) {
              setTimeout(async () => {
                try {
                  remoteVideo.muted = false;
                  await remoteVideo.play();
                  console.log('âœ… å»¶è¿Ÿå–æ¶ˆé™éŸ³æˆåŠŸ:', stream.streamID);
                  unmuted = true;
                } catch (e) {
                  console.warn('âš ï¸ å»¶è¿Ÿå–æ¶ˆé™éŸ³å¤±è´¥ï¼Œæ˜¾ç¤ºç‚¹å‡»æç¤º:', e);
                  remoteVideo.muted = true; // æ¢å¤é™éŸ³

                  // å°è¯•3: æ˜¾ç¤º"ç‚¹å‡»å–æ¶ˆé™éŸ³"æç¤º
                  label.innerHTML = `${displayName} <span style="font-size:12px">(ç‚¹å‡»å–æ¶ˆé™éŸ³)</span>`;
                  box.style.cursor = 'pointer';
                  box.onclick = async () => {
                    remoteVideo.muted = false;
                    label.textContent = displayName;
                    box.style.cursor = 'default';
                    box.onclick = null;
                    console.log('âœ… ç”¨æˆ·ç‚¹å‡»å–æ¶ˆé™éŸ³:', stream.streamID);
                  };
                }
              }, 2000);
            }
          } catch (e) {
            console.error('âŒ è¿œç¨‹è§†é¢‘é™éŸ³æ’­æ”¾ä¹Ÿå¤±è´¥:', e);
          }
        }

        // è®°å½•æµä¿¡æ¯
        remoteStreams[stream.streamID] = {
          boxId: emptyBoxId,
          stream: remoteStream
        };
      } catch (error) {
        console.error('âŒ æ’­æ”¾è¿œç¨‹æµå¤±è´¥:', error);
      }
    }

    // ğŸ”¥ æ ‡è®°æ˜¯å¦å·²æ³¨å†Œäº‹ä»¶ç›‘å¬å™¨ï¼Œé˜²æ­¢é‡å¤æ³¨å†Œ
    let isEventListenerRegistered = false;

    // ç›‘å¬è¿œç¨‹æµ
    function listenRemoteStream() {
      // ğŸ”¥ é˜²æ­¢é‡å¤æ³¨å†Œäº‹ä»¶ç›‘å¬å™¨
      if (isEventListenerRegistered) {
        console.log('âš ï¸ äº‹ä»¶ç›‘å¬å™¨å·²æ³¨å†Œï¼Œè·³è¿‡é‡å¤æ³¨å†Œ');
        return;
      }

      console.log('ğŸ“¡ å¼€å§‹æ³¨å†ŒZEGOäº‹ä»¶ç›‘å¬å™¨...');

      zg.on('roomStreamUpdate', async (roomID, updateType, streamList) => {
        console.log('ğŸ”” è¿œç¨‹æµæ›´æ–° - RoomID:', roomID);
        console.log('ğŸ”” æ›´æ–°ç±»å‹:', updateType);
        console.log('ğŸ”” æµåˆ—è¡¨æ•°é‡:', streamList.length);
        console.log('ğŸ”” æµè¯¦æƒ…:', streamList);

        if (updateType === 'ADD') {
          // æœ‰æ–°çš„è¿œç¨‹æµåŠ å…¥
          console.log('âœ… æ£€æµ‹åˆ°æ–°æµåŠ å…¥ï¼Œå¼€å§‹æ’­æ”¾...');
          for (const stream of streamList) {
            await playRemoteStream(stream);
          }
        } else if (updateType === 'DELETE') {
          // è¿œç¨‹æµç¦»å¼€
          for (const stream of streamList) {
            console.log('ğŸ“º ç§»é™¤æµ:', stream.streamID);

            // ğŸ”¥ åœæ­¢æ’­æ”¾æµ
            try {
              zg.stopPlayingStream(stream.streamID);
              console.log('âœ… å·²åœæ­¢æ’­æ”¾æµ:', stream.streamID);
            } catch (error) {
              console.error('åœæ­¢æ’­æ”¾æµå¤±è´¥:', error);
            }

            const streamInfo = remoteStreams[stream.streamID];
            if (streamInfo) {
              const box = document.getElementById(streamInfo.boxId);
              console.log(`ğŸ§¹ æ¸…ç†è§†é¢‘å®¹å™¨ ${streamInfo.boxId}`);

              // ğŸ”¥ å½»åº•æ¸…ç†æ‰€æœ‰ video å…ƒç´ 
              const videos = box.querySelectorAll('video');
              videos.forEach(video => {
                video.pause();
                video.srcObject = null;
                video.src = '';
                video.load(); // é‡ç½®videoå…ƒç´ 
              });

              // ğŸ”¥ ç§»é™¤æ‰€æœ‰å­å…ƒç´ 
              while (box.firstChild) {
                box.removeChild(box.firstChild);
              }

              // ğŸ”¥ ç§»é™¤å±æ€§
              box.removeAttribute('data-stream-id');
              box.removeAttribute('data-user-id');

              // æ¢å¤å ä½ç¬¦
              box.innerHTML = `
                <div class="video-placeholder empty-slot">
                  <div class="placeholder-icon">ğŸ‘¤</div>
                  <div class="placeholder-text">ç­‰å¾…åŠ å…¥</div>
                </div>
              `;

              delete remoteStreams[stream.streamID];
              console.log(`âœ… è§†é¢‘å®¹å™¨ ${streamInfo.boxId} å·²å½»åº•æ¸…ç†`);


            }
          }
        }
      });

      // ğŸ”¥ ç›‘å¬ç”¨æˆ·è¢«è¸¢å‡ºäº‹ä»¶ï¼ˆå¯èƒ½çš„äº‹ä»¶ï¼‰
      zg.on('roomUserUpdate', (roomID, updateType, userList) => {
        console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
        console.log('ğŸ‘¥ æˆ¿é—´ç”¨æˆ·æ›´æ–°äº‹ä»¶è§¦å‘ï¼');
        console.log('ğŸ“ roomID:', roomID);
        console.log('ğŸ“ updateType:', updateType);
        console.log('ğŸ“ userList:', userList);
        console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
      });

      // âœ… ç›‘å¬æˆ¿é—´çŠ¶æ€å˜åŒ–ï¼ˆç”¨äºæ£€æµ‹è¢«è¸¢å‡ºã€æˆ¿é—´è§£æ•£å’Œæ–­çº¿é‡è¿ï¼‰
      zg.on('roomStateUpdate', async (roomID, state, errorCode, extendedData) => {
        // ğŸ”¥ è¯¦ç»†æ—¥å¿—ï¼šè®°å½•æ‰€æœ‰å‚æ•°
        console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
        console.log('ğŸ”” æˆ¿é—´çŠ¶æ€å˜åŒ–äº‹ä»¶è§¦å‘ï¼');
        console.log('ğŸ“ roomID:', roomID);
        console.log('ğŸ“ state:', state);
        console.log('ğŸ“ errorCode:', errorCode, '(ç±»å‹:', typeof errorCode, ')');
        console.log('ğŸ“ extendedData:', extendedData);
        console.log('ğŸ“ hasLeftRoom:', hasLeftRoom);
        console.log('ğŸ“ isKickedOut:', isKickedOut);
        console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');

        // state: 'DISCONNECTED' è¡¨ç¤ºæ–­å¼€è¿æ¥
        if (state === 'DISCONNECTED') {
          console.log('âš ï¸ æ£€æµ‹åˆ°æ–­å¼€è¿æ¥ï¼ŒerrorCode=' + errorCode);

          // ğŸ”¥ å…³é”®ä¿®å¤ï¼šå¦‚æœç”¨æˆ·å·²ç»ä¸»åŠ¨ç¦»å¼€æˆ¿é—´ï¼Œä¸å¤„ç†æ–­å¼€äº‹ä»¶
          if (hasLeftRoom) {
            console.log('âœ… ç”¨æˆ·å·²ä¸»åŠ¨ç¦»å¼€ï¼Œå¿½ç•¥æ–­å¼€äº‹ä»¶');
            return;
          }

          // ğŸ”¥ å…³é”®å‘ç°ï¼šZEGOçš„KickoutUser APIè¸¢å‡ºç”¨æˆ·æ—¶ï¼ŒerrorCodeæ˜¯1002055
          // errorCode å¯èƒ½çš„å€¼ï¼š
          // - 0: æ­£å¸¸æ–­å¼€ï¼ˆä¸»åŠ¨é€€å‡ºï¼‰
          // - 1002055: è¢«æœåŠ¡ç«¯å¼ºåˆ¶è¸¢å‡ºï¼ˆKickoutUser APIï¼‰
          // - å…¶ä»–å€¼: ç½‘ç»œé—®é¢˜ç­‰

          // âœ… æ£€æŸ¥ errorCode æ˜¯å¦ä¸ºè¢«è¸¢å‡ºçš„é”™è¯¯ç 
          if (errorCode === 1002055) {
            console.log('âœ… ç¡®è®¤ï¼šè¢«æœåŠ¡ç«¯å¼ºåˆ¶è¸¢å‡º (errorCode=1002055)');

            // æ£€æŸ¥ extendedData ä¸­çš„è¸¢å‡ºåŸå› 
            if (extendedData && extendedData.custom_kickout_message) {
              console.log('ğŸ“ è¸¢å‡ºåŸå› :', extendedData.custom_kickout_message);
            }

            // æ ‡è®°ä¸ºå·²è¢«è¸¢å‡º
            isKickedOut = true;

            // åœæ­¢è®¡æ—¶å™¨å’Œè½®è¯¢
            stopTimer();
            stopRemoteControlPolling();
            stopRoomStatusPolling();

            // æ¸…ç†æœ¬åœ°æµ
            if (localStream) {
              try {
                zg.destroyStream(localStream);
              } catch (error) {
                console.error('æ¸…ç†æœ¬åœ°æµå¤±è´¥:', error);
              }
            }

            // âœ… æ£€æŸ¥æˆ¿é—´çŠ¶æ€ï¼ŒåŒºåˆ†æ˜¯"è¢«è¸¢å‡º"è¿˜æ˜¯"æˆ¿é—´è§£æ•£"
            try {
              console.log('ğŸ” è°ƒç”¨åç«¯APIæ£€æŸ¥æˆ¿é—´çŠ¶æ€...');
              const response = await fetch('/api/zego/check-room', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                },
                body: JSON.stringify({ roomId: roomId })
              });

              const result = await response.json();
              console.log('ğŸ” æˆ¿é—´çŠ¶æ€æ£€æŸ¥ç»“æœ:', result);
              console.log('ğŸ” è¯¦ç»†æ•°æ®:', {
                isDismissed: result.data?.isDismissed,
                isActive: result.data?.isActive,
                exists: result.data?.exists,
                canJoin: result.data?.canJoin
              });

              if (result.success) {
                if (result.data.isDismissed) {
                  // æˆ¿é—´å·²è§£æ•£
                  console.log('âœ… æˆ¿é—´å·²è§£æ•£ï¼Œæ˜¾ç¤º"é¢è¯•å·²ç»“æŸ"å¼¹çª—');
                  showInterviewEndedModal();
                } else if (result.data.isActive) {
                  // æˆ¿é—´è¿˜åœ¨ï¼Œä½†ç”¨æˆ·è¢«è¸¢å‡ºäº†
                  console.log('âœ… æˆ¿é—´ä»ç„¶æ´»è·ƒï¼Œç”¨æˆ·è¢«è¸¢å‡ºï¼Œæ˜¾ç¤º"è¢«è¸¢å‡º"å¼¹çª—');
                  showKickedOutModal();
                } else {
                  // æˆ¿é—´çŠ¶æ€æœªçŸ¥ï¼Œé»˜è®¤æ˜¾ç¤ºè¢«è¸¢å‡ºå¼¹çª—
                  console.log('âš ï¸ æˆ¿é—´çŠ¶æ€æœªçŸ¥ï¼Œé»˜è®¤æ˜¾ç¤º"è¢«è¸¢å‡º"å¼¹çª—');
                  showKickedOutModal();
                }
              } else {
                // APIè°ƒç”¨å¤±è´¥ï¼Œé»˜è®¤æ˜¾ç¤ºè¢«è¸¢å‡ºå¼¹çª—
                console.error('âŒ æ£€æŸ¥æˆ¿é—´çŠ¶æ€å¤±è´¥:', result.message);
                showKickedOutModal();
              }
            } catch (error) {
              // ç½‘ç»œé”™è¯¯ï¼Œé»˜è®¤æ˜¾ç¤ºè¢«è¸¢å‡ºå¼¹çª—
              console.error('âŒ æ£€æŸ¥æˆ¿é—´çŠ¶æ€å¤±è´¥ï¼ˆç½‘ç»œé”™è¯¯ï¼‰:', error);
              showKickedOutModal();
            }
          } else {
            // å…¶ä»– errorCodeï¼Œå¯èƒ½æ˜¯ç½‘ç»œé—®é¢˜æˆ–æ­£å¸¸æ–­å¼€
            console.log('ğŸ”„ ç½‘ç»œæ–­å¼€æˆ–å…¶ä»–åŸå› ï¼ŒerrorCode=' + errorCode + 'ï¼Œæ˜¾ç¤ºé‡è¿æç¤º');
            showReconnectToast();
          }
        } else if (state === 'CONNECTING') {
          console.log('ğŸ”„ æ­£åœ¨é‡æ–°è¿æ¥...');
          if (!isKickedOut) {
            showReconnectToast();
          }
        } else if (state === 'CONNECTED') {
          console.log('âœ… é‡æ–°è¿æ¥æˆåŠŸ');
          if (!isKickedOut) {
            hideReconnectToast();
          }
        }
      });

      // ğŸ”¥ æ ‡è®°äº‹ä»¶ç›‘å¬å™¨å·²æ³¨å†Œ
      isEventListenerRegistered = true;
      console.log('âœ… ZEGOäº‹ä»¶ç›‘å¬å™¨æ³¨å†Œå®Œæˆ');
    }

    // âœ… æ˜¾ç¤ºé‡è¿æç¤º
    function showReconnectToast() {
      const toast = document.getElementById('reconnectToast');
      toast.classList.add('show');
    }

    // âœ… éšè—é‡è¿æç¤º
    function hideReconnectToast() {
      const toast = document.getElementById('reconnectToast');
      toast.classList.remove('show');
    }

    // âœ… æ˜¾ç¤º"é¢è¯•å·²ç»“æŸ"å¼¹çª—
    function showInterviewEndedModal() {
      console.log('ğŸ“¢ æ˜¾ç¤ºé¢è¯•å·²ç»“æŸå¼¹çª—');

      // åˆ›å»ºé®ç½©å±‚
      const overlay = document.createElement('div');
      overlay.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.7);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
      `;

      // åˆ›å»ºå¼¹çª—
      const modal = document.createElement('div');
      modal.style.cssText = `
        background: white;
        border-radius: 12px;
        padding: 30px;
        max-width: 400px;
        width: 90%;
        text-align: center;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
      `;

      modal.innerHTML = `
        <div style="font-size: 48px; margin-bottom: 20px;">âœ…</div>
        <h2 style="margin: 0 0 15px 0; font-size: 24px; color: #333;">é¢è¯•å·²ç»“æŸ</h2>
        <p style="margin: 0 0 25px 0; font-size: 16px; color: #666;">æˆ¿é—´å·²è¢«ä¸»æŒäººè§£æ•£ï¼Œæ„Ÿè°¢æ‚¨çš„å‚ä¸</p>
        <button onclick="window.close(); setTimeout(() => window.location.href='video-interview-guest.html', 100);"
                style="background: linear-gradient(135deg, #5fb3a3 0%, #4a9d8e 100%); color: white; border: none; padding: 12px 40px;
                       border-radius: 8px; font-size: 16px; cursor: pointer; width: 100%;">
          ç¡®å®š
        </button>
      `;

      overlay.appendChild(modal);
      document.body.appendChild(overlay);
    }

    // âœ… æ˜¾ç¤º"æ‚¨å·²è¢«è¯·å‡ºæˆ¿é—´"å¼¹çª—
    function showKickedOutModal() {
      console.log('ğŸ“¢ æ˜¾ç¤ºè¢«è¸¢å‡ºå¼¹çª—');

      // åˆ›å»ºé®ç½©å±‚
      const overlay = document.createElement('div');
      overlay.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.7);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
      `;

      // åˆ›å»ºå¼¹çª—
      const modal = document.createElement('div');
      modal.style.cssText = `
        background: white;
        border-radius: 12px;
        padding: 30px;
        max-width: 400px;
        width: 90%;
        text-align: center;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
      `;

      modal.innerHTML = `
        <div style="font-size: 48px; margin-bottom: 20px;">âš ï¸</div>
        <h2 style="margin: 0 0 15px 0; font-size: 24px; color: #333;">æ‚¨å·²è¢«è¯·å‡ºæˆ¿é—´</h2>
        <p style="margin: 0 0 25px 0; font-size: 16px; color: #666;">è¯·è”ç³»ä¸»æŒäººé‡æ–°åŠ å…¥</p>
        <button onclick="window.close(); setTimeout(() => window.location.href='video-interview-guest.html?kicked=true', 100);"
                style="background: linear-gradient(135deg, #5fb3a3 0%, #4a9d8e 100%); color: white; border: none; padding: 12px 40px;
                       border-radius: 8px; font-size: 16px; cursor: pointer; width: 100%;">
          ç¡®å®š
        </button>
      `;

      overlay.appendChild(modal);
      document.body.appendChild(overlay);
    }

    // âœ… æ˜¾ç¤ºé¡µé¢åå°æç¤º
    function showBackgroundToast() {
      const toast = document.getElementById('backgroundToast');
      toast.classList.add('show');
    }

    // âœ… éšè—é¡µé¢åå°æç¤º
    function hideBackgroundToast() {
      const toast = document.getElementById('backgroundToast');
      toast.classList.remove('show');
    }

    // âœ… ç›‘å¬é¡µé¢å¯è§æ€§å˜åŒ–ï¼ˆç”µè¯/è¯­éŸ³æ‰“æ–­ï¼‰
    document.addEventListener('visibilitychange', () => {
      if (document.hidden) {
        console.log('ğŸ“± é¡µé¢è¿›å…¥åå°ï¼ˆå¯èƒ½æ¥ç”µè¯/åˆ‡æ¢åº”ç”¨ï¼‰');
        showBackgroundToast();
      } else {
        console.log('ğŸ“± é¡µé¢è¿”å›å‰å°');
        hideBackgroundToast();
        // æ£€æŸ¥è¿æ¥çŠ¶æ€
        console.log('ğŸ” æ£€æŸ¥è¿æ¥çŠ¶æ€...');
      }
    });

    // åˆ‡æ¢éº¦å…‹é£
    function toggleMic() {
      if (!localStream) return;

      isMicOn = !isMicOn;
      zg.muteMicrophone(!isMicOn);

      const btn = document.getElementById('micBtn');
      const iconText = btn.querySelector('.control-icon-text');
      const label = btn.querySelector('.control-label');

      if (isMicOn) {
        btn.classList.remove('disabled');
        iconText.textContent = 'ğŸ¤';
        label.textContent = 'éº¦å…‹é£';
      } else {
        btn.classList.add('disabled');
        iconText.textContent = 'ğŸ¤';
        label.textContent = 'å·²é™éŸ³';
      }
    }

    // åˆ‡æ¢æ‘„åƒå¤´
    function toggleCamera() {
      if (!localStream) return;

      isCameraOn = !isCameraOn;
      zg.mutePublishStreamVideo(localStream, !isCameraOn);

      const btn = document.getElementById('cameraBtn');
      const iconText = btn.querySelector('.control-icon-text');
      const label = btn.querySelector('.control-label');

      if (isCameraOn) {
        btn.classList.remove('disabled');
        iconText.textContent = 'ğŸ“¹';
        label.textContent = 'æ‘„åƒå¤´';
      } else {
        btn.classList.add('disabled');
        iconText.textContent = 'ğŸ“¹';
        label.textContent = 'å·²å…³é—­';
      }
    }

    // ç¿»è½¬é•œå¤´ï¼ˆå‰ç½®/åç½®åˆ‡æ¢ï¼‰
    // âœ… ä½¿ç”¨å³æ„å®˜æ–¹æ¨èçš„æ–¹å¼ï¼šuseFrontCamera
    // å®˜æ–¹æ–‡æ¡£ï¼šhttps://doc-zh.zego.im/real-time-video-web/best-practice/mobile-front-and-rear-camera-switching
    async function flipCamera() {
      if (!localStream || !isCameraOn) {
        alert('è¯·å…ˆæ‰“å¼€æ‘„åƒå¤´');
        return;
      }

      try {
        showLoading('æ­£åœ¨åˆ‡æ¢æ‘„åƒå¤´...');
        console.log('ğŸ”„ å¼€å§‹åˆ‡æ¢æ‘„åƒå¤´ï¼Œå½“å‰:', isFrontCamera ? 'å‰ç½®' : 'åç½®');

        // åˆ‡æ¢æ‘„åƒå¤´æ–¹å‘
        isFrontCamera = !isFrontCamera;
        console.log('ğŸ”„ åˆ‡æ¢åˆ°:', isFrontCamera ? 'å‰ç½®' : 'åç½®');

        // âœ… ä½¿ç”¨å®˜æ–¹æ¨èçš„ useFrontCamera æ–¹æ³•
        // true = å‰ç½®æ‘„åƒå¤´ï¼Œfalse = åç½®æ‘„åƒå¤´
        await zg.useFrontCamera(localStream, isFrontCamera);

        console.log('âœ… æ‘„åƒå¤´åˆ‡æ¢æˆåŠŸ:', isFrontCamera ? 'å‰ç½®' : 'åç½®');
        hideLoading();
        alert('æ‘„åƒå¤´å·²åˆ‡æ¢åˆ°' + (isFrontCamera ? 'å‰ç½®' : 'åç½®'));

      } catch (error) {
        console.error('âŒ åˆ‡æ¢æ‘„åƒå¤´å¤±è´¥:', error);
        hideLoading();

        // åˆ‡æ¢å›åŸæ¥çš„æ–¹å‘
        isFrontCamera = !isFrontCamera;
        alert('åˆ‡æ¢æ‘„åƒå¤´å¤±è´¥: ' + error.message);
      }
    }

    // æ˜¾ç¤ºé‚€è¯·å¼¹çª—
    function showInviteModal() {
      console.log('ğŸ“¨ æ˜¾ç¤ºé‚€è¯·å¼¹çª—');
      console.log('ğŸ  å½“å‰roomId:', roomId);

      // ğŸ”¥ æ£€æŸ¥roomIdæ˜¯å¦å­˜åœ¨
      if (!roomId || roomId === '') {
        alert('æˆ¿é—´å·ä¸å­˜åœ¨ï¼Œæ— æ³•ç”Ÿæˆé‚€è¯·é“¾æ¥ï¼');
        console.error('âŒ roomIdä¸ºç©ºï¼Œæ— æ³•ç”Ÿæˆé‚€è¯·é“¾æ¥');
        return;
      }

      // ğŸ¯ å°ç¨‹åºç¯å¢ƒä¸‹ï¼Œå‘é€ triggerShare æ¶ˆæ¯ç»™å°ç¨‹åº
      if (IS_IN_MINIPROGRAM) {
        try {
          console.log('ğŸ’¡ å°ç¨‹åºç¯å¢ƒï¼Œå‘é€ triggerShare æ¶ˆæ¯ç»™å°ç¨‹åº');

          // ç”Ÿæˆè®¿å®¢H5é“¾æ¥
          const baseUrl = window.location.origin + window.location.pathname.replace('video-interview-guest-room.html', '');
          const inviteLink = `${baseUrl}video-interview-guest.html?roomId=${roomId}`;

          console.log('ğŸ“¤ å‡†å¤‡å‘é€ triggerShare æ¶ˆæ¯');
          console.log('ğŸ“¤ roomId:', roomId);
          console.log('ğŸ“¤ inviteLink:', inviteLink);

          // å‘é€æ¶ˆæ¯ç»™å°ç¨‹åº
          if (typeof wx !== 'undefined' && wx.miniProgram) {
            wx.miniProgram.postMessage({
              data: {
                type: 'triggerShare',
                roomId: roomId,
                inviteLink: inviteLink,
                shareTitle: 'é‚€è¯·ä½ å‚åŠ è§†é¢‘é¢è¯•',
                shareDesc: `é¢è¯•é—´å·ï¼š${roomId.replace(/^room_/, 'AD-').split('_')[0]}`
              }
            });
            console.log('âœ… å·²å‘é€ triggerShare æ¶ˆæ¯ç»™å°ç¨‹åº');

            // æç¤ºç”¨æˆ·ç‚¹å‡»å³ä¸Šè§’åˆ†äº«
            alert('è¯·ç‚¹å‡»å³ä¸Šè§’"..."æŒ‰é’®ï¼Œé€‰æ‹©"è½¬å‘"åˆ†äº«ç»™å®¢æˆ·/é˜¿å§¨');
          } else {
            console.warn('âš ï¸ æœªæ‰¾åˆ° wx.miniProgramï¼Œæ— æ³•å‘é€æ¶ˆæ¯');
          }
        } catch (error) {
          console.error('âŒ å‘é€ triggerShare æ¶ˆæ¯å¤±è´¥:', error);
          // ä¸å½±å“ä¸»æµç¨‹
        }
        return;
      }

      // éå°ç¨‹åºç¯å¢ƒï¼Œæ˜¾ç¤ºé‚€è¯·å¼¹çª—
      const modal = document.getElementById('inviteModal');
      const inviteLinkInput = document.getElementById('inviteLink');

      // ç”Ÿæˆé‚€è¯·é“¾æ¥ï¼ˆè®¿å®¢ç«¯ï¼‰
      const baseUrl = window.location.origin + window.location.pathname.replace('video-interview-guest-room.html', 'video-interview-guest.html');
      const link = `${baseUrl}?roomId=${roomId}`;

      console.log('ğŸ”— ç”Ÿæˆçš„é‚€è¯·é“¾æ¥:', link);

      inviteLinkInput.value = link;
      modal.classList.add('show');
    }

    // å…³é—­é‚€è¯·å¼¹çª—
    function closeInviteModal() {
      const modal = document.getElementById('inviteModal');
      modal.classList.remove('show');
    }

    // å¤åˆ¶é‚€è¯·é“¾æ¥
    async function copyInviteLink() {
      const inviteLink = document.getElementById('inviteLink');

      try {
        await navigator.clipboard.writeText(inviteLink.value);

        const btn = event.target;
        const originalText = btn.textContent;
        btn.textContent = 'âœ… é“¾æ¥å·²å¤åˆ¶ï¼';
        btn.style.background = 'linear-gradient(135deg, #4caf50 0%, #45a049 100%)';

        setTimeout(() => {
          btn.textContent = originalText;
          btn.style.background = 'linear-gradient(135deg, #5fb3a3 0%, #4a9d8e 100%)';
          closeInviteModal();
        }, 1500);

      } catch (err) {
        alert('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶é“¾æ¥');
      }
    }

    // ç‚¹å‡»å¼¹çª—å¤–éƒ¨å…³é—­
    document.addEventListener('click', function(e) {
      const modal = document.getElementById('inviteModal');
      if (e.target === modal) {
        closeInviteModal();
      }
    });

    // ç¦»å¼€æˆ¿é—´
    function leaveRoom() {
      // æ˜¾ç¤ºè‡ªå®šä¹‰ç¡®è®¤å¼¹çª—
      showLeaveConfirmModal();
    }

    // âœ… æ˜¾ç¤º"ç¡®è®¤ç¦»å¼€"å¼¹çª—
    function showLeaveConfirmModal() {
      console.log('ğŸ“¢ æ˜¾ç¤ºç¡®è®¤ç¦»å¼€å¼¹çª—');

      // åˆ›å»ºé®ç½©å±‚
      const overlay = document.createElement('div');
      overlay.id = 'leaveConfirmOverlay';
      overlay.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.7);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
      `;

      // åˆ›å»ºå¼¹çª—
      const modal = document.createElement('div');
      modal.style.cssText = `
        background: white;
        border-radius: 12px;
        padding: 30px;
        max-width: 400px;
        width: 90%;
        text-align: center;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
      `;

      modal.innerHTML = `
        <div style="font-size: 48px; margin-bottom: 20px;">â“</div>
        <h2 style="margin: 0 0 15px 0; font-size: 24px; color: #333;">ç¡®å®šè¦ç¦»å¼€é¢è¯•å—ï¼Ÿ</h2>
        <div style="display: flex; gap: 12px; margin-top: 25px;">
          <button id="cancelLeaveBtn" style="flex: 1; background: #f5f5f5; color: #666; border: none; padding: 12px 24px;
                         border-radius: 8px; font-size: 16px; cursor: pointer;">
            å–æ¶ˆ
          </button>
          <button id="confirmLeaveBtn" style="flex: 1; background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%); color: white; border: none; padding: 12px 24px;
                         border-radius: 8px; font-size: 16px; cursor: pointer;">
            ç¦»å¼€é¢è¯•
          </button>
        </div>
      `;

      overlay.appendChild(modal);
      document.body.appendChild(overlay);

      // ç»‘å®šæŒ‰é’®äº‹ä»¶
      document.getElementById('cancelLeaveBtn').onclick = function() {
        console.log('âŒ ç”¨æˆ·å–æ¶ˆç¦»å¼€');
        document.body.removeChild(overlay);
      };

      document.getElementById('confirmLeaveBtn').onclick = function() {
        console.log('âœ… ç”¨æˆ·ç¡®è®¤ç¦»å¼€');
        document.body.removeChild(overlay);
        executeLeaveRoom();
      };
    }

    // æ‰§è¡Œç¦»å¼€æˆ¿é—´çš„å®é™…æ“ä½œ
    function executeLeaveRoom() {
      try {
        console.log('ğŸšª å¼€å§‹ç¦»å¼€æˆ¿é—´...');

        // ğŸ”¥ æ ‡è®°ä¸ºä¸»åŠ¨ç¦»å¼€ï¼Œé˜²æ­¢è§¦å‘è¢«è¸¢å‡ºå¼¹çª—
        hasLeftRoom = true;

        // åœæ­¢è®¡æ—¶å™¨å’Œè½®è¯¢
        stopTimer();
        stopRemoteControlPolling();

        // æ¸…ç†æœ¬åœ°æµ
        if (zg && localStream) {
          console.log('ğŸ§¹ æ¸…ç†æœ¬åœ°æµ...');

          // åœæ­¢æ¨æµ
          try {
            zg.stopPublishingStream(localStream.streamID);
            console.log('âœ… å·²åœæ­¢æ¨æµ');
          } catch (error) {
            console.error('åœæ­¢æ¨æµå¤±è´¥:', error);
          }

          // é”€æ¯æœ¬åœ°æµ
          try {
            zg.destroyStream(localStream);
            console.log('âœ… å·²é”€æ¯æœ¬åœ°æµ');
          } catch (error) {
            console.error('é”€æ¯æœ¬åœ°æµå¤±è´¥:', error);
          }

          // é€€å‡ºæˆ¿é—´
          try {
            zg.logoutRoom(roomId);
            console.log('âœ… å·²é€€å‡ºæˆ¿é—´');
          } catch (error) {
            console.error('é€€å‡ºæˆ¿é—´å¤±è´¥:', error);
          }
        }

        console.log('âœ… å·²ç¦»å¼€æˆ¿é—´');

        // ğŸ¯ ä¸åˆ é™¤ localStorage ä¸­çš„ç”¨æˆ·ä¿¡æ¯ï¼Œè¿™æ ·é‡æ–°è¿›å…¥åå¯ä»¥ç›´æ¥åŠ å…¥
        console.log('âœ… ä¿ç•™ç”¨æˆ·ä¿¡æ¯ï¼Œé‡æ–°è¿›å…¥å¯ç›´æ¥åŠ å…¥');

        // ğŸ¯ æ˜¾ç¤ºç¦»å¼€æˆåŠŸå¼¹çª—
        showLeaveSuccessModal();
      } catch (error) {
        console.error('âŒ ç¦»å¼€æˆ¿é—´å¤±è´¥:', error.message);
        alert('ç¦»å¼€æˆ¿é—´å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
      }
    }

    // âœ… æ˜¾ç¤ºç¦»å¼€æˆåŠŸå¼¹çª—
    function showLeaveSuccessModal() {
      console.log('ğŸ“¢ æ˜¾ç¤ºç¦»å¼€æˆåŠŸå¼¹çª—');

      // åˆ›å»ºé®ç½©å±‚
      const overlay = document.createElement('div');
      overlay.id = 'leaveSuccessOverlay';
      overlay.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.7);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
      `;

      // åˆ›å»ºå¼¹çª—
      const modal = document.createElement('div');
      modal.style.cssText = `
        background: white;
        border-radius: 12px;
        padding: 30px;
        max-width: 400px;
        width: 90%;
        text-align: center;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
      `;

      modal.innerHTML = `
        <div style="font-size: 48px; margin-bottom: 20px;">ğŸ‘‹</div>
        <h2 style="margin: 0 0 15px 0; font-size: 24px; color: #333;">å·²ç¦»å¼€é¢è¯•é—´</h2>
        <p style="margin: 0 0 25px 0; font-size: 16px; color: #666;">å¦‚éœ€é‡æ–°è¿›å…¥ï¼Œè¯·é‡æ–°ç‚¹å‡»é‚€è¯·é“¾æ¥</p>
        <button id="closeLeavePageBtn" style="background: linear-gradient(135deg, #5fb3a3 0%, #4a9d8e 100%); color: white; border: none; padding: 12px 40px;
                       border-radius: 8px; font-size: 16px; cursor: pointer; width: 100%;">
          ç¡®å®š
        </button>
      `;

      overlay.appendChild(modal);
      document.body.appendChild(overlay);

      // ç»‘å®šæŒ‰é’®äº‹ä»¶
      document.getElementById('closeLeavePageBtn').onclick = function() {
        // å°è¯•å…³é—­å½“å‰çª—å£
        window.close();

        // å¦‚æœæ— æ³•å…³é—­ï¼ˆä¸æ˜¯é€šè¿‡è„šæœ¬æ‰“å¼€çš„çª—å£ï¼‰ï¼Œåˆ™è·³è½¬åˆ°è®¿å®¢å…¥å£é¡µ
        setTimeout(() => {
          window.location.href = 'video-interview-guest.html';
        }, 100);
      };
    }

    // è®¡æ—¶å™¨
    function startTimer() {
      startTime = Date.now();
      timerInterval = setInterval(() => {
        const elapsed = Math.floor((Date.now() - startTime) / 1000);
        const minutes = Math.floor(elapsed / 60).toString().padStart(2, '0');
        const seconds = (elapsed % 60).toString().padStart(2, '0');
        document.getElementById('timer').textContent = `${minutes}:${seconds}`;
      }, 1000);
    }

    function stopTimer() {
      if (timerInterval) {
        clearInterval(timerInterval);
        timerInterval = null;
      }
    }

    // åŠ è½½æç¤º
    function showLoading(text) {
      const loading = document.getElementById('loading');
      loading.textContent = text;
      loading.style.display = 'block';
    }

    function hideLoading() {
      document.getElementById('loading').style.display = 'none';
    }

    // ï¿½ æ›´æ–°è°ƒè¯•é¢æ¿


    // ï¿½ğŸ”¥ é˜¶æ®µ1ï¼šDOM åŠ è½½å®Œæˆåç«‹å³æ˜¾ç¤ºæµ®çª—
    document.addEventListener('DOMContentLoaded', () => {
      console.log('ğŸ“± DOM åŠ è½½å®Œæˆï¼Œç«‹å³æ˜¾ç¤ºæµ®çª—');
      console.log('ğŸ” [è°ƒè¯•] é¡µé¢ç‰ˆæœ¬: v2024.01.20.002');





      // ğŸ¯ æ ¹æ®ç¯å¢ƒæ·»åŠ  body classï¼ˆç”¨äºæ§åˆ¶é‚€è¯·æŒ‰é’®æ˜¾ç¤ºï¼‰
      console.log('ğŸ” [è°ƒè¯•] IS_IN_MINIPROGRAM =', IS_IN_MINIPROGRAM);
      console.log('ğŸ” [è°ƒè¯•] å½“å‰ body.className =', document.body.className);

      if (IS_IN_MINIPROGRAM) {
        document.body.classList.add('miniprogram-env');
        console.log('âœ… å·²æ·»åŠ å°ç¨‹åºç¯å¢ƒæ ‡è¯†ï¼Œé‚€è¯·æŒ‰é’®å°†è¢«éšè—');
        console.log('ğŸ” [è°ƒè¯•] æ·»åŠ å body.className =', document.body.className);

        // éªŒè¯é‚€è¯·æŒ‰é’®æ˜¯å¦çœŸçš„éšè—äº†
        setTimeout(() => {
          const invitePlaceholders = document.querySelectorAll('.invite-placeholder');
          console.log('ğŸ” [è°ƒè¯•] æ‰¾åˆ°', invitePlaceholders.length, 'ä¸ªé‚€è¯·æŒ‰é’®');
          invitePlaceholders.forEach((el, index) => {
            const style = window.getComputedStyle(el);
            console.log(`ğŸ” [è°ƒè¯•] é‚€è¯·æŒ‰é’® ${index + 1} display =`, style.display);
            if (style.display !== 'none') {
              console.error(`âŒ [é”™è¯¯] é‚€è¯·æŒ‰é’® ${index + 1} æ²¡æœ‰éšè—ï¼`);
            }
          });


        }, 100);
      } else {
        console.log('âœ… æµè§ˆå™¨ç¯å¢ƒï¼Œé‚€è¯·æŒ‰é’®æ­£å¸¸æ˜¾ç¤º');


      }

      // ğŸ”¥ å…³é”®ä¿®å¤ï¼šé¡µé¢åŠ è½½æ—¶å¼ºåˆ¶æ¸…ç†æ®‹ç•™çŠ¶æ€
      // è¿™æ ·å¯ä»¥ç¡®ä¿é‡æ–°è¿›å…¥æ—¶çŠ¶æ€æ˜¯å¹²å‡€çš„
      console.log('ğŸ§¹ é¡µé¢åŠ è½½æ—¶æ¸…ç†æ®‹ç•™çŠ¶æ€...');

      // æ¸…ç†å¯èƒ½æ®‹ç•™çš„SDKå®ä¾‹
      if (window.zg) {
        try {
          console.log('âš ï¸ æ£€æµ‹åˆ°æ®‹ç•™çš„SDKå®ä¾‹ï¼Œæ­£åœ¨æ¸…ç†...');
          if (window.zg.logoutRoom) {
            window.zg.logoutRoom(roomId).catch(() => {});
          }
          window.zg = null;
        } catch (e) {
          console.warn('æ¸…ç†æ®‹ç•™SDKå®ä¾‹å¤±è´¥:', e);
        }
      }

      // ğŸ”¥ æ¸…ç†æ‰€æœ‰è¿œç¨‹è§†é¢‘å®¹å™¨çš„DOMå…ƒç´ 
      console.log('ğŸ§¹ æ¸…ç†é¡µé¢åŠ è½½æ—¶çš„æ®‹ç•™DOMå…ƒç´ ...');
      const remoteBoxIds = ['remoteBox1', 'remoteBox2', 'remoteBox3', 'remoteBox4', 'remoteBox5'];
      remoteBoxIds.forEach(boxId => {
        const box = document.getElementById(boxId);
        if (box) {
          // åœæ­¢æ‰€æœ‰videoå…ƒç´ 
          const videos = box.querySelectorAll('video');
          videos.forEach(video => {
            video.pause();
            video.srcObject = null;
            video.src = '';
          });
          // é‡ç½®å®¹å™¨å†…å®¹ä¸ºæ™®é€šå ä½ç¬¦
          box.innerHTML = `
            <div class="video-placeholder empty-slot">
              <div class="placeholder-icon">ğŸ‘¤</div>
              <div class="placeholder-text">ç­‰å¾…åŠ å…¥</div>
            </div>
          `;
        }
      });

      // ğŸ”¥ æ¸…ç†æœ¬åœ°è§†é¢‘
      const localVideo = document.getElementById('localVideo');
      if (localVideo) {
        localVideo.pause();
        localVideo.srcObject = null;
        localVideo.src = '';
      }
      console.log('âœ… æ®‹ç•™DOMå…ƒç´ å·²æ¸…ç†');



      // é‡ç½®å…¨å±€å˜é‡
      zg = null;
      localStream = null;
      currentStreamId = null;
      remoteStreams = {};
      isEventListenerRegistered = false; // ğŸ”¥ é‡ç½®äº‹ä»¶ç›‘å¬å™¨æ ‡å¿—
      isInitializing = false; // ğŸ”¥ é‡ç½®åˆå§‹åŒ–é”

      // æ£€æµ‹æ˜¯å¦æ˜¯é‡æ–°è¿›å…¥
      const reentryCount = parseInt(sessionStorage.getItem('reentryCount') || '0');
      if (reentryCount > 0) {
        console.log(`âš ï¸ æ£€æµ‹åˆ°é‡æ–°è¿›å…¥ (ç¬¬${reentryCount + 1}æ¬¡è¿›å…¥)`);

        // å¦‚æœé‡æ–°è¿›å…¥æ¬¡æ•°è¿‡å¤šï¼Œæ¸…é™¤æ ‡è®°å¹¶åˆ·æ–°é¡µé¢ä½œä¸ºå…œåº•
        if (reentryCount >= 3) {
          console.log('âš ï¸ é‡æ–°è¿›å…¥æ¬¡æ•°è¿‡å¤šï¼Œæ¸…é™¤æ ‡è®°å¹¶åˆ·æ–°é¡µé¢');
          sessionStorage.removeItem('reentryCount');
          sessionStorage.setItem('forceRefresh', 'true');
          window.location.reload();
          return;
        }
      }
      sessionStorage.setItem('reentryCount', (reentryCount + 1).toString());

      console.log('âœ… çŠ¶æ€æ¸…ç†å®Œæˆï¼Œå‡†å¤‡æ˜¾ç¤ºèº«ä»½é€‰æ‹©æµ®çª—');

      // ğŸ¯ æ£€æŸ¥æ˜¯å¦æœ‰ä¿å­˜çš„ç”¨æˆ·ä¿¡æ¯ï¼ˆé‡æ–°è¿›å…¥åœºæ™¯ï¼‰
      const hasUserInfo = userName && userRole; // ä»å‰é¢çš„ä»£ç ä¸­è·å–ï¼ˆç¬¬äºŒæ¬¡è¿›å…¥æ—¶å·²èµ‹å€¼ï¼‰

      if (hasUserInfo) {
        // ğŸ¯ æœ‰ä¿å­˜çš„ç”¨æˆ·ä¿¡æ¯ï¼Œç›´æ¥éšè—èº«ä»½é€‰æ‹©æµ®çª—ï¼Œå‡†å¤‡è‡ªåŠ¨åŠ å…¥
        console.log('ğŸ”„ æ£€æµ‹åˆ°ä¿å­˜çš„ç”¨æˆ·ä¿¡æ¯ï¼Œå‡†å¤‡è‡ªåŠ¨åŠ å…¥æˆ¿é—´:', { userName, userRole });
        const identityOverlay = document.getElementById('identityOverlay');
        identityOverlay.style.display = 'none';
        console.log('âœ… å·²éšè—èº«ä»½é€‰æ‹©æµ®çª—');
      } else {
        // ğŸ”¥ æ˜¾ç¤ºèº«ä»½é€‰æ‹©æµ®çª—ï¼ˆæ‰€æœ‰å¹³å°ç»Ÿä¸€ï¼‰
        const identityOverlay = document.getElementById('identityOverlay');
        identityOverlay.style.display = 'flex';

        // æ˜¾ç¤ºæˆ¿é—´å·ï¼ˆæ ¼å¼åŒ–ä¸º AD-æ—¶é—´æˆ³ï¼‰
        const displayRoomId = roomId ? roomId.replace(/^room_/, 'AD-').split('_')[0] : '-';
        document.getElementById('roomIdDisplay').textContent = displayRoomId;

        // ğŸ”¥ æŒ‰é’®é»˜è®¤å·²åœ¨ HTML ä¸­è®¾ç½®ä¸ºç¦ç”¨çŠ¶æ€ï¼ˆdisabledï¼‰ï¼Œæ–‡å­—ä¸º"æ­£åœ¨åŠ è½½èµ„æº..."
        // ç­‰å¾… window.load äº‹ä»¶åä¼šè‡ªåŠ¨å¯ç”¨

        console.log('âœ… èº«ä»½é€‰æ‹©æµ®çª—å·²æ˜¾ç¤ºï¼ˆæŒ‰é’®é»˜è®¤ç¦ç”¨ï¼Œç­‰å¾…èµ„æºåŠ è½½ï¼‰');
      }
    });

    // ğŸ”¥ é˜¶æ®µ2ï¼šæ‰€æœ‰èµ„æºåŠ è½½å®Œæˆåå¯ç”¨æŒ‰é’®
    window.addEventListener('load', async () => {
      console.log('ğŸ“± æ‰€æœ‰èµ„æºåŠ è½½å®Œæˆï¼Œå¯ç”¨æŒ‰é’®');

      // ğŸ¯ æ£€æŸ¥æ˜¯å¦æœ‰ä¿å­˜çš„ç”¨æˆ·ä¿¡æ¯ï¼ˆé‡æ–°è¿›å…¥åœºæ™¯ï¼‰
      const hasUserInfo = userName && userRole; // ä»å‰é¢çš„ä»£ç ä¸­è·å–ï¼ˆç¬¬äºŒæ¬¡è¿›å…¥æ—¶å·²èµ‹å€¼ï¼‰

      if (hasUserInfo) {
        // ğŸ¯ æœ‰ä¿å­˜çš„ç”¨æˆ·ä¿¡æ¯ï¼Œè‡ªåŠ¨åŠ å…¥æˆ¿é—´
        console.log('ğŸ”„ è‡ªåŠ¨åŠ å…¥æˆ¿é—´ï¼Œç”¨æˆ·ä¿¡æ¯:', { userName, userRole });
        try {
          await init();
          console.log('âœ… è‡ªåŠ¨åŠ å…¥æˆ¿é—´æˆåŠŸ');
        } catch (error) {
          console.error('âŒ è‡ªåŠ¨åŠ å…¥æˆ¿é—´å¤±è´¥:', error);
          alert('è‡ªåŠ¨åŠ å…¥æˆ¿é—´å¤±è´¥ï¼Œè¯·é‡æ–°è¿›å…¥');
          // æ¸…é™¤ä¿å­˜çš„ç”¨æˆ·ä¿¡æ¯ï¼Œè®©ç”¨æˆ·é‡æ–°å¡«å†™
          const savedUserInfoKey = `guest_user_info_${roomId}`;
          localStorage.removeItem(savedUserInfoKey);
          window.location.href = `video-interview-guest.html?roomId=${roomId}`;
        }
        return; // ä¸å†æ‰§è¡Œåç»­çš„æŒ‰é’®ç»‘å®šé€»è¾‘
      }

      // ğŸ”¥ å¯ç”¨æŒ‰é’®å¹¶ç»‘å®šäº‹ä»¶
      const joinForm = document.getElementById('joinForm');
      const joinBtn = document.getElementById('joinBtn');
      const nameInput = document.getElementById('nameInput');
      const nameLabel = document.getElementById('nameLabel');
      const roleRadios = document.querySelectorAll('input[name="role"]');

      // å¯ç”¨æŒ‰é’®
      joinBtn.disabled = false;
      joinBtn.textContent = 'è¿›å…¥é¢è¯•é—´';

      // ğŸ”¥ ç›‘å¬è§’è‰²åˆ‡æ¢ï¼ŒåŠ¨æ€æ›´æ–°å§“åæ ‡ç­¾
      roleRadios.forEach(radio => {
        radio.addEventListener('change', (e) => {
          if (e.target.value === 'helper') {
            nameLabel.innerHTML = 'æ‚¨çš„å§“å <span style="color: red;">*</span>';
            nameInput.placeholder = 'è¯·è¾“å…¥æ‚¨çš„å§“åï¼ˆå¿…å¡«ï¼‰';
          } else {
            nameLabel.textContent = 'æ‚¨çš„å§“åï¼ˆé€‰å¡«ï¼‰';
            nameInput.placeholder = 'è¯·è¾“å…¥æ‚¨çš„å§“å';
          }
        });
      });

      // ğŸ”¥ ç»‘å®šè¡¨å•æäº¤äº‹ä»¶
      joinForm.addEventListener('submit', async (e) => {
        e.preventDefault(); // é˜»æ­¢è¡¨å•é»˜è®¤æäº¤

        // è·å–ç”¨æˆ·è¾“å…¥
        const inputName = nameInput.value.trim();
        const selectedRole = document.querySelector('input[name="role"]:checked').value;

        // ğŸ”¥ å¦‚æœé€‰æ‹©é˜¿å§¨è§’è‰²ï¼Œåå­—å¿…å¡«
        if (selectedRole === 'helper' && !inputName) {
          alert('è¯·è¾“å…¥æ‚¨çš„å§“å');
          nameInput.focus();
          return;
        }

        // ğŸ”¥ å§“åéå¿…å¡«ï¼ˆå®¢æˆ·å¯ä»¥ä¸å¡«ï¼‰ï¼Œå¦‚æœæ²¡å¡«å°±ç”¨é»˜è®¤å€¼
        let finalUserName;
        if (inputName) {
          finalUserName = selectedRole + '-' + inputName; // ä¾‹å¦‚: "customer-å¼ ä¸‰"
        } else {
          // æ²¡å¡«å§“åï¼Œä½¿ç”¨é»˜è®¤å€¼
          finalUserName = selectedRole; // ä¾‹å¦‚: "customer"
        }

        // è®¾ç½®å…¨å±€å˜é‡
        userName = finalUserName;
        userRole = selectedRole;

        console.log('âœ… ç”¨æˆ·ä¿¡æ¯:', { userName, userRole });

        // ğŸ¯ ç”Ÿæˆæˆ–è·å–ç¨³å®šçš„ç”¨æˆ·IDï¼ˆä¸ loginRoom ä¸­çš„é€»è¾‘ä¸€è‡´ï¼‰
        const sessionKey = `zego_user_${roomId}`;
        let storedUserId = sessionStorage.getItem(sessionKey);

        if (!storedUserId) {
          // ç¬¬ä¸€æ¬¡è¿›å…¥ï¼Œç”Ÿæˆæ–°ID
          storedUserId = 'guest_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
          sessionStorage.setItem(sessionKey, storedUserId);
          console.log('ğŸ†• ç”Ÿæˆæ–°ç”¨æˆ·ID:', storedUserId);
        } else {
          console.log('â™»ï¸ ä½¿ç”¨å·²æœ‰ç”¨æˆ·ID:', storedUserId);
        }

        // ğŸ¯ ä¿å­˜ç”¨æˆ·ä¿¡æ¯åˆ° localStorageï¼ˆç”¨äºé‡æ–°è¿›å…¥ï¼‰
        // ä½¿ç”¨ roomId ä½œä¸ºé”®åï¼Œå€¼ä¸­åŒ…å« userIdã€userNameã€userRole
        const savedUserInfoKey = `guest_user_info_${roomId}`;
        const userInfo = { userId: storedUserId, userName, userRole };
        localStorage.setItem(savedUserInfoKey, JSON.stringify(userInfo));
        console.log('âœ… ç”¨æˆ·ä¿¡æ¯å·²ä¿å­˜åˆ° localStorage:', savedUserInfoKey, userInfo);

        // ç¦ç”¨æŒ‰é’®ï¼Œé˜²æ­¢é‡å¤ç‚¹å‡»
        joinBtn.disabled = true;
        joinBtn.textContent = 'æ­£åœ¨è¿›å…¥é¢è¯•é—´...';

        // éšè—æµ®çª—
        const identityOverlay = document.getElementById('identityOverlay');
        identityOverlay.style.display = 'none';

        // ğŸ”¥ åœ¨ç”¨æˆ·ç‚¹å‡»"è¿›å…¥é¢è¯•é—´"çš„äº¤äº’ä¸Šä¸‹æ–‡ä¸­åˆå§‹åŒ–
        try {
          await init();
        } catch (error) {
          // å¦‚æœåˆå§‹åŒ–å¤±è´¥ï¼Œé‡æ–°æ˜¾ç¤ºæµ®çª—
          console.error('âŒ åˆå§‹åŒ–å¤±è´¥:', error);
          identityOverlay.style.display = 'flex';
          joinBtn.disabled = false;
          joinBtn.textContent = 'è¿›å…¥é¢è¯•é—´';
        }
      });

      console.log('âœ… æŒ‰é’®å·²å¯ç”¨ï¼Œäº‹ä»¶å·²ç»‘å®š');
    });

    // ==================== æè¯å™¨åŠŸèƒ½ ====================
    let teleprompterPollingTimer = null;

    // å¼€å§‹è½®è¯¢æè¯å™¨æ¶ˆæ¯
    function startTeleprompterPolling() {
      if (teleprompterPollingTimer) {
        clearInterval(teleprompterPollingTimer);
      }

      console.log('ğŸ“ å¼€å§‹è½®è¯¢æè¯å™¨æ¶ˆæ¯...');

      // ç«‹å³æ‰§è¡Œä¸€æ¬¡
      pollTeleprompterMessages();

      // æ¯2ç§’è½®è¯¢ä¸€æ¬¡
      teleprompterPollingTimer = setInterval(() => {
        pollTeleprompterMessages();
      }, 2000);
    }

    // åœæ­¢è½®è¯¢æè¯å™¨æ¶ˆæ¯
    function stopTeleprompterPolling() {
      if (teleprompterPollingTimer) {
        clearInterval(teleprompterPollingTimer);
        teleprompterPollingTimer = null;
        console.log('ğŸ“ å·²åœæ­¢è½®è¯¢æè¯å™¨æ¶ˆæ¯');
      }
    }

    // è½®è¯¢æè¯å™¨æ¶ˆæ¯
    async function pollTeleprompterMessages() {
      if (!roomId || !currentUserId) {
        return;
      }

      try {
        const response = await fetch('/api/zego/get-teleprompter', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            roomId: roomId,
            userId: currentUserId
          })
        });

        if (!response.ok) {
          console.warn('è·å–æè¯å™¨æ¶ˆæ¯å¤±è´¥:', response.status);
          return;
        }

        const result = await response.json();

        if (result.success && result.data && result.data.length > 0) {
          console.log('ğŸ“ æ”¶åˆ°æè¯å™¨æ¶ˆæ¯:', result.data);
          // å¤„ç†æ‰€æœ‰æœªè¯»æ¶ˆæ¯
          result.data.forEach(message => {
            handleTeleprompterMessage(message);
          });
        }
      } catch (error) {
        console.error('è½®è¯¢æè¯å™¨æ¶ˆæ¯å¤±è´¥:', error);
      }
    }

    // å¤„ç†æè¯å™¨æ¶ˆæ¯
    function handleTeleprompterMessage(message) {
      console.log('ğŸ“ æ”¶åˆ°æè¯å™¨æ¶ˆæ¯:', message);

      const { type, action, content, scrollSpeed } = message;

      // æ ¹æ®æ¶ˆæ¯ç±»å‹å¤„ç†
      if (type === 'CONTENT') {
        // CONTENTç±»å‹æ¶ˆæ¯ï¼šæ›´æ–°å†…å®¹å¹¶æ˜¾ç¤º
        updateTeleprompterContent(content, scrollSpeed);
      } else if (type === 'CONTROL') {
        // CONTROLç±»å‹æ¶ˆæ¯ï¼šæ§åˆ¶æ’­æ”¾çŠ¶æ€
        switch (action) {
          case 'PLAY':
            // ä½¿ç”¨æ¶ˆæ¯ä¸­çš„é€Ÿåº¦ï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨ä¿å­˜çš„é€Ÿåº¦
            const speedToUse = scrollSpeed || teleprompterSavedScrollSpeed;
            console.log('â–¶ï¸ æ’­æ”¾æè¯å™¨ï¼Œé€Ÿåº¦:', speedToUse, 'åƒç´ /ç§’');
            startTeleprompterScroll(speedToUse);
            break;
          case 'PAUSE':
            pauseTeleprompterScroll();
            break;
          case 'SHOW':
            showTeleprompter();
            break;
          case 'HIDE':
          case 'STOP':
            hideTeleprompter();
            break;
        }
      }
    }

    // æ›´æ–°æè¯å™¨å†…å®¹
    function updateTeleprompterContent(content, scrollSpeed) {
      const container = document.getElementById('teleprompterContainer');
      const contentDiv = document.getElementById('teleprompterContent');

      if (!container || !contentDiv) return;

      contentDiv.textContent = content;

      // ä¿å­˜æ»šåŠ¨é€Ÿåº¦ï¼Œä¾›åç»­PLAYæ¶ˆæ¯ä½¿ç”¨
      if (scrollSpeed && scrollSpeed > 0) {
        teleprompterSavedScrollSpeed = scrollSpeed;
        console.log('ğŸ’¾ ä¿å­˜æ»šåŠ¨é€Ÿåº¦:', scrollSpeed, 'åƒç´ /ç§’');
      }

      container.classList.add('show');

      console.log('ğŸ“ æè¯å™¨å†…å®¹å·²æ›´æ–°');
    }

    // æè¯å™¨æ»šåŠ¨æ§åˆ¶å˜é‡
    let teleprompterScrollAnimationId = null;
    let teleprompterScrollPosition = 0;
    let teleprompterScrollSpeed = 50; // åƒç´ /ç§’ï¼ˆé»˜è®¤å€¼ï¼‰
    let teleprompterSavedScrollSpeed = 50; // ä¿å­˜çš„æ»šåŠ¨é€Ÿåº¦ï¼ˆä»CONTENTæ¶ˆæ¯ä¸­è·å–ï¼‰

    // å¼€å§‹æ»šåŠ¨æè¯å™¨ - ä½¿ç”¨requestAnimationFrameå®ç°æµç•…æ»šåŠ¨
    function startTeleprompterScroll(scrollSpeed) {
      const contentDiv = document.getElementById('teleprompterContent');
      if (!contentDiv) return;

      // åœæ­¢ä¹‹å‰çš„æ»šåŠ¨
      pauseTeleprompterScroll();

      // è®¾ç½®æ»šåŠ¨é€Ÿåº¦ï¼ˆåƒç´ /ç§’ï¼‰
      teleprompterScrollSpeed = scrollSpeed || 50;

      // è·å–å½“å‰æ»šåŠ¨ä½ç½®
      teleprompterScrollPosition = contentDiv.scrollTop;

      let lastTimestamp = performance.now();

      // æ»šåŠ¨åŠ¨ç”»å‡½æ•°
      function scroll(timestamp) {
        const deltaTime = (timestamp - lastTimestamp) / 1000; // è½¬æ¢ä¸ºç§’
        lastTimestamp = timestamp;

        // è®¡ç®—æ–°çš„æ»šåŠ¨ä½ç½®
        teleprompterScrollPosition += teleprompterScrollSpeed * deltaTime;

        // è®¾ç½®æ»šåŠ¨ä½ç½®
        contentDiv.scrollTop = teleprompterScrollPosition;

        // æ£€æŸ¥æ˜¯å¦æ»šåŠ¨åˆ°åº•éƒ¨
        const maxScroll = contentDiv.scrollHeight - contentDiv.clientHeight;
        if (teleprompterScrollPosition >= maxScroll) {
          // å¾ªç¯æ»šåŠ¨ï¼šå›åˆ°é¡¶éƒ¨
          teleprompterScrollPosition = 0;
          contentDiv.scrollTop = 0;
        }

        // ç»§ç»­åŠ¨ç”»
        teleprompterScrollAnimationId = requestAnimationFrame(scroll);
      }

      // å¼€å§‹åŠ¨ç”»
      teleprompterScrollAnimationId = requestAnimationFrame(scroll);

      console.log('â–¶ï¸ æè¯å™¨å¼€å§‹æ»šåŠ¨ï¼Œé€Ÿåº¦:', teleprompterScrollSpeed, 'åƒç´ /ç§’');
    }

    // æš‚åœæ»šåŠ¨æè¯å™¨
    function pauseTeleprompterScroll() {
      if (teleprompterScrollAnimationId) {
        cancelAnimationFrame(teleprompterScrollAnimationId);
        teleprompterScrollAnimationId = null;
      }

      console.log('â¸ï¸ æè¯å™¨æš‚åœæ»šåŠ¨');
    }

    // æ˜¾ç¤ºæè¯å™¨
    function showTeleprompter() {
      const container = document.getElementById('teleprompterContainer');
      if (!container) return;

      container.classList.add('show');

      console.log('ğŸ‘ï¸ æè¯å™¨å·²æ˜¾ç¤º');
    }

    // éšè—æè¯å™¨
    function hideTeleprompter() {
      const container = document.getElementById('teleprompterContainer');
      if (!container) return;

      container.classList.remove('show');
      pauseTeleprompterScroll();

      console.log('âŒ æè¯å™¨å·²éšè—');
    }

    // æ¸…ç†å‡½æ•° - ç»Ÿä¸€çš„æ¸…ç†é€»è¾‘
    function cleanup() {
      console.log('ğŸ§¹ å¼€å§‹æ¸…ç†èµ„æº...');

      // ğŸ”¥ æ ‡è®°ä¸ºä¸»åŠ¨ç¦»å¼€ï¼Œé˜²æ­¢è§¦å‘è¢«è¸¢å‡ºå¼¹çª—
      hasLeftRoom = true;

      // ğŸ”¥ é€šçŸ¥åç«¯ç”¨æˆ·ç¦»å¼€
      if (roomId && currentUserId) {
        console.log(`ğŸ”” cleanup: å‡†å¤‡é€šçŸ¥åç«¯ç”¨æˆ·ç¦»å¼€`);
        console.log(`  - roomId: ${roomId}`);
        console.log(`  - currentUserId: ${currentUserId}`);

        const apiUrl = window.location.origin + '/api/zego/leave-room';
        const leaveData = { roomId: roomId, userId: currentUserId };

        // ğŸ”¥ æ–¹æ³•1ï¼šå°è¯•ä½¿ç”¨ sendBeaconï¼ˆæœ€å¯é ï¼‰
        if (navigator.sendBeacon) {
          try {
            const blob = new Blob([JSON.stringify(leaveData)], { type: 'application/json' });
            const success = navigator.sendBeacon(apiUrl, blob);
            console.log(`âœ… cleanup: sendBeacon å‘é€${success ? 'æˆåŠŸ' : 'å¤±è´¥'}`);
            if (!success) {
              // å¦‚æœ sendBeacon å¤±è´¥ï¼Œå°è¯•åŒæ­¥ XHR
              throw new Error('sendBeacon è¿”å› false');
            }
          } catch (error) {
            console.error(`âŒ cleanup: sendBeacon å¤±è´¥:`, error);

            // ğŸ”¥ æ–¹æ³•2ï¼šä½¿ç”¨åŒæ­¥ XMLHttpRequestï¼ˆå…œåº•æ–¹æ¡ˆï¼‰
            try {
              const xhr = new XMLHttpRequest();
              xhr.open('POST', apiUrl, false); // false = åŒæ­¥è¯·æ±‚
              xhr.setRequestHeader('Content-Type', 'application/json');
              xhr.send(JSON.stringify(leaveData));
              console.log(`âœ… cleanup: åŒæ­¥ XHR å‘é€æˆåŠŸ`);
            } catch (xhrError) {
              console.error(`âŒ cleanup: åŒæ­¥ XHR å¤±è´¥:`, xhrError);
            }
          }
        } else {
          console.warn(`âš ï¸ cleanup: navigator.sendBeacon ä¸æ”¯æŒï¼Œä½¿ç”¨åŒæ­¥ XHR`);

          // ç›´æ¥ä½¿ç”¨åŒæ­¥ XHR
          try {
            const xhr = new XMLHttpRequest();
            xhr.open('POST', apiUrl, false);
            xhr.setRequestHeader('Content-Type', 'application/json');
            xhr.send(JSON.stringify(leaveData));
            console.log(`âœ… cleanup: åŒæ­¥ XHR å‘é€æˆåŠŸ`);
          } catch (xhrError) {
            console.error(`âŒ cleanup: åŒæ­¥ XHR å¤±è´¥:`, xhrError);
          }
        }
      } else {
        console.log(`âš ï¸ cleanup: roomId æˆ– currentUserId ä¸ºç©ºï¼Œè·³è¿‡é€šçŸ¥`);
      }

      // ğŸ”¥ å…³é”®ä¿®å¤ï¼šæ ‡è®°ç”¨æˆ·å·²ç¦»å¼€ï¼Œç”¨äºé‡æ–°è¿›å…¥æ—¶æ£€æµ‹
      // è¿™æ ·é‡æ–°è¿›å…¥æ—¶å¯ä»¥çŸ¥é“éœ€è¦å®Œå…¨é‡æ–°åˆå§‹åŒ–
      try {
        sessionStorage.setItem(`user_left_${roomId}`, Date.now().toString());
        console.log('âœ… å·²æ ‡è®°ç”¨æˆ·ç¦»å¼€');
      } catch (e) {
        console.warn('æ ‡è®°ç”¨æˆ·ç¦»å¼€å¤±è´¥:', e);
      }

      try {
        // åœæ­¢è®¡æ—¶å™¨å’Œè½®è¯¢
        if (typeof stopTimer === 'function') stopTimer();
        if (typeof stopRemoteControlPolling === 'function') stopRemoteControlPolling();
        stopTeleprompterPolling();

        if (zg) {
          // åœæ­¢æ¨æµ
          if (localStream && currentStreamId) {
            try {
              zg.stopPublishingStream(currentStreamId);
              console.log('âœ… å·²åœæ­¢æ¨æµ');
            } catch (e) {
              console.warn('åœæ­¢æ¨æµå¤±è´¥:', e);
            }
          }

          // é”€æ¯æœ¬åœ°æµ
          if (localStream) {
            try {
              zg.destroyStream(localStream);
              console.log('âœ… å·²é”€æ¯æœ¬åœ°æµ');
            } catch (e) {
              console.warn('é”€æ¯æœ¬åœ°æµå¤±è´¥:', e);
            }
          }

          // é€€å‡ºæˆ¿é—´
          if (roomId) {
            try {
              zg.logoutRoom(roomId);
              console.log('âœ… å·²é€€å‡ºæˆ¿é—´');
            } catch (e) {
              console.warn('é€€å‡ºæˆ¿é—´å¤±è´¥:', e);
            }
          }

          // ğŸ”¥ é”€æ¯ZEGOå¼•æ“å®ä¾‹
          try {
            // æ³¨æ„ï¼šZegoExpressEngineæ²¡æœ‰destroyæ–¹æ³•ï¼Œä½†æˆ‘ä»¬å¯ä»¥ç½®ç©ºå¼•ç”¨
            zg = null;
            console.log('âœ… å·²æ¸…ç†ZEGOå¼•æ“å¼•ç”¨');
          } catch (e) {
            console.warn('æ¸…ç†ZEGOå¼•æ“å¤±è´¥:', e);
          }
        }

        // ğŸ”¥ æ¸…ç†æ‰€æœ‰è¿œç¨‹è§†é¢‘å®¹å™¨çš„DOMå…ƒç´ 
        console.log('ğŸ§¹ æ¸…ç†è¿œç¨‹è§†é¢‘å®¹å™¨...');
        const remoteBoxIds = ['remoteBox1', 'remoteBox2', 'remoteBox3', 'remoteBox4', 'remoteBox5'];
        remoteBoxIds.forEach(boxId => {
          const box = document.getElementById(boxId);
          if (box) {
            // åœæ­¢æ‰€æœ‰videoå…ƒç´ 
            const videos = box.querySelectorAll('video');
            videos.forEach(video => {
              video.pause();
              video.srcObject = null;
              video.src = '';
            });
            // é‡ç½®å®¹å™¨å†…å®¹ä¸ºæ™®é€šå ä½ç¬¦
            box.innerHTML = `
              <div class="video-placeholder empty-slot">
                <div class="placeholder-icon">ğŸ‘¤</div>
                <div class="placeholder-text">ç­‰å¾…åŠ å…¥</div>
              </div>
            `;
          }
        });
        console.log('âœ… è¿œç¨‹è§†é¢‘å®¹å™¨å·²æ¸…ç†');

        // ğŸ”¥ æ¸…ç†æœ¬åœ°è§†é¢‘
        const localVideo = document.getElementById('localVideo');
        if (localVideo) {
          localVideo.pause();
          localVideo.srcObject = null;
          localVideo.src = '';
          console.log('âœ… æœ¬åœ°è§†é¢‘å·²æ¸…ç†');
        }

        // é‡ç½®æ‰€æœ‰çŠ¶æ€å˜é‡
        localStream = null;
        currentStreamId = null;
        remoteStreams = {};

        console.log('âœ… èµ„æºæ¸…ç†å®Œæˆ');
      } catch (error) {
        console.error('æ¸…ç†èµ„æºæ—¶å‡ºé”™:', error);
      }
    }

    // ğŸ”¥ ä¿®æ”¹ï¼šåªåœ¨é¡µé¢çœŸæ­£å…³é—­æ—¶æ¸…ç†ï¼Œä¸åœ¨åå°æ—¶æ¸…ç†
    // beforeunload: é¡µé¢å³å°†å¸è½½ï¼ˆåˆ·æ–°ã€å…³é—­æ ‡ç­¾é¡µã€å¯¼èˆªç¦»å¼€ï¼‰
    window.addEventListener('beforeunload', (e) => {
      console.log('âš ï¸ é¡µé¢å³å°†å¸è½½ï¼ˆbeforeunloadï¼‰');
      cleanup();
    });

    // ğŸ”¥ ä¿®æ”¹ï¼špagehide äº‹ä»¶åœ¨é¡µé¢çœŸæ­£å¸è½½æ—¶è§¦å‘
    // è¿™æ˜¯æœ€å¯é çš„é¡µé¢å¸è½½äº‹ä»¶ï¼Œç‰¹åˆ«æ˜¯åœ¨ç§»åŠ¨ç«¯
    window.addEventListener('pagehide', (e) => {
      console.log('âš ï¸ é¡µé¢å¸è½½ï¼ˆpagehideï¼‰');
      cleanup();
    });

    // âŒ ç§»é™¤ï¼šä¸å†åœ¨ visibilitychange æ—¶æ¸…ç†èµ„æº
    // å› ä¸ºç”¨æˆ·å¯èƒ½åªæ˜¯åˆ‡æ¢åˆ°å…¶ä»–åº”ç”¨ï¼Œè€Œä¸æ˜¯çœŸæ­£å…³é—­é¡µé¢
    // ä¿æŒè¿æ¥å¯ä»¥è®©ç”¨æˆ·åˆ‡æ¢å›æ¥æ—¶ç»§ç»­é¢è¯•
  </script>

  <!-- ğŸ¯ å°† ZEGO SDK ç§»åˆ°é¡µé¢åº•éƒ¨ï¼Œé¿å…é˜»å¡é¡µé¢æ¸²æŸ“ -->
  <!-- è¿™æ ·ç”¨æˆ·å¯ä»¥ç«‹å³çœ‹åˆ°åŠé€æ˜èƒŒæ™¯å’Œè¡¨å•ï¼Œæå‡ä½“éªŒ -->
  <script src="./ZegoExpressWebRTC-standalone.js"></script>

</body>
</html>

