<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>è§†é¢‘é¢è¯• - è®¿å®¢</title>

  <!-- ä½¿ç”¨æœ¬åœ° ZEGO SDK -->
  <script src="./ZegoExpressWebRTC-standalone.js"></script>

  <!-- ZEGO Token ç”Ÿæˆåº“ï¼ˆå†…åµŒå®ç°ï¼‰ -->
  <script>
    // Token ç”Ÿæˆå‡½æ•°ï¼ˆå†…åµŒå®ç°ï¼Œé¿å… CDN åŠ è½½é—®é¢˜ï¼‰
    function generateToken04(appId, userId, secret, effectiveTimeInSeconds, payload) {
      if (!payload) {
        payload = '';
      }

      // HMAC-SHA256 å®ç°
      async function hmacSHA256(key, message) {
        const encoder = new TextEncoder();
        const keyData = encoder.encode(key);
        const messageData = encoder.encode(message);

        const cryptoKey = await crypto.subtle.importKey(
          'raw',
          keyData,
          { name: 'HMAC', hash: 'SHA-256' },
          false,
          ['sign']
        );

        const signature = await crypto.subtle.sign('HMAC', cryptoKey, messageData);
        return new Uint8Array(signature);
      }

      // Base64 ç¼–ç 
      function base64Encode(bytes) {
        let binary = '';
        for (let i = 0; i < bytes.length; i++) {
          binary += String.fromCharCode(bytes[i]);
        }
        return btoa(binary).replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
      }

      // ç”Ÿæˆ Token
      const expire = Math.floor(Date.now() / 1000) + effectiveTimeInSeconds;
      const body = {
        app_id: appId,
        user_id: userId,
        nonce: Math.floor(Math.random() * 2147483647),
        ctime: Math.floor(Date.now() / 1000),
        expire: expire
      };

      if (payload) {
        body.payload = payload;
      }

      const header = { alg: 'HS256', typ: 'JWT' };
      const headerStr = JSON.stringify(header);
      const bodyStr = JSON.stringify(body);

      const encoder = new TextEncoder();
      const headerBase64 = base64Encode(encoder.encode(headerStr));
      const bodyBase64 = base64Encode(encoder.encode(bodyStr));
      const toSign = headerBase64 + '.' + bodyBase64;

      // è¿”å› Promise
      return hmacSHA256(secret, toSign).then(signature => {
        const signatureBase64 = base64Encode(signature);
        return '04' + toSign + '.' + signatureBase64;
      });
    }
  </script>

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica', 'Arial', sans-serif;
      background: linear-gradient(180deg, #5fb3a3 0%, #4a9d8e 100%);
      overflow: hidden;
    }

    .container {
      width: 100vw;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* å¤´éƒ¨ä¿¡æ¯æ  */
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 12px;
      background: rgba(255, 255, 255, 0.95);
      border-radius: 8px;
      margin: 8px 8px 0 8px;
      box-shadow: 0 2px 6px rgba(95, 179, 163, 0.1);
      flex-shrink: 0;
    }

    .header-left,
    .header-right {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .info-item {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .room-label,
    .time-label {
      font-size: 12px;
      color: #666;
    }

    .room-value,
    .time-value {
      font-size: 13px;
      color: #333;
      font-weight: 500;
    }

    /* è§†é¢‘ç½‘æ ¼ - ä¸ä¸»æŒäººç«¯ä¿æŒä¸€è‡´ï¼ˆ2è¡Œ3åˆ—ï¼Œå…±6ä¸ªä½ç½®ï¼‰ */
    .video-grid {
      flex: 1;
      display: grid;
      grid-template-columns: 1fr 1fr;
      grid-auto-rows: calc((100% - 8px) / 2);
      gap: 8px;
      padding: 8px;
      background: transparent;
      overflow-y: auto;
      overflow-x: hidden;
    }

    /* éšè—æ»šåŠ¨æ¡ */
    .video-grid::-webkit-scrollbar {
      display: none;
    }

    .video-grid {
      -ms-overflow-style: none;
      scrollbar-width: none;
    }

    .video-item {
      position: relative;
      background: #000;
      border-radius: 12px;
      overflow: hidden;
      min-height: 0;
    }

    .video-box {
      width: 100%;
      height: 100%;
      position: relative;
    }

    .video-player {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }

    .video-label {
      position: absolute;
      bottom: 8px;
      left: 8px;
      background: rgba(0, 0, 0, 0.7);
      color: #fff;
      padding: 4px 10px;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 500;
      z-index: 1;
    }

    /* å ä½ç¬¦ */
    .video-placeholder {
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: #2a2a2a;
      color: #999;
    }

    /* é‚€è¯·æŒ‰é’®æ ·å¼ */
    .invite-placeholder {
      cursor: pointer;
      transition: all 0.3s ease;
      background: rgba(95, 179, 163, 0.1) !important;
      border: 2px dashed rgba(95, 179, 163, 0.3);
    }

    .invite-placeholder .placeholder-icon {
      color: #5fb3a3;
      font-size: 64px;
      font-weight: 300;
      line-height: 1;
      opacity: 1;
    }

    .invite-placeholder .placeholder-text {
      color: #fff;
    }

    .invite-placeholder:hover {
      background: rgba(95, 179, 163, 0.2) !important;
      border-color: rgba(95, 179, 163, 0.5);
    }

    .invite-placeholder:hover .placeholder-icon {
      transform: rotate(90deg);
    }

    .invite-placeholder:active {
      transform: scale(0.98);
    }

    .placeholder-icon {
      font-size: 48px;
      margin-bottom: 8px;
      opacity: 0.5;
    }

    .placeholder-text {
      font-size: 13px;
    }

    /* æ§åˆ¶æŒ‰é’® */
    .controls {
      display: flex;
      justify-content: space-around;
      padding: 16px;
      padding-bottom: calc(16px + env(safe-area-inset-bottom));
      background: rgba(255, 255, 255, 0.95);
      border-radius: 20px 20px 0 0;
      box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
      flex-shrink: 0;
    }

    .control-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 6px;
      cursor: pointer;
      padding: 8px 16px;
      border-radius: 12px;
      transition: all 0.2s;
      min-width: 70px;
    }

    .control-item:active {
      transform: scale(0.95);
      background: rgba(0, 0, 0, 0.05);
    }

    .control-icon-text {
      font-size: 28px;
      line-height: 1;
    }

    .control-label {
      font-size: 12px;
      color: #666;
      font-weight: 400;
    }

    /* å…³é—­çŠ¶æ€æ ·å¼ */
    .control-item.disabled {
      opacity: 0.5;
    }

    .control-item.disabled .control-icon-text {
      color: #999;
    }

    .control-item.disabled .control-label {
      color: #999;
    }

    .control-item-danger:active {
      background: rgba(255, 68, 68, 0.1);
    }

    .control-item-danger .control-icon-text {
      color: #f44;
    }

    .control-item-danger .control-label {
      color: #f44;
    }

    /* åŠ è½½æç¤º */
    .loading {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0, 0, 0, 0.8);
      color: #fff;
      padding: 20px 30px;
      border-radius: 8px;
      font-size: 16px;
      z-index: 2000;
    }

    /* é‚€è¯·å¼¹çª—æ ·å¼ */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.6);
      z-index: 3000;
      justify-content: center;
      align-items: center;
    }

    .modal.show {
      display: flex;
    }

    .modal-content {
      background: #fff;
      border-radius: 16px;
      width: 90%;
      max-width: 450px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      animation: modalSlideIn 0.3s ease;
    }

    @keyframes modalSlideIn {
      from {
        transform: translateY(-50px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px 24px;
      border-bottom: 1px solid #eee;
    }

    .modal-header h3 {
      margin: 0;
      font-size: 18px;
      color: #333;
    }

    .modal-close {
      font-size: 28px;
      color: #999;
      cursor: pointer;
      line-height: 1;
      transition: color 0.3s;
    }

    .modal-close:hover {
      color: #333;
    }

    .modal-body {
      padding: 24px;
    }

    .modal-tip {
      margin: 0 0 12px 0;
      color: #666;
      font-size: 14px;
    }

    .invite-link-box {
      background: #f5f5f5;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 16px;
    }

    .invite-link-input {
      width: 100%;
      border: none;
      background: transparent;
      color: #333;
      font-size: 13px;
      outline: none;
      word-break: break-all;
    }

    .invite-copy-btn {
      width: 100%;
      padding: 14px;
      background: linear-gradient(135deg, #5fb3a3 0%, #4a9d8e 100%);
      color: #fff;
      border: none;
      border-radius: 10px;
      font-size: 16px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s;
      box-shadow: 0 4px 16px rgba(95, 179, 163, 0.3);
    }

    .invite-copy-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(95, 179, 163, 0.4);
    }

    .invite-copy-btn:active {
      transform: translateY(0);
    }

    .modal-hint {
      margin: 16px 0 0 0;
      text-align: center;
      color: #999;
      font-size: 13px;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- é¡¶éƒ¨ä¿¡æ¯ -->
    <div class="header">
      <div class="header-left">
        <div class="info-item">
          <span class="room-label">æˆ¿é—´å·ï¼š</span>
          <span class="room-value" id="roomIdDisplay">-</span>
        </div>
      </div>
      <div class="header-right">
        <div class="info-item">
          <span class="time-label">é¢è¯•æ—¶é—´ï¼š</span>
          <span class="time-value" id="timer">00:00</span>
        </div>
      </div>
    </div>

    <!-- è§†é¢‘ç½‘æ ¼ - 6ä¸ªä½ç½® -->
    <div class="video-grid">
      <!-- ä½ç½®1ï¼šæœ¬åœ°è§†é¢‘ -->
      <div class="video-item">
        <div class="video-box" id="localBox">
          <video id="localVideo" class="video-player" autoplay muted playsinline></video>
          <div class="video-label" id="localLabel">æˆ‘</div>
        </div>
      </div>

      <!-- ä½ç½®2ï¼šä¸»æŒäºº -->
      <div class="video-item">
        <div class="video-box" id="remoteBox1">
          <div class="video-placeholder">
            <div class="placeholder-icon">ğŸ‘¤</div>
            <div class="placeholder-text">ç­‰å¾…ä¸»æŒäºº...</div>
          </div>
        </div>
      </div>

      <!-- ä½ç½®3ï¼šå…¶ä»–å‚ä¸è€… -->
      <div class="video-item">
        <div class="video-box" id="remoteBox2">
          <div class="video-placeholder invite-placeholder" onclick="showInviteModal()">
            <div class="placeholder-icon">+</div>
            <div class="placeholder-text">é‚€è¯·ç”¨æˆ·</div>
          </div>
        </div>
      </div>

      <!-- ä½ç½®4ï¼šå…¶ä»–å‚ä¸è€… -->
      <div class="video-item">
        <div class="video-box" id="remoteBox3">
          <div class="video-placeholder invite-placeholder" onclick="showInviteModal()">
            <div class="placeholder-icon">+</div>
            <div class="placeholder-text">é‚€è¯·ç”¨æˆ·</div>
          </div>
        </div>
      </div>

      <!-- ä½ç½®5ï¼šå…¶ä»–å‚ä¸è€… -->
      <div class="video-item">
        <div class="video-box" id="remoteBox4">
          <div class="video-placeholder invite-placeholder" onclick="showInviteModal()">
            <div class="placeholder-icon">+</div>
            <div class="placeholder-text">é‚€è¯·ç”¨æˆ·</div>
          </div>
        </div>
      </div>

      <!-- ä½ç½®6ï¼šå…¶ä»–å‚ä¸è€… -->
      <div class="video-item">
        <div class="video-box" id="remoteBox5">
          <div class="video-placeholder invite-placeholder" onclick="showInviteModal()">
            <div class="placeholder-icon">+</div>
            <div class="placeholder-text">é‚€è¯·ç”¨æˆ·</div>
          </div>
        </div>
      </div>
    </div>

    <!-- æ§åˆ¶æŒ‰é’® -->
    <div class="controls">
      <div class="control-item" id="micBtn" onclick="toggleMic()">
        <div class="control-icon-text">ğŸ¤</div>
        <div class="control-label">éº¦å…‹é£</div>
      </div>
      <div class="control-item" id="cameraBtn" onclick="toggleCamera()">
        <div class="control-icon-text">ğŸ“¹</div>
        <div class="control-label">æ‘„åƒå¤´</div>
      </div>
      <div class="control-item" id="flipBtn" onclick="flipCamera()">
        <div class="control-icon-text">ğŸ”„</div>
        <div class="control-label">ç¿»è½¬</div>
      </div>
      <div class="control-item control-item-danger" onclick="leaveRoom()">
        <div class="control-icon-text">ğŸ“</div>
        <div class="control-label">ç¦»å¼€æˆ¿é—´</div>
      </div>
    </div>
  </div>

  <div id="loading" class="loading" style="display: none;">æ­£åœ¨è¿æ¥...</div>

  <!-- é‚€è¯·å¼¹çª— -->
  <div id="inviteModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>é‚€è¯·å…¶ä»–äººåŠ å…¥é¢è¯•</h3>
        <span class="modal-close" onclick="closeInviteModal()">&times;</span>
      </div>
      <div class="modal-body">
        <p class="modal-tip">å¤åˆ¶ä»¥ä¸‹é“¾æ¥å‘é€ç»™å…¶ä»–äººï¼š</p>
        <div class="invite-link-box">
          <input type="text" id="inviteLink" class="invite-link-input" readonly>
        </div>
        <button class="invite-copy-btn" onclick="copyInviteLink()">
          ğŸ“‹ å¤åˆ¶é“¾æ¥å¹¶é‚€è¯·
        </button>
        <p class="modal-hint">ğŸ’¡ å¯¹æ–¹ç‚¹å‡»é“¾æ¥å³å¯åŠ å…¥</p>
      </div>
    </div>
  </div>

  <script>
    // è·å–URLå‚æ•°
    const urlParams = new URLSearchParams(window.location.search);
    const roomId = urlParams.get('roomId');
    const userName = urlParams.get('userName') || 'è®¿å®¢';
    const userRole = urlParams.get('role') || 'customer'; // è‹±æ–‡ï¼šcustomer æˆ– helper

    // è§’è‰²è½¬æ¢ï¼ˆè‹±æ–‡ -> ä¸­æ–‡æ˜¾ç¤ºï¼‰
    const roleDisplayMap = {
      'customer': 'å®¢æˆ·',
      'helper': 'é˜¿å§¨'
    };
    const roleDisplay = roleDisplayMap[userRole] || 'è®¿å®¢';

    // æ ¼å¼åŒ–æˆ¿é—´å·æ˜¾ç¤ºï¼ˆä¸ä¸»æŒäººç«¯ä¿æŒä¸€è‡´ï¼‰
    const displayRoomId = roomId ? roomId.replace(/^room_/, 'AD-').split('_')[0] : '-';

    // æ˜¾ç¤ºä¿¡æ¯
    document.getElementById('roomIdDisplay').textContent = displayRoomId;
    document.getElementById('localLabel').textContent = userName || roleDisplay;

    if (!roomId) {
      alert('æ— æ•ˆçš„æˆ¿é—´å·');
      window.location.href = 'video-interview-guest.html';
    }

    // ZEGOé…ç½®ï¼ˆä¸ä¸»æŒäººç«¯ä¿æŒä¸€è‡´ï¼‰
    const appID = 1279160453;
    const server = 'wss://webliveroom-api.zego.im/ws';
    const serverSecret = 'e18cc600e2939d412c48f152e157f01d';

    let zg = null;
    let localStream = null;
    let currentUserId = ''; // å½“å‰ç”¨æˆ·ID
    let currentStreamId = ''; // å½“å‰æµID
    let isMicOn = true;
    let isCameraOn = true;
    let isFrontCamera = true; // é»˜è®¤å‰ç½®æ‘„åƒå¤´
    let timerInterval = null;
    let startTime = null;

    // ç”ŸæˆTokenï¼ˆè®¿å®¢æ¨¡å¼ï¼šè°ƒç”¨åç«¯å…¬å¼€æ¥å£ï¼‰
    async function generateToken(userID, roomID) {
      try {
        console.log('ğŸ”‘ æ­£åœ¨è·å–è®¿å®¢Token...');
        console.log('ğŸ“± AppID:', appID);
        console.log('ğŸ‘¤ UserID:', userID);
        console.log('ğŸ  RoomID:', roomID);
        console.log('ğŸ‘¨ UserName:', userName);
        console.log('ğŸ­ Role:', userRole);

        // è®¿å®¢æ¨¡å¼ï¼šè°ƒç”¨åç«¯å…¬å¼€æ¥å£ï¼ˆæ— éœ€JWTè®¤è¯ï¼‰
        const requestBody = {
          userId: userID,
          roomId: roomID,
          userName: userName,
          role: userRole,
          expireTime: 7200
        };

        console.log('ğŸ“¤ è¯·æ±‚å‚æ•°:', requestBody);

        const response = await fetch('https://crm.andejiazheng.com/api/zego/generate-guest-token', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(requestBody)
        });

        console.log('ğŸ“¥ å“åº”çŠ¶æ€:', response.status, response.statusText);

        if (!response.ok) {
          const errorText = await response.text();
          console.error('âŒ é”™è¯¯å“åº”:', errorText);

          let errorData;
          try {
            errorData = JSON.parse(errorText);
          } catch (e) {
            throw new Error(`HTTP ${response.status}: ${errorText}`);
          }

          throw new Error(errorData.message || `HTTP error! status: ${response.status}`);
        }

        const result = await response.json();
        console.log('ğŸ“¥ å“åº”æ•°æ®:', result);

        if (result.success && result.data && result.data.token) {
          console.log('âœ… Token è·å–æˆåŠŸ');
          return result.data.token;
        } else {
          throw new Error(result.message || 'è·å–Tokenå¤±è´¥');
        }
      } catch (error) {
        console.error('âŒ Token è·å–å¤±è´¥:', error);
        console.error('âŒ é”™è¯¯è¯¦æƒ…:', error.message);
        throw error;
      }
    }

    // åˆå§‹åŒ–
    async function init() {
      showLoading('æ­£åœ¨åˆå§‹åŒ–...');

      try {
        // åˆ›å»ºZegoExpressEngineå®ä¾‹
        zg = new ZegoExpressEngine(appID, server);

        // å…³é—­è¯¦ç»†æ—¥å¿—
        zg.setLogConfig({
          logLevel: 'error', // åªæ˜¾ç¤ºé”™è¯¯æ—¥å¿—
          remoteLogLevel: 'disable' // ç¦ç”¨è¿œç¨‹æ—¥å¿—
        });

        console.log('âœ… ZEGO SDK åˆå§‹åŒ–æˆåŠŸ');

        // âš ï¸ é‡è¦ï¼šåœ¨ç™»å½•æˆ¿é—´ä¹‹å‰è®¾ç½®äº‹ä»¶ç›‘å¬
        listenRemoteStream();

        // ç™»å½•æˆ¿é—´
        await loginRoom();

        // åˆ›å»ºæœ¬åœ°æµ
        await createLocalStream();

        hideLoading();
        startTimer();

      } catch (error) {
        console.error('âŒ åˆå§‹åŒ–å¤±è´¥:', error);
        hideLoading();
        alert('è¿æ¥å¤±è´¥: ' + (error.message || 'æœªçŸ¥é”™è¯¯'));
      }
    }

    // ç™»å½•æˆ¿é—´
    async function loginRoom() {
      showLoading('æ­£åœ¨åŠ å…¥æˆ¿é—´...');

      // ç”Ÿæˆç”¨æˆ·IDå¹¶ä¿å­˜ä¸ºå…¨å±€å˜é‡
      currentUserId = 'guest_' + Date.now();

      // è·å–Token
      const token = await generateToken(currentUserId, roomId);

      const result = await zg.loginRoom(roomId, token, {
        userID: currentUserId,
        userName: userName
      });

      console.log('âœ… ç™»å½•æˆ¿é—´æˆåŠŸ');
    }

    // åˆ›å»ºæœ¬åœ°æµ
    async function createLocalStream() {
      showLoading('æ­£åœ¨æ‰“å¼€æ‘„åƒå¤´å’Œéº¦å…‹é£...');

      localStream = await zg.createStream({
        camera: {
          video: true,
          audio: true
        }
      });

      const localVideo = document.getElementById('localVideo');
      localVideo.srcObject = localStream;

      // æ¨æµï¼ˆä½¿ç”¨ä¸userIdå¯¹åº”çš„streamIDï¼‰
      currentStreamId = 'stream_' + currentUserId;
      await zg.startPublishingStream(currentStreamId, localStream);

      console.log('âœ… æœ¬åœ°æµåˆ›å»ºæˆåŠŸ, StreamID:', currentStreamId);
    }

    // è¿œç¨‹æµç®¡ç†
    const remoteStreams = {}; // å­˜å‚¨è¿œç¨‹æµä¿¡æ¯ { streamID: { boxId, stream } }
    const availableBoxes = ['remoteBox1', 'remoteBox2', 'remoteBox3', 'remoteBox4', 'remoteBox5'];

    // ç›‘å¬è¿œç¨‹æµ
    function listenRemoteStream() {
      zg.on('roomStreamUpdate', async (roomID, updateType, streamList) => {
        console.log('ğŸ”” è¿œç¨‹æµæ›´æ–° - RoomID:', roomID);
        console.log('ğŸ”” æ›´æ–°ç±»å‹:', updateType);
        console.log('ğŸ”” æµåˆ—è¡¨æ•°é‡:', streamList.length);
        console.log('ğŸ”” æµè¯¦æƒ…:', streamList);

        if (updateType === 'ADD') {
          // æœ‰æ–°çš„è¿œç¨‹æµåŠ å…¥
          console.log('âœ… æ£€æµ‹åˆ°æ–°æµåŠ å…¥ï¼Œå¼€å§‹æ’­æ”¾...');
          for (const stream of streamList) {
            console.log('ğŸ“º å‡†å¤‡æ’­æ”¾æµ:', stream.streamID, 'ç”¨æˆ·:', stream.user);
            // æ‰¾åˆ°ç¬¬ä¸€ä¸ªç©ºä½
            const emptyBoxId = availableBoxes.find(boxId => {
              return !Object.values(remoteStreams).some(s => s.boxId === boxId);
            });

            if (!emptyBoxId) {
              console.warn('âš ï¸ æ²¡æœ‰ç©ºä½äº†');
              continue;
            }

            const remoteStream = await zg.startPlayingStream(stream.streamID);

            // æ˜¾ç¤ºè¿œç¨‹è§†é¢‘
            const box = document.getElementById(emptyBoxId);
            box.innerHTML = `
              <video class="video-player" autoplay playsinline></video>
              <div class="video-label">${stream.user.userName || 'å‚ä¸è€…'}</div>
            `;

            const remoteVideo = box.querySelector('video');
            remoteVideo.srcObject = remoteStream;

            // è®°å½•æµä¿¡æ¯
            remoteStreams[stream.streamID] = {
              boxId: emptyBoxId,
              stream: remoteStream
            };
          }
        } else if (updateType === 'DELETE') {
          // è¿œç¨‹æµç¦»å¼€
          for (const stream of streamList) {
            const streamInfo = remoteStreams[stream.streamID];
            if (streamInfo) {
              const box = document.getElementById(streamInfo.boxId);
              box.innerHTML = `
                <div class="video-placeholder invite-placeholder" onclick="showInviteModal()">
                  <div class="placeholder-icon">+</div>
                  <div class="placeholder-text">é‚€è¯·ç”¨æˆ·</div>
                </div>
              `;

              delete remoteStreams[stream.streamID];
              console.log('âœ… è¿œç¨‹æµå·²ç¦»å¼€');
            }
          }
        }
      });
    }

    // åˆ‡æ¢éº¦å…‹é£
    function toggleMic() {
      if (!localStream) return;

      isMicOn = !isMicOn;
      zg.muteMicrophone(!isMicOn);

      const btn = document.getElementById('micBtn');
      const iconText = btn.querySelector('.control-icon-text');
      const label = btn.querySelector('.control-label');

      if (isMicOn) {
        btn.classList.remove('disabled');
        iconText.textContent = 'ğŸ¤';
        label.textContent = 'éº¦å…‹é£';
      } else {
        btn.classList.add('disabled');
        iconText.textContent = 'ğŸ¤';
        label.textContent = 'å·²é™éŸ³';
      }
    }

    // åˆ‡æ¢æ‘„åƒå¤´
    function toggleCamera() {
      if (!localStream) return;

      isCameraOn = !isCameraOn;
      zg.mutePublishStreamVideo(localStream, !isCameraOn);

      const btn = document.getElementById('cameraBtn');
      const iconText = btn.querySelector('.control-icon-text');
      const label = btn.querySelector('.control-label');

      if (isCameraOn) {
        btn.classList.remove('disabled');
        iconText.textContent = 'ğŸ“¹';
        label.textContent = 'æ‘„åƒå¤´';
      } else {
        btn.classList.add('disabled');
        iconText.textContent = 'ğŸ“¹';
        label.textContent = 'å·²å…³é—­';
      }
    }

    // ç¿»è½¬é•œå¤´ï¼ˆå‰ç½®/åç½®åˆ‡æ¢ï¼‰
    async function flipCamera() {
      if (!localStream || !isCameraOn) {
        alert('è¯·å…ˆæ‰“å¼€æ‘„åƒå¤´');
        return;
      }

      try {
        showLoading('æ­£åœ¨åˆ‡æ¢æ‘„åƒå¤´...');

        // åœæ­¢å½“å‰æµ
        await zg.stopPublishingStream(currentStreamId);
        zg.destroyStream(localStream);

        // åˆ‡æ¢æ‘„åƒå¤´æ–¹å‘
        isFrontCamera = !isFrontCamera;

        // åˆ›å»ºæ–°çš„æµ
        localStream = await zg.createStream({
          camera: {
            video: {
              facingMode: isFrontCamera ? 'user' : 'environment'
            },
            audio: true
          }
        });

        // æ›´æ–°æœ¬åœ°è§†é¢‘
        const localVideo = document.getElementById('localVideo');
        localVideo.srcObject = localStream;

        // é‡æ–°æ¨æµï¼ˆä½¿ç”¨ç›¸åŒçš„streamIDï¼‰
        await zg.startPublishingStream(currentStreamId, localStream);

        hideLoading();
        console.log('âœ… æ‘„åƒå¤´å·²åˆ‡æ¢');

      } catch (error) {
        console.error('âŒ åˆ‡æ¢æ‘„åƒå¤´å¤±è´¥:', error.message);
        hideLoading();
        alert('åˆ‡æ¢æ‘„åƒå¤´å¤±è´¥');
      }
    }

    // æ˜¾ç¤ºé‚€è¯·å¼¹çª—
    function showInviteModal() {
      const modal = document.getElementById('inviteModal');
      const inviteLink = document.getElementById('inviteLink');

      // ç”Ÿæˆé‚€è¯·é“¾æ¥ï¼ˆè®¿å®¢ç«¯ï¼‰
      const baseUrl = window.location.origin + window.location.pathname.replace('video-interview-guest-room.html', 'video-interview-guest.html');
      const link = `${baseUrl}?roomId=${roomId}`;

      inviteLink.value = link;
      modal.classList.add('show');
    }

    // å…³é—­é‚€è¯·å¼¹çª—
    function closeInviteModal() {
      const modal = document.getElementById('inviteModal');
      modal.classList.remove('show');
    }

    // å¤åˆ¶é‚€è¯·é“¾æ¥
    async function copyInviteLink() {
      const inviteLink = document.getElementById('inviteLink');

      try {
        await navigator.clipboard.writeText(inviteLink.value);

        const btn = event.target;
        const originalText = btn.textContent;
        btn.textContent = 'âœ… é“¾æ¥å·²å¤åˆ¶ï¼';
        btn.style.background = 'linear-gradient(135deg, #4caf50 0%, #45a049 100%)';

        setTimeout(() => {
          btn.textContent = originalText;
          btn.style.background = 'linear-gradient(135deg, #5fb3a3 0%, #4a9d8e 100%)';
          closeInviteModal();
        }, 1500);

      } catch (err) {
        alert('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶é“¾æ¥');
      }
    }

    // ç‚¹å‡»å¼¹çª—å¤–éƒ¨å…³é—­
    document.addEventListener('click', function(e) {
      const modal = document.getElementById('inviteModal');
      if (e.target === modal) {
        closeInviteModal();
      }
    });

    // ç¦»å¼€æˆ¿é—´
    function leaveRoom() {
      if (confirm('ç¡®å®šè¦ç¦»å¼€é¢è¯•å—ï¼Ÿ')) {
        try {
          stopTimer();

          if (zg && localStream) {
            zg.destroyStream(localStream);
            zg.logoutRoom(roomId);
          }

          console.log('âœ… å·²ç¦»å¼€æˆ¿é—´');
          window.location.href = 'video-interview-guest.html';
        } catch (error) {
          console.error('âŒ ç¦»å¼€æˆ¿é—´å¤±è´¥:', error.message);
          window.location.href = 'video-interview-guest.html';
        }
      }
    }

    // è®¡æ—¶å™¨
    function startTimer() {
      startTime = Date.now();
      timerInterval = setInterval(() => {
        const elapsed = Math.floor((Date.now() - startTime) / 1000);
        const minutes = Math.floor(elapsed / 60).toString().padStart(2, '0');
        const seconds = (elapsed % 60).toString().padStart(2, '0');
        document.getElementById('timer').textContent = `${minutes}:${seconds}`;
      }, 1000);
    }

    function stopTimer() {
      if (timerInterval) {
        clearInterval(timerInterval);
        timerInterval = null;
      }
    }

    // åŠ è½½æç¤º
    function showLoading(text) {
      const loading = document.getElementById('loading');
      loading.textContent = text;
      loading.style.display = 'block';
    }

    function hideLoading() {
      document.getElementById('loading').style.display = 'none';
    }

    // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
    window.addEventListener('load', init);

    // é¡µé¢å…³é—­å‰æ¸…ç†
    window.addEventListener('beforeunload', () => {
      if (zg && localStream) {
        zg.destroyStream(localStream);
        zg.logoutRoom(roomId);
      }
    });
  </script>
</body>
</html>

