<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>è§†é¢‘é¢è¯• - è®¿å®¢</title>

  <!-- ä½¿ç”¨æœ¬åœ° ZEGO SDK -->
  <script src="./ZegoExpressWebRTC-standalone.js"></script>

  <!-- ZEGO Token ç”Ÿæˆåº“ï¼ˆå†…åµŒå®ç°ï¼‰ -->
  <script>
    // Token ç”Ÿæˆå‡½æ•°ï¼ˆå†…åµŒå®ç°ï¼Œé¿å… CDN åŠ è½½é—®é¢˜ï¼‰
    function generateToken04(appId, userId, secret, effectiveTimeInSeconds, payload) {
      if (!payload) {
        payload = '';
      }

      // HMAC-SHA256 å®ç°
      async function hmacSHA256(key, message) {
        const encoder = new TextEncoder();
        const keyData = encoder.encode(key);
        const messageData = encoder.encode(message);

        const cryptoKey = await crypto.subtle.importKey(
          'raw',
          keyData,
          { name: 'HMAC', hash: 'SHA-256' },
          false,
          ['sign']
        );

        const signature = await crypto.subtle.sign('HMAC', cryptoKey, messageData);
        return new Uint8Array(signature);
      }

      // Base64 ç¼–ç 
      function base64Encode(bytes) {
        let binary = '';
        for (let i = 0; i < bytes.length; i++) {
          binary += String.fromCharCode(bytes[i]);
        }
        return btoa(binary).replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
      }

      // ç”Ÿæˆ Token
      const expire = Math.floor(Date.now() / 1000) + effectiveTimeInSeconds;
      const body = {
        app_id: appId,
        user_id: userId,
        nonce: Math.floor(Math.random() * 2147483647),
        ctime: Math.floor(Date.now() / 1000),
        expire: expire
      };

      if (payload) {
        body.payload = payload;
      }

      const header = { alg: 'HS256', typ: 'JWT' };
      const headerStr = JSON.stringify(header);
      const bodyStr = JSON.stringify(body);

      const encoder = new TextEncoder();
      const headerBase64 = base64Encode(encoder.encode(headerStr));
      const bodyBase64 = base64Encode(encoder.encode(bodyStr));
      const toSign = headerBase64 + '.' + bodyBase64;

      // è¿”å› Promise
      return hmacSHA256(secret, toSign).then(signature => {
        const signatureBase64 = base64Encode(signature);
        return '04' + toSign + '.' + signatureBase64;
      });
    }
  </script>

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica', 'Arial', sans-serif;
      background: linear-gradient(180deg, #5fb3a3 0%, #4a9d8e 100%);
      overflow: hidden;
    }

    .container {
      width: 100vw;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* å¤´éƒ¨ä¿¡æ¯æ  */
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 12px;
      background: rgba(255, 255, 255, 0.95);
      border-radius: 8px;
      margin: 8px 8px 0 8px;
      box-shadow: 0 2px 6px rgba(95, 179, 163, 0.1);
      flex-shrink: 0;
    }

    .header-left,
    .header-right {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .info-item {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .room-label,
    .time-label {
      font-size: 12px;
      color: #666;
    }

    .room-value,
    .time-value {
      font-size: 13px;
      color: #333;
      font-weight: 500;
    }

    /* è§†é¢‘ç½‘æ ¼ - ä¸ä¸»æŒäººç«¯ä¿æŒä¸€è‡´ï¼ˆ2è¡Œ3åˆ—ï¼Œå…±6ä¸ªä½ç½®ï¼‰ */
    .video-grid {
      flex: 1;
      display: grid;
      grid-template-columns: 1fr 1fr;
      grid-auto-rows: calc((100% - 8px) / 2);
      gap: 8px;
      padding: 8px;
      background: transparent;
      overflow-y: auto;
      overflow-x: hidden;
    }

    /* éšè—æ»šåŠ¨æ¡ */
    .video-grid::-webkit-scrollbar {
      display: none;
    }

    .video-grid {
      -ms-overflow-style: none;
      scrollbar-width: none;
    }

    .video-item {
      position: relative;
      background: #000;
      border-radius: 12px;
      overflow: hidden;
      min-height: 0;
    }

    .video-box {
      width: 100%;
      height: 100%;
      position: relative;
    }

    .video-player {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }

    /* âœ… æœ¬åœ°è§†é¢‘é•œåƒï¼šè®©å‰ç½®æ‘„åƒå¤´çš„ç”»é¢ç¬¦åˆè‡ªæ‹ä¹ æƒ¯ï¼ˆå·¦å³ç¿»è½¬ï¼‰
     * æ³¨æ„ï¼šåªå¯¹æœ¬åœ°é¢„è§ˆé•œåƒï¼Œæ¨æµç»™å¯¹æ–¹çš„ç”»é¢æ˜¯æ­£å¸¸çš„ï¼ˆä¸é•œåƒï¼‰
     */
    #localVideo {
      transform: scaleX(-1);  /* æ°´å¹³ç¿»è½¬æœ¬åœ°è§†é¢‘ */
    }

    .video-label {
      position: absolute;
      bottom: 8px;
      left: 8px;
      background: rgba(0, 0, 0, 0.7);
      color: #fff;
      padding: 4px 10px;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 500;
      z-index: 1;
    }

    /* å ä½ç¬¦ */
    .video-placeholder {
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: #2a2a2a;
      color: #999;
    }

    /* é‚€è¯·æŒ‰é’®æ ·å¼ */
    .invite-placeholder {
      cursor: pointer;
      transition: all 0.3s ease;
      background: rgba(95, 179, 163, 0.1) !important;
      border: 2px dashed rgba(95, 179, 163, 0.3);
    }

    .invite-placeholder .placeholder-icon {
      color: #5fb3a3;
      font-size: 64px;
      font-weight: 300;
      line-height: 1;
      opacity: 1;
    }

    .invite-placeholder .placeholder-text {
      color: #fff;
    }

    .invite-placeholder:hover {
      background: rgba(95, 179, 163, 0.2) !important;
      border-color: rgba(95, 179, 163, 0.5);
    }

    .invite-placeholder:hover .placeholder-icon {
      transform: rotate(90deg);
    }

    .invite-placeholder:active {
      transform: scale(0.98);
    }

    .placeholder-icon {
      font-size: 48px;
      margin-bottom: 8px;
      opacity: 0.5;
    }

    .placeholder-text {
      font-size: 13px;
    }

    /* æ§åˆ¶æŒ‰é’® */
    .controls {
      display: flex;
      justify-content: space-around;
      padding: 16px;
      padding-bottom: calc(16px + env(safe-area-inset-bottom));
      background: rgba(255, 255, 255, 0.95);
      border-radius: 20px 20px 0 0;
      box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
      flex-shrink: 0;
    }

    .control-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 6px;
      cursor: pointer;
      padding: 8px 16px;
      border-radius: 12px;
      transition: all 0.2s;
      min-width: 70px;
    }

    .control-item:active {
      transform: scale(0.95);
      background: rgba(0, 0, 0, 0.05);
    }

    .control-icon-text {
      font-size: 28px;
      line-height: 1;
    }

    .control-label {
      font-size: 12px;
      color: #666;
      font-weight: 400;
    }

    /* å…³é—­çŠ¶æ€æ ·å¼ */
    .control-item.disabled {
      opacity: 0.5;
    }

    .control-item.disabled .control-icon-text {
      color: #999;
    }

    .control-item.disabled .control-label {
      color: #999;
    }

    .control-item-danger:active {
      background: rgba(255, 68, 68, 0.1);
    }

    .control-item-danger .control-icon-text {
      color: #f44;
    }

    .control-item-danger .control-label {
      color: #f44;
    }

    /* åŠ è½½æç¤º */
    .loading {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0, 0, 0, 0.8);
      color: #fff;
      padding: 20px 30px;
      border-radius: 8px;
      font-size: 16px;
      z-index: 2000;
    }

    /* é‚€è¯·å¼¹çª—æ ·å¼ */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.6);
      z-index: 3000;
      justify-content: center;
      align-items: center;
    }

    .modal.show {
      display: flex;
    }

    .modal-content {
      background: #fff;
      border-radius: 16px;
      width: 90%;
      max-width: 450px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      animation: modalSlideIn 0.3s ease;
    }

    @keyframes modalSlideIn {
      from {
        transform: translateY(-50px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px 24px;
      border-bottom: 1px solid #eee;
    }

    .modal-header h3 {
      margin: 0;
      font-size: 18px;
      color: #333;
    }

    .modal-close {
      font-size: 28px;
      color: #999;
      cursor: pointer;
      line-height: 1;
      transition: color 0.3s;
    }

    .modal-close:hover {
      color: #333;
    }

    .modal-body {
      padding: 24px;
    }

    .modal-tip {
      margin: 0 0 12px 0;
      color: #666;
      font-size: 14px;
    }

    .invite-link-box {
      background: #f5f5f5;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 16px;
    }

    .invite-link-input {
      width: 100%;
      border: none;
      background: transparent;
      color: #333;
      font-size: 13px;
      outline: none;
      word-break: break-all;
    }

    .invite-copy-btn {
      width: 100%;
      padding: 14px;
      background: linear-gradient(135deg, #5fb3a3 0%, #4a9d8e 100%);
      color: #fff;
      border: none;
      border-radius: 10px;
      font-size: 16px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s;
      box-shadow: 0 4px 16px rgba(95, 179, 163, 0.3);
    }

    .invite-copy-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(95, 179, 163, 0.4);
    }

    .invite-copy-btn:active {
      transform: translateY(0);
    }

    .modal-hint {
      margin: 16px 0 0 0;
      text-align: center;
      color: #999;
      font-size: 13px;
    }

    /* âœ… é‡è¿æç¤ºæ ·å¼ */
    .reconnect-toast {
      position: fixed;
      top: 80px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.85);
      color: #fff;
      padding: 12px 24px;
      border-radius: 20px;
      font-size: 14px;
      z-index: 10000;
      display: none;
      align-items: center;
      gap: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }

    .reconnect-toast.show {
      display: flex;
    }

    .reconnect-spinner {
      width: 16px;
      height: 16px;
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-top-color: #fff;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* ğŸ” è°ƒè¯•æ—¥å¿—æ˜¾ç¤ºåŒºåŸŸ */
    #debugLog {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      max-height: 40vh;
      background: rgba(0, 0, 0, 0.9);
      color: #0f0;
      font-family: monospace;
      font-size: 11px;
      padding: 10px;
      overflow-y: auto;
      z-index: 99999;
      display: none;
      white-space: pre-wrap;
      word-break: break-all;
    }

    #debugLog.show {
      display: block;
    }

    #debugToggle {
      position: fixed;
      bottom: 20px;
      right: 20px;
      width: 60px;
      height: 60px;
      background: #ff4444;
      color: #fff;
      border: none;
      border-radius: 50%;
      font-size: 12px;
      font-weight: bold;
      z-index: 100000;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      display: none;
    }

    #debugToggle.show {
      display: block;
    }

    /* âœ… é¡µé¢åå°æç¤ºæ ·å¼ */
    .background-toast {
      position: fixed;
      top: 80px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(255, 152, 0, 0.95);
      color: #fff;
      padding: 12px 24px;
      border-radius: 20px;
      font-size: 14px;
      z-index: 10000;
      display: none;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }

    .background-toast.show {
      display: block;
    }

    /* iOS/å¾®ä¿¡ è‡ªåŠ¨æ’­æ”¾é—®é¢˜æµ®å±‚ï¼šå¼•å¯¼ç”¨æˆ·ç‚¹å‡»â€œå¼€å§‹é¢è¯•â€ */
    .play-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.55);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 20000;
    }

    .play-overlay.show {
      display: flex;
    }

    .play-overlay-content {
      background: #fff;
      border-radius: 16px;
      padding: 18px 20px 16px;
      max-width: 280px;
      width: 80%;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.35);
      text-align: center;
      font-size: 14px;
      color: #333;
    }

    .play-overlay-title {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 8px;
    }

    .play-overlay-desc {
      font-size: 13px;
      color: #666;
      margin-bottom: 14px;
      line-height: 1.5;
    }

    .play-overlay-button {
      display: inline-block;
      width: 100%;
      border: none;
      outline: none;
      background: linear-gradient(90deg, #ff9800, #ff7043);
      color: #fff;
      border-radius: 20px;
      padding: 10px 0;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
    }

    .play-overlay-button:active {
      opacity: 0.85;
    }
  </style>
</head>
<body>
  <!-- âœ… é‡è¿æç¤º -->
  <div class="reconnect-toast" id="reconnectToast">
    <div class="reconnect-spinner"></div>
    <span>æ­£åœ¨é‡æ–°è¿æ¥...</span>
  </div>

  <!-- âœ… é¡µé¢åå°æç¤º -->
  <div class="background-toast" id="backgroundToast">
    ğŸ“± é¡µé¢å·²è¿›å…¥åå°
  </div>

  <div class="container">
    <!-- é¡¶éƒ¨ä¿¡æ¯ -->
    <div class="header">
      <div class="header-left">
        <div class="info-item">
          <span class="room-label">æˆ¿é—´å·ï¼š</span>
          <span class="room-value" id="roomIdDisplay">-</span>
        </div>
      </div>
      <div class="header-right">
        <div class="info-item">
          <span class="time-label">é¢è¯•æ—¶é—´ï¼š</span>
          <span class="time-value" id="timer">00:00</span>
        </div>
      </div>
    </div>

    <!-- iOSç”¨æˆ·äº¤äº’æç¤ºå±‚å·²ç§»é™¤ -->
    <!-- å¦‚æœéœ€è¦ç”¨æˆ·äº¤äº’ï¼Œä¼šåœ¨è§†é¢‘æ¡†å†…æ˜¾ç¤º"â–¶ï¸ ç‚¹å‡»æ’­æ”¾è§†é¢‘"æŒ‰é’® -->

    <!-- è§†é¢‘ç½‘æ ¼ - 6ä¸ªä½ç½® -->
    <div class="video-grid">
      <!-- ä½ç½®1ï¼šæœ¬åœ°è§†é¢‘ -->
      <div class="video-item">
        <div class="video-box" id="localBox">
          <video id="localVideo" class="video-player" autoplay muted playsinline webkit-playsinline x5-playsinline x-webkit-airplay="allow" x5-video-player-type="h5" x5-video-player-fullscreen="false"></video>
          <div class="video-label" id="localLabel">æˆ‘</div>
        </div>
      </div>

      <!-- ä½ç½®2ï¼šä¸»æŒäºº -->
      <div class="video-item">
        <div class="video-box" id="remoteBox1">
          <div class="video-placeholder">
            <div class="placeholder-icon">ğŸ‘¤</div>
            <div class="placeholder-text">ç­‰å¾…ä¸»æŒäºº...</div>
          </div>
        </div>
      </div>

      <!-- ä½ç½®3ï¼šå…¶ä»–å‚ä¸è€… -->
      <div class="video-item">
        <div class="video-box" id="remoteBox2">
          <div class="video-placeholder invite-placeholder" onclick="showInviteModal()">
            <div class="placeholder-icon">+</div>
  <!-- iOS / å¾®ä¿¡ è‡ªåŠ¨æ’­æ”¾é—®é¢˜æµ®å±‚ï¼šå¼•å¯¼ç”¨æˆ·ç‚¹å‡»â€œå¼€å§‹é¢è¯•â€ -->
  <div id="playOverlay" class="play-overlay">
    <div class="play-overlay-content">
      <div class="play-overlay-title">å¼€å§‹é¢è¯•</div>
      <div class="play-overlay-desc">
        å·²è¿›å…¥é¢è¯•é—´ï¼Œå¦‚æš‚æ—¶çœ‹ä¸åˆ°å¯¹æ–¹ç”»é¢ï¼Œè¯·ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®å¼€å§‹æ’­æ”¾ã€‚
      </div>
      <button id="startInterviewBtn" class="play-overlay-button">å¼€å§‹é¢è¯•</button>
    </div>
  </div>

            <div class="placeholder-text">é‚€è¯·ç”¨æˆ·</div>
          </div>
        </div>
      </div>

      <!-- ä½ç½®4ï¼šå…¶ä»–å‚ä¸è€… -->
      <div class="video-item">
        <div class="video-box" id="remoteBox3">
          <div class="video-placeholder invite-placeholder" onclick="showInviteModal()">
            <div class="placeholder-icon">+</div>
            <div class="placeholder-text">é‚€è¯·ç”¨æˆ·</div>
          </div>
        </div>
      </div>

      <!-- ä½ç½®5ï¼šå…¶ä»–å‚ä¸è€… -->
      <div class="video-item">
        <div class="video-box" id="remoteBox4">
          <div class="video-placeholder invite-placeholder" onclick="showInviteModal()">
            <div class="placeholder-icon">+</div>
            <div class="placeholder-text">é‚€è¯·ç”¨æˆ·</div>
          </div>
        </div>
      </div>

      <!-- ä½ç½®6ï¼šå…¶ä»–å‚ä¸è€… -->
      <div class="video-item">
        <div class="video-box" id="remoteBox5">
          <div class="video-placeholder invite-placeholder" onclick="showInviteModal()">
            <div class="placeholder-icon">+</div>
            <div class="placeholder-text">é‚€è¯·ç”¨æˆ·</div>
          </div>
        </div>
      </div>
    </div>

    <!-- æ§åˆ¶æŒ‰é’® -->
    <div class="controls">
      <div class="control-item" id="micBtn" onclick="toggleMic()">
        <div class="control-icon-text">ğŸ¤</div>
        <div class="control-label">éº¦å…‹é£</div>
      </div>
      <div class="control-item" id="cameraBtn" onclick="toggleCamera()">
        <div class="control-icon-text">ğŸ“¹</div>
        <div class="control-label">æ‘„åƒå¤´</div>
      </div>
      <div class="control-item" id="flipBtn" onclick="flipCamera()">
        <div class="control-icon-text">ğŸ”„</div>
        <div class="control-label">ç¿»è½¬</div>
      </div>
      <div class="control-item control-item-danger" onclick="leaveRoom()">
        <div class="control-icon-text">ğŸ“</div>
        <div class="control-label">ç¦»å¼€æˆ¿é—´</div>
      </div>
    </div>
  </div>

  <div id="loading" class="loading" style="display: none;">æ­£åœ¨è¿æ¥...</div>

  <!-- ğŸ” è°ƒè¯•å·¥å…· -->
  <button id="debugToggle" onclick="toggleDebugLog()">DEBUG</button>
  <div id="debugLog"></div>

  <!-- é‚€è¯·å¼¹çª— -->
  <div id="inviteModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>é‚€è¯·å…¶ä»–äººåŠ å…¥é¢è¯•</h3>
        <span class="modal-close" onclick="closeInviteModal()">&times;</span>
      </div>
      <div class="modal-body">
        <p class="modal-tip">å¤åˆ¶ä»¥ä¸‹é“¾æ¥å‘é€ç»™å…¶ä»–äººï¼š</p>
        <div class="invite-link-box">
          <input type="text" id="inviteLink" class="invite-link-input" readonly>
        </div>
        <button class="invite-copy-btn" onclick="copyInviteLink()">
          ğŸ“‹ å¤åˆ¶é“¾æ¥å¹¶é‚€è¯·
        </button>
        <p class="modal-hint">ğŸ’¡ å¯¹æ–¹ç‚¹å‡»é“¾æ¥å³å¯åŠ å…¥</p>
      </div>
    </div>
  </div>

  <script>
    // ğŸ” è°ƒè¯•æ¨¡å¼
    const urlParams = new URLSearchParams(window.location.search);
    const debugMode = urlParams.get('debug') === '1';

    // è°ƒè¯•æ—¥å¿—æ•°ç»„
    let debugLogs = [];
    const maxDebugLogs = 100;

    // é‡å†™ console.log ä»¥æ•è·æ—¥å¿—
    const originalConsoleLog = console.log;
    const originalConsoleWarn = console.warn;
    const originalConsoleError = console.error;

    function addDebugLog(type, ...args) {
      const timestamp = new Date().toLocaleTimeString();
      const message = args.map(arg => {
        if (typeof arg === 'object') {
          try {
            return JSON.stringify(arg, null, 2);
          } catch (e) {
            return String(arg);
          }
        }
        return String(arg);
      }).join(' ');

      debugLogs.push(`[${timestamp}] ${type}: ${message}`);
      if (debugLogs.length > maxDebugLogs) {
        debugLogs.shift();
      }

      // æ›´æ–°è°ƒè¯•æ˜¾ç¤º
      if (debugMode) {
        const debugLogEl = document.getElementById('debugLog');
        if (debugLogEl) {
          debugLogEl.textContent = debugLogs.join('\n');
          debugLogEl.scrollTop = debugLogEl.scrollHeight;
        }
      }
    }

    if (debugMode) {
      console.log = function(...args) {
        addDebugLog('LOG', ...args);
        originalConsoleLog.apply(console, args);
      };
      console.warn = function(...args) {
        addDebugLog('WARN', ...args);
        originalConsoleWarn.apply(console, args);
      };
      console.error = function(...args) {
        addDebugLog('ERROR', ...args);
        originalConsoleError.apply(console, args);
      };

      // æ˜¾ç¤ºè°ƒè¯•æŒ‰é’® - ç«‹å³æ‰§è¡Œæˆ–ç­‰å¾… DOM åŠ è½½
      function showDebugButton() {
        const btn = document.getElementById('debugToggle');
        if (btn) {
          btn.classList.add('show');
          console.log('âœ… è°ƒè¯•æ¨¡å¼å·²å¯åŠ¨ï¼');
        } else {
          // å¦‚æœå…ƒç´ è¿˜ä¸å­˜åœ¨ï¼Œç­‰å¾… DOM åŠ è½½
    // iOS/å¾®ä¿¡ è‡ªåŠ¨æ’­æ”¾é—®é¢˜æµ®å±‚æ§åˆ¶
    let playOverlayShown = false;

    // ç”¨äºâ€œè‡ªåŠ¨æ’­æ”¾è¢«æ‹¦æˆªâ€åœºæ™¯ï¼šæ˜¾ç¤ºæµ®å±‚å¹¶æ³¨å†Œè§£é”é€»è¾‘
    function showPlayOverlay() {
      try {
        // ä»…åœ¨ iOS / å¾®ä¿¡ ç¯å¢ƒä¸‹æ˜¾ç¤º
        if (!isIOS() && !isWeChat()) return;

        const overlay = document.getElementById('playOverlay');
        if (!overlay) return;

        if (playOverlayShown) {
          overlay.classList.add('show');
          return;
        }

        playOverlayShown = true;
        overlay.classList.add('show');

        // ç¡®ä¿å·²æ³¨å†Œè‡ªåŠ¨æ’­æ”¾è§£é”é€»è¾‘
        registerAutoPlayUnlock();

        console.log('âœ… å·²æ˜¾ç¤ºâ€œå¼€å§‹é¢è¯•â€æµ®å±‚ï¼ˆè‡ªåŠ¨æ’­æ”¾å…œåº•ï¼‰');
      } catch (e) {
        console.warn('âš ï¸ æ˜¾ç¤ºå¼€å§‹é¢è¯•æµ®å±‚å¤±è´¥:', e);
      }
    }

    // iOS é¦–æ¬¡è¿›å…¥æˆ¿é—´æ—¶ä½¿ç”¨ï¼šåªè´Ÿè´£å±•ç¤ºâ€œå¼€å§‹é¢è¯•â€æµ®å±‚ï¼Œä¸æ³¨å†Œè‡ªåŠ¨æ’­æ”¾è§£é”
    function showStartOverlayForInit() {
      try {
        const overlay = document.getElementById('playOverlay');
        if (!overlay) return;
        overlay.classList.add('show');
        console.log('âœ… iOS é¦–æ¬¡è¿›å…¥ï¼Œæ˜¾ç¤ºâ€œå¼€å§‹é¢è¯•â€æµ®å±‚ç­‰å¾…ç”¨æˆ·ç‚¹å‡»');
      } catch (e) {
        console.warn('âš ï¸ æ˜¾ç¤ºå¼€å§‹é¢è¯•æµ®å±‚å¤±è´¥:', e);
      }
    }

    function hidePlayOverlay() {
      const overlay = document.getElementById('playOverlay');
      if (!overlay) return;
      overlay.classList.remove('show');
    }

    // ç»‘å®šâ€œå¼€å§‹é¢è¯•â€æŒ‰é’®äº‹ä»¶ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
    (function bindStartInterviewButton() {
      const btn = document.getElementById('startInterviewBtn');
      if (!btn) return;
      btn.addEventListener('click', () => {
        console.log('ğŸŸ¢ ç”¨æˆ·ç‚¹å‡»â€œå¼€å§‹é¢è¯•â€æŒ‰é’®');
        hidePlayOverlay();

        // å¦‚æœè¿˜æ²¡æœ‰åˆå§‹åŒ–ï¼Œåˆ™è¿™æ˜¯ç¬¬ä¸€æ¬¡â€œå¼€å§‹é¢è¯•â€ç‚¹å‡» â†’ å¼€å§‹åˆå§‹åŒ–æµç¨‹
        if (!hasInitialized) {
          init();
        }
        // å¦‚æœå·²ç»åˆå§‹åŒ–è¿‡ï¼Œåˆ™è¯´æ˜æ˜¯è‡ªåŠ¨æ’­æ”¾å…œåº•åœºæ™¯ï¼Œå®é™…è§£é”é€»è¾‘åœ¨ registerAutoPlayUnlock æ³¨å†Œçš„å…¨å±€ç‚¹å‡» handler ä¸­å¤„ç†
      });
    })();


          setTimeout(showDebugButton, 100);
        }
      }

      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', showDebugButton);
      } else {
        showDebugButton();
      }
    }

    // åˆ‡æ¢è°ƒè¯•æ—¥å¿—æ˜¾ç¤º
    function toggleDebugLog() {
      const debugLogEl = document.getElementById('debugLog');
      debugLogEl.classList.toggle('show');
    }

    // è·å–URLå‚æ•°
    const roomId = urlParams.get('roomId');
    const userName = urlParams.get('userName') || 'è®¿å®¢';
    const userRole = urlParams.get('role') || 'customer'; // è‹±æ–‡ï¼šcustomer æˆ– helper

    // ç¯å¢ƒæ£€æµ‹ï¼šiOS / å¾®ä¿¡
    function isIOS() {
      const ua = navigator.userAgent;
      // iPhone / iPod / iPad
      if (/iP(hone|od|ad)/i.test(ua)) return true;
      // iPadOS 13+ ä¼ªè£…æˆ Macï¼Œä½†åŒæ—¶æ”¯æŒè§¦æ§
      if (/Macintosh/i.test(ua) && navigator.maxTouchPoints > 1) return true;
      return false;
    }

    function isWeChat() {
      return /MicroMessenger/i.test(navigator.userAgent);
    }

    // ä»… iOS ä¸Šçš„å¾®ä¿¡å†…ç½®æµè§ˆå™¨
    function isWeChatIOS() {
      return isIOS() && isWeChat();
    }

    // ğŸ”“ iOS / å¾®ä¿¡ è‡ªåŠ¨æ’­æ”¾è§£é”å…œåº•ï¼šç”¨æˆ·ä»»æ„ç‚¹å‡»åï¼Œç»Ÿä¸€å°è¯• play æ‰€æœ‰ video
    function registerAutoPlayUnlock() {
      if (autoPlayUnlockRegistered) return;

      // åªåœ¨ iOS æˆ– å¾®ä¿¡ å†…ç½®æµè§ˆå™¨ä¸­å¯ç”¨
      if (!isIOS() && !isWeChat()) {
        return;
      }

      autoPlayUnlockRegistered = true;

      const handler = async () => {
        try {
          console.log('ğŸ”“ ç”¨æˆ·äº¤äº’è§¦å‘ï¼Œå°è¯•è§£é”æ‰€æœ‰è§†é¢‘æ’­æ”¾');
          const videos = document.querySelectorAll('video');
          for (const video of videos) {
            try {
              // è¿œç«¯è§†é¢‘ä¸é™éŸ³ï¼Œæœ¬åœ°é¢„è§ˆä¿æŒ muted
              if (video.id !== 'localVideo') {
                video.muted = false;
                video.volume = 1.0;
              }
              await video.play();
            } catch (e) {
              console.warn('âš ï¸ è§£é”æ’­æ”¾å¤±è´¥:', e);
            }
          }
        } finally {

    // iOS be 	ea H5  db abaffc a WeixinJSBridge e fe	f bb bdbe

    function wechatAutoPlay(videoEl) {
      try {
        if (!isWeChatIOS() || !videoEl) return;

        const tryPlay = () => {
          try {
            // c ube e ae b fe	f bdcf abc b e
e b	ddec fe
dec b
 play
            WeixinJSBridge.invoke('getNetworkType', {}, function () {
              const playPromise = videoEl.play();
              if (playPromise && typeof playPromise.then === 'function') {
                playPromise.catch(err => {
                  console.warn(' e	fff WeixinJSBridge e b	fc video.play()  e
e b:', err);
                });
              }
            });
          } catch (e) {
            console.warn(' e	ff WeixinJSBridge.invoke f
cddc ab ade	b bb bd bbc play:', e);
            try {
              videoEl.play();
            } catch (innerErr) {
              console.warn(' e	ff r d play ad
	e fe b:', innerErr);
            }
          }
        };

        if (typeof WeixinJSBridge !== 'undefined' && WeixinJSBridge.invoke) {
          tryPlay();
        } else {
          document.addEventListener('WeixinJSBridgeReady', tryPlay, false);
          document.addEventListener('onWeixinJSBridgeReady', tryPlay, false);
        }
      } catch (e) {
        console.warn(' e	ff wechatAutoPlay f
cddc abe	f:', e);
      }
    }

          document.removeEventListener('click', handler);
          document.removeEventListener('touchstart', handler);
        }
      };

      document.addEventListener('click', handler);
      document.addEventListener('touchstart', handler);

      console.log('âœ… å·²æ³¨å†Œ iOS/å¾®ä¿¡ è‡ªåŠ¨æ’­æ”¾è§£é”å…œåº•');
    }

    // Helper: auto play video in iOS WeChat WebView via WeixinJSBridge
    function wechatAutoPlayGlobal(videoEl) {
      try {
        if (!isWeChatIOS() || !videoEl) return;

        const tryPlay = function () {
          try {
            WeixinJSBridge.invoke('getNetworkType', {}, function () {
              const playPromise = videoEl.play();
              if (playPromise && typeof playPromise.then === 'function') {
                playPromise.catch(function (err) {
                  console.warn('WeixinJSBridge video.play() failed:', err);
                });
              }
            });
          } catch (e) {
            console.warn('WeixinJSBridge.invoke failed, fallback to plain play:', e);
            try {
              videoEl.play();
            } catch (innerErr) {
              console.warn('Fallback video.play() also failed:', innerErr);
            }
          }
        };

        if (typeof WeixinJSBridge !== 'undefined' && WeixinJSBridge.invoke) {
          tryPlay();
        } else {
          document.addEventListener('WeixinJSBridgeReady', tryPlay, false);
          document.addEventListener('onWeixinJSBridgeReady', tryPlay, false);
        }
      } catch (e) {
        console.warn('wechatAutoPlayGlobal error:', e);
      }
    }



    // ğŸ”’ é˜²æ­¢å¾®ä¿¡åˆ†äº«ç›´æ¥è¿›å…¥æˆ¿é—´ï¼šæ£€æµ‹æ˜¯å¦æ˜¯æ­£å¸¸æµç¨‹è¿›å…¥
    // ä½¿ç”¨ sessionStorage æ ‡è®°æ˜¯å¦ä»é€‰æ‹©èº«ä»½é¡µé¢è·³è½¬è¿‡æ¥
    const fromGuestPage = sessionStorage.getItem('fromGuestPage');

    if (!fromGuestPage) {
      // ä¸æ˜¯ä»é€‰æ‹©èº«ä»½é¡µé¢è·³è½¬è¿‡æ¥çš„ï¼ˆå¯èƒ½æ˜¯å¾®ä¿¡åˆ†äº«çš„é“¾æ¥ï¼‰
      console.log('âš ï¸ æ£€æµ‹åˆ°éæ­£å¸¸æµç¨‹è®¿é—®ï¼Œé‡å®šå‘åˆ°é€‰æ‹©èº«ä»½é¡µé¢');
      // æ¸…é™¤å¯èƒ½å­˜åœ¨çš„æ—§æ ‡è®°
      sessionStorage.removeItem('fromGuestPage');
      // é‡å®šå‘åˆ°é€‰æ‹©èº«ä»½é¡µé¢
      window.location.href = `video-interview-guest.html?roomId=${roomId}`;
      // é˜»æ­¢åç»­ä»£ç æ‰§è¡Œ
      throw new Error('Redirecting to guest page');
    }

    // æ¸…é™¤æ ‡è®°ï¼ˆä¸€æ¬¡æ€§ä½¿ç”¨ï¼‰
    sessionStorage.removeItem('fromGuestPage');

    // è§’è‰²è½¬æ¢ï¼ˆè‹±æ–‡ -> ä¸­æ–‡æ˜¾ç¤ºï¼‰
    const roleDisplayMap = {
      'customer': 'å®¢æˆ·',
      'helper': 'é˜¿å§¨'
    };
    const roleDisplay = roleDisplayMap[userRole] || 'è®¿å®¢';

    // æ ¼å¼åŒ–æˆ¿é—´å·æ˜¾ç¤ºï¼ˆä¸ä¸»æŒäººç«¯ä¿æŒä¸€è‡´ï¼‰
    const displayRoomId = roomId ? roomId.replace(/^room_/, 'AD-').split('_')[0] : '-';

    // æ˜¾ç¤ºä¿¡æ¯
    document.getElementById('roomIdDisplay').textContent = displayRoomId;
    document.getElementById('localLabel').textContent = userName || roleDisplay;

    if (!roomId) {
      alert('æ— æ•ˆçš„æˆ¿é—´å·');
      window.location.href = 'video-interview-guest.html';
    }

    // ZEGOé…ç½®ï¼ˆä¸ä¸»æŒäººç«¯ä¿æŒä¸€è‡´ï¼‰
    const appID = 1279160453;
    const server = 'wss://webliveroom-api.zego.im/ws';
    const serverSecret = 'e18cc600e2939d412c48f152e157f01d';

    let zg = null;
    let localStream = null;
    let currentUserId = ''; // å½“å‰ç”¨æˆ·ID
    let currentStreamId = ''; // å½“å‰æµID
    let isMicOn = true;
    let isCameraOn = true;
    let isFrontCamera = true; // é»˜è®¤å‰ç½®æ‘„åƒå¤´
    let timerInterval = null;
    let startTime = null;
    let remoteControlPolling = null; // è¿œç¨‹æ§åˆ¶è½®è¯¢å®šæ—¶å™¨
    let lastRemoteControlTimestamp = 0; // æœ€åæ¥æ”¶çš„è¿œç¨‹æ§åˆ¶æ¶ˆæ¯æ—¶é—´æˆ³
    let remoteStreamPolling = null; // è¿œç¨‹æµè½®è¯¢å®šæ—¶å™¨ï¼ˆå…œåº•é˜²æ­¢é—æ¼å·²æœ‰è¿œç«¯æµï¼‰
    let autoPlayUnlockRegistered = false; // iOS/å¾®ä¿¡ è‡ªåŠ¨æ’­æ”¾è§£é”æ˜¯å¦å·²æ³¨å†Œ
    let hasInitialized = false; // æ˜¯å¦å·²ç»æ‰§è¡Œè¿‡åˆå§‹åŒ–ï¼ˆç”¨äº iOS â€œå¼€å§‹é¢è¯•â€æµç¨‹ï¼‰


    // ç”ŸæˆTokenï¼ˆè®¿å®¢æ¨¡å¼ï¼šè°ƒç”¨åç«¯å…¬å¼€æ¥å£ï¼‰
    async function generateToken(userID, roomID) {
      try {
        console.log('ğŸ”‘ æ­£åœ¨è·å–è®¿å®¢Token...');
        console.log('ğŸ“± AppID:', appID);
        console.log('ğŸ‘¤ UserID:', userID);
        console.log('ğŸ  RoomID:', roomID);
        console.log('ğŸ‘¨ UserName:', userName);
        console.log('ğŸ­ Role:', userRole);

        // è®¿å®¢æ¨¡å¼ï¼šè°ƒç”¨åç«¯å…¬å¼€æ¥å£ï¼ˆæ— éœ€JWTè®¤è¯ï¼‰
        const requestBody = {
          userId: userID,
          roomId: roomID,
          userName: userName,
          role: userRole,
          expireTime: 7200
        };

        console.log('ğŸ“¤ è¯·æ±‚å‚æ•°:', requestBody);

        const response = await fetch('https://crm.andejiazheng.com/api/zego/generate-guest-token', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(requestBody)
        });

        console.log('ğŸ“¥ å“åº”çŠ¶æ€:', response.status, response.statusText);

        if (!response.ok) {
          const errorText = await response.text();
          console.error('âŒ é”™è¯¯å“åº”:', errorText);

          let errorData;
          try {
            errorData = JSON.parse(errorText);
          } catch (e) {
            throw new Error(`HTTP ${response.status}: ${errorText}`);
          }

          throw new Error(errorData.message || `HTTP error! status: ${response.status}`);
        }

        const result = await response.json();
        console.log('ğŸ“¥ å“åº”æ•°æ®:', result);

        if (result.success && result.data && result.data.token) {
          console.log('âœ… Token è·å–æˆåŠŸ');
          return result.data.token;
        } else {
          throw new Error(result.message || 'è·å–Tokenå¤±è´¥');
        }
      } catch (error) {
        console.error('âŒ Token è·å–å¤±è´¥:', error);
        console.error('âŒ é”™è¯¯è¯¦æƒ…:', error.message);
        throw error;
      }
    }

    // åˆå§‹åŒ–
    async function init() {
      if (hasInitialized) {
        console.log('âš ï¸ åˆå§‹åŒ–å·²æ‰§è¡Œï¼Œå¿½ç•¥é‡å¤è°ƒç”¨');
        return;
      }
      hasInitialized = true;

      showLoading('æ­£åœ¨åˆå§‹åŒ–...');

      try {
        // æ›´æ–°æœ¬åœ°è§†é¢‘æ ‡ç­¾ä¸ºä¸­æ–‡è§’è‰²åç§°
        const localLabel = document.getElementById('localLabel');
        let displayName = userName;
        // å¤„ç†ä¸¤ç§æƒ…å†µï¼š1. "customer-å¼ ä¸‰" 2. "customer"ï¼ˆæ²¡æœ‰å§“åï¼‰
        if (displayName === 'customer') {
          displayName = 'å®¢æˆ·';
        } else if (displayName === 'helper') {
          displayName = 'é˜¿å§¨';
        } else {
          displayName = displayName.replace(/^customer-/, 'å®¢æˆ·-').replace(/^helper-/, 'é˜¿å§¨-');
        }
        localLabel.textContent = displayName;

        // åˆ›å»ºZegoExpressEngineå®ä¾‹
        zg = new ZegoExpressEngine(appID, server);

        // å…³é—­è¯¦ç»†æ—¥å¿—
        zg.setLogConfig({
          logLevel: 'error', // åªæ˜¾ç¤ºé”™è¯¯æ—¥å¿—
          remoteLogLevel: 'disable' // ç¦ç”¨è¿œç¨‹æ—¥å¿—
        });

        console.log('âœ… ZEGO SDK åˆå§‹åŒ–æˆåŠŸ');

        // âš ï¸ é‡è¦ï¼šåœ¨ç™»å½•æˆ¿é—´ä¹‹å‰è®¾ç½®äº‹ä»¶ç›‘å¬
        listenRemoteStream();

        // ç™»å½•æˆ¿é—´
        await loginRoom();

        // åˆ›å»ºæœ¬åœ°æµ
        await createLocalStream();

        hideLoading();
        startTimer();

        // æ³¨å†Œ iOS/å¾®ä¿¡ è‡ªåŠ¨æ’­æ”¾è§£é”å…œåº•ï¼ˆç¡®ä¿ä»»æ„ç‚¹å‡»éƒ½èƒ½å°è¯• play è§†é¢‘ï¼‰
        registerAutoPlayUnlock();

      } catch (error) {
        console.error('âŒ åˆå§‹åŒ–å¤±è´¥:', error);
        hideLoading();
        alert('è¿æ¥å¤±è´¥: ' + (error.message || 'æœªçŸ¥é”™è¯¯'));
        // åˆå§‹åŒ–å¤±è´¥æ—¶å…è®¸ç”¨æˆ·é‡æ–°ç‚¹å‡»â€œå¼€å§‹é¢è¯•â€å†è¯•ä¸€æ¬¡
        hasInitialized = false;
      }
    }

    // ç™»å½•æˆ¿é—´
    async function loginRoom() {
      showLoading('æ­£åœ¨åŠ å…¥æˆ¿é—´...');

      // ç”Ÿæˆç”¨æˆ·IDå¹¶ä¿å­˜ä¸ºå…¨å±€å˜é‡
      currentUserId = 'guest_' + Date.now();

      // è·å–Token
      const token = await generateToken(currentUserId, roomId);

      // ğŸ”¥ğŸ”¥ğŸ”¥ å…³é”®ä¿®å¤ï¼šæ·»åŠ  ZegoRoomConfig å‚æ•°ï¼Œè®¾ç½® userUpdate: true
      // æ ¹æ® ZEGO å®˜æ–¹æ–‡æ¡£ï¼Œè¿™ä¸ªå‚æ•°ç¡®ä¿ï¼š
      // 1. èƒ½æ”¶åˆ° roomUserUpdate å›è°ƒï¼ˆç”¨æˆ·è¿›å‡ºæˆ¿é—´é€šçŸ¥ï¼‰
      // 2. èƒ½æ­£ç¡®è§¦å‘ roomStreamUpdate å›è°ƒï¼ˆåŒ…æ‹¬ç™»å½•æ—¶æˆ¿é—´å†…å·²å­˜åœ¨çš„æµï¼‰
      const result = await zg.loginRoom(roomId, token, {
        userID: currentUserId,
        userName: userName
      }, {
        userUpdate: true  // ğŸ”¥ å…³é”®å‚æ•°ï¼šå¼€å¯ç”¨æˆ·å’Œæµæ›´æ–°é€šçŸ¥
      });

      console.log('âœ… ç™»å½•æˆ¿é—´æˆåŠŸ');
      console.log('âœ… å·²å¼€å¯ç”¨æˆ·å’Œæµæ›´æ–°é€šçŸ¥ (userUpdate: true)');

      // ğŸ”¥ğŸ”¥ğŸ”¥ å¾®ä¿¡æµè§ˆå™¨å…³é”®ä¿®å¤ï¼šç™»å½•æˆ¿é—´åç«‹å³æŸ¥è¯¢å·²å­˜åœ¨çš„æµ
      // åŸå› ï¼šå¾®ä¿¡æµè§ˆå™¨çš„ç”¨æˆ·äº¤äº’çª—å£æœŸéå¸¸çŸ­ï¼ˆ1-2ç§’ï¼‰
      // å¿…é¡»åœ¨ç”¨æˆ·ç‚¹å‡»"åŠ å…¥æˆ¿é—´"æŒ‰é’®åç«‹å³æ’­æ”¾ï¼Œä¸èƒ½ç­‰åˆ°æ¨æµå®Œæˆåå†æ’­æ”¾
      console.log('ğŸ” [å¾®ä¿¡ä¿®å¤] ç™»å½•æˆ¿é—´åç«‹å³æŸ¥è¯¢å·²å­˜åœ¨çš„æµ...');
      try {
        const existingStreams = zg.getRemoteStreams();
        console.log('ğŸ” [å¾®ä¿¡ä¿®å¤] å‘ç°å·²å­˜åœ¨çš„è¿œç¨‹æµæ•°é‡:', existingStreams.length);

        if (existingStreams.length > 0) {
          console.log('ğŸ¬ [å¾®ä¿¡ä¿®å¤] åœ¨ç”¨æˆ·äº¤äº’çª—å£æœŸå†…ç«‹å³æ’­æ”¾å·²å­˜åœ¨çš„æµ');
          for (const stream of existingStreams) {
            console.log('ğŸ“º [å¾®ä¿¡ä¿®å¤] å‡†å¤‡æ’­æ”¾å·²å­˜åœ¨çš„æµ:', stream.streamID, 'ç”¨æˆ·:', stream.user);
            await playRemoteStream(stream);
          }
        }
      } catch (error) {
        console.error('âŒ [å¾®ä¿¡ä¿®å¤] ç«‹å³æŸ¥è¯¢è¿œç¨‹æµå¤±è´¥:', error);
      }
    }

    // ==================== æ£€æŸ¥éº¦å…‹é£æƒé™ ====================
    async function checkMicrophonePermission() {
      try {
        console.log('ğŸ¤ æ£€æŸ¥éº¦å…‹é£æƒé™...');
        // è¯·æ±‚éº¦å…‹é£æƒé™ï¼ˆä¼šè§¦å‘æµè§ˆå™¨æƒé™æç¤ºï¼‰
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        // ç«‹å³åœæ­¢ï¼Œåªæ˜¯ä¸ºäº†è§¦å‘æƒé™è¯·æ±‚
        stream.getTracks().forEach(track => track.stop());
        console.log('âœ… éº¦å…‹é£æƒé™å·²æˆäºˆ');
        return true;
      } catch (error) {
        console.error('âŒ éº¦å…‹é£æƒé™è¢«æ‹’ç»:', error);
        alert('è¯·å…è®¸ä½¿ç”¨éº¦å…‹é£ï¼Œå¦åˆ™æ— æ³•è¿›è¡Œè¯­éŸ³é€šè¯');
        return false;
      }
    }

    // ==================== æ£€æŸ¥éŸ³é¢‘è®¾å¤‡ ====================
    async function checkAudioDevices() {
      try {
        console.log('ğŸ” æ£€æµ‹éŸ³é¢‘è®¾å¤‡...');
        const devices = await zg.enumDevices();
        const microphones = devices.microphones;

        if (microphones.length === 0) {
          console.error('âŒ æœªæ£€æµ‹åˆ°éº¦å…‹é£è®¾å¤‡');
          alert('æœªæ£€æµ‹åˆ°éº¦å…‹é£ï¼Œè¯·æ£€æŸ¥è®¾å¤‡è¿æ¥');
          return false;
        }

        console.log('âœ… å¯ç”¨çš„éº¦å…‹é£:', microphones);
        return true;
      } catch (error) {
        console.error('âŒ æ£€æµ‹éŸ³é¢‘è®¾å¤‡å¤±è´¥:', error);
        return false;
      }
    }

    // åˆ›å»ºæœ¬åœ°æµ
    async function createLocalStream() {
      showLoading('æ­£åœ¨æ‰“å¼€æ‘„åƒå¤´å’Œéº¦å…‹é£...');

      // ğŸ”¥ iOS å¾®ä¿¡æµè§ˆå™¨ä¿®å¤ï¼šæ¢å¤ AudioContext
      // è¿™æ˜¯è§£å†³ iOS å¾®ä¿¡æµè§ˆå™¨éŸ³é¢‘æ’­æ”¾é—®é¢˜çš„å…³é”®æ­¥éª¤
      try {
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        if (AudioContext) {
          const audioContext = new AudioContext();
          if (audioContext.state === 'suspended') {
            await audioContext.resume();
            console.log('âœ… AudioContext å·²æ¢å¤ï¼ŒçŠ¶æ€:', audioContext.state);
          } else {
            console.log('âœ… AudioContext çŠ¶æ€æ­£å¸¸:', audioContext.state);
          }
        }
      } catch (error) {
        console.warn('âš ï¸ AudioContext æ¢å¤å¤±è´¥:', error);
      }

      // âœ… å…³é”®ä¿®å¤ï¼šç›´æ¥åˆ›å»ºæµï¼Œä¸è¦æå‰æ£€æŸ¥æƒé™
      // iOSå¾®ä¿¡ä¸­ï¼Œæå‰è°ƒç”¨getUserMediaå†åœæ­¢ä¼šå¯¼è‡´åç»­æ— æ³•æ­£å¸¸è·å–éŸ³è§†é¢‘
      // è®©ZEGO SDKè‡ªå·±å¤„ç†æƒé™è¯·æ±‚ï¼Œè¿™æ ·æœ€ç¨³å®š

      // âœ… è®¾ç½®è§†é¢‘è´¨é‡ä¸º 720pï¼Œå¹¶é…ç½®éŸ³é¢‘å‚æ•°ï¼ˆæ¢å¤æ—§ç‰ˆæœ¬é…ç½®ï¼‰
      localStream = await zg.createStream({
        camera: {
          video: {
            width: 1280,
            height: 720,
            frameRate: 15,
            bitrate: 1500,
            facingMode: 'user'  // å‰ç½®æ‘„åƒå¤´
          },
          audio: {
            ANS: true,  // è‡ªåŠ¨é™å™ª (Automatic Noise Suppression)
            AGC: true,  // è‡ªåŠ¨å¢ç›Šæ§åˆ¶ (Automatic Gain Control)
            AEC: true   // å›å£°æ¶ˆé™¤ (Acoustic Echo Cancellation)
          }
        }
      });

      console.log('âœ… åˆ›å»ºæœ¬åœ°æµæˆåŠŸ');

      // æ’­æ”¾æœ¬åœ°è§†é¢‘
      const localVideo = document.getElementById('localVideo');
      localVideo.srcObject = localStream;

      // âœ… iOSä¿®å¤ï¼šæ˜¾å¼è°ƒç”¨play()ç¡®ä¿æœ¬åœ°è§†é¢‘æ˜¾ç¤º
      try {
        await localVideo.play();
        console.log('âœ… æœ¬åœ°è§†é¢‘æ’­æ”¾æˆåŠŸ');
      } catch (error) {
        console.error('âŒ æœ¬åœ°è§†é¢‘æ’­æ”¾å¤±è´¥:', error);
      }

      // æ¨æµï¼ˆä½¿ç”¨ä¸userIdå¯¹åº”çš„streamIDï¼‰
      currentStreamId = 'stream_' + currentUserId;
      await zg.startPublishingStream(currentStreamId, localStream);

      console.log('âœ… æœ¬åœ°æµåˆ›å»ºæˆåŠŸ, StreamID:', currentStreamId);

      // ğŸ”¥ğŸ”¥ğŸ”¥ iOS å¾®ä¿¡æµè§ˆå™¨å…³é”®ä¿®å¤ï¼šä¸»åŠ¨è·å–å¹¶æ’­æ”¾æˆ¿é—´å†…å·²å­˜åœ¨çš„è¿œç¨‹æµ
      // è¿™æ˜¯è§£å†³"iOS åè¿›å…¥æˆ¿é—´çœ‹ä¸åˆ°å…¶ä»–äºº"é—®é¢˜çš„æ ¸å¿ƒæ–¹æ¡ˆ
      // åŸå› ï¼šå¾®ä¿¡æµè§ˆå™¨å¯èƒ½æ— æ³•åŠæ—¶è§¦å‘ roomStreamUpdate å›è°ƒé€šçŸ¥å·²æœ‰æµ
      console.log('ğŸ” ä¸»åŠ¨æŸ¥è¯¢æˆ¿é—´å†…å·²å­˜åœ¨çš„è¿œç¨‹æµ...');
      try {
        const existingStreams = zg.getRemoteStreams();
        console.log('ğŸ” å‘ç°å·²å­˜åœ¨çš„è¿œç¨‹æµæ•°é‡:', existingStreams.length);

        if (existingStreams.length > 0) {
          console.log('ğŸ¬ å¼€å§‹æ’­æ”¾å·²å­˜åœ¨çš„è¿œç¨‹æµï¼ˆåœ¨ç”¨æˆ·äº¤äº’çª—å£æœŸå†…ï¼‰');
          for (const stream of existingStreams) {
            console.log('ğŸ“º å‡†å¤‡æ’­æ”¾å·²å­˜åœ¨çš„æµ:', stream.streamID, 'ç”¨æˆ·:', stream.user);
            // ä½¿ç”¨æ’­æ”¾å‡½æ•°
            await playRemoteStream(stream);
          }
        } else {
          console.log('â„¹ï¸ æˆ¿é—´å†…æš‚æ— å…¶ä»–è¿œç¨‹æµ');
        }

        // ğŸ”¥ å»¶è¿Ÿå†æŸ¥è¯¢ä¸€æ¬¡ï¼ˆé˜²æ­¢é—æ¼ï¼‰
        // æœ‰æ—¶å€™ getRemoteStreams() åœ¨åˆšå‘å¸ƒæœ¬åœ°æµæ—¶è¿”å›ç©ºæ•°ç»„
        // å»¶è¿Ÿ 2 ç§’åå†æŸ¥è¯¢ä¸€æ¬¡ï¼Œç¡®ä¿ä¸é—æ¼ä»»ä½•æµ
        setTimeout(async () => {
          console.log('ğŸ” å»¶è¿ŸæŸ¥è¯¢ï¼šå†æ¬¡æ£€æŸ¥æˆ¿é—´å†…çš„è¿œç¨‹æµ...');
          const streams = zg.getRemoteStreams();
          console.log('ğŸ” å»¶è¿ŸæŸ¥è¯¢ï¼šå‘ç°è¿œç¨‹æµæ•°é‡:', streams.length);

          for (const stream of streams) {
            // playRemoteStream å†…éƒ¨ä¼šæ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ï¼Œé¿å…é‡å¤æ’­æ”¾
            await playRemoteStream(stream);
          }
        }, 2000);

      } catch (error) {
        console.error('âŒ ä¸»åŠ¨è·å–è¿œç¨‹æµå¤±è´¥:', error);
      }

      // å¯åŠ¨è¿œç¨‹æ§åˆ¶æ¶ˆæ¯è½®è¯¢
      startRemoteControlPolling();
      // å¯åŠ¨è¿œç¨‹æµè½®è¯¢å…œåº•ï¼Œé˜²æ­¢é—æ¼å·²æœ‰è¿œç«¯æµï¼ˆç‰¹åˆ«æ˜¯ iOS / å¾®ä¿¡ ç¯å¢ƒï¼‰
      startRemoteStreamPolling();
    }

    // ==================== è¿œç¨‹æ§åˆ¶åŠŸèƒ½ ====================
    // å¯åŠ¨è¿œç¨‹æ§åˆ¶æ¶ˆæ¯è½®è¯¢
    function startRemoteControlPolling() {
      // æ¯2ç§’è½®è¯¢ä¸€æ¬¡
      remoteControlPolling = setInterval(async () => {
        try {
          const response = await fetch('/api/zego/get-remote-control', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              roomId: roomId,
              userId: currentUserId,
              lastTimestamp: lastRemoteControlTimestamp
            })
          });

          const result = await response.json();
          if (result.success && result.data && result.data.length > 0) {
            // å¤„ç†è¿œç¨‹æ§åˆ¶æ¶ˆæ¯
            for (const message of result.data) {
              handleRemoteControl(message);
              lastRemoteControlTimestamp = Math.max(lastRemoteControlTimestamp, message.timestamp);
            }
          }
        } catch (error) {
          console.error('âŒ è½®è¯¢è¿œç¨‹æ§åˆ¶æ¶ˆæ¯å¤±è´¥:', error);
        }
      }, 2000);

      console.log('âœ… è¿œç¨‹æ§åˆ¶æ¶ˆæ¯è½®è¯¢å·²å¯åŠ¨');
    }

    // åœæ­¢è¿œç¨‹æ§åˆ¶æ¶ˆæ¯è½®è¯¢
    function stopRemoteControlPolling() {
      if (remoteControlPolling) {
        clearInterval(remoteControlPolling);
        remoteControlPolling = null;
        console.log('âœ… è¿œç¨‹æ§åˆ¶æ¶ˆæ¯è½®è¯¢å·²åœæ­¢');
      }
    }

    // ==================== è¿œç¨‹æµè½®è¯¢ï¼ˆå…œåº•ï¼Œé˜²æ­¢é—æ¼å·²æœ‰è¿œç«¯æµï¼‰ ====================
    function startRemoteStreamPolling() {
      // é¿å…é‡å¤å¯åŠ¨
      if (remoteStreamPolling) return;

      // æ¯3ç§’æ£€æŸ¥ä¸€æ¬¡æˆ¿é—´å†…å·²æœ‰çš„è¿œç¨‹æµï¼Œé˜²æ­¢ iOS / å¾®ä¿¡ ç¯å¢ƒé—æ¼å›è°ƒ
      remoteStreamPolling = setInterval(() => {
        try {
          if (!zg) return;

          const streams = zg.getRemoteStreams() || [];
          console.log('ğŸ” è¿œç¨‹æµè½®è¯¢ï¼šå½“å‰è¿œç¨‹æµæ•°é‡:', streams.length);

          streams.forEach(stream => {
            // ä»…å¯¹å°šæœªæ’­æ”¾çš„æµåšå…œåº•æ’­æ”¾ï¼ŒplayRemoteStream å†…éƒ¨ä¹Ÿä¼šåšå»é‡
            if (!remoteStreams[stream.streamID]) {
              console.log('ğŸ¬ è¿œç¨‹æµè½®è¯¢ï¼šå‘ç°æœªæ’­æ”¾çš„æµï¼Œå°è¯•æ’­æ”¾:', stream.streamID, 'ç”¨æˆ·:', stream.user);
              playRemoteStream(stream);
            }
          });
        } catch (error) {
          console.error('âŒ è¿œç¨‹æµè½®è¯¢å¤±è´¥:', error);
        }
      }, 3000);

      console.log('âœ… è¿œç¨‹æµè½®è¯¢å·²å¯åŠ¨');
    }

    function stopRemoteStreamPolling() {
      if (remoteStreamPolling) {
        clearInterval(remoteStreamPolling);
        remoteStreamPolling = null;
        console.log('âœ… è¿œç¨‹æµè½®è¯¢å·²åœæ­¢');
      }
    }

    // å¤„ç†è¿œç¨‹æ§åˆ¶æ¶ˆæ¯
    function handleRemoteControl(message) {
      console.log('ğŸ“© æ”¶åˆ°è¿œç¨‹æ§åˆ¶æ¶ˆæ¯:', message);

      if (message.controlType === 'camera') {
        // è¿œç¨‹æ§åˆ¶æ‘„åƒå¤´
        if (message.enabled && !isCameraOn) {
          // å¼€å¯æ‘„åƒå¤´
          isCameraOn = true;
          zg.mutePublishStreamVideo(localStream, false);
          updateCameraButton();
          alert('ä¸»æŒäººå·²å¼€å¯æ‚¨çš„æ‘„åƒå¤´');
        } else if (!message.enabled && isCameraOn) {
          // å…³é—­æ‘„åƒå¤´
          isCameraOn = false;
          zg.mutePublishStreamVideo(localStream, true);
          updateCameraButton();
          alert('ä¸»æŒäººå·²å…³é—­æ‚¨çš„æ‘„åƒå¤´');
        }
      } else if (message.controlType === 'microphone') {
        // è¿œç¨‹æ§åˆ¶éº¦å…‹é£
        if (message.enabled && !isMicOn) {
          // å¼€å¯éº¦å…‹é£
          isMicOn = true;
          zg.muteMicrophone(false);
          updateMicButton();
          alert('ä¸»æŒäººå·²å¼€å¯æ‚¨çš„éº¦å…‹é£');
        } else if (!message.enabled && isMicOn) {
          // å…³é—­éº¦å…‹é£
          isMicOn = false;
          zg.muteMicrophone(true);
          updateMicButton();
          alert('ä¸»æŒäººå·²å…³é—­æ‚¨çš„éº¦å…‹é£');
        }
      }
    }

    // æ›´æ–°éº¦å…‹é£æŒ‰é’®çŠ¶æ€
    function updateMicButton() {
      const btn = document.getElementById('micBtn');
      const iconText = btn.querySelector('.control-icon-text');
      const label = btn.querySelector('.control-label');

      if (isMicOn) {
        btn.classList.remove('disabled');
        iconText.textContent = 'ğŸ¤';
        label.textContent = 'éº¦å…‹é£';
      } else {
        btn.classList.add('disabled');
        iconText.textContent = 'ğŸ¤';
        label.textContent = 'å·²é™éŸ³';
      }
    }

    // æ›´æ–°æ‘„åƒå¤´æŒ‰é’®çŠ¶æ€
    function updateCameraButton() {
      const btn = document.getElementById('cameraBtn');
      const iconText = btn.querySelector('.control-icon-text');
      const label = btn.querySelector('.control-label');

      if (isCameraOn) {
        btn.classList.remove('disabled');
        iconText.textContent = 'ğŸ“¹';
        label.textContent = 'æ‘„åƒå¤´';
      } else {
        btn.classList.add('disabled');
        iconText.textContent = 'ğŸ“¹';
        label.textContent = 'å·²å…³é—­';
      }
    }

    // è¿œç¨‹æµç®¡ç†
    const remoteStreams = {}; // å­˜å‚¨è¿œç¨‹æµä¿¡æ¯ { streamID: { boxId, stream, videoElement } }
    const availableBoxes = ['remoteBox1', 'remoteBox2', 'remoteBox3', 'remoteBox4', 'remoteBox5'];

    // ğŸ”¥ æŒ‰ç…§ PC ç«¯çš„æ–¹å¼ï¼šæ‰‹åŠ¨è®¾ç½® srcObjectï¼ˆä¸ä¼  video ç»™ SDKï¼‰
    async function playRemoteStream(stream) {
      // ğŸ”¥ å…³é”®ä¿®å¤ï¼šæ£€æŸ¥æ˜¯å¦å·²ç»åœ¨æ’­æ”¾è¿™ä¸ªæµ
      if (remoteStreams[stream.streamID]) {
        console.log('âš ï¸ æµå·²å­˜åœ¨ï¼Œè·³è¿‡:', stream.streamID);
        return;
      }

      console.log('ğŸ“º å‡†å¤‡æ’­æ”¾æµ:', stream.streamID, 'ç”¨æˆ·:', stream.user);

      // æ‰¾åˆ°ç¬¬ä¸€ä¸ªç©ºä½
      const emptyBoxId = availableBoxes.find(boxId => {
        return !Object.values(remoteStreams).some(s => s.boxId === boxId);
      });

      if (!emptyBoxId) {
        console.warn('âš ï¸ æ²¡æœ‰ç©ºä½äº†');
        return;
      }

      // æ˜¾ç¤ºè¿œç¨‹è§†é¢‘
      const box = document.getElementById(emptyBoxId);
      box.style.display = 'block';

      // è½¬æ¢ç”¨æˆ·åæ˜¾ç¤º
      let displayName = stream.user.userName || 'å‚ä¸è€…';

      // å¦‚æœæ˜¯ä¸»æŒäººï¼ˆHRï¼‰ï¼Œæ˜¾ç¤ºä¸º"ä¸»æŒäºº"
      if (displayName === 'HR') {
        displayName = 'ä¸»æŒäºº';
      } else if (displayName === 'customer') {
        displayName = 'å®¢æˆ·';
      } else if (displayName === 'helper') {
        displayName = 'é˜¿å§¨';
      } else {
        // è½¬æ¢è®¿å®¢è§’è‰²ï¼šcustomer-å¼ ä¸‰ -> å®¢æˆ·-å¼ ä¸‰
        displayName = displayName.replace(/^customer-/, 'å®¢æˆ·-').replace(/^helper-/, 'é˜¿å§¨-');
      }

      // âœ… åˆ›å»ºå”¯ä¸€çš„video ID
      const videoId = `remote-video-${stream.streamID.replace(/[^a-zA-Z0-9]/g, '_')}`;

      // âœ… è¿œç¨‹è§†é¢‘ä¸åº”è¯¥é™éŸ³ï¼åªæœ‰æœ¬åœ°é¢„è§ˆæ‰éœ€è¦é™éŸ³
      // âœ… iOSä¿®å¤ï¼šæ·»åŠ æ‰€æœ‰å¿…è¦çš„å±æ€§ç¡®ä¿è§†é¢‘å’ŒéŸ³é¢‘æ­£å¸¸æ’­æ”¾
      box.innerHTML = `
        <video id="${videoId}" class="video-player" autoplay playsinline webkit-playsinline x5-playsinline x-webkit-airplay="allow" x5-video-player-type="h5" x5-video-player-fullscreen="false"></video>
        <div class="video-label">${displayName}</div>
      `;

      const remoteVideo = document.getElementById(videoId);

      // ğŸ”Š å…³é”®ä¿®å¤ï¼šæ˜¾å¼è®¾ç½®è¿œç¨‹è§†é¢‘éŸ³é‡ä¸ºæœ€å¤§ï¼ˆ1.0ï¼‰
      remoteVideo.volume = 1.0;
      // âœ… ç¡®ä¿ä¸é™éŸ³ï¼ˆè¿™æ˜¯å…³é”®ï¼ï¼‰
      remoteVideo.muted = false;
      console.log('ğŸ”Š è®¾ç½®è¿œç¨‹è§†é¢‘éŸ³é‡ä¸º:', remoteVideo.volume, 'é™éŸ³çŠ¶æ€:', remoteVideo.muted);

      // å®šä¹‰æ’­æ”¾å‡½æ•°ï¼ˆæ”¯æŒè‡ªåŠ¨é‡è¯•ï¼‰
      const playStream = async (retryCount = 0, maxRetries = 3) => {
        try {
          console.log(`ğŸ¬ å°è¯•æ’­æ”¾è¿œç¨‹æµ (ç¬¬${retryCount + 1}æ¬¡):`, stream.streamID);

          // ğŸ”¥ PCç«¯æ–¹å¼ï¼šä¸ä¼  video å…ƒç´ ç»™ SDKï¼Œæ‰‹åŠ¨å¤„ç†æ‰€æœ‰æ­¥éª¤
          const remoteStream = await zg.startPlayingStream(stream.streamID);

          console.log('âœ… SDK è¿”å›è¿œç¨‹æµ:', remoteStream);
          console.log('ğŸ“¹ è¿œç¨‹æµè§†é¢‘è½¨é“æ•°é‡:', remoteStream.getVideoTracks().length);
          console.log('ğŸ¤ è¿œç¨‹æµéŸ³é¢‘è½¨é“æ•°é‡:', remoteStream.getAudioTracks().length);

          // ğŸ”¥ æ‰‹åŠ¨è®¾ç½® srcObjectï¼ˆiOS å…³é”®æ­¥éª¤ï¼‰
          remoteVideo.srcObject = remoteStream;
          console.log('âœ… å·²è®¾ç½® srcObject');

          // ğŸ”¥ iOS å…³é”®ä¿®å¤ï¼šè®¾ç½®éŸ³é¢‘å±æ€§å¹¶æ˜¾å¼è°ƒç”¨ play()
          remoteVideo.muted = false;  // ç¡®ä¿ä¸é™éŸ³
          remoteVideo.volume = 1;     // ç¡®ä¿éŸ³é‡æœ€å¤§
          remoteVideo.playsInline = true;  // iOS å†…è”æ’­æ”¾
          remoteVideo.autoplay = true;     // è‡ªåŠ¨æ’­æ”¾

          console.log('ğŸ”Š Videoå…ƒç´ é…ç½® - éŸ³é‡:', remoteVideo.volume, 'é™éŸ³:', remoteVideo.muted, 'playsInline:', remoteVideo.playsInline);

          // iOS WeChat H5: å°è¯•é€šè¿‡ WeixinJSBridge è§£é”è‡ªåŠ¨æ’­æ”¾
          wechatAutoPlayGlobal(remoteVideo);

          // æ˜¾å¼è°ƒç”¨ play()
          try {
            await remoteVideo.play();
            console.log('âœ… æ˜¾å¼è°ƒç”¨ play() æˆåŠŸ');
          } catch (playError) {
            console.warn('âš ï¸ play() è°ƒç”¨å¤±è´¥:', playError.message);
            // å¦‚æœ play() å¤±è´¥ï¼Œå¯èƒ½éœ€è¦ç”¨æˆ·äº¤äº’
            if (playError.name === 'NotAllowedError') {
              console.log('âš ï¸ éœ€è¦ç”¨æˆ·äº¤äº’æ‰èƒ½æ’­æ”¾');
            }
          }

          // è®°å½•æµä¿¡æ¯
          remoteStreams[stream.streamID] = {
            boxId: emptyBoxId,
            stream: remoteStream,
            videoElement: remoteVideo
          };
          console.log('âœ… è¿œç¨‹è§†é¢‘æ’­æ”¾æˆåŠŸ:', stream.streamID);

          return true;

        } catch (error) {
          console.warn(`âš ï¸ æ’­æ”¾å¤±è´¥ (ç¬¬${retryCount + 1}æ¬¡):`, error.name, error.message);

          // âœ… iOSä¿®å¤ï¼šå¦‚æœæ˜¯è‡ªåŠ¨æ’­æ”¾ç­–ç•¥é—®é¢˜ï¼Œæç¤ºç”¨æˆ·ç‚¹å‡»æ’­æ”¾
          if (error.name === 'NotAllowedError' || error.name === 'NotSupportedError') {
            console.log('âš ï¸ éœ€è¦ç”¨æˆ·äº¤äº’æ‰èƒ½æ’­æ”¾ï¼Œæ˜¾ç¤ºæ’­æ”¾æŒ‰é’®');

            // åŒæ—¶åœ¨ iOS / å¾®ä¿¡ ç¯å¢ƒä¸‹æ˜¾ç¤ºå…¨å±€â€œå¼€å§‹é¢è¯•â€æµ®å±‚
            showPlayOverlay();

            // åˆ›å»ºæ’­æ”¾æŒ‰é’®è¦†ç›–å±‚ï¼ˆè§†é¢‘æ¡†å†…çš„å±€éƒ¨æŒ‰é’®ï¼‰
            const playButton = document.createElement('div');
            playButton.style.cssText = `
              position: absolute;
              top: 50%;
              left: 50%;
              transform: translate(-50%, -50%);
              background: rgba(0, 0, 0, 0.7);
              color: white;
              padding: 15px 30px;
              border-radius: 25px;
              cursor: pointer;
              font-size: 16px;
              z-index: 100;
              display: flex;
              align-items: center;
              gap: 10px;
            `;
            playButton.innerHTML = 'â–¶ï¸ ç‚¹å‡»æ’­æ”¾è§†é¢‘';

            box.style.position = 'relative';
            box.appendChild(playButton);

            // ç‚¹å‡»æ’­æ”¾æŒ‰é’®æ—¶é‡æ–°å°è¯•æ’­æ”¾
            playButton.onclick = async () => {
              try {
                await remoteVideo.play();
                console.log('âœ… ç”¨æˆ·ç‚¹å‡»åè§†é¢‘æ’­æ”¾æˆåŠŸ');
                playButton.remove();
                hidePlayOverlay();
              } catch (e) {
                console.error('âŒ ç”¨æˆ·ç‚¹å‡»åä»ç„¶æ’­æ”¾å¤±è´¥:', e);
                alert('æ’­æ”¾å¤±è´¥ï¼Œè¯·æ£€æŸ¥æµè§ˆå™¨æƒé™è®¾ç½®æˆ–åˆ·æ–°é¡µé¢é‡è¯•');
              }
            };

            return false;

          } else if (retryCount < maxRetries) {
            // âœ… è‡ªåŠ¨é‡è¯•æœºåˆ¶ï¼šå…¶ä»–é”™è¯¯è‡ªåŠ¨é‡è¯•
            console.log(`ğŸ”„ ${(retryCount + 1) * 1000}msåè‡ªåŠ¨é‡è¯•...`);
            await new Promise(resolve => setTimeout(resolve, (retryCount + 1) * 1000));
            return await playStream(retryCount + 1, maxRetries);

          } else {
            console.error('âŒ æ’­æ”¾å¤±è´¥ï¼Œå·²è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°');
            return false;
          }
        }
      };

      // æ‰§è¡Œæ’­æ”¾
      await playStream();
    }

    // ç›‘å¬è¿œç¨‹æµ
    function listenRemoteStream() {
      zg.on('roomStreamUpdate', async (roomID, updateType, streamList) => {
        console.log('ğŸ”” è¿œç¨‹æµæ›´æ–° - RoomID:', roomID);
        console.log('ğŸ”” æ›´æ–°ç±»å‹:', updateType);
        console.log('ğŸ”” æµåˆ—è¡¨æ•°é‡:', streamList.length);
        console.log('ğŸ”” æµè¯¦æƒ…:', streamList);

        if (updateType === 'ADD') {
          // æœ‰æ–°çš„è¿œç¨‹æµåŠ å…¥
          console.log('âœ… æ£€æµ‹åˆ°æ–°æµåŠ å…¥ï¼Œå¼€å§‹æ’­æ”¾...');
          for (const stream of streamList) {
            // ğŸ”¥ ä½¿ç”¨æ’­æ”¾å‡½æ•°
            await playRemoteStream(stream);
          }
        } else if (updateType === 'DELETE') {
          // è¿œç¨‹æµç¦»å¼€
          for (const stream of streamList) {
            const streamInfo = remoteStreams[stream.streamID];
            if (streamInfo) {
              const box = document.getElementById(streamInfo.boxId);
              box.innerHTML = `
                <div class="video-placeholder invite-placeholder" onclick="showInviteModal()">
                  <div class="placeholder-icon">+</div>
                  <div class="placeholder-text">é‚€è¯·ç”¨æˆ·</div>
                </div>
              `;

              delete remoteStreams[stream.streamID];
              console.log('âœ… è¿œç¨‹æµå·²ç¦»å¼€:', stream.streamID);
            }
          }
        }
      });

      // âœ… ç›‘å¬è®¾å¤‡é”™è¯¯ï¼ˆiOSè®¾å¤‡å ç”¨é—®é¢˜ï¼‰
      zg.on('deviceError', (errorCode, deviceName) => {
        console.error('ğŸš¨ è®¾å¤‡é”™è¯¯:', { errorCode, deviceName });

        // 1106011: æ‘„åƒå¤´è¢«å ç”¨
        // 1106012: éº¦å…‹é£è¢«å ç”¨
        if (errorCode === 1106011 || errorCode === 1106012) {
          const deviceType = errorCode === 1106011 ? 'æ‘„åƒå¤´' : 'éº¦å…‹é£';
          alert(`${deviceType}è¢«å…¶ä»–é¡µé¢æˆ–åº”ç”¨å ç”¨ï¼Œè¯·å…³é—­å…¶ä»–é¡µé¢ååˆ·æ–°é‡è¯•`);
          console.error(`âŒ iOSè®¾å¤‡å ç”¨é—®é¢˜: ${deviceType}è¢«å ç”¨ï¼Œéœ€è¦ç”¨æˆ·å…³é—­å…¶ä»–é¡µé¢`);
        }
      });

      // âœ… ç›‘å¬æˆ¿é—´çŠ¶æ€å˜åŒ–ï¼ˆç”¨äºæ£€æµ‹è¢«è¸¢å‡ºã€æˆ¿é—´è§£æ•£å’Œæ–­çº¿é‡è¿ï¼‰
      zg.on('roomStateUpdate', (roomID, state, errorCode, extendedData) => {
        console.log('ğŸ”” æˆ¿é—´çŠ¶æ€å˜åŒ–:', { roomID, state, errorCode, extendedData });

        // state: 'DISCONNECTED' è¡¨ç¤ºæ–­å¼€è¿æ¥
        // errorCode: 3 è¡¨ç¤ºè¢«æœåŠ¡ç«¯å¼ºåˆ¶è¸¢å‡ºï¼ˆåŒ…æ‹¬å•ç‹¬è¸¢å‡ºå’Œæˆ¿é—´è§£æ•£ï¼‰
        if (state === 'DISCONNECTED' && errorCode === 3) {
          console.log('âš ï¸ è¢«æœåŠ¡ç«¯å¼ºåˆ¶æ–­å¼€è¿æ¥');

          // åœæ­¢è®¡æ—¶å™¨å’Œè½®è¯¢
          stopTimer();
          stopRemoteControlPolling();
          stopRemoteStreamPolling();

          // æ¸…ç†æœ¬åœ°æµ
          if (localStream) {
            try {
              zg.destroyStream(localStream);
            } catch (error) {
              console.error('æ¸…ç†æœ¬åœ°æµå¤±è´¥:', error);
            }
          }

          // æ˜¾ç¤ºæç¤ºå¹¶è·³è½¬
          // æ³¨æ„ï¼šæ— æ³•åŒºåˆ†æ˜¯å•ç‹¬è¢«è¸¢å‡ºè¿˜æ˜¯æˆ¿é—´è§£æ•£ï¼Œç»Ÿä¸€æç¤º"é¢è¯•å·²ç»“æŸ"
          alert('é¢è¯•å·²ç»“æŸï¼Œæˆ¿é—´å·²è§£æ•£');
          window.location.href = `video-interview-guest.html?roomId=${roomId}&kicked=true`;
        }
        // âœ… æ–­çº¿é‡è¿æ£€æµ‹
        else if (state === 'DISCONNECTED' && errorCode !== 3) {
          console.log('ğŸ”„ ç½‘ç»œæ–­å¼€ï¼Œç­‰å¾…é‡è¿...');
          showReconnectToast();
        } else if (state === 'CONNECTING') {
          console.log('ğŸ”„ æ­£åœ¨é‡æ–°è¿æ¥...');
          showReconnectToast();
        } else if (state === 'CONNECTED') {
          console.log('âœ… é‡æ–°è¿æ¥æˆåŠŸ');
          hideReconnectToast();
        }
      });
    }

    // âœ… æ˜¾ç¤ºé‡è¿æç¤º
    function showReconnectToast() {
      const toast = document.getElementById('reconnectToast');
      toast.classList.add('show');
    }

    // âœ… éšè—é‡è¿æç¤º
    function hideReconnectToast() {
      const toast = document.getElementById('reconnectToast');
      toast.classList.remove('show');
    }

    // âœ… æ˜¾ç¤ºé¡µé¢åå°æç¤º
    function showBackgroundToast() {
      const toast = document.getElementById('backgroundToast');
      toast.classList.add('show');
    }

    // âœ… éšè—é¡µé¢åå°æç¤º
    function hideBackgroundToast() {
      const toast = document.getElementById('backgroundToast');
      toast.classList.remove('show');
    }

    // âœ… ç›‘å¬é¡µé¢å¯è§æ€§å˜åŒ–ï¼ˆç”µè¯/è¯­éŸ³æ‰“æ–­ï¼‰
    document.addEventListener('visibilitychange', () => {
      if (document.hidden) {
        console.log('ğŸ“± é¡µé¢è¿›å…¥åå°ï¼ˆå¯èƒ½æ¥ç”µè¯/åˆ‡æ¢åº”ç”¨ï¼‰');
        showBackgroundToast();
      } else {
        console.log('ğŸ“± é¡µé¢è¿”å›å‰å°');
        hideBackgroundToast();
        // æ£€æŸ¥è¿æ¥çŠ¶æ€
        console.log('ğŸ” æ£€æŸ¥è¿æ¥çŠ¶æ€...');
      }
    });

    // åˆ‡æ¢éº¦å…‹é£
    function toggleMic() {
      if (!localStream) return;

      isMicOn = !isMicOn;
      zg.muteMicrophone(!isMicOn);

      const btn = document.getElementById('micBtn');
      const iconText = btn.querySelector('.control-icon-text');
      const label = btn.querySelector('.control-label');

      if (isMicOn) {
        btn.classList.remove('disabled');
        iconText.textContent = 'ğŸ¤';
        label.textContent = 'éº¦å…‹é£';
      } else {
        btn.classList.add('disabled');
        iconText.textContent = 'ğŸ¤';
        label.textContent = 'å·²é™éŸ³';
      }
    }

    // åˆ‡æ¢æ‘„åƒå¤´
    function toggleCamera() {
      if (!localStream) return;

      isCameraOn = !isCameraOn;
      zg.mutePublishStreamVideo(localStream, !isCameraOn);

      const btn = document.getElementById('cameraBtn');
      const iconText = btn.querySelector('.control-icon-text');
      const label = btn.querySelector('.control-label');

      if (isCameraOn) {
        btn.classList.remove('disabled');
        iconText.textContent = 'ğŸ“¹';
        label.textContent = 'æ‘„åƒå¤´';
      } else {
        btn.classList.add('disabled');
        iconText.textContent = 'ğŸ“¹';
        label.textContent = 'å·²å…³é—­';
      }
    }

    // ç¿»è½¬é•œå¤´ï¼ˆå‰ç½®/åç½®åˆ‡æ¢ï¼‰
    // âœ… ä½¿ç”¨å³æ„å®˜æ–¹æ¨èçš„æ–¹å¼äºŒï¼šstopCaptureVideo + startCaptureCamera + updatePublishingStream
    async function flipCamera() {
      if (!localStream || !isCameraOn) {
        alert('è¯·å…ˆæ‰“å¼€æ‘„åƒå¤´');
        return;
      }

      try {
        showLoading('æ­£åœ¨åˆ‡æ¢æ‘„åƒå¤´...');
        console.log('ğŸ”„ å¼€å§‹åˆ‡æ¢æ‘„åƒå¤´ï¼Œå½“å‰:', isFrontCamera ? 'å‰ç½®' : 'åç½®');

        // åˆ‡æ¢æ‘„åƒå¤´æ–¹å‘
        isFrontCamera = !isFrontCamera;
        console.log('ğŸ”„ åˆ‡æ¢åˆ°:', isFrontCamera ? 'å‰ç½®' : 'åç½®');

        // âœ… æ­¥éª¤1ï¼šåœæ­¢å½“å‰æ‘„åƒå¤´é‡‡é›†
        console.log('â¸ï¸ åœæ­¢è§†é¢‘é‡‡é›†...');
        await zg.stopCaptureVideo();

        // âœ… æ­¥éª¤2ï¼šé‡æ–°å¼€å§‹é‡‡é›†ï¼ˆæŒ‡å®šå‰ç½®æˆ–åç½®æ‘„åƒå¤´ï¼‰
        console.log('ğŸ“¹ é‡æ–°å¼€å§‹é‡‡é›†...');
        const videoConfig = {
          width: 1280,
          height: 720,
          frameRate: 15,
          bitrate: 1500,
          facingMode: isFrontCamera ? 'user' : 'environment'
        };
        await zg.startCaptureCamera(videoConfig);

        // âœ… æ­¥éª¤3ï¼šæ›´æ–°æ¨æµ
        console.log('ğŸ“¤ æ›´æ–°æ¨æµ...');
        await zg.updatePublishingStream(localStream);
        console.log('âœ… æ¨æµæ›´æ–°æˆåŠŸ');

        hideLoading();
        console.log('âœ… æ‘„åƒå¤´åˆ‡æ¢æˆåŠŸ:', isFrontCamera ? 'å‰ç½®' : 'åç½®');
        alert('æ‘„åƒå¤´å·²åˆ‡æ¢åˆ°' + (isFrontCamera ? 'å‰ç½®' : 'åç½®'));

      } catch (error) {
        console.error('âŒ åˆ‡æ¢æ‘„åƒå¤´å¤±è´¥:', error);
        hideLoading();

        // å°è¯•åˆ‡æ¢å›åŸæ¥çš„æ–¹å‘
        isFrontCamera = !isFrontCamera;
        alert('åˆ‡æ¢æ‘„åƒå¤´å¤±è´¥ï¼Œå¯èƒ½æ‚¨çš„è®¾å¤‡ä¸æ”¯æŒå‰åæ‘„åƒå¤´åˆ‡æ¢');
      }
    }

    // æ˜¾ç¤ºé‚€è¯·å¼¹çª—
    function showInviteModal() {
      const modal = document.getElementById('inviteModal');
      const inviteLink = document.getElementById('inviteLink');

      // ç”Ÿæˆé‚€è¯·é“¾æ¥ï¼ˆè®¿å®¢ç«¯ï¼‰
      const baseUrl = window.location.origin + window.location.pathname.replace('video-interview-guest-room.html', 'video-interview-guest.html');
      const link = `${baseUrl}?roomId=${roomId}`;

      inviteLink.value = link;
      modal.classList.add('show');
    }

    // å…³é—­é‚€è¯·å¼¹çª—
    function closeInviteModal() {
      const modal = document.getElementById('inviteModal');
      modal.classList.remove('show');
    }

    // å¤åˆ¶é‚€è¯·é“¾æ¥
    async function copyInviteLink() {
      const inviteLink = document.getElementById('inviteLink');

      try {
        await navigator.clipboard.writeText(inviteLink.value);

        const btn = event.target;
        const originalText = btn.textContent;
        btn.textContent = 'âœ… é“¾æ¥å·²å¤åˆ¶ï¼';
        btn.style.background = 'linear-gradient(135deg, #4caf50 0%, #45a049 100%)';

        setTimeout(() => {
          btn.textContent = originalText;
          btn.style.background = 'linear-gradient(135deg, #5fb3a3 0%, #4a9d8e 100%)';
          closeInviteModal();
        }, 1500);

      } catch (err) {
        alert('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶é“¾æ¥');
      }
    }

    // ç‚¹å‡»å¼¹çª—å¤–éƒ¨å…³é—­
    document.addEventListener('click', function(e) {
      const modal = document.getElementById('inviteModal');
      if (e.target === modal) {
        closeInviteModal();
      }
    });

    // ç¦»å¼€æˆ¿é—´
    function leaveRoom() {
      if (confirm('ç¡®å®šè¦ç¦»å¼€é¢è¯•å—ï¼Ÿ')) {
        try {
          console.log('ğŸšª å¼€å§‹ç¦»å¼€æˆ¿é—´...');

          // åœæ­¢è®¡æ—¶å™¨å’Œè½®è¯¢
          stopTimer();
          stopRemoteControlPolling();
          stopRemoteStreamPolling();

          // æ¸…ç†æœ¬åœ°æµ
          if (zg && localStream) {
            console.log('ğŸ§¹ æ¸…ç†æœ¬åœ°æµ...');

            // åœæ­¢æ¨æµ
            try {
              zg.stopPublishingStream(localStream.streamID);
              console.log('âœ… å·²åœæ­¢æ¨æµ');
            } catch (error) {
              console.error('åœæ­¢æ¨æµå¤±è´¥:', error);
            }

            // é”€æ¯æœ¬åœ°æµ
            try {
              zg.destroyStream(localStream);
              console.log('âœ… å·²é”€æ¯æœ¬åœ°æµ');
            } catch (error) {
              console.error('é”€æ¯æœ¬åœ°æµå¤±è´¥:', error);
            }

            // é€€å‡ºæˆ¿é—´
            try {
              zg.logoutRoom(roomId);
              console.log('âœ… å·²é€€å‡ºæˆ¿é—´');
            } catch (error) {
              console.error('é€€å‡ºæˆ¿é—´å¤±è´¥:', error);
            }
          }

          console.log('âœ… å·²ç¦»å¼€æˆ¿é—´');

          // âœ… ä¸»åŠ¨ç¦»å¼€ï¼šè·³è½¬åˆ°é€‰æ‹©èº«ä»½é¡µé¢ï¼Œç”¨æˆ·å¯ä»¥é‡æ–°è¿›å…¥
          window.location.href = `video-interview-guest.html?roomId=${roomId}`;
        } catch (error) {
          console.error('âŒ ç¦»å¼€æˆ¿é—´å¤±è´¥:', error.message);
          window.location.href = `video-interview-guest.html?roomId=${roomId}`;
        }
      }
    }

    // è®¡æ—¶å™¨
    function startTimer() {
      startTime = Date.now();
      timerInterval = setInterval(() => {
        const elapsed = Math.floor((Date.now() - startTime) / 1000);
        const minutes = Math.floor(elapsed / 60).toString().padStart(2, '0');
        const seconds = (elapsed % 60).toString().padStart(2, '0');
        document.getElementById('timer').textContent = `${minutes}:${seconds}`;
      }, 1000);
    }

    function stopTimer() {
      if (timerInterval) {
        clearInterval(timerInterval);
        timerInterval = null;
      }
    }

    // åŠ è½½æç¤º
    function showLoading(text) {
      const loading = document.getElementById('loading');
      loading.textContent = text;
      loading.style.display = 'block';
    }

    function hideLoading() {
      document.getElementById('loading').style.display = 'none';
    }

    // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
    // iOS å¾®ä¿¡ï¼šå…ˆå±•ç¤ºâ€œå¼€å§‹é¢è¯•â€æŒ‰é’®ï¼Œç‚¹å‡»åå†æ‰§è¡Œ init()
    // å…¶ä»–ç¯å¢ƒï¼šç›´æ¥è‡ªåŠ¨åˆå§‹åŒ–
    window.addEventListener('load', () => {
      if (isWeChatIOS()) {
        // iOS å¾®ä¿¡ï¼šåªæ˜¾ç¤ºâ€œå¼€å§‹é¢è¯•â€æµ®å±‚ï¼ŒçœŸæ­£çš„åˆå§‹åŒ–åœ¨æŒ‰é’®ç‚¹å‡»æ—¶è§¦å‘
        try {
          showStartOverlayForInit();
        } catch (e) {
          console.warn('âš ï¸ æ˜¾ç¤º iOS å¾®ä¿¡å¼€å§‹é¢è¯•æµ®å±‚å¤±è´¥:', e);
        }
      } else {
        // å…¶ä»–ç¯å¢ƒï¼šä¿æŒåŸæ¥çš„è‡ªåŠ¨åˆå§‹åŒ–é€»è¾‘
        init();
      }
    });

    // é¡µé¢å…³é—­å‰æ¸…ç†
    window.addEventListener('beforeunload', () => {
      if (zg && localStream) {
        zg.destroyStream(localStream);
        zg.logoutRoom(roomId);
      }
    });
  </script>
</body>
</html>

