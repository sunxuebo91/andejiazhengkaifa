<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>è§†é¢‘é¢è¯• - HRä¸»æŒäºº</title>

  <!-- å¾®ä¿¡ç¯å¢ƒæ£€æµ‹å’Œè‡ªåŠ¨è·³è½¬ -->
  <script>
    (function() {
      // æ£€æµ‹æ˜¯å¦åœ¨å¾®ä¿¡ä¸­
      function isWechat() {
        return /MicroMessenger/i.test(navigator.userAgent);
      }

      // æ£€æµ‹æ˜¯å¦åœ¨å°ç¨‹åº WebView ä¸­
      function isInMiniProgram() {
        return window.__wxjs_environment === 'miniprogram';
      }

      // è·å–æˆ¿é—´å·å‚æ•°
      const urlParams = new URLSearchParams(window.location.search);
      const roomId = urlParams.get('room') || '';

      console.log('ğŸ” ç¯å¢ƒæ£€æµ‹:');
      console.log('  - æ˜¯å¦åœ¨å¾®ä¿¡ä¸­:', isWechat());
      console.log('  - æ˜¯å¦åœ¨å°ç¨‹åº WebView ä¸­:', isInMiniProgram());
      console.log('  - æˆ¿é—´å·:', roomId);

      // æ³¨æ„ï¼šè¿™ä¸ª H5 é¡µé¢ç°åœ¨åªç”¨äºæµè§ˆå™¨è®¿é—®
      // å¾®ä¿¡ä¸­çš„è·³è½¬ä½¿ç”¨åŠ å¯† URL Schemeï¼ˆç”±äº‘å‡½æ•°ç”Ÿæˆï¼‰

      if (isInMiniProgram()) {
        console.log('âœ… å·²åœ¨å°ç¨‹åº WebView ä¸­ï¼Œæ­£å¸¸åŠ è½½ H5 é¡µé¢');
      } else if (!isWechat()) {
        console.log('ğŸŒ æµè§ˆå™¨ç¯å¢ƒï¼Œæ­£å¸¸åŠ è½½ H5 é¡µé¢');
      } else if (isWechat() && !isInMiniProgram()) {
        console.log('âš ï¸ å¾®ä¿¡æµè§ˆå™¨ç¯å¢ƒï¼Œä½†ä¸åœ¨å°ç¨‹åºä¸­');
        console.log('ğŸ’¡ æç¤ºï¼šè¯·ä½¿ç”¨å°ç¨‹åºåˆ†äº«çš„åŠ å¯†é“¾æ¥æ‰“å¼€');
      }
    })();
  </script>

  <!-- ä½¿ç”¨æœ¬åœ° ZEGO SDKï¼ˆv3.11.0 ç‹¬ç«‹æ‰“åŒ…ç‰ˆæœ¬ï¼ŒåŒ…å«æ‰€æœ‰ä¾èµ–ï¼‰ -->
  <script src="./ZegoExpressWebRTC-standalone.js"></script>
  <!-- ZEGO Token ç”Ÿæˆåº“ï¼ˆå†…åµŒå®ç°ï¼‰ -->
  <script>
    // Token ç”Ÿæˆå‡½æ•°ï¼ˆå†…åµŒå®ç°ï¼Œé¿å… CDN åŠ è½½é—®é¢˜ï¼‰
    function generateToken04(appId, userId, secret, effectiveTimeInSeconds, payload) {
      if (!payload) {
        payload = '';
      }

      // HMAC-SHA256 å®ç°
      async function hmacSHA256(key, message) {
        const encoder = new TextEncoder();
        // å°† secret ä½œä¸º UTF-8 å­—ç¬¦ä¸²ç¼–ç ï¼ˆä¸æ˜¯åå…­è¿›åˆ¶ï¼‰
        const keyData = encoder.encode(key);
        const messageData = encoder.encode(message);

        const cryptoKey = await crypto.subtle.importKey(
          'raw',
          keyData,
          { name: 'HMAC', hash: 'SHA-256' },
          false,
          ['sign']
        );

        const signature = await crypto.subtle.sign('HMAC', cryptoKey, messageData);
        return new Uint8Array(signature);
      }

      // Base64 ç¼–ç 
      function base64Encode(bytes) {
        let binary = '';
        for (let i = 0; i < bytes.length; i++) {
          binary += String.fromCharCode(bytes[i]);
        }
        return btoa(binary).replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
      }

      // ç”Ÿæˆ Tokenï¼ˆåŒæ­¥åŒ…è£…å¼‚æ­¥å‡½æ•°ï¼‰
      const expire = Math.floor(Date.now() / 1000) + effectiveTimeInSeconds;
      const body = {
        app_id: appId,
        user_id: userId,
        nonce: Math.floor(Math.random() * 2147483647),
        ctime: Math.floor(Date.now() / 1000),
        expire: expire
      };

      if (payload) {
        body.payload = payload;
      }

      const header = { alg: 'HS256', typ: 'JWT' };
      const headerStr = JSON.stringify(header);
      const bodyStr = JSON.stringify(body);

      const encoder = new TextEncoder();
      const headerBase64 = base64Encode(encoder.encode(headerStr));
      const bodyBase64 = base64Encode(encoder.encode(bodyStr));
      const toSign = headerBase64 + '.' + bodyBase64;

      // è¿”å› Promise
      // ä½¿ç”¨ UTF-8 ç¼–ç çš„ secretï¼ˆä¸æ˜¯åå…­è¿›åˆ¶ï¼‰
      return hmacSHA256(secret, toSign).then(signature => {
        const signatureBase64 = base64Encode(signature);
        return '04' + toSign + '.' + signatureBase64;
      });
    }
  </script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica', 'Arial', sans-serif;
      background: linear-gradient(180deg, #5fb3a3 0%, #4a9d8e 100%);
      overflow: hidden;
    }
    
    .container {
      width: 100vw;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* å¤´éƒ¨ä¿¡æ¯æ  */
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 12px;
      background: rgba(255, 255, 255, 0.95);
      border-radius: 8px;
      margin: 8px 8px 0 8px;
      box-shadow: 0 2px 6px rgba(95, 179, 163, 0.1);
      flex-shrink: 0;
    }

    .header-left,
    .header-right {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .room-label,
    .time-label {
      font-size: 12px;
      color: #666;
    }

    .room-value,
    .time-value {
      font-size: 13px;
      color: #333;
      font-weight: 500;
    }
    
    /* è§†é¢‘ç½‘æ ¼ */
    .video-grid {
      flex: 1;
      display: grid;
      grid-template-columns: 1fr 1fr;
      grid-auto-rows: calc((100% - 8px) / 2);
      gap: 8px;
      padding: 8px;
      background: transparent;
      overflow-y: auto;
      overflow-x: hidden;
    }

    /* éšè—æ»šåŠ¨æ¡ */
    .video-grid::-webkit-scrollbar {
      display: none;
    }

    .video-grid {
      -ms-overflow-style: none;  /* IE and Edge */
      scrollbar-width: none;  /* Firefox */
    }

    .video-item {
      position: relative;
      background: #000;
      border-radius: 12px;
      overflow: hidden;
      min-height: 0;
    }

    .video-box {
      width: 100%;
      height: 100%;
      position: relative;
    }

    .video-player {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .video-label {
      position: absolute;
      bottom: 10px;
      left: 10px;
      background: rgba(0, 0, 0, 0.7);
      color: white;
      padding: 5px 10px;
      border-radius: 6px;
      font-size: 12px;
    }

    .video-placeholder {
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: #2a2a2a;
      color: #999;
    }

    /* é‚€è¯·æŒ‰é’®æ ·å¼ */
    .invite-placeholder {
      cursor: pointer;
      transition: all 0.3s ease;
      background: rgba(95, 179, 163, 0.1) !important;
      border: 2px dashed rgba(95, 179, 163, 0.3);
    }

    .invite-placeholder .placeholder-icon {
      color: #5fb3a3;
      font-size: 64px;
      font-weight: 300;
      line-height: 1;
    }

    .invite-placeholder .placeholder-text {
      color: #fff;
    }

    .invite-placeholder:hover {
      background: rgba(95, 179, 163, 0.2) !important;
      border-color: rgba(95, 179, 163, 0.5);
    }

    .invite-placeholder:hover .placeholder-icon {
      transform: rotate(90deg);
    }

    .invite-placeholder:active {
      transform: scale(0.98);
    }

    .placeholder-icon {
      font-size: 48px;
      margin-bottom: 10px;
    }

    .placeholder-text {
      font-size: 14px;
    }

    .empty-video {
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #999;
      font-size: 14px;
    }
    
    /* æ§åˆ¶æŒ‰é’® */
    .controls {
      padding: 10px 6px;
      margin: 10px;
      background: rgba(255, 255, 255, 0.98);
      border-radius: 12px;
      display: flex;
      justify-content: space-around;
      align-items: center;
      box-shadow: 0 -2px 10px rgba(95, 179, 163, 0.15);
    }

    .control-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      padding: 6px;
      border-radius: 6px;
      transition: all 0.3s;
      cursor: pointer;
      flex: 1;
    }

    .control-item:active {
      background: rgba(95, 179, 163, 0.1);
    }

    .control-item-danger:active {
      background: rgba(255, 107, 107, 0.1);
    }

    .control-icon-text {
      font-size: 24px;
      line-height: 1;
    }

    .control-label {
      font-size: 11px;
      color: #666;
    }

    .control-item-danger .control-label {
      color: #ff6b6b;
    }
    
    /* åŠ å…¥é¢è¯•é¢æ¿ */
    .join-panel {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    /* éšè—ç±» */
    .join-panel.hidden {
      display: none !important;
    }
    
    .join-box {
      background: #fff;
      padding: 32px 24px;
      border-radius: 16px;
      width: 85%;
      max-width: 400px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.2);
    }

    .join-box h2 {
      margin-bottom: 12px;
      text-align: center;
      color: #333;
      font-size: 22px;
      font-weight: bold;
    }
    
    .join-box .room-hint {
      text-align: center;
      color: #999;
      font-size: 14px;
      margin-bottom: 20px;
    }

    /* èº«ä»½é€‰æ‹© */
    .role-selector {
      display: flex;
      gap: 12px;
      margin-bottom: 20px;
    }

    .role-option {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
      padding: 16px 12px;
      border: 2px solid #e0e0e0;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s;
      background: #fff;
    }

    .role-option:hover {
      border-color: #5fb3a3;
      background: rgba(95, 179, 163, 0.05);
    }

    .role-option.selected {
      border-color: #5fb3a3;
      background: rgba(95, 179, 163, 0.1);
    }

    .role-icon {
      font-size: 32px;
      line-height: 1;
    }

    .role-text {
      font-size: 14px;
      color: #333;
      font-weight: 500;
    }

    .role-option.selected .role-text {
      color: #5fb3a3;
      font-weight: 600;
    }

    .join-box input {
      width: 100%;
      padding: 14px 16px;
      border: 1px solid #ddd;
      border-radius: 8px;
      margin-bottom: 20px;
      font-size: 15px;
      transition: border-color 0.3s;
    }
    
    .join-box input:focus {
      outline: none;
      border-color: #5fb3a3;
    }

    .join-box button {
      width: 100%;
      padding: 16px;
      background: linear-gradient(135deg, #5fb3a3 0%, #4a9d8e 100%);
      color: #fff;
      border: none;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s;
      box-shadow: 0 4px 16px rgba(95, 179, 163, 0.3);
    }

    .join-box button:active {
      transform: scale(0.98);
    }
    
    /* åŠ è½½æç¤º */
    .loading {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0,0,0,0.8);
      color: #fff;
      padding: 20px 30px;
      border-radius: 8px;
      font-size: 16px;
      z-index: 2000;
    }

    /* é‚€è¯·å¼¹çª—æ ·å¼ */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.6);
      z-index: 3000;
      justify-content: center;
      align-items: center;
    }

    .modal.show {
      display: flex;
    }

    .modal-content {
      background: #fff;
      border-radius: 16px;
      width: 90%;
      max-width: 450px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      animation: modalSlideIn 0.3s ease;
    }

    @keyframes modalSlideIn {
      from {
        transform: translateY(-50px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px 24px;
      border-bottom: 1px solid #eee;
    }

    .modal-header h3 {
      margin: 0;
      font-size: 18px;
      color: #333;
    }

    .modal-close {
      font-size: 28px;
      color: #999;
      cursor: pointer;
      line-height: 1;
      transition: color 0.3s;
    }

    .modal-close:hover {
      color: #333;
    }

    .modal-body {
      padding: 24px;
    }

    .modal-tip {
      margin: 0 0 12px 0;
      color: #666;
      font-size: 14px;
    }

    .invite-link-box {
      background: #f5f5f5;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 16px;
    }

    .invite-link-input {
      width: 100%;
      border: none;
      background: transparent;
      color: #333;
      font-size: 13px;
      outline: none;
      word-break: break-all;
    }

    .invite-copy-btn {
      width: 100%;
      padding: 14px;
      background: linear-gradient(135deg, #5fb3a3 0%, #4a9d8e 100%);
      color: #fff;
      border: none;
      border-radius: 10px;
      font-size: 16px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s;
      box-shadow: 0 4px 16px rgba(95, 179, 163, 0.3);
    }

    .invite-copy-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(95, 179, 163, 0.4);
    }

    .invite-copy-btn:active {
      transform: translateY(0);
    }

    .modal-hint {
      margin: 16px 0 0 0;
      text-align: center;
      color: #999;
      font-size: 13px;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- åˆ›å»ºé¢è¯•é—´é¢æ¿ -->
    <div class="join-panel" id="joinPanel">
      <div class="join-box">
        <h2>ğŸ¥ è§†é¢‘é¢è¯• - HRä¸»æŒäºº</h2>
        <div class="room-hint">ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®åˆ›å»ºé¢è¯•é—´</div>

        <button onclick="createRoom()">åˆ›å»ºé¢è¯•é—´</button>
      </div>
    </div>
    
    <!-- æˆ¿é—´ä¿¡æ¯ -->
    <div class="header">
      <div class="header-left">
        <span class="room-label">æˆ¿é—´å·ï¼š</span>
        <span class="room-value" id="roomId"></span>
      </div>
      <div class="header-right">
        <span class="time-label">é¢è¯•æ—¶é—´ï¼š</span>
        <span class="time-value" id="interviewTime">00:00</span>
      </div>
    </div>
    
    <!-- è§†é¢‘ç½‘æ ¼ -->
    <div class="video-grid" id="videoGrid">
      <!-- æœ¬åœ°è§†é¢‘ -->
      <div class="video-item">
        <div class="video-box">
          <video id="localVideo" class="video-player" autoplay muted playsinline></video>
          <div class="video-label" id="localLabel">ä¸»æŒäºº</div>
        </div>
      </div>

      <!-- è¿œç¨‹è§†é¢‘1 -->
      <div class="video-item">
        <div class="video-box" id="remoteBox1">
          <div class="video-placeholder invite-placeholder" onclick="showInviteModal()">
            <div class="placeholder-icon">+</div>
            <div class="placeholder-text">é‚€è¯·ç”¨æˆ·</div>
          </div>
        </div>
      </div>

      <!-- è¿œç¨‹è§†é¢‘2 -->
      <div class="video-item">
        <div class="video-box" id="remoteBox2">
          <div class="video-placeholder invite-placeholder" onclick="showInviteModal()">
            <div class="placeholder-icon">+</div>
            <div class="placeholder-text">é‚€è¯·ç”¨æˆ·</div>
          </div>
        </div>
      </div>

      <!-- è¿œç¨‹è§†é¢‘3 -->
      <div class="video-item">
        <div class="video-box" id="remoteBox3">
          <div class="video-placeholder invite-placeholder" onclick="showInviteModal()">
            <div class="placeholder-icon">+</div>
            <div class="placeholder-text">é‚€è¯·ç”¨æˆ·</div>
          </div>
        </div>
      </div>

      <!-- è¿œç¨‹è§†é¢‘4 -->
      <div class="video-item">
        <div class="video-box" id="remoteBox4">
          <div class="video-placeholder invite-placeholder" onclick="showInviteModal()">
            <div class="placeholder-icon">+</div>
            <div class="placeholder-text">é‚€è¯·ç”¨æˆ·</div>
          </div>
        </div>
      </div>

      <!-- è¿œç¨‹è§†é¢‘5 -->
      <div class="video-item">
        <div class="video-box" id="remoteBox5">
          <div class="video-placeholder invite-placeholder" onclick="showInviteModal()">
            <div class="placeholder-icon">+</div>
            <div class="placeholder-text">é‚€è¯·ç”¨æˆ·</div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- æ§åˆ¶æŒ‰é’® -->
    <div class="controls">
      <div class="control-item" id="micBtn" onclick="toggleMic()">
        <div class="control-icon-text">ğŸ¤</div>
        <div class="control-label">éº¦å…‹é£</div>
      </div>
      <div class="control-item" id="cameraBtn" onclick="toggleCamera()">
        <div class="control-icon-text">ğŸ“¹</div>
        <div class="control-label">æ‘„åƒå¤´</div>
      </div>
      <div class="control-item control-item-danger" onclick="leaveRoom()">
        <div class="control-icon-text">ğŸ“</div>
        <div class="control-label">ç»“æŸé€šè¯</div>
      </div>
    </div>
  </div>

  <!-- é‚€è¯·å¼¹çª— -->
  <div id="inviteModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>é‚€è¯·å€™é€‰äººåŠ å…¥é¢è¯•</h3>
        <span class="modal-close" onclick="closeInviteModal()">&times;</span>
      </div>
      <div class="modal-body">
        <p class="modal-tip">å¤åˆ¶ä»¥ä¸‹é“¾æ¥å‘é€ç»™å€™é€‰äººï¼š</p>
        <div class="invite-link-box">
          <input type="text" id="inviteLink" class="invite-link-input" readonly>
        </div>
        <button class="invite-copy-btn" onclick="copyInviteLink()">
          ğŸ“‹ å¤åˆ¶é“¾æ¥å¹¶é‚€è¯·
        </button>
        <p class="modal-hint">ğŸ’¡ å€™é€‰äººç‚¹å‡»é“¾æ¥å³å¯åŠ å…¥</p>
      </div>
    </div>
  </div>

  <script>
    // ==================== è„šæœ¬å¼€å§‹æ‰§è¡Œ ====================
    console.log('ğŸš€ video-interview.html è„šæœ¬å¼€å§‹æ‰§è¡Œ');
    console.log('ğŸ“… è„šæœ¬ç‰ˆæœ¬: 2025-11-10 v2.1');
    console.log('ğŸ” ç«‹å³æ£€æµ‹ ZegoExpressEngine:', typeof ZegoExpressEngine);
    console.log('ğŸ” ZegoExpressEngine è¯¦æƒ…:', ZegoExpressEngine);
    console.log('ğŸ” ZegoExpressEngine.ZegoExpressEngine:', typeof ZegoExpressEngine !== 'undefined' && ZegoExpressEngine.ZegoExpressEngine);
    console.log('ğŸ” ç«‹å³æ£€æµ‹ generateToken04:', typeof generateToken04);

    // ==================== å…¨å±€å˜é‡ ====================
    const urlParams = new URLSearchParams(window.location.search);
    let roomId = urlParams.get('room') || ''; // HRç«¯ä¼šè‡ªåŠ¨ç”Ÿæˆæˆ¿é—´å·

    // ZEGO é…ç½®
    const appID = 1279160453;
    const server = 'wss://webliveroom-api.zego.im/ws';
    // ServerSecretï¼ˆUTF-8 æ ¼å¼ï¼Œç”¨äºç”Ÿæˆ Tokenï¼‰
    const serverSecret = 'e18cc600e2939d412c48f152e157f01d';

    let zg = null;
    let localStream = null;
    let remoteStreams = {}; // å­˜å‚¨è¿œç¨‹æµ { streamID: MediaStream }
    let isMicOn = true;
    let isCameraOn = true;
    let currentUserId = '';
    let currentUserName = '';
    let currentUserRole = ''; // ç”¨æˆ·èº«ä»½ï¼šcustomer æˆ– ayi
    let interviewStartTime = null;
    let interviewTimer = null;

    // ==================== è·å– JWT Token ====================
    function getJwtToken() {
      const urlParams = new URLSearchParams(window.location.search);
      const tokenFromUrl = urlParams.get('token');
      if (tokenFromUrl) {
        console.log('âœ… ä» URL è·å–åˆ° JWT Token');
        return tokenFromUrl;
      }
      console.warn('âš ï¸ æœªæ‰¾åˆ° JWT Token');
      return null;
    }

    // ==================== Token ç”Ÿæˆ ====================
    async function generateToken(userID, roomID, userName) {
      try {
        console.log('ğŸ”‘ ä»åç«¯APIè·å– ZEGO Token...');
        console.log('ğŸ“± AppID:', appID);
        console.log('ğŸ‘¤ UserID:', userID);
        console.log('ğŸ  RoomID:', roomID);
        console.log('ğŸ‘¨ UserName:', userName);

        // è·å– JWT Token
        const jwtToken = getJwtToken();
        if (!jwtToken) {
          throw new Error('æœªæ‰¾åˆ° JWT Tokenï¼Œè¯·å…ˆç™»å½•ç³»ç»Ÿ');
        }

        // è°ƒç”¨åç«¯API
        const response = await fetch('https://crm.andejiazheng.com/api/zego/generate-token', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${jwtToken}`,
          },
          body: JSON.stringify({
            userId: userID,
            roomId: roomID,
            userName: userName,
            expireTime: 7200
          })
        });

        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        const result = await response.json();
        console.log('âœ… åç«¯å“åº”:', result);

        if (result.success && result.data && result.data.token) {
          const token = result.data.token;
          console.log('âœ… Token è·å–æˆåŠŸï¼Œé•¿åº¦:', token.length);
          return token;
        } else {
          throw new Error(result.message || 'è·å–Tokenå¤±è´¥');
        }
      } catch (error) {
        console.error('âŒ Token è·å–å¤±è´¥:', error);
        throw error;
      }
    }

    // ==================== èº«ä»½é€‰æ‹© ====================
    function selectRole(role) {
      currentUserRole = role;

      // æ›´æ–°é€‰ä¸­çŠ¶æ€
      document.querySelectorAll('.role-option').forEach(option => {
        option.classList.remove('selected');
      });
      document.querySelector(`.role-option[data-role="${role}"]`).classList.add('selected');

      console.log('é€‰æ‹©èº«ä»½:', role === 'customer' ? 'å®¢æˆ·' : 'é˜¿å§¨');
    }

    // ==================== åˆå§‹åŒ– ZEGO ====================
    function initZego() {
      console.log('åˆå§‹åŒ– ZEGO SDK...');

      // æ£€æŸ¥ ZEGO SDK æ˜¯å¦åŠ è½½
      if (typeof ZegoExpressEngine === 'undefined') {
        console.error('ZEGO SDK æœªåŠ è½½');
        alert('è§†é¢‘SDKåŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
        return false;
      }

      // å°è¯•è·å–æ­£ç¡®çš„æ„é€ å‡½æ•°
      let ZegoEngine = ZegoExpressEngine;
      if (typeof ZegoExpressEngine === 'object' && ZegoExpressEngine.ZegoExpressEngine) {
        console.log('æ£€æµ‹åˆ° ZegoExpressEngine æ˜¯å¯¹è±¡ï¼Œæå–æ„é€ å‡½æ•°');
        ZegoEngine = ZegoExpressEngine.ZegoExpressEngine;
      }

      console.log('ä½¿ç”¨çš„æ„é€ å‡½æ•°ç±»å‹:', typeof ZegoEngine);

      // åˆ›å»º ZEGO å®ä¾‹ï¼Œå¹¶è®¾ç½®æ—¥å¿—çº§åˆ«ä¸º disableï¼ˆå®Œå…¨å…³é—­æ—¥å¿—ï¼‰
      zg = new ZegoEngine(appID, server);
      zg.setLogConfig({
        logLevel: 'disable',  // å®Œå…¨å…³é—­ ZEGO SDK æ—¥å¿—
        remoteLogLevel: 'disable'  // å…³é—­è¿œç¨‹æ—¥å¿—
      });

      console.log('ZEGO SDK åˆå§‹åŒ–æˆåŠŸ');
      
      // ç›‘å¬è¿œç¨‹æµæ›´æ–°
      zg.on('roomStreamUpdate', async (roomID, updateType, streamList) => {
        console.log('ğŸ”” æˆ¿é—´æµæ›´æ–° - RoomID:', roomID);
        console.log('ğŸ”” æ›´æ–°ç±»å‹:', updateType);
        console.log('ğŸ”” æµåˆ—è¡¨æ•°é‡:', streamList.length);
        console.log('ğŸ”” æµè¯¦æƒ…:', streamList);

        if (updateType === 'ADD') {
          // æœ‰æ–°çš„æµåŠ å…¥
          console.log('âœ… æ£€æµ‹åˆ°æ–°æµåŠ å…¥ï¼Œå¼€å§‹æ’­æ”¾...');
          for (const stream of streamList) {
            console.log('ğŸ“º å‡†å¤‡æ’­æ”¾æµ:', stream.streamID, 'ç”¨æˆ·:', stream.user);
            await playRemoteStream(stream);
          }
        } else if (updateType === 'DELETE') {
          // æœ‰æµç¦»å¼€
          console.log('âš ï¸ æ£€æµ‹åˆ°æµç¦»å¼€');
          for (const stream of streamList) {
            console.log('ğŸ“º ç§»é™¤æµ:', stream.streamID);
            removeRemoteStream(stream.streamID);
          }
        }
      });
      
      // ç›‘å¬æˆ¿é—´çŠ¶æ€
      zg.on('roomStateUpdate', (roomID, state, errorCode, extendedData) => {
        console.log('æˆ¿é—´çŠ¶æ€æ›´æ–°:', state, errorCode);
        if (state === 'DISCONNECTED') {
          showMessage('å·²æ–­å¼€è¿æ¥');
        } else if (state === 'CONNECTING') {
          showMessage('æ­£åœ¨è¿æ¥...');
        } else if (state === 'CONNECTED') {
          console.log('å·²è¿æ¥åˆ°æˆ¿é—´');
        }
      });

      return true;
    }

    // ==================== åˆ›å»ºé¢è¯•é—´ ====================
    async function createRoom() {
      console.log('â• åˆ›å»ºé¢è¯•é—´');

      // æ£€æŸ¥ ZEGO SDK æ˜¯å¦å·²åˆå§‹åŒ–
      if (!zg) {
        console.error('ZEGO SDK æœªåˆå§‹åŒ–');
        alert('è§†é¢‘SDKæœªåˆå§‹åŒ–ï¼Œæ­£åœ¨é‡æ–°åˆå§‹åŒ–...');
        const success = initZego();
        if (!success) {
          return;
        }
        // ç­‰å¾…ä¸€ä¸‹è®© SDK å®Œå…¨åˆå§‹åŒ–
        await new Promise(resolve => setTimeout(resolve, 500));
      }

      try {
        showMessage('æ­£åœ¨åˆ›å»ºé¢è¯•é—´...');

        // ç”Ÿæˆæˆ¿é—´å·
        const timestamp = Date.now();
        const randomStr = Math.random().toString(36).substring(2, 8);
        roomId = `room_${timestamp}_${randomStr}`;
        currentUserId = 'user_' + Date.now();
        currentUserName = 'HR';

        console.log('âœ… æˆ¿é—´ä¿¡æ¯:', { roomId: roomId, userId: currentUserId, userName: currentUserName });

        // æ›´æ–°æˆ¿é—´å·æ˜¾ç¤ºï¼ˆæ ¼å¼åŒ–ä¸º AD-æ—¶é—´æˆ³ï¼Œå»æ‰åé¢çš„éšæœºå­—æ¯ï¼‰
        const displayRoomId = roomId.replace(/^room_/, 'AD-').split('_')[0];
        document.getElementById('roomId').textContent = displayRoomId;

        // ç”Ÿæˆ Token
        console.log('â³ æ­£åœ¨ç”Ÿæˆ Token...');
        const token = await generateToken(currentUserId, roomId, currentUserName);
        console.log('âœ… Token:', token ? 'Token å·²ç”Ÿæˆ' : 'ä½¿ç”¨ç©º Token');

        // ç™»å½•æˆ¿é—´
        console.log('â³ æ­£åœ¨ç™»å½•æˆ¿é—´...');
        await zg.loginRoom(roomId, token, {
          userID: currentUserId,
          userName: currentUserName
        });
        console.log('âœ… ç™»å½•æˆ¿é—´æˆåŠŸ');

        // åˆ›å»ºæœ¬åœ°æµ
        console.log('æ­£åœ¨åˆ›å»ºæœ¬åœ°æµ...');
        localStream = await zg.createStream({
          camera: {
            video: true,
            audio: true
          }
        });
        console.log('åˆ›å»ºæœ¬åœ°æµæˆåŠŸ');

        // æ’­æ”¾æœ¬åœ°è§†é¢‘
        const localVideo = document.getElementById('localVideo');
        localVideo.srcObject = localStream;

        // æ›´æ–°æœ¬åœ°æ ‡ç­¾
        document.getElementById('localLabel').textContent = 'ä¸»æŒäºº';

        // æ¨æµ
        const streamID = 'stream_' + currentUserId;
        console.log('æ­£åœ¨æ¨æµ:', streamID);
        await zg.startPublishingStream(streamID, localStream);
        console.log('æ¨æµæˆåŠŸ');

        // éšè—åŠ å…¥é¢æ¿ï¼Œæ˜¾ç¤ºä¸»ç•Œé¢
        document.getElementById('joinPanel').classList.add('hidden');

        // å¼€å§‹è®¡æ—¶
        startTimer();

        hideMessage();
        console.log('âœ… é¢è¯•é—´åˆ›å»ºæˆåŠŸ');
      } catch (error) {
        console.error('âŒ åˆ›å»ºé¢è¯•é—´å¤±è´¥:', error);
        hideMessage();
        alert('åˆ›å»ºé¢è¯•é—´å¤±è´¥: ' + error.message);
      }
    }

    // ==================== åŠ å…¥æˆ¿é—´ ====================
    async function joinRoom() {
      const userName = document.getElementById('userName').value.trim();
      if (!userName) {
        alert('è¯·è¾“å…¥æ‚¨çš„å§“å');
        return;
      }

      if (!currentUserRole) {
        alert('è¯·é€‰æ‹©æ‚¨çš„èº«ä»½');
        return;
      }

      // æ£€æŸ¥ ZEGO SDK æ˜¯å¦å·²åˆå§‹åŒ–
      if (!zg) {
        console.error('ZEGO SDK æœªåˆå§‹åŒ–');
        alert('è§†é¢‘SDKæœªåˆå§‹åŒ–ï¼Œæ­£åœ¨é‡æ–°åˆå§‹åŒ–...');
        const success = initZego();
        if (!success) {
          return;
        }
        // ç­‰å¾…ä¸€ä¸‹è®© SDK å®Œå…¨åˆå§‹åŒ–
        await new Promise(resolve => setTimeout(resolve, 500));
      }

      try {
        showMessage('æ­£åœ¨åŠ å…¥æˆ¿é—´...');

        // ç”Ÿæˆç”¨æˆ·ID
        currentUserId = 'user_' + Date.now();
        currentUserName = userName;

        console.log('âœ… ç”¨æˆ·ä¿¡æ¯:', { userId: currentUserId, userName: currentUserName, roomId: roomId, role: currentUserRole });

        // æ£€æŸ¥æˆ¿é—´å·
        if (!roomId || roomId === 'test_room') {
          throw new Error('æˆ¿é—´å·æ— æ•ˆï¼Œè¯·é€šè¿‡æ­£ç¡®çš„é“¾æ¥è¿›å…¥');
        }

        // ç”Ÿæˆ Token
        console.log('â³ æ­£åœ¨ç”Ÿæˆ Token...');
        const token = await generateToken(currentUserId);
        console.log('âœ… Token:', token ? 'Token å·²ç”Ÿæˆ' : 'ä½¿ç”¨ç©º Token');

        // ç™»å½•æˆ¿é—´
        console.log('â³ æ­£åœ¨ç™»å½•æˆ¿é—´...');
        console.log('â³ ç™»å½•å‚æ•°:', { roomId, token: token ? 'å·²ç”Ÿæˆ' : 'ç©º', userID: currentUserId, userName: currentUserName });

        await zg.loginRoom(roomId, token, {
          userID: currentUserId,
          userName: currentUserName
        });
        console.log('âœ… ç™»å½•æˆ¿é—´æˆåŠŸ');
        
        // åˆ›å»ºæœ¬åœ°æµ
        console.log('æ­£åœ¨åˆ›å»ºæœ¬åœ°æµ...');
        localStream = await zg.createStream({
          camera: { 
            video: true, 
            audio: true 
          }
        });
        console.log('åˆ›å»ºæœ¬åœ°æµæˆåŠŸ');
        
        // æ’­æ”¾æœ¬åœ°è§†é¢‘
        const localVideo = document.getElementById('localVideo');
        localVideo.srcObject = localStream;
        
        // æ›´æ–°æœ¬åœ°æ ‡ç­¾ï¼ˆæ˜¾ç¤ºèº«ä»½ + å§“åï¼‰
        const roleText = currentUserRole === 'customer' ? 'å®¢æˆ·' : 'é˜¿å§¨';
        document.getElementById('localLabel').textContent = `${roleText}ï¼š${userName}`;
        
        // æ¨æµ
        const streamID = 'stream_' + currentUserId;
        console.log('æ­£åœ¨æ¨æµ:', streamID);
        await zg.startPublishingStream(streamID, localStream);
        console.log('æ¨æµæˆåŠŸ');
        
        // éšè—åŠ å…¥é¢æ¿
        document.getElementById('joinPanel').style.display = 'none';
        hideMessage();

        // å¯åŠ¨é¢è¯•è®¡æ—¶å™¨
        startInterviewTimer();

      } catch (error) {
        console.error('âŒ åŠ å…¥æˆ¿é—´å¤±è´¥:', error);
        console.error('âŒ é”™è¯¯è¯¦æƒ…:', {
          message: error.message,
          code: error.code,
          name: error.name,
          stack: error.stack
        });

        let errorMsg = 'åŠ å…¥æˆ¿é—´å¤±è´¥';
        if (error.message) {
          errorMsg += ': ' + error.message;
        } else if (error.code) {
          errorMsg += ': é”™è¯¯ä»£ç  ' + error.code;
        } else {
          errorMsg += ': ' + JSON.stringify(error);
        }

        alert(errorMsg);
        hideMessage();
      }
    }

    // ==================== æ’­æ”¾è¿œç¨‹æµ ====================
    async function playRemoteStream(stream) {
      console.log('â–¶ï¸ æ’­æ”¾è¿œç¨‹æµ:', stream);

      try {
        const remoteStream = await zg.startPlayingStream(stream.streamID);
        remoteStreams[stream.streamID] = remoteStream;

        // æ‰¾åˆ°ç©ºé—²çš„è§†é¢‘ä½ç½®ï¼ˆæœ€å¤š5ä¸ªè¿œç¨‹ç”¨æˆ·ï¼‰
        for (let i = 1; i <= 5; i++) {
          const box = document.getElementById(`remoteBox${i}`);
          if (box.querySelector('.video-placeholder')) {
            // è¿™ä¸ªä½ç½®æ˜¯ç©ºçš„ï¼Œä½¿ç”¨å®ƒ
            box.innerHTML = `
              <video id="remote${i}" class="video-player" autoplay playsinline></video>
              <div class="video-label">${stream.user.userName || 'è®¿å®¢'}</div>
            `;
            const video = document.getElementById(`remote${i}`);
            video.srcObject = remoteStream;

            // ä¿å­˜streamIDåˆ°boxçš„dataå±æ€§ï¼Œæ–¹ä¾¿åç»­æŸ¥æ‰¾
            box.setAttribute('data-stream-id', stream.streamID);
            break;
          }
        }

        console.log('âœ… è¿œç¨‹æµæ’­æ”¾æˆåŠŸ');
      } catch (error) {
        console.error('âŒ æ’­æ”¾è¿œç¨‹æµå¤±è´¥:', error);
      }
    }

    // ==================== ç§»é™¤è¿œç¨‹æµ ====================
    function removeRemoteStream(streamID) {
      console.log('ğŸ—‘ï¸ ç§»é™¤è¿œç¨‹æµ:', streamID);

      if (remoteStreams[streamID]) {
        zg.stopPlayingStream(streamID);
        delete remoteStreams[streamID];
      }

      // æ¢å¤å ä½ç¬¦
      for (let i = 1; i <= 5; i++) {
        const box = document.getElementById(`remoteBox${i}`);
        if (box.getAttribute('data-stream-id') === streamID) {
          box.removeAttribute('data-stream-id');
          box.innerHTML = `
            <div class="video-placeholder invite-placeholder" onclick="showInviteModal()">
              <div class="placeholder-icon">+</div>
              <div class="placeholder-text">é‚€è¯·ç”¨æˆ·</div>
            </div>
          `;
          break;
        }
      }
    }

    // ==================== é¢è¯•è®¡æ—¶å™¨ ====================
    function startInterviewTimer() {
      interviewStartTime = Date.now();
      interviewTimer = setInterval(() => {
        const elapsed = Math.floor((Date.now() - interviewStartTime) / 1000);
        const minutes = Math.floor(elapsed / 60);
        const seconds = elapsed % 60;
        const timeStr = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        document.getElementById('interviewTime').textContent = timeStr;
      }, 1000);
    }

    function stopInterviewTimer() {
      if (interviewTimer) {
        clearInterval(interviewTimer);
        interviewTimer = null;
      }
    }
    
    // ==================== æ§åˆ¶åŠŸèƒ½ ====================
    function toggleMic() {
      if (!localStream) return;

      isMicOn = !isMicOn;
      zg.muteMicrophone(!isMicOn);

      const btn = document.getElementById('micBtn');
      const iconText = btn.querySelector('.control-icon-text');
      iconText.textContent = isMicOn ? 'ğŸ¤' : 'ğŸ”‡';

      console.log('éº¦å…‹é£:', isMicOn ? 'å¼€å¯' : 'å…³é—­');
    }

    function toggleCamera() {
      if (!localStream) return;

      isCameraOn = !isCameraOn;
      zg.mutePublishStreamVideo(localStream, !isCameraOn);

      const btn = document.getElementById('cameraBtn');
      const iconText = btn.querySelector('.control-icon-text');
      iconText.textContent = isCameraOn ? 'ğŸ“¹' : 'ğŸ“·';

      console.log('æ‘„åƒå¤´:', isCameraOn ? 'å¼€å¯' : 'å…³é—­');
    }
    
    // æ˜¾ç¤ºé‚€è¯·å¼¹çª—
    function showInviteModal() {
      const modal = document.getElementById('inviteModal');
      const inviteLinkInput = document.getElementById('inviteLink');

      // ç”Ÿæˆé‚€è¯·é“¾æ¥
      const baseUrl = window.location.origin + window.location.pathname.replace('video-interview-host.html', '');
      const inviteLink = `${baseUrl}video-interview-guest.html?roomId=${roomId}`;

      inviteLinkInput.value = inviteLink;
      modal.classList.add('show');
    }

    // å…³é—­é‚€è¯·å¼¹çª—
    function closeInviteModal() {
      const modal = document.getElementById('inviteModal');
      modal.classList.remove('show');
    }

    // å¤åˆ¶é‚€è¯·é“¾æ¥
    function copyInviteLink() {
      const inviteLinkInput = document.getElementById('inviteLink');

      // é€‰ä¸­å¹¶å¤åˆ¶
      inviteLinkInput.select();
      inviteLinkInput.setSelectionRange(0, 99999); // ç§»åŠ¨ç«¯å…¼å®¹

      try {
        document.execCommand('copy');

        // ä¿®æ”¹æŒ‰é’®æ–‡å­—æç¤º
        const btn = event.target;
        const originalText = btn.textContent;
        btn.textContent = 'âœ… é“¾æ¥å·²å¤åˆ¶ï¼';
        btn.style.background = 'linear-gradient(135deg, #4caf50 0%, #45a049 100%)';

        setTimeout(() => {
          btn.textContent = originalText;
          btn.style.background = 'linear-gradient(135deg, #5fb3a3 0%, #4a9d8e 100%)';
          closeInviteModal();
        }, 1500);

      } catch (err) {
        alert('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶é“¾æ¥');
      }
    }

    // ç‚¹å‡»å¼¹çª—å¤–éƒ¨å…³é—­
    document.addEventListener('click', function(e) {
      const modal = document.getElementById('inviteModal');
      if (e.target === modal) {
        closeInviteModal();
      }
    });

    function leaveRoom() {
      if (confirm('ç¡®å®šè¦ç¦»å¼€é¢è¯•é—´å—ï¼Ÿ')) {
        try {
          // åœæ­¢è®¡æ—¶å™¨
          stopTimer();

          if (zg && localStream) {
            zg.destroyStream(localStream);
            zg.logoutRoom(roomId);
          }

          // å°è¯•é€šçŸ¥å°ç¨‹åºå…³é—­
          if (typeof wx !== 'undefined' && wx.miniProgram) {
            wx.miniProgram.navigateBack();
          } else {
            // å¦‚æœä¸åœ¨å°ç¨‹åºä¸­ï¼Œæ˜¾ç¤ºæç¤º
            alert('å·²ç¦»å¼€é¢è¯•é—´');
            location.reload();
          }
        } catch (error) {
          console.error('ç¦»å¼€æˆ¿é—´å¤±è´¥:', error);
        }
      }
    }
    
    // ==================== å·¥å…·å‡½æ•° ====================
    function showMessage(msg) {
      let loading = document.getElementById('loading');
      if (!loading) {
        loading = document.createElement('div');
        loading.id = 'loading';
        loading.className = 'loading';
        document.body.appendChild(loading);
      }
      loading.textContent = msg;
      loading.style.display = 'block';
    }
    
    function hideMessage() {
      const loading = document.getElementById('loading');
      if (loading) {
        loading.style.display = 'none';
      }
    }

    // ==================== è®¡æ—¶å™¨å‡½æ•° ====================
    function startTimer() {
      if (interviewTimer) {
        clearInterval(interviewTimer);
      }
      interviewStartTime = Date.now();
      interviewTimer = setInterval(updateTimer, 1000);
      updateTimer(); // ç«‹å³æ›´æ–°ä¸€æ¬¡
    }

    function stopTimer() {
      if (interviewTimer) {
        clearInterval(interviewTimer);
        interviewTimer = null;
      }
    }

    function updateTimer() {
      if (!interviewStartTime) return;

      const elapsed = Math.floor((Date.now() - interviewStartTime) / 1000);
      const minutes = Math.floor(elapsed / 60);
      const seconds = elapsed % 60;

      const timeStr = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
      const timeElement = document.getElementById('interviewTime');
      if (timeElement) {
        timeElement.textContent = timeStr;
      }
    }
    
    // ==================== ç­‰å¾… SDK åŠ è½½ ====================
    function waitForSDK(maxRetries = 20, interval = 200) {
      return new Promise((resolve, reject) => {
        let retries = 0;

        const checkSDK = () => {
          console.log(`ğŸ”„ æ£€æŸ¥ SDK åŠ è½½çŠ¶æ€ (${retries + 1}/${maxRetries})...`);

          if (typeof ZegoExpressEngine !== 'undefined') {
            console.log('âœ… ZEGO SDK åŠ è½½æˆåŠŸï¼');
            resolve(true);
          } else if (retries >= maxRetries) {
            console.error('âŒ ZEGO SDK åŠ è½½è¶…æ—¶ï¼');
            reject(new Error('SDK åŠ è½½è¶…æ—¶'));
          } else {
            retries++;
            setTimeout(checkSDK, interval);
          }
        };

        checkSDK();
      });
    }

    // ==================== é¡µé¢åŠ è½½ ====================
    window.onload = async function() {
      console.log('é¡µé¢åŠ è½½å®Œæˆ');
      console.log('æˆ¿é—´å·:', roomId);

      // æ£€æŸ¥ SDK åŠ è½½çŠ¶æ€
      console.log('æ£€æŸ¥ ZEGO SDK åŠ è½½çŠ¶æ€...');
      console.log('ZegoExpressEngine æ˜¯å¦å­˜åœ¨:', typeof ZegoExpressEngine !== 'undefined');
      console.log('generateToken04 æ˜¯å¦å­˜åœ¨:', typeof generateToken04 !== 'undefined');

      if (typeof generateToken04 === 'undefined') {
        console.warn('âš ï¸ Token ç”Ÿæˆåº“æœªåŠ è½½');
      } else {
        console.log('âœ… Token ç”Ÿæˆåº“åŠ è½½æˆåŠŸ');
      }

      // ç­‰å¾… SDK åŠ è½½
      if (typeof ZegoExpressEngine === 'undefined') {
        console.log('â³ ZEGO SDK å°šæœªåŠ è½½ï¼Œç­‰å¾…ä¸­...');
        try {
          await waitForSDK();
        } catch (error) {
          console.error('âŒ ZEGO SDK åŠ è½½å¤±è´¥:', error);
          alert('è§†é¢‘SDKåŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥ååˆ·æ–°é¡µé¢é‡è¯•');
          return;
        }
      } else {
        console.log('âœ… ZEGO SDK å·²åŠ è½½');
      }

      initZego();
    };
    
    // é¡µé¢å¸è½½æ—¶æ¸…ç†
    window.onbeforeunload = function() {
      if (zg && localStream) {
        zg.destroyStream(localStream);
        zg.logoutRoom(roomId);
      }
    };
  </script>
</body>
</html>

