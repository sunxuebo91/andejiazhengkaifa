<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>è§†é¢‘é¢è¯• - ä¸»æŒäºº</title>

  <!-- ğŸ”¥ é¡µé¢è®¿é—®æ—¥å¿—è®°å½•å™¨ï¼ˆæœ€å…ˆåŠ è½½ï¼‰ -->
  <script src="page-access-logger.js"></script>

  <!-- å¾®ä¿¡ç¯å¢ƒæ£€æµ‹å’Œè‡ªåŠ¨è·³è½¬ -->
  <script>
    // ğŸ¯ å…¨å±€ç¯å¢ƒæ£€æµ‹å˜é‡ï¼ˆä¾›åç»­ä½¿ç”¨ï¼‰
    var IS_IN_MINIPROGRAM = false;
    var IS_WECHAT = false;

    (function() {
      // æ£€æµ‹æ˜¯å¦åœ¨å¾®ä¿¡ä¸­
      function isWechat() {
        return /MicroMessenger/i.test(navigator.userAgent);
      }

      // æ£€æµ‹æ˜¯å¦åœ¨å°ç¨‹åº WebView ä¸­ï¼ˆå¾®ä¿¡å®˜æ–¹æ¨èæ–¹æ³•ï¼‰
      function isInMiniProgram() {
        // æ–¹æ³•1ï¼šé€šè¿‡ window.__wxjs_environment åˆ¤æ–­ï¼ˆæœ€å¯é ï¼‰
        if (window.__wxjs_environment === 'miniprogram') {
          return true;
        }

        // æ–¹æ³•2ï¼šé€šè¿‡ userAgent åˆ¤æ–­ï¼ˆå¾®ä¿¡ 7.0.0+ æ”¯æŒï¼‰
        if (/miniProgram/i.test(navigator.userAgent)) {
          return true;
        }

        return false;
      }

      // è®¾ç½®å…¨å±€å˜é‡
      IS_WECHAT = isWechat();
      IS_IN_MINIPROGRAM = isInMiniProgram();

      // è·å–æˆ¿é—´å·å‚æ•°
      const urlParams = new URLSearchParams(window.location.search);
      const roomId = urlParams.get('room') || '';

      console.log('ğŸ” ç¯å¢ƒæ£€æµ‹:');
      console.log('  - æ˜¯å¦åœ¨å¾®ä¿¡ä¸­:', IS_WECHAT);
      console.log('  - æ˜¯å¦åœ¨å°ç¨‹åº WebView ä¸­:', IS_IN_MINIPROGRAM);
      console.log('  - UserAgent:', navigator.userAgent);
      console.log('  - __wxjs_environment:', window.__wxjs_environment);
      console.log('  - æˆ¿é—´å·:', roomId);

      // æ³¨æ„ï¼šè¿™ä¸ª H5 é¡µé¢ç°åœ¨åªç”¨äºæµè§ˆå™¨è®¿é—®
      // å¾®ä¿¡ä¸­çš„è·³è½¬ä½¿ç”¨åŠ å¯† URL Schemeï¼ˆç”±äº‘å‡½æ•°ç”Ÿæˆï¼‰

      if (IS_IN_MINIPROGRAM) {
        console.log('âœ… å·²åœ¨å°ç¨‹åº WebView ä¸­ï¼Œæ­£å¸¸åŠ è½½ H5 é¡µé¢');
        console.log('ğŸ’¡ é‚€è¯·åŠŸèƒ½å°†è¢«éšè—ï¼ˆå°ç¨‹åºç¯å¢ƒä½¿ç”¨åˆ†äº«åŠŸèƒ½ï¼‰');
      } else if (!IS_WECHAT) {
        console.log('ğŸŒ æµè§ˆå™¨ç¯å¢ƒï¼Œæ­£å¸¸åŠ è½½ H5 é¡µé¢');
      } else if (IS_WECHAT && !IS_IN_MINIPROGRAM) {
        console.log('âš ï¸ å¾®ä¿¡æµè§ˆå™¨ç¯å¢ƒï¼Œä½†ä¸åœ¨å°ç¨‹åºä¸­');
        console.log('ğŸ’¡ æç¤ºï¼šè¯·ä½¿ç”¨å°ç¨‹åºåˆ†äº«çš„åŠ å¯†é“¾æ¥æ‰“å¼€');
      }
    })();


  </script>

  <!-- ä½¿ç”¨æœ¬åœ° ZEGO SDKï¼ˆv3.11.0 ç‹¬ç«‹æ‰“åŒ…ç‰ˆæœ¬ï¼ŒåŒ…å«æ‰€æœ‰ä¾èµ–ï¼‰ -->
  <script src="./ZegoExpressWebRTC-standalone.js"></script>

  <!-- ZEGO Token ç”Ÿæˆåº“ï¼ˆå†…åµŒå®ç°ï¼‰ -->
  <script>
    // Token ç”Ÿæˆå‡½æ•°ï¼ˆå†…åµŒå®ç°ï¼Œé¿å… CDN åŠ è½½é—®é¢˜ï¼‰
    function generateToken04(appId, userId, secret, effectiveTimeInSeconds, payload) {
      if (!payload) {
        payload = '';
      }

      // HMAC-SHA256 å®ç°
      async function hmacSHA256(key, message) {
        const encoder = new TextEncoder();
        // å°† secret ä½œä¸º UTF-8 å­—ç¬¦ä¸²ç¼–ç ï¼ˆä¸æ˜¯åå…­è¿›åˆ¶ï¼‰
        const keyData = encoder.encode(key);
        const messageData = encoder.encode(message);

        const cryptoKey = await crypto.subtle.importKey(
          'raw',
          keyData,
          { name: 'HMAC', hash: 'SHA-256' },
          false,
          ['sign']
        );

        const signature = await crypto.subtle.sign('HMAC', cryptoKey, messageData);
        return new Uint8Array(signature);
      }

      // Base64 ç¼–ç 
      function base64Encode(bytes) {
        let binary = '';
        for (let i = 0; i < bytes.length; i++) {
          binary += String.fromCharCode(bytes[i]);
        }
        return btoa(binary).replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
      }

      // ç”Ÿæˆ Tokenï¼ˆåŒæ­¥åŒ…è£…å¼‚æ­¥å‡½æ•°ï¼‰
      const expire = Math.floor(Date.now() / 1000) + effectiveTimeInSeconds;
      const body = {
        app_id: appId,
        user_id: userId,
        nonce: Math.floor(Math.random() * 2147483647),
        ctime: Math.floor(Date.now() / 1000),
        expire: expire
      };

      if (payload) {
        body.payload = payload;
      }

      const header = { alg: 'HS256', typ: 'JWT' };
      const headerStr = JSON.stringify(header);
      const bodyStr = JSON.stringify(body);

      const encoder = new TextEncoder();
      const headerBase64 = base64Encode(encoder.encode(headerStr));
      const bodyBase64 = base64Encode(encoder.encode(bodyStr));
      const toSign = headerBase64 + '.' + bodyBase64;

      // è¿”å› Promise
      // ä½¿ç”¨ UTF-8 ç¼–ç çš„ secretï¼ˆä¸æ˜¯åå…­è¿›åˆ¶ï¼‰
      return hmacSHA256(secret, toSign).then(signature => {
        const signatureBase64 = base64Encode(signature);
        return '04' + toSign + '.' + signatureBase64;
      });
    }
  </script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica', 'Arial', sans-serif;
      background: linear-gradient(180deg, #5fb3a3 0%, #4a9d8e 100%);
      overflow: hidden;
    }
    
    .container {
      width: 100vw;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* å¤´éƒ¨ä¿¡æ¯æ  */
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 12px;
      background: rgba(255, 255, 255, 0.95);
      border-radius: 8px;
      margin: 8px 8px 0 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15), 0 2px 4px rgba(0, 0, 0, 0.1);
      flex-shrink: 0;
    }

    .header-left,
    .header-right {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .room-label,
    .time-label {
      font-size: 12px;
      color: #666;
    }

    .room-value,
    .time-value {
      font-size: 13px;
      color: #333;
      font-weight: 500;
    }
    
    /* è§†é¢‘ç½‘æ ¼ */
    .video-grid {
      flex: 1;
      display: grid;
      grid-template-columns: 1fr 1fr;
      grid-auto-rows: calc((100% - 8px) / 2);
      gap: 8px;
      padding: 8px;
      background: transparent;
      overflow-y: auto;
      overflow-x: hidden;
    }

    /* éšè—æ»šåŠ¨æ¡ */
    .video-grid::-webkit-scrollbar {
      display: none;
    }

    .video-grid {
      -ms-overflow-style: none;  /* IE and Edge */
      scrollbar-width: none;  /* Firefox */
    }

    .video-item {
      position: relative;
      background: #000;
      border-radius: 12px;
      overflow: hidden;
      min-height: 0;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3), 0 4px 8px rgba(0, 0, 0, 0.2);
      transition: box-shadow 0.3s ease;
    }

    .video-item:hover {
      box-shadow: 0 12px 32px rgba(0, 0, 0, 0.4), 0 6px 12px rgba(0, 0, 0, 0.25);
    }

    .video-box {
      width: 100%;
      height: 100%;
      position: relative;
    }

    .video-player {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    /* âœ… æœ¬åœ°è§†é¢‘é•œåƒï¼šè®©å‰ç½®æ‘„åƒå¤´çš„ç”»é¢ç¬¦åˆè‡ªæ‹ä¹ æƒ¯ï¼ˆå·¦å³ç¿»è½¬ï¼‰
     * æ³¨æ„ï¼šåªå¯¹æœ¬åœ°é¢„è§ˆé•œåƒï¼Œæ¨æµç»™å¯¹æ–¹çš„ç”»é¢æ˜¯æ­£å¸¸çš„ï¼ˆä¸é•œåƒï¼‰
     */
    #localVideo {
      transform: scaleX(-1);  /* æ°´å¹³ç¿»è½¬æœ¬åœ°è§†é¢‘ */
    }

    .video-label {
      position: absolute;
      bottom: 10px;
      left: 10px;
      background: rgba(0, 0, 0, 0.7);
      color: white;
      padding: 5px 10px;
      border-radius: 6px;
      font-size: 12px;
    }

    /* ç®¡ç†æŒ‰é’® */
    .manage-btn {
      position: absolute;
      top: 10px;
      right: 10px;
      width: 32px;
      height: 32px;
      background: rgba(0, 0, 0, 0.7);
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s;
      z-index: 10;
    }

    .manage-btn:hover {
      background: rgba(0, 0, 0, 0.85);
      transform: scale(1.05);
    }

    .manage-btn:active {
      transform: scale(0.95);
    }

    .manage-icon {
      color: white;
      font-size: 18px;
      line-height: 1;
    }

    /* ç®¡ç†èœå• */
    .manage-menu {
      position: absolute;
      top: 45px;
      right: 10px;
      background: white;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      overflow: hidden;
      z-index: 20;
      min-width: 140px;
      display: none;
    }

    .manage-menu.show {
      display: block;
      animation: menuFadeIn 0.2s ease;
    }

    @keyframes menuFadeIn {
      from {
        opacity: 0;
        transform: translateY(-5px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .manage-menu-item {
      padding: 12px 16px;
      cursor: pointer;
      transition: background 0.2s;
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
      color: #333;
      border-bottom: 1px solid #f0f0f0;
    }

    .manage-menu-item:last-child {
      border-bottom: none;
    }

    .manage-menu-item:hover {
      background: #f5f5f5;
    }

    .manage-menu-item:active {
      background: #e8e8e8;
    }

    .manage-menu-item.danger {
      color: #ff4d4f;
    }

    .manage-menu-item.danger:hover {
      background: #fff1f0;
    }

    .manage-menu-icon {
      font-size: 16px;
      line-height: 1;
    }

    .video-placeholder {
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: linear-gradient(135deg, #1a1a1a 0%, #2a2a2a 100%);
      color: #666;
    }

    /* ç©ºä½å ä½ç¬¦æ ·å¼ - é•¶åµŒæ•ˆæœç‰ˆ */
    .empty-slot {
      background: linear-gradient(135deg, #1a1a1a 0%, #2a2a2a 100%);
      border: 1px solid #333;
    }

    .empty-slot .placeholder-icon {
      /* ğŸ”¥ é•¶åµŒæ•ˆæœï¼šåœ†å½¢å‡¹é™·å®¹å™¨ */
      width: 80px;
      height: 80px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 16px;
      position: relative;

      /* ğŸ”¥ æ·±è‰²èƒŒæ™¯ï¼Œä¸å®¹å™¨èä¸ºä¸€ä½“ */
      background: linear-gradient(145deg, #151515, #1f1f1f);

      /* ğŸ”¥ å†…é˜´å½±ï¼šè¥é€ "å‡¹é™·"æ•ˆæœ */
      box-shadow:
        inset 5px 5px 10px rgba(0, 0, 0, 0.8),      /* å·¦ä¸Šæ·±è‰²é˜´å½±ï¼ˆå‡¹é™·ï¼‰ */
        inset -5px -5px 10px rgba(255, 255, 255, 0.03), /* å³ä¸‹æµ…è‰²é«˜å…‰ï¼ˆæ·±åº¦ï¼‰ */
        inset 0 0 20px rgba(0, 0, 0, 0.4),          /* æ•´ä½“å†…é˜´å½± */
        0 1px 2px rgba(0, 0, 0, 0.3);               /* è½»å¾®å¤–é˜´å½±å¢åŠ å±‚æ¬¡ */

      /* ğŸ”¥ Logoå›¾æ ‡ï¼ˆä¸ä½¿ç”¨emojiï¼Œæ”¹ç”¨èƒŒæ™¯å›¾ï¼‰ */
      font-size: 0; /* éšè—emoji */

      /* æ·»åŠ å¾®å¦™çš„è¿‡æ¸¡æ•ˆæœ */
      transition: all 0.3s ease;
    }

    /* ğŸ”¥ LogoèƒŒæ™¯å›¾ */
    .empty-slot .placeholder-icon::before {
      content: '';
      position: absolute;
      width: 50px;
      height: 50px;
      background-image: url('./assets/logo-dove.svg');
      background-size: contain;
      background-position: center;
      background-repeat: no-repeat;
      opacity: 0.4; /* åŠé€æ˜ï¼Œåƒ"åˆ»"åœ¨é‡Œé¢ */
      filter: brightness(1.2) contrast(1.1); /* è½»å¾®æäº® */
    }

    /* æ‚¬åœæ•ˆæœï¼šè½»å¾®"æµ®èµ·" */
    .empty-slot .placeholder-icon:hover {
      box-shadow:
        inset 3px 3px 8px rgba(0, 0, 0, 0.7),
        inset -3px -3px 8px rgba(255, 255, 255, 0.04),
        inset 0 0 15px rgba(0, 0, 0, 0.3),
        0 2px 4px rgba(0, 0, 0, 0.4);
    }

    .empty-slot .placeholder-icon:hover::before {
      opacity: 0.5; /* æ‚¬åœæ—¶logoç¨å¾®äº®ä¸€ç‚¹ */
    }

    .empty-slot .placeholder-text {
      color: #888;
      font-size: 14px;
      font-weight: 400;
      margin-top: 4px;
    }

    body.miniprogram-env .video-placeholder.empty-slot .placeholder-text {
      color: #888;
      font-size: 14px;
    }

    .placeholder-icon {
      font-size: 48px;
      margin-bottom: 10px;
    }

    .placeholder-text {
      font-size: 14px;
    }

    .empty-video {
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #999;
      font-size: 14px;
    }
    
    /* æ§åˆ¶æŒ‰é’® */
    .controls {
      padding: 10px 6px;
      margin: 10px;
      background: rgba(255, 255, 255, 0.98);
      border-radius: 12px;
      display: flex;
      justify-content: space-around;
      align-items: center;
      box-shadow: 0 -2px 10px rgba(95, 179, 163, 0.15);
    }

    .control-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      padding: 6px;
      border-radius: 6px;
      transition: all 0.3s;
      cursor: pointer;
      flex: 1;
    }

    .control-item:active {
      background: rgba(95, 179, 163, 0.1);
    }

    .control-item-danger:active {
      background: rgba(255, 107, 107, 0.1);
    }

    .control-icon-text {
      font-size: 24px;
      line-height: 1;
    }

    .control-label {
      font-size: 11px;
      color: #666;
    }

    /* å…³é—­çŠ¶æ€æ ·å¼ */
    .control-item.disabled {
      opacity: 0.5;
    }

    .control-item.disabled .control-icon-text {
      color: #999;
    }

    .control-item.disabled .control-label {
      color: #999;
    }

    .control-item-danger .control-label {
      color: #ff6b6b;
    }
    
    /* åŠ å…¥é¢è¯•é¢æ¿ */
    .join-panel {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    /* éšè—ç±» */
    .join-panel.hidden {
      display: none !important;
    }
    
    .join-box {
      background: #fff;
      padding: 32px 24px;
      border-radius: 16px;
      width: 85%;
      max-width: 400px;
      box-shadow: 0 16px 48px rgba(0,0,0,0.3), 0 8px 16px rgba(0,0,0,0.2);
    }

    .join-box h2 {
      margin-bottom: 12px;
      text-align: center;
      color: #333;
      font-size: 22px;
      font-weight: bold;
    }
    
    .join-box .room-hint {
      text-align: center;
      color: #999;
      font-size: 14px;
      margin-bottom: 20px;
    }

    /* èº«ä»½é€‰æ‹© */
    .role-selector {
      display: flex;
      gap: 12px;
      margin-bottom: 20px;
    }

    .role-option {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
      padding: 16px 12px;
      border: 2px solid #e0e0e0;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s;
      background: #fff;
    }

    .role-option:hover {
      border-color: #5fb3a3;
      background: rgba(95, 179, 163, 0.05);
    }

    .role-option.selected {
      border-color: #5fb3a3;
      background: rgba(95, 179, 163, 0.1);
    }

    .role-icon {
      font-size: 32px;
      line-height: 1;
    }

    .role-text {
      font-size: 14px;
      color: #333;
      font-weight: 500;
    }

    .role-option.selected .role-text {
      color: #5fb3a3;
      font-weight: 600;
    }

    .join-box input {
      width: 100%;
      padding: 14px 16px;
      border: 1px solid #ddd;
      border-radius: 8px;
      margin-bottom: 20px;
      font-size: 15px;
      transition: border-color 0.3s;
    }
    
    .join-box input:focus {
      outline: none;
      border-color: #5fb3a3;
    }

    .join-box button {
      width: 100%;
      padding: 16px;
      background: linear-gradient(135deg, #5fb3a3 0%, #4a9d8e 100%);
      color: #fff;
      border: none;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s;
      box-shadow: 0 4px 16px rgba(95, 179, 163, 0.3);
    }

    .join-box button:active {
      transform: scale(0.98);
    }
    
    /* åŠ è½½æç¤º */
    .loading {
      position: fixed;
      top: 80px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.8);
      color: #fff;
      padding: 8px 16px;
      border-radius: 6px;
      font-size: 12px;
      z-index: 2000;
      white-space: nowrap;
    }

    /* Toast æç¤ºæ ·å¼ */
    .toast {
      position: fixed;
      top: 80px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.8);
      color: #fff;
      padding: 8px 16px;
      border-radius: 6px;
      font-size: 12px;
      z-index: 3000;
      display: none;
      max-width: 80%;
      text-align: center;
      animation: fadeIn 0.3s ease-in-out;
      white-space: nowrap;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateX(-50%) scale(0.9);
      }
      to {
        opacity: 1;
        transform: translateX(-50%) scale(1);
      }
    }

    .toast.success {
      background: rgba(82, 196, 26, 0.9);
    }

    .toast.error {
      background: rgba(255, 77, 79, 0.9);
    }

    .toast.warning {
      background: rgba(250, 173, 20, 0.9);
    }

    /* âœ… é‡è¿æç¤ºæ ·å¼ */
    .reconnect-toast {
      position: fixed;
      top: 80px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.85);
      color: #fff;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 12px;
      z-index: 10000;
      display: none;
      align-items: center;
      gap: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      white-space: nowrap;
    }

    .reconnect-toast.show {
      display: flex;
    }

    .reconnect-spinner {
      width: 16px;
      height: 16px;
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-top-color: #fff;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* é‚€è¯·å¼¹çª—æ ·å¼ */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.6);
      z-index: 3000;
      justify-content: center;
      align-items: center;
    }

    .modal.show {
      display: flex;
    }

    .modal-content {
      background: #fff;
      border-radius: 16px;
      width: 90%;
      max-width: 450px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      animation: modalSlideIn 0.3s ease;
    }

    @keyframes modalSlideIn {
      from {
        transform: translateY(-50px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px 24px;
      border-bottom: 1px solid #eee;
    }

    .modal-header h3 {
      margin: 0;
      font-size: 18px;
      color: #333;
    }

    .modal-close {
      font-size: 28px;
      color: #999;
      cursor: pointer;
      line-height: 1;
      transition: color 0.3s;
    }

    .modal-close:hover {
      color: #333;
    }

    .modal-body {
      padding: 24px;
    }

    .modal-tip {
      margin: 0 0 12px 0;
      color: #666;
      font-size: 14px;
    }

    .invite-link-box {
      background: #f5f5f5;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 16px;
    }

    .invite-link-input {
      width: 100%;
      border: none;
      background: transparent;
      color: #333;
      font-size: 13px;
      outline: none;
      word-break: break-all;
    }

    .invite-copy-btn {
      width: 100%;
      padding: 14px;
      background: linear-gradient(135deg, #5fb3a3 0%, #4a9d8e 100%);
      color: #fff;
      border: none;
      border-radius: 10px;
      font-size: 16px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s;
      box-shadow: 0 4px 16px rgba(95, 179, 163, 0.3);
    }

    .invite-copy-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(95, 179, 163, 0.4);
    }

    .invite-copy-btn:active {
      transform: translateY(0);
    }

    .modal-hint {
      margin: 16px 0 0 0;
      text-align: center;
      color: #999;
      font-size: 13px;
    }


  </style>
</head>
<body>
  <!-- âœ… é‡è¿æç¤º -->
  <div class="reconnect-toast" id="reconnectToast">
    <div class="reconnect-spinner"></div>
    <span>æ­£åœ¨é‡æ–°è¿æ¥...</span>
  </div>

  <div class="container">
    <!-- åˆ›å»ºé¢è¯•é—´é¢æ¿ -->
    <div class="join-panel" id="joinPanel">
      <div class="join-box">
        <h2>ğŸ¥ è§†é¢‘é¢è¯• - ä¸»æŒäºº</h2>
        <div class="room-hint">ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®åˆ›å»ºé¢è¯•é—´</div>

        <button onclick="createRoom()">åˆ›å»ºé¢è¯•é—´</button>
      </div>
    </div>
    
    <!-- æˆ¿é—´ä¿¡æ¯ -->
    <div class="header">
      <div class="header-left">
        <span class="room-label">æˆ¿é—´å·ï¼š</span>
        <span class="room-value" id="roomId"></span>
      </div>
      <div class="header-right">
        <span class="time-label">é¢è¯•æ—¶é—´ï¼š</span>
        <span class="time-value" id="interviewTime">00:00</span>
      </div>
    </div>
    
    <!-- è§†é¢‘ç½‘æ ¼ -->
    <div class="video-grid" id="videoGrid">
      <!-- æœ¬åœ°è§†é¢‘ -->
      <div class="video-item">
        <div class="video-box">
          <video id="localVideo" class="video-player" autoplay muted playsinline webkit-playsinline x5-playsinline x-webkit-airplay="allow" x5-video-player-type="h5" x5-video-player-fullscreen="false"></video>
          <div class="video-label" id="localLabel">ä¸»æŒäºº</div>
        </div>
      </div>

      <!-- è¿œç¨‹è§†é¢‘1 -->
      <div class="video-item">
        <div class="video-box" id="remoteBox1">
          <div class="video-placeholder empty-slot">
            <div class="placeholder-icon">ğŸ‘¤</div>
            <div class="placeholder-text">ç­‰å¾…åŠ å…¥</div>
          </div>
        </div>
      </div>

      <!-- è¿œç¨‹è§†é¢‘2 -->
      <div class="video-item">
        <div class="video-box" id="remoteBox2">
          <div class="video-placeholder empty-slot">
            <div class="placeholder-icon">ğŸ‘¤</div>
            <div class="placeholder-text">ç­‰å¾…åŠ å…¥</div>
          </div>
        </div>
      </div>

      <!-- è¿œç¨‹è§†é¢‘3 -->
      <div class="video-item">
        <div class="video-box" id="remoteBox3">
          <div class="video-placeholder empty-slot">
            <div class="placeholder-icon">ğŸ‘¤</div>
            <div class="placeholder-text">ç­‰å¾…åŠ å…¥</div>
          </div>
        </div>
      </div>

      <!-- è¿œç¨‹è§†é¢‘4 -->
      <div class="video-item">
        <div class="video-box" id="remoteBox4">
          <div class="video-placeholder empty-slot">
            <div class="placeholder-icon">ğŸ‘¤</div>
            <div class="placeholder-text">ç­‰å¾…åŠ å…¥</div>
          </div>
        </div>
      </div>

      <!-- è¿œç¨‹è§†é¢‘5 -->
      <div class="video-item">
        <div class="video-box" id="remoteBox5">
          <div class="video-placeholder empty-slot">
            <div class="placeholder-icon">ğŸ‘¤</div>
            <div class="placeholder-text">ç­‰å¾…åŠ å…¥</div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- æ§åˆ¶æŒ‰é’® -->
    <div class="controls">
      <div class="control-item" id="micBtn" onclick="toggleMic()">
        <div class="control-icon-text">ğŸ¤</div>
        <div class="control-label">éº¦å…‹é£</div>
      </div>
      <div class="control-item" id="cameraBtn" onclick="toggleCamera()">
        <div class="control-icon-text">ğŸ“¹</div>
        <div class="control-label">æ‘„åƒå¤´</div>
      </div>
      <div class="control-item" id="flipBtn" onclick="flipCamera()">
        <div class="control-icon-text">ğŸ”„</div>
        <div class="control-label">ç¿»è½¬</div>
      </div>
      <div class="control-item" id="teleprompterBtn" onclick="showTeleprompterModal()">
        <div class="control-icon-text">ğŸ“</div>
        <div class="control-label">æè¯å™¨</div>
      </div>
      <div class="control-item control-item-danger" onclick="leaveRoom()">
        <div class="control-icon-text">ğŸ“</div>
        <div class="control-label">ç»“æŸé¢è¯•</div>
      </div>
    </div>
  </div>

  <!-- é‚€è¯·å¼¹çª— -->
  <div id="inviteModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>é‚€è¯·ç”¨æˆ·</h3>
        <span class="modal-close" onclick="closeInviteModal()">&times;</span>
      </div>
      <div class="modal-body">
        <p class="modal-tip">å¤åˆ¶ä»¥ä¸‹é“¾æ¥å‘é€ç»™å€™é€‰äººï¼š</p>
        <div class="invite-link-box">
          <input type="text" id="inviteLink" class="invite-link-input" readonly>
        </div>
        <button class="invite-copy-btn" onclick="copyInviteLink()">
          ğŸ“‹ å¤åˆ¶é“¾æ¥å¹¶é‚€è¯·
        </button>
        <p class="modal-hint">ğŸ’¡ å€™é€‰äººç‚¹å‡»é“¾æ¥å³å¯åŠ å…¥</p>
      </div>
    </div>
  </div>

  <!-- æè¯å™¨å¼¹çª— -->
  <div id="teleprompterModal" class="modal">
    <div class="modal-content" style="max-width: 500px;">
      <div class="modal-header">
        <h3>ğŸ“ æè¯å™¨æ§åˆ¶</h3>
        <span class="modal-close" onclick="closeTeleprompterModal()">&times;</span>
      </div>
      <div class="modal-body">
        <!-- æè¯å†…å®¹ -->
        <div style="margin-bottom: 20px;">
          <label style="display: block; margin-bottom: 8px; font-weight: 500; color: #333;">æè¯å†…å®¹:</label>
          <textarea
            id="teleprompterContent"
            placeholder="è¯·è¾“å…¥æè¯å†…å®¹..."
            oninput="this.scrollTop = this.scrollHeight"
            style="width: 100%; min-height: 120px; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 15px; resize: vertical;"
          ></textarea>
        </div>

        <!-- æ¨é€ç»™ -->
        <div style="margin-bottom: 20px;">
          <label style="display: block; margin-bottom: 8px; font-weight: 500; color: #333;">æ¨é€ç»™:</label>
          <select
            id="teleprompterTarget"
            style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 15px;"
          >
            <option value="" disabled selected>è¯·é€‰æ‹©é˜¿å§¨</option>
          </select>
        </div>

        <!-- æ»šåŠ¨é€Ÿåº¦ -->
        <div style="margin-bottom: 24px;">
          <label style="display: block; margin-bottom: 8px; font-weight: 500; color: #333;">
            æ»šåŠ¨é€Ÿåº¦: <span id="speedValue">10</span> åƒç´ /ç§’
          </label>
          <input
            type="range"
            id="teleprompterSpeed"
            min="10"
            max="100"
            value="10"
            oninput="document.getElementById('speedValue').textContent = this.value"
            style="width: 100%;"
          >
        </div>

        <!-- æ“ä½œæŒ‰é’® -->
        <div style="display: flex; flex-direction: column; gap: 12px;">
          <button
            onclick="quickStartTeleprompter()"
            style="width: 100%; padding: 14px; background: linear-gradient(135deg, #5DBFB3 0%, #4da89d 100%); color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; box-shadow: 0 4px 12px rgba(93, 191, 179, 0.3);"
          >
            ğŸš€ ä¸€é”®æ¨é€å¹¶å¼€å¯
          </button>

          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
            <button
              onclick="controlTeleprompter('PLAY')"
              style="padding: 12px; background: #fff; color: #52c41a; border: 1px solid #52c41a; border-radius: 8px; font-size: 14px; cursor: pointer;"
            >
              â–¶ï¸ æ’­æ”¾
            </button>
            <button
              onclick="controlTeleprompter('PAUSE')"
              style="padding: 12px; background: #fff; color: #faad14; border: 1px solid #faad14; border-radius: 8px; font-size: 14px; cursor: pointer;"
            >
              â¸ï¸ æš‚åœ
            </button>
          </div>

          <button
            onclick="controlTeleprompter('HIDE')"
            style="width: 100%; padding: 12px; background: #fff; color: #ff4d4f; border: 1px solid #ff4d4f; border-radius: 8px; font-size: 14px; cursor: pointer;"
          >
            âŒ å…³é—­æè¯å™¨
          </button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ==================== è„šæœ¬å¼€å§‹æ‰§è¡Œ ====================
    console.log('ğŸš€ video-interview.html è„šæœ¬å¼€å§‹æ‰§è¡Œ');
    console.log('ğŸ“… è„šæœ¬ç‰ˆæœ¬: 2025-11-10 v2.1');
    console.log('ğŸ” ç«‹å³æ£€æµ‹ ZegoExpressEngine:', typeof ZegoExpressEngine);
    console.log('ğŸ” ZegoExpressEngine è¯¦æƒ…:', ZegoExpressEngine);
    console.log('ğŸ” ZegoExpressEngine.ZegoExpressEngine:', typeof ZegoExpressEngine !== 'undefined' && ZegoExpressEngine.ZegoExpressEngine);
    console.log('ğŸ” ç«‹å³æ£€æµ‹ generateToken04:', typeof generateToken04);

    // ==================== å…¨å±€å˜é‡ ====================
    const urlParams = new URLSearchParams(window.location.search);
    let roomId = urlParams.get('room') || ''; // HRç«¯ä¼šè‡ªåŠ¨ç”Ÿæˆæˆ¿é—´å·

    // ZEGO é…ç½®
    const appID = 1279160453;
    const server = 'wss://webliveroom-api.zego.im/ws';
    // ServerSecretï¼ˆUTF-8 æ ¼å¼ï¼Œç”¨äºç”Ÿæˆ Tokenï¼‰
    const serverSecret = 'e18cc600e2939d412c48f152e157f01d';

    let zg = null;
    let localStream = null;
    let remoteStreams = {}; // å­˜å‚¨è¿œç¨‹æµ { streamID: MediaStream }
    let isMicOn = true;
    let isCameraOn = true;
    let isFrontCamera = true; // é»˜è®¤ä½¿ç”¨å‰ç½®æ‘„åƒå¤´
    let currentUserId = '';
    let currentUserName = '';
    let currentUserRole = ''; // ç”¨æˆ·èº«ä»½ï¼šcustomer æˆ– ayi
    let currentStreamId = ''; // å½“å‰æ¨æµID
    let interviewStartTime = null;
    let interviewTimer = null;
    let onlineUsers = {}; // å­˜å‚¨åœ¨çº¿ç”¨æˆ· { userId: { userName, userRole, streamId } }

    // ç®€åŒ–çš„æ—¥å¿—å‡½æ•°ï¼ˆä»…è¾“å‡ºåˆ° consoleï¼‰
    function addLog(message, type = 'info') {
      console.log(`[${type.toUpperCase()}] ${message}`);
    }

    // ==================== è·å– JWT Token ====================
    function getJwtToken() {
      const urlParams = new URLSearchParams(window.location.search);
      const tokenFromUrl = urlParams.get('token');
      if (tokenFromUrl) {
        console.log('âœ… ä» URL è·å–åˆ° JWT Token');
        return tokenFromUrl;
      }
      console.warn('âš ï¸ æœªæ‰¾åˆ° JWT Token');
      return null;
    }

    // ==================== Token ç”Ÿæˆ ====================
    async function generateToken(userID, roomID, userName) {
      try {
        console.log('ğŸ”‘ ä»åç«¯APIè·å– ZEGO Token...');
        console.log('ğŸ“± AppID:', appID);
        console.log('ğŸ‘¤ UserID:', userID);
        console.log('ğŸ  RoomID:', roomID);
        console.log('ğŸ‘¨ UserName:', userName);

        // è·å– JWT Token
        const jwtToken = getJwtToken();
        if (!jwtToken) {
          throw new Error('æœªæ‰¾åˆ° JWT Tokenï¼Œè¯·å…ˆç™»å½•ç³»ç»Ÿ');
        }

        // è°ƒç”¨åç«¯API
        const response = await fetch('/api/zego/generate-token', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${jwtToken}`,
          },
          body: JSON.stringify({
            userId: userID,
            roomId: roomID,
            userName: userName,
            expireTime: 7200
          })
        });

        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        const result = await response.json();
        console.log('âœ… åç«¯å“åº”:', result);

        if (result.success && result.data && result.data.token) {
          const token = result.data.token;
          console.log('âœ… Token è·å–æˆåŠŸï¼Œé•¿åº¦:', token.length);
          return token;
        } else {
          throw new Error(result.message || 'è·å–Tokenå¤±è´¥');
        }
      } catch (error) {
        console.error('âŒ Token è·å–å¤±è´¥:', error);
        throw error;
      }
    }

    // ==================== èº«ä»½é€‰æ‹© ====================
    function selectRole(role) {
      currentUserRole = role;

      // æ›´æ–°é€‰ä¸­çŠ¶æ€
      document.querySelectorAll('.role-option').forEach(option => {
        option.classList.remove('selected');
      });
      document.querySelector(`.role-option[data-role="${role}"]`).classList.add('selected');

      console.log('é€‰æ‹©èº«ä»½:', role === 'customer' ? 'å®¢æˆ·' : 'é˜¿å§¨');
    }

    // ==================== åˆå§‹åŒ– ZEGO ====================
    function initZego() {
      console.log('åˆå§‹åŒ– ZEGO SDK...');

      // æ£€æŸ¥ ZEGO SDK æ˜¯å¦åŠ è½½
      if (typeof ZegoExpressEngine === 'undefined') {
        console.error('ZEGO SDK æœªåŠ è½½');
        showToast('è§†é¢‘SDKåŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•', 'error', 3000);
        return false;
      }

      // å°è¯•è·å–æ­£ç¡®çš„æ„é€ å‡½æ•°
      let ZegoEngine = ZegoExpressEngine;
      if (typeof ZegoExpressEngine === 'object' && ZegoExpressEngine.ZegoExpressEngine) {
        console.log('æ£€æµ‹åˆ° ZegoExpressEngine æ˜¯å¯¹è±¡ï¼Œæå–æ„é€ å‡½æ•°');
        ZegoEngine = ZegoExpressEngine.ZegoExpressEngine;
      }

      console.log('ä½¿ç”¨çš„æ„é€ å‡½æ•°ç±»å‹:', typeof ZegoEngine);

      // åˆ›å»º ZEGO å®ä¾‹ï¼Œå¹¶è®¾ç½®æ—¥å¿—çº§åˆ«ä¸º errorï¼ˆåªæ˜¾ç¤ºé”™è¯¯æ—¥å¿—ï¼‰
      zg = new ZegoEngine(appID, server);
      zg.setLogConfig({
        logLevel: 'error',  // åªæ˜¾ç¤ºé”™è¯¯æ—¥å¿—
        remoteLogLevel: 'disable'  // å…³é—­è¿œç¨‹æ—¥å¿—
      });

      console.log('ZEGO SDK åˆå§‹åŒ–æˆåŠŸ');
      
      // ç›‘å¬è¿œç¨‹æµæ›´æ–°
      zg.on('roomStreamUpdate', async (roomID, updateType, streamList) => {
        console.log('ğŸ”” æˆ¿é—´æµæ›´æ–° - RoomID:', roomID);
        console.log('ğŸ”” æ›´æ–°ç±»å‹:', updateType);
        console.log('ğŸ”” æµåˆ—è¡¨æ•°é‡:', streamList.length);
        console.log('ğŸ”” æµè¯¦æƒ…:', streamList);

        // ğŸ”¥ æ·»åŠ æ—¥å¿—
        addLog(`ğŸ”” æµæ›´æ–°: ${updateType} (${streamList.length}ä¸ªæµ)`, 'event');

        if (updateType === 'ADD') {
          // æœ‰æ–°çš„æµåŠ å…¥
          console.log('âœ… æ£€æµ‹åˆ°æ–°æµåŠ å…¥ï¼Œå¼€å§‹æ’­æ”¾...');
          for (const stream of streamList) {
            console.log('ğŸ“º å‡†å¤‡æ’­æ”¾æµ:', stream.streamID, 'ç”¨æˆ·:', stream.user);
            const userName = stream.user?.userName || 'æœªçŸ¥ç”¨æˆ·';
            const userId = stream.user?.userID || '';
            addLog(`â• æ–°æµåŠ å…¥: ${userName} (${stream.streamID})`, 'success');

            // æ·»åŠ åˆ°åœ¨çº¿ç”¨æˆ·åˆ—è¡¨
            onlineUsers[userId] = {
              userName: userName,
              userRole: userName, // ä»userNameæ¨æ–­è§’è‰²ï¼ˆcustomer/helperï¼‰
              streamId: stream.streamID
            };
            console.log('ğŸ‘¥ åœ¨çº¿ç”¨æˆ·åˆ—è¡¨å·²æ›´æ–°:', onlineUsers);

            await playRemoteStream(stream);
          }
        } else if (updateType === 'DELETE') {
          // æœ‰æµç¦»å¼€
          console.log('âš ï¸ æ£€æµ‹åˆ°æµç¦»å¼€');
          for (const stream of streamList) {
            console.log('ğŸ“º ç§»é™¤æµ:', stream.streamID);
            const userName = stream.user?.userName || 'æœªçŸ¥ç”¨æˆ·';
            const userId = stream.user?.userID || '';
            addLog(`â– æµç¦»å¼€: ${userName} (${stream.streamID})`, 'warning');

            // ä»åœ¨çº¿ç”¨æˆ·åˆ—è¡¨ç§»é™¤
            delete onlineUsers[userId];
            console.log('ğŸ‘¥ åœ¨çº¿ç”¨æˆ·åˆ—è¡¨å·²æ›´æ–°:', onlineUsers);

            removeRemoteStream(stream.streamID);
          }
        }
      });

      // âœ… ç›‘å¬è®¾å¤‡é”™è¯¯ï¼ˆiOSè®¾å¤‡å ç”¨é—®é¢˜ï¼‰
      zg.on('deviceError', (errorCode, deviceName) => {
        console.error('ğŸš¨ è®¾å¤‡é”™è¯¯:', { errorCode, deviceName });

        // 1106011: æ‘„åƒå¤´è¢«å ç”¨
        // 1106012: éº¦å…‹é£è¢«å ç”¨
        if (errorCode === 1106011 || errorCode === 1106012) {
          const deviceType = errorCode === 1106011 ? 'æ‘„åƒå¤´' : 'éº¦å…‹é£';
          showToast(`${deviceType}è¢«å…¶ä»–é¡µé¢æˆ–åº”ç”¨å ç”¨ï¼Œè¯·å…³é—­å…¶ä»–é¡µé¢ååˆ·æ–°é‡è¯•`, 'error', 3000);
          console.error(`âŒ iOSè®¾å¤‡å ç”¨é—®é¢˜: ${deviceType}è¢«å ç”¨ï¼Œéœ€è¦ç”¨æˆ·å…³é—­å…¶ä»–é¡µé¢`);
        }
      });

      // ç›‘å¬æˆ¿é—´çŠ¶æ€
      zg.on('roomStateUpdate', (roomID, state, errorCode, extendedData) => {
        console.log('æˆ¿é—´çŠ¶æ€æ›´æ–°:', state, errorCode);

        if (state === 'DISCONNECTED') {
          console.log('âš ï¸ æ£€æµ‹åˆ°æ–­å¼€è¿æ¥ï¼ŒerrorCode=' + errorCode);

          // ğŸ”¥ errorCode è¯´æ˜ï¼š
          // 0 = æ­£å¸¸æ–­å¼€ï¼ˆä¸»åŠ¨é€€å‡ºï¼‰
          // 1002055 = æˆ¿é—´è¢«è§£æ•£
          // å…¶ä»– = ç½‘ç»œæ–­å¼€ç­‰å¼‚å¸¸æƒ…å†µ

          if (errorCode === 1002055) {
            // æˆ¿é—´è¢«è§£æ•£ï¼Œä¸æ˜¾ç¤ºé‡è¿æç¤ºï¼ˆå·²ç»æœ‰"æˆ¿é—´å·²è§£æ•£"çš„å¼¹çª—ï¼‰
            console.log('ğŸ”´ æˆ¿é—´å·²è¢«è§£æ•£ï¼Œä¸æ˜¾ç¤ºé‡è¿æç¤º');
            hideReconnectToast(); // ç¡®ä¿éšè—é‡è¿æç¤º
          } else if (errorCode !== 0) {
            // å…¶ä»–éæ­£å¸¸æ–­å¼€ï¼Œæ˜¾ç¤ºé‡è¿æç¤º
            console.log('ğŸ”„ ç½‘ç»œæ–­å¼€ï¼Œæ˜¾ç¤ºé‡è¿æç¤º');
            showReconnectToast();
          }
        } else if (state === 'CONNECTING') {
          console.log('ğŸ”„ æ­£åœ¨é‡æ–°è¿æ¥...');
          showReconnectToast();
        } else if (state === 'CONNECTED') {
          console.log('âœ… å·²è¿æ¥åˆ°æˆ¿é—´');
          hideReconnectToast();
        }
      });

      return true;
    }



    // ==================== æ£€æŸ¥å¹¶åŠ å…¥æˆ¿é—´ ====================
    async function checkAndJoinRoom(roomId) {
      console.log('ğŸ” æ£€æŸ¥æˆ¿é—´çŠ¶æ€:', roomId);

      const jwtToken = getJwtToken();
      if (!jwtToken) {
        console.warn('âš ï¸ æœªæ‰¾åˆ°JWT Tokenï¼Œæ— æ³•æ£€æŸ¥æˆ¿é—´çŠ¶æ€');
        addLog('âš ï¸ æœªç™»å½•ï¼Œè¯·æ‰‹åŠ¨åˆ›å»ºé¢è¯•é—´', 'warning');
        // æ˜¾ç¤ºåˆ›å»ºé¢è¯•é—´æŒ‰é’®
        const joinPanel = document.getElementById('joinPanel');
        if (joinPanel) {
          joinPanel.style.display = 'flex';
        }
        return;
      }

      try {
        // è°ƒç”¨åç«¯æ£€æŸ¥æˆ¿é—´çŠ¶æ€
        const response = await fetch(`/api/interview/rooms/${roomId}/status`, {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${jwtToken}`
          }
        });

        const result = await response.json();
        console.log('ğŸ“‹ æˆ¿é—´çŠ¶æ€æ£€æŸ¥ç»“æœ:', result);

        if (result.success && result.data) {
          const { dbStatus, zegoCanJoin } = result.data;

          // ğŸ”¥ å…³é”®åˆ¤æ–­ï¼šåªæœ‰æˆ¿é—´çŠ¶æ€ä¸º active æ‰è‡ªåŠ¨åŠ å…¥
          if (dbStatus === 'active') {
            console.log('âœ… æˆ¿é—´çŠ¶æ€ä¸º activeï¼Œè‡ªåŠ¨åŠ å…¥æˆ¿é—´');
            addLog('âœ… æ£€æµ‹åˆ°æ´»è·ƒçš„é¢è¯•é—´ï¼Œæ­£åœ¨è‡ªåŠ¨åŠ å…¥...', 'success');

            // éšè—è¿‡æ¸¡é¡µé¢
            const joinPanel = document.getElementById('joinPanel');
            if (joinPanel) {
              joinPanel.style.display = 'none';
            }

            // ç­‰å¾…ä¸€ä¸‹è®©SDKå®Œå…¨åˆå§‹åŒ–
            setTimeout(() => {
              createRoom(); // è°ƒç”¨åˆ›å»ºæˆ¿é—´å‡½æ•°ï¼ˆå®é™…ä¸Šä¼šåŠ å…¥å·²å­˜åœ¨çš„æˆ¿é—´ï¼‰
            }, 1000);
          } else {
            // æˆ¿é—´å·²ç»“æŸï¼Œä¸è‡ªåŠ¨åŠ å…¥
            console.log('âš ï¸ æˆ¿é—´çŠ¶æ€ä¸º', dbStatus, 'ï¼Œä¸è‡ªåŠ¨åŠ å…¥');
            addLog(`âš ï¸ é¢è¯•é—´å·²ç»“æŸï¼Œè¯·åˆ›å»ºæ–°çš„é¢è¯•é—´`, 'warning');

            // æ˜¾ç¤ºåˆ›å»ºé¢è¯•é—´æŒ‰é’®
            const joinPanel = document.getElementById('joinPanel');
            if (joinPanel) {
              joinPanel.style.display = 'flex';
            }
          }
        } else {
          // æˆ¿é—´ä¸å­˜åœ¨æˆ–æ£€æŸ¥å¤±è´¥
          console.warn('âš ï¸ æˆ¿é—´ä¸å­˜åœ¨æˆ–æ£€æŸ¥å¤±è´¥:', result.message);
          addLog('âš ï¸ é¢è¯•é—´ä¸å­˜åœ¨ï¼Œè¯·åˆ›å»ºæ–°çš„é¢è¯•é—´', 'warning');

          // æ˜¾ç¤ºåˆ›å»ºé¢è¯•é—´æŒ‰é’®
          const joinPanel = document.getElementById('joinPanel');
          if (joinPanel) {
            joinPanel.style.display = 'flex';
          }
        }
      } catch (error) {
        console.error('âŒ æ£€æŸ¥æˆ¿é—´çŠ¶æ€å¤±è´¥:', error);
        addLog('âŒ æ£€æŸ¥æˆ¿é—´çŠ¶æ€å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨åˆ›å»ºé¢è¯•é—´', 'error');

        // æ˜¾ç¤ºåˆ›å»ºé¢è¯•é—´æŒ‰é’®
        const joinPanel = document.getElementById('joinPanel');
        if (joinPanel) {
          joinPanel.style.display = 'flex';
        }
      }
    }

    // ==================== åˆ›å»ºé¢è¯•é—´ ====================
    async function createRoom() {
      console.log('â• åˆ›å»ºé¢è¯•é—´');

      // æ£€æŸ¥ ZEGO SDK æ˜¯å¦å·²åˆå§‹åŒ–
      if (!zg) {
        console.error('ZEGO SDK æœªåˆå§‹åŒ–');
        showToast('è§†é¢‘SDKæœªåˆå§‹åŒ–ï¼Œæ­£åœ¨é‡æ–°åˆå§‹åŒ–...', 'warning', 2000);
        const success = initZego();
        if (!success) {
          return;
        }
        // ç­‰å¾…ä¸€ä¸‹è®© SDK å®Œå…¨åˆå§‹åŒ–
        await new Promise(resolve => setTimeout(resolve, 500));
      }

      try {
        // ğŸ¯ æ­¥éª¤0: æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨æ´»è·ƒé¢è¯•é—´ï¼ˆä»…åœ¨é¦–æ¬¡åˆ›å»ºæ—¶æ£€æŸ¥ï¼‰
        const urlParams = new URLSearchParams(window.location.search);
        const isRejoin = urlParams.get('room'); // å¦‚æœURLä¸­æœ‰roomå‚æ•°ï¼Œè¯´æ˜æ˜¯é‡æ–°åŠ å…¥

        const jwtToken = getJwtToken();

        // ğŸ”¥ å…³é”®ï¼šåªæœ‰åœ¨é¦–æ¬¡åˆ›å»ºï¼ˆæ²¡æœ‰roomå‚æ•°ï¼‰æ—¶æ‰æ£€æŸ¥æ´»è·ƒé¢è¯•é—´
        if (jwtToken && !isRejoin) {
          try {
            showMessage('æ­£åœ¨æ£€æŸ¥é¢è¯•é—´çŠ¶æ€...');
            console.log('ğŸ” æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨æ´»è·ƒé¢è¯•é—´...');
            const checkResponse = await fetch(window.location.origin + '/api/interview/active-room', {
              method: 'GET',
              headers: {
                'Authorization': `Bearer ${jwtToken}`
              }
            });

            if (checkResponse.ok) {
              const checkResult = await checkResponse.json();
              if (checkResult.success && checkResult.data) {
                // æ‰¾åˆ°æ´»è·ƒé¢è¯•é—´ï¼Œç›´æ¥è¿›å…¥
                const activeRoom = checkResult.data;
                console.log('âœ… æ‰¾åˆ°æ´»è·ƒé¢è¯•é—´ï¼Œç›´æ¥è¿›å…¥:', activeRoom.roomId);
                showMessage('è¿›å…¥å·²å­˜åœ¨çš„é¢è¯•é—´...');

                // è®¾ç½® roomId å¹¶é‡æ–°åŠ è½½é¡µé¢ï¼ˆå¸¦ room å‚æ•°ï¼‰
                const hostUrl = `${window.location.origin}/miniprogram/video-interview-host.html?token=${jwtToken}&room=${activeRoom.roomId}`;
                console.log('ğŸ”— é‡å®šå‘åˆ°:', hostUrl);
                window.location.href = hostUrl;
                return; // åœæ­¢æ‰§è¡Œåç»­ä»£ç 
              } else {
                console.log('â„¹ï¸ æ²¡æœ‰æ´»è·ƒé¢è¯•é—´ï¼Œåˆ›å»ºæ–°çš„');
              }
            }
          } catch (error) {
            console.warn('âš ï¸ æ£€æŸ¥æ´»è·ƒé¢è¯•é—´å¤±è´¥ï¼Œç»§ç»­åˆ›å»ºæ–°çš„:', error);
          }
        } else if (isRejoin) {
          console.log('ğŸ”„ é‡æ–°åŠ å…¥æˆ¿é—´ï¼Œè·³è¿‡æ´»è·ƒé¢è¯•é—´æ£€æŸ¥');
        }

        showMessage('æ­£åœ¨åˆ›å»ºé¢è¯•é—´...');

        // âœ… ä¼˜åŒ–ï¼šä¸å†æå‰æ£€æŸ¥æƒé™ï¼Œç›´æ¥è®© ZEGO SDK çš„ createStream ä¸€æ¬¡æ€§è¯·æ±‚æ‘„åƒå¤´å’Œéº¦å…‹é£æƒé™
        // è¿™æ ·ç”¨æˆ·åªéœ€è¦æˆæƒä¸€æ¬¡ï¼Œä½“éªŒæ›´å¥½

        // ğŸ¯ æ­¥éª¤1: è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯
        // jwtToken å·²åœ¨æ­¥éª¤0ä¸­å£°æ˜ï¼Œè¿™é‡Œç›´æ¥ä½¿ç”¨
        if (jwtToken) {
          try {
            console.log('ğŸ“± æ­£åœ¨è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯...');
            const userResponse = await fetch(window.location.origin + '/api/auth/me', {
              method: 'GET',
              headers: {
                'Authorization': `Bearer ${jwtToken}`
              }
            });

            if (userResponse.ok) {
              const userResult = await userResponse.json();
              if (userResult.success && userResult.data) {
                currentUserName = userResult.data.name || userResult.data.username || 'HR';
                console.log('âœ… è·å–åˆ°ç”¨æˆ·å§“å:', currentUserName);
              } else {
                console.warn('âš ï¸ è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤åç§°');
                currentUserName = 'HR';
              }
            } else {
              console.warn('âš ï¸ ç”¨æˆ·ä¿¡æ¯APIè°ƒç”¨å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤åç§°');
              currentUserName = 'HR';
            }
          } catch (error) {
            console.warn('âš ï¸ è·å–ç”¨æˆ·ä¿¡æ¯å¼‚å¸¸ï¼Œä½¿ç”¨é»˜è®¤åç§°:', error);
            currentUserName = 'HR';
          }
        } else {
          console.warn('âš ï¸ æœªæ‰¾åˆ°JWT Tokenï¼Œä½¿ç”¨é»˜è®¤åç§°');
          currentUserName = 'HR';
        }

        // ğŸ¯ æ­¥éª¤2: å¦‚æœURLä¸­å·²æœ‰roomIdï¼Œåˆ™ä½¿ç”¨å®ƒï¼ˆé‡æ–°åŠ å…¥æˆ¿é—´ï¼‰
        // å¦åˆ™ç”Ÿæˆæ–°çš„æˆ¿é—´å·ï¼ˆåˆ›å»ºæ–°æˆ¿é—´ï¼‰
        if (!roomId) {
          const timestamp = Date.now();
          const randomStr = Math.random().toString(36).substring(2, 8);
          roomId = `room_${timestamp}_${randomStr}`;
        } else {
          console.log('ğŸ”„ é‡æ–°åŠ å…¥å·²å­˜åœ¨çš„æˆ¿é—´:', roomId);
        }
        currentUserId = 'user_' + Date.now();

        console.log('âœ… æˆ¿é—´ä¿¡æ¯:', { roomId: roomId, userId: currentUserId, userName: currentUserName });

        // æ›´æ–°æˆ¿é—´å·æ˜¾ç¤ºï¼ˆæ ¼å¼åŒ–ä¸º AD-æ—¶é—´æˆ³ï¼Œå»æ‰åé¢çš„éšæœºå­—æ¯ï¼‰
        const displayRoomId = roomId.replace(/^room_/, 'AD-').split('_')[0];
        document.getElementById('roomId').textContent = displayRoomId;

        // ç”Ÿæˆ Token
        console.log('â³ æ­£åœ¨ç”Ÿæˆ Token...');
        const token = await generateToken(currentUserId, roomId, currentUserName);
        console.log('âœ… Token:', token ? 'Token å·²ç”Ÿæˆ' : 'ä½¿ç”¨ç©º Token');

        // ğŸ¯ æ­¥éª¤4: åˆ›å»ºé¢è¯•é—´æ•°æ®åº“è®°å½•ï¼ˆä»…åœ¨åˆ›å»ºæ–°æˆ¿é—´æ—¶ï¼‰
        // urlParams å’Œ isRejoin å·²åœ¨æ­¥éª¤0ä¸­å£°æ˜ï¼Œè¿™é‡Œç›´æ¥ä½¿ç”¨
        // jwtToken å·²åœ¨æ­¥éª¤0ä¸­å£°æ˜ï¼Œè¿™é‡Œç›´æ¥ä½¿ç”¨
        if (jwtToken && !isRejoin) {
          try {
            console.log('ğŸ’¾ æ­£åœ¨åˆ›å»ºé¢è¯•é—´æ•°æ®åº“è®°å½•...');

            // ğŸ¯ ç”Ÿæˆä¸»æŒäººé‡æ–°è¿›å…¥çš„URLï¼ˆå¸¦tokenï¼‰
            const hostUrl = `${window.location.origin}/miniprogram/video-interview-host.html?token=${jwtToken}&room=${roomId}`;
            console.log('ğŸ”— ä¸»æŒäººé‡æ–°è¿›å…¥URL:', hostUrl);

            const apiUrl = window.location.origin + '/api/interview/rooms';
            const response = await fetch(apiUrl, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${jwtToken}`
              },
              body: JSON.stringify({
                roomId: roomId,
                roomName: `${currentUserName}çš„é¢è¯•é—´`,
                hostName: currentUserName,
                hostZegoUserId: currentUserId,
                source: 'miniprogram', // æ ‡è®°æ¥æºä¸ºå°ç¨‹åºH5
                hostUrl: hostUrl // ä¿å­˜ä¸»æŒäººé‡æ–°è¿›å…¥çš„URL
              })
            });

            const result = await response.json();
            if (result.success) {
              console.log('âœ… é¢è¯•é—´æ•°æ®åº“è®°å½•å·²åˆ›å»º');
              addLog('âœ… é¢è¯•é—´è®°å½•å·²ä¿å­˜', 'success');
            } else {
              console.warn('âš ï¸ åˆ›å»ºé¢è¯•é—´è®°å½•å¤±è´¥:', result.message);
            }
          } catch (error) {
            console.warn('âš ï¸ åˆ›å»ºé¢è¯•é—´è®°å½•å¤±è´¥ï¼Œä½†ç»§ç»­åˆ›å»ºæˆ¿é—´:', error);
          }
        } else if (isRejoin) {
          console.log('ğŸ”„ é‡æ–°åŠ å…¥æˆ¿é—´ï¼Œè·³è¿‡æ•°æ®åº“è®°å½•åˆ›å»º');
          addLog('ğŸ”„ é‡æ–°åŠ å…¥å·²å­˜åœ¨çš„é¢è¯•é—´', 'info');
        } else {
          console.warn('âš ï¸ æœªæ‰¾åˆ°JWT Tokenï¼Œæ— æ³•åˆ›å»ºé¢è¯•é—´è®°å½•');
        }

        // ç™»å½•æˆ¿é—´
        console.log('â³ æ­£åœ¨ç™»å½•æˆ¿é—´...');
        addLog(`ğŸšª ä¸»æŒäººæ­£åœ¨ç™»å½•æˆ¿é—´: ${roomId}`, 'info');
        // ğŸ”¥ å…³é”®ä¿®å¤ï¼šæ·»åŠ  userUpdate: true å‚æ•°
        await zg.loginRoom(roomId, token, {
          userID: currentUserId,
          userName: currentUserName
        }, {
          userUpdate: true  // ğŸ”¥ å¼€å¯ç”¨æˆ·å’Œæµæ›´æ–°é€šçŸ¥
        });
        console.log('âœ… ç™»å½•æˆ¿é—´æˆåŠŸ');
        console.log('âœ… å·²å¼€å¯ç”¨æˆ·å’Œæµæ›´æ–°é€šçŸ¥ (userUpdate: true)');
        addLog(`âœ… ä¸»æŒäººç™»å½•æˆåŠŸ (ç”¨æˆ·ID: ${currentUserId})`, 'success');

        // ğŸ¥ åˆ›å»ºæœ¬åœ°æµï¼ˆä¸€æ¬¡æ€§è¯·æ±‚æ‘„åƒå¤´å’Œéº¦å…‹é£æƒé™ï¼‰
        console.log('ğŸ“ æ­£åœ¨è¯·æ±‚æ‘„åƒå¤´å’Œéº¦å…‹é£æƒé™...');
        showMessage('æ­£åœ¨è¯·æ±‚æ‘„åƒå¤´å’Œéº¦å…‹é£æƒé™...');

        // âœ… è®¾ç½®è§†é¢‘è´¨é‡ä¸º 720pï¼Œå¹¶é…ç½®éŸ³é¢‘å‚æ•°
        // âš ï¸ æ³¨æ„ï¼šä¸è¦åŒæ—¶å¼€å¯æ‰€æœ‰éŸ³é¢‘å¤„ç†ï¼Œå¯èƒ½å¯¼è‡´å£°éŸ³é—®é¢˜
        // ğŸ”¥ è¿™é‡Œä¼šè§¦å‘æµè§ˆå™¨çš„æƒé™è¯·æ±‚å¼¹çª—ï¼Œç”¨æˆ·åªéœ€æˆæƒä¸€æ¬¡å³å¯
        localStream = await zg.createStream({
          camera: {
            video: {
              width: 1280,
              height: 720,
              frameRate: 15,
              bitrate: 1500,
              facingMode: 'user'  // å‰ç½®æ‘„åƒå¤´
            },
            audio: true  // ä½¿ç”¨é»˜è®¤éŸ³é¢‘é…ç½®ï¼Œè®©æµè§ˆå™¨è‡ªåŠ¨å¤„ç†
          }
        });
        console.log('âœ… æƒé™æˆæƒæˆåŠŸï¼Œæœ¬åœ°æµåˆ›å»ºæˆåŠŸ');

        // ğŸ¨ å¯ç”¨åŸºç¡€ç¾é¢œï¼ˆè‡ªç„¶æ•ˆæœï¼Œä¸å¤¸å¼ ï¼Œé€‚é… 720p åˆ†è¾¨ç‡ï¼‰
        if (zg.setEffectsBeauty && typeof zg.setEffectsBeauty === 'function') {
          try {
            await zg.setEffectsBeauty(localStream, true, {
              smoothIntensity: 35,   // é€‚åº¦ç£¨çš®
              whitenIntensity: 25,   // é€‚åº¦ç¾ç™½
              rosyIntensity: 20,     // é€‚åº¦çº¢æ¶¦
              sharpenIntensity: 30   // é€‚åº¦é”åŒ–ï¼ˆ720p éœ€è¦é€‚åº¦é”åŒ–ï¼‰
            });
            console.log('âœ… åŸºç¡€ç¾é¢œå·²å¯ç”¨ - è‡ªç„¶ä¸å¤¸å¼ çš„ç¾é¢œæ•ˆæœ');
            // ç§»é™¤ç¾é¢œå¼€å¯çš„ç”¨æˆ·æç¤ºï¼Œé™é»˜å¯ç”¨
          } catch (error) {
            console.warn('âš ï¸ ç¾é¢œå¯ç”¨å¤±è´¥:', error);
            // ç¾é¢œå¤±è´¥ä¸å½±å“æ­£å¸¸é€šè¯ï¼Œç»§ç»­æ‰§è¡Œ
          }
        } else {
          console.log('â„¹ï¸ å½“å‰ SDK ç‰ˆæœ¬ä¸æ”¯æŒç¾é¢œåŠŸèƒ½');
        }

        // âœ… ç¡®ä¿éŸ³é¢‘è½¨é“å·²å¯ç”¨
        const audioTracks = localStream.getAudioTracks();
        console.log('ğŸ¤ éŸ³é¢‘è½¨é“æ•°é‡:', audioTracks.length);
        audioTracks.forEach((track, index) => {
          console.log(`ğŸ¤ éŸ³é¢‘è½¨é“ ${index}:`, {
            enabled: track.enabled,
            muted: track.muted,
            readyState: track.readyState,
            label: track.label
          });
          // ç¡®ä¿éŸ³é¢‘è½¨é“å·²å¯ç”¨
          track.enabled = true;
        });

        // æ’­æ”¾æœ¬åœ°è§†é¢‘
        const localVideo = document.getElementById('localVideo');
        localVideo.srcObject = localStream;

        // âœ… iOSä¿®å¤ï¼šæ˜¾å¼è°ƒç”¨play()ç¡®ä¿æœ¬åœ°è§†é¢‘æ˜¾ç¤º
        try {
          await localVideo.play();
          console.log('âœ… æœ¬åœ°è§†é¢‘æ’­æ”¾æˆåŠŸ');
        } catch (error) {
          console.error('âŒ æœ¬åœ°è§†é¢‘æ’­æ”¾å¤±è´¥:', error);
          // iOSå¯èƒ½éœ€è¦ç”¨æˆ·äº¤äº’ï¼Œä½†æœ¬åœ°è§†é¢‘é€šå¸¸å¯ä»¥è‡ªåŠ¨æ’­æ”¾ï¼ˆå› ä¸ºæ˜¯mutedçš„ï¼‰
        }

        // æ›´æ–°æœ¬åœ°æ ‡ç­¾
        document.getElementById('localLabel').textContent = 'ä¸»æŒäºº';

        // æ¨æµ
        currentStreamId = 'stream_' + currentUserId;
        console.log('æ­£åœ¨æ¨æµ:', currentStreamId);
        addLog(`ğŸ“¤ ä¸»æŒäººå¼€å§‹æ¨æµ: ${currentStreamId}`, 'info');
        await zg.startPublishingStream(currentStreamId, localStream);
        console.log('æ¨æµæˆåŠŸ');
        addLog(`âœ… ä¸»æŒäººæ¨æµæˆåŠŸ`, 'success');

        // éšè—åŠ å…¥é¢æ¿ï¼Œæ˜¾ç¤ºä¸»ç•Œé¢
        document.getElementById('joinPanel').classList.add('hidden');

        // å¼€å§‹è®¡æ—¶
        startTimer();

        hideMessage();
        console.log('âœ… é¢è¯•é—´åˆ›å»ºæˆåŠŸ');

        // ğŸ”¥ é€šçŸ¥å°ç¨‹åºé¡µé¢ï¼ˆç”¨äºåˆ†äº«ï¼‰
        try {
          notifyMiniProgram(roomId);
        } catch (notifyError) {
          console.warn('âš ï¸ é€šçŸ¥å°ç¨‹åºå¤±è´¥:', notifyError);
        }
      } catch (error) {
        console.error('âŒ åˆ›å»ºé¢è¯•é—´å¤±è´¥:', error);
        hideMessage();
        showToast('åˆ›å»ºé¢è¯•é—´å¤±è´¥: ' + (error.message || error.toString() || 'æœªçŸ¥é”™è¯¯'), 'error', 3000);
      }
    }

    // ==================== åŠ å…¥æˆ¿é—´ ====================
    async function joinRoom() {
      const userName = document.getElementById('userName').value.trim();
      if (!userName) {
        showToast('è¯·è¾“å…¥æ‚¨çš„å§“å', 'warning', 2000);
        return;
      }

      if (!currentUserRole) {
        showToast('è¯·é€‰æ‹©æ‚¨çš„èº«ä»½', 'warning', 2000);
        return;
      }

      // æ£€æŸ¥ ZEGO SDK æ˜¯å¦å·²åˆå§‹åŒ–
      if (!zg) {
        console.error('ZEGO SDK æœªåˆå§‹åŒ–');
        showToast('è§†é¢‘SDKæœªåˆå§‹åŒ–ï¼Œæ­£åœ¨é‡æ–°åˆå§‹åŒ–...', 'warning', 2000);
        const success = initZego();
        if (!success) {
          return;
        }
        // ç­‰å¾…ä¸€ä¸‹è®© SDK å®Œå…¨åˆå§‹åŒ–
        await new Promise(resolve => setTimeout(resolve, 500));
      }

      try {
        showMessage('æ­£åœ¨åŠ å…¥æˆ¿é—´...');

        // âœ… å…³é”®ä¿®å¤ï¼šä¸è¦æå‰æ£€æŸ¥æƒé™ï¼Œç›´æ¥è®©ZEGO SDKå¤„ç†
        // iOSå¾®ä¿¡ä¸­ï¼Œæå‰è°ƒç”¨getUserMediaå†åœæ­¢ä¼šå¯¼è‡´åç»­æ— æ³•æ­£å¸¸è·å–éŸ³è§†é¢‘

        // ç”Ÿæˆç”¨æˆ·ID
        currentUserId = 'user_' + Date.now();
        currentUserName = userName;

        console.log('âœ… ç”¨æˆ·ä¿¡æ¯:', { userId: currentUserId, userName: currentUserName, roomId: roomId, role: currentUserRole });

        // æ£€æŸ¥æˆ¿é—´å·
        if (!roomId || roomId === 'test_room') {
          throw new Error('æˆ¿é—´å·æ— æ•ˆï¼Œè¯·é€šè¿‡æ­£ç¡®çš„é“¾æ¥è¿›å…¥');
        }

        // ç”Ÿæˆ Token
        console.log('â³ æ­£åœ¨ç”Ÿæˆ Token...');
        const token = await generateToken(currentUserId);
        console.log('âœ… Token:', token ? 'Token å·²ç”Ÿæˆ' : 'ä½¿ç”¨ç©º Token');

        // ç™»å½•æˆ¿é—´
        console.log('â³ æ­£åœ¨ç™»å½•æˆ¿é—´...');
        console.log('â³ ç™»å½•å‚æ•°:', { roomId, token: token ? 'å·²ç”Ÿæˆ' : 'ç©º', userID: currentUserId, userName: currentUserName });

        // ğŸ”¥ å…³é”®ä¿®å¤ï¼šæ·»åŠ  userUpdate: true å‚æ•°
        await zg.loginRoom(roomId, token, {
          userID: currentUserId,
          userName: currentUserName
        }, {
          userUpdate: true  // ğŸ”¥ å¼€å¯ç”¨æˆ·å’Œæµæ›´æ–°é€šçŸ¥
        });
        console.log('âœ… ç™»å½•æˆ¿é—´æˆåŠŸ');
        console.log('âœ… å·²å¼€å¯ç”¨æˆ·å’Œæµæ›´æ–°é€šçŸ¥ (userUpdate: true)');

        // åˆ›å»ºæœ¬åœ°æµï¼ˆä½¿ç”¨ç®€å•é…ç½®ï¼Œä¸PCç«¯ä¸€è‡´ï¼‰
        console.log('â³ æ­£åœ¨åˆ›å»ºæœ¬åœ°æµ...');
        localStream = await zg.createStream({
          camera: {
            video: true,  // ä½¿ç”¨é»˜è®¤è§†é¢‘é…ç½®
            audio: true   // ä½¿ç”¨é»˜è®¤éŸ³é¢‘é…ç½®
          }
        });
        console.log('âœ… åˆ›å»ºæœ¬åœ°æµæˆåŠŸ');

        // æ’­æ”¾æœ¬åœ°è§†é¢‘ï¼ˆä¸PCç«¯ä¸€è‡´ï¼‰
        const localVideo = document.getElementById('localVideo');
        localVideo.srcObject = localStream;

        // æ›´æ–°æœ¬åœ°æ ‡ç­¾ï¼ˆæ˜¾ç¤ºèº«ä»½ + å§“åï¼‰
        const roleText = currentUserRole === 'customer' ? 'å®¢æˆ·' : 'é˜¿å§¨';
        document.getElementById('localLabel').textContent = `${roleText}ï¼š${userName}`;

        // æ¨æµ
        const streamID = 'stream_' + currentUserId;
        console.log('æ­£åœ¨æ¨æµ:', streamID);
        await zg.startPublishingStream(streamID, localStream);
        console.log('æ¨æµæˆåŠŸ');
        
        // éšè—åŠ å…¥é¢æ¿
        document.getElementById('joinPanel').style.display = 'none';
        hideMessage();

        // å¯åŠ¨é¢è¯•è®¡æ—¶å™¨
        startInterviewTimer();

      } catch (error) {
        console.error('âŒ åŠ å…¥æˆ¿é—´å¤±è´¥:', error);
        console.error('âŒ é”™è¯¯è¯¦æƒ…:', {
          message: error.message,
          code: error.code,
          name: error.name,
          stack: error.stack
        });

        let errorMsg = 'åŠ å…¥æˆ¿é—´å¤±è´¥';
        if (error.message) {
          errorMsg += ': ' + error.message;
        } else if (error.code) {
          errorMsg += ': é”™è¯¯ä»£ç  ' + error.code;
        } else {
          errorMsg += ': ' + JSON.stringify(error);
        }

        showToast(errorMsg, 'error', 3000);
        hideMessage();
      }
    }

    // ==================== æ’­æ”¾è¿œç¨‹æµ ====================
    async function playRemoteStream(stream) {
      console.log('â–¶ï¸ æ’­æ”¾è¿œç¨‹æµ:', stream);
      const userName = stream.user?.userName || 'è®¿å®¢';
      addLog(`ğŸ“º å¼€å§‹æ’­æ”¾è¿œç¨‹æµ: ${userName} (${stream.streamID})`, 'info');

      try {
        // ğŸ”¥ å…³é”®ä¿®å¤ï¼šæ£€æŸ¥æ˜¯å¦å·²ç»åœ¨æ’­æ”¾è¿™ä¸ªæµ
        if (remoteStreams[stream.streamID]) {
          console.log('âš ï¸ æµå·²å­˜åœ¨ï¼Œè·³è¿‡:', stream.streamID);
          addLog(`âš ï¸ æµå·²å­˜åœ¨ï¼Œè·³è¿‡: ${userName}`, 'warning');
          return;
        }

        // ğŸ”¥ å…³é”®ä¿®å¤ï¼šæ‰¾åˆ°çœŸæ­£ç©ºé—²çš„è§†é¢‘ä½ç½®
        // æ£€æŸ¥ DOM çš„ data-stream-id å±æ€§æ¥åˆ¤æ–­å®¹å™¨æ˜¯å¦è¢«å ç”¨
        let emptyBoxIndex = -1;
        for (let i = 1; i <= 5; i++) {
          const box = document.getElementById(`remoteBox${i}`);
          // æ£€æŸ¥è¿™ä¸ªå®¹å™¨æ˜¯å¦å·²ç»æœ‰ data-stream-id å±æ€§
          const streamId = box.getAttribute('data-stream-id');

          if (!streamId || streamId === '') {
            // è¿™ä¸ªå®¹å™¨æ²¡æœ‰ data-stream-idï¼Œè¯´æ˜æ˜¯ç©ºçš„
            emptyBoxIndex = i;
            console.log(`âœ… æ‰¾åˆ°ç©ºä½: remoteBox${i}`);
            addLog(`âœ… åˆ†é…å®¹å™¨ä½ç½®${i}ç»™: ${userName}`, 'info');
            break;
          } else {
            console.log(`âš ï¸ remoteBox${i} å·²è¢«å ç”¨ï¼ŒstreamId: ${streamId}`);
          }
        }

        if (emptyBoxIndex === -1) {
          console.warn('âš ï¸ æ²¡æœ‰ç©ºä½äº†');
          addLog(`âš ï¸ æ²¡æœ‰ç©ºä½ï¼Œæ— æ³•æ’­æ”¾: ${userName}`, 'warning');
          return;
        }

        const i = emptyBoxIndex;
        const box = document.getElementById(`remoteBox${i}`);

        // ğŸ”¥ å½»åº•æ¸…ç†å®¹å™¨
        const oldVideos = box.querySelectorAll('video');
        oldVideos.forEach(video => {
          video.pause();
          video.srcObject = null;
          video.src = '';
        });

        // è½¬æ¢ç”¨æˆ·åä¸­çš„è‹±æ–‡è§’è‰²ä¸ºä¸­æ–‡
        let displayName = stream.user.userName || 'è®¿å®¢';
        // å¤„ç†ä¸¤ç§æƒ…å†µï¼š1. "customer-å¼ ä¸‰" 2. "customer"ï¼ˆæ²¡æœ‰å§“åï¼‰
        if (displayName === 'customer') {
          displayName = 'å®¢æˆ·';
        } else if (displayName === 'helper') {
          displayName = 'é˜¿å§¨';
        } else {
          displayName = displayName.replace(/^customer-/, 'å®¢æˆ·-').replace(/^helper-/, 'é˜¿å§¨-');
        }

        // âœ… åˆ›å»ºå”¯ä¸€çš„video ID
        const videoId = `remote${i}`;

        // âœ… è¿œç¨‹è§†é¢‘ä¸åº”è¯¥é™éŸ³ï¼åªæœ‰æœ¬åœ°é¢„è§ˆæ‰éœ€è¦é™éŸ³
        // âœ… iOSä¿®å¤ï¼šæ·»åŠ æ‰€æœ‰å¿…è¦çš„å±æ€§ç¡®ä¿è§†é¢‘å’ŒéŸ³é¢‘æ­£å¸¸æ’­æ”¾
        box.innerHTML = `
          <video id="${videoId}" class="video-player" autoplay playsinline webkit-playsinline x5-playsinline x-webkit-airplay="allow" x5-video-player-type="h5" x5-video-player-fullscreen="false"></video>
          <div class="video-label">${displayName}</div>
          <div class="manage-btn" onclick="toggleManageMenu(event, '${stream.streamID}', '${stream.user.userID}')">
            <div class="manage-icon">â‹®</div>
          </div>
          <div class="manage-menu" id="menu_${stream.streamID}">
            <div class="manage-menu-item" onclick="remoteControlCamera('${stream.user.userID}', false)">
              <span class="manage-menu-icon">ğŸ“¹</span>
              <span>å…³é—­æ‘„åƒå¤´</span>
            </div>
            <div class="manage-menu-item" onclick="remoteControlMic('${stream.user.userID}', false)">
              <span class="manage-menu-icon">ğŸ¤</span>
              <span>å…³é—­éº¦å…‹é£</span>
            </div>
            <div class="manage-menu-item danger" onclick="kickUser('${stream.user.userID}', '${displayName}')">
              <span class="manage-menu-icon">ğŸšª</span>
              <span>ç§»å‡ºé¢è¯•é—´</span>
            </div>
          </div>
        `;

        const video = document.getElementById(videoId);

        // ğŸ”Š å…³é”®ä¿®å¤ï¼šæ˜¾å¼è®¾ç½®è¿œç¨‹è§†é¢‘éŸ³é‡ä¸ºæœ€å¤§ï¼ˆ1.0ï¼‰
        video.volume = 1.0;
        // âœ… ç¡®ä¿ä¸é™éŸ³ï¼ˆè¿™æ˜¯å…³é”®ï¼ï¼‰
        video.muted = false;
        console.log('ğŸ”Š è®¾ç½®è¿œç¨‹è§†é¢‘éŸ³é‡ä¸º:', video.volume, 'é™éŸ³çŠ¶æ€:', video.muted);

        // âœ…âœ…âœ… ä½¿ç”¨ZEGOå®˜æ–¹æ¨èæ–¹å¼ï¼šè®©SDKè‡ªåŠ¨å¤„ç†iOSå…¼å®¹æ€§
        // è¿™æ˜¯ZEGOå®˜æ–¹æ–‡æ¡£æ¨èçš„æœ€ä½³å®è·µï¼ŒSDKä¼šè‡ªåŠ¨å¤„ç†ï¼š
        // 1. iOS autoplayç­–ç•¥
        // 2. ç”¨æˆ·äº¤äº’è¦æ±‚
        // 3. è‡ªåŠ¨é‡è¯•æœºåˆ¶
        // 4. è®¾å¤‡å ç”¨æ£€æµ‹

        // å®šä¹‰æ’­æ”¾å‡½æ•°ï¼ˆæ”¯æŒè‡ªåŠ¨é‡è¯•ï¼‰
        const playStream = async (retryCount = 0, maxRetries = 3) => {
          try {
            console.log(`ğŸ¬ å°è¯•æ’­æ”¾è¿œç¨‹æµ (ç¬¬${retryCount + 1}æ¬¡):`, stream.streamID);

                // ğŸ”¥ iOS ä¿®å¤ï¼šä¸ä¼  video å…ƒç´ ç»™ SDKï¼Œæ‰‹åŠ¨å¤„ç†æ‰€æœ‰æ­¥éª¤
                // è¿™æ ·å¯ä»¥ç¡®ä¿åœ¨ iOS ä¸Šæ­£ç¡®è®¾ç½® srcObject å’Œè°ƒç”¨ play()
                const remoteStream = await zg.startPlayingStream(stream.streamID);

                console.log('âœ… SDK è¿”å›è¿œç¨‹æµ:', remoteStream);
                console.log('ğŸ“¹ è¿œç¨‹æµè§†é¢‘è½¨é“æ•°é‡:', remoteStream.getVideoTracks().length);
                console.log('ğŸ¤ è¿œç¨‹æµéŸ³é¢‘è½¨é“æ•°é‡:', remoteStream.getAudioTracks().length);

                remoteStream.getVideoTracks().forEach((track, index) => {
                  console.log(`ğŸ“¹ è¿œç¨‹è§†é¢‘è½¨é“ ${index}:`, {
                    enabled: track.enabled,
                    muted: track.muted,
                    readyState: track.readyState,
                    label: track.label
                  });
                });
                remoteStream.getAudioTracks().forEach((track, index) => {
                  console.log(`ğŸ¤ è¿œç¨‹éŸ³é¢‘è½¨é“ ${index}:`, {
                    enabled: track.enabled,
                    muted: track.muted,
                    readyState: track.readyState,
                    label: track.label
                  });
                });

                // ğŸ”¥ æ‰‹åŠ¨è®¾ç½® srcObjectï¼ˆiOS å…³é”®æ­¥éª¤ï¼‰
                video.srcObject = remoteStream;
                console.log('âœ… å·²è®¾ç½® srcObject');

                // ğŸ”¥ iOS å…³é”®ä¿®å¤ï¼šè®¾ç½®éŸ³é¢‘å±æ€§å¹¶æ˜¾å¼è°ƒç”¨ play()
                video.muted = false;  // ç¡®ä¿ä¸é™éŸ³
                video.volume = 1;     // ç¡®ä¿éŸ³é‡æœ€å¤§
                video.playsInline = true;  // iOS å†…è”æ’­æ”¾
                video.autoplay = true;     // è‡ªåŠ¨æ’­æ”¾

                console.log('ğŸ”Š Videoå…ƒç´ é…ç½® - éŸ³é‡:', video.volume, 'é™éŸ³:', video.muted, 'playsInline:', video.playsInline);

                // æ˜¾å¼è°ƒç”¨ play()
                try {
                  await video.play();
                  console.log('âœ… iOSä¿®å¤ï¼šæ˜¾å¼è°ƒç”¨ play() æˆåŠŸ');
                } catch (playError) {
                  console.warn('âš ï¸ iOSä¿®å¤ï¼šplay() è°ƒç”¨å¤±è´¥:', playError.message);
                  // å¦‚æœ play() å¤±è´¥ï¼Œå¯èƒ½éœ€è¦ç”¨æˆ·äº¤äº’
                  if (playError.name === 'NotAllowedError') {
                    console.log('âš ï¸ éœ€è¦ç”¨æˆ·äº¤äº’æ‰èƒ½æ’­æ”¾');
                  }
                }

                remoteStreams[stream.streamID] = remoteStream;
                console.log('âœ… è¿œç¨‹è§†é¢‘æ’­æ”¾æˆåŠŸ:', stream.streamID);
                addLog(`âœ… è¿œç¨‹æµæ’­æ”¾æˆåŠŸ: ${displayName} (ä½ç½®${i})`, 'success');

                return true;

              } catch (error) {
                console.warn(`âš ï¸ æ’­æ”¾å¤±è´¥ (ç¬¬${retryCount + 1}æ¬¡):`, error.name, error.message);

                // âœ… iOSä¿®å¤ï¼šå¦‚æœæ˜¯è‡ªåŠ¨æ’­æ”¾ç­–ç•¥é—®é¢˜ï¼Œæç¤ºç”¨æˆ·ç‚¹å‡»æ’­æ”¾
                if (error.name === 'NotAllowedError' || error.name === 'NotSupportedError') {
                  console.log('âš ï¸ éœ€è¦ç”¨æˆ·äº¤äº’æ‰èƒ½æ’­æ”¾ï¼Œæ˜¾ç¤ºæ’­æ”¾æŒ‰é’®');

                  // åˆ›å»ºæ’­æ”¾æŒ‰é’®è¦†ç›–å±‚
                  const playButton = document.createElement('div');
                  playButton.style.cssText = `
                    position: absolute;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    background: rgba(0, 0, 0, 0.7);
                    color: white;
                    padding: 15px 30px;
                    border-radius: 25px;
                    cursor: pointer;
                    font-size: 16px;
                    z-index: 100;
                    display: flex;
                    align-items: center;
                    gap: 10px;
                  `;
                  playButton.innerHTML = 'â–¶ï¸ ç‚¹å‡»æ’­æ”¾è§†é¢‘';

                  box.style.position = 'relative';
                  box.appendChild(playButton);

                  // ç‚¹å‡»æ’­æ”¾æŒ‰é’®æ—¶é‡æ–°å°è¯•æ’­æ”¾
                  playButton.onclick = async () => {
                    try {
                      // ç”¨æˆ·äº¤äº’åï¼Œé‡æ–°è°ƒç”¨SDKæ’­æ”¾
                      await zg.startPlayingStream(stream.streamID, {
                        video: video,
                        audio: true
                      });
                      console.log('âœ… ç”¨æˆ·ç‚¹å‡»åè§†é¢‘æ’­æ”¾æˆåŠŸ');
                      playButton.remove();
                    } catch (e) {
                      console.error('âŒ ç”¨æˆ·ç‚¹å‡»åä»ç„¶æ’­æ”¾å¤±è´¥:', e);
                      showToast('æ’­æ”¾å¤±è´¥ï¼Œè¯·æ£€æŸ¥æµè§ˆå™¨æƒé™è®¾ç½®æˆ–åˆ·æ–°é¡µé¢é‡è¯•', 'error', 3000);
                    }
                  };

                  return false;

                } else if (retryCount < maxRetries) {
                  // âœ… è‡ªåŠ¨é‡è¯•æœºåˆ¶ï¼šå…¶ä»–é”™è¯¯è‡ªåŠ¨é‡è¯•
                  console.log(`ğŸ”„ ${(retryCount + 1) * 1000}msåè‡ªåŠ¨é‡è¯•...`);
                  await new Promise(resolve => setTimeout(resolve, (retryCount + 1) * 1000));
                  return await playStream(retryCount + 1, maxRetries);

                } else {
                  // âœ… é™çº§æ–¹æ¡ˆï¼šå°è¯•æ—§æ–¹å¼ï¼ˆæ‰‹åŠ¨è®¾ç½®srcObjectï¼‰
                  console.log('ğŸ”„ å°è¯•é™çº§æ–¹æ¡ˆï¼ˆæ‰‹åŠ¨è®¾ç½®srcObjectï¼‰...');
                  try {
                    const remoteStream = await zg.startPlayingStream(stream.streamID);
                    video.srcObject = remoteStream;
                    remoteStreams[stream.streamID] = remoteStream;

                    await video.play();
                    console.log('âœ… é™çº§æ–¹æ¡ˆæ’­æ”¾æˆåŠŸ:', stream.streamID);
                    return true;

                  } catch (e) {
                    console.error('âŒ é™çº§æ–¹æ¡ˆä¹Ÿå¤±è´¥äº†:', e.name, e.message);
                    showToast('æ’­æ”¾è¿œç¨‹è§†é¢‘å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•', 'error', 3000);
                    return false;
                  }
                }
              }
            };

        // æ‰§è¡Œæ’­æ”¾
        await playStream();

        // ä¿å­˜streamIDå’ŒuserIDåˆ°boxçš„dataå±æ€§ï¼Œæ–¹ä¾¿åç»­æŸ¥æ‰¾
        box.setAttribute('data-stream-id', stream.streamID);
        box.setAttribute('data-user-id', stream.user.userID);

        console.log('âœ… è¿œç¨‹æµæ’­æ”¾æˆåŠŸ');
      } catch (error) {
        console.error('âŒ æ’­æ”¾è¿œç¨‹æµå¤±è´¥:', error);
      }
    }

    // ==================== ç§»é™¤è¿œç¨‹æµ ====================
    function removeRemoteStream(streamID) {
      console.log('ğŸ—‘ï¸ ç§»é™¤è¿œç¨‹æµ:', streamID);
      addLog(`ğŸ—‘ï¸ ç§»é™¤è¿œç¨‹æµ: ${streamID}`, 'warning');

      // åœæ­¢æ’­æ”¾æµ
      if (remoteStreams[streamID]) {
        try {
          zg.stopPlayingStream(streamID);
          console.log('âœ… å·²åœæ­¢æ’­æ”¾æµ:', streamID);
          addLog(`âœ… å·²åœæ­¢æ’­æ”¾æµ: ${streamID}`, 'success');
        } catch (error) {
          console.error('åœæ­¢æ’­æ”¾æµå¤±è´¥:', error);
          addLog(`âŒ åœæ­¢æ’­æ”¾æµå¤±è´¥: ${error.message}`, 'error');
        }
        delete remoteStreams[streamID];
      }

      // ğŸ”¥ å½»åº•æ¸…ç†å®¹å™¨
      for (let i = 1; i <= 5; i++) {
        const box = document.getElementById(`remoteBox${i}`);
        if (box.getAttribute('data-stream-id') === streamID) {
          console.log(`ğŸ§¹ æ¸…ç†è§†é¢‘å®¹å™¨ remoteBox${i}`);
          addLog(`ğŸ§¹ æ¸…ç†å®¹å™¨ä½ç½®${i}`, 'info');

          // ğŸ”¥ å½»åº•æ¸…ç†æ‰€æœ‰ video å…ƒç´ 
          const videos = box.querySelectorAll('video');
          videos.forEach(video => {
            video.pause();
            video.srcObject = null;
            video.src = '';
            video.load(); // é‡ç½®videoå…ƒç´ 
          });

          // ğŸ”¥ ç§»é™¤æ‰€æœ‰å­å…ƒç´ 
          while (box.firstChild) {
            box.removeChild(box.firstChild);
          }

          // ç§»é™¤å±æ€§
          box.removeAttribute('data-stream-id');
          box.removeAttribute('data-user-id');

          // æ¢å¤å ä½ç¬¦
          box.innerHTML = `
            <div class="video-placeholder empty-slot">
              <div class="placeholder-icon">ğŸ‘¤</div>
              <div class="placeholder-text">ç­‰å¾…åŠ å…¥</div>
            </div>
          `;

          console.log(`âœ… è§†é¢‘å®¹å™¨ remoteBox${i} å·²å½»åº•æ¸…ç†`);
          addLog(`âœ… å®¹å™¨ä½ç½®${i}å·²é‡Šæ”¾`, 'success');
          break;
        }
      }
    }

    // ==================== é¢è¯•è®¡æ—¶å™¨ ====================
    function startInterviewTimer() {
      interviewStartTime = Date.now();
      interviewTimer = setInterval(() => {
        const elapsed = Math.floor((Date.now() - interviewStartTime) / 1000);
        const minutes = Math.floor(elapsed / 60);
        const seconds = elapsed % 60;
        const timeStr = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        document.getElementById('interviewTime').textContent = timeStr;
      }, 1000);
    }

    function stopInterviewTimer() {
      if (interviewTimer) {
        clearInterval(interviewTimer);
        interviewTimer = null;
      }
    }
    
    // ==================== æ§åˆ¶åŠŸèƒ½ ====================
    function toggleMic() {
      if (!localStream) return;

      isMicOn = !isMicOn;
      zg.muteMicrophone(!isMicOn);

      const btn = document.getElementById('micBtn');
      const iconText = btn.querySelector('.control-icon-text');
      const label = btn.querySelector('.control-label');

      if (isMicOn) {
        btn.classList.remove('disabled');
        iconText.textContent = 'ğŸ¤';
        label.textContent = 'éº¦å…‹é£';
      } else {
        btn.classList.add('disabled');
        iconText.textContent = 'ğŸ¤';
        label.textContent = 'å·²é™éŸ³';
      }

      console.log('éº¦å…‹é£:', isMicOn ? 'å¼€å¯' : 'å…³é—­');
    }

    function toggleCamera() {
      if (!localStream) return;

      isCameraOn = !isCameraOn;
      zg.mutePublishStreamVideo(localStream, !isCameraOn);

      const btn = document.getElementById('cameraBtn');
      const iconText = btn.querySelector('.control-icon-text');
      const label = btn.querySelector('.control-label');

      if (isCameraOn) {
        btn.classList.remove('disabled');
        iconText.textContent = 'ğŸ“¹';
        label.textContent = 'æ‘„åƒå¤´';
      } else {
        btn.classList.add('disabled');
        iconText.textContent = 'ğŸ“¹';
        label.textContent = 'å·²å…³é—­';
      }

      console.log('æ‘„åƒå¤´:', isCameraOn ? 'å¼€å¯' : 'å…³é—­');
    }

    // ==================== ç®¡ç†åŠŸèƒ½ ====================
    // åˆ‡æ¢ç®¡ç†èœå•
    function toggleManageMenu(event, streamId, userId) {
      console.log('ğŸ“‹ toggleManageMenu è¢«è°ƒç”¨:', { streamId, userId });
      event.stopPropagation();

      const menu = document.getElementById(`menu_${streamId}`);
      console.log('ğŸ“‹ èœå•å…ƒç´ :', menu);

      const allMenus = document.querySelectorAll('.manage-menu');

      // å…³é—­å…¶ä»–èœå•
      allMenus.forEach(m => {
        if (m !== menu) {
          m.classList.remove('show');
        }
      });

      // åˆ‡æ¢å½“å‰èœå•
      menu.classList.toggle('show');
      console.log('ğŸ“‹ èœå•æ˜¾ç¤ºçŠ¶æ€:', menu.classList.contains('show'));
    }

    // ç‚¹å‡»å…¶ä»–åœ°æ–¹å…³é—­èœå•
    document.addEventListener('click', () => {
      const allMenus = document.querySelectorAll('.manage-menu');
      allMenus.forEach(m => m.classList.remove('show'));
    });

    // è¿œç¨‹æ§åˆ¶æ‘„åƒå¤´
    async function remoteControlCamera(targetUserId, enabled) {
      try {
        const jwtToken = getJwtToken();
        if (!jwtToken) {
          showToast('æœªæ‰¾åˆ°è®¤è¯ä¿¡æ¯', 'error', 3000);
          return;
        }

        console.log('ğŸ® è¿œç¨‹æ§åˆ¶æ‘„åƒå¤´:', {
          roomId: roomId,
          hostUserId: currentUserId,
          targetUserId: targetUserId,
          controlType: 'camera',
          enabled: enabled
        });

        const response = await fetch('/api/zego/remote-control', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${jwtToken}`
          },
          body: JSON.stringify({
            roomId: roomId,
            hostUserId: currentUserId,
            targetUserId: targetUserId,
            controlType: 'camera',
            enabled: enabled
          })
        });

        const result = await response.json();
        if (result.success) {
          console.log('âœ… è¿œç¨‹æ§åˆ¶æ‘„åƒå¤´æˆåŠŸ');
          showToast(enabled ? 'âœ… å·²å¼€å¯å¯¹æ–¹æ‘„åƒå¤´' : 'âœ… å·²å…³é—­å¯¹æ–¹æ‘„åƒå¤´', 'success', 2000);
        } else {
          console.error('âŒ è¿œç¨‹æ§åˆ¶æ‘„åƒå¤´å¤±è´¥:', result.message);
          showToast('æ“ä½œå¤±è´¥: ' + result.message, 'error', 3000);
        }
      } catch (error) {
        console.error('âŒ è¿œç¨‹æ§åˆ¶æ‘„åƒå¤´å¤±è´¥:', error);
        showToast('æ“ä½œå¤±è´¥: ' + error.message, 'error', 3000);
      }
    }

    // è¿œç¨‹æ§åˆ¶éº¦å…‹é£
    async function remoteControlMic(targetUserId, enabled) {
      try {
        const jwtToken = getJwtToken();
        if (!jwtToken) {
          showToast('æœªæ‰¾åˆ°è®¤è¯ä¿¡æ¯', 'error', 3000);
          return;
        }

        console.log('ğŸ® è¿œç¨‹æ§åˆ¶éº¦å…‹é£:', {
          roomId: roomId,
          hostUserId: currentUserId,
          targetUserId: targetUserId,
          controlType: 'microphone',
          enabled: enabled
        });

        const response = await fetch('/api/zego/remote-control', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${jwtToken}`
          },
          body: JSON.stringify({
            roomId: roomId,
            hostUserId: currentUserId,
            targetUserId: targetUserId,
            controlType: 'microphone',
            enabled: enabled
          })
        });

        const result = await response.json();
        if (result.success) {
          console.log('âœ… è¿œç¨‹æ§åˆ¶éº¦å…‹é£æˆåŠŸ');
          showToast(enabled ? 'âœ… å·²å¼€å¯å¯¹æ–¹éº¦å…‹é£' : 'âœ… å·²å…³é—­å¯¹æ–¹éº¦å…‹é£', 'success', 2000);
        } else {
          console.error('âŒ è¿œç¨‹æ§åˆ¶éº¦å…‹é£å¤±è´¥:', result.message);
          showToast('æ“ä½œå¤±è´¥: ' + result.message, 'error', 3000);
        }
      } catch (error) {
        console.error('âŒ è¿œç¨‹æ§åˆ¶éº¦å…‹é£å¤±è´¥:', error);
        showToast('æ“ä½œå¤±è´¥: ' + error.message, 'error', 3000);
      }
    }

    // è¸¢å‡ºç”¨æˆ·
    async function kickUser(targetUserId, userName) {
      console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
      console.log('ğŸšª kickUser å‡½æ•°è¢«è°ƒç”¨ï¼');
      console.log('ğŸ“ targetUserId:', targetUserId);
      console.log('ğŸ“ userName:', userName);
      console.log('ğŸ“ currentUserId:', currentUserId);
      console.log('ğŸ“ roomId:', roomId);
      console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');

      // âœ… ä½¿ç”¨è‡ªå®šä¹‰ç¡®è®¤å¼¹çª—æ›¿ä»£ confirm()
      showKickUserModal(targetUserId, userName);
    }

    // âœ… æ˜¾ç¤ºè¸¢å‡ºç”¨æˆ·ç¡®è®¤å¼¹çª—
    function showKickUserModal(targetUserId, userName) {
      // åˆ›å»ºé®ç½©å±‚
      const overlay = document.createElement('div');
      overlay.id = 'kickUserOverlay';
      overlay.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.7);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
      `;

      // åˆ›å»ºå¼¹çª—
      const modal = document.createElement('div');
      modal.style.cssText = `
        background: white;
        border-radius: 12px;
        padding: 30px;
        max-width: 400px;
        width: 90%;
        text-align: center;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
      `;

      modal.innerHTML = `
        <div style="font-size: 48px; margin-bottom: 20px;">âš ï¸</div>
        <h2 style="margin: 0 0 15px 0; font-size: 20px; color: #333;">ç¡®å®šè¦ç§»å‡ºæ­¤ç”¨æˆ·å—ï¼Ÿ</h2>
        <p style="margin: 0 0 25px 0; font-size: 16px; color: #666;">${userName}</p>
        <div style="display: flex; gap: 12px;">
          <button id="cancelKickBtn" style="flex: 1; background: #f5f5f5; color: #666; border: none; padding: 12px 24px;
                         border-radius: 8px; font-size: 16px; cursor: pointer;">
            å–æ¶ˆ
          </button>
          <button id="confirmKickBtn" style="flex: 1; background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%); color: white; border: none; padding: 12px 24px;
                         border-radius: 8px; font-size: 16px; cursor: pointer;">
            ç¡®å®šç§»å‡º
          </button>
        </div>
      `;

      overlay.appendChild(modal);
      document.body.appendChild(overlay);

      // ç»‘å®šæŒ‰é’®äº‹ä»¶
      document.getElementById('cancelKickBtn').onclick = () => {
        overlay.remove();
        console.log('âŒ ç”¨æˆ·å–æ¶ˆäº†è¸¢å‡ºæ“ä½œ');
      };
      document.getElementById('confirmKickBtn').onclick = () => {
        overlay.remove();
        executeKickUser(targetUserId, userName);
      };
    }

    // âœ… æ‰§è¡Œè¸¢å‡ºç”¨æˆ·æ“ä½œ
    async function executeKickUser(targetUserId, userName) {
      console.log('âœ… ç”¨æˆ·ç¡®è®¤è¸¢å‡ºæ“ä½œï¼Œå¼€å§‹æ‰§è¡Œ...');

      try {
        const jwtToken = getJwtToken();
        if (!jwtToken) {
          console.error('âŒ æœªæ‰¾åˆ° JWT Token');
          showToast('æœªæ‰¾åˆ°è®¤è¯ä¿¡æ¯', 'error', 3000);
          return;
        }

        console.log('âœ… JWT Token å·²è·å–');
        showMessage('æ­£åœ¨ç§»å‡ºç”¨æˆ·...');

        const requestBody = {
          roomId: roomId,
          userId: targetUserId,
          hostUserId: currentUserId  // ä¼ é€’ä¸»æŒäººçš„ ZEGO userIdï¼ˆuser_xxx æ ¼å¼ï¼‰
        };

        console.log('ğŸ“¤ å‘é€è¸¢å‡ºè¯·æ±‚:', requestBody);

        const response = await fetch('/api/zego/kick-user', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${jwtToken}`
          },
          body: JSON.stringify(requestBody)
        });

        console.log('ğŸ“¥ æ”¶åˆ°å“åº”ï¼ŒçŠ¶æ€ç :', response.status);

        const result = await response.json();
        console.log('ğŸ“¥ å“åº”å†…å®¹:', result);

        hideMessage();

        if (result.success) {
          console.log('âœ… è¸¢å‡ºç”¨æˆ·æˆåŠŸ');
          showToast(`âœ… å·²å°† ${userName} ç§»å‡ºé¢è¯•é—´`, 'success', 2000);
        } else {
          console.error('âŒ è¸¢å‡ºç”¨æˆ·å¤±è´¥:', result.message);
          showToast('æ“ä½œå¤±è´¥: ' + result.message, 'error', 3000);
        }
      } catch (error) {
        console.error('âŒ è¸¢å‡ºç”¨æˆ·å¤±è´¥:', error);
        hideMessage();
        showToast('æ“ä½œå¤±è´¥: ' + error.message, 'error', 3000);
      }
    }

    // ç¿»è½¬é•œå¤´ï¼ˆå‰ç½®/åç½®åˆ‡æ¢ï¼‰
    // âœ… ä½¿ç”¨å³æ„å®˜æ–¹æ¨èçš„æ–¹å¼ï¼šuseFrontCamera
    // å®˜æ–¹æ–‡æ¡£ï¼šhttps://doc-zh.zego.im/real-time-video-web/best-practice/mobile-front-and-rear-camera-switching
    async function flipCamera() {
      if (!localStream || !isCameraOn) {
        showToast('è¯·å…ˆæ‰“å¼€æ‘„åƒå¤´', 'warning', 2000);
        return;
      }

      try {
        showMessage('æ­£åœ¨åˆ‡æ¢æ‘„åƒå¤´...');
        console.log('ğŸ”„ å¼€å§‹åˆ‡æ¢æ‘„åƒå¤´ï¼Œå½“å‰:', isFrontCamera ? 'å‰ç½®' : 'åç½®');

        // åˆ‡æ¢æ‘„åƒå¤´æ–¹å‘
        isFrontCamera = !isFrontCamera;
        console.log('ğŸ”„ åˆ‡æ¢åˆ°:', isFrontCamera ? 'å‰ç½®' : 'åç½®');

        // âœ… ä½¿ç”¨å®˜æ–¹æ¨èçš„ useFrontCamera æ–¹æ³•
        // true = å‰ç½®æ‘„åƒå¤´ï¼Œfalse = åç½®æ‘„åƒå¤´
        await zg.useFrontCamera(localStream, isFrontCamera);

        console.log('âœ… æ‘„åƒå¤´åˆ‡æ¢æˆåŠŸ:', isFrontCamera ? 'å‰ç½®' : 'åç½®');
        hideMessage();
        showToast('âœ… æ‘„åƒå¤´å·²åˆ‡æ¢åˆ°' + (isFrontCamera ? 'å‰ç½®' : 'åç½®'), 'success', 2000);
      } catch (error) {
        console.error('âŒ åˆ‡æ¢æ‘„åƒå¤´å¤±è´¥:', error);
        hideMessage();

        // åˆ‡æ¢å›åŸæ¥çš„æ–¹å‘
        isFrontCamera = !isFrontCamera;
        showToast('åˆ‡æ¢æ‘„åƒå¤´å¤±è´¥: ' + error.message, 'error', 3000);
      }
    }

    // æ˜¾ç¤ºé‚€è¯·å¼¹çª—
    function showInviteModal() {
      console.log('ğŸ“¨ æ˜¾ç¤ºé‚€è¯·å¼¹çª—');
      console.log('ğŸ  å½“å‰roomId:', roomId);

      // ğŸ”¥ æ£€æŸ¥roomIdæ˜¯å¦å­˜åœ¨
      if (!roomId || roomId === '') {
        showToast('è¯·å…ˆåˆ›å»ºé¢è¯•é—´ï¼', 'warning', 2000);
        console.error('âŒ roomIdä¸ºç©ºï¼Œæ— æ³•ç”Ÿæˆé‚€è¯·é“¾æ¥');
        return;
      }

      // ğŸ¯ å°ç¨‹åºç¯å¢ƒä¸‹ï¼Œå‘é€ triggerShare æ¶ˆæ¯ç»™å°ç¨‹åº
      if (IS_IN_MINIPROGRAM) {
        try {
          console.log('ğŸ’¡ å°ç¨‹åºç¯å¢ƒï¼Œå‘é€ triggerShare æ¶ˆæ¯ç»™å°ç¨‹åº');

          // ç”Ÿæˆè®¿å®¢H5é“¾æ¥
          const baseUrl = window.location.origin + window.location.pathname.replace('video-interview-host.html', '');
          const inviteLink = `${baseUrl}video-interview-guest.html?roomId=${roomId}`;

          console.log('ğŸ“¤ å‡†å¤‡å‘é€ triggerShare æ¶ˆæ¯');
          console.log('ğŸ“¤ roomId:', roomId);
          console.log('ğŸ“¤ inviteLink:', inviteLink);

          // å‘é€æ¶ˆæ¯ç»™å°ç¨‹åº
          if (typeof wx !== 'undefined' && wx.miniProgram) {
            wx.miniProgram.postMessage({
              data: {
                type: 'triggerShare',
                roomId: roomId,
                inviteLink: inviteLink,
                shareTitle: 'é‚€è¯·ä½ å‚åŠ è§†é¢‘é¢è¯•',
                shareDesc: `é¢è¯•é—´å·ï¼š${roomId.replace(/^room_/, 'AD-').split('_')[0]}`
              }
            });
            console.log('âœ… å·²å‘é€ triggerShare æ¶ˆæ¯ç»™å°ç¨‹åº');

            // æç¤ºç”¨æˆ·ç‚¹å‡»å³ä¸Šè§’åˆ†äº«
            showToast('è¯·ç‚¹å‡»å³ä¸Šè§’"..."æŒ‰é’®ï¼Œé€‰æ‹©"è½¬å‘"åˆ†äº«ç»™å®¢æˆ·/é˜¿å§¨', 'info', 3000);
          } else {
            console.warn('âš ï¸ æœªæ‰¾åˆ° wx.miniProgramï¼Œæ— æ³•å‘é€æ¶ˆæ¯');
          }
        } catch (error) {
          console.error('âš ï¸ å‘é€ triggerShare æ¶ˆæ¯å¤±è´¥:', error);
          // ä¸å½±å“ä¸»æµç¨‹
        }
        return;
      }

      // éå°ç¨‹åºç¯å¢ƒï¼Œæ˜¾ç¤ºé‚€è¯·å¼¹çª—
      const modal = document.getElementById('inviteModal');
      const inviteLinkInput = document.getElementById('inviteLink');

      // ç”Ÿæˆé‚€è¯·é“¾æ¥
      const baseUrl = window.location.origin + window.location.pathname.replace('video-interview-host.html', '');
      const inviteLink = `${baseUrl}video-interview-guest.html?roomId=${roomId}`;

      console.log('ğŸ”— ç”Ÿæˆçš„é‚€è¯·é“¾æ¥:', inviteLink);

      inviteLinkInput.value = inviteLink;
      modal.classList.add('show');
    }

    // å…³é—­é‚€è¯·å¼¹çª—
    function closeInviteModal() {
      const modal = document.getElementById('inviteModal');
      modal.classList.remove('show');
    }

    // å¤åˆ¶é‚€è¯·é“¾æ¥
    function copyInviteLink() {
      const inviteLinkInput = document.getElementById('inviteLink');

      // é€‰ä¸­å¹¶å¤åˆ¶
      inviteLinkInput.select();
      inviteLinkInput.setSelectionRange(0, 99999); // ç§»åŠ¨ç«¯å…¼å®¹

      try {
        document.execCommand('copy');

        // ä¿®æ”¹æŒ‰é’®æ–‡å­—æç¤º
        const btn = event.target;
        const originalText = btn.textContent;
        btn.textContent = 'âœ… é“¾æ¥å·²å¤åˆ¶ï¼';
        btn.style.background = 'linear-gradient(135deg, #4caf50 0%, #45a049 100%)';

        setTimeout(() => {
          btn.textContent = originalText;
          btn.style.background = 'linear-gradient(135deg, #5fb3a3 0%, #4a9d8e 100%)';
          closeInviteModal();
        }, 1500);

      } catch (err) {
        showToast('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶é“¾æ¥', 'error', 3000);
      }
    }

    // ç‚¹å‡»å¼¹çª—å¤–éƒ¨å…³é—­
    document.addEventListener('click', function(e) {
      const modal = document.getElementById('inviteModal');
      if (e.target === modal) {
        closeInviteModal();
      }
    });

    // ==================== é€šçŸ¥å°ç¨‹åº ====================
    // ğŸ”¥ å‘é€ roomCreated æ¶ˆæ¯ç»™å°ç¨‹åº
    function notifyMiniProgram(roomId) {
      try {
        console.log('ğŸ“¤ å‡†å¤‡å‘é€ roomCreated æ¶ˆæ¯ç»™å°ç¨‹åº');
        console.log('ğŸ“¤ roomId:', roomId);

        // æ£€æŸ¥æ˜¯å¦åœ¨å°ç¨‹åºç¯å¢ƒ
        if (typeof wx !== 'undefined' && wx.miniProgram) {
          wx.miniProgram.postMessage({
            data: {
              type: 'roomCreated',
              roomId: roomId
            }
          });

          console.log('âœ… å·²å‘é€ roomCreated æ¶ˆæ¯ç»™å°ç¨‹åº');
        } else {
          console.log('âš ï¸ ä¸åœ¨å°ç¨‹åºç¯å¢ƒï¼Œè·³è¿‡å‘é€æ¶ˆæ¯');
        }
      } catch (error) {
        console.error('âš ï¸ å‘é€æ¶ˆæ¯ç»™å°ç¨‹åºå¤±è´¥:', error);
        // ä¸æŠ›å‡ºé”™è¯¯ï¼Œé¿å…å½±å“ä¸»æµç¨‹
      }
    }

    // ==================== æè¯å™¨åŠŸèƒ½ ====================
    // æ˜¾ç¤ºæè¯å™¨å¼¹çª—
    function showTeleprompterModal() {
      const modal = document.getElementById('teleprompterModal');
      modal.style.display = 'flex';
      console.log('ğŸ“ æ‰“å¼€æè¯å™¨æ§åˆ¶é¢æ¿');

      // æ›´æ–°ç”¨æˆ·åˆ—è¡¨
      updateTeleprompterUserList();
    }

    // æ›´æ–°æè¯å™¨ç”¨æˆ·åˆ—è¡¨
    function updateTeleprompterUserList() {
      const select = document.getElementById('teleprompterTarget');

      // ä¿å­˜å½“å‰é€‰ä¸­çš„å€¼
      const currentValue = select.value;

      // æ¸…ç©ºç°æœ‰é€‰é¡¹
      select.innerHTML = '';

      // ç»Ÿè®¡åœ¨çº¿ç”¨æˆ·
      const helperUsers = [];
      const customerUsers = [];

      for (const userId in onlineUsers) {
        const user = onlineUsers[userId];
        // æ ¹æ®userNameåˆ¤æ–­è§’è‰²ï¼ˆå¦‚æœuserNameåŒ…å«"customer"æˆ–"helper"ï¼‰
        if (user.userName.toLowerCase().includes('helper') || user.userName === 'ayi') {
          helperUsers.push({ userId, ...user });
        } else if (user.userName.toLowerCase().includes('customer')) {
          customerUsers.push({ userId, ...user });
        } else {
          // é»˜è®¤å½“ä½œhelper
          helperUsers.push({ userId, ...user });
        }
      }

      // å¦‚æœæ²¡æœ‰é˜¿å§¨åœ¨çº¿ï¼Œæ˜¾ç¤ºplaceholder
      if (helperUsers.length === 0) {
        const placeholderOption = document.createElement('option');
        placeholderOption.value = '';
        placeholderOption.textContent = 'è¯·é€‰æ‹©é˜¿å§¨';
        placeholderOption.disabled = true;
        placeholderOption.selected = true;
        select.appendChild(placeholderOption);
      } else {
        // æœ‰é˜¿å§¨åœ¨çº¿æ—¶ï¼Œæ·»åŠ "æ‰€æœ‰é˜¿å§¨"é€‰é¡¹
        const allOption = document.createElement('option');
        allOption.value = 'ALL';
        allOption.textContent = 'æ‰€æœ‰é˜¿å§¨';
        select.appendChild(allOption);

        // æ·»åŠ åˆ†éš”ç¬¦
        const separator = document.createElement('option');
        separator.disabled = true;
        separator.textContent = '--- é˜¿å§¨ç”¨æˆ· ---';
        select.appendChild(separator);

        // æ·»åŠ æ¯ä¸ªé˜¿å§¨ç”¨æˆ·
        helperUsers.forEach((user, index) => {
          const option = document.createElement('option');
          option.value = user.userId;

          // ç§»é™¤"helper-"å‰ç¼€ï¼Œåªæ˜¾ç¤ºä¸­æ–‡åç§°
          let displayName = user.userName;
          if (displayName.toLowerCase().startsWith('helper-')) {
            displayName = displayName.substring(7); // ç§»é™¤"helper-"å‰ç¼€
          }
          option.textContent = displayName;

          // å¦‚æœä¹‹å‰æœ‰é€‰ä¸­å€¼ï¼Œä¿æŒé€‰ä¸­ï¼›å¦åˆ™é»˜è®¤é€‰ä¸­ç¬¬ä¸€ä¸ªé˜¿å§¨
          if (currentValue && currentValue === user.userId) {
            option.selected = true;
          } else if (!currentValue && index === 0) {
            option.selected = true;
            console.log(`âœ… è‡ªåŠ¨é€‰ä¸­ç¬¬ä¸€ä¸ªé˜¿å§¨: ${displayName}`);
          }

          select.appendChild(option);
        });
      }

      // æ˜¾ç¤ºåœ¨çº¿ç”¨æˆ·æ•°é‡
      console.log(`ğŸ‘¥ åœ¨çº¿é˜¿å§¨: ${helperUsers.length}äºº, åœ¨çº¿å®¢æˆ·: ${customerUsers.length}äºº`);
    }

    // å…³é—­æè¯å™¨å¼¹çª—
    function closeTeleprompterModal() {
      const modal = document.getElementById('teleprompterModal');
      modal.style.display = 'none';
      console.log('ğŸ“ å…³é—­æè¯å™¨æ§åˆ¶é¢æ¿');
    }

    // ç‚¹å‡»å¼¹çª—å¤–éƒ¨å…³é—­
    window.addEventListener('click', function(e) {
      const modal = document.getElementById('teleprompterModal');
      if (e.target === modal) {
        closeTeleprompterModal();
      }
    });

    // ä¸€é”®æ¨é€å¹¶å¼€å¯æè¯å™¨
    async function quickStartTeleprompter() {
      const content = document.getElementById('teleprompterContent').value.trim();
      if (!content) {
        showToast('è¯·è¾“å…¥æè¯å†…å®¹', 'warning', 2000);
        return;
      }

      if (!roomId) {
        showToast('è¯·å…ˆåˆ›å»ºæˆ¿é—´', 'warning', 2000);
        return;
      }

      try {
        showMessage('æ­£åœ¨å¯åŠ¨æè¯å™¨...');

        const jwtToken = getJwtToken();
        if (!jwtToken) {
          throw new Error('æœªæ‰¾åˆ°è®¤è¯ä¿¡æ¯');
        }

        const speed = parseInt(document.getElementById('teleprompterSpeed').value);
        const targetValue = document.getElementById('teleprompterTarget').value;

        // éªŒè¯æ˜¯å¦é€‰æ‹©äº†é˜¿å§¨
        if (!targetValue) {
          showMessage('è¯·é€‰æ‹©è¦æ¨é€çš„é˜¿å§¨', 'warning');
          return;
        }

        // å¦‚æœé€‰æ‹©çš„æ˜¯"ALL"ï¼Œåˆ™æ¨é€ç»™æ‰€æœ‰ç”¨æˆ·ï¼›å¦åˆ™æ¨é€ç»™æŒ‡å®šç”¨æˆ·
        const targetUserIds = targetValue === 'ALL' ? ['ALL'] : [targetValue];

        const response = await fetch('/api/zego/quick-start-teleprompter', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${jwtToken}`
          },
          body: JSON.stringify({
            roomId: roomId,
            content: content,
            targetUserIds: targetUserIds,
            scrollSpeed: speed,
            autoPlay: true
          })
        });

        const result = await response.json();
        hideMessage();

        if (result.success) {
          // ä½¿ç”¨ Toast æ›¿ä»£ alertï¼Œé¿å…å°ç¨‹åºç¯å¢ƒå‡ºç°"å…³é—­ç½‘é¡µ"å¼¹çª—
          showToast('ğŸš€ æè¯å™¨å·²å¯åŠ¨ï¼', 'success', 2000);
          console.log('âœ… æè¯å™¨å¯åŠ¨æˆåŠŸ');

          // âœ… ä¸è‡ªåŠ¨å…³é—­æè¯å™¨å¼¹çª—ï¼Œè®©ä¸»æŒäººå¯ä»¥ç»§ç»­æ§åˆ¶
          // ä¸»æŒäººå¯ä»¥æ‰‹åŠ¨ç‚¹å‡» X å…³é—­ï¼Œæˆ–è€…ç»§ç»­ä½¿ç”¨æ’­æ”¾/æš‚åœ/å…³é—­ç­‰åŠŸèƒ½
        } else {
          throw new Error(result.message || 'å¯åŠ¨å¤±è´¥');
        }
      } catch (error) {
        console.error('âŒ å¯åŠ¨æè¯å™¨å¤±è´¥:', error);
        hideMessage();
        showToast('å¯åŠ¨å¤±è´¥: ' + error.message, 'error', 3000);
      }
    }

    // æ¨é€æè¯å†…å®¹
    async function pushTeleprompterContent() {
      const content = document.getElementById('teleprompterContent').value.trim();
      if (!content) {
        showToast('è¯·è¾“å…¥æè¯å†…å®¹', 'warning', 2000);
        return;
      }

      if (!roomId) {
        showToast('è¯·å…ˆåˆ›å»ºæˆ¿é—´', 'warning', 2000);
        return;
      }

      try {
        showMessage('æ­£åœ¨æ¨é€å†…å®¹...');

        const jwtToken = getJwtToken();
        if (!jwtToken) {
          throw new Error('æœªæ‰¾åˆ°è®¤è¯ä¿¡æ¯');
        }

        const speed = parseInt(document.getElementById('teleprompterSpeed').value);
        const targetValue = document.getElementById('teleprompterTarget').value;

        // éªŒè¯æ˜¯å¦é€‰æ‹©äº†é˜¿å§¨
        if (!targetValue) {
          showMessage('è¯·é€‰æ‹©è¦æ¨é€çš„é˜¿å§¨', 'warning');
          return;
        }

        const targetUserIds = targetValue === 'ALL' ? ['ALL'] : [targetValue];

        const response = await fetch('/api/zego/push-teleprompter', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${jwtToken}`
          },
          body: JSON.stringify({
            roomId: roomId,
            content: content,
            targetUserIds: targetUserIds,
            scrollSpeed: speed
          })
        });

        const result = await response.json();
        hideMessage();

        if (result.success) {
          // ä½¿ç”¨ Toast æ›¿ä»£ alert
          showToast('ğŸ“¤ å†…å®¹å·²æ¨é€', 'success', 2000);
          console.log('âœ… æè¯å†…å®¹æ¨é€æˆåŠŸ');
        } else {
          throw new Error(result.message || 'æ¨é€å¤±è´¥');
        }
      } catch (error) {
        console.error('âŒ æ¨é€æè¯å†…å®¹å¤±è´¥:', error);
        hideMessage();
        showToast('æ¨é€å¤±è´¥: ' + error.message, 'error', 3000);
      }
    }

    // æ§åˆ¶æè¯å™¨æ’­æ”¾çŠ¶æ€
    async function controlTeleprompter(action) {
      if (!roomId) {
        showToast('è¯·å…ˆåˆ›å»ºæˆ¿é—´', 'warning', 2000);
        return;
      }

      try {
        const jwtToken = getJwtToken();
        if (!jwtToken) {
          throw new Error('æœªæ‰¾åˆ°è®¤è¯ä¿¡æ¯');
        }

        const actionText = {
          'PLAY': 'æ’­æ”¾',
          'PAUSE': 'æš‚åœ',
          'SHOW': 'æ˜¾ç¤º',
          'HIDE': 'å…³é—­'
        }[action] || action;

        showMessage(`æ­£åœ¨${actionText}æè¯å™¨...`);

        const targetValue = document.getElementById('teleprompterTarget').value;

        // éªŒè¯æ˜¯å¦é€‰æ‹©äº†é˜¿å§¨
        if (!targetValue) {
          showMessage('è¯·é€‰æ‹©è¦æ¨é€çš„é˜¿å§¨', 'warning');
          return;
        }

        const targetUserIds = targetValue === 'ALL' ? ['ALL'] : [targetValue];

        const response = await fetch('/api/zego/control-teleprompter', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${jwtToken}`
          },
          body: JSON.stringify({
            roomId: roomId,
            targetUserIds: targetUserIds,
            action: action
          })
        });

        const result = await response.json();
        hideMessage();

        if (result.success) {
          console.log(`âœ… æè¯å™¨${actionText}æˆåŠŸ`);
          if (action === 'HIDE') {
            // ä½¿ç”¨ Toast æ›¿ä»£ alert
            showToast('âŒ æè¯å™¨å·²å…³é—­', 'success', 2000);
          }
        } else {
          throw new Error(result.message || 'æ“ä½œå¤±è´¥');
        }
      } catch (error) {
        console.error(`âŒ æ§åˆ¶æè¯å™¨å¤±è´¥:`, error);
        hideMessage();
        showToast('æ“ä½œå¤±è´¥: ' + error.message, 'error', 3000);
      }
    }

    // âœ… æ˜¾ç¤ºç»“æŸé¢è¯•ç¡®è®¤å¼¹çª—ï¼ˆè‡ªå®šä¹‰å¼¹çª—ï¼Œé¿å…å¾®ä¿¡åŠ«æŒï¼‰
    function leaveRoom() {
      showEndInterviewModal();
    }

    // âœ… æ˜¾ç¤ºç»“æŸé¢è¯•ç¡®è®¤å¼¹çª—
    function showEndInterviewModal() {
      console.log('ğŸ“¢ æ˜¾ç¤ºç»“æŸé¢è¯•ç¡®è®¤å¼¹çª—');

      // åˆ›å»ºé®ç½©å±‚
      const overlay = document.createElement('div');
      overlay.id = 'endInterviewOverlay';
      overlay.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.7);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
      `;

      // åˆ›å»ºå¼¹çª—
      const modal = document.createElement('div');
      modal.style.cssText = `
        background: white;
        border-radius: 12px;
        padding: 30px;
        max-width: 400px;
        width: 90%;
        text-align: center;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
      `;

      modal.innerHTML = `
        <div style="font-size: 48px; margin-bottom: 20px;">âš ï¸</div>
        <h2 style="margin: 0 0 15px 0; font-size: 18px; color: #333;">ç¡®å®šè¦ç»“æŸé¢è¯•å¹¶è§£æ•£æˆ¿é—´å—ï¼Ÿ</h2>
        <p style="margin: 0 0 25px 0; font-size: 14px; color: #999;">æ‰€æœ‰å‚ä¸è€…å°†è¢«è¸¢å‡ºï¼Œæ­¤æ“ä½œä¸å¯æ’¤é”€</p>
        <div style="display: flex; gap: 12px;">
          <button id="cancelEndBtn" style="flex: 1; background: #f5f5f5; color: #666; border: none; padding: 12px 24px;
                         border-radius: 8px; font-size: 16px; cursor: pointer;">
            å–æ¶ˆ
          </button>
          <button id="confirmEndBtn" style="flex: 1; background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%); color: white; border: none; padding: 12px 24px;
                         border-radius: 8px; font-size: 16px; cursor: pointer;">
            ç¡®å®šç»“æŸ
          </button>
        </div>
      `;

      overlay.appendChild(modal);
      document.body.appendChild(overlay);

      // ç»‘å®šæŒ‰é’®äº‹ä»¶
      document.getElementById('cancelEndBtn').onclick = closeEndInterviewModal;
      document.getElementById('confirmEndBtn').onclick = confirmEndInterview;
    }

    // âœ… å…³é—­ç»“æŸé¢è¯•ç¡®è®¤å¼¹çª—
    function closeEndInterviewModal() {
      const overlay = document.getElementById('endInterviewOverlay');
      if (overlay) {
        overlay.remove();
      }
    }

    // âœ… ç¡®è®¤ç»“æŸé¢è¯•
    async function confirmEndInterview() {
      closeEndInterviewModal();

      try {
        showMessage('æ­£åœ¨ç»“æŸé¢è¯•...');

        // 1. ç»“æŸé¢è¯•é—´æ•°æ®åº“è®°å½•
        const jwtToken = getJwtToken();
        if (jwtToken) {
          try {
            const endResponse = await fetch(`/api/interview/rooms/${roomId}/end`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${jwtToken}`
              }
            });

            const endResult = await endResponse.json();
            if (endResult.success) {
              console.log('âœ… é¢è¯•é—´è®°å½•å·²ç»“æŸ');
            } else {
              console.warn('âš ï¸ ç»“æŸé¢è¯•é—´è®°å½•å¤±è´¥:', endResult.message);
            }
          } catch (error) {
            console.error('âŒ ç»“æŸé¢è¯•é—´è®°å½•å¤±è´¥:', error);
          }

          // 2. è°ƒç”¨åç«¯APIè§£æ•£æˆ¿é—´ï¼ˆè¸¢å‡ºæ‰€æœ‰äººï¼‰
          try {
            const response = await fetch('/api/zego/dismiss-room', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${jwtToken}`
              },
              body: JSON.stringify({
                roomId: roomId,
                hostUserId: currentUserId  // âœ… æ·»åŠ ä¸»æŒäººçš„ ZEGO userId
              })
            });

            const result = await response.json();
            if (result.success) {
              console.log('âœ… æˆ¿é—´å·²è§£æ•£ï¼Œæ‰€æœ‰ç”¨æˆ·å·²è¢«è¸¢å‡º');
            } else {
              console.warn('âš ï¸ è§£æ•£æˆ¿é—´å¤±è´¥:', result.message);
            }
          } catch (error) {
            console.error('âŒ è°ƒç”¨è§£æ•£æˆ¿é—´APIå¤±è´¥:', error);
          }
        }

        // 2. åœæ­¢è®¡æ—¶å™¨
        stopTimer();

        // 3. åœæ­¢æ¨æµå¹¶é”€æ¯æœ¬åœ°æµ
        if (zg && localStream) {
          try {
            const streamID = 'stream_' + currentUserId;
            await zg.stopPublishingStream(streamID);
            console.log('âœ… å·²åœæ­¢æ¨æµ');
          } catch (error) {
            console.error('åœæ­¢æ¨æµå¤±è´¥:', error);
          }

          try {
            zg.destroyStream(localStream);
            console.log('âœ… å·²é”€æ¯æœ¬åœ°æµ');
          } catch (error) {
            console.error('é”€æ¯æœ¬åœ°æµå¤±è´¥:', error);
          }

          localStream = null;
        }

        // 4. ç™»å‡ºæˆ¿é—´
        if (zg) {
          try {
            await zg.logoutRoom(roomId);
            console.log('âœ… å·²ç™»å‡ºæˆ¿é—´');
          } catch (error) {
            console.error('ç™»å‡ºæˆ¿é—´å¤±è´¥:', error);
          }
        }

        hideMessage();

        // 5. å…³é—­é¢è¯•é—´ç•Œé¢
        console.log('ğŸšª å‡†å¤‡å…³é—­é¡µé¢...');

        // ä¼˜å…ˆä½¿ç”¨å°ç¨‹åº API å…³é—­é¡µé¢
        if (typeof wx !== 'undefined' && wx.miniProgram) {
          console.log('âœ… ä½¿ç”¨å°ç¨‹åº API å…³é—­é¡µé¢');
          wx.miniProgram.navigateBack();
        } else {
          // éå°ç¨‹åºç¯å¢ƒï¼Œå°è¯•å…³é—­çª—å£
          console.log('âš ï¸ éå°ç¨‹åºç¯å¢ƒï¼Œå°è¯•å…³é—­çª—å£');
          window.close();

          // å¦‚æœæ— æ³•å…³é—­ï¼Œè¿”å›ä¸Šä¸€é¡µ
          setTimeout(() => {
            if (window.history.length > 1) {
              window.history.back();
            } else {
              // å¦‚æœéƒ½å¤±è´¥ï¼Œæ˜¾ç¤ºæç¤º
              showToast('âœ… é¢è¯•å·²ç»“æŸï¼Œè¯·æ‰‹åŠ¨å…³é—­æ­¤é¡µé¢', 'success', 3000);
            }
          }, 100);
        }
      } catch (error) {
        console.error('âŒ ç»“æŸé¢è¯•å¤±è´¥:', error);
        hideMessage();
        showToast('ç»“æŸé¢è¯•å¤±è´¥: ' + error.message, 'error', 3000);
      }
    }
    
    // ==================== å·¥å…·å‡½æ•° ====================
    function showMessage(msg) {
      let loading = document.getElementById('loading');
      if (!loading) {
        loading = document.createElement('div');
        loading.id = 'loading';
        loading.className = 'loading';
        document.body.appendChild(loading);
      }
      loading.textContent = msg;
      loading.style.display = 'block';
    }

    function hideMessage() {
      const loading = document.getElementById('loading');
      if (loading) {
        loading.style.display = 'none';
      }
    }

    // âœ… æ˜¾ç¤ºé‡è¿æç¤º
    function showReconnectToast() {
      const toast = document.getElementById('reconnectToast');
      if (toast) {
        toast.classList.add('show');
      }
    }

    // âœ… éšè—é‡è¿æç¤º
    function hideReconnectToast() {
      const toast = document.getElementById('reconnectToast');
      if (toast) {
        toast.classList.remove('show');
      }
    }

    // Toast æç¤ºå‡½æ•°ï¼ˆæ›¿ä»£ alertï¼Œé¿å…å°ç¨‹åºç¯å¢ƒå‡ºç°"å…³é—­ç½‘é¡µ"å¼¹çª—ï¼‰
    function showToast(msg, type = 'success', duration = 2000) {
      let toast = document.getElementById('toast');
      if (!toast) {
        toast = document.createElement('div');
        toast.id = 'toast';
        toast.className = 'toast';
        document.body.appendChild(toast);
      }

      // è®¾ç½®æ ·å¼ç±»å‹
      toast.className = 'toast ' + type;
      toast.textContent = msg;
      toast.style.display = 'block';

      // è‡ªåŠ¨éšè—
      setTimeout(() => {
        toast.style.display = 'none';
      }, duration);
    }

    // ==================== è®¡æ—¶å™¨å‡½æ•° ====================
    function startTimer() {
      if (interviewTimer) {
        clearInterval(interviewTimer);
      }
      interviewStartTime = Date.now();
      interviewTimer = setInterval(updateTimer, 1000);
      updateTimer(); // ç«‹å³æ›´æ–°ä¸€æ¬¡
    }

    function stopTimer() {
      if (interviewTimer) {
        clearInterval(interviewTimer);
        interviewTimer = null;
      }
    }

    function updateTimer() {
      if (!interviewStartTime) return;

      const elapsed = Math.floor((Date.now() - interviewStartTime) / 1000);
      const minutes = Math.floor(elapsed / 60);
      const seconds = elapsed % 60;

      const timeStr = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
      const timeElement = document.getElementById('interviewTime');
      if (timeElement) {
        timeElement.textContent = timeStr;
      }
    }
    
    // ==================== ç­‰å¾… SDK åŠ è½½ ====================
    function waitForSDK(maxRetries = 20, interval = 200) {
      return new Promise((resolve, reject) => {
        let retries = 0;

        const checkSDK = () => {
          console.log(`ğŸ”„ æ£€æŸ¥ SDK åŠ è½½çŠ¶æ€ (${retries + 1}/${maxRetries})...`);

          if (typeof ZegoExpressEngine !== 'undefined') {
            console.log('âœ… ZEGO SDK åŠ è½½æˆåŠŸï¼');
            resolve(true);
          } else if (retries >= maxRetries) {
            console.error('âŒ ZEGO SDK åŠ è½½è¶…æ—¶ï¼');
            reject(new Error('SDK åŠ è½½è¶…æ—¶'));
          } else {
            retries++;
            setTimeout(checkSDK, interval);
          }
        };

        checkSDK();
      });
    }

    // ==================== é¡µé¢åŠ è½½ ====================
    window.onload = async function() {
      console.log('é¡µé¢åŠ è½½å®Œæˆ');
      console.log('æˆ¿é—´å·:', roomId);

      // ğŸ¯ æ ¹æ®ç¯å¢ƒæ·»åŠ  body classï¼ˆç”¨äºæ§åˆ¶é‚€è¯·æŒ‰é’®æ˜¾ç¤ºï¼‰
      if (IS_IN_MINIPROGRAM) {
        document.body.classList.add('miniprogram-env');
        console.log('âœ… å·²æ·»åŠ å°ç¨‹åºç¯å¢ƒæ ‡è¯†ï¼Œé‚€è¯·æŒ‰é’®å°†è¢«éšè—');
      } else {
        console.log('âœ… æµè§ˆå™¨ç¯å¢ƒï¼Œé‚€è¯·æŒ‰é’®æ­£å¸¸æ˜¾ç¤º');
      }

      // æ£€æŸ¥ SDK åŠ è½½çŠ¶æ€
      console.log('æ£€æŸ¥ ZEGO SDK åŠ è½½çŠ¶æ€...');
      console.log('ZegoExpressEngine æ˜¯å¦å­˜åœ¨:', typeof ZegoExpressEngine !== 'undefined');
      console.log('generateToken04 æ˜¯å¦å­˜åœ¨:', typeof generateToken04 !== 'undefined');

      if (typeof generateToken04 === 'undefined') {
        console.warn('âš ï¸ Token ç”Ÿæˆåº“æœªåŠ è½½');
      } else {
        console.log('âœ… Token ç”Ÿæˆåº“åŠ è½½æˆåŠŸ');
      }

      // ğŸ”¥ æ·»åŠ åˆå§‹æ—¥å¿—
      addLog('ğŸ¬ è§†é¢‘é¢è¯•ç³»ç»Ÿå¯åŠ¨', 'info');
      addLog(`ğŸ“± æˆ¿é—´ID: ${roomId || 'å¾…åˆ›å»º'}`, 'info');

      // ç­‰å¾… SDK åŠ è½½
      if (typeof ZegoExpressEngine === 'undefined') {
        console.log('â³ ZEGO SDK å°šæœªåŠ è½½ï¼Œç­‰å¾…ä¸­...');
        addLog('â³ ZEGO SDK å°šæœªåŠ è½½ï¼Œç­‰å¾…ä¸­...', 'warning');
        try {
          await waitForSDK();
          addLog('âœ… ZEGO SDK åŠ è½½æˆåŠŸ', 'success');
        } catch (error) {
          console.error('âŒ ZEGO SDK åŠ è½½å¤±è´¥:', error);
          addLog('âŒ ZEGO SDK åŠ è½½å¤±è´¥', 'error');
          showToast('è§†é¢‘SDKåŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥ååˆ·æ–°é¡µé¢é‡è¯•', 'error', 3000);
          return;
        }
      } else {
        console.log('âœ… ZEGO SDK å·²åŠ è½½');
        addLog('âœ… ZEGO SDK å·²åŠ è½½', 'success');
      }

      initZego();

      // ğŸ¯ å¦‚æœURLä¸­æœ‰roomIdå‚æ•°ï¼Œå…ˆæ£€æŸ¥æˆ¿é—´çŠ¶æ€å†å†³å®šæ˜¯å¦è‡ªåŠ¨åŠ å…¥
      if (roomId) {
        console.log('ğŸ”„ æ£€æµ‹åˆ°URLä¸­çš„æˆ¿é—´ID:', roomId);
        addLog('ğŸ” æ­£åœ¨æ£€æŸ¥é¢è¯•é—´çŠ¶æ€...', 'info');

        // ğŸ”¥ å…³é”®ä¿®å¤ï¼šå…ˆæ£€æŸ¥æˆ¿é—´çŠ¶æ€ï¼Œå†å†³å®šæ˜¯å¦è‡ªåŠ¨åŠ å…¥
        checkAndJoinRoom(roomId);
      }
    };
    
    // ğŸ”¥ ç»Ÿä¸€çš„ç¦»å¼€æˆ¿é—´é€šçŸ¥å‡½æ•°
    function notifyLeaveRoom(eventName) {
      if (!roomId || !currentUserId) {
        console.log(`âš ï¸ ${eventName}: roomId æˆ– currentUserId ä¸ºç©ºï¼Œè·³è¿‡é€šçŸ¥`);
        return;
      }

      console.log(`ğŸ”” ${eventName}: å‡†å¤‡é€šçŸ¥åç«¯ä¸»æŒäººç¦»å¼€`);
      console.log(`  - roomId: ${roomId}`);
      console.log(`  - currentUserId: ${currentUserId}`);

      const apiUrl = window.location.origin + '/api/zego/leave-room';
      const leaveData = { roomId: roomId, userId: currentUserId };

      // ğŸ”¥ æ–¹æ³•1ï¼šå°è¯•ä½¿ç”¨ sendBeaconï¼ˆæœ€å¯é ï¼‰
      if (navigator.sendBeacon) {
        try {
          const blob = new Blob([JSON.stringify(leaveData)], { type: 'application/json' });
          const success = navigator.sendBeacon(apiUrl, blob);
          console.log(`âœ… ${eventName}: sendBeacon å‘é€${success ? 'æˆåŠŸ' : 'å¤±è´¥'}`);
          if (success) return; // å¦‚æœæˆåŠŸå°±è¿”å›
        } catch (error) {
          console.error(`âŒ ${eventName}: sendBeacon å¤±è´¥:`, error);
        }
      } else {
        console.warn(`âš ï¸ ${eventName}: navigator.sendBeacon ä¸æ”¯æŒ`);
      }

      // ğŸ”¥ æ–¹æ³•2ï¼šä½¿ç”¨åŒæ­¥ XMLHttpRequestï¼ˆå…œåº•æ–¹æ¡ˆï¼‰
      try {
        const xhr = new XMLHttpRequest();
        xhr.open('POST', apiUrl, false); // false = åŒæ­¥è¯·æ±‚
        xhr.setRequestHeader('Content-Type', 'application/json');
        xhr.send(JSON.stringify(leaveData));
        console.log(`âœ… ${eventName}: åŒæ­¥ XHR å‘é€æˆåŠŸ`);
      } catch (error) {
        console.error(`âŒ ${eventName}: åŒæ­¥ XHR å¤±è´¥:`, error);
      }
    }

    // ğŸ”¥ é¡µé¢å¸è½½æ—¶æ¸…ç†èµ„æº
    window.addEventListener('beforeunload', function(e) {
      console.log('âš ï¸ é¡µé¢å³å°†å¸è½½ï¼ˆbeforeunloadï¼‰');
      notifyLeaveRoom('beforeunload');

      // æ¸…ç† ZEGO èµ„æº
      if (zg && localStream) {
        zg.destroyStream(localStream);
        zg.logoutRoom(roomId);
      }
    });

    // ğŸ”¥ pagehide äº‹ä»¶åœ¨é¡µé¢çœŸæ­£å¸è½½æ—¶è§¦å‘ï¼ˆç§»åŠ¨ç«¯æ›´å¯é ï¼‰
    window.addEventListener('pagehide', function(e) {
      console.log('âš ï¸ é¡µé¢å¸è½½ï¼ˆpagehideï¼‰');
      notifyLeaveRoom('pagehide');

      // æ¸…ç† ZEGO èµ„æº
      if (zg && localStream) {
        zg.destroyStream(localStream);
        zg.logoutRoom(roomId);
      }
    });

    // âœ… ç›‘å¬é¡µé¢å¯è§æ€§å˜åŒ–ï¼ˆç”¨äºæ˜¾ç¤ºæç¤ºï¼Œä½†ä¸æ¸…ç†èµ„æºï¼‰
    document.addEventListener('visibilitychange', () => {
      if (document.hidden) {
        console.log('ğŸ“± é¡µé¢è¿›å…¥åå°ï¼ˆä¿æŒè¿æ¥ï¼‰');
      } else {
        console.log('ğŸ“± é¡µé¢è¿”å›å‰å°');
      }
    });
  </script>

</body>
</html>

