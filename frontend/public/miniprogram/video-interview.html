<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>è§†é¢‘é¢è¯•</title>

  <!-- å¾®ä¿¡ç¯å¢ƒæ£€æµ‹å’Œè‡ªåŠ¨è·³è½¬ -->
  <script>
    (function() {
      // æ£€æµ‹æ˜¯å¦åœ¨å¾®ä¿¡ä¸­
      function isWechat() {
        return /MicroMessenger/i.test(navigator.userAgent);
      }

      // æ£€æµ‹æ˜¯å¦åœ¨å°ç¨‹åº WebView ä¸­
      function isInMiniProgram() {
        return window.__wxjs_environment === 'miniprogram';
      }

      // è·å–æˆ¿é—´å·å‚æ•°
      const urlParams = new URLSearchParams(window.location.search);
      const roomId = urlParams.get('room') || '';

      console.log('ğŸ” ç¯å¢ƒæ£€æµ‹:');
      console.log('  - æ˜¯å¦åœ¨å¾®ä¿¡ä¸­:', isWechat());
      console.log('  - æ˜¯å¦åœ¨å°ç¨‹åº WebView ä¸­:', isInMiniProgram());
      console.log('  - æˆ¿é—´å·:', roomId);

      // æ³¨æ„ï¼šè¿™ä¸ª H5 é¡µé¢ç°åœ¨åªç”¨äºæµè§ˆå™¨è®¿é—®
      // å¾®ä¿¡ä¸­çš„è·³è½¬ä½¿ç”¨åŠ å¯† URL Schemeï¼ˆç”±äº‘å‡½æ•°ç”Ÿæˆï¼‰

      if (isInMiniProgram()) {
        console.log('âœ… å·²åœ¨å°ç¨‹åº WebView ä¸­ï¼Œæ­£å¸¸åŠ è½½ H5 é¡µé¢');
      } else if (!isWechat()) {
        console.log('ğŸŒ æµè§ˆå™¨ç¯å¢ƒï¼Œæ­£å¸¸åŠ è½½ H5 é¡µé¢');
      } else if (isWechat() && !isInMiniProgram()) {
        console.log('âš ï¸ å¾®ä¿¡æµè§ˆå™¨ç¯å¢ƒï¼Œä½†ä¸åœ¨å°ç¨‹åºä¸­');
        console.log('ğŸ’¡ æç¤ºï¼šè¯·ä½¿ç”¨å°ç¨‹åºåˆ†äº«çš„åŠ å¯†é“¾æ¥æ‰“å¼€');
      }
    })();
  </script>

  <!-- ä½¿ç”¨æœ¬åœ° ZEGO SDKï¼ˆv3.11.0 ç‹¬ç«‹æ‰“åŒ…ç‰ˆæœ¬ï¼ŒåŒ…å«æ‰€æœ‰ä¾èµ–ï¼‰ -->
  <script src="./ZegoExpressWebRTC-standalone.js"></script>
  <!-- ZEGO Token ç”Ÿæˆåº“ï¼ˆå†…åµŒå®ç°ï¼‰ -->
  <script>
    // Token ç”Ÿæˆå‡½æ•°ï¼ˆå†…åµŒå®ç°ï¼Œé¿å… CDN åŠ è½½é—®é¢˜ï¼‰
    function generateToken04(appId, userId, secret, effectiveTimeInSeconds, payload) {
      if (!payload) {
        payload = '';
      }

      // HMAC-SHA256 å®ç°
      async function hmacSHA256(key, message) {
        const encoder = new TextEncoder();
        // å°† secret ä½œä¸º UTF-8 å­—ç¬¦ä¸²ç¼–ç ï¼ˆä¸æ˜¯åå…­è¿›åˆ¶ï¼‰
        const keyData = encoder.encode(key);
        const messageData = encoder.encode(message);

        const cryptoKey = await crypto.subtle.importKey(
          'raw',
          keyData,
          { name: 'HMAC', hash: 'SHA-256' },
          false,
          ['sign']
        );

        const signature = await crypto.subtle.sign('HMAC', cryptoKey, messageData);
        return new Uint8Array(signature);
      }

      // Base64 ç¼–ç 
      function base64Encode(bytes) {
        let binary = '';
        for (let i = 0; i < bytes.length; i++) {
          binary += String.fromCharCode(bytes[i]);
        }
        return btoa(binary).replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
      }

      // ç”Ÿæˆ Tokenï¼ˆåŒæ­¥åŒ…è£…å¼‚æ­¥å‡½æ•°ï¼‰
      const expire = Math.floor(Date.now() / 1000) + effectiveTimeInSeconds;
      const body = {
        app_id: appId,
        user_id: userId,
        nonce: Math.floor(Math.random() * 2147483647),
        ctime: Math.floor(Date.now() / 1000),
        expire: expire
      };

      if (payload) {
        body.payload = payload;
      }

      const header = { alg: 'HS256', typ: 'JWT' };
      const headerStr = JSON.stringify(header);
      const bodyStr = JSON.stringify(body);

      const encoder = new TextEncoder();
      const headerBase64 = base64Encode(encoder.encode(headerStr));
      const bodyBase64 = base64Encode(encoder.encode(bodyStr));
      const toSign = headerBase64 + '.' + bodyBase64;

      // è¿”å› Promise
      // ä½¿ç”¨ UTF-8 ç¼–ç çš„ secretï¼ˆä¸æ˜¯åå…­è¿›åˆ¶ï¼‰
      return hmacSHA256(secret, toSign).then(signature => {
        const signatureBase64 = base64Encode(signature);
        return '04' + toSign + '.' + signatureBase64;
      });
    }
  </script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica', 'Arial', sans-serif;
      background: linear-gradient(180deg, #5fb3a3 0%, #4a9d8e 100%);
      overflow: hidden;
    }
    
    .container {
      width: 100vw;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }
    
    /* å¤´éƒ¨ä¿¡æ¯æ  */
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 12px;
      background: rgba(255, 255, 255, 0.95);
      border-radius: 8px;
      margin: 10px 10px 0 10px;
      box-shadow: 0 2px 6px rgba(95, 179, 163, 0.1);
      flex-shrink: 0;
    }

    .header-left,
    .header-right {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .room-label,
    .time-label {
      font-size: 12px;
      color: #666;
    }

    .room-value,
    .time-value {
      font-size: 13px;
      color: #333;
      font-weight: 500;
    }
    
    /* è§†é¢‘ç½‘æ ¼ */
    .video-grid {
      flex: 1;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      padding: 10px;
      background: transparent;
      overflow: hidden;
    }
    
    .video-item {
      position: relative;
      background: #f5f5f5;
      border-radius: 8px;
      overflow: hidden;
      border: 1px solid #e0e0e0;
    }
    
    .video-player {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    .video-label {
      position: absolute;
      bottom: 6px;
      left: 6px;
      padding: 3px 6px;
      background: rgba(0,0,0,0.7);
      color: #fff;
      border-radius: 3px;
      font-size: 11px;
    }
    
    .empty-video {
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #999;
      font-size: 14px;
    }
    
    /* æ§åˆ¶æŒ‰é’® */
    .controls {
      padding: 10px 6px;
      margin: 10px;
      background: rgba(255, 255, 255, 0.98);
      border-radius: 12px;
      display: flex;
      justify-content: space-around;
      align-items: center;
      box-shadow: 0 -2px 10px rgba(95, 179, 163, 0.15);
    }

    .control-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      padding: 6px;
      border-radius: 6px;
      transition: all 0.3s;
      cursor: pointer;
      flex: 1;
    }

    .control-item:active {
      background: rgba(95, 179, 163, 0.1);
    }

    .control-item-danger:active {
      background: rgba(255, 107, 107, 0.1);
    }

    .control-icon-text {
      font-size: 24px;
      line-height: 1;
    }

    .control-label {
      font-size: 11px;
      color: #666;
    }

    .control-item-danger .control-label {
      color: #ff6b6b;
    }
    
    /* åŠ å…¥é¢è¯•é¢æ¿ */
    .join-panel {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    
    .join-box {
      background: #fff;
      padding: 32px 24px;
      border-radius: 16px;
      width: 85%;
      max-width: 400px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.2);
    }

    .join-box h2 {
      margin-bottom: 12px;
      text-align: center;
      color: #333;
      font-size: 22px;
      font-weight: bold;
    }
    
    .join-box .room-hint {
      text-align: center;
      color: #999;
      font-size: 14px;
      margin-bottom: 20px;
    }

    /* èº«ä»½é€‰æ‹© */
    .role-selector {
      display: flex;
      gap: 12px;
      margin-bottom: 20px;
    }

    .role-option {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
      padding: 16px 12px;
      border: 2px solid #e0e0e0;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s;
      background: #fff;
    }

    .role-option:hover {
      border-color: #5fb3a3;
      background: rgba(95, 179, 163, 0.05);
    }

    .role-option.selected {
      border-color: #5fb3a3;
      background: rgba(95, 179, 163, 0.1);
    }

    .role-icon {
      font-size: 32px;
      line-height: 1;
    }

    .role-text {
      font-size: 14px;
      color: #333;
      font-weight: 500;
    }

    .role-option.selected .role-text {
      color: #5fb3a3;
      font-weight: 600;
    }

    .join-box input {
      width: 100%;
      padding: 14px 16px;
      border: 1px solid #ddd;
      border-radius: 8px;
      margin-bottom: 20px;
      font-size: 15px;
      transition: border-color 0.3s;
    }
    
    .join-box input:focus {
      outline: none;
      border-color: #5fb3a3;
    }

    .join-box button {
      width: 100%;
      padding: 16px;
      background: linear-gradient(135deg, #5fb3a3 0%, #4a9d8e 100%);
      color: #fff;
      border: none;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s;
      box-shadow: 0 4px 16px rgba(95, 179, 163, 0.3);
    }

    .join-box button:active {
      transform: scale(0.98);
    }
    
    /* åŠ è½½æç¤º */
    .loading {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0,0,0,0.8);
      color: #fff;
      padding: 20px 30px;
      border-radius: 8px;
      font-size: 16px;
      z-index: 2000;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- åŠ å…¥é¢è¯•é¢æ¿ -->
    <div class="join-panel" id="joinPanel">
      <div class="join-box">
        <h2>åŠ å…¥é¢è¯•é—´</h2>
        <div class="room-hint">æˆ¿é—´å·ï¼š<span id="roomIdHint"></span></div>

        <!-- èº«ä»½é€‰æ‹© -->
        <div class="role-selector">
          <div class="role-option" data-role="customer" onclick="selectRole('customer')">
            <div class="role-icon">ğŸ‘¤</div>
            <div class="role-text">æˆ‘æ˜¯å®¢æˆ·</div>
          </div>
          <div class="role-option" data-role="ayi" onclick="selectRole('ayi')">
            <div class="role-icon">ğŸ‘©â€ğŸ”§</div>
            <div class="role-text">æˆ‘æ˜¯é˜¿å§¨</div>
          </div>
        </div>

        <input type="text" id="userName" placeholder="è¯·è¾“å…¥æ‚¨çš„å§“å" maxlength="20" />
        <button onclick="joinRoom()">åŠ å…¥é¢è¯•</button>
      </div>
    </div>
    
    <!-- æˆ¿é—´ä¿¡æ¯ -->
    <div class="header">
      <div class="header-left">
        <span class="room-label">æˆ¿é—´å·ï¼š</span>
        <span class="room-value" id="roomId"></span>
      </div>
      <div class="header-right">
        <span class="time-label">é¢è¯•æ—¶é—´ï¼š</span>
        <span class="time-value" id="interviewTime">00:00</span>
      </div>
    </div>
    
    <!-- è§†é¢‘ç½‘æ ¼ -->
    <div class="video-grid" id="videoGrid">
      <!-- æœ¬åœ°è§†é¢‘ -->
      <div class="video-item">
        <video id="localVideo" class="video-player" autoplay muted playsinline></video>
        <div class="video-label" id="localLabel">æˆ‘</div>
      </div>
      
      <!-- è¿œç¨‹è§†é¢‘å®¹å™¨ -->
      <div class="video-item" id="remoteContainer">
        <div class="empty-video">ç­‰å¾…ä¸»æŒäººåŠ å…¥...</div>
      </div>
    </div>
    
    <!-- æ§åˆ¶æŒ‰é’® -->
    <div class="controls">
      <div class="control-item" id="micBtn" onclick="toggleMic()">
        <div class="control-icon-text">ğŸ¤</div>
        <div class="control-label">éº¦å…‹é£</div>
      </div>
      <div class="control-item" id="cameraBtn" onclick="toggleCamera()">
        <div class="control-icon-text">ğŸ“¹</div>
        <div class="control-label">æ‘„åƒå¤´</div>
      </div>
      <div class="control-item control-item-danger" onclick="leaveRoom()">
        <div class="control-icon-text">ğŸ“</div>
        <div class="control-label">ç»“æŸé€šè¯</div>
      </div>
    </div>
  </div>

  <script>
    // ==================== è„šæœ¬å¼€å§‹æ‰§è¡Œ ====================
    console.log('ğŸš€ video-interview.html è„šæœ¬å¼€å§‹æ‰§è¡Œ');
    console.log('ğŸ“… è„šæœ¬ç‰ˆæœ¬: 2025-11-10 v2.1');
    console.log('ğŸ” ç«‹å³æ£€æµ‹ ZegoExpressEngine:', typeof ZegoExpressEngine);
    console.log('ğŸ” ZegoExpressEngine è¯¦æƒ…:', ZegoExpressEngine);
    console.log('ğŸ” ZegoExpressEngine.ZegoExpressEngine:', typeof ZegoExpressEngine !== 'undefined' && ZegoExpressEngine.ZegoExpressEngine);
    console.log('ğŸ” ç«‹å³æ£€æµ‹ generateToken04:', typeof generateToken04);

    // ==================== å…¨å±€å˜é‡ ====================
    const urlParams = new URLSearchParams(window.location.search);
    const roomId = urlParams.get('room') || 'test_room';

    // ZEGO é…ç½®
    const appID = 1279160453;
    const server = 'wss://webliveroom1279160453-api.imzego.com/ws';
    // ServerSecretï¼ˆUTF-8 æ ¼å¼ï¼Œç”¨äºç”Ÿæˆ Tokenï¼‰
    const serverSecret = 'e18cc600e2939d412c48f152e157f01d';
    
    let zg = null;
    let localStream = null;
    let isMicOn = true;
    let isCameraOn = true;
    let currentUserId = '';
    let currentUserName = '';
    let currentUserRole = ''; // ç”¨æˆ·èº«ä»½ï¼šcustomer æˆ– ayi
    let interviewStartTime = null;
    let interviewTimer = null;
    
    // æ˜¾ç¤ºæˆ¿é—´å·
    document.getElementById('roomId').textContent = roomId;
    document.getElementById('roomIdHint').textContent = roomId;

    // ==================== Token ç”Ÿæˆ ====================
    async function generateToken(userID, userName) {
      try {
        console.log('ğŸ”‘ ä»åç«¯APIè·å– Token...');
        console.log('ğŸ“± AppID:', appID);
        console.log('ğŸ‘¤ UserID:', userID);
        console.log('ğŸ  RoomID:', roomId);
        console.log('ğŸ‘¨ UserName:', userName);

        // ä»åç«¯APIè·å–Token
        const response = await fetch('https://crm.andejiazheng.com/api/zego/generate-token', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            userId: userID,
            roomId: roomId,
            userName: userName,
            expireTime: 7200 // 2å°æ—¶
          })
        });

        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        const result = await response.json();
        console.log('âœ… åç«¯å“åº”:', result);

        if (result.success && result.data && result.data.token) {
          const token = result.data.token;
          console.log('âœ… Token è·å–æˆåŠŸï¼Œé•¿åº¦:', token.length);
          console.log('ğŸ” Token å‰ç¼€:', token.substring(0, 20) + '...');
          return token;
        } else {
          throw new Error(result.message || 'è·å–Tokenå¤±è´¥');
        }
      } catch (error) {
        console.error('âŒ Token è·å–å¤±è´¥:', error);

        // é™çº§æ–¹æ¡ˆï¼šä½¿ç”¨å‰ç«¯ç”ŸæˆToken
        console.warn('âš ï¸ å°è¯•ä½¿ç”¨å‰ç«¯ç”ŸæˆToken...');
        try {
          const effectiveTimeInSeconds = 3600 * 24;
          const payload = '';

          if (typeof generateToken04 !== 'undefined') {
            const token = await generateToken04(appID, userID, serverSecret, effectiveTimeInSeconds, payload);
            console.log('âœ… å‰ç«¯Tokenç”ŸæˆæˆåŠŸï¼Œé•¿åº¦:', token.length);
            return token;
          }
        } catch (fallbackError) {
          console.error('âŒ å‰ç«¯Tokenç”Ÿæˆä¹Ÿå¤±è´¥:', fallbackError);
        }

        return '';
      }
    }

    // ==================== èº«ä»½é€‰æ‹© ====================
    function selectRole(role) {
      currentUserRole = role;

      // æ›´æ–°é€‰ä¸­çŠ¶æ€
      document.querySelectorAll('.role-option').forEach(option => {
        option.classList.remove('selected');
      });
      document.querySelector(`.role-option[data-role="${role}"]`).classList.add('selected');

      console.log('é€‰æ‹©èº«ä»½:', role === 'customer' ? 'å®¢æˆ·' : 'é˜¿å§¨');
    }

    // ==================== åˆå§‹åŒ– ZEGO ====================
    function initZego() {
      console.log('åˆå§‹åŒ– ZEGO SDK...');

      // æ£€æŸ¥ ZEGO SDK æ˜¯å¦åŠ è½½
      if (typeof ZegoExpressEngine === 'undefined') {
        console.error('ZEGO SDK æœªåŠ è½½');
        alert('è§†é¢‘SDKåŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
        return false;
      }

      // å°è¯•è·å–æ­£ç¡®çš„æ„é€ å‡½æ•°
      let ZegoEngine = ZegoExpressEngine;
      if (typeof ZegoExpressEngine === 'object' && ZegoExpressEngine.ZegoExpressEngine) {
        console.log('æ£€æµ‹åˆ° ZegoExpressEngine æ˜¯å¯¹è±¡ï¼Œæå–æ„é€ å‡½æ•°');
        ZegoEngine = ZegoExpressEngine.ZegoExpressEngine;
      }

      console.log('ä½¿ç”¨çš„æ„é€ å‡½æ•°ç±»å‹:', typeof ZegoEngine);

      // åˆ›å»º ZEGO å®ä¾‹ï¼Œå¹¶è®¾ç½®æ—¥å¿—çº§åˆ«ä¸º errorï¼ˆåªæ˜¾ç¤ºé”™è¯¯ï¼‰
      zg = new ZegoEngine(appID, server);
      zg.setLogConfig({ logLevel: 'error' }); // å…³é—­è¯¦ç»†æ—¥å¿—

      console.log('ZEGO SDK åˆå§‹åŒ–æˆåŠŸ');
      
      // ç›‘å¬è¿œç¨‹æµæ›´æ–°
      zg.on('roomStreamUpdate', async (roomID, updateType, streamList) => {
        console.log('è¿œç¨‹æµæ›´æ–°:', updateType, streamList);

        if (updateType === 'ADD') {
          for (let stream of streamList) {
            await playRemoteStream(stream);
          }
        } else if (updateType === 'DELETE') {
          for (let stream of streamList) {
            const video = document.getElementById('remote_' + stream.streamID);
            if (video) {
              video.remove();
            }
            const container = document.getElementById('remoteContainer');
            if (container.children.length === 0) {
              container.innerHTML = '<div class="empty-video">ä¸»æŒäººå·²ç¦»å¼€</div>';
            }
          }
        }
      });

      // æ’­æ”¾è¿œç¨‹æµï¼ˆåŒ…å« iOS è‡ªåŠ¨æ’­æ”¾å…¼å®¹å¤„ç†ï¼‰
      async function playRemoteStream(stream) {
        console.log('â–¶ï¸ æ’­æ”¾è¿œç¨‹æµ:', stream);

        const container = document.getElementById('remoteContainer');
        if (!container) {
          console.error('âŒ æœªæ‰¾åˆ°è¿œç¨‹è§†é¢‘å®¹å™¨ remoteContainer');
          return;
        }

        // æ¯æ¬¡åªæ˜¾ç¤ºä¸€ä¸ªè¿œç«¯è§†é¢‘
        container.innerHTML = '';

        // å±•ç¤ºåç§°ï¼šä¼˜å…ˆä½¿ç”¨å¯¹æ–¹æ˜µç§°ï¼Œå¦åˆ™æ˜¾ç¤ºâ€œä¸»æŒäººâ€
        const displayName = (stream.user && stream.user.userName) || 'ä¸»æŒäºº';

        const video = document.createElement('video');
        const videoId = 'remote_' + stream.streamID;
        video.id = videoId;
        video.className = 'video-player';
        video.setAttribute('autoplay', 'true');
        video.setAttribute('playsinline', 'true');
        video.setAttribute('webkit-playsinline', 'true');
        video.setAttribute('x5-playsinline', 'true');
        video.setAttribute('x5-video-player-type', 'h5');
        video.setAttribute('x5-video-player-fullscreen', 'false');

        container.appendChild(video);

        const label = document.createElement('div');
        label.className = 'video-label';
        label.textContent = displayName;
        container.appendChild(label);

        const playStream = async (retryCount = 0, maxRetries = 3) => {
          try {
            console.log(`ğŸ¬ å°è¯•æ’­æ”¾è¿œç¨‹æµ (ç¬¬${retryCount + 1}æ¬¡):`, stream.streamID);

            const remoteStream = await zg.startPlayingStream(stream.streamID);
            console.log('âœ… SDK è¿”å›è¿œç¨‹æµ:', remoteStream);

            // æ‰‹åŠ¨è®¾ç½® srcObjectï¼ˆiOS å…³é”®æ­¥éª¤ï¼‰
            video.srcObject = remoteStream;

            // æ˜¾å¼è®¾ç½®éŸ³é¢‘ç›¸å…³å±æ€§
            video.muted = false;
            video.volume = 1;
            video.autoplay = true;
            // @ts-ignore
            video.playsInline = true;

            try {
              await video.play();
              console.log('âœ… è¿œç¨‹è§†é¢‘æ’­æ”¾æˆåŠŸ:', stream.streamID);
            } catch (playError) {
              console.warn('âš ï¸ video.play() è°ƒç”¨å¤±è´¥:', playError);
              if (playError.name === 'NotAllowedError') {
                console.warn('âš ï¸ æµè§ˆå™¨éœ€è¦ç”¨æˆ·äº¤äº’æ‰èƒ½æ’­æ”¾éŸ³è§†é¢‘');
                showClickToPlayOverlay(video, container);
              }
            }
          } catch (error) {
            console.error('âŒ æ’­æ”¾è¿œç¨‹æµå¤±è´¥:', error);
            if (retryCount < maxRetries) {
              console.log(`â³ å‡†å¤‡é‡è¯•æ’­æ”¾è¿œç¨‹æµ (${retryCount + 1}/${maxRetries})...`);
              setTimeout(() => playStream(retryCount + 1, maxRetries), 1000);
            } else {
              showClickToPlayOverlay(video, container);
            }
          }
        };

        // ç«‹å³å°è¯•æ’­æ”¾è¿œç«¯æµ
        playStream();
      }

      // iOS / å¾®ä¿¡ç¯å¢ƒä¸‹ï¼Œç‚¹å‡»è§£é”éŸ³è§†é¢‘æ’­æ”¾
      function showClickToPlayOverlay(video, container) {
        // é¿å…é‡å¤åˆ›å»º
        if (container.querySelector('.click-to-play')) {
          return;
        }

        const overlay = document.createElement('div');
        overlay.className = 'empty-video click-to-play';
        overlay.textContent = 'â–¶ï¸ ç‚¹å‡»æ’­æ”¾å¯¹æ–¹è§†é¢‘';
        overlay.style.position = 'absolute';
        overlay.style.top = '0';
        overlay.style.left = '0';
        overlay.style.right = '0';
        overlay.style.bottom = '0';
        overlay.style.background = 'rgba(0,0,0,0.4)';
        overlay.style.cursor = 'pointer';

        overlay.onclick = async () => {
          overlay.textContent = 'æ­£åœ¨å°è¯•æ’­æ”¾...';
          try {
            await video.play();
            overlay.remove();
            console.log('âœ… ç”¨æˆ·ç‚¹å‡»åï¼Œè¿œç¨‹è§†é¢‘æ’­æ”¾æˆåŠŸ');
          } catch (err) {
            console.error('âŒ ç”¨æˆ·ç‚¹å‡»åä»ç„¶æ— æ³•æ’­æ”¾:', err);
            overlay.textContent = 'ç‚¹å‡»é‡æ–°æ’­æ”¾';
          }
        };

        container.appendChild(overlay);
      }
      
      // ç›‘å¬æˆ¿é—´çŠ¶æ€
      zg.on('roomStateUpdate', (roomID, state, errorCode, extendedData) => {
        console.log('æˆ¿é—´çŠ¶æ€æ›´æ–°:', state, errorCode);
        if (state === 'DISCONNECTED') {
          showMessage('å·²æ–­å¼€è¿æ¥');
        } else if (state === 'CONNECTING') {
          showMessage('æ­£åœ¨è¿æ¥...');
        } else if (state === 'CONNECTED') {
          console.log('å·²è¿æ¥åˆ°æˆ¿é—´');
        }
      });

      return true;
    }

    // ==================== åŠ å…¥æˆ¿é—´ ====================
    async function joinRoom() {
      const userName = document.getElementById('userName').value.trim();
      if (!userName) {
        alert('è¯·è¾“å…¥æ‚¨çš„å§“å');
        return;
      }

      if (!currentUserRole) {
        alert('è¯·é€‰æ‹©æ‚¨çš„èº«ä»½');
        return;
      }

      // æ£€æŸ¥ ZEGO SDK æ˜¯å¦å·²åˆå§‹åŒ–
      if (!zg) {
        console.error('ZEGO SDK æœªåˆå§‹åŒ–');
        alert('è§†é¢‘SDKæœªåˆå§‹åŒ–ï¼Œæ­£åœ¨é‡æ–°åˆå§‹åŒ–...');
        const success = initZego();
        if (!success) {
          return;
        }
        // ç­‰å¾…ä¸€ä¸‹è®© SDK å®Œå…¨åˆå§‹åŒ–
        await new Promise(resolve => setTimeout(resolve, 500));
      }

      try {
        showMessage('æ­£åœ¨åŠ å…¥æˆ¿é—´...');

        // ç”Ÿæˆç”¨æˆ·ID
        currentUserId = 'user_' + Date.now();
        currentUserName = userName;

        console.log('âœ… ç”¨æˆ·ä¿¡æ¯:', { userId: currentUserId, userName: currentUserName, roomId: roomId, role: currentUserRole });

        // æ£€æŸ¥æˆ¿é—´å·
        if (!roomId || roomId === 'test_room') {
          throw new Error('æˆ¿é—´å·æ— æ•ˆï¼Œè¯·é€šè¿‡æ­£ç¡®çš„é“¾æ¥è¿›å…¥');
        }

        // ç”Ÿæˆ Token
        console.log('â³ æ­£åœ¨ç”Ÿæˆ Token...');
        const token = await generateToken(currentUserId, currentUserName);
        console.log('âœ… Token:', token ? 'Token å·²ç”Ÿæˆ' : 'ä½¿ç”¨ç©º Token');

        // ç™»å½•æˆ¿é—´
        console.log('â³ æ­£åœ¨ç™»å½•æˆ¿é—´...');
        console.log('â³ ç™»å½•å‚æ•°:', { roomId, token: token ? 'å·²ç”Ÿæˆ' : 'ç©º', userID: currentUserId, userName: currentUserName });

        await zg.loginRoom(roomId, token, {
          userID: currentUserId,
          userName: currentUserName
        });
        console.log('âœ… ç™»å½•æˆ¿é—´æˆåŠŸ');
        
        // åˆ›å»ºæœ¬åœ°æµ
        console.log('æ­£åœ¨åˆ›å»ºæœ¬åœ°æµ...');
        localStream = await zg.createStream({
          camera: { 
            video: true, 
            audio: true 
          }
        });
        console.log('åˆ›å»ºæœ¬åœ°æµæˆåŠŸ');
        
        // æ’­æ”¾æœ¬åœ°è§†é¢‘
        const localVideo = document.getElementById('localVideo');
        localVideo.srcObject = localStream;
        
        // æ›´æ–°æœ¬åœ°æ ‡ç­¾ï¼ˆæ˜¾ç¤ºèº«ä»½ + å§“åï¼‰
        const roleText = currentUserRole === 'customer' ? 'å®¢æˆ·' : 'é˜¿å§¨';
        document.getElementById('localLabel').textContent = `${roleText}ï¼š${userName}`;
        
        // æ¨æµ
        const streamID = 'stream_' + currentUserId;
        console.log('æ­£åœ¨æ¨æµ:', streamID);
        await zg.startPublishingStream(streamID, localStream);
        console.log('æ¨æµæˆåŠŸ');
        
        // éšè—åŠ å…¥é¢æ¿
        document.getElementById('joinPanel').style.display = 'none';
        hideMessage();

        // å¯åŠ¨é¢è¯•è®¡æ—¶å™¨
        startInterviewTimer();

      } catch (error) {
        console.error('âŒ åŠ å…¥æˆ¿é—´å¤±è´¥:', error);
        console.error('âŒ é”™è¯¯è¯¦æƒ…:', {
          message: error.message,
          code: error.code,
          name: error.name,
          stack: error.stack
        });

        let errorMsg = 'åŠ å…¥æˆ¿é—´å¤±è´¥';
        if (error.message) {
          errorMsg += ': ' + error.message;
        } else if (error.code) {
          errorMsg += ': é”™è¯¯ä»£ç  ' + error.code;
        } else {
          errorMsg += ': ' + JSON.stringify(error);
        }

        alert(errorMsg);
        hideMessage();
      }
    }

    // ==================== é¢è¯•è®¡æ—¶å™¨ ====================
    function startInterviewTimer() {
      interviewStartTime = Date.now();
      interviewTimer = setInterval(() => {
        const elapsed = Math.floor((Date.now() - interviewStartTime) / 1000);
        const minutes = Math.floor(elapsed / 60);
        const seconds = elapsed % 60;
        const timeStr = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        document.getElementById('interviewTime').textContent = timeStr;
      }, 1000);
    }

    function stopInterviewTimer() {
      if (interviewTimer) {
        clearInterval(interviewTimer);
        interviewTimer = null;
      }
    }
    
    // ==================== æ§åˆ¶åŠŸèƒ½ ====================
    function toggleMic() {
      if (!localStream) return;

      isMicOn = !isMicOn;
      zg.muteMicrophone(!isMicOn);

      const btn = document.getElementById('micBtn');
      const iconText = btn.querySelector('.control-icon-text');
      iconText.textContent = isMicOn ? 'ğŸ¤' : 'ğŸ”‡';

      console.log('éº¦å…‹é£:', isMicOn ? 'å¼€å¯' : 'å…³é—­');
    }

    function toggleCamera() {
      if (!localStream) return;

      isCameraOn = !isCameraOn;
      zg.mutePublishStreamVideo(localStream, !isCameraOn);

      const btn = document.getElementById('cameraBtn');
      const iconText = btn.querySelector('.control-icon-text');
      iconText.textContent = isCameraOn ? 'ğŸ“¹' : 'ğŸ“·';

      console.log('æ‘„åƒå¤´:', isCameraOn ? 'å¼€å¯' : 'å…³é—­');
    }
    
    function leaveRoom() {
      if (confirm('ç¡®å®šè¦ç¦»å¼€é¢è¯•é—´å—ï¼Ÿ')) {
        try {
          // åœæ­¢è®¡æ—¶å™¨
          stopInterviewTimer();

          if (zg && localStream) {
            zg.destroyStream(localStream);
            zg.logoutRoom(roomId);
          }

          // å°è¯•é€šçŸ¥å°ç¨‹åºå…³é—­
          if (typeof wx !== 'undefined' && wx.miniProgram) {
            wx.miniProgram.navigateBack();
          } else {
            // å¦‚æœä¸åœ¨å°ç¨‹åºä¸­ï¼Œæ˜¾ç¤ºæç¤º
            alert('å·²ç¦»å¼€é¢è¯•é—´');
            location.reload();
          }
        } catch (error) {
          console.error('ç¦»å¼€æˆ¿é—´å¤±è´¥:', error);
        }
      }
    }
    
    // ==================== å·¥å…·å‡½æ•° ====================
    function showMessage(msg) {
      let loading = document.getElementById('loading');
      if (!loading) {
        loading = document.createElement('div');
        loading.id = 'loading';
        loading.className = 'loading';
        document.body.appendChild(loading);
      }
      loading.textContent = msg;
      loading.style.display = 'block';
    }
    
    function hideMessage() {
      const loading = document.getElementById('loading');
      if (loading) {
        loading.style.display = 'none';
      }
    }
    
    // ==================== ç­‰å¾… SDK åŠ è½½ ====================
    function waitForSDK(maxRetries = 20, interval = 200) {
      return new Promise((resolve, reject) => {
        let retries = 0;

        const checkSDK = () => {
          console.log(`ğŸ”„ æ£€æŸ¥ SDK åŠ è½½çŠ¶æ€ (${retries + 1}/${maxRetries})...`);

          if (typeof ZegoExpressEngine !== 'undefined') {
            console.log('âœ… ZEGO SDK åŠ è½½æˆåŠŸï¼');
            resolve(true);
          } else if (retries >= maxRetries) {
            console.error('âŒ ZEGO SDK åŠ è½½è¶…æ—¶ï¼');
            reject(new Error('SDK åŠ è½½è¶…æ—¶'));
          } else {
            retries++;
            setTimeout(checkSDK, interval);
          }
        };

        checkSDK();
      });
    }

    // ==================== é¡µé¢åŠ è½½ ====================
    window.onload = async function() {
      console.log('é¡µé¢åŠ è½½å®Œæˆ');
      console.log('æˆ¿é—´å·:', roomId);

      // æ£€æŸ¥ SDK åŠ è½½çŠ¶æ€
      console.log('æ£€æŸ¥ ZEGO SDK åŠ è½½çŠ¶æ€...');
      console.log('ZegoExpressEngine æ˜¯å¦å­˜åœ¨:', typeof ZegoExpressEngine !== 'undefined');
      console.log('generateToken04 æ˜¯å¦å­˜åœ¨:', typeof generateToken04 !== 'undefined');

      if (typeof generateToken04 === 'undefined') {
        console.warn('âš ï¸ Token ç”Ÿæˆåº“æœªåŠ è½½');
      } else {
        console.log('âœ… Token ç”Ÿæˆåº“åŠ è½½æˆåŠŸ');
      }

      // ç­‰å¾… SDK åŠ è½½
      if (typeof ZegoExpressEngine === 'undefined') {
        console.log('â³ ZEGO SDK å°šæœªåŠ è½½ï¼Œç­‰å¾…ä¸­...');
        try {
          await waitForSDK();
        } catch (error) {
          console.error('âŒ ZEGO SDK åŠ è½½å¤±è´¥:', error);
          alert('è§†é¢‘SDKåŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥ååˆ·æ–°é¡µé¢é‡è¯•');
          return;
        }
      } else {
        console.log('âœ… ZEGO SDK å·²åŠ è½½');
      }

      initZego();
    };
    
    // é¡µé¢å¸è½½æ—¶æ¸…ç†
    window.onbeforeunload = function() {
      if (zg && localStream) {
        zg.destroyStream(localStream);
        zg.logoutRoom(roomId);
      }
    };
  </script>
</body>
</html>

