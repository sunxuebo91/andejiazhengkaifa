# 📱 视频镜像和声音问题修复说明

> **修复日期**: 2025-11-12  
> **修复文件**: 
> - `video-interview-host.html` (主持人端)
> - `video-interview-guest-room.html` (访客端)

---

## 🔍 问题分析

### 问题1: 视频方向相反（镜像问题）

**现象**:
- 前置摄像头拍摄时，画面左右相反
- 举起右手，画面中显示左手

**根本原因**:
- 代码中虽然有注释说"ZEGO SDK 默认已经设置了 OnlyPreviewMirror 模式"
- 但**实际上没有任何代码设置镜像**
- `createStream` 中只设置了 `video: { width, height, frameRate, bitrate }`
- **没有设置 `facingMode` 或镜像参数**
- CSS 中也没有镜像样式

### 问题2: 没有声音

**现象**:
- 只有画面，听不到对方声音
- 或者对方听不到自己的声音

**根本原因**:
- `audio: true` 已设置，但**没有详细的音频配置**
- **没有权限检查代码**（浏览器可能拒绝麦克风权限）
- **没有音频设备检测**（可能没有麦克风设备）
- 可能需要用户交互才能播放音频

---

## ✅ 修复方案

### 修复1: 添加CSS镜像效果

**位置**: CSS 样式部分

**修改前**:
```css
.video-player {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

/* ✅ ZEGO SDK 默认已经设置了 OnlyPreviewMirror 模式（本地预览镜像，推流不镜像）
 * 所以不需要用 CSS 再次翻转，否则会翻转两次导致画面反向
 */
```

**修改后**:
```css
.video-player {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

/* ✅ 本地视频镜像：让前置摄像头的画面符合自拍习惯（左右翻转）
 * 注意：只对本地预览镜像，推流给对方的画面是正常的（不镜像）
 */
#localVideo {
  transform: scaleX(-1);  /* 水平翻转本地视频 */
}
```

**效果**:
- 本地预览画面左右翻转（符合自拍习惯）
- 推流给对方的画面是正常的（不翻转）
- 对方看到的是正常方向的画面

---

### 修复2: 添加麦克风权限检查

**位置**: JavaScript 函数部分

**新增函数**:
```javascript
// ==================== 检查麦克风权限 ====================
async function checkMicrophonePermission() {
  try {
    console.log('🎤 检查麦克风权限...');
    // 请求麦克风权限（会触发浏览器权限提示）
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    // 立即停止，只是为了触发权限请求
    stream.getTracks().forEach(track => track.stop());
    console.log('✅ 麦克风权限已授予');
    return true;
  } catch (error) {
    console.error('❌ 麦克风权限被拒绝:', error);
    alert('请允许使用麦克风，否则无法进行语音通话');
    return false;
  }
}
```

**效果**:
- 在创建流之前先检查麦克风权限
- 如果权限被拒绝，提示用户并阻止继续
- 避免创建流时因权限问题失败

---

### 修复3: 添加音频设备检测

**位置**: JavaScript 函数部分

**新增函数**:
```javascript
// ==================== 检查音频设备 ====================
async function checkAudioDevices() {
  try {
    console.log('🔍 检测音频设备...');
    const devices = await zg.enumDevices();
    const microphones = devices.microphones;
    
    if (microphones.length === 0) {
      console.error('❌ 未检测到麦克风设备');
      alert('未检测到麦克风，请检查设备连接');
      return false;
    }
    
    console.log('✅ 可用的麦克风:', microphones);
    return true;
  } catch (error) {
    console.error('❌ 检测音频设备失败:', error);
    return false;
  }
}
```

**效果**:
- 检测系统中是否有可用的麦克风设备
- 如果没有麦克风，提示用户并阻止继续
- 避免因设备问题导致无声音

---

### 修复4: 增强音频配置

**位置**: `createStream` 函数

**修改前**:
```javascript
localStream = await zg.createStream({
  camera: {
    video: {
      width: 1280,
      height: 720,
      frameRate: 15,
      bitrate: 1500
    },
    audio: true
  }
});
```

**修改后**:
```javascript
localStream = await zg.createStream({
  camera: {
    video: {
      width: 1280,
      height: 720,
      frameRate: 15,
      bitrate: 1500,
      facingMode: 'user'  // 前置摄像头
    },
    audio: {
      ANS: true,  // 自动降噪 (Automatic Noise Suppression)
      AGC: true,  // 自动增益控制 (Automatic Gain Control)
      AEC: true   // 回声消除 (Acoustic Echo Cancellation)
    }
  }
});
```

**效果**:
- 明确指定使用前置摄像头 (`facingMode: 'user'`)
- 启用自动降噪（ANS）：减少背景噪音
- 启用自动增益控制（AGC）：自动调整音量
- 启用回声消除（AEC）：消除回声，提高通话质量

---

### 修复5: 在创建流前调用权限检查

**位置**: `createRoom()` 和 `joinRoom()` 函数

**修改前**:
```javascript
async function createRoom() {
  try {
    showMessage('正在创建面试间...');
    
    // 直接创建流
    localStream = await zg.createStream({...});
  }
}
```

**修改后**:
```javascript
async function createRoom() {
  try {
    showMessage('正在创建面试间...');
    
    // 🎤 步骤1: 检查麦克风权限
    const hasPermission = await checkMicrophonePermission();
    if (!hasPermission) {
      hideMessage();
      return;
    }

    // 🔍 步骤2: 检查音频设备
    const hasAudioDevice = await checkAudioDevices();
    if (!hasAudioDevice) {
      hideMessage();
      return;
    }
    
    // 然后再创建流
    localStream = await zg.createStream({...});
  }
}
```

**效果**:
- 在创建流之前先检查权限和设备
- 如果检查失败，提前终止，避免后续错误
- 提供更好的用户体验和错误提示

---

## 🎯 测试方法

### 测试镜像效果

1. 打开视频面试页面
2. 允许摄像头权限
3. 在镜头前举起右手
4. **预期结果**: 画面中显示右手（镜像正常）
5. 让另一个人加入房间
6. **预期结果**: 对方看到的是正常方向（你举右手，对方看到你的右手）

### 测试声音功能

1. 打开视频面试页面
2. **检查浏览器地址栏**: 应该看到麦克风权限提示
3. 点击"允许"授予麦克风权限
4. **检查控制台**: 应该看到 "✅ 麦克风权限已授予" 和 "✅ 可用的麦克风"
5. 说话测试
6. 让另一个人加入房间
7. **预期结果**: 双方都能听到对方的声音

### 测试权限被拒绝的情况

1. 打开视频面试页面
2. 在浏览器权限提示中点击"拒绝"
3. **预期结果**: 弹出提示 "请允许使用麦克风，否则无法进行语音通话"
4. 页面停止加载，不会继续创建流

### 测试没有麦克风的情况

1. 在系统设置中禁用麦克风
2. 打开视频面试页面
3. **预期结果**: 弹出提示 "未检测到麦克风，请检查设备连接"
4. 页面停止加载

---

## 📊 修复对比

| 项目 | 修复前 | 修复后 |
|------|--------|--------|
| **视频镜像** | ❌ 画面左右相反 | ✅ 本地预览镜像，推流正常 |
| **麦克风权限** | ❌ 没有检查 | ✅ 提前检查并提示 |
| **音频设备** | ❌ 没有检测 | ✅ 检测并提示 |
| **音频质量** | ⚠️ 基础配置 | ✅ 降噪+增益+回声消除 |
| **错误提示** | ❌ 不明确 | ✅ 清晰的错误提示 |
| **用户体验** | ⚠️ 一般 | ✅ 优秀 |

---

## 🔧 技术细节

### CSS 镜像原理

```css
#localVideo {
  transform: scaleX(-1);  /* 水平翻转 */
}
```

- `scaleX(-1)` 表示在 X 轴（水平方向）上缩放 -1 倍
- 效果等同于水平翻转（镜像）
- **只影响显示**，不影响推流数据

### 音频配置说明

- **ANS (Automatic Noise Suppression)**: 自动降噪
  - 减少背景噪音（风声、键盘声等）
  - 提高语音清晰度

- **AGC (Automatic Gain Control)**: 自动增益控制
  - 自动调整音量大小
  - 避免声音过大或过小

- **AEC (Acoustic Echo Cancellation)**: 回声消除
  - 消除扬声器播放的声音被麦克风再次采集
  - 避免回声和啸叫

---

## ⚠️ 注意事项

1. **浏览器兼容性**:
   - Chrome/Edge: 完全支持
   - Safari: 支持，但可能需要用户交互才能播放音频
   - Firefox: 支持

2. **HTTPS 要求**:
   - 麦克风和摄像头权限**必须在 HTTPS 环境**下才能使用
   - 本地测试可以使用 `localhost`

3. **权限持久化**:
   - 用户授予权限后，浏览器会记住
   - 下次访问不需要再次授权

4. **iOS Safari 特殊处理**:
   - iOS Safari 可能需要用户交互（点击）才能播放音频
   - 代码中已经添加了重试逻辑

---

## 📝 相关文档

- [ZEGO Web SDK 文档](https://doc-zh.zego.im/article/7637)
- [MDN - getUserMedia](https://developer.mozilla.org/zh-CN/docs/Web/API/MediaDevices/getUserMedia)
- [MDN - CSS transform](https://developer.mozilla.org/zh-CN/docs/Web/CSS/transform)

---

## 🎉 总结

通过以上修复，我们解决了：

1. ✅ **视频镜像问题**: 本地预览镜像，推流正常
2. ✅ **声音问题**: 权限检查 + 设备检测 + 音频优化
3. ✅ **用户体验**: 清晰的错误提示和引导
4. ✅ **音频质量**: 降噪、增益控制、回声消除

现在视频面试功能应该可以正常使用了！🎊

