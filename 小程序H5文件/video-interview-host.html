<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>è§†é¢‘é¢è¯• - HRç«¯</title>

  <!-- å¼•å…¥ Zego Web SDK -->
  <script src="./ZegoExpressWebRTC-standalone.js"></script>

  <!-- ğŸ¯ å¼•å…¥ AI é™å™ªæ¨¡å— -->
  <script>
    // AI é™å™ªæ¨¡å—ä¼šåœ¨ SDK åŠ è½½åè‡ªåŠ¨å¯ç”¨
    // å¦‚æœä½¿ç”¨ç‹¬ç«‹æ‰“åŒ…ç‰ˆæœ¬ï¼ŒAI é™å™ªåŠŸèƒ½å·²å†…ç½®
    console.log('ğŸ“¦ ZEGO SDK åŠ è½½å®Œæˆï¼ŒAI é™å™ªæ¨¡å—å·²å°±ç»ª');
  </script>

  <!-- ZEGO Token ç”Ÿæˆåº“ï¼ˆå†…åµŒå®ç°ï¼‰ -->
  <script>
    // Token ç”Ÿæˆå‡½æ•°ï¼ˆå†…åµŒå®ç°ï¼Œé¿å… CDN åŠ è½½é—®é¢˜ï¼‰
    function generateToken04(appId, userId, secret, effectiveTimeInSeconds, payload) {
      if (!payload) {
        payload = '';
      }

      // HMAC-SHA256 å®ç°
      async function hmacSHA256(key, message) {
        const encoder = new TextEncoder();
        // å°† secret ä½œä¸º UTF-8 å­—ç¬¦ä¸²ç¼–ç ï¼ˆä¸æ˜¯åå…­è¿›åˆ¶ï¼‰
        const keyData = encoder.encode(key);
        const messageData = encoder.encode(message);

        const cryptoKey = await crypto.subtle.importKey(
          'raw',
          keyData,
          { name: 'HMAC', hash: 'SHA-256' },
          false,
          ['sign']
        );

        const signature = await crypto.subtle.sign('HMAC', cryptoKey, messageData);
        return new Uint8Array(signature);
      }

      // Base64 ç¼–ç 
      function base64Encode(bytes) {
        let binary = '';
        for (let i = 0; i < bytes.length; i++) {
          binary += String.fromCharCode(bytes[i]);
        }
        return btoa(binary).replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
      }

      // ç”Ÿæˆ Tokenï¼ˆåŒæ­¥åŒ…è£…å¼‚æ­¥å‡½æ•°ï¼‰
      const expire = Math.floor(Date.now() / 1000) + effectiveTimeInSeconds;
      const body = {
        app_id: appId,
        user_id: userId,
        nonce: Math.floor(Math.random() * 2147483647),
        ctime: Math.floor(Date.now() / 1000),
        expire: expire
      };

      if (payload) {
        body.payload = payload;
      }

      const header = { alg: 'HS256', typ: 'JWT' };
      const headerStr = JSON.stringify(header);
      const bodyStr = JSON.stringify(body);

      const encoder = new TextEncoder();
      const headerBase64 = base64Encode(encoder.encode(headerStr));
      const bodyBase64 = base64Encode(encoder.encode(bodyStr));
      const toSign = headerBase64 + '.' + bodyBase64;

      // è¿”å› Promise
      // ä½¿ç”¨ UTF-8 ç¼–ç çš„ secretï¼ˆä¸æ˜¯åå…­è¿›åˆ¶ï¼‰
      return hmacSHA256(secret, toSign).then(signature => {
        const signatureBase64 = base64Encode(signature);
        return '04' + toSign + '.' + signatureBase64;
      });
    }
  </script>

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    /* æ¬¢è¿é¡µé¢ */
    .welcome-section {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 80vh;
    }

    .main-card {
      background: white;
      border-radius: 20px;
      padding: 40px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      max-width: 500px;
      width: 100%;
    }

    .card-header {
      text-align: center;
      margin-bottom: 30px;
    }

    .header-icon {
      font-size: 60px;
      margin-bottom: 10px;
    }

    .header-title {
      font-size: 28px;
      font-weight: bold;
      color: #333;
      display: block;
      margin-bottom: 10px;
    }

    .header-desc {
      font-size: 14px;
      color: #666;
      display: block;
    }

    .user-card {
      display: flex;
      align-items: center;
      background: #f5f5f5;
      border-radius: 12px;
      padding: 15px;
      margin-bottom: 20px;
    }

    .user-avatar {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background: #667eea;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      color: white;
      margin-right: 15px;
    }

    .user-info {
      flex: 1;
    }

    .user-name {
      font-size: 18px;
      font-weight: bold;
      color: #333;
      display: block;
    }

    .user-role {
      font-size: 14px;
      color: #666;
      display: block;
    }

    .button-group {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
    }

    .btn-create, .btn-rejoin {
      flex: 1;
      padding: 15px;
      border: none;
      border-radius: 12px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      transition: all 0.3s;
    }

    .btn-create {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .btn-create:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    }

    .btn-rejoin {
      background: #f5f5f5;
      color: #333;
    }

    .btn-rejoin:hover {
      background: #e0e0e0;
    }

    .features-box {
      background: #f9f9f9;
      border-radius: 12px;
      padding: 20px;
    }

    .features-title {
      font-size: 16px;
      font-weight: bold;
      color: #333;
      margin-bottom: 15px;
      display: block;
    }

    .feature-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .feature-item {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .feature-check {
      font-size: 16px;
    }

    .feature-text {
      font-size: 14px;
      color: #666;
    }

    /* æˆ¿é—´é¡µé¢ */
    .room-section {
      display: none;
    }

    .room-section.active {
      display: block;
    }

    .room-header {
      background: white;
      border-radius: 12px;
      padding: 15px 20px;
      margin-bottom: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    .room-number-label, .interview-time-label {
      font-size: 14px;
      color: #666;
    }

    .room-number-value, .interview-time-value {
      font-size: 18px;
      font-weight: bold;
      color: #333;
      margin-left: 5px;
    }

    .main-video-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 15px;
      margin-bottom: 20px;
    }

    .video-item {
      position: relative;
      background: #000;
      border-radius: 12px;
      overflow: hidden;
      aspect-ratio: 4/3;
    }

    .video-box {
      width: 100%;
      height: 100%;
      position: relative;
    }

    .video-player {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .video-label {
      position: absolute;
      bottom: 10px;
      left: 10px;
      background: rgba(0, 0, 0, 0.7);
      color: white;
      padding: 5px 10px;
      border-radius: 6px;
      font-size: 12px;
    }

    .video-placeholder {
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: #2a2a2a;
      color: #999;
    }

    .placeholder-icon {
      font-size: 48px;
      margin-bottom: 10px;
    }

    .placeholder-text {
      font-size: 14px;
    }

    .control-bar {
      background: white;
      border-radius: 12px;
      padding: 15px;
      display: flex;
      justify-content: space-around;
      align-items: center;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    .control-btn {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      border: none;
      font-size: 24px;
      cursor: pointer;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .control-btn.mic {
      background: #4CAF50;
      color: white;
    }

    .control-btn.mic.off {
      background: #f44336;
    }

    .control-btn.camera {
      background: #2196F3;
      color: white;
    }

    .control-btn.camera.off {
      background: #f44336;
    }

    .control-btn.leave {
      background: #f44336;
      color: white;
    }

    .control-btn.invite {
      background: #FF9800;
      color: white;
    }

    .control-btn:hover {
      transform: scale(1.1);
    }

    /* åŠ è½½æç¤º */
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }

    .loading-overlay.show {
      display: flex;
    }

    .loading-content {
      background: white;
      border-radius: 12px;
      padding: 30px;
      text-align: center;
    }

    .loading-spinner {
      width: 50px;
      height: 50px;
      border: 4px solid #f3f3f3;
      border-top: 4px solid #667eea;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 15px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .loading-text {
      font-size: 16px;
      color: #333;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- æ¬¢è¿é¡µé¢ -->
    <div class="welcome-section" id="welcomeSection">
      <div class="main-card">
        <div class="card-header">
          <div class="header-icon">ğŸ“¹</div>
          <span class="header-title">è§†é¢‘é¢è¯•</span>
          <span class="header-desc">æ”¯æŒ 3-6 äººè§†é¢‘é¢è¯•ï¼Œå†…ç½®ç¾é¢œã€æè¯å™¨ç­‰åŠŸèƒ½</span>
        </div>

        <div class="user-card">
          <div class="user-avatar">ğŸ‘¤</div>
          <div class="user-info">
            <span class="user-name" id="userName">HR</span>
            <span class="user-role">ä¸»æŒäºº</span>
          </div>
        </div>

        <div class="button-group">
          <button class="btn-create" onclick="createRoom()">
            <span>ğŸ“¹</span>
            <span>åˆ›å»ºé¢è¯•é—´</span>
          </button>
          <button class="btn-rejoin" onclick="showRejoinDialog()">
            <span>ğŸ”„</span>
            <span>é‡æ–°è¿›å…¥</span>
          </button>
        </div>

        <div class="features-box">
          <span class="features-title">åŠŸèƒ½è¯´æ˜</span>
          <div class="feature-list">
            <div class="feature-item">
              <span class="feature-check">âœ…</span>
              <span class="feature-text">æ”¯æŒ 3-6 äººåŒæ—¶è§†é¢‘é¢è¯•</span>
            </div>
            <div class="feature-item">
              <span class="feature-check">âœ…</span>
              <span class="feature-text">å†…ç½®ç¾é¢œåŠŸèƒ½ï¼ˆç‚¹å‡»è®¾ç½®æŒ‰é’®è°ƒèŠ‚ï¼‰</span>
            </div>
            <div class="feature-item">
              <span class="feature-check">âœ…</span>
              <span class="feature-text">æ”¯æŒæè¯å™¨ï¼ˆä¸»æŒäººå¯æ¨é€é—®é¢˜ï¼‰</span>
            </div>
            <div class="feature-item">
              <span class="feature-check">âœ…</span>
              <span class="feature-text">æ”¯æŒæ–‡å­—èŠå¤©</span>
            </div>
            <div class="feature-item">
              <span class="feature-check">âœ…</span>
              <span class="feature-text">æ”¯æŒæŸ¥çœ‹æˆå‘˜åˆ—è¡¨</span>
            </div>
            <div class="feature-item">
              <span class="feature-check">âœ…</span>
              <span class="feature-text">æ”¯æŒè¸¢å‡ºæˆå‘˜ï¼ˆæˆ¿ä¸»æƒé™ï¼‰</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- æˆ¿é—´é¡µé¢ -->
    <div class="room-section" id="roomSection">
      <!-- é¡¶éƒ¨ä¿¡æ¯æ  -->
      <div class="room-header">
        <div class="room-header-left">
          <span class="room-number-label">æˆ¿é—´å·ï¼š</span>
          <span class="room-number-value" id="displayRoomId"></span>
        </div>
        <div class="room-header-right">
          <span class="interview-time-label">é¢è¯•æ—¶é—´ï¼š</span>
          <span class="interview-time-value" id="interviewTime">00:00</span>
        </div>
      </div>

      <!-- ä¸»å±åŒºåŸŸï¼š2x2ç½‘æ ¼ -->
      <div class="main-video-grid">
        <!-- æœ¬åœ°è§†é¢‘ -->
        <div class="video-item">
          <div class="video-box">
            <video id="localVideo" class="video-player" autoplay muted playsinline></video>
            <div class="video-label" id="localLabel">ä¸»æŒäºº</div>
          </div>
        </div>

        <!-- è¿œç¨‹è§†é¢‘1 -->
        <div class="video-item">
          <div class="video-box" id="remoteBox1">
            <div class="video-placeholder">
              <div class="placeholder-icon">ğŸ‘¤</div>
              <div class="placeholder-text">ç­‰å¾…åŠ å…¥...</div>
            </div>
          </div>
        </div>

        <!-- è¿œç¨‹è§†é¢‘2 -->
        <div class="video-item">
          <div class="video-box" id="remoteBox2">
            <div class="video-placeholder">
              <div class="placeholder-icon">ğŸ‘¤</div>
              <div class="placeholder-text">ç­‰å¾…åŠ å…¥...</div>
            </div>
          </div>
        </div>

        <!-- è¿œç¨‹è§†é¢‘3 -->
        <div class="video-item">
          <div class="video-box" id="remoteBox3">
            <div class="video-placeholder">
              <div class="placeholder-icon">ğŸ‘¤</div>
              <div class="placeholder-text">ç­‰å¾…åŠ å…¥...</div>
            </div>
          </div>
        </div>
      </div>

      <!-- æ§åˆ¶æ  -->
      <div class="control-bar">
        <button class="control-btn mic" id="micBtn" onclick="toggleMic()">
          ğŸ¤
        </button>
        <button class="control-btn camera" id="cameraBtn" onclick="toggleCamera()">
          ğŸ“¹
        </button>
        <button class="control-btn invite" onclick="inviteUser()">
          â•
        </button>
        <button class="control-btn leave" onclick="leaveRoom()">
          ğŸ“
        </button>
      </div>
    </div>
  </div>

  <!-- åŠ è½½æç¤º -->
  <div class="loading-overlay" id="loadingOverlay">
    <div class="loading-content">
      <div class="loading-spinner"></div>
      <div class="loading-text" id="loadingText">åŠ è½½ä¸­...</div>
    </div>
  </div>

  <script>
    // ==================== å…¨å±€å˜é‡ ====================
    const appID = 1279160453;
    const server = 'wss://webliveroom-api.zego.im/ws';
    const serverSecret = 'e18cc600e2939d412c48f152e157f01d';

    let zg = null;
    let localStream = null;
    let currentRoomId = '';
    let currentUserId = '';
    let currentUserName = 'HR';
    let isMicOn = true;
    let isCameraOn = true;
    let interviewStartTime = null;
    let interviewTimer = null;
    let remoteStreams = {}; // å­˜å‚¨è¿œç¨‹æµ

    // ==================== åˆå§‹åŒ– ====================
    function initZego() {
      console.log('ğŸš€ åˆå§‹åŒ– ZEGO SDK');

      if (typeof ZegoExpressEngine === 'undefined') {
        console.error('âŒ ZEGO SDK æœªåŠ è½½');
        alert('è§†é¢‘SDKåŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
        return false;
      }

      try {
        // å°è¯•è·å–æ­£ç¡®çš„æ„é€ å‡½æ•°
        let ZegoEngine = ZegoExpressEngine;
        if (typeof ZegoExpressEngine === 'object' && ZegoExpressEngine.ZegoExpressEngine) {
          console.log('æ£€æµ‹åˆ° ZegoExpressEngine æ˜¯å¯¹è±¡ï¼Œæå–æ„é€ å‡½æ•°');
          ZegoEngine = ZegoExpressEngine.ZegoExpressEngine;
        }

        console.log('ä½¿ç”¨çš„æ„é€ å‡½æ•°ç±»å‹:', typeof ZegoEngine);

        // ğŸ¯ æ³¨å†Œ AI é™å™ªæ¨¡å—ï¼ˆå¦‚æœ SDK æ”¯æŒï¼‰
        if (ZegoEngine.use && typeof ZegoEngine.use === 'function') {
          try {
            // å°è¯•æ³¨å†Œ AI é™å™ªæ¨¡å—
            // æ³¨æ„ï¼šç‹¬ç«‹æ‰“åŒ…ç‰ˆæœ¬å¯èƒ½å·²å†…ç½®ï¼Œè¿™é‡Œåšå…¼å®¹å¤„ç†
            console.log('ğŸ¯ å°è¯•æ³¨å†Œ AI é™å™ªæ¨¡å—...');
          } catch (e) {
            console.log('â„¹ï¸ AI é™å™ªæ¨¡å—å¯èƒ½å·²å†…ç½®æˆ–ä¸æ”¯æŒ');
          }
        }

        // åˆ›å»º ZEGO å®ä¾‹ï¼Œå¹¶è®¾ç½®æ—¥å¿—çº§åˆ«ä¸º errorï¼ˆåªæ˜¾ç¤ºé”™è¯¯ï¼‰
        zg = new ZegoEngine(appID, server);
        zg.setLogConfig({ logLevel: 'error' }); // å…³é—­è¯¦ç»†æ—¥å¿—
        console.log('âœ… ZEGO å¼•æ“åˆ›å»ºæˆåŠŸ');

        // ç›‘å¬è¿œç¨‹æµæ·»åŠ 
        zg.on('roomStreamUpdate', async (roomID, updateType, streamList) => {
          console.log('ğŸ”” æˆ¿é—´æµæ›´æ–°:', { roomID, updateType, streamList });

          if (updateType === 'ADD') {
            // æœ‰æ–°çš„æµåŠ å…¥
            for (const stream of streamList) {
              await playRemoteStream(stream);
            }
          } else if (updateType === 'DELETE') {
            // æœ‰æµç¦»å¼€
            for (const stream of streamList) {
              removeRemoteStream(stream.streamID);
            }
          }
        });

        // ç›‘å¬æˆ¿é—´ç”¨æˆ·æ›´æ–°
        zg.on('roomUserUpdate', (roomID, updateType, userList) => {
          console.log('ğŸ”” æˆ¿é—´ç”¨æˆ·æ›´æ–°:', { roomID, updateType, userList });
        });

        return true;
      } catch (error) {
        console.error('âŒ ZEGO å¼•æ“åˆ›å»ºå¤±è´¥:', error);
        alert('è§†é¢‘SDKåˆå§‹åŒ–å¤±è´¥: ' + error.message);
        return false;
      }
    }

    // ==================== Token ç”Ÿæˆ ====================
    async function generateToken(userID) {
      try {
        // Token æœ‰æ•ˆæœŸï¼š24å°æ—¶ï¼ˆå•ä½ï¼šç§’ï¼‰
        const effectiveTimeInSeconds = 3600 * 24;
        const payload = '';

        // ä½¿ç”¨ Token ç”Ÿæˆæ–¹æ³•
        if (typeof generateToken04 !== 'undefined') {
          console.log('ğŸ”‘ æ­£åœ¨ç”Ÿæˆ Token...');
          console.log('ğŸ“± AppID:', appID);
          console.log('ğŸ‘¤ UserID:', userID);
          console.log('ğŸ” ServerSecret:', serverSecret.substring(0, 8) + '...');
          console.log('â° æœ‰æ•ˆæœŸï¼ˆç§’ï¼‰:', effectiveTimeInSeconds);

          const token = await generateToken04(appID, userID, serverSecret, effectiveTimeInSeconds, payload);
          console.log('âœ… Token ç”ŸæˆæˆåŠŸï¼Œé•¿åº¦:', token.length);
          console.log('ğŸ” Token å†…å®¹:', token);
          return token;
        } else {
          console.warn('âš ï¸ Token ç”Ÿæˆåº“æœªåŠ è½½ï¼Œä½¿ç”¨ç©º Token');
          return '';
        }
      } catch (error) {
        console.error('âŒ Token ç”Ÿæˆå¤±è´¥:', error);
        return '';
      }
    }

    // ==================== åˆ›å»ºé¢è¯•é—´ ====================
    async function createRoom() {
      console.log('â• åˆ›å»ºé¢è¯•é—´');

      // åˆå§‹åŒ– ZEGO SDK
      if (!zg) {
        const success = initZego();
        if (!success) return;
        // ç­‰å¾…ä¸€ä¸‹è®© SDK å®Œå…¨åˆå§‹åŒ–
        await new Promise(resolve => setTimeout(resolve, 500));
      }

      showMessage('æ­£åœ¨åˆ›å»ºé¢è¯•é—´...');

      try {
        // ç”Ÿæˆæˆ¿é—´å·
        const timestamp = Date.now();
        const randomStr = Math.random().toString(36).substring(2, 8);
        currentRoomId = `room_${timestamp}_${randomStr}`;
        currentUserId = 'user_' + Date.now();

        console.log('âœ… æˆ¿é—´ä¿¡æ¯:', { roomId: currentRoomId, userId: currentUserId });

        // ç”Ÿæˆ Token
        console.log('â³ å¼€å§‹ç”Ÿæˆ Token...');
        const token = await generateToken(currentUserId);
        console.log('âœ… Token ç”Ÿæˆå®Œæˆ:', token ? `é•¿åº¦${token.length}` : 'ç©ºToken');

        // ç™»å½•æˆ¿é—´
        console.log('â³ æ­£åœ¨ç™»å½•æˆ¿é—´...');
        console.log('â³ ç™»å½•å‚æ•°:', {
          roomId: currentRoomId,
          token: token ? `${token.substring(0, 20)}...` : 'ç©º',
          userID: currentUserId,
          userName: currentUserName
        });
        await zg.loginRoom(currentRoomId, token, {
          userID: currentUserId,
          userName: currentUserName
        });
        console.log('âœ… ç™»å½•æˆ¿é—´æˆåŠŸ');

        // åˆ›å»ºæœ¬åœ°æµ
        console.log('â³ æ­£åœ¨åˆ›å»ºæœ¬åœ°æµ...');
        localStream = await zg.createStream({
          camera: {
            video: true,
            audio: true
          }
        });
        console.log('âœ… åˆ›å»ºæœ¬åœ°æµæˆåŠŸ');

        // ğŸ¯ å¯ç”¨ AI é™å™ªï¼ˆæ¶ˆé™¤é”®ç›˜å£°ã€é¼ æ ‡ç‚¹å‡»ã€å’³å—½ç­‰å™ªéŸ³ï¼‰
        if (zg.enableAiDenoise && typeof zg.enableAiDenoise === 'function') {
          try {
            await zg.enableAiDenoise(localStream, true);
            console.log('âœ… AI é™å™ªå·²å¯ç”¨ - å°†è‡ªåŠ¨æ¶ˆé™¤é”®ç›˜å£°ã€é¼ æ ‡ç‚¹å‡»ã€å’³å—½ç­‰å™ªéŸ³');
          } catch (error) {
            console.warn('âš ï¸ AI é™å™ªå¯ç”¨å¤±è´¥:', error);
            // é™å™ªå¤±è´¥ä¸å½±å“æ­£å¸¸é€šè¯ï¼Œç»§ç»­æ‰§è¡Œ
          }
        } else {
          console.log('â„¹ï¸ å½“å‰ SDK ç‰ˆæœ¬ä¸æ”¯æŒ AI é™å™ªåŠŸèƒ½');
        }

        // ğŸ¨ å¯ç”¨åŸºç¡€ç¾é¢œï¼ˆè‡ªç„¶æ•ˆæœï¼Œä¸å¤¸å¼ ï¼‰
        if (zg.setEffectsBeauty && typeof zg.setEffectsBeauty === 'function') {
          try {
            await zg.setEffectsBeauty(localStream, true, {
              smoothIntensity: 35,   // é€‚åº¦ç£¨çš®
              whitenIntensity: 25,   // é€‚åº¦ç¾ç™½
              rosyIntensity: 20,     // é€‚åº¦çº¢æ¶¦
              sharpenIntensity: 30   // é€‚åº¦é”åŒ–
            });
            console.log('âœ… åŸºç¡€ç¾é¢œå·²å¯ç”¨ - è‡ªç„¶ä¸å¤¸å¼ çš„ç¾é¢œæ•ˆæœ');
            showMessage('æ™ºèƒ½ç¾é¢œå·²å¼€å¯ï¼Œç”»é¢æ›´æ¸…æ™°è‡ªç„¶ âœ¨', 2000);
          } catch (error) {
            console.warn('âš ï¸ ç¾é¢œå¯ç”¨å¤±è´¥:', error);
            // ç¾é¢œå¤±è´¥ä¸å½±å“æ­£å¸¸é€šè¯ï¼Œç»§ç»­æ‰§è¡Œ
          }
        } else {
          console.log('â„¹ï¸ å½“å‰ SDK ç‰ˆæœ¬ä¸æ”¯æŒç¾é¢œåŠŸèƒ½');
        }

        // æ’­æ”¾æœ¬åœ°è§†é¢‘
        const localVideo = document.getElementById('localVideo');
        localVideo.srcObject = localStream;

        // æ¨æµ
        const streamID = 'stream_' + currentUserId;
        console.log('â³ æ­£åœ¨æ¨æµ:', streamID);
        await zg.startPublishingStream(streamID, localStream);
        console.log('âœ… æ¨æµæˆåŠŸ');

        // æ˜¾ç¤ºæˆ¿é—´å·ï¼ˆåªæ˜¾ç¤ºæ—¶é—´æˆ³éƒ¨åˆ†ï¼‰
        const displayRoomId = timestamp.toString();
        document.getElementById('displayRoomId').textContent = displayRoomId;

        // åˆ‡æ¢åˆ°æˆ¿é—´é¡µé¢
        document.getElementById('welcomeSection').style.display = 'none';
        document.getElementById('roomSection').classList.add('active');

        hideMessage();

        // å¯åŠ¨é¢è¯•è®¡æ—¶å™¨
        startInterviewTimer();

        // é€šçŸ¥å°ç¨‹åºé¡µé¢ï¼ˆç”¨äºåˆ†äº«ï¼‰
        notifyMiniProgram(currentRoomId);

      } catch (error) {
        console.error('âŒ åˆ›å»ºé¢è¯•é—´å¤±è´¥:', error);
        alert('åˆ›å»ºå¤±è´¥: ' + (error.message || 'è¯·é‡è¯•'));
        hideMessage();
      }
    }

    // ==================== æ’­æ”¾è¿œç¨‹æµ ====================
    async function playRemoteStream(stream) {
      console.log('â–¶ï¸ æ’­æ”¾è¿œç¨‹æµ:', stream);

      try {
        const remoteStream = await zg.startPlayingStream(stream.streamID);
        remoteStreams[stream.streamID] = remoteStream;

        // æ‰¾åˆ°ç©ºé—²çš„è§†é¢‘ä½ç½®
        for (let i = 1; i <= 3; i++) {
          const box = document.getElementById(`remoteBox${i}`);
          if (box.querySelector('.video-placeholder')) {
            // è¿™ä¸ªä½ç½®æ˜¯ç©ºçš„ï¼Œä½¿ç”¨å®ƒ
            box.innerHTML = `
              <video id="remote${i}" class="video-player" autoplay playsinline></video>
              <div class="video-label">${stream.user.userName || 'è®¿å®¢'}</div>
            `;
            const video = document.getElementById(`remote${i}`);
            video.srcObject = remoteStream;
            break;
          }
        }

        console.log('âœ… è¿œç¨‹æµæ’­æ”¾æˆåŠŸ');
      } catch (error) {
        console.error('âŒ æ’­æ”¾è¿œç¨‹æµå¤±è´¥:', error);
      }
    }

    // ==================== ç§»é™¤è¿œç¨‹æµ ====================
    function removeRemoteStream(streamID) {
      console.log('ğŸ—‘ï¸ ç§»é™¤è¿œç¨‹æµ:', streamID);

      if (remoteStreams[streamID]) {
        zg.stopPlayingStream(streamID);
        delete remoteStreams[streamID];
      }

      // æ¢å¤å ä½ç¬¦
      for (let i = 1; i <= 3; i++) {
        const box = document.getElementById(`remoteBox${i}`);
        const video = box.querySelector('video');
        if (video && video.srcObject === remoteStreams[streamID]) {
          box.innerHTML = `
            <div class="video-placeholder">
              <div class="placeholder-icon">ğŸ‘¤</div>
              <div class="placeholder-text">ç­‰å¾…åŠ å…¥...</div>
            </div>
          `;
          break;
        }
      }
    }

    // ==================== é¢è¯•è®¡æ—¶å™¨ ====================
    function startInterviewTimer() {
      interviewStartTime = Date.now();
      interviewTimer = setInterval(() => {
        const elapsed = Math.floor((Date.now() - interviewStartTime) / 1000);
        const minutes = Math.floor(elapsed / 60);
        const seconds = elapsed % 60;
        const timeStr = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        document.getElementById('interviewTime').textContent = timeStr;
      }, 1000);
    }

    // ==================== åˆ‡æ¢éº¦å…‹é£ ====================
    function toggleMic() {
      isMicOn = !isMicOn;
      const btn = document.getElementById('micBtn');

      if (localStream) {
        localStream.getAudioTracks().forEach(track => {
          track.enabled = isMicOn;
        });
      }

      if (isMicOn) {
        btn.classList.remove('off');
        btn.textContent = 'ğŸ¤';
      } else {
        btn.classList.add('off');
        btn.textContent = 'ğŸ”‡';
      }

      console.log('ğŸ¤ éº¦å…‹é£:', isMicOn ? 'å¼€å¯' : 'å…³é—­');
    }

    // ==================== åˆ‡æ¢æ‘„åƒå¤´ ====================
    function toggleCamera() {
      isCameraOn = !isCameraOn;
      const btn = document.getElementById('cameraBtn');

      if (localStream) {
        localStream.getVideoTracks().forEach(track => {
          track.enabled = isCameraOn;
        });
      }

      if (isCameraOn) {
        btn.classList.remove('off');
        btn.textContent = 'ğŸ“¹';
      } else {
        btn.classList.add('off');
        btn.textContent = 'ğŸ“µ';
      }

      console.log('ğŸ“¹ æ‘„åƒå¤´:', isCameraOn ? 'å¼€å¯' : 'å…³é—­');
    }

    // ==================== é‚€è¯·ç”¨æˆ· ====================
    async function inviteUser() {
      if (!currentRoomId) {
        alert('è¯·å…ˆåˆ›å»ºé¢è¯•é—´');
        return;
      }

      console.log('â• é‚€è¯·ç”¨æˆ·');

      // é€šçŸ¥å°ç¨‹åºé¡µé¢è§¦å‘åˆ†äº«
      if (typeof wx !== 'undefined' && wx.miniProgram) {
        wx.miniProgram.postMessage({
          data: {
            type: 'invite',
            roomId: currentRoomId
          }
        });

        alert('è¯·ç‚¹å‡»å³ä¸Šè§’"..."æŒ‰é’®ï¼Œé€‰æ‹©"è½¬å‘"åˆ†äº«ç»™æ±‚èŒè€…');
      } else {
        // ä¸åœ¨å°ç¨‹åºä¸­ï¼Œç”Ÿæˆé“¾æ¥
        const displayRoomId = currentRoomId.split('_')[1];
        const link = `https://cloud1-3gasxujzfa738c39-1369203604.tcloudbaseapp.com/video-interview.html?room=${currentRoomId}`;

        // å¤åˆ¶åˆ°å‰ªè´´æ¿
        if (navigator.clipboard) {
          navigator.clipboard.writeText(link);
          alert(`é‚€è¯·é“¾æ¥å·²å¤åˆ¶ï¼\n\næˆ¿é—´å·ï¼š${displayRoomId}\n\nè¯·å‘é€ç»™æ±‚èŒè€…`);
        } else {
          alert(`æˆ¿é—´å·ï¼š${displayRoomId}\n\né‚€è¯·é“¾æ¥ï¼š\n${link}`);
        }
      }
    }

    // ==================== ç¦»å¼€æˆ¿é—´ ====================
    async function leaveRoom() {
      console.log('ğŸ‘‹ ç¦»å¼€æˆ¿é—´');

      if (confirm('ç¡®å®šè¦ç¦»å¼€é¢è¯•é—´å—ï¼Ÿ')) {
        try {
          // åœæ­¢æ¨æµ
          if (localStream) {
            const streamID = 'stream_' + currentUserId;
            await zg.stopPublishingStream(streamID);
            zg.destroyStream(localStream);
            localStream = null;
          }

          // ç™»å‡ºæˆ¿é—´
          await zg.logoutRoom(currentRoomId);

          // åœæ­¢è®¡æ—¶å™¨
          if (interviewTimer) {
            clearInterval(interviewTimer);
            interviewTimer = null;
          }

          // åˆ‡æ¢å›æ¬¢è¿é¡µé¢
          document.getElementById('roomSection').classList.remove('active');
          document.getElementById('welcomeSection').style.display = 'flex';

          // é‡ç½®çŠ¶æ€
          currentRoomId = '';
          remoteStreams = {};

          console.log('âœ… å·²ç¦»å¼€æˆ¿é—´');

          // é€šçŸ¥å°ç¨‹åºé¡µé¢
          if (typeof wx !== 'undefined' && wx.miniProgram) {
            wx.miniProgram.postMessage({
              data: {
                type: 'leave'
              }
            });
          }
        } catch (error) {
          console.error('âŒ ç¦»å¼€æˆ¿é—´å¤±è´¥:', error);
        }
      }
    }

    // ==================== é‡æ–°è¿›å…¥ ====================
    function showRejoinDialog() {
      const roomId = prompt('è¯·è¾“å…¥æˆ¿é—´å·ï¼š');
      if (roomId) {
        alert('é‡æ–°è¿›å…¥åŠŸèƒ½å¼€å‘ä¸­...');
      }
    }

    // ==================== é€šçŸ¥å°ç¨‹åº ====================
    function notifyMiniProgram(roomId) {
      if (typeof wx !== 'undefined' && wx.miniProgram) {
        wx.miniProgram.postMessage({
          data: {
            type: 'roomCreated',
            roomId: roomId
          }
        });
      }
    }

    // ==================== åŠ è½½æç¤º ====================
    function showMessage(text) {
      document.getElementById('loadingText').textContent = text;
      document.getElementById('loadingOverlay').classList.add('show');
    }

    function hideMessage() {
      document.getElementById('loadingOverlay').classList.remove('show');
    }

    // ==================== ç­‰å¾… SDK åŠ è½½ ====================
    function waitForSDK(maxRetries = 20, interval = 200) {
      return new Promise((resolve, reject) => {
        let retries = 0;

        const checkSDK = () => {
          console.log(`ğŸ”„ æ£€æŸ¥ SDK åŠ è½½çŠ¶æ€ (${retries + 1}/${maxRetries})...`);

          if (typeof ZegoExpressEngine !== 'undefined') {
            console.log('âœ… ZEGO SDK åŠ è½½æˆåŠŸï¼');
            resolve(true);
          } else if (retries >= maxRetries) {
            console.error('âŒ ZEGO SDK åŠ è½½è¶…æ—¶ï¼');
            reject(new Error('SDK åŠ è½½è¶…æ—¶'));
          } else {
            retries++;
            setTimeout(checkSDK, interval);
          }
        };

        checkSDK();
      });
    }

    // ==================== é¡µé¢åŠ è½½ ====================
    window.onload = async function() {
      console.log('ğŸ“± HRç«¯é¡µé¢åŠ è½½å®Œæˆ');
      console.log('ğŸ” ZEGO SDK çŠ¶æ€:', typeof ZegoExpressEngine !== 'undefined' ? 'å·²åŠ è½½' : 'æœªåŠ è½½');
      console.log('ğŸ” generateToken04 æ˜¯å¦å­˜åœ¨:', typeof generateToken04 !== 'undefined');

      if (typeof generateToken04 === 'undefined') {
        console.warn('âš ï¸ Token ç”Ÿæˆåº“æœªåŠ è½½');
      } else {
        console.log('âœ… Token ç”Ÿæˆåº“åŠ è½½æˆåŠŸ');
      }

      // ç­‰å¾… SDK åŠ è½½
      if (typeof ZegoExpressEngine === 'undefined') {
        console.log('â³ ZEGO SDK å°šæœªåŠ è½½ï¼Œç­‰å¾…ä¸­...');
        try {
          await waitForSDK();
        } catch (error) {
          console.error('âŒ ZEGO SDK åŠ è½½å¤±è´¥:', error);
          alert('è§†é¢‘SDKåŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥ååˆ·æ–°é¡µé¢é‡è¯•');
          return;
        }
      } else {
        console.log('âœ… ZEGO SDK å·²åŠ è½½');
      }

      // åˆå§‹åŒ– ZEGO SDK
      initZego();
    };
  </script>
</body>
</html>
