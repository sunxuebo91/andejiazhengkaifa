# è§†é¢‘é¢è¯• H5 éƒ¨ç½²é…ç½®è¯¦ç»†è¯´æ˜

## ğŸ“‹ ç›®å½•

1. [æœåŠ¡å™¨ç¯å¢ƒè¦æ±‚](#æœåŠ¡å™¨ç¯å¢ƒè¦æ±‚)
2. [Nginx å®Œæ•´é…ç½®](#nginx-å®Œæ•´é…ç½®)
3. [Apache é…ç½®](#apache-é…ç½®)
4. [å®å¡”é¢æ¿é…ç½®](#å®å¡”é¢æ¿é…ç½®)
5. [åŸŸå SSL è¯ä¹¦é…ç½®](#åŸŸå-ssl-è¯ä¹¦é…ç½®)
6. [å°ç¨‹åºé…ç½®ä¿®æ”¹](#å°ç¨‹åºé…ç½®ä¿®æ”¹)
7. [æµ‹è¯•éªŒè¯](#æµ‹è¯•éªŒè¯)

---

## æœåŠ¡å™¨ç¯å¢ƒè¦æ±‚

### æœ€ä½è¦æ±‚

- **æ“ä½œç³»ç»Ÿ**ï¼šLinux (Ubuntu/CentOS) æˆ– Windows Server
- **Web æœåŠ¡å™¨**ï¼šNginx 1.18+ æˆ– Apache 2.4+
- **SSL è¯ä¹¦**ï¼šå¿…é¡»ï¼ˆLet's Encrypt å…è´¹è¯ä¹¦å³å¯ï¼‰
- **å¸¦å®½**ï¼šå»ºè®® 10Mbps ä»¥ä¸Š
- **å­˜å‚¨ç©ºé—´**ï¼šè‡³å°‘ 100MB

### æ¨èé…ç½®

- **CPU**ï¼š2æ ¸å¿ƒä»¥ä¸Š
- **å†…å­˜**ï¼š2GB ä»¥ä¸Š
- **å¸¦å®½**ï¼š20Mbps ä»¥ä¸Š
- **CDN**ï¼šå»ºè®®ä½¿ç”¨ CDN åŠ é€Ÿï¼ˆå¯é€‰ï¼‰

---

## Nginx å®Œæ•´é…ç½®

### æ–¹æ¡ˆ 1ï¼šä½¿ç”¨å­ç›®å½•ï¼ˆæ¨èï¼‰

**é€‚ç”¨åœºæ™¯**ï¼šå·²æœ‰åŸŸå `api.yourdomain.com`ï¼Œåœ¨å…¶ä¸‹åˆ›å»º `/h5/` å­ç›®å½•

**é…ç½®æ–‡ä»¶**ï¼š`/etc/nginx/sites-available/yourdomain.conf`

```nginx
# HTTP è‡ªåŠ¨è·³è½¬åˆ° HTTPS
server {
    listen 80;
    server_name api.yourdomain.com;
    return 301 https://$server_name$request_uri;
}

# HTTPS é…ç½®
server {
    listen 443 ssl http2;
    server_name api.yourdomain.com;
    
    # SSL è¯ä¹¦é…ç½®
    ssl_certificate /etc/letsencrypt/live/api.yourdomain.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/api.yourdomain.com/privkey.pem;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;
    ssl_prefer_server_ciphers on;
    
    # æ—¥å¿—é…ç½®
    access_log /var/log/nginx/api.yourdomain.com.access.log;
    error_log /var/log/nginx/api.yourdomain.com.error.log;
    
    # H5 è§†é¢‘é¢è¯•æ–‡ä»¶
    location /h5/ {
        alias /var/www/html/h5/;
        index video-interview-host.html;
        
        # å…è®¸è·¨åŸŸï¼ˆå¦‚æœéœ€è¦ï¼‰
        add_header Access-Control-Allow-Origin *;
        add_header Access-Control-Allow-Methods 'GET, POST, OPTIONS';
        add_header Access-Control-Allow-Headers 'DNT,X-Mx-ReqToken,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Authorization';
        
        # ç¼“å­˜é…ç½®
        location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg)$ {
            expires 30d;
            add_header Cache-Control "public, immutable";
        }
        
        # HTML æ–‡ä»¶ä¸ç¼“å­˜
        location ~* \.(html)$ {
            expires -1;
            add_header Cache-Control "no-store, no-cache, must-revalidate, proxy-revalidate";
        }
    }
    
    # å¾®ä¿¡æ ¡éªŒæ–‡ä»¶
    location ~ ^/[A-Za-z0-9]+\.txt$ {
        root /var/www/html;
    }
    
    # å…¶ä»– API é…ç½®...
    location /api/ {
        proxy_pass http://localhost:3000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
```

**è®¿é—®åœ°å€**ï¼š
- HRç«¯ï¼š`https://api.yourdomain.com/h5/video-interview-host.html`
- è®¿å®¢ç«¯ï¼š`https://api.yourdomain.com/h5/video-interview.html?room=xxx`

---

### æ–¹æ¡ˆ 2ï¼šä½¿ç”¨ç‹¬ç«‹å­åŸŸå

**é€‚ç”¨åœºæ™¯**ï¼šåˆ›å»ºä¸“é—¨çš„å­åŸŸå `interview.yourdomain.com`

**é…ç½®æ–‡ä»¶**ï¼š`/etc/nginx/sites-available/interview.conf`

```nginx
# HTTP è‡ªåŠ¨è·³è½¬åˆ° HTTPS
server {
    listen 80;
    server_name interview.yourdomain.com;
    return 301 https://$server_name$request_uri;
}

# HTTPS é…ç½®
server {
    listen 443 ssl http2;
    server_name interview.yourdomain.com;
    
    # SSL è¯ä¹¦é…ç½®
    ssl_certificate /etc/letsencrypt/live/interview.yourdomain.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/interview.yourdomain.com/privkey.pem;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;
    ssl_prefer_server_ciphers on;
    
    # ç½‘ç«™æ ¹ç›®å½•
    root /var/www/html/interview;
    index video-interview-host.html;
    
    # æ—¥å¿—é…ç½®
    access_log /var/log/nginx/interview.access.log;
    error_log /var/log/nginx/interview.error.log;
    
    # ä¸»é…ç½®
    location / {
        try_files $uri $uri/ =404;
        
        # å…è®¸è·¨åŸŸ
        add_header Access-Control-Allow-Origin *;
        add_header Access-Control-Allow-Methods 'GET, POST, OPTIONS';
    }
    
    # é™æ€èµ„æºç¼“å­˜
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg)$ {
        expires 30d;
        add_header Cache-Control "public, immutable";
    }
    
    # HTML æ–‡ä»¶ä¸ç¼“å­˜
    location ~* \.(html)$ {
        expires -1;
        add_header Cache-Control "no-store, no-cache, must-revalidate";
    }
    
    # å¾®ä¿¡æ ¡éªŒæ–‡ä»¶
    location ~ ^/[A-Za-z0-9]+\.txt$ {
        root /var/www/html/interview;
    }
}
```

**è®¿é—®åœ°å€**ï¼š
- HRç«¯ï¼š`https://interview.yourdomain.com/video-interview-host.html`
- è®¿å®¢ç«¯ï¼š`https://interview.yourdomain.com/video-interview.html?room=xxx`

---

## Apache é…ç½®

### æ–¹æ¡ˆ 1ï¼šä½¿ç”¨å­ç›®å½•

**é…ç½®æ–‡ä»¶**ï¼š`/etc/apache2/sites-available/yourdomain.conf`

```apache
<VirtualHost *:80>
    ServerName api.yourdomain.com
    Redirect permanent / https://api.yourdomain.com/
</VirtualHost>

<VirtualHost *:443>
    ServerName api.yourdomain.com
    DocumentRoot /var/www/html
    
    # SSL é…ç½®
    SSLEngine on
    SSLCertificateFile /etc/letsencrypt/live/api.yourdomain.com/fullchain.pem
    SSLCertificateKeyFile /etc/letsencrypt/live/api.yourdomain.com/privkey.pem
    
    # H5 ç›®å½•
    Alias /h5 /var/www/html/h5
    <Directory /var/www/html/h5>
        Options Indexes FollowSymLinks
        AllowOverride All
        Require all granted
        
        # å…è®¸è·¨åŸŸ
        Header set Access-Control-Allow-Origin "*"
        Header set Access-Control-Allow-Methods "GET, POST, OPTIONS"
    </Directory>
    
    # ç¼“å­˜é…ç½®
    <FilesMatch "\.(js|css|png|jpg|jpeg|gif|ico|svg)$">
        Header set Cache-Control "max-age=2592000, public"
    </FilesMatch>
    
    <FilesMatch "\.(html)$">
        Header set Cache-Control "no-store, no-cache, must-revalidate"
    </FilesMatch>
    
    # æ—¥å¿—
    ErrorLog ${APACHE_LOG_DIR}/api.yourdomain.com.error.log
    CustomLog ${APACHE_LOG_DIR}/api.yourdomain.com.access.log combined
</VirtualHost>
```

**å¯ç”¨å¿…è¦çš„æ¨¡å—**ï¼š

```bash
sudo a2enmod ssl
sudo a2enmod headers
sudo a2enmod rewrite
sudo systemctl restart apache2
```

---

## å®å¡”é¢æ¿é…ç½®

### ç¬¬ 1 æ­¥ï¼šåˆ›å»ºç½‘ç«™

1. ç™»å½•å®å¡”é¢æ¿
2. ç‚¹å‡»"ç½‘ç«™" â†’ "æ·»åŠ ç«™ç‚¹"
3. å¡«å†™ä¿¡æ¯ï¼š
   - **åŸŸå**ï¼š`api.yourdomain.com` æˆ– `interview.yourdomain.com`
   - **æ ¹ç›®å½•**ï¼š`/www/wwwroot/api.yourdomain.com`
   - **PHPç‰ˆæœ¬**ï¼šçº¯é™æ€ï¼ˆä¸éœ€è¦PHPï¼‰
   - **æ•°æ®åº“**ï¼šä¸åˆ›å»º

### ç¬¬ 2 æ­¥ï¼šé…ç½® SSL è¯ä¹¦

1. ç‚¹å‡»ç½‘ç«™åç§° â†’ "è®¾ç½®"
2. ç‚¹å‡»"SSL"æ ‡ç­¾
3. é€‰æ‹©"Let's Encrypt"
4. ç‚¹å‡»"ç”³è¯·"
5. ç­‰å¾…è¯ä¹¦ç”³è¯·æˆåŠŸ
6. å¼€å¯"å¼ºåˆ¶HTTPS"

### ç¬¬ 3 æ­¥ï¼šä¸Šä¼ æ–‡ä»¶

1. ç‚¹å‡»"æ–‡ä»¶"
2. è¿›å…¥ç½‘ç«™æ ¹ç›®å½•ï¼š`/www/wwwroot/api.yourdomain.com`
3. åˆ›å»º `h5` æ–‡ä»¶å¤¹ï¼ˆå¦‚æœä½¿ç”¨å­ç›®å½•æ–¹æ¡ˆï¼‰
4. ä¸Šä¼ ä»¥ä¸‹æ–‡ä»¶ï¼š
   - `video-interview-host.html`
   - `video-interview.html`
   - `ZegoExpressWebRTC-standalone.js`

### ç¬¬ 4 æ­¥ï¼šé…ç½®ä¼ªé™æ€ï¼ˆå¯é€‰ï¼‰

å¦‚æœéœ€è¦ç¾åŒ–URLï¼Œå¯ä»¥é…ç½®ä¼ªé™æ€è§„åˆ™ã€‚

---

## åŸŸå SSL è¯ä¹¦é…ç½®

### ä½¿ç”¨ Let's Encrypt å…è´¹è¯ä¹¦ï¼ˆæ¨èï¼‰

#### æ–¹æ³• 1ï¼šä½¿ç”¨ Certbotï¼ˆå‘½ä»¤è¡Œï¼‰

```bash
# å®‰è£… Certbot
sudo apt-get update
sudo apt-get install certbot python3-certbot-nginx

# ç”³è¯·è¯ä¹¦ï¼ˆNginxï¼‰
sudo certbot --nginx -d api.yourdomain.com

# æˆ–ç”³è¯·è¯ä¹¦ï¼ˆApacheï¼‰
sudo certbot --apache -d api.yourdomain.com

# è‡ªåŠ¨ç»­æœŸ
sudo certbot renew --dry-run
```

#### æ–¹æ³• 2ï¼šä½¿ç”¨å®å¡”é¢æ¿

1. ç½‘ç«™è®¾ç½® â†’ SSL â†’ Let's Encrypt
2. ç‚¹å‡»"ç”³è¯·"
3. è‡ªåŠ¨é…ç½®å®Œæˆ

---

## å°ç¨‹åºé…ç½®ä¿®æ”¹

### ä¿®æ”¹ WebView é¡µé¢

**æ–‡ä»¶**ï¼š`miniprogram/pages/video-interview-webview/index.js`

```javascript
onLoad(options) {
  console.log('WebView é¡µé¢åŠ è½½ï¼Œå‚æ•°:', options);

  const role = options.role || 'guest';
  const roomId = options.roomId || options.room || '';

  // ğŸ”¥ ä¿®æ”¹è¿™é‡Œï¼šæ›¿æ¢ä¸ºä½ çš„åŸŸå
  // æ–¹æ¡ˆ1ï¼šä½¿ç”¨å­ç›®å½•
  const h5Domain = 'https://api.yourdomain.com/h5';
  
  // æ–¹æ¡ˆ2ï¼šä½¿ç”¨å­åŸŸå
  // const h5Domain = 'https://interview.yourdomain.com';
  
  let h5Url = '';
  let webviewUrl = '';

  if (role === 'host') {
    h5Url = `${h5Domain}/video-interview-host.html`;
    webviewUrl = h5Url;
    console.log('âœ… åŠ è½½ HR ç«¯é¡µé¢');
  } else {
    if (!roomId) {
      wx.showModal({
        title: 'æç¤º',
        content: 'ç¼ºå°‘æˆ¿é—´å·å‚æ•°',
        showCancel: false,
        success: () => {
          wx.navigateBack();
        }
      });
      return;
    }
    h5Url = `${h5Domain}/video-interview.html`;
    webviewUrl = `${h5Url}?room=${roomId}`;
    console.log('âœ… åŠ è½½è®¿å®¢ç«¯é¡µé¢');
  }

  console.log('WebView URL:', webviewUrl);

  this.setData({
    roomId: roomId,
    role: role,
    webviewUrl: webviewUrl
  });
}
```

### é…ç½®å°ç¨‹åºä¸šåŠ¡åŸŸå

1. ç™»å½•å¾®ä¿¡å°ç¨‹åºåå°ï¼šhttps://mp.weixin.qq.com/
2. å¼€å‘ â†’ å¼€å‘ç®¡ç† â†’ å¼€å‘è®¾ç½® â†’ ä¸šåŠ¡åŸŸå
3. ç‚¹å‡»"æ·»åŠ "
4. è¾“å…¥åŸŸåï¼š`api.yourdomain.com` æˆ– `interview.yourdomain.com`
5. ä¸‹è½½æ ¡éªŒæ–‡ä»¶ï¼ˆå¦‚ `WxVerifyFile.txt`ï¼‰
6. ä¸Šä¼ åˆ°æœåŠ¡å™¨æ ¹ç›®å½•
7. ç‚¹å‡»"éªŒè¯"

---

## æµ‹è¯•éªŒè¯

### 1. æµ‹è¯• HTTPS è®¿é—®

```bash
# æµ‹è¯• SSL è¯ä¹¦
curl -I https://api.yourdomain.com/h5/video-interview-host.html

# åº”è¯¥è¿”å› 200 OK
```

### 2. æµ‹è¯• HR ç«¯é¡µé¢

åœ¨æµè§ˆå™¨ä¸­è®¿é—®ï¼š
```
https://api.yourdomain.com/h5/video-interview-host.html
```

æ£€æŸ¥é¡¹ï¼š
- âœ… é¡µé¢æ­£å¸¸åŠ è½½
- âœ… æ²¡æœ‰ SSL è­¦å‘Š
- âœ… æ§åˆ¶å°æ²¡æœ‰é”™è¯¯
- âœ… ç‚¹å‡»"åˆ›å»ºé¢è¯•é—´"èƒ½æ­£å¸¸å·¥ä½œ

### 3. æµ‹è¯•è®¿å®¢ç«¯é¡µé¢

åœ¨æµè§ˆå™¨ä¸­è®¿é—®ï¼š
```
https://api.yourdomain.com/h5/video-interview.html?room=test_123
```

æ£€æŸ¥é¡¹ï¼š
- âœ… é¡µé¢æ­£å¸¸åŠ è½½
- âœ… æˆ¿é—´å·æ­£ç¡®æ˜¾ç¤º
- âœ… èƒ½è¾“å…¥å§“å
- âœ… èƒ½é€‰æ‹©èº«ä»½

### 4. æµ‹è¯•å°ç¨‹åºé›†æˆ

1. ä¿®æ”¹å°ç¨‹åºä»£ç ä¸­çš„åŸŸå
2. é‡æ–°ç¼–è¯‘å°ç¨‹åº
3. åœ¨å¼€å‘è€…å·¥å…·ä¸­æµ‹è¯•
4. åœ¨çœŸæœºä¸Šæµ‹è¯•

---

## å¸¸è§é—®é¢˜æ’æŸ¥

### é—®é¢˜ 1ï¼šé¡µé¢ 404

**æ£€æŸ¥**ï¼š
- æ–‡ä»¶æ˜¯å¦ä¸Šä¼ åˆ°æ­£ç¡®ç›®å½•
- Nginx/Apache é…ç½®æ˜¯å¦æ­£ç¡®
- æ–‡ä»¶æƒé™æ˜¯å¦æ­£ç¡®ï¼ˆ644ï¼‰

### é—®é¢˜ 2ï¼šSSL è¯ä¹¦é”™è¯¯

**æ£€æŸ¥**ï¼š
- è¯ä¹¦æ˜¯å¦è¿‡æœŸ
- åŸŸåæ˜¯å¦åŒ¹é…
- è¯ä¹¦é“¾æ˜¯å¦å®Œæ•´

### é—®é¢˜ 3ï¼šå°ç¨‹åºæç¤º"ä¸åœ¨ä¸šåŠ¡åŸŸååˆ—è¡¨ä¸­"

**æ£€æŸ¥**ï¼š
- æ˜¯å¦åœ¨å°ç¨‹åºåå°æ·»åŠ äº†åŸŸå
- æ ¡éªŒæ–‡ä»¶æ˜¯å¦ä¸Šä¼ 
- åŸŸåæ˜¯å¦éªŒè¯æˆåŠŸ

### é—®é¢˜ 4ï¼šè§†é¢‘æ— æ³•æ’­æ”¾

**æ£€æŸ¥**ï¼š
- ZEGO AppID å’Œ ServerSecret æ˜¯å¦æ­£ç¡®
- æµè§ˆå™¨æ˜¯å¦å…è®¸æ‘„åƒå¤´å’Œéº¦å…‹é£æƒé™
- ç½‘ç»œæ˜¯å¦æ­£å¸¸

---

## æ€§èƒ½ä¼˜åŒ–å»ºè®®

### 1. å¯ç”¨ Gzip å‹ç¼©

```nginx
gzip on;
gzip_vary on;
gzip_min_length 1024;
gzip_types text/plain text/css text/xml text/javascript application/x-javascript application/xml+rss application/javascript;
```

### 2. ä½¿ç”¨ CDN åŠ é€Ÿ

å°† `ZegoExpressWebRTC-standalone.js` ä¸Šä¼ åˆ° CDNï¼Œä¿®æ”¹ HTML ä¸­çš„å¼•ç”¨è·¯å¾„ã€‚

### 3. å¯ç”¨ HTTP/2

```nginx
listen 443 ssl http2;
```

### 4. é…ç½®ç¼“å­˜ç­–ç•¥

- JS/CSS æ–‡ä»¶ï¼šç¼“å­˜ 30 å¤©
- HTML æ–‡ä»¶ï¼šä¸ç¼“å­˜
- å›¾ç‰‡æ–‡ä»¶ï¼šç¼“å­˜ 7 å¤©

