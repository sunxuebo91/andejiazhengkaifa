# å°ç¨‹åº H5 é¡µé¢è®¿é—®æ—¥å¿—ç³»ç»Ÿ

## ğŸ“‹ åŠŸèƒ½è¯´æ˜

å·²ä¸ºå°ç¨‹åº H5 é¡µé¢æ·»åŠ äº†å®Œæ•´çš„è®¿é—®æ—¥å¿—è®°å½•ç³»ç»Ÿï¼Œå¯ä»¥è¿½è¸ªï¼š
- ğŸ“„ è®¿é—®çš„é¡µé¢æ–‡ä»¶å
- ğŸ”— å®Œæ•´çš„ URL å’Œå‚æ•°
- ğŸŒ è®¿é—®ç¯å¢ƒï¼ˆå°ç¨‹åº WebView / å¾®ä¿¡æµè§ˆå™¨ / æ™®é€šæµè§ˆå™¨ï¼‰
- ğŸ“± ç”¨æˆ·çš„ IP åœ°å€å’Œ User-Agent
- â±ï¸ é¡µé¢åœç•™æ—¶é—´
- ğŸ“‹ æ‰€æœ‰ Query å‚æ•°

---

## ğŸ¯ æ—¥å¿—è®°å½•æ–¹å¼

### **1. å‰ç«¯æ—¥å¿—ï¼ˆæµè§ˆå™¨æ§åˆ¶å°ï¼‰**

æ¯ä¸ª H5 é¡µé¢åŠ è½½æ—¶ï¼Œä¼šåœ¨æµè§ˆå™¨æ§åˆ¶å°è¾“å‡ºè¯¦ç»†çš„è®¿é—®ä¿¡æ¯ï¼š

```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
â•‘ ğŸ“Š é¡µé¢è®¿é—®æ—¥å¿—
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
â•‘ ğŸ“„ è®¿é—®æ–‡ä»¶: video-interview-guest-room.html
â•‘ ğŸ”— å®Œæ•´URL: https://crm.andejiazheng.com/miniprogram/video-interview-guest-room.html?roomId=xxx
â•‘ ğŸŒ ç¯å¢ƒ: å°ç¨‹åºWebView
â•‘ ğŸ“‹ Queryå‚æ•°: {"roomId":"xxx"}
â•‘ ğŸ• æ—¶é—´: 2025-11-19 12:30:00
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

### **2. åç«¯æ—¥å¿—ï¼ˆPM2 æ—¥å¿—ï¼‰**

è®¿é—®ä¿¡æ¯ä¼šè‡ªåŠ¨å‘é€åˆ°åç«¯ï¼Œè®°å½•åœ¨ PM2 æ—¥å¿—ä¸­ï¼š

```bash
# æŸ¥çœ‹åç«¯æ—¥å¿—
pm2 logs backend-prod

# å®æ—¶ç›‘æ§æ—¥å¿—
pm2 logs backend-prod --lines 100
```

åç«¯æ—¥å¿—æ ¼å¼ï¼š

```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
â•‘ ğŸ¯ å°ç¨‹åº WebView è®¿é—®
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
â•‘ ğŸ“„ è®¿é—®æ–‡ä»¶: video-interview-guest-room.html
â•‘ ğŸ”— å®Œæ•´URL: https://crm.andejiazheng.com/miniprogram/video-interview-guest-room.html?roomId=xxx
â•‘ ğŸŒ ç¯å¢ƒ: å°ç¨‹åºWebView
â•‘ ğŸ“‹ Queryå‚æ•°: {"roomId":"xxx"}
â•‘ ğŸ• æ—¶é—´: 2025-11-19 12:30:00
â•‘ ğŸ“± æ¥æº: direct
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

---

## ğŸ“ ç›¸å…³æ–‡ä»¶

### **å‰ç«¯æ–‡ä»¶**

1. **`frontend/public/miniprogram/page-access-logger.js`**
   - é¡µé¢è®¿é—®æ—¥å¿—è®°å½•è„šæœ¬
   - è‡ªåŠ¨æ£€æµ‹ç¯å¢ƒï¼ˆå°ç¨‹åº/å¾®ä¿¡/æµè§ˆå™¨ï¼‰
   - å‘é€æ—¥å¿—åˆ°åç«¯ API

2. **å·²æ·»åŠ æ—¥å¿—çš„ HTML é¡µé¢**
   - `video-interview-host.html` - HR ä¸»æŒäººé¡µé¢
   - `video-interview-guest.html` - è®¿å®¢å…¥å£é¡µé¢
   - `video-interview-guest-room.html` - è®¿å®¢æˆ¿é—´é¡µé¢

### **åç«¯æ–‡ä»¶**

1. **`backend/src/modules/miniprogram-log/miniprogram-log.controller.ts`**
   - æ¥æ”¶å‰ç«¯å‘é€çš„è®¿é—®æ—¥å¿—
   - æ ¼å¼åŒ–è¾“å‡ºåˆ° PM2 æ—¥å¿—

2. **`backend/src/modules/miniprogram-log/miniprogram-log.module.ts`**
   - æ—¥å¿—æ¨¡å—å®šä¹‰

3. **`backend/src/common/middleware/miniprogram-logger.middleware.ts`**
   - ä¸­é—´ä»¶ï¼ˆå¤‡ç”¨ï¼Œå½“å‰æœªä½¿ç”¨ï¼‰

---

## ğŸ” å¦‚ä½•æŸ¥çœ‹æ—¥å¿—

### **æ–¹æ³• 1ï¼šæŸ¥çœ‹åç«¯ PM2 æ—¥å¿—**

```bash
# æŸ¥çœ‹æœ€è¿‘ 100 è¡Œæ—¥å¿—
pm2 logs backend-prod --lines 100

# å®æ—¶ç›‘æ§æ—¥å¿—ï¼ˆæŒ‰ Ctrl+C é€€å‡ºï¼‰
pm2 logs backend-prod

# åªæŸ¥çœ‹è¾“å‡ºæ—¥å¿—ï¼ˆä¸åŒ…å«é”™è¯¯æ—¥å¿—ï¼‰
pm2 logs backend-prod --out

# æ¸…ç©ºæ—¥å¿—
pm2 flush backend-prod
```

### **æ–¹æ³• 2ï¼šæŸ¥çœ‹æµè§ˆå™¨æ§åˆ¶å°**

1. åœ¨å°ç¨‹åºä¸­æ‰“å¼€ H5 é¡µé¢
2. å¦‚æœæ˜¯å¼€å‘ç‰ˆå°ç¨‹åºï¼Œå¯ä»¥å¼€å¯è°ƒè¯•æ¨¡å¼
3. æŸ¥çœ‹æ§åˆ¶å°è¾“å‡ºçš„æ—¥å¿—ä¿¡æ¯

### **æ–¹æ³• 3ï¼šä½¿ç”¨å¾®ä¿¡å¼€å‘è€…å·¥å…·**

1. æ‰“å¼€å¾®ä¿¡å¼€å‘è€…å·¥å…·
2. åŠ è½½å°ç¨‹åºé¡¹ç›®
3. åœ¨ WebView é¡µé¢ä¸­æ‰“å¼€æ§åˆ¶å°
4. æŸ¥çœ‹æ—¥å¿—è¾“å‡º

---

## ğŸ¯ æµ‹è¯•æ­¥éª¤

### **æµ‹è¯• 1ï¼šå°ç¨‹åºè®¿é—®**

1. åœ¨å°ç¨‹åºä¸­æ‰“å¼€è§†é¢‘é¢è¯•é¡µé¢
2. æŸ¥çœ‹åç«¯æ—¥å¿—ï¼š
   ```bash
   pm2 logs backend-prod --lines 50
   ```
3. åº”è¯¥çœ‹åˆ°ç±»ä¼¼è¿™æ ·çš„æ—¥å¿—ï¼š
   ```
   â•‘ ğŸ¯ å°ç¨‹åº WebView è®¿é—®
   â•‘ ğŸ“„ è®¿é—®æ–‡ä»¶: video-interview-guest-room.html
   ```

### **æµ‹è¯• 2ï¼šå¾®ä¿¡æµè§ˆå™¨è®¿é—®**

1. åœ¨å¾®ä¿¡ä¸­ç›´æ¥æ‰“å¼€ H5 é“¾æ¥
2. æŸ¥çœ‹åç«¯æ—¥å¿—
3. åº”è¯¥çœ‹åˆ°ï¼š
   ```
   â•‘ ğŸ“± å¾®ä¿¡æµè§ˆå™¨è®¿é—®
   ```

### **æµ‹è¯• 3ï¼šæ™®é€šæµè§ˆå™¨è®¿é—®**

1. åœ¨ Chrome/Safari ä¸­æ‰“å¼€ H5 é“¾æ¥
2. æŸ¥çœ‹åç«¯æ—¥å¿—
3. åº”è¯¥çœ‹åˆ°ï¼š
   ```
   â•‘ ğŸŒ æ™®é€šæµè§ˆå™¨è®¿é—®
   ```

---

## ğŸ“Š æ—¥å¿—åŒ…å«çš„ä¿¡æ¯

| å­—æ®µ | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|
| `fileName` | è®¿é—®çš„æ–‡ä»¶å | `video-interview-guest-room.html` |
| `url` | å®Œæ•´ URL | `https://crm.andejiazheng.com/miniprogram/...` |
| `environment` | è®¿é—®ç¯å¢ƒ | `å°ç¨‹åºWebView` / `å¾®ä¿¡æµè§ˆå™¨` / `æ™®é€šæµè§ˆå™¨` |
| `queryParams` | URL å‚æ•° | `{"roomId":"xxx"}` |
| `timestamp` | è®¿é—®æ—¶é—´ | `2025-11-19T12:30:00.000Z` |
| `referrer` | æ¥æºé¡µé¢ | `direct` æˆ–å…¶ä»– URL |
| `userAgent` | æµè§ˆå™¨æ ‡è¯† | `Mozilla/5.0 ...` |
| `stayDuration` | åœç•™æ—¶é—´ï¼ˆç§’ï¼‰ | `120` |

---

## ğŸ”§ API æ¥å£

### **POST /api/miniprogram-access-log**

æ¥æ”¶å‰ç«¯å‘é€çš„è®¿é—®æ—¥å¿—ã€‚

**è¯·æ±‚ç¤ºä¾‹ï¼š**

```json
{
  "url": "https://crm.andejiazheng.com/miniprogram/video-interview-guest-room.html?roomId=xxx",
  "fileName": "video-interview-guest-room.html",
  "environment": "å°ç¨‹åºWebView",
  "queryParams": {
    "roomId": "xxx"
  },
  "timestamp": "2025-11-19T12:30:00.000Z",
  "userAgent": "Mozilla/5.0 ...",
  "isWechat": true,
  "isMiniProgram": true
}
```

**å“åº”ç¤ºä¾‹ï¼š**

```json
{
  "success": true,
  "message": "æ—¥å¿—è®°å½•æˆåŠŸ",
  "timestamp": 1763524800000
}
```

---

## ğŸ“ æ³¨æ„äº‹é¡¹

1. **æ—¥å¿—ä¸ä¼šé˜»å¡é¡µé¢åŠ è½½**
   - æ—¥å¿—å‘é€æ˜¯å¼‚æ­¥çš„ï¼Œä¸å½±å“é¡µé¢æ€§èƒ½

2. **æ—¥å¿—ä¼šè‡ªåŠ¨è®°å½•åœç•™æ—¶é—´**
   - é¡µé¢å…³é—­æ—¶ä¼šå‘é€åœç•™æ—¶é—´

3. **æ—¥å¿—åŒ…å«æ•æ„Ÿä¿¡æ¯**
   - ä¸è¦åœ¨ç”Ÿäº§ç¯å¢ƒä¸­æš´éœ²æ—¥å¿— API
   - åç«¯æ—¥å¿—æ–‡ä»¶éœ€è¦å®šæœŸæ¸…ç†

4. **æ—¥å¿—æ–‡ä»¶ä½ç½®**
   - åç«¯æ—¥å¿—ï¼š`/home/ubuntu/andejiazhengcrm/logs/backend-prod-out.log`
   - é”™è¯¯æ—¥å¿—ï¼š`/home/ubuntu/andejiazhengcrm/logs/backend-prod-error.log`

---

## ğŸ‰ å®Œæˆï¼

ç°åœ¨ä½ å¯ä»¥åœ¨å°ç¨‹åºä¸­æ‰“å¼€ H5 é¡µé¢ï¼Œç„¶åæŸ¥çœ‹åç«¯æ—¥å¿—ï¼Œå°±èƒ½çœ‹åˆ°è¯¦ç»†çš„è®¿é—®è®°å½•äº†ï¼

**æŸ¥çœ‹æ—¥å¿—å‘½ä»¤ï¼š**

```bash
pm2 logs backend-prod --lines 100
```

