# 小程序合同创建完整文档

## 📋 目录

1. [流程概述](#流程概述)
2. [API接口清单](#api接口清单)
3. [数据格式要求](#数据格式要求)
4. [完整代码示例](#完整代码示例)
5. [错误处理](#错误处理)
6. [与CRM端的差异](#与crm端的差异)
7. [测试验证](#测试验证)

---

## 🔄 流程概述

### 手动分步流程（推荐）

```
步骤1：获取模板字段（页面加载时）
   ↓
步骤2：用户填写表单
   ↓
步骤3：提交创建合同
   ↓ 显示"✅ 合同创建成功！合同编号：CON123"
   ↓
步骤4：点击"发起签署"按钮
   ↓ 显示"✅ 签署链接已生成"
   ↓
步骤5：选择签署角色，点击"开始签署"
   ↓ 跳转到签署页面（WebView）
```

### 流程特点

- ✅ **每一步都有明确提示**：用户知道每一步的执行结果
- ✅ **失败时显示详细错误**：包括爱签错误码和错误消息
- ✅ **可以重试任何步骤**：发起签署失败可以重试
- ✅ **方便调试和排查**：每一步都有日志记录

---

## 🔌 API接口清单

### 接口1：获取模板字段

**用途**：获取爱签模板的所有字段定义，用于动态生成表单

**接口地址**：
```
POST https://crm.andejiazheng.com/api/esign/template/data
```

**认证**：❌ 无需认证（公开接口）

**请求参数**：
```json
{
  "templateIdent": "TN84E8C106BFE74FD3AE36AC2CA33A44DE"
}
```

**返回数据**：
```json
{
  "code": 100000,
  "data": [
    {
      "dataKey": "客户姓名",
      "dataType": "text",
      "required": true
    },
    {
      "dataKey": "客户电话",
      "dataType": "text",
      "required": true
    },
    {
      "dataKey": "阿姨姓名",
      "dataType": "text",
      "required": true
    }
  ],
  "msg": "成功"
}
```

---

### 接口2：验证数据（可选）

**用途**：提交前验证数据是否完整

**接口地址**：
```
POST https://crm.andejiazheng.com/api/contracts/miniprogram/validate
```

**认证**：❌ 无需认证（公开接口）

**请求参数**：与"创建合同"接口相同

**返回数据（验证通过）**：
```json
{
  "success": true,
  "valid": true,
  "message": "✅ 数据验证通过，可以提交创建合同"
}
```

**返回数据（验证失败）**：
```json
{
  "success": true,
  "valid": false,
  "message": "缺少以下必填字段：客户身份证号(customerIdCard)、服务人员身份证号(workerIdCard)",
  "missingFields": [
    "客户身份证号(customerIdCard)",
    "服务人员身份证号(workerIdCard)"
  ],
  "details": {
    "templateNo": "✅ 已提供",
    "customerName": "✅ 已提供",
    "customerPhone": "✅ 已提供",
    "customerIdCard": "❌ 缺失",
    "workerName": "✅ 已提供",
    "workerPhone": "✅ 已提供",
    "workerIdCard": "❌ 缺失"
  }
}
```

---

### 接口3：创建合同

**用途**：提交表单数据，创建合同记录（不触发爱签流程）

**接口地址**：
```
POST https://crm.andejiazheng.com/api/contracts/miniprogram/create
```

**认证**：❌ 无需认证（公开接口）

**请求参数**：见下方"数据格式要求"

**返回数据（成功）**：
```json
{
  "success": true,
  "data": {
    "_id": "699ec826b2b79ea081a35200",
    "contractNumber": "CON13606777884",
    "contractStatus": "draft",
    "customerName": "孙学博",
    "customerPhone": "18604592681",
    "workerName": "闫凯欣",
    "workerPhone": "13264518973",
    "createdAt": "2026-02-25T10:00:00.000Z"
  },
  "message": "✅ 合同创建成功！合同编号：CON13606777884",
  "nextStep": {
    "action": "initiate_signing",
    "description": "请点击「发起签署」按钮获取签署链接",
    "endpoint": "/api/contracts/miniprogram/initiate-signing/699ec826b2b79ea081a35200"
  }
}
```

**返回数据（失败 - 数据验证不通过）**：
```json
{
  "success": false,
  "message": "数据验证失败：缺少以下必填字段：客户身份证号(customerIdCard)",
  "error": {
    "code": "VALIDATION_ERROR",
    "missingFields": ["客户身份证号(customerIdCard)"],
    "details": "缺少以下必填字段：客户身份证号(customerIdCard)"
  }
}
```

---

### 接口4：发起签署

**用途**：为已创建的合同触发爱签流程，生成签署链接

**接口地址**：
```
POST https://crm.andejiazheng.com/api/contracts/miniprogram/initiate-signing/:id
```

**认证**：❌ 无需认证（公开接口）

**请求参数**：无（合同ID在URL中）

**返回数据（成功）**：
```json
{
  "success": true,
  "data": {
    "contractId": "699ec826b2b79ea081a35200",
    "contractNumber": "CON13606777884",
    "esignContractNo": "CON13606777884",
    "contractStatus": "signing",
    "signUrls": [
      {
        "name": "孙学博",
        "mobile": "18604592681",
        "role": "甲方（客户）",
        "signUrl": "https://hxcx.asign.cn/sign/CON13606777884?account=account_xxx",
        "account": "account_xxx",
        "signOrder": 1
      },
      {
        "name": "闫凯欣",
        "mobile": "13264518973",
        "role": "乙方（服务人员）",
        "signUrl": "https://hxcx.asign.cn/sign/CON13606777884?account=account_yyy",
        "account": "account_yyy",
        "signOrder": 2
      }
    ]
  },
  "message": "✅ 签署链接生成成功！"
}
```

**返回数据（失败 - 爱签API错误）**：
```json
{
  "success": false,
  "message": "❌ 签署链接生成失败：缺少模板必填参数",
  "error": {
    "code": "ESIGN_ERROR",
    "esignCode": 100626,
    "esignMessage": "参数错误，缺少模板必填参数",
    "details": "请检查合同数据是否完整"
  }
}
```

---

## 📝 数据格式要求

### 必填字段（用于验证和触发爱签）

| 字段名 | 类型 | 说明 | 示例 |
|--------|------|------|------|
| `templateNo` | string | 爱签模板编号 | `TN84E8C106BFE74FD3AE36AC2CA33A44DE` |
| `customerName` | string | 客户姓名 | `孙学博` |
| `customerPhone` | string | 客户手机号（11位） | `18604592681` |
| `customerIdCard` | string | 客户身份证号（18位） | `230623199105111630` |
| `workerName` | string | 服务人员姓名 | `闫凯欣` |
| `workerPhone` | string | 服务人员手机号（11位） | `13264518973` |
| `workerIdCard` | string | 服务人员身份证号（18位） | `13013219930910004X` |

### 必填字段（CRM内部使用）

| 字段名 | 类型 | 说明 | 示例 |
|--------|------|------|------|
| `contractType` | string | 合同类型 | `住家育儿嫂` |
| `startDate` | string | 合同开始日期 | `2026-02-25` |
| `endDate` | string | 合同结束日期 | `2027-02-25` |
| `workerSalary` | number | 服务人员工资 | `9000` |
| `customerServiceFee` | number | 客户服务费 | `8000` |
| `customerId` | string | 客户ID（MongoDB ObjectId） | `6847fa0e6798cab487d828f1` |
| `workerId` | string | 服务人员ID（MongoDB ObjectId） | `684139d383fb4fccb5cd4916` |
| `createdBy` | string | 创建人ID（MongoDB ObjectId） | `68316f1ce504025976127909` |

### 爱签模板字段（中文字段名，直接平铺）

**重要**：所有爱签模板字段必须使用**中文字段名**，并且**直接平铺在根级别**，不要嵌套在 `templateParams` 对象中。

| 字段名 | 类型 | 说明 | 示例 |
|--------|------|------|------|
| `客户姓名` | string | 客户姓名 | `孙学博` |
| `客户电话` | string | 客户电话 | `18604592681` |
| `客户身份证` | string | 客户身份证号 | `230623199105111630` |
| `客户服务地址` | string | 客户服务地址 | `黑龙江大庆市林甸县...` |
| `阿姨姓名` | string | 服务人员姓名 | `闫凯欣` |
| `阿姨电话` | string | 服务人员电话 | `13264518973` |
| `阿姨身份证` | string | 服务人员身份证号 | `13013219930910004X` |
| `阿姨工资` | string | 服务人员工资 | `9000` |
| `阿姨工资大写` | string | 服务人员工资大写 | `玖仟元整` |
| `服务费` | string | 客户服务费 | `8000` |
| `服务费大写` | string | 客户服务费大写 | `捌仟元整` |
| `服务时间` | string | 服务时间 | `8-18` |
| `合同开始时间` | string | 合同开始时间 | `2026-02-25` |
| `合同结束时间` | string | 合同结束时间 | `2027-02-25` |
| `服务类型` | string | 服务类型 | `住家育儿嫂` |
| `休息方式` | string | 休息方式 | `单休` |
| `合同备注` | string | 合同备注 | `无` |

### 完整的提交数据示例

```json
{
  "templateNo": "TN84E8C106BFE74FD3AE36AC2CA33A44DE",

  "customerName": "孙学博",
  "customerPhone": "18604592681",
  "customerIdCard": "230623199105111630",
  "workerName": "闫凯欣",
  "workerPhone": "13264518973",
  "workerIdCard": "13013219930910004X",

  "contractType": "住家育儿嫂",
  "startDate": "2026-02-25",
  "endDate": "2027-02-25",
  "workerSalary": 9000,
  "customerServiceFee": 8000,
  "customerId": "6847fa0e6798cab487d828f1",
  "workerId": "684139d383fb4fccb5cd4916",
  "createdBy": "68316f1ce504025976127909",

  "客户姓名": "孙学博",
  "客户电话": "18604592681",
  "客户身份证": "230623199105111630",
  "客户服务地址": "黑龙江大庆市林甸县宏伟乡全胜村八组2号",
  "服务地址": "黑龙江大庆市林甸县宏伟乡全胜村八组2号",
  "阿姨姓名": "闫凯欣",
  "阿姨身份证": "13013219930910004X",
  "阿姨电话": "13264518973",
  "联系地址": "北京市顺义区裕龙三区25号楼2门401",
  "籍贯": "河北省",
  "性别": "女",
  "年龄": 32,
  "阿姨工资": "9000",
  "阿姨工资大写": "玖仟元整",
  "服务费": "8000",
  "服务费大写": "捌仟元",
  "首次匹配费": "1500",
  "首次匹配费大写": "壹仟伍佰元整",
  "服务时间": "8-18",
  "合同开始时间": "2026-02-25",
  "合同结束时间": "2027-02-25",
  "服务类型": "住家育儿嫂",
  "休息方式": "单休",
  "多选6": "婴幼儿洗澡、洗头...",
  "多选7": "做早餐；做中餐；做晚餐",
  "合同备注": "无"
}
```

**关键点**：
1. ✅ 所有中文字段名（爱签模板字段）直接平铺在根级别
2. ✅ 不要嵌套在 `templateParams` 对象中
3. ✅ 后端会自动提取所有中文字段名作为模板参数传递给爱签API
4. ✅ 英文字段名（如 `customerName`、`workerPhone`）是CRM内部使用的

---

## 💻 完整代码示例

### 页面数据结构

```javascript
Page({
  data: {
    // 当前步骤：1=填写表单, 2=合同已创建, 3=签署链接已生成
    currentStep: 1,

    // 合同信息
    contractId: null,
    contractNumber: null,

    // 签署链接
    signUrls: [],

    // 表单数据
    formData: {
      customerName: '',
      customerPhone: '',
      customerIdCard: '',
      workerName: '',
      workerPhone: '',
      workerIdCard: '',
      // ... 其他字段
    },

    // 模板字段
    templateFields: []
  },

  // 页面加载
  async onLoad() {
    await this.loadTemplateFields();
  },

  // 步骤1：加载模板字段
  async loadTemplateFields() {
    try {
      const res = await wx.request({
        url: 'https://crm.andejiazheng.com/api/esign/template/data',
        method: 'POST',
        data: {
          templateIdent: 'TN84E8C106BFE74FD3AE36AC2CA33A44DE'
        }
      });

      if (res.data.code === 100000) {
        this.setData({
          templateFields: res.data.data
        });
      }
    } catch (error) {
      wx.showToast({
        title: '加载模板失败',
        icon: 'none'
      });
    }
  },

  // 步骤2：提交创建合同
  async submitForm() {
    // 构建提交数据
    const submitData = {
      templateNo: 'TN84E8C106BFE74FD3AE36AC2CA33A44DE',

      // 英文字段（必填）
      customerName: this.data.formData.customerName,
      customerPhone: this.data.formData.customerPhone,
      customerIdCard: this.data.formData.customerIdCard,
      workerName: this.data.formData.workerName,
      workerPhone: this.data.formData.workerPhone,
      workerIdCard: this.data.formData.workerIdCard,
      contractType: this.data.formData.contractType,
      startDate: this.data.formData.startDate,
      endDate: this.data.formData.endDate,
      workerSalary: this.data.formData.workerSalary,
      customerServiceFee: this.data.formData.customerServiceFee,
      customerId: this.data.selectedCustomer._id,
      workerId: this.data.selectedWorker._id,
      createdBy: this.data.currentUser._id,

      // 中文字段（爱签模板字段，直接平铺）
      "客户姓名": this.data.formData.customerName,
      "客户电话": this.data.formData.customerPhone,
      "客户身份证": this.data.formData.customerIdCard,
      "阿姨姓名": this.data.formData.workerName,
      "阿姨电话": this.data.formData.workerPhone,
      "阿姨身份证": this.data.formData.workerIdCard,
      "阿姨工资": this.data.formData.workerSalary.toString(),
      "服务费": this.data.formData.customerServiceFee.toString(),
      "服务时间": this.data.formData.serviceTime,
      "合同开始时间": this.data.formData.startDate,
      "合同结束时间": this.data.formData.endDate,
      "服务类型": this.data.formData.contractType,
      // ... 其他中文字段
    };

    wx.showLoading({ title: '创建中...' });

    try {
      const res = await wx.request({
        url: 'https://crm.andejiazheng.com/api/contracts/miniprogram/create',
        method: 'POST',
        data: submitData
      });

      wx.hideLoading();

      if (res.data.success) {
        // ✅ 创建成功
        this.setData({
          contractId: res.data.data._id,
          contractNumber: res.data.data.contractNumber,
          currentStep: 2
        });

        wx.showModal({
          title: '✅ 合同创建成功',
          content: `合同编号：${res.data.data.contractNumber}\n\n请点击「发起签署」按钮获取签署链接`,
          showCancel: false,
          confirmText: '知道了'
        });
      } else {
        // ❌ 创建失败
        wx.showModal({
          title: '❌ 合同创建失败',
          content: res.data.message,
          showCancel: false
        });
      }
    } catch (error) {
      wx.hideLoading();
      wx.showToast({
        title: '网络错误',
        icon: 'none'
      });
    }
  },

  // 步骤3：发起签署
  async initiateSigning() {
    wx.showLoading({ title: '生成签署链接中...' });

    try {
      const res = await wx.request({
        url: `https://crm.andejiazheng.com/api/contracts/miniprogram/initiate-signing/${this.data.contractId}`,
        method: 'POST'
      });

      wx.hideLoading();

      if (res.data.success) {
        // ✅ 签署链接生成成功
        this.setData({
          signUrls: res.data.data.signUrls,
          currentStep: 3
        });

        wx.showModal({
          title: '✅ 签署链接已生成',
          content: `合同编号：${this.data.contractNumber}\n\n请选择要签署的角色`,
          showCancel: false,
          confirmText: '开始签署'
        });
      } else {
        // ❌ 签署链接生成失败
        const errorMsg = `${res.data.message}\n\n` +
                        `爱签错误码：${res.data.error?.esignCode || '无'}\n` +
                        `爱签错误信息：${res.data.error?.esignMessage || '无'}`;

        wx.showModal({
          title: '❌ 签署链接生成失败',
          content: errorMsg,
          showCancel: true,
          cancelText: '取消',
          confirmText: '重试',
          success: (modalRes) => {
            if (modalRes.confirm) {
              this.initiateSigning();  // 重试
            }
          }
        });
      }
    } catch (error) {
      wx.hideLoading();
      wx.showToast({
        title: '网络错误',
        icon: 'none'
      });
    }
  },

  // 步骤4：跳转签署页面
  goToSign(e) {
    const role = e.currentTarget.dataset.role;
    const signUrl = this.data.signUrls.find(s => s.role === role)?.signUrl;

    if (signUrl) {
      wx.navigateTo({
        url: `/pages/webview/index?url=${encodeURIComponent(signUrl)}`
      });
    } else {
      wx.showToast({
        title: '签署链接不存在',
        icon: 'none'
      });
    }
  }
});
```

### 页面UI示例

```xml
<view class="container">
  <!-- 步骤1：填写表单 -->
  <view wx:if="{{currentStep === 1}}" class="form-container">
    <view class="title">创建合同</view>

    <form>
      <!-- 客户信息 -->
      <view class="section">
        <view class="section-title">客户信息</view>
        <input placeholder="客户姓名" model:value="{{formData.customerName}}" />
        <input placeholder="客户电话" type="number" model:value="{{formData.customerPhone}}" />
        <input placeholder="客户身份证号" model:value="{{formData.customerIdCard}}" />
      </view>

      <!-- 服务人员信息 -->
      <view class="section">
        <view class="section-title">服务人员信息</view>
        <input placeholder="服务人员姓名" model:value="{{formData.workerName}}" />
        <input placeholder="服务人员电话" type="number" model:value="{{formData.workerPhone}}" />
        <input placeholder="服务人员身份证号" model:value="{{formData.workerIdCard}}" />
      </view>

      <!-- 合同信息 -->
      <view class="section">
        <view class="section-title">合同信息</view>
        <picker bindchange="onContractTypeChange" value="{{formData.contractType}}">
          <view class="picker">服务类型：{{formData.contractType || '请选择'}}</view>
        </picker>
        <picker mode="date" bindchange="onStartDateChange" value="{{formData.startDate}}">
          <view class="picker">开始日期：{{formData.startDate || '请选择'}}</view>
        </picker>
        <picker mode="date" bindchange="onEndDateChange" value="{{formData.endDate}}">
          <view class="picker">结束日期：{{formData.endDate || '请选择'}}</view>
        </picker>
        <input placeholder="服务人员工资" type="digit" model:value="{{formData.workerSalary}}" />
        <input placeholder="客户服务费" type="digit" model:value="{{formData.customerServiceFee}}" />
      </view>
    </form>

    <button bindtap="submitForm" type="primary" class="submit-btn">提交创建合同</button>
  </view>

  <!-- 步骤2：合同已创建，等待发起签署 -->
  <view wx:if="{{currentStep === 2}}" class="success-card">
    <view class="icon">✅</view>
    <view class="title">合同创建成功</view>
    <view class="info">
      <text class="label">合同编号：</text>
      <text class="value">{{contractNumber}}</text>
    </view>
    <view class="info">
      <text class="label">合同状态：</text>
      <text class="value">草稿</text>
    </view>
    <button bindtap="initiateSigning" type="primary" class="action-btn">发起签署</button>
  </view>

  <!-- 步骤3：签署链接已生成 -->
  <view wx:if="{{currentStep === 3}}" class="success-card">
    <view class="icon">✅</view>
    <view class="title">签署链接已生成</view>
    <view class="info">
      <text class="label">合同编号：</text>
      <text class="value">{{contractNumber}}</text>
    </view>
    <view class="info">
      <text class="label">合同状态：</text>
      <text class="value">签署中</text>
    </view>

    <view class="sign-urls">
      <view class="section-title">请选择签署角色</view>
      <view wx:for="{{signUrls}}" wx:key="role" class="sign-url-item">
        <view class="role">{{item.role}}</view>
        <view class="name">{{item.name}}（{{item.mobile}}）</view>
        <button
          bindtap="goToSign"
          data-role="{{item.role}}"
          type="primary"
          size="mini"
          class="sign-btn">
          开始签署
        </button>
      </view>
    </view>
  </view>
</view>
```

---

## ❌ 错误处理

### 常见错误及解决方案

#### 错误1：数据验证失败

**错误信息**：
```json
{
  "success": false,
  "message": "数据验证失败：缺少以下必填字段：客户身份证号(customerIdCard)",
  "error": {
    "code": "VALIDATION_ERROR",
    "missingFields": ["客户身份证号(customerIdCard)"]
  }
}
```

**原因**：提交的数据中缺少必填字段

**解决方案**：
1. 检查表单是否收集了所有必填字段
2. 确保字段名正确（区分大小写）
3. 确保字段值不为空

---

#### 错误2：爱签API错误 - 缺少模板必填参数

**错误信息**：
```json
{
  "success": false,
  "message": "❌ 签署链接生成失败：缺少模板必填参数",
  "error": {
    "code": "ESIGN_ERROR",
    "esignCode": 100626,
    "esignMessage": "参数错误，缺少模板必填参数"
  }
}
```

**原因**：提交的中文字段（爱签模板字段）不完整

**解决方案**：
1. 检查是否提交了所有中文字段名
2. 确保中文字段名与爱签模板定义一致
3. 确保中文字段值不为空

---

#### 错误3：爱签API错误 - 合同不存在

**错误信息**：
```json
{
  "success": false,
  "error": {
    "esignCode": 100066,
    "esignMessage": "合同不存在"
  }
}
```

**原因**：爱签合同创建失败，但返回了签署链接

**解决方案**：
1. 检查后端日志，查看爱签API返回的详细错误
2. 确认模板参数是否正确
3. 联系技术支持排查

---

#### 错误4：身份证号格式错误

**错误信息**：
```
身份证号必须是18位
```

**原因**：身份证号长度不是18位

**解决方案**：
1. 检查身份证号输入框的验证逻辑
2. 确保身份证号是18位（最后一位可以是X）
3. 去除空格和特殊字符

---

#### 错误5：手机号格式错误

**错误信息**：
```
请输入有效的中国手机号码
```

**原因**：手机号格式不正确

**解决方案**：
1. 确保手机号是11位数字
2. 确保手机号以1开头
3. 去除空格和特殊字符

---

## 🔄 与CRM端的差异

### 核心差异

| 项目 | CRM端 | 小程序端 |
|------|-------|---------|
| **接口路径** | `/api/contracts` | `/api/contracts/miniprogram/create` + `/initiate-signing/:id` |
| **自动触发爱签** | ✅ 是 | ❌ 否（需要手动） |
| **流程步骤** | 1步（自动） | 2步（手动） |
| **创建后合同状态** | `signing` | `draft` → `signing` |
| **是否返回签署链接** | ✅ 是（自动返回） | ❌ 否（需要调用第二个接口） |
| **错误提示** | 简单 | 详细（包含爱签错误码） |

### 为什么要有差异？

#### CRM端保持自动化的原因
1. **CRM用户是内部员工**，熟悉系统，不需要详细提示
2. **操作效率优先**，一步完成所有操作
3. **已有的前端代码**不需要修改

#### 小程序端采用手动分步的原因
1. **用户体验更好**：每一步都有明确的成功/失败提示
2. **方便调试**：失败时知道是哪一步出错
3. **错误提示详细**：显示爱签错误码和错误消息
4. **可以重试**：发起签署失败可以重试

---

## 🧪 测试验证

### 测试脚本

已提供测试脚本：`test-miniprogram-contract-flow.sh`

```bash
# 运行测试
./test-miniprogram-contract-flow.sh
```

### 测试步骤

#### 1. 测试创建合同

**请求**：
```bash
curl -X POST "https://crm.andejiazheng.com/api/contracts/miniprogram/create" \
  -H "Content-Type: application/json" \
  -d '{
    "templateNo": "TN84E8C106BFE74FD3AE36AC2CA33A44DE",
    "customerName": "测试客户",
    "customerPhone": "13800138888",
    "customerIdCard": "110101199001011234",
    "workerName": "测试阿姨",
    "workerPhone": "13900139999",
    "workerIdCard": "110101198001011234",
    "contractType": "住家保姆",
    "startDate": "2026-02-25",
    "endDate": "2027-02-25",
    "workerSalary": 8000,
    "customerServiceFee": 7000,
    "customerId": "实际的客户ID",
    "workerId": "实际的服务人员ID",
    "createdBy": "实际的用户ID",
    "客户姓名": "测试客户",
    "客户电话": "13800138888",
    "阿姨姓名": "测试阿姨",
    "阿姨工资": "8000"
  }'
```

**预期结果**：
- ✅ 返回 `success: true`
- ✅ 返回合同ID和合同编号
- ✅ 合同状态为 `draft`

#### 2. 测试发起签署

**请求**：
```bash
curl -X POST "https://crm.andejiazheng.com/api/contracts/miniprogram/initiate-signing/合同ID" \
  -H "Content-Type: application/json"
```

**预期结果**：
- ✅ 返回 `success: true`
- ✅ 返回签署链接数组
- ✅ 签署链接可以正常打开

---

## 📋 接口清单总结

| 接口 | 路径 | 方法 | 认证 | 功能 |
|------|------|------|------|------|
| **获取模板字段** | `/api/esign/template/data` | POST | ❌ | 获取爱签模板字段定义 |
| **验证数据** | `/api/contracts/miniprogram/validate` | POST | ❌ | 提交前验证数据完整性 |
| **创建合同** | `/api/contracts/miniprogram/create` | POST | ❌ | 创建合同（不触发爱签） |
| **发起签署** | `/api/contracts/miniprogram/initiate-signing/:id` | POST | ❌ | 触发爱签流程，生成签署链接 |

---

## 📞 常见问题

### Q1：为什么要分两步创建合同？

**A**：为了更好的用户体验和错误提示。如果一步完成，失败时用户不知道是哪里出错了。分两步可以明确知道是创建合同失败还是生成签署链接失败。

### Q2：创建合同后可以修改数据吗？

**A**：可以。在发起签署之前（合同状态为 `draft`），可以调用更新接口修改合同数据。发起签署后（合同状态为 `signing`）不建议修改。

### Q3：发起签署失败可以重试吗？

**A**：可以。发起签署失败后，可以多次重试。如果合同已经发起过签署，会返回现有的签署链接。

### Q4：签署链接有效期是多久？

**A**：默认30天。可以在调用爱签API时通过 `validityTime` 参数设置。

### Q5：如何判断合同是否签署完成？

**A**：需要监听爱签的回调通知，或者定期查询合同状态。合同签署完成后，状态会变为 `signed`。

---

## 🎯 总结

### 核心要点

1. **手动分步流程**：创建合同 → 发起签署 → 开始签署
2. **数据格式**：中文字段名直接平铺，不要嵌套
3. **必填字段**：7个英文必填字段 + 所有爱签模板字段
4. **错误处理**：详细的错误提示，包含爱签错误码
5. **可以重试**：发起签署失败可以多次重试

### 注意事项

1. ✅ 所有接口都是公开的，无需认证
2. ✅ 创建合同时不会自动触发爱签流程
3. ✅ 必须手动调用"发起签署"接口
4. ✅ 签署链接在 `signUrls` 数组中
5. ✅ 失败时会返回详细的错误信息

---

## 📄 相关文档

- `test-miniprogram-contract-flow.sh` - 测试脚本
- `小程序合同动态表单API文档.md` - 动态表单相关
- `微信小程序域名配置指南.md` - 域名配置说明

