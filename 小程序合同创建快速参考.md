# 小程序合同创建快速参考

## 🚀 快速开始

### 1. 接口清单

| 接口 | URL | 功能 |
|------|-----|------|
| 获取模板字段 | `POST /api/esign/template/data` | 获取表单字段定义 |
| 创建合同 | `POST /api/contracts/miniprogram/create` | 创建合同（不触发爱签） |
| 发起签署 | `POST /api/contracts/miniprogram/initiate-signing/:id` | 生成签署链接 |

### 2. 流程图

```
获取模板 → 填写表单 → 创建合同 → 发起签署 → 开始签署
```

### 3. 必填字段（7个）

```javascript
{
  "templateNo": "TN84E8C106BFE74FD3AE36AC2CA33A44DE",
  "customerName": "孙学博",
  "customerPhone": "18604592681",
  "customerIdCard": "230623199105111630",  // ⚠️ 必须18位
  "workerName": "闫凯欣",
  "workerPhone": "13264518973",
  "workerIdCard": "13013219930910004X",  // ⚠️ 必须18位
  
  // 中文字段（爱签模板字段）直接平铺
  "客户姓名": "孙学博",
  "客户电话": "18604592681",
  "阿姨姓名": "闫凯欣",
  "阿姨工资": "9000",
  // ... 其他中文字段
}
```

### 4. 关键代码

```javascript
// 步骤1：创建合同
const res1 = await wx.request({
  url: 'https://crm.andejiazheng.com/api/contracts/miniprogram/create',
  method: 'POST',
  data: submitData
});
const contractId = res1.data.data._id;

// 步骤2：发起签署
const res2 = await wx.request({
  url: `https://crm.andejiazheng.com/api/contracts/miniprogram/initiate-signing/${contractId}`,
  method: 'POST'
});
const signUrls = res2.data.data.signUrls;

// 步骤3：跳转签署
const customerSignUrl = signUrls.find(s => s.role === '甲方（客户）')?.signUrl;
wx.navigateTo({
  url: `/pages/webview/index?url=${encodeURIComponent(customerSignUrl)}`
});
```

---

## ⚠️ 常见错误

### 错误1：数据验证失败
```
缺少以下必填字段：客户身份证号(customerIdCard)
```
**解决**：检查是否提交了所有7个必填字段

### 错误2：爱签API错误
```
esignCode: 100626
esignMessage: "参数错误，缺少模板必填参数"
```
**解决**：检查中文字段是否完整

### 错误3：合同不存在
```
esignCode: 100066
esignMessage: "合同不存在"
```
**解决**：检查后端日志，查看爱签API详细错误

---

## 🎯 关键点

1. ✅ 中文字段名直接平铺，不要嵌套在 `templateParams` 中
2. ✅ 身份证号必须18位
3. ✅ 手机号必须11位
4. ✅ 创建合同后状态为 `draft`
5. ✅ 发起签署后状态变为 `signing`
6. ✅ 所有接口都无需认证

---

## 📄 完整文档

详见：`小程序合同创建完整文档.md`（920行）

包含：
- ✅ 完整的API接口说明
- ✅ 详细的数据格式要求
- ✅ 完整的代码示例
- ✅ UI示例
- ✅ 错误处理
- ✅ 测试验证
- ✅ 常见问题解答

