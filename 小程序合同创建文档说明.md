# 小程序合同创建文档说明

## 📚 文档清单

已创建以下文档，供小程序开发使用：

### 1. 主文档（必读）

**文件名**：`小程序合同创建完整文档.md`（920行）

**内容**：
- ✅ 完整的流程说明
- ✅ 4个API接口详细说明
- ✅ 数据格式要求（必填字段、中文字段）
- ✅ 完整的代码示例（包含所有步骤）
- ✅ UI示例（WXML代码）
- ✅ 错误处理（5种常见错误）
- ✅ 与CRM端的差异对比
- ✅ 测试验证方法
- ✅ 常见问题解答

**适用场景**：
- 第一次接触小程序合同创建功能
- 需要了解完整的实现细节
- 需要参考代码示例

---

### 2. 快速参考（常用）

**文件名**：`小程序合同创建快速参考.md`（100行）

**内容**：
- ✅ 接口清单（3个接口）
- ✅ 流程图
- ✅ 必填字段清单
- ✅ 关键代码片段
- ✅ 常见错误及解决方案

**适用场景**：
- 已经了解基本流程，需要快速查找接口
- 需要快速复制代码片段
- 需要快速查看错误解决方案

---

### 3. 测试脚本

**文件名**：`test-miniprogram-contract-flow.sh`

**内容**：
- ✅ 自动化测试脚本
- ✅ 测试创建合同接口
- ✅ 测试发起签署接口
- ✅ 显示详细的测试结果

**使用方法**：
```bash
chmod +x test-miniprogram-contract-flow.sh
./test-miniprogram-contract-flow.sh
```

---

## 🎯 核心要点

### 流程（手动分步）

```
步骤1：获取模板字段
步骤2：用户填写表单
步骤3：提交创建合同 → 显示"合同创建成功"
步骤4：点击"发起签署" → 显示"签署链接已生成"
步骤5：点击"开始签署" → 跳转签署页面
```

### 接口（3个）

1. `POST /api/esign/template/data` - 获取模板字段
2. `POST /api/contracts/miniprogram/create` - 创建合同
3. `POST /api/contracts/miniprogram/initiate-signing/:id` - 发起签署

### 必填字段（7个）

1. `templateNo` - 模板编号
2. `customerName` - 客户姓名
3. `customerPhone` - 客户手机号
4. `customerIdCard` - 客户身份证号（18位）⚠️
5. `workerName` - 服务人员姓名
6. `workerPhone` - 服务人员手机号
7. `workerIdCard` - 服务人员身份证号（18位）⚠️

### 数据格式（重要）

**中文字段名直接平铺，不要嵌套**：

```javascript
{
  // ✅ 正确
  "客户姓名": "孙学博",
  "阿姨姓名": "闫凯欣",
  
  // ❌ 错误
  "templateParams": {
    "客户姓名": "孙学博"
  }
}
```

---

## 🔄 与CRM端的差异

| 项目 | CRM端 | 小程序端 |
|------|-------|---------|
| **接口** | `/api/contracts` | `/api/contracts/miniprogram/create` |
| **自动触发爱签** | ✅ 是 | ❌ 否 |
| **流程步骤** | 1步 | 2步 |
| **合同状态** | `signing` | `draft` → `signing` |

**重要**：CRM端和小程序端的接口不同，不能混用！

---

## ✅ 已完成的工作

1. ✅ 修改了小程序端的创建合同接口（不自动触发爱签）
2. ✅ 新增了小程序端的发起签署接口
3. ✅ 添加了数据验证功能（返回详细错误）
4. ✅ 添加了详细的错误提示（包含爱签错误码）
5. ✅ 代码已编译并重启后端服务
6. ✅ 创建了完整的文档和测试脚本

---

## 📝 小程序端需要做的工作

### 1. 修改合同创建页面

**调整前**：
```javascript
// 自动跳转签署
const res = await createContract(data);
wx.navigateTo({ url: '/pages/webview/...' });
```

**调整后**：
```javascript
// 步骤1：创建合同
const res1 = await createContract(data);
this.setData({ contractId: res1.data._id, currentStep: 2 });

// 步骤2：发起签署（用户点击按钮）
async initiateSigning() {
  const res2 = await wx.request({
    url: `https://crm.andejiazheng.com/api/contracts/miniprogram/initiate-signing/${this.data.contractId}`,
    method: 'POST'
  });
  this.setData({ signUrls: res2.data.data.signUrls, currentStep: 3 });
}

// 步骤3：跳转签署（用户点击按钮）
goToSign(role) {
  const signUrl = this.data.signUrls.find(s => s.role === role)?.signUrl;
  wx.navigateTo({ url: `/pages/webview/index?url=${encodeURIComponent(signUrl)}` });
}
```

### 2. 添加UI状态管理

```javascript
data: {
  currentStep: 1,  // 1=填写表单, 2=合同已创建, 3=签署链接已生成
  contractId: null,
  contractNumber: null,
  signUrls: []
}
```

### 3. 添加错误处理

```javascript
if (!res.data.success) {
  if (res.data.error?.code === 'VALIDATION_ERROR') {
    // 数据验证失败
    wx.showModal({
      title: '数据不完整',
      content: res.data.error.missingFields.join('\n')
    });
  } else if (res.data.error?.code === 'ESIGN_ERROR') {
    // 爱签API失败
    wx.showModal({
      title: '签署链接生成失败',
      content: `${res.data.message}\n\n爱签错误码：${res.data.error.esignCode}`
    });
  }
}
```

---

## 🧪 测试建议

1. **测试创建合同**：
   - 提交完整数据，检查是否返回合同ID
   - 检查合同状态是否为 `draft`

2. **测试发起签署**：
   - 使用创建的合同ID调用发起签署接口
   - 检查是否返回签署链接
   - 检查签署链接是否可以正常打开

3. **测试错误处理**：
   - 提交不完整的数据，检查错误提示
   - 模拟爱签API失败，检查错误信息

---

## 📞 技术支持

如有问题，请查看：
1. `小程序合同创建完整文档.md` - 完整的实现细节
2. `小程序合同创建快速参考.md` - 快速查找接口和代码
3. 后端日志：`pm2 logs backend-prod`

---

## 🎉 总结

**已完成**：
- ✅ 后端接口已调整完成
- ✅ 文档已创建完成
- ✅ 测试脚本已创建完成

**待完成**：
- ⏳ 小程序前端代码调整
- ⏳ 小程序UI调整
- ⏳ 小程序测试验证

**预计工作量**：
- 前端代码调整：2-3小时
- UI调整：1-2小时
- 测试验证：1小时

**总计**：约4-6小时

