# 小程序合同状态同步问题修复说明

## 问题描述

小程序端显示的合同状态与CRM端不同步。

### 原因分析

1. **CRM端（Web前端）**：
   - 使用 `<ContractStatusMini>` 组件
   - **实时调用爱签API** 查询最新状态
   - 显示的是爱签API返回的实时状态

2. **小程序端（原来）**：
   - 调用 `GET /api/contracts/miniprogram/list`
   - 返回数据库中缓存的 `contractStatus` 和 `esignStatus`
   - **不会实时查询爱签API**
   - 显示的是数据库中的历史状态

### 问题示例

从用户截图看到：
- 第二个合同（廖德范）在小程序显示"新建合同"
- 但在CRM端可能显示"签约中"或"已签约"（实时状态）

## 解决方案

### 修改内容

修改了 `backend/src/modules/contracts/contracts-miniprogram.controller.ts` 的 `getContractList` 方法：

1. **新增参数** `syncStatus`（默认为 `true`）
2. **批量同步状态**：在返回合同列表前，并发查询所有合同的爱签API状态
3. **状态映射**：根据爱签状态自动更新本地状态
   - 爱签状态 `"2"` → `contractStatus = 'active'`（已签约）
   - 爱签状态 `"0"` 或 `"1"` → `contractStatus = 'signing'`（签约中）
   - 爱签状态 `"6"` 或 `"7"` → `contractStatus = 'cancelled'`（已作废/撤销）

### API 使用方式

```javascript
// 小程序端调用（默认同步状态）
wx.request({
  url: 'https://crm.andejiazheng.com/api/contracts/miniprogram/list',
  method: 'GET',
  data: {
    page: 1,
    limit: 10,
    search: '孙学博',
    syncStatus: true  // 默认为true，可省略
  }
});

// 如果不需要同步状态（提高性能）
wx.request({
  url: 'https://crm.andejiazheng.com/api/contracts/miniprogram/list',
  method: 'GET',
  data: {
    page: 1,
    limit: 10,
    syncStatus: false  // 不同步，使用数据库缓存状态
  }
});
```

### 返回数据结构

```json
{
  "success": true,
  "data": {
    "contracts": [
      {
        "_id": "...",
        "contractNumber": "CONTRACT_1771826319995_tfhwlbyw",
        "customerName": "孙学博",
        "contractStatus": "active",  // 本地状态（已同步）
        "esignStatus": "2",          // 爱签状态码
        "esignStatusText": "已签约", // 爱签状态文本
        "esignContractNo": "..."
      }
    ],
    "total": 5,
    "page": 1,
    "limit": 10
  }
}
```

## 状态映射表

### 爱签API状态码（esignStatus）

| 状态码 | 状态名称 | 颜色 | 说明 |
|--------|----------|------|------|
| `"0"` | 等待签约 | 橙色 | 合同已创建，等待签署 |
| `"1"` | 签约中 | 蓝色 | 合同正在签署过程中 |
| `"2"` | 已签约 | 绿色 | 合同已完成签署 |
| `"3"` | 过期 | 红色 | 合同已过期 |
| `"4"` | 拒签 | 红色 | 签署方拒绝签署 |
| `"6"` | 作废 | 灰色 | 合同已作废 |
| `"7"` | 撤销 | 灰色 | 合同已撤销 |

### 本地合同状态（contractStatus）

| 状态 | 说明 | 对应爱签状态 |
|------|------|-------------|
| `draft` | 草稿 | 未发起签署 |
| `signing` | 签约中 | `"0"`, `"1"` |
| `active` | 已签约 | `"2"` |
| `replaced` | 已被替换 | 换人后的旧合同 |
| `cancelled` | 已作废 | `"6"`, `"7"` |

## 小程序端显示建议

```javascript
// 小程序端状态显示映射
function getContractStatusDisplay(contract) {
  // 优先使用 esignStatusText（已同步的爱签状态）
  if (contract.esignStatusText) {
    return {
      text: contract.esignStatusText,
      color: getColorByEsignStatus(contract.esignStatus)
    };
  }
  
  // 否则使用 contractStatus
  const statusMap = {
    'draft': { text: '待签约', color: 'gray' },
    'signing': { text: '签约中', color: 'orange' },
    'active': { text: '已签约', color: 'green' },
    'replaced': { text: '已换人', color: 'blue' },
    'cancelled': { text: '已终止', color: 'red' }
  };
  
  return statusMap[contract.contractStatus] || { text: '未知', color: 'gray' };
}

function getColorByEsignStatus(status) {
  const colorMap = {
    '0': 'orange',  // 等待签约
    '1': 'blue',    // 签约中
    '2': 'green',   // 已签约
    '3': 'red',     // 过期
    '4': 'red',     // 拒签
    '6': 'gray',    // 作废
    '7': 'gray'     // 撤销
  };
  return colorMap[status] || 'gray';
}
```

## 性能考虑

- **默认开启同步**：确保状态准确性
- **并发查询**：使用 `Promise.all` 并发查询所有合同状态，提高性能
- **容错处理**：单个合同查询失败不影响其他合同
- **可选关闭**：如果性能要求高，可设置 `syncStatus=false` 使用缓存状态

## 测试建议

1. 在小程序端调用列表接口，检查返回的状态是否与CRM端一致
2. 测试不同状态的合同显示是否正确
3. 测试查询失败时的容错处理
4. 测试性能：10个合同的并发查询耗时

## 一句话总结

**修改后，小程序调用 `GET /api/contracts/miniprogram/list` 接口时，会自动并发查询爱签API获取所有合同的最新状态，确保与CRM端显示一致。**

