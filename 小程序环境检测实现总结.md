# 小程序环境检测与邀请功能隐藏 - 实现总结

## 📌 需求

在视频面试 H5 页面中，检测是否在微信小程序环境下运行：
- **小程序环境**：隐藏邀请按钮，提示用户使用小程序分享功能
- **H5 浏览器环境**：正常显示邀请按钮和邀请弹窗

## ✅ 实现方案

### 1. 微信官方环境检测方法

根据微信官方文档，使用以下方法检测小程序环境：

#### 方法 1：`window.__wxjs_environment`（最可靠）
```javascript
if (window.__wxjs_environment === 'miniprogram') {
  // 在小程序 WebView 中
}
```

#### 方法 2：UserAgent 检测（微信 7.0.0+）
```javascript
if (/miniProgram/i.test(navigator.userAgent)) {
  // 在小程序 WebView 中
}
```

#### 方法 3：wx.miniProgram.getEnv（JSSDK）
```javascript
wx.miniProgram.getEnv(function(res) {
  console.log(res.miniprogram) // true 表示在小程序中
});
```

### 2. 实现代码

#### 全局环境检测变量
```javascript
var IS_IN_MINIPROGRAM = false;
var IS_WECHAT = false;

(function() {
  function isWechat() {
    return /MicroMessenger/i.test(navigator.userAgent);
  }

  function isInMiniProgram() {
    // 双重检测确保兼容性
    if (window.__wxjs_environment === 'miniprogram') {
      return true;
    }
    if (/miniProgram/i.test(navigator.userAgent)) {
      return true;
    }
    return false;
  }

  IS_WECHAT = isWechat();
  IS_IN_MINIPROGRAM = isInMiniProgram();
})();
```

#### CSS 样式控制
```css
/* 小程序环境下隐藏邀请按钮 */
body.miniprogram-env .invite-placeholder {
  display: none !important;
}
```

#### 页面加载时添加环境标识
```javascript
window.onload = function() {
  if (IS_IN_MINIPROGRAM) {
    document.body.classList.add('miniprogram-env');
  }
};
```

#### 邀请功能逻辑控制
```javascript
function showInviteModal() {
  if (IS_IN_MINIPROGRAM) {
    alert('请点击右上角"..."按钮，选择"转发"分享给候选人');
    return;
  }
  // 显示邀请弹窗...
}
```

## 📁 修改的文件

### 1. frontend/public/miniprogram/video-interview-host.html
- ✅ 添加环境检测脚本（第 8-63 行）
- ✅ 添加 CSS 样式控制（第 391-407 行）
- ✅ 页面加载时添加环境标识（第 2717-2719 行）
- ✅ 修改 `showInviteModal()` 函数（第 2174-2204 行）

### 2. frontend/public/miniprogram/video-interview-guest-room.html
- ✅ 添加环境检测脚本（第 1-57 行）
- ✅ 添加 CSS 样式控制（第 291-307 行）
- ✅ 页面加载时添加环境标识（第 2395-2399 行）
- ✅ 修改 `showInviteModal()` 函数（第 2255-2273 行）

### 3. 新增文件

- ✅ `frontend/public/miniprogram/test-env-detection.html` - 环境检测测试页面
- ✅ `frontend/public/miniprogram/环境检测说明.md` - 详细说明文档
- ✅ `小程序环境检测实现总结.md` - 本文档

## 🧪 测试方法

### 浏览器环境测试
1. 在 Chrome/Safari 中打开 `video-interview-host.html`
2. 应该看到邀请按钮（+ 邀请用户）
3. 点击邀请按钮应该弹出邀请链接弹窗
4. 控制台输出：`✅ 浏览器环境，邀请按钮正常显示`

### 小程序环境测试
1. 在微信小程序的 web-view 中打开页面
2. 邀请按钮应该被隐藏
3. 点击空位置应该提示使用分享功能
4. 控制台输出：`✅ 已添加小程序环境标识，邀请按钮将被隐藏`

### 环境检测测试页面
访问 `/miniprogram/test-env-detection.html` 查看详细的环境检测信息：
- 是否在微信中
- 是否在小程序 WebView 中
- `window.__wxjs_environment` 的值
- UserAgent 信息
- 测试邀请功能按钮

## 🎯 技术要点

### 1. 为什么不需要安装微信 JS SDK？

**答案**：不需要安装！

- **小程序环境**：小程序的 web-view 自带 `wx.miniProgram` API，无需额外安装
- **环境检测**：使用原生 JavaScript 即可检测（`window.__wxjs_environment` 和 `navigator.userAgent`）
- **后端集成**：后端已安装 `wechat-api` 包处理微信服务端 API

### 2. 双重检测的原因

使用两种方法检测小程序环境，确保兼容性：
- `window.__wxjs_environment`：最可靠，但需要在 WeixinJSBridgeReady 后使用
- `navigator.userAgent`：微信 7.0.0+ 支持，但 iOS 早期版本可能不包含

### 3. CSS 控制 vs JavaScript 控制

采用 CSS + JavaScript 结合的方式：
- **CSS**：通过 `body.miniprogram-env` 类控制样式，性能更好
- **JavaScript**：在函数中检测环境，提供友好提示

## 📊 效果对比

| 环境 | 邀请按钮 | 点击行为 | 用户体验 |
|------|---------|---------|---------|
| 小程序 | 隐藏 | 提示使用分享功能 | ✅ 符合小程序使用习惯 |
| H5 浏览器 | 显示 | 弹出邀请链接弹窗 | ✅ 可复制链接分享 |

## 🔗 参考资料

- [微信官方文档 - web-view](https://developers.weixin.qq.com/miniprogram/dev/component/web-view.html)
- [微信 JSSDK 说明文档](https://developers.weixin.qq.com/doc/offiaccount/OA_Web_Apps/JS-SDK.html)
- [判断 H5 是否在小程序 webview 中](https://blog.csdn.net/jamlin456/article/details/139088390)

## ⚠️ 注意事项

1. **兼容性**：iOS 早期版本的 UserAgent 可能不包含 `miniProgram` 字段
2. **异步检测**：`window.__wxjs_environment` 建议在 `WeixinJSBridgeReady` 回调中使用
3. **测试环境**：开发者工具和真机环境可能有差异，建议在真机上测试
4. **降级方案**：如果无法检测，默认按浏览器环境处理

## 🎉 总结

✅ **无需安装微信 JS SDK**  
✅ **使用微信官方推荐的环境检测方法**  
✅ **双重检测确保兼容性**  
✅ **CSS + JavaScript 结合控制显示**  
✅ **提供测试页面和详细文档**  

现在，视频面试 H5 页面可以自动识别运行环境，并根据环境调整邀请功能的显示，提供更好的用户体验！

