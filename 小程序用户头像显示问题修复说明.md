# å°ç¨‹åºç”¨æˆ·å¤´åƒæ˜¾ç¤ºé—®é¢˜ä¿®å¤è¯´æ˜

## ğŸ“‹ é—®é¢˜æè¿°

CRMåå°çš„"å°ç¨‹åºç”¨æˆ·ç®¡ç†"é¡µé¢ä¸­ï¼Œç”¨æˆ·åˆ—è¡¨ä¸æ˜¾ç¤ºç”¨æˆ·å¤´åƒï¼Œåªæ˜¾ç¤ºé»˜è®¤çš„ç”¨æˆ·å›¾æ ‡ã€‚

## ğŸ” é—®é¢˜æ ¹æœ¬åŸå› 

ç»è¿‡æ·±åº¦åˆ†æï¼Œå‘ç°é—®é¢˜çš„æ ¹æœ¬åŸå› æ˜¯ï¼š

**`/api/miniprogram-users/login` æ¥å£åœ¨åˆ›å»ºæ–°ç”¨æˆ·æ—¶ï¼Œåªä¿å­˜äº† `openid` å’Œ `phone`ï¼Œæ²¡æœ‰ä¿å­˜ç”¨æˆ·çš„å¤´åƒï¼ˆ`avatar`ï¼‰ã€æ˜µç§°ï¼ˆ`nickname`ï¼‰ã€æ€§åˆ«ï¼ˆ`gender`ï¼‰ç­‰ä¿¡æ¯ã€‚**

### åŸå§‹ä»£ç é—®é¢˜

```typescript
// æ—§ä»£ç  - åªä¿å­˜äº†åŸºæœ¬ä¿¡æ¯
const newUser = new this.miniProgramUserModel({
  openid,
  phone: phone || undefined,
  lastLoginAt: now,
  lastLoginIp: ip,
  loginCount: 1,
  status: 'active',
});
```

## âœ… ä¿®å¤æ–¹æ¡ˆ

### 1. ä¿®æ”¹åç«¯æ¥å£

#### Controller å±‚ä¿®æ”¹

ä¿®æ”¹ `backend/src/modules/miniprogram-user/miniprogram-user.controller.ts`ï¼š

- åœ¨ `recordLogin` æ–¹æ³•ä¸­æ·»åŠ æ¥æ”¶ç”¨æˆ·ä¿¡æ¯çš„å‚æ•°ï¼š`nickname`ã€`avatar`ã€`avatarFile`ã€`gender`ã€`city`ã€`province`ã€`country`ã€`language`
- å°†è¿™äº›å‚æ•°ä¼ é€’ç»™ Service å±‚

#### Service å±‚ä¿®æ”¹

ä¿®æ”¹ `backend/src/modules/miniprogram-user/miniprogram-user.service.ts`ï¼š

- åœ¨ `recordLogin` æ–¹æ³•ä¸­æ·»åŠ  `userInfo` å‚æ•°
- åˆ›å»ºæ–°ç”¨æˆ·æ—¶ï¼Œä¿å­˜å®Œæ•´çš„ç”¨æˆ·ä¿¡æ¯
- æ›´æ–°ç°æœ‰ç”¨æˆ·æ—¶ï¼Œå¦‚æœå­—æ®µä¸ºç©ºåˆ™è¡¥å……ç”¨æˆ·ä¿¡æ¯

### 2. å°ç¨‹åºç«¯è°ƒç”¨ç¤ºä¾‹

#### æ–¹å¼1ï¼šä½¿ç”¨ `/api/miniprogram-users/login` æ¥å£ï¼ˆæ¨èï¼‰

```javascript
// å°ç¨‹åºç«¯ - app.js æˆ–ç™»å½•é¡µé¢
wx.getUserProfile({
  desc: 'ç”¨äºå®Œå–„ç”¨æˆ·èµ„æ–™',
  success: (res) => {
    const userInfo = res.userInfo;
    
    // è°ƒç”¨ç™»å½•æ¥å£ï¼Œä¼ é€’å®Œæ•´çš„ç”¨æˆ·ä¿¡æ¯
    wx.request({
      url: 'https://crm.andejiazheng.com/api/miniprogram-users/login',
      method: 'POST',
      data: {
        openid: app.globalData.openid,        // å¿…å¡«ï¼šå¾®ä¿¡openid
        phone: '13800138000',                 // å¯é€‰ï¼šæ‰‹æœºå·
        nickname: userInfo.nickName,          // æ˜µç§°
        avatar: userInfo.avatarUrl,           // å¤´åƒURL
        gender: userInfo.gender,              // æ€§åˆ«ï¼š0-æœªçŸ¥, 1-ç”·, 2-å¥³
        city: userInfo.city,                  // åŸå¸‚
        province: userInfo.province,          // çœä»½
        country: userInfo.country,            // å›½å®¶
        language: userInfo.language           // è¯­è¨€
      },
      success: (res) => {
        if (res.data.success) {
          console.log('ç™»å½•æˆåŠŸ:', res.data.data);
          // ä¿å­˜ç”¨æˆ·ä¿¡æ¯
          wx.setStorageSync('userInfo', res.data.data);
        }
      }
    });
  }
});
```

#### æ–¹å¼2ï¼šä½¿ç”¨ `/api/miniprogram-users/register` æ¥å£

```javascript
// å°ç¨‹åºç«¯ - æ³¨å†Œé¡µé¢
wx.request({
  url: 'https://crm.andejiazheng.com/api/miniprogram-users/register',
  method: 'POST',
  data: {
    openid: app.globalData.openid,        // å¿…å¡«ï¼šå¾®ä¿¡openid
    phone: '13800138000',                 // å¿…å¡«ï¼šæ‰‹æœºå·
    nickname: userInfo.nickName,          // å¯é€‰ï¼šæ˜µç§°
    avatar: userInfo.avatarUrl,           // å¯é€‰ï¼šå¤´åƒURL
    gender: userInfo.gender,              // å¯é€‰ï¼šæ€§åˆ«
    city: userInfo.city,                  // å¯é€‰ï¼šåŸå¸‚
    province: userInfo.province           // å¯é€‰ï¼šçœä»½
  },
  success: (res) => {
    if (res.data.success) {
      console.log('æ³¨å†ŒæˆåŠŸ:', res.data.data);
    }
  }
});
```

## ğŸ¯ ä¿®å¤æ•ˆæœ

ä¿®å¤åï¼š
1. âœ… å°ç¨‹åºç”¨æˆ·ç™»å½•æ—¶ï¼Œä¼šè‡ªåŠ¨ä¿å­˜å¤´åƒã€æ˜µç§°ç­‰ä¿¡æ¯
2. âœ… CRMåå°çš„ç”¨æˆ·åˆ—è¡¨ä¼šæ­£ç¡®æ˜¾ç¤ºç”¨æˆ·å¤´åƒ
3. âœ… å¦‚æœç”¨æˆ·æ²¡æœ‰å¤´åƒï¼Œä¼šæ˜¾ç¤ºé»˜è®¤çš„ç”¨æˆ·å›¾æ ‡ï¼ˆå·²æœ‰çš„fallbackæœºåˆ¶ï¼‰

## ğŸ“ æµ‹è¯•éªŒè¯

### æµ‹è¯•å‘½ä»¤

```bash
# æµ‹è¯•ç™»å½•æ¥å£ï¼ˆå¸¦å¤´åƒï¼‰
curl -X POST http://localhost:3000/api/miniprogram-users/login \
  -H "Content-Type: application/json" \
  -d '{
    "openid": "test_openid_123",
    "phone": "13900000123",
    "nickname": "æµ‹è¯•ç”¨æˆ·",
    "avatar": "https://thirdwx.qlogo.cn/mmopen/test_avatar.jpg",
    "gender": 1,
    "city": "æ·±åœ³",
    "province": "å¹¿ä¸œ"
  }'
```

### éªŒè¯æ•°æ®åº“

```bash
mongosh housekeeping --quiet --eval "db.miniprogram_users.findOne({openid: 'test_openid_123'}, {nickname: 1, avatar: 1})"
```

## ğŸš€ éƒ¨ç½²æ­¥éª¤

1. é‡æ–°ç¼–è¯‘åç«¯ä»£ç ï¼š
```bash
cd backend
npm run build
```

2. é‡å¯åç«¯æœåŠ¡ï¼š
```bash
pm2 restart backend-prod
```

3. æ›´æ–°å°ç¨‹åºç«¯ä»£ç ï¼Œç¡®ä¿è°ƒç”¨ç™»å½•æ¥å£æ—¶ä¼ é€’å®Œæ•´çš„ç”¨æˆ·ä¿¡æ¯

## ğŸ“Œ æ³¨æ„äº‹é¡¹

1. **å¾®ä¿¡å¤´åƒè·å–**ï¼šå¾®ä¿¡å°ç¨‹åºä»2021å¹´4æœˆèµ·ï¼Œ`wx.getUserInfo` ä¸å†è¿”å›ç”¨æˆ·å¤´åƒå’Œæ˜µç§°ï¼Œéœ€è¦ä½¿ç”¨ `wx.getUserProfile` æˆ– `button open-type="getUserInfo"` è·å–
2. **å¤´åƒå­—æ®µ**ï¼šå¾®ä¿¡è¿”å›çš„å­—æ®µæ˜¯ `avatarUrl`ï¼Œåç«¯æ¥æ”¶çš„å­—æ®µæ˜¯ `avatar`ï¼Œéœ€è¦æ³¨æ„å­—æ®µåè½¬æ¢
3. **éšç§ä¿æŠ¤**ï¼šè·å–ç”¨æˆ·ä¿¡æ¯éœ€è¦ç”¨æˆ·ä¸»åŠ¨æˆæƒï¼Œå»ºè®®åœ¨åˆé€‚çš„æ—¶æœºå¼•å¯¼ç”¨æˆ·æˆæƒ

## ğŸ”— ç›¸å…³æ–‡æ¡£

- [å°ç¨‹åºAPIå®Œæ•´æ–‡æ¡£](./backend/docs/å°ç¨‹åºAPIå®Œæ•´æ–‡æ¡£.md)
- [å°ç¨‹åºç”¨æˆ·ç®¡ç†åŠŸèƒ½å®ç°æ€»ç»“](./å°ç¨‹åºç”¨æˆ·ç®¡ç†åŠŸèƒ½å®ç°æ€»ç»“.md)

