# å°ç¨‹åºç«¯æ¥æ”¶H5æ¶ˆæ¯å®Œæ•´æŒ‡å—

## âœ… H5ç«¯éƒ¨ç½²çŠ¶æ€

**çŠ¶æ€**ï¼šâœ… å·²éƒ¨ç½²å®Œæˆ  
**æ–‡ä»¶**ï¼š`frontend/public/miniprogram/video-interview-host.html`  
**è®¿é—®åœ°å€**ï¼š`https://crm.andejiazheng.com/miniprogram/video-interview-host.html`

---

## ğŸ“¨ H5ç«¯å‘é€çš„æ¶ˆæ¯æ ¼å¼

### æ¶ˆæ¯1ï¼šroomCreatedï¼ˆæˆ¿é—´åˆ›å»ºæˆåŠŸï¼‰

**å‘é€æ—¶æœº**ï¼šåˆ›å»ºæˆ¿é—´æˆåŠŸåç«‹å³å‘é€

```javascript
{
  type: 'roomCreated',
  roomId: 'room_1234567890_abc123'
}
```

### æ¶ˆæ¯2ï¼štriggerShareï¼ˆè§¦å‘åˆ†äº«ï¼‰

**å‘é€æ—¶æœº**ï¼šç”¨æˆ·ç‚¹å‡»"+"å·é‚€è¯·æŒ‰é’®æ—¶å‘é€

```javascript
{
  type: 'triggerShare',
  roomId: 'room_1234567890_abc123',
  inviteLink: 'https://crm.andejiazheng.com/miniprogram/video-interview-guest.html?roomId=room_1234567890_abc123',
  shareTitle: 'é‚€è¯·ä½ å‚åŠ è§†é¢‘é¢è¯•',
  shareDesc: 'é¢è¯•é—´å·ï¼šAD-1234567890'
}
```

---

## ğŸ’» å°ç¨‹åºç«¯å®ç°ä»£ç 

### 1. é¡µé¢é…ç½®ï¼ˆinterview.wxmlï¼‰

```xml
<!-- è§†é¢‘é¢è¯•é¡µé¢ -->
<web-view 
  src="{{webviewUrl}}" 
  bindmessage="handleMessage"
></web-view>
```

**å…³é”®ç‚¹**ï¼šå¿…é¡»æ·»åŠ  `bindmessage="handleMessage"` æ¥æ¥æ”¶H5æ¶ˆæ¯

---

### 2. é¡µé¢é€»è¾‘ï¼ˆinterview.jsï¼‰

```javascript
Page({
  data: {
    webviewUrl: '',
    roomId: '',
    inviteLink: ''  // ä¿å­˜è®¿å®¢é‚€è¯·é“¾æ¥
  },

  onLoad(options) {
    const { roomId } = options;
    
    // è·å–Tokenå’Œç”¨æˆ·ä¿¡æ¯
    const token = wx.getStorageSync('access_token') || wx.getStorageSync('token');
    const userInfo = wx.getStorageSync('userInfo') || {};
    const userName = userInfo.name || userInfo.realName || 'ç”¨æˆ·';

    // æ„å»º H5 é¡µé¢ URL
    let h5Url = `https://crm.andejiazheng.com/miniprogram/video-interview-host.html`;
    
    if (token) {
      h5Url += `?token=${encodeURIComponent(token)}`;
    }
    
    if (roomId) {
      h5Url += `${token ? '&' : '?'}room=${roomId}`;
    }

    this.setData({
      webviewUrl: h5Url,
      roomId: roomId || ''
    });

    console.log('ğŸ“± [å°ç¨‹åº] è§†é¢‘é¢è¯•é¡µé¢åŠ è½½');
    console.log('ğŸ“± [å°ç¨‹åº] H5 URL:', h5Url);
  },

  // ğŸ”¥ æ¥æ”¶ H5 é¡µé¢å‘é€çš„æ¶ˆæ¯
  handleMessage(e) {
    console.log('ğŸ“¨ æ”¶åˆ° H5 æ¶ˆæ¯:', e.detail.data);
    
    // å¤„ç†ä¸åŒçš„æ¶ˆæ¯ç±»å‹
    const messages = e.detail.data;
    if (messages && messages.length > 0) {
      // è·å–æœ€åä¸€æ¡æ¶ˆæ¯
      const lastMessage = messages[messages.length - 1];
      
      console.log('ğŸ“¨ å¤„ç†æ¶ˆæ¯:', lastMessage);
      
      switch (lastMessage.type) {
        case 'roomCreated':
          // æˆ¿é—´åˆ›å»ºæˆåŠŸ
          this.handleRoomCreated(lastMessage);
          break;
          
        case 'triggerShare':
          // è§¦å‘åˆ†äº«
          this.handleTriggerShare(lastMessage);
          break;
          
        default:
          console.log('ğŸ“¨ æœªçŸ¥æ¶ˆæ¯ç±»å‹:', lastMessage.type);
      }
    }
  },

  // ğŸ”¥ å¤„ç†æˆ¿é—´åˆ›å»ºæˆåŠŸæ¶ˆæ¯
  handleRoomCreated(message) {
    const { roomId } = message;
    
    console.log('âœ… é¢è¯•é—´åˆ›å»ºæˆåŠŸ:', roomId);
    
    // ä¿å­˜æˆ¿é—´ID
    this.setData({ roomId });
    
    // ç”Ÿæˆè®¿å®¢åŠ å…¥é“¾æ¥
    const inviteLink = `https://crm.andejiazheng.com/miniprogram/video-interview-guest.html?roomId=${roomId}`;
    this.setData({ inviteLink });
    
    console.log('ğŸ“¤ è®¿å®¢åŠ å…¥é“¾æ¥:', inviteLink);
    
    // å¯é€‰ï¼šæ˜¾ç¤ºæç¤º
    wx.showToast({
      title: 'é¢è¯•é—´åˆ›å»ºæˆåŠŸ',
      icon: 'success',
      duration: 1500
    });
  },

  // ğŸ”¥ å¤„ç†è§¦å‘åˆ†äº«æ¶ˆæ¯
  handleTriggerShare(message) {
    const { roomId, inviteLink, shareTitle, shareDesc } = message;
    
    console.log('ğŸ“¤ è§¦å‘åˆ†äº«:', { roomId, inviteLink, shareTitle, shareDesc });
    
    // ä¿å­˜åˆ†äº«ä¿¡æ¯
    this.setData({
      roomId,
      inviteLink,
      shareTitle: shareTitle || 'é‚€è¯·ä½ å‚åŠ è§†é¢‘é¢è¯•',
      shareDesc: shareDesc || `é¢è¯•é—´å·ï¼š${roomId}`
    });
    
    // æç¤ºç”¨æˆ·ç‚¹å‡»å³ä¸Šè§’åˆ†äº«
    wx.showModal({
      title: 'é‚€è¯·è®¿å®¢',
      content: 'è¯·ç‚¹å‡»å³ä¸Šè§’"..."æŒ‰é’®ï¼Œé€‰æ‹©"è½¬å‘"åˆ†äº«ç»™è®¿å®¢',
      showCancel: false,
      confirmText: 'çŸ¥é“äº†'
    });
  },

  // ğŸ”¥ åˆ†äº«ç»™è®¿å®¢ï¼ˆè½¬å‘åŠŸèƒ½ï¼‰
  onShareAppMessage() {
    const { inviteLink, shareTitle, shareDesc } = this.data;
    
    console.log('ğŸ“¤ åˆ†äº«ç»™è®¿å®¢:', { inviteLink, shareTitle, shareDesc });
    
    return {
      title: shareTitle || 'é‚€è¯·ä½ å‚åŠ è§†é¢‘é¢è¯•',
      path: `/pages/interview/guest?url=${encodeURIComponent(inviteLink)}`,
      imageUrl: '/images/share-interview.png'  // éœ€è¦å‡†å¤‡åˆ†äº«å›¾ç‰‡
    };
  },

  // ğŸ”¥ åˆ†äº«åˆ°æœ‹å‹åœˆï¼ˆéœ€è¦å¼€é€šæƒé™ï¼‰
  onShareTimeline() {
    const { inviteLink, shareTitle } = this.data;
    
    return {
      title: shareTitle || 'é‚€è¯·ä½ å‚åŠ è§†é¢‘é¢è¯•',
      query: `url=${encodeURIComponent(inviteLink)}`,
      imageUrl: '/images/share-interview.png'
    };
  }
});
```

---

## ğŸ¯ å…³é”®å®ç°ç‚¹

### 1. **bindmessage äº‹ä»¶**
```xml
<web-view bindmessage="handleMessage"></web-view>
```
- å¿…é¡»æ·»åŠ æ­¤å±æ€§æ‰èƒ½æ¥æ”¶H5æ¶ˆæ¯
- æ¶ˆæ¯æ ¼å¼ï¼š`e.detail.data` æ˜¯ä¸€ä¸ªæ•°ç»„

### 2. **æ¶ˆæ¯å¤„ç†**
```javascript
handleMessage(e) {
  const messages = e.detail.data;
  const lastMessage = messages[messages.length - 1];
  
  switch (lastMessage.type) {
    case 'roomCreated': // æˆ¿é—´åˆ›å»ºæˆåŠŸ
    case 'triggerShare': // è§¦å‘åˆ†äº«
  }
}
```

### 3. **åˆ†äº«åŠŸèƒ½**
```javascript
onShareAppMessage() {
  return {
    title: 'é‚€è¯·ä½ å‚åŠ è§†é¢‘é¢è¯•',
    path: `/pages/interview/guest?url=${encodeURIComponent(inviteLink)}`
  };
}
```

---

## ğŸ“¦ éœ€è¦åˆ›å»ºçš„è®¿å®¢é¡µé¢

### pages/interview/guest/guest.wxml
```xml
<web-view src="{{guestUrl}}"></web-view>
```

### pages/interview/guest/guest.js
```javascript
Page({
  data: {
    guestUrl: ''
  },

  onLoad(options) {
    const { url } = options;
    
    if (url) {
      this.setData({
        guestUrl: decodeURIComponent(url)
      });
    }
  }
});
```

---

## ğŸ§ª æµ‹è¯•æ­¥éª¤

1. åœ¨å°ç¨‹åºä¸­æ‰“å¼€è§†é¢‘é¢è¯•ä¸»æŒäººé¡µé¢
2. æ‰“å¼€å¾®ä¿¡å¼€å‘è€…å·¥å…·æ§åˆ¶å°
3. åˆ›å»ºæˆ¿é—´ï¼ŒæŸ¥çœ‹æ§åˆ¶å°è¾“å‡ºï¼š
   ```
   ğŸ“¨ æ”¶åˆ° H5 æ¶ˆæ¯: [{ type: 'roomCreated', roomId: '...' }]
   âœ… é¢è¯•é—´åˆ›å»ºæˆåŠŸ: room_1234567890_abc123
   ```
4. ç‚¹å‡»"+"å·ï¼ŒæŸ¥çœ‹æ§åˆ¶å°è¾“å‡ºï¼š
   ```
   ğŸ“¨ æ”¶åˆ° H5 æ¶ˆæ¯: [{ type: 'triggerShare', ... }]
   ğŸ“¤ è§¦å‘åˆ†äº«: { roomId: '...', inviteLink: '...' }
   ```
5. ç‚¹å‡»å³ä¸Šè§’"..."ï¼Œé€‰æ‹©"è½¬å‘"
6. è®¿å®¢æ”¶åˆ°åˆ†äº«åï¼Œç‚¹å‡»è¿›å…¥è®¿å®¢é¡µé¢

---

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **postMessage å»¶è¿Ÿ**ï¼š`wx.miniProgram.postMessage()` ä¸æ˜¯å®æ—¶çš„ï¼Œæ¶ˆæ¯ä¼šåœ¨é¡µé¢åé€€ã€ç»„ä»¶é”€æ¯ã€åˆ†äº«ç­‰æ—¶æœºæ‰å‘é€
2. **æ¶ˆæ¯æ ¼å¼**ï¼š`e.detail.data` æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œéœ€è¦å–æœ€åä¸€æ¡æ¶ˆæ¯
3. **è®¿å®¢é¡µé¢**ï¼šéœ€è¦åˆ›å»º `pages/interview/guest` é¡µé¢æ¥æ¥æ”¶è®¿å®¢
4. **åˆ†äº«å›¾ç‰‡**ï¼šéœ€è¦å‡†å¤‡ `/images/share-interview.png` åˆ†äº«å›¾ç‰‡

---

**éƒ¨ç½²å®Œæˆæ—¶é—´**ï¼š2025-11-19  
**H5ç«¯åœ°å€**ï¼šhttps://crm.andejiazheng.com/miniprogram/video-interview-host.html

