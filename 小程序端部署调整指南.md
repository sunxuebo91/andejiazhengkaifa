# å°ç¨‹åºç«¯éƒ¨ç½²è°ƒæ•´æŒ‡å—

> **ç›®æ ‡**: æ¥æ”¶CRMåç«¯è¿”å›çš„ `notificationData`ï¼Œå¹¶å‘é€å¾®ä¿¡è®¢é˜…æ¶ˆæ¯é€šçŸ¥  
> **æ—¥æœŸ**: 2025-12-21  
> **CRMåç«¯çŠ¶æ€**: âœ… å·²å®Œæˆ

---

## ğŸ“‹ èƒŒæ™¯è¯´æ˜

### CRMåç«¯å·²å®Œæˆçš„å·¥ä½œ

CRMåç«¯å·²ç»åœ¨**4ä¸ªå®¢æˆ·åˆ†é…æ¥å£**çš„è¿”å›æ•°æ®ä¸­æ·»åŠ äº† `notificationData` å­—æ®µï¼š

| æ¥å£ | è·¯å¾„ | è¯´æ˜ |
|------|------|------|
| 1ï¸âƒ£ Webç«¯å•ä¸ªåˆ†é… | `PATCH /api/customers/:id/assign` | Webç«¯åˆ†é…å®¢æˆ· |
| 2ï¸âƒ£ å°ç¨‹åºç«¯å•ä¸ªåˆ†é… | `PATCH /api/customers/miniprogram/:id/assign` | å°ç¨‹åºç«¯åˆ†é…å®¢æˆ· |
| 3ï¸âƒ£ æ‰¹é‡åˆ†é… | `POST /api/customers/batch-assign` | æ‰¹é‡åˆ†é…å¤šä¸ªå®¢æˆ· |
| 4ï¸âƒ£ å…¬æµ·åˆ†é… | `POST /api/customers/public-pool/assign` | ä»å…¬æµ·åˆ†é…å®¢æˆ· |

---

## ğŸ¯ å°ç¨‹åºç«¯éœ€è¦åšä»€ä¹ˆ

### æ ¸å¿ƒä»»åŠ¡

**æ¥æ”¶ `notificationData` å¹¶å‘é€å¾®ä¿¡è®¢é˜…æ¶ˆæ¯**

---

## ğŸ“Š è¿”å›æ•°æ®æ ¼å¼

### 1. å•ä¸ªå®¢æˆ·åˆ†é…ï¼ˆæœ€å¸¸ç”¨ï¼‰

```json
{
  "success": true,
  "message": "å®¢æˆ·åˆ†é…æˆåŠŸ",
  "data": {
    "_id": "60f7b3c4e1b2c3d4e5f6g7h8",
    "name": "å¼ ä¸‰",
    "phone": "13800138000",
    "assignedTo": "60f7b3c4e1b2c3d4e5f6g7h9",
    
    "notificationData": {
      "assignedToId": "60f7b3c4e1b2c3d4e5f6g7h9",  // è¢«åˆ†é…äººID
      "customerName": "å¼ ä¸‰",                        // å®¢æˆ·å§“å
      "customerPhone": "13800138000",                // å®¢æˆ·ç”µè¯
      "source": "æ‰‹åŠ¨åˆ†é…",                          // åˆ†é…åŸå› 
      "assignerName": "æç»ç†",                      // åˆ†é…äººå§“å
      "customerId": "60f7b3c4e1b2c3d4e5f6g7h8",     // å®¢æˆ·ID
      "assignTime": "2025-12-21T10:30:00.000Z",      // åˆ†é…æ—¶é—´
      "serviceCategory": "æœˆå«‚",                     // æœåŠ¡ç±»åˆ«
      "leadSource": "ç¾å›¢"                           // çº¿ç´¢æ¥æº
    }
  }
}
```

### 2. æ‰¹é‡åˆ†é…

```json
{
  "success": true,
  "message": "æ‰¹é‡åˆ†é…å®Œæˆï¼šæˆåŠŸ 5 ä¸ªï¼Œå¤±è´¥ 0 ä¸ª",
  "data": {
    "success": 5,
    "failed": 0,
    "errors": [],
    
    "notificationData": {
      "assignedToId": "60f7b3c4e1b2c3d4e5f6g7h9",
      "source": "æ‰¹é‡åˆ†é…",
      "assignerName": "æç»ç†",
      "assignTime": "2025-12-21T10:30:00.000Z",
      "customerCount": 5,                            // æˆåŠŸåˆ†é…çš„å®¢æˆ·æ•°é‡
      "customerIds": ["id1", "id2", "id3", ...]      // å®¢æˆ·IDåˆ—è¡¨
    }
  }
}
```

---

## ğŸ”§ å°ç¨‹åºç«¯å®ç°æ­¥éª¤

### æ­¥éª¤1: ä¿®æ”¹åˆ†é…æ¥å£è°ƒç”¨

**ä½ç½®**: å°ç¨‹åºç«¯çš„å®¢æˆ·åˆ†é…åŠŸèƒ½

```javascript
// åŸæœ‰ä»£ç ï¼ˆç¤ºä¾‹ï¼‰
async function assignCustomer(customerId, assignedTo, reason) {
  const res = await wx.request({
    url: `${API_BASE}/customers/miniprogram/${customerId}/assign`,
    method: 'PATCH',
    header: {
      'Authorization': `Bearer ${token}`,
      'Content-Type': 'application/json'
    },
    data: {
      assignedTo: assignedTo,
      assignmentReason: reason
    }
  });

  if (res.data.success) {
    wx.showToast({ title: 'åˆ†é…æˆåŠŸ', icon: 'success' });
    
    // âœ… æ–°å¢ï¼šæ£€æŸ¥æ˜¯å¦æœ‰é€šçŸ¥æ•°æ®
    if (res.data.data.notificationData) {
      // å‘é€è®¢é˜…æ¶ˆæ¯
      await sendSubscribeNotification(res.data.data.notificationData);
    }
  }
}
```

---

### æ­¥éª¤2: å®ç°è®¢é˜…æ¶ˆæ¯å‘é€

#### æ–¹æ¡ˆA: è°ƒç”¨äº‘å‡½æ•°ï¼ˆæ¨è â­â­â­â­â­ï¼‰

```javascript
/**
 * å‘é€è®¢é˜…æ¶ˆæ¯é€šçŸ¥
 */
async function sendSubscribeNotification(notificationData) {
  try {
    // è°ƒç”¨äº‘å‡½æ•°å‘é€è®¢é˜…æ¶ˆæ¯
    const result = await wx.cloud.callFunction({
      name: 'sendCustomerAssignNotification',
      data: {
        assignedToId: notificationData.assignedToId,
        customerName: notificationData.customerName,
        customerPhone: notificationData.customerPhone,
        source: notificationData.source,
        assignerName: notificationData.assignerName,
        customerId: notificationData.customerId,
        assignTime: notificationData.assignTime
      }
    });

    if (result.result.success) {
      console.log('âœ… è®¢é˜…æ¶ˆæ¯å‘é€æˆåŠŸ');
    } else {
      console.warn('âš ï¸ è®¢é˜…æ¶ˆæ¯å‘é€å¤±è´¥:', result.result.message);
    }
  } catch (error) {
    console.error('âŒ å‘é€è®¢é˜…æ¶ˆæ¯å¤±è´¥:', error);
    // å¤±è´¥ä¸å½±å“ä¸»æµç¨‹
  }
}
```

#### æ–¹æ¡ˆB: è°ƒç”¨CRMåç«¯æ¥å£

```javascript
/**
 * å‘é€è®¢é˜…æ¶ˆæ¯é€šçŸ¥
 */
async function sendSubscribeNotification(notificationData) {
  try {
    const res = await wx.request({
      url: `${API_BASE}/wechat/send-subscribe-message`,
      method: 'POST',
      header: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      },
      data: notificationData
    });

    if (res.data.success) {
      console.log('âœ… è®¢é˜…æ¶ˆæ¯å‘é€æˆåŠŸ');
    }
  } catch (error) {
    console.error('âŒ å‘é€è®¢é˜…æ¶ˆæ¯å¤±è´¥:', error);
  }
}
```

---

### æ­¥éª¤3: åˆ›å»ºäº‘å‡½æ•°ï¼ˆå¦‚æœä½¿ç”¨æ–¹æ¡ˆAï¼‰

**æ–‡ä»¶**: `cloudfunctions/sendCustomerAssignNotification/index.js`

```javascript
const cloud = require('wx-server-sdk');
cloud.init({ env: cloud.DYNAMIC_CURRENT_ENV });

exports.main = async (event, context) => {
  const {
    assignedToId,
    customerName,
    customerPhone,
    source,
    assignerName,
    customerId,
    assignTime
  } = event;

  try {
    // 1. æŸ¥è¯¢è¢«åˆ†é…äººçš„ openId
    const db = cloud.database();
    const userRes = await db.collection('users')
      .where({ _id: assignedToId })
      .field({ wechatOpenId: true })
      .get();

    if (!userRes.data || userRes.data.length === 0) {
      return { success: false, message: 'ç”¨æˆ·ä¸å­˜åœ¨' };
    }

    const user = userRes.data[0];
    if (!user.wechatOpenId) {
      return { success: false, message: 'ç”¨æˆ·æœªç»‘å®šå¾®ä¿¡' };
    }

    // 2. å‘é€è®¢é˜…æ¶ˆæ¯
    const result = await cloud.openapi.subscribeMessage.send({
      touser: user.wechatOpenId,
      page: `pages/customer/detail?id=${customerId}`,  // è·³è½¬åˆ°å®¢æˆ·è¯¦æƒ…é¡µ
      data: {
        thing1: { value: customerName },              // å®¢æˆ·å§“å
        phone_number2: { value: customerPhone },      // è”ç³»ç”µè¯
        thing3: { value: source },                    // åˆ†é…åŸå› 
        name4: { value: assignerName },               // åˆ†é…äºº
        time5: { value: formatTime(assignTime) }      // åˆ†é…æ—¶é—´
      },
      templateId: 'YOUR_TEMPLATE_ID',  // âš ï¸ æ›¿æ¢ä¸ºå®é™…çš„æ¨¡æ¿ID
      miniprogramState: 'formal'  // æ­£å¼ç‰ˆ
    });

    return { success: true, result };
  } catch (error) {
    console.error('å‘é€è®¢é˜…æ¶ˆæ¯å¤±è´¥:', error);
    return { success: false, message: error.message };
  }
};

// æ ¼å¼åŒ–æ—¶é—´
function formatTime(isoString) {
  const date = new Date(isoString);
  return `${date.getFullYear()}-${pad(date.getMonth() + 1)}-${pad(date.getDate())} ${pad(date.getHours())}:${pad(date.getMinutes())}`;
}

function pad(n) {
  return n < 10 ? '0' + n : n;
}
```

---

## ğŸ“ é…ç½®è®¢é˜…æ¶ˆæ¯æ¨¡æ¿

### 1. ç™»å½•å°ç¨‹åºåå°

è®¿é—®ï¼šhttps://mp.weixin.qq.com

### 2. é…ç½®è®¢é˜…æ¶ˆæ¯

**è·¯å¾„**: åŠŸèƒ½ â†’ è®¢é˜…æ¶ˆæ¯ â†’ å…¬å…±æ¨¡æ¿åº“

**æœç´¢å…³é”®è¯**: "ä»»åŠ¡åˆ†é…" æˆ– "å·¥ä½œæé†’"

**æ¨èæ¨¡æ¿å­—æ®µ**:
- `thing1`: å®¢æˆ·å§“å
- `phone_number2`: è”ç³»ç”µè¯
- `thing3`: åˆ†é…åŸå› 
- `name4`: åˆ†é…äºº
- `time5`: åˆ†é…æ—¶é—´

### 3. è·å–æ¨¡æ¿ID

æ·»åŠ æ¨¡æ¿åï¼Œä¼šæ˜¾ç¤º**æ¨¡æ¿ID**ï¼ˆç±»ä¼¼ï¼š`xxxxxxxxxxxxxxxxxxxxxx`ï¼‰

### 4. æ›´æ–°åˆ°ä»£ç ä¸­

å°†æ¨¡æ¿IDæ›¿æ¢åˆ°äº‘å‡½æ•°æˆ–å°ç¨‹åºä»£ç ä¸­çš„ `YOUR_TEMPLATE_ID`

---

## âš ï¸ é‡è¦æé†’

### 1. ç”¨æˆ·éœ€è¦æˆæƒè®¢é˜…

åœ¨å‘é€è®¢é˜…æ¶ˆæ¯å‰ï¼Œç”¨æˆ·éœ€è¦æˆæƒï¼š

```javascript
// åœ¨åˆé€‚çš„æ—¶æœºè¯·æ±‚è®¢é˜…æˆæƒ
wx.requestSubscribeMessage({
  tmplIds: ['YOUR_TEMPLATE_ID'],
  success: (res) => {
    console.log('è®¢é˜…æˆåŠŸ', res);
  },
  fail: (err) => {
    console.log('è®¢é˜…å¤±è´¥', err);
  }
});
```

**å»ºè®®æ—¶æœº**:
- å‘˜å·¥é¦–æ¬¡ç™»å½•å°ç¨‹åºæ—¶
- è¿›å…¥"æˆ‘çš„å®¢æˆ·"é¡µé¢æ—¶
- åˆ†é…å®¢æˆ·å‰æç¤ºæˆæƒ

### 2. è®¢é˜…ç±»å‹

- **ä¸€æ¬¡æ€§è®¢é˜…**: æˆæƒä¸€æ¬¡ï¼Œå‘é€ä¸€æ¬¡
- **é•¿æœŸè®¢é˜…**: éœ€è¦ç”³è¯·æƒé™ï¼Œæˆæƒä¸€æ¬¡å¯å¤šæ¬¡å‘é€

**å»ºè®®**: ç”³è¯·é•¿æœŸè®¢é˜…æƒé™

---

## ğŸ§ª æµ‹è¯•æ­¥éª¤

### 1. æµ‹è¯•åˆ†é…æ¥å£

```javascript
// åœ¨å°ç¨‹åºä¸­æµ‹è¯•
assignCustomer('å®¢æˆ·ID', 'å‘˜å·¥ID', 'æµ‹è¯•åˆ†é…');
```

### 2. æ£€æŸ¥è¿”å›æ•°æ®

åœ¨æ§åˆ¶å°æŸ¥çœ‹æ˜¯å¦åŒ…å« `notificationData` å­—æ®µ

### 3. æµ‹è¯•è®¢é˜…æ¶ˆæ¯

æ£€æŸ¥è¢«åˆ†é…çš„å‘˜å·¥æ˜¯å¦æ”¶åˆ°å¾®ä¿¡é€šçŸ¥

---

## ğŸ“Š å®Œæ•´ç¤ºä¾‹ä»£ç 

```javascript
// pages/customer/assign.js

Page({
  data: {
    customerId: '',
    selectedUserId: ''
  },

  // åˆ†é…å®¢æˆ·
  async assignCustomer() {
    wx.showLoading({ title: 'åˆ†é…ä¸­...' });

    try {
      const res = await wx.request({
        url: `${API_BASE}/customers/miniprogram/${this.data.customerId}/assign`,
        method: 'PATCH',
        header: {
          'Authorization': `Bearer ${wx.getStorageSync('token')}`,
          'Content-Type': 'application/json'
        },
        data: {
          assignedTo: this.data.selectedUserId,
          assignmentReason: 'å°ç¨‹åºåˆ†é…'
        }
      });

      wx.hideLoading();

      if (res.data.success) {
        wx.showToast({ title: 'åˆ†é…æˆåŠŸ', icon: 'success' });

        // âœ… å‘é€è®¢é˜…æ¶ˆæ¯
        if (res.data.data.notificationData) {
          this.sendNotification(res.data.data.notificationData);
        }

        // è¿”å›ä¸Šä¸€é¡µ
        setTimeout(() => {
          wx.navigateBack();
        }, 1500);
      } else {
        wx.showToast({ title: res.data.message, icon: 'none' });
      }
    } catch (error) {
      wx.hideLoading();
      wx.showToast({ title: 'åˆ†é…å¤±è´¥', icon: 'none' });
      console.error('åˆ†é…å¤±è´¥:', error);
    }
  },

  // å‘é€è®¢é˜…æ¶ˆæ¯
  async sendNotification(notificationData) {
    try {
      const result = await wx.cloud.callFunction({
        name: 'sendCustomerAssignNotification',
        data: notificationData
      });

      if (result.result.success) {
        console.log('âœ… é€šçŸ¥å‘é€æˆåŠŸ');
      } else {
        console.warn('âš ï¸ é€šçŸ¥å‘é€å¤±è´¥:', result.result.message);
      }
    } catch (error) {
      console.error('âŒ é€šçŸ¥å‘é€å¤±è´¥:', error);
    }
  }
});
```

---

## ğŸ¯ æ€»ç»“

### CRMåç«¯ï¼ˆå·²å®Œæˆ âœ…ï¼‰

- âœ… 4ä¸ªåˆ†é…æ¥å£éƒ½è¿”å› `notificationData`
- âœ… åŒ…å«æ‰€æœ‰å¿…è¦çš„é€šçŸ¥ä¿¡æ¯
- âœ… ä¸å½±å“ç°æœ‰åŠŸèƒ½

### å°ç¨‹åºç«¯ï¼ˆå¾…å®ç° â³ï¼‰

1. â³ ä¿®æ”¹åˆ†é…æ¥å£è°ƒç”¨ï¼Œæ¥æ”¶ `notificationData`
2. â³ å®ç°è®¢é˜…æ¶ˆæ¯å‘é€é€»è¾‘
3. â³ é…ç½®è®¢é˜…æ¶ˆæ¯æ¨¡æ¿
4. â³ è¯·æ±‚ç”¨æˆ·æˆæƒè®¢é˜…
5. â³ æµ‹è¯•å®Œæ•´æµç¨‹

---

## ğŸ“ æŠ€æœ¯æ”¯æŒ

å¦‚æœ‰é—®é¢˜ï¼Œè¯·å‚è€ƒï¼š
- `CRMç«¯-çº¿ç´¢åˆ†é…é€šçŸ¥å®ç°è¯´æ˜.md` - CRMç«¯å®ç°è¯¦æƒ…
- `å°ç¨‹åºè°ƒç”¨CRMæ¥å£-æ·±åº¦åˆ†æ.md` - æ¥å£è°ƒç”¨åˆ†æ
- `éƒ¨ç½²å’Œæµ‹è¯•æŒ‡å—.md` - éƒ¨ç½²å’Œæµ‹è¯•æ­¥éª¤

---

**é¢„è®¡å·¥ä½œé‡**: 2-4å°æ—¶  
**éš¾åº¦**: â­â­â­ (ä¸­ç­‰)  
**ä¼˜å…ˆçº§**: ğŸ”¥ğŸ”¥ğŸ”¥ğŸ”¥ (é«˜)

