# 小程序签名不匹配问题 - 解决方案

## 📋 问题描述

小程序发起合同时提示**签名不匹配**错误。

## 🔍 问题原因

### 1. 域名配置问题
签署链接使用了错误的域名：
- ❌ 错误：`https://oapi.asign.cn/sign/...` （后端API域名）
- ✅ 正确：`https://hxcx.asign.cn/sign/...` （小程序Web页面域名）

### 2. 微信小程序域名未配置
微信小程序后台未配置爱签的域名，导致无法访问爱签的签署页面。

---

## ✅ 解决方案

### 第一步：修复后端代码（已完成）

**修改文件**：`backend/src/modules/esign/esign.service.ts`

**修改内容**：
```typescript
// 修改前（错误）
const esignHost = this.config.host; // https://oapi.asign.cn
const signUrl = `${esignHost}/sign/${contractNo}?account=${account}`;

// 修改后（正确）
const apiHost = this.config.host; // https://oapi.asign.cn (用于API调用)
const miniProgramSignHost = apiHost.includes('prev.asign.cn') 
  ? 'https://bpre.asign.cn'  // 测试环境
  : 'https://hxcx.asign.cn'; // 生产环境
const signUrl = `${miniProgramSignHost}/sign/${contractNo}?account=${account}`;
```

**状态**：✅ 已完成并部署

---

### 第二步：配置微信小程序域名（待完成）

#### 2.1 配置 request 合法域名

登录微信小程序后台：https://mp.weixin.qq.com/

**路径**：
```
开发 → 开发管理 → 开发设置 → 服务器域名 → request合法域名
```

**添加以下域名**：
```
https://hapi.asign.cn      # 爱签API接口
https://hzuul.asign.cn     # 爱签回调通知
https://hface.asign.cn     # 爱签人脸识别
https://crm.andejiazheng.com  # 你们自己的后端API
```

#### 2.2 配置业务域名（用于 web-view）

**路径**：
```
开发 → 开发管理 → 开发设置 → 业务域名
```

**添加域名**：
```
https://hxcx.asign.cn
```

**⚠️ 重要**：业务域名需要上传校验文件

**步骤**：
1. 在小程序后台点击"添加"，输入 `hxcx.asign.cn`
2. 点击"下载校验文件"（如 `WxVerifyFile.txt`）
3. **联系爱签客服**，提供以下信息：
   - 你们的 AppID: **141496759**
   - 下载的校验文件
   - 请求：上传到 `https://hxcx.asign.cn/` 根目录
4. 爱签客服上传完成后，在小程序后台点击"验证"

---

## 🧪 测试验证

### 1. 检查签署链接格式

创建新合同后，查看签署链接应该是：
```
✅ 正确：https://hxcx.asign.cn/sign/CON12345678?account=account_xxx
❌ 错误：https://oapi.asign.cn/sign/CON12345678?account=account_xxx
```

### 2. 在小程序中测试

1. 创建新合同
2. 点击签署链接
3. 应该能正常打开签署页面，不再提示"签名不匹配"

---

## 📊 域名对应关系

### 后端服务器调用（API）
```
生产环境：https://oapi.asign.cn
测试环境：https://prev.asign.cn
```

### 小程序端调用（API）
```
生产环境：https://hapi.asign.cn
测试环境：https://bprev.asign.cn
```

### 小程序签署页面（Web-view）
```
生产环境：https://hxcx.asign.cn
测试环境：https://bpre.asign.cn
```

**关键点**：
- 后端服务器调用爱签API使用 `oapi.asign.cn`
- 小程序打开签署页面使用 `hxcx.asign.cn`
- 这两个域名是不同的！

---

## 📞 联系爱签客服

**需要提供的信息**：
- AppID: **141496759**
- 问题描述：需要配置微信小程序业务域名校验文件
- 校验文件：从微信小程序后台下载的 `WxVerifyFile.txt`

---

## ✅ 完成检查清单

- [x] 后端代码已修复（签署链接使用正确域名）
- [x] 后端服务已重新编译和部署
- [ ] 微信小程序后台已添加 request 合法域名（4个）
- [ ] 微信小程序后台已添加业务域名（1个）
- [ ] 已联系爱签客服上传业务域名校验文件
- [ ] 业务域名验证通过
- [ ] 在小程序中测试合同签署功能正常

---

## 📝 相关文档

- [微信小程序域名配置指南.md](./微信小程序域名配置指南.md) - 详细配置步骤
- [L爱签技术文档.md](./L爱签技术文档.md) - 爱签官方技术文档

---

**创建时间**: 2026-02-25  
**状态**: 后端修复已完成，等待小程序域名配置

