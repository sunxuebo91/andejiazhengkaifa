# 微信小程序域名配置指南

## 📌 问题说明

小程序发起合同提示**签名不匹配**，需要在微信小程序后台配置爱签的域名。

---

## ✅ 需要配置的域名清单

### 1. 爱签域名（生产环境）

| 域名 | 类型 | 用途 |
|------|------|------|
| `https://hapi.asign.cn` | request合法域名 | API接口调用 |
| `https://hzuul.asign.cn` | request合法域名 | 回调通知 |
| `https://hxcx.asign.cn` | 业务域名 | 签署页面（Web-view） |
| `https://hface.asign.cn` | request合法域名 | 人脸识别 |

### 2. 你们自己的域名

| 域名 | 类型 | 用途 |
|------|------|------|
| `https://crm.andejiazheng.com` | request合法域名 | 调用自己的后端API |

---

## 🔧 配置步骤

### Step 1: 登录微信小程序后台

访问：https://mp.weixin.qq.com/

使用管理员账号登录

---

### Step 2: 配置 request 合法域名

**路径**：
```
开发 → 开发管理 → 开发设置 → 服务器域名 → request合法域名
```

**点击"修改"，添加以下域名**：
```
https://hapi.asign.cn
https://hzuul.asign.cn
https://hface.asign.cn
https://crm.andejiazheng.com
```

**注意**：
- 每个域名单独添加
- 必须是 HTTPS 协议
- 不能有端口号
- 不能有路径

---

### Step 3: 配置业务域名（用于 web-view）

**路径**：
```
开发 → 开发管理 → 开发设置 → 业务域名
```

**添加域名**：
```
https://hxcx.asign.cn
```

**⚠️ 重要**：配置业务域名需要校验文件

#### 3.1 下载校验文件
1. 点击"添加"
2. 输入域名：`hxcx.asign.cn`
3. 点击"下载校验文件"（如：`WxVerifyFile.txt`）

#### 3.2 上传校验文件到爱签服务器
**联系爱签客服**，提供以下信息：
- 你们的爱签 AppID：`141496759`
- 下载的校验文件
- 请求他们上传到 `https://hxcx.asign.cn/` 根目录

#### 3.3 验证域名
爱签客服上传完成后，点击"验证"按钮

---

### Step 4: 检查人脸识别参数配置

在代码中，人脸识别接口的 `faceAuthMode` 参数需要设置为 `4`（微信小程序端）

**示例**：
```javascript
{
  validateType: 3, // 人脸识别
  faceAuthMode: 4  // 微信小程序端
}
```

---

## 🔍 验证配置是否生效

### 1. 在微信开发者工具中测试

打开微信开发者工具，查看控制台是否有域名相关错误：
- ✅ 没有 "不在以下 request 合法域名列表中" 错误
- ✅ 没有 "不在以下业务域名列表中" 错误

### 2. 真机测试

在真机上测试合同签署流程：
- ✅ 能正常创建合同
- ✅ 能打开签署页面
- ✅ 能完成签署

---

## 📊 域名对应关系

### 后端 API 调用（服务器端）
```
生产环境：https://oapi.asign.cn
测试环境：https://prev.asign.cn
```

### 小程序端调用
```
生产环境：https://hapi.asign.cn
测试环境：https://bprev.asign.cn
```

**注意**：这两个域名是不同的！
- 后端服务器调用爱签API使用 `oapi.asign.cn`
- 小程序端调用爱签API使用 `hapi.asign.cn`

---

## ❓ 常见问题

### Q1: 为什么需要配置这么多域名？

**A**: 因为爱签的服务分布在不同的域名上：
- `hapi.asign.cn` - API接口服务
- `hxcx.asign.cn` - 签署页面（H5页面）
- `hface.asign.cn` - 人脸识别服务
- `hzuul.asign.cn` - 回调通知服务

### Q2: 业务域名校验文件怎么上传？

**A**: 业务域名 `hxcx.asign.cn` 是爱签的服务器，你们无法直接上传文件。需要：
1. 下载校验文件
2. 联系爱签客服（提供你们的AppID）
3. 让爱签客服帮你们上传校验文件
4. 上传完成后，在小程序后台点击"验证"

### Q3: 配置完成后多久生效？

**A**: 
- request合法域名：立即生效
- 业务域名：验证通过后立即生效

### Q4: 测试环境和生产环境域名一样吗？

**A**: 不一样！

**测试环境**：
- API：`https://bprev.asign.cn`
- 回调：`https://bh5.asign.cn`
- Web页：`https://bpre.asign.cn`
- 人脸：`https://bpreface.asign.cn`

**生产环境**：
- API：`https://hapi.asign.cn`
- 回调：`https://hzuul.asign.cn`
- Web页：`https://hxcx.asign.cn`
- 人脸：`https://hface.asign.cn`

---

## 📞 联系爱签客服

如需帮助，请联系爱签客服并提供：
- **AppID**: `141496759`
- **问题描述**: 需要配置微信小程序业务域名校验文件
- **校验文件**: 从微信小程序后台下载的 `WxVerifyFile.txt`

---

## ✅ 配置检查清单

完成配置后，请检查：

- [ ] 已在小程序后台添加 `https://hapi.asign.cn`（request合法域名）
- [ ] 已在小程序后台添加 `https://hzuul.asign.cn`（request合法域名）
- [ ] 已在小程序后台添加 `https://hface.asign.cn`（request合法域名）
- [ ] 已在小程序后台添加 `https://crm.andejiazheng.com`（request合法域名）
- [ ] 已在小程序后台添加 `https://hxcx.asign.cn`（业务域名）
- [ ] 已联系爱签客服上传业务域名校验文件
- [ ] 业务域名验证通过
- [ ] 代码中 `faceAuthMode` 设置为 `4`
- [ ] 在开发者工具中测试通过
- [ ] 在真机上测试通过

---

## ✅ 已完成的修复

### 2026-02-25 修复签署链接域名问题

**问题**：小程序签署链接使用了错误的域名 `oapi.asign.cn`（后端API域名），导致签名不匹配。

**修复**：
1. 修改了 `backend/src/modules/esign/esign.service.ts` 文件
2. 将签署链接域名改为小程序专用域名：
   - 生产环境：`https://hxcx.asign.cn`
   - 测试环境：`https://bpre.asign.cn`
3. 后端服务已重新编译并重启

**验证方法**：
创建新合同后，检查签署链接应该是：
```
https://hxcx.asign.cn/sign/CON12345678?account=account_xxx
```
而不是：
```
https://oapi.asign.cn/sign/CON12345678?account=account_xxx
```

---

**最后更新**: 2026-02-25

