# CRMå®¢æˆ·åˆ†é…é€šçŸ¥åŠŸèƒ½ - æ¥å£å®ç°æ€»ç»“

> **ç»™å°ç¨‹åºå¼€å‘å›¢é˜Ÿ**  
> **æ—¥æœŸ**: 2025-12-21  
> **CRMåç«¯è´Ÿè´£äºº**: AI Assistant

---

## ğŸ¯ åŠŸèƒ½è¯´æ˜

**éœ€æ±‚**: åœ¨CRMç«¯åˆ†é…å®¢æˆ·æ—¶ï¼Œè¢«åˆ†é…çš„å‘˜å·¥èƒ½æ”¶åˆ°å¾®ä¿¡é€šçŸ¥

**å®ç°æ–¹æ¡ˆ**: CRMåç«¯åœ¨åˆ†é…æ¥å£è¿”å›æ—¶ï¼Œæ·»åŠ  `notificationData` å­—æ®µï¼Œå°ç¨‹åºç«¯æ¥æ”¶åå‘é€å¾®ä¿¡è®¢é˜…æ¶ˆæ¯

---

## âœ… CRMåç«¯å·²å®Œæˆçš„å·¥ä½œ

### ä¿®æ”¹çš„æ¥å£ï¼ˆå…±4ä¸ªï¼‰

| æ¥å£ | è·¯å¾„ | è¯´æ˜ |
|------|------|------|
| 1 | `PATCH /api/customers/:id/assign` | Webç«¯å•ä¸ªåˆ†é… |
| 2 | `PATCH /api/customers/miniprogram/:id/assign` | å°ç¨‹åºç«¯å•ä¸ªåˆ†é… |
| 3 | `POST /api/customers/batch-assign` | æ‰¹é‡åˆ†é… |
| 4 | `POST /api/customers/public-pool/assign` | å…¬æµ·åˆ†é… |

### è¿”å›æ•°æ®å˜åŒ–

**ä¹‹å‰**:
```json
{
  "success": true,
  "message": "å®¢æˆ·åˆ†é…æˆåŠŸ",
  "data": {
    "_id": "...",
    "name": "å¼ ä¸‰",
    "phone": "13800138000"
  }
}
```

**ç°åœ¨**:
```json
{
  "success": true,
  "message": "å®¢æˆ·åˆ†é…æˆåŠŸ",
  "data": {
    "_id": "...",
    "name": "å¼ ä¸‰",
    "phone": "13800138000",
    
    "notificationData": {
      "assignedToId": "è¢«åˆ†é…äººID",
      "customerName": "å¼ ä¸‰",
      "customerPhone": "13800138000",
      "source": "æ‰‹åŠ¨åˆ†é…",
      "assignerName": "æç»ç†",
      "customerId": "å®¢æˆ·ID",
      "assignTime": "2025-12-21T10:30:00.000Z",
      "serviceCategory": "æœˆå«‚",
      "leadSource": "ç¾å›¢"
    }
  }
}
```

---

## ğŸ“‹ å°ç¨‹åºç«¯éœ€è¦åšä»€ä¹ˆ

### æ ¸å¿ƒä»»åŠ¡ï¼ˆ3æ­¥ï¼‰

#### 1ï¸âƒ£ æ¥æ”¶ `notificationData`

```javascript
// è°ƒç”¨åˆ†é…æ¥å£å
const res = await wx.request({
  url: `${API_BASE}/customers/miniprogram/${customerId}/assign`,
  method: 'PATCH',
  data: { assignedTo, assignmentReason }
});

// âœ… æ£€æŸ¥æ˜¯å¦æœ‰é€šçŸ¥æ•°æ®
if (res.data.success && res.data.data.notificationData) {
  const notificationData = res.data.data.notificationData;
  // ä¸‹ä¸€æ­¥ï¼šå‘é€é€šçŸ¥
}
```

#### 2ï¸âƒ£ å‘é€è®¢é˜…æ¶ˆæ¯

```javascript
// è°ƒç”¨äº‘å‡½æ•°å‘é€è®¢é˜…æ¶ˆæ¯
await wx.cloud.callFunction({
  name: 'sendCustomerAssignNotification',
  data: notificationData
});
```

#### 3ï¸âƒ£ é…ç½®è®¢é˜…æ¶ˆæ¯æ¨¡æ¿

1. ç™»å½•å°ç¨‹åºåå°ï¼šhttps://mp.weixin.qq.com
2. åŠŸèƒ½ â†’ è®¢é˜…æ¶ˆæ¯ â†’ å…¬å…±æ¨¡æ¿åº“
3. æœç´¢"ä»»åŠ¡åˆ†é…"æˆ–"å·¥ä½œæé†’"
4. æ·»åŠ æ¨¡æ¿ï¼Œè·å–æ¨¡æ¿ID
5. æ›´æ–°åˆ°äº‘å‡½æ•°ä»£ç ä¸­

---

## ğŸ”§ äº‘å‡½æ•°ç¤ºä¾‹ä»£ç 

**æ–‡ä»¶**: `cloudfunctions/sendCustomerAssignNotification/index.js`

```javascript
const cloud = require('wx-server-sdk');
cloud.init({ env: cloud.DYNAMIC_CURRENT_ENV });

exports.main = async (event, context) => {
  const { assignedToId, customerName, customerPhone, source, assignerName, customerId, assignTime } = event;

  try {
    // 1. æŸ¥è¯¢ç”¨æˆ·çš„ openId
    const db = cloud.database();
    const userRes = await db.collection('users')
      .where({ _id: assignedToId })
      .field({ wechatOpenId: true })
      .get();

    if (!userRes.data || userRes.data.length === 0) {
      return { success: false, message: 'ç”¨æˆ·ä¸å­˜åœ¨' };
    }

    const user = userRes.data[0];
    if (!user.wechatOpenId) {
      return { success: false, message: 'ç”¨æˆ·æœªç»‘å®šå¾®ä¿¡' };
    }

    // 2. å‘é€è®¢é˜…æ¶ˆæ¯
    const result = await cloud.openapi.subscribeMessage.send({
      touser: user.wechatOpenId,
      page: `pages/customer/detail?id=${customerId}`,
      data: {
        thing1: { value: customerName },
        phone_number2: { value: customerPhone },
        thing3: { value: source },
        name4: { value: assignerName },
        time5: { value: formatTime(assignTime) }
      },
      templateId: 'YOUR_TEMPLATE_ID',  // âš ï¸ æ›¿æ¢ä¸ºå®é™…çš„æ¨¡æ¿ID
      miniprogramState: 'formal'
    });

    return { success: true, result };
  } catch (error) {
    console.error('å‘é€è®¢é˜…æ¶ˆæ¯å¤±è´¥:', error);
    return { success: false, message: error.message };
  }
};

function formatTime(isoString) {
  const date = new Date(isoString);
  const y = date.getFullYear();
  const m = pad(date.getMonth() + 1);
  const d = pad(date.getDate());
  const h = pad(date.getHours());
  const min = pad(date.getMinutes());
  return `${y}-${m}-${d} ${h}:${min}`;
}

function pad(n) {
  return n < 10 ? '0' + n : n;
}
```

---

## ğŸ“Š `notificationData` å­—æ®µè¯´æ˜

| å­—æ®µå | ç±»å‹ | è¯´æ˜ | ç¤ºä¾‹ |
|--------|------|------|------|
| `assignedToId` | string | è¢«åˆ†é…äººçš„ç”¨æˆ·ID | `"60f7b3c4..."` |
| `customerName` | string | å®¢æˆ·å§“å | `"å¼ ä¸‰"` |
| `customerPhone` | string | å®¢æˆ·ç”µè¯ | `"13800138000"` |
| `source` | string | åˆ†é…åŸå›  | `"æ‰‹åŠ¨åˆ†é…"` |
| `assignerName` | string | åˆ†é…äººå§“å | `"æç»ç†"` |
| `customerId` | string | å®¢æˆ·ID | `"60f7b3c4..."` |
| `assignTime` | string | åˆ†é…æ—¶é—´ï¼ˆISOæ ¼å¼ï¼‰ | `"2025-12-21T10:30:00.000Z"` |
| `serviceCategory` | string | æœåŠ¡ç±»åˆ« | `"æœˆå«‚"` |
| `leadSource` | string | çº¿ç´¢æ¥æº | `"ç¾å›¢"` |

**æ‰¹é‡åˆ†é…æ—¶é¢å¤–å­—æ®µ**:
- `customerCount`: æˆåŠŸåˆ†é…çš„å®¢æˆ·æ•°é‡
- `customerIds`: å®¢æˆ·IDåˆ—è¡¨

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. ç”¨æˆ·éœ€è¦æˆæƒè®¢é˜…

åœ¨å‘é€è®¢é˜…æ¶ˆæ¯å‰ï¼Œç”¨æˆ·éœ€è¦æˆæƒï¼š

```javascript
wx.requestSubscribeMessage({
  tmplIds: ['YOUR_TEMPLATE_ID'],
  success: (res) => {
    console.log('è®¢é˜…æˆåŠŸ', res);
  }
});
```

**å»ºè®®æˆæƒæ—¶æœº**:
- å‘˜å·¥é¦–æ¬¡ç™»å½•å°ç¨‹åº
- è¿›å…¥"æˆ‘çš„å®¢æˆ·"é¡µé¢
- åˆ†é…å®¢æˆ·å‰æç¤º

### 2. è®¢é˜…ç±»å‹

- **ä¸€æ¬¡æ€§è®¢é˜…**: æˆæƒä¸€æ¬¡ï¼Œå‘é€ä¸€æ¬¡ï¼ˆé»˜è®¤ï¼‰
- **é•¿æœŸè®¢é˜…**: éœ€è¦ç”³è¯·æƒé™ï¼Œæˆæƒä¸€æ¬¡å¯å¤šæ¬¡å‘é€ï¼ˆæ¨èï¼‰

### 3. å‘åå…¼å®¹

æ·»åŠ çš„ `notificationData` å­—æ®µ**ä¸å½±å“ç°æœ‰åŠŸèƒ½**ï¼š
- âœ… ä¸å¤„ç†ä¹Ÿä¸ä¼šæŠ¥é”™
- âœ… åˆ†é…æ“ä½œæ­£å¸¸è¿›è¡Œ
- âœ… å¯ä»¥é€æ­¥å®ç°

---

## ğŸ§ª æµ‹è¯•æ–¹æ³•

### 1. æµ‹è¯•æ¥å£è¿”å›

```javascript
// åœ¨å°ç¨‹åºä¸­è°ƒç”¨åˆ†é…æ¥å£
const res = await wx.request({
  url: `${API_BASE}/customers/miniprogram/CUSTOMER_ID/assign`,
  method: 'PATCH',
  data: {
    assignedTo: 'USER_ID',
    assignmentReason: 'æµ‹è¯•åˆ†é…'
  }
});

// æ£€æŸ¥è¿”å›æ•°æ®
console.log('notificationData:', res.data.data.notificationData);
```

### 2. æµ‹è¯•è®¢é˜…æ¶ˆæ¯

1. ç¡®ä¿è¢«åˆ†é…çš„å‘˜å·¥å·²æˆæƒè®¢é˜…
2. æ‰§è¡Œåˆ†é…æ“ä½œ
3. æ£€æŸ¥å‘˜å·¥æ˜¯å¦æ”¶åˆ°å¾®ä¿¡é€šçŸ¥

---

## ğŸ“ è”ç³»æ–¹å¼

### å¦‚æœ‰é—®é¢˜ï¼Œè¯·æŸ¥çœ‹ï¼š

1. **å°ç¨‹åºç«¯éƒ¨ç½²è°ƒæ•´æŒ‡å—.md** - è¯¦ç»†å®ç°æ­¥éª¤
2. **CRMç«¯-çº¿ç´¢åˆ†é…é€šçŸ¥å®ç°è¯´æ˜.md** - CRMç«¯å®ç°è¯¦æƒ…
3. **å°ç¨‹åºè°ƒç”¨CRMæ¥å£-æ·±åº¦åˆ†æ.md** - æ¥å£è°ƒç”¨åˆ†æ

### æˆ–è”ç³»CRMåç«¯å›¢é˜Ÿ

---

## ğŸ¯ å·¥ä½œé‡è¯„ä¼°

| ä»»åŠ¡ | é¢„è®¡æ—¶é—´ | éš¾åº¦ |
|------|---------|------|
| ä¿®æ”¹åˆ†é…æ¥å£è°ƒç”¨ | 30åˆ†é’Ÿ | â­ |
| å®ç°äº‘å‡½æ•° | 1å°æ—¶ | â­â­ |
| é…ç½®è®¢é˜…æ¶ˆæ¯æ¨¡æ¿ | 30åˆ†é’Ÿ | â­ |
| å®ç°æˆæƒé€»è¾‘ | 1å°æ—¶ | â­â­ |
| æµ‹è¯•å’Œè°ƒè¯• | 1å°æ—¶ | â­â­ |
| **æ€»è®¡** | **4å°æ—¶** | **â­â­â­** |

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

### æœ€å°å¯è¡Œæ–¹æ¡ˆï¼ˆMVPï¼‰

1. âœ… ä¿®æ”¹åˆ†é…æ¥å£è°ƒç”¨ï¼Œæ‰“å° `notificationData`
2. âœ… éªŒè¯æ•°æ®æ ¼å¼æ­£ç¡®
3. âœ… å®ç°äº‘å‡½æ•°å‘é€è®¢é˜…æ¶ˆæ¯
4. âœ… é…ç½®è®¢é˜…æ¶ˆæ¯æ¨¡æ¿
5. âœ… æµ‹è¯•å®Œæ•´æµç¨‹

**é¢„è®¡æ—¶é—´**: 2å°æ—¶

---

## ğŸ“ Checklist

- [ ] æ¥æ”¶ `notificationData` å­—æ®µ
- [ ] åˆ›å»ºäº‘å‡½æ•° `sendCustomerAssignNotification`
- [ ] é…ç½®è®¢é˜…æ¶ˆæ¯æ¨¡æ¿
- [ ] è·å–æ¨¡æ¿IDå¹¶æ›´æ–°åˆ°ä»£ç 
- [ ] å®ç°ç”¨æˆ·æˆæƒè®¢é˜…é€»è¾‘
- [ ] æµ‹è¯•å•ä¸ªåˆ†é…é€šçŸ¥
- [ ] æµ‹è¯•æ‰¹é‡åˆ†é…é€šçŸ¥
- [ ] æµ‹è¯•å…¬æµ·åˆ†é…é€šçŸ¥
- [ ] ä¸Šçº¿éƒ¨ç½²

---

**CRMåç«¯çŠ¶æ€**: âœ… å·²å®Œæˆï¼Œå¯ä»¥å¼€å§‹å¯¹æ¥  
**å°ç¨‹åºç«¯çŠ¶æ€**: â³ å¾…å®ç°  
**é¢„è®¡å®Œæˆæ—¶é—´**: 1-2ä¸ªå·¥ä½œæ—¥

