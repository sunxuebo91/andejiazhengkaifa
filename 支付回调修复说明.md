# æ”¯ä»˜å›è°ƒä¿®å¤è¯´æ˜

## ğŸ› é—®é¢˜æè¿°

**ç°è±¡**ï¼šæ”¯ä»˜å®Œæˆåï¼Œé¡µé¢æ²¡æœ‰ååº”ï¼Œä¿å•çŠ¶æ€æ²¡æœ‰è‡ªåŠ¨æ›´æ–°ä¸º"å·²ç”Ÿæ•ˆ"

**åŸå› **ï¼š
1. æ”¯ä»˜å›è°ƒæ¥å£æ¥æ”¶åˆ°çš„æ•°æ®æ˜¯ `undefined`
2. å¤§æ ‘ä¿å‘é€çš„æ˜¯ **XML æ ¼å¼** çš„å›è°ƒæ•°æ®
3. NestJS é»˜è®¤ä½¿ç”¨ `express.json()` è§£æè¯·æ±‚ä½“ï¼Œæ— æ³•æ­£ç¡®è§£æ XML

**æ—¥å¿—æ˜¾ç¤º**ï¼š
```
ğŸ“¥ æ”¶åˆ°æ”¯ä»˜å›è°ƒé€šçŸ¥:
undefined
```

---

## âœ… ä¿®å¤æ–¹æ¡ˆ

### 1. ä¿®æ”¹ `main.ts` - æ·»åŠ åŸå§‹æ–‡æœ¬è§£æå™¨

**æ–‡ä»¶**: `backend/src/main.ts`

**ä¿®æ”¹å†…å®¹**ï¼š
```typescript
// ä¸ºæ”¯ä»˜å›è°ƒæ¥å£é…ç½®åŸå§‹æ–‡æœ¬è§£æå™¨ï¼ˆæ¥æ”¶XMLï¼‰
app.use('/api/dashubao/payment/callback', express.text({ type: '*/*' }));

// å…¶ä»–æ¥å£ä½¿ç”¨JSONè§£æå™¨
app.use(express.json({ limit: '50mb' }));
app.use(express.urlencoded({ extended: true, limit: '50mb' }));
```

**è¯´æ˜**ï¼š
- ä¸º `/api/dashubao/payment/callback` è·¯å¾„å•ç‹¬é…ç½®æ–‡æœ¬è§£æå™¨
- æ¥æ”¶ä»»æ„ç±»å‹çš„è¯·æ±‚ä½“ï¼ˆ`type: '*/*'`ï¼‰
- å°†è¯·æ±‚ä½“è§£æä¸ºåŸå§‹å­—ç¬¦ä¸²ï¼Œè€Œä¸æ˜¯ JSON å¯¹è±¡

### 2. ä¿®æ”¹ `dashubao.controller.ts` - ä½¿ç”¨ `@Req()` è£…é¥°å™¨

**æ–‡ä»¶**: `backend/src/modules/dashubao/dashubao.controller.ts`

**å¯¼å…¥ `Req` è£…é¥°å™¨**ï¼š
```typescript
import {
  Controller,
  Post,
  Get,
  Body,
  Param,
  Query,
  UseGuards,
  Request,
  Req,  // âœ… æ–°å¢
  HttpCode,
  HttpStatus,
  Res,
  StreamableFile,
} from '@nestjs/common';
```

**ä¿®æ”¹å›è°ƒæ¥å£**ï¼š
```typescript
@Post('payment/callback')
@HttpCode(HttpStatus.OK)
@ApiOperation({ summary: 'æ”¯ä»˜å›è°ƒ - æ¥æ”¶å¤§æ ‘ä¿æ”¯ä»˜æˆåŠŸé€šçŸ¥' })
@ApiResponse({ status: 200, description: 'å›è°ƒå¤„ç†æˆåŠŸ' })
async paymentCallback(@Req() req: any) {
  // è·å–åŸå§‹è¯·æ±‚ä½“ï¼ˆXMLå­—ç¬¦ä¸²ï¼‰
  const xmlBody = req.body;
  return this.dashubaoService.handlePaymentCallback(xmlBody);
}
```

**è¯´æ˜**ï¼š
- ä½¿ç”¨ `@Req()` è£…é¥°å™¨è·å–åŸå§‹è¯·æ±‚å¯¹è±¡
- ä» `req.body` è·å–åŸå§‹ XML å­—ç¬¦ä¸²
- ä¼ é€’ç»™ Service å±‚è¿›è¡Œè§£æ

---

## ğŸ” å·¥ä½œæµç¨‹

### å®Œæ•´çš„æ”¯ä»˜æµç¨‹

```
1. ç”¨æˆ·æ‰«ç æ”¯ä»˜
   â†“
2. å¾®ä¿¡æ”¯ä»˜æˆåŠŸ
   â†“
3. å¤§æ ‘ä¿æ”¶åˆ°å¾®ä¿¡æ”¯ä»˜é€šçŸ¥
   â†“
4. å¤§æ ‘ä¿å‘é€XMLå›è°ƒåˆ°æˆ‘ä»¬çš„æœåŠ¡å™¨
   POST https://crm.andejiazheng.com/api/dashubao/payment/callback
   Content-Type: text/xml
   Body: <?xml version="1.0"?>...
   â†“
5. æˆ‘ä»¬çš„æœåŠ¡å™¨æ¥æ”¶XMLå­—ç¬¦ä¸²
   express.text() è§£æä¸ºåŸå§‹å­—ç¬¦ä¸²
   â†“
6. Controller è·å–åŸå§‹å­—ç¬¦ä¸²
   @Req() req: any
   const xmlBody = req.body;
   â†“
7. Service è§£æXML
   xml2js.parseStringPromise(xmlBody)
   â†“
8. æ›´æ–°ä¿å•çŠ¶æ€ä¸º"å·²ç”Ÿæ•ˆ"
   policyModel.updateOne({ status: 'active' })
   â†“
9. å‰ç«¯è½®è¯¢æ£€æµ‹åˆ°çŠ¶æ€å˜åŒ–
   æ¯3ç§’æŸ¥è¯¢ä¸€æ¬¡ä¿å•çŠ¶æ€
   â†“
10. æ˜¾ç¤º"æ”¯ä»˜æˆåŠŸ"
    å¼¹çª—æ˜¾ç¤ºæˆåŠŸä¿¡æ¯
```

---

## ğŸ§ª æµ‹è¯•æ–¹æ³•

### æ–¹æ³•1ï¼šçœŸå®æ”¯ä»˜æµ‹è¯•

1. **åˆ›å»ºæ–°ä¿å•**
   - é€‰æ‹©ä¿é™©è®¡åˆ’
   - å¡«å†™æŠ•ä¿äººå’Œè¢«ä¿é™©äººä¿¡æ¯
   - æäº¤ä¿å•

2. **ç‚¹å‡»æ”¯ä»˜**
   - ç‚¹å‡»"ç«‹å³æ”¯ä»˜"æŒ‰é’®
   - å¼¹å‡ºäºŒç»´ç æ”¯ä»˜çª—å£

3. **æ‰«ç æ”¯ä»˜**
   - ä½¿ç”¨å¾®ä¿¡æ‰«æäºŒç»´ç 
   - å®Œæˆæ”¯ä»˜ï¼ˆ12å…ƒï¼‰

4. **ç­‰å¾…å›è°ƒ**
   - æ”¯ä»˜æˆåŠŸåï¼Œå¤§æ ‘ä¿ä¼šåœ¨å‡ ç§’å†…å‘é€å›è°ƒ
   - å‰ç«¯æ¯3ç§’è½®è¯¢ä¸€æ¬¡ä¿å•çŠ¶æ€

5. **æŸ¥çœ‹ç»“æœ**
   - æ”¯ä»˜çª—å£åº”è¯¥æ˜¾ç¤º"æ”¯ä»˜æˆåŠŸ"
   - ä¿å•åˆ—è¡¨ä¸­çŠ¶æ€å˜ä¸º"å·²ç”Ÿæ•ˆ"ï¼ˆç»¿è‰²ï¼‰

### æ–¹æ³•2ï¼šæŸ¥çœ‹æ—¥å¿—

**æŸ¥çœ‹æ”¯ä»˜å›è°ƒæ—¥å¿—**ï¼š
```bash
pm2 logs backend-prod --lines 50 | grep -A 20 "æ”¶åˆ°æ”¯ä»˜å›è°ƒ"
```

**åº”è¯¥çœ‹åˆ°**ï¼š
```
ğŸ“¥ æ”¶åˆ°æ”¯ä»˜å›è°ƒé€šçŸ¥:
{
  ResultInfo: {
    OrderId: '19743306',
    AgencyPolicyRef: 'ANDE1766133619140lrd2lj',
    PolicyList: {
      Policy: {
        Success: 'true',
        PolicyNo: '14527003900176210471',
        EffectiveDate: '20251220000000',
        ExpireDate: '20260119235959'
      }
    }
  }
}
âœ… ä¿å• 14527003900176210471 æ”¯ä»˜æˆåŠŸï¼ŒçŠ¶æ€å·²æ›´æ–°
```

**å¦‚æœè¿˜æ˜¯ `undefined`**ï¼š
- æ£€æŸ¥ `main.ts` æ˜¯å¦æ­£ç¡®é…ç½®äº†æ–‡æœ¬è§£æå™¨
- æ£€æŸ¥è·¯å¾„æ˜¯å¦åŒ¹é…ï¼š`/api/dashubao/payment/callback`
- æ£€æŸ¥æ˜¯å¦é‡å¯äº†åç«¯æœåŠ¡

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. ä¸­é—´ä»¶é¡ºåºå¾ˆé‡è¦

```typescript
// âœ… æ­£ç¡®ï¼šå…ˆé…ç½®ç‰¹å®šè·¯å¾„çš„è§£æå™¨
app.use('/api/dashubao/payment/callback', express.text({ type: '*/*' }));
app.use(express.json({ limit: '50mb' }));

// âŒ é”™è¯¯ï¼šå…ˆé…ç½®JSONè§£æå™¨ä¼šæ‹¦æˆªæ‰€æœ‰è¯·æ±‚
app.use(express.json({ limit: '50mb' }));
app.use('/api/dashubao/payment/callback', express.text({ type: '*/*' }));
```

### 2. è·¯å¾„å¿…é¡»å®Œå…¨åŒ¹é…

- é…ç½®çš„è·¯å¾„ï¼š`/api/dashubao/payment/callback`
- å®é™…çš„è·¯å¾„ï¼š`/api/dashubao/payment/callback`
- å¿…é¡»å®Œå…¨ä¸€è‡´ï¼ˆåŒ…æ‹¬ `/api` å‰ç¼€ï¼‰

### 3. å¤§æ ‘ä¿å›è°ƒå¯èƒ½æœ‰å»¶è¿Ÿ

- æ”¯ä»˜æˆåŠŸåï¼Œå¤§æ ‘ä¿å¯èƒ½éœ€è¦å‡ ç§’é’Ÿæ‰å‘é€å›è°ƒ
- å‰ç«¯æ¯3ç§’è½®è¯¢ä¸€æ¬¡ï¼Œæœ€å¤šå¯èƒ½éœ€è¦ç­‰å¾…3-6ç§’
- å¦‚æœè¶…è¿‡30ç§’è¿˜æ²¡æœ‰ååº”ï¼Œæ£€æŸ¥æ—¥å¿—

---

## ğŸ‰ ä¿®å¤å®Œæˆ

âœ… å·²ä¿®æ”¹ `main.ts` æ·»åŠ æ–‡æœ¬è§£æå™¨  
âœ… å·²ä¿®æ”¹ `dashubao.controller.ts` ä½¿ç”¨ `@Req()` è£…é¥°å™¨  
âœ… å·²ç¼–è¯‘å¹¶é‡å¯åç«¯æœåŠ¡  
ğŸš€ ç°åœ¨å¯ä»¥æµ‹è¯•æ”¯ä»˜åŠŸèƒ½äº†ï¼

---

## ğŸ“ ä¸‹æ¬¡æ”¯ä»˜æµ‹è¯•æ­¥éª¤

1. **åˆ›å»ºæ–°ä¿å•**ï¼ˆä¸è¦ç”¨æ—§çš„æµæ°´å·ï¼‰
2. **ç‚¹å‡»æ”¯ä»˜**
3. **æ‰«ç æ”¯ä»˜**ï¼ˆ12å…ƒï¼‰
4. **ç­‰å¾…3-6ç§’**
5. **æŸ¥çœ‹æ”¯ä»˜çª—å£æ˜¯å¦æ˜¾ç¤º"æ”¯ä»˜æˆåŠŸ"**
6. **æŸ¥çœ‹ä¿å•åˆ—è¡¨çŠ¶æ€æ˜¯å¦å˜ä¸º"å·²ç”Ÿæ•ˆ"**

å¦‚æœè¿˜æœ‰é—®é¢˜ï¼Œç«‹å³æŸ¥çœ‹æ—¥å¿—ï¼š
```bash
pm2 logs backend-prod --lines 100 | grep -A 20 "æ”¶åˆ°æ”¯ä»˜å›è°ƒ"
```

ç¥æµ‹è¯•é¡ºåˆ©ï¼ğŸ¯

