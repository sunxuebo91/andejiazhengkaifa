# 支付场景切换说明 - MWEB → NATIVE

## 🔍 问题原因

用户在**微信内置浏览器**中打开了 H5 支付链接，但 `MWEB`（H5支付场景）不支持在微信内打开。

微信提示：**"请在微信外打开订单，进行支付"**

---

## ✅ 解决方案：切换到 NATIVE（二维码支付）

### 支付场景对比

| TradeType | 场景 | 适用环境 | 是否适合你们 |
|-----------|------|----------|-------------|
| **MWEB** | H5支付 | 微信外的手机浏览器 | ❌ 不适合（用户在微信内打开） |
| **NATIVE** | 二维码支付 | PC端扫码 | ✅ **推荐**（用户在电脑上操作CRM） |
| **OPEN** | 公众号支付 | 微信公众号内 | ⚠️ 需要配置公众号 |
| **MINI** | 小程序支付 | 微信小程序 | ⚠️ 需要开发小程序 |
| **APP** | APP支付 | 原生APP | ❌ 不适合 |

---

## 🎯 NATIVE（二维码支付）的优势

### 适合你们的使用场景：
1. ✅ **用户在电脑上操作CRM系统**
2. ✅ **点击支付后，显示二维码**
3. ✅ **用户用手机微信扫码支付**
4. ✅ **支付成功后，系统自动更新保单状态**

### 用户体验流程：
```
用户在电脑上创建保单
    ↓
点击"立即支付"
    ↓
弹出支付窗口，显示二维码
    ↓
用户用手机微信扫码
    ↓
在手机上完成支付
    ↓
大树保回调我们的服务器
    ↓
系统自动更新保单状态为"已生效"
    ↓
前端检测到状态变化，显示支付成功
```

---

## 📝 已完成的修改

### 1. 前端修改（`frontend/src/components/WechatPayModal.tsx`）

**第42-43行**：
```typescript
// 之前（MWEB - H5支付）
const result = await insuranceService.createPaymentOrder(policyRef, 'MWEB');

// 现在（NATIVE - 二维码支付）
const result = await insuranceService.createPaymentOrder(policyRef, 'NATIVE');
```

### 2. 后端支持（无需修改）

后端已经支持动态传入 `tradeType` 参数，会根据前端传入的值生成对应的支付请求。

---

## 🚀 测试步骤

### 前提条件：
⚠️ **必须先确认大树保已为账号 `ande` 配置了微信支付功能！**

如果还没有配置，会返回错误："没有配置支付类型！"

### 测试流程：

1. **刷新页面**（清除缓存）

2. **创建新保单**
   - 注意：必须创建全新的保单，不要用之前的流水号

3. **点击"立即支付"**
   - 应该弹出支付窗口
   - 显示二维码

4. **查看后端日志**
   ```bash
   pm2 logs backend-prod --lines 50 | grep "TradeType"
   ```
   应该看到：
   ```xml
   <TradeType>NATIVE</TradeType>
   ```

5. **如果支付接口调用成功**
   - 前端会显示二维码
   - 用手机微信扫码支付

6. **支付成功后**
   - 大树保会回调我们的服务器
   - 系统自动更新保单状态
   - 前端检测到状态变化，显示支付成功

---

## ⚠️ 可能遇到的问题

### 问题1：仍然返回"没有配置支付类型！"

**原因**：大树保账号未配置微信支付功能

**解决**：联系大树保技术支持，要求为账号 `ande` 开通微信支付功能

---

### 问题2：返回"流水号不能重复"

**原因**：使用了之前已经创建过的保单流水号

**解决**：创建一个全新的保单，系统会自动生成新的流水号

---

### 问题3：二维码显示失败

**原因**：大树保返回的支付信息格式不正确

**解决**：查看后端日志，确认大树保返回的数据格式：
```bash
pm2 logs backend-prod --lines 100 | grep -A 10 "收到响应"
```

---

## 📋 支付接口返回的数据格式

### NATIVE（二维码支付）成功时返回：

```xml
<ResultInfo>
  <Success>true</Success>
  <OrderId>订单号</OrderId>
  <WeChatCodeUrl>二维码链接</WeChatCodeUrl>
  <!-- 其他微信支付参数 -->
</ResultInfo>
```

前端会使用 `WeChatCodeUrl` 或 `WeChatWebUrl` 生成二维码。

---

## 🎉 总结

1. ✅ 已将支付场景从 `MWEB` 切换到 `NATIVE`
2. ✅ 前端已编译完成
3. ⚠️ **需要确认大树保是否已配置微信支付功能**
4. 🚀 刷新页面即可测试

---

## 📞 如果还有问题

联系大树保技术支持，提供以下信息：

```
账号：ande
环境：生产环境（https://api.dasurebao.com.cn/remoting/ws）
问题：调用支付接口（0022）返回"没有配置支付类型！"
请求：TradeType=NATIVE, Target=WeChat
请求：是否已为该账号配置微信支付功能？
```

