# æ”¯ä»˜æ¥å£ä¿®å¤è¯´æ˜

## ğŸ” é—®é¢˜åŸå› 

å¤§æ ‘ä¿æŠ€æœ¯æ”¯æŒæŒ‡å‡ºï¼š**`NotifyUrl` ä¸èƒ½å¡«å¤§æ ‘ä¿çš„åŸŸåï¼**

ä¹‹å‰æˆ‘ä»¬å¡«çš„æ˜¯ï¼š
```xml
<NotifyUrl>https://api.dasurebao.com.cn/payment/notify</NotifyUrl>
```

âŒ **è¿™æ˜¯é”™è¯¯çš„ï¼** è¿™æ˜¯å¤§æ ‘ä¿è‡ªå·±çš„åŸŸåï¼Œä¸æ˜¯æˆ‘ä»¬çš„å›è°ƒåœ°å€ã€‚

---

## âœ… è§£å†³æ–¹æ¡ˆ

### 1. ä¿®æ”¹ NotifyUrl ä¸ºæˆ‘ä»¬è‡ªå·±çš„æœåŠ¡å™¨åœ°å€

**æ–°çš„ NotifyUrl**:
```xml
<NotifyUrl>https://crm.andejiazheng.com/api/dashubao/payment/callback</NotifyUrl>
```

### 2. åˆ›å»ºæ”¯ä»˜å›è°ƒæ¥å£

**æ¥å£è·¯å¾„**: `POST /api/dashubao/payment/callback`

**åŠŸèƒ½**: æ¥æ”¶å¤§æ ‘ä¿æ”¯ä»˜æˆåŠŸåçš„é€šçŸ¥ï¼Œæ›´æ–°ä¿å•çŠ¶æ€

**å¤„ç†é€»è¾‘**:
1. æ¥æ”¶å¤§æ ‘ä¿å‘é€çš„XMLå›è°ƒæ•°æ®
2. è§£æè®¢å•å·ã€æµæ°´å·ã€ä¿å•ä¿¡æ¯
3. æ›´æ–°æ•°æ®åº“ä¸­çš„ä¿å•çŠ¶æ€ä¸º"å·²ç”Ÿæ•ˆ"
4. æ›´æ–°ä¿å•å·ã€ç”Ÿæ•ˆæ—¥æœŸã€å¤±æ•ˆæ—¥æœŸç­‰ä¿¡æ¯
5. è¿”å›æˆåŠŸå“åº”ç»™å¤§æ ‘ä¿

---

## ğŸ“‹ ä¿®æ”¹çš„æ–‡ä»¶

### 1. `backend/src/modules/dashubao/dashubao.service.ts`

#### ä¿®æ”¹ NotifyUrl ç”Ÿæˆé€»è¾‘ï¼ˆç¬¬414-422è¡Œï¼‰
```typescript
// æ„å»ºæ”¯ä»˜ä¿¡æ¯ï¼ˆæ·»åŠ NotifyUrlå›è°ƒåœ°å€ - ä½¿ç”¨è‡ªå·±çš„æœåŠ¡å™¨åœ°å€ï¼‰
const backendBaseUrl = process.env.BACKEND_BASE_URL || 'https://crm.andejiazheng.com';
const notifyUrl = `${backendBaseUrl}/api/dashubao/payment/callback`;
const payInfoXml = `
<PayInfo>
  <Target>WeChat</Target>
  <TradeType>${tradeType}</TradeType>
  <NotifyUrl>${notifyUrl}</NotifyUrl>
</PayInfo>`;
```

#### æ–°å¢æ”¯ä»˜å›è°ƒå¤„ç†æ–¹æ³•ï¼ˆç¬¬495-545è¡Œï¼‰
```typescript
/**
 * å¤„ç†æ”¯ä»˜å›è°ƒ
 */
async handlePaymentCallback(body: any): Promise<any> {
  this.logger.log('='.repeat(80));
  this.logger.log('ğŸ“¥ æ”¶åˆ°æ”¯ä»˜å›è°ƒé€šçŸ¥:');
  this.logger.log(JSON.stringify(body, null, 2));
  this.logger.log('='.repeat(80));

  try {
    // è§£æXMLå›è°ƒæ•°æ®
    const xml2js = require('xml2js');
    const parser = new xml2js.Parser({ explicitArray: false });
    const result = await parser.parseStringPromise(body);

    const resultInfo = result.ResultInfo;
    const orderId = resultInfo.OrderId;
    const agencyPolicyRef = resultInfo.AgencyPolicyRef;
    const policyList = resultInfo.PolicyList?.Policy;

    this.logger.log(`è®¢å•å·: ${orderId}`);
    this.logger.log(`æµæ°´å·: ${agencyPolicyRef}`);

    // æ›´æ–°ä¿å•çŠ¶æ€
    if (policyList) {
      const policies = Array.isArray(policyList) ? policyList : [policyList];
      
      for (const policy of policies) {
        if (policy.Success === 'true') {
          await this.policyModel.updateOne(
            { agencyPolicyRef: agencyPolicyRef },
            {
              status: 'active',
              policyNo: policy.PolicyNo,
              orderId: policy.OrderId,
              effectiveDate: policy.EffectiveDate,
              expireDate: policy.ExpireDate,
            }
          );
          this.logger.log(`âœ… ä¿å• ${policy.PolicyNo} æ”¯ä»˜æˆåŠŸï¼ŒçŠ¶æ€å·²æ›´æ–°`);
        }
      }
    }

    // è¿”å›æˆåŠŸå“åº”ç»™å¤§æ ‘ä¿
    return { success: true, message: 'å›è°ƒå¤„ç†æˆåŠŸ' };
  } catch (error) {
    this.logger.error('å¤„ç†æ”¯ä»˜å›è°ƒå¤±è´¥:', error);
    throw error;
  }
}
```

### 2. `backend/src/modules/dashubao/dashubao.controller.ts`

#### æ–°å¢æ”¯ä»˜å›è°ƒæ¥å£ï¼ˆç¬¬107-114è¡Œï¼‰
```typescript
@Post('payment/callback')
@HttpCode(HttpStatus.OK)
@ApiOperation({ summary: 'æ”¯ä»˜å›è°ƒ - æ¥æ”¶å¤§æ ‘ä¿æ”¯ä»˜æˆåŠŸé€šçŸ¥' })
@ApiResponse({ status: 200, description: 'å›è°ƒå¤„ç†æˆåŠŸ' })
async paymentCallback(@Body() body: any) {
  return this.dashubaoService.handlePaymentCallback(body);
}
```

---

## ğŸ‰ ç°åœ¨çš„å®Œæ•´æ”¯ä»˜æµç¨‹

1. **ç”¨æˆ·ç‚¹å‡»"æŠ•ä¿"** â†’ åˆ›å»ºä¿å•ï¼ˆçŠ¶æ€ï¼šå¾…æ”¯ä»˜ï¼‰
2. **è‡ªåŠ¨å¼¹å‡ºæ”¯ä»˜çª—å£** â†’ è°ƒç”¨æ”¯ä»˜æ¥å£è·å–å¾®ä¿¡æ”¯ä»˜URL
3. **ç”¨æˆ·æ‰«ç æ”¯ä»˜** â†’ å¾®ä¿¡æ”¯ä»˜æˆåŠŸ
4. **å¤§æ ‘ä¿å‡ºå•** â†’ ç”Ÿæˆæ­£å¼ä¿å•
5. **å¤§æ ‘ä¿å›è°ƒæˆ‘ä»¬çš„æœåŠ¡å™¨** â†’ `POST https://crm.andejiazheng.com/api/dashubao/payment/callback`
6. **æˆ‘ä»¬æ›´æ–°ä¿å•çŠ¶æ€** â†’ çŠ¶æ€ä»"å¾…æ”¯ä»˜"å˜ä¸º"å·²ç”Ÿæ•ˆ"
7. **å‰ç«¯è½®è¯¢æ£€æµ‹** â†’ å‘ç°çŠ¶æ€å˜åŒ–ï¼Œå…³é—­æ”¯ä»˜çª—å£ï¼Œæ˜¾ç¤ºæˆåŠŸ

---

## ğŸš€ æµ‹è¯•æ­¥éª¤

1. åˆ·æ–°é¡µé¢
2. åˆ›å»ºä¸€ä¸ªæ–°çš„ä¿å•
3. ç‚¹å‡»"ç«‹å³æ”¯ä»˜"
4. æŸ¥çœ‹åç«¯æ—¥å¿—ï¼Œç¡®è®¤ NotifyUrl æ˜¯å¦æ­£ç¡®ï¼š
   ```
   <NotifyUrl>https://crm.andejiazheng.com/api/dashubao/payment/callback</NotifyUrl>
   ```
5. æ‰«ç æ”¯ä»˜ï¼ˆå¦‚æœæ”¯ä»˜æˆåŠŸï¼‰
6. ç­‰å¾…å¤§æ ‘ä¿å›è°ƒ
7. æŸ¥çœ‹åç«¯æ—¥å¿—ï¼Œç¡®è®¤æ˜¯å¦æ”¶åˆ°å›è°ƒé€šçŸ¥
8. æ£€æŸ¥ä¿å•çŠ¶æ€æ˜¯å¦æ›´æ–°ä¸º"å·²ç”Ÿæ•ˆ"

---

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **å›è°ƒæ¥å£ä¸éœ€è¦JWTè®¤è¯** - å› ä¸ºæ˜¯å¤§æ ‘ä¿æœåŠ¡å™¨è°ƒç”¨ï¼Œä¸æ˜¯å‰ç«¯è°ƒç”¨
2. **å›è°ƒæ¥å£éœ€è¦å…¬ç½‘å¯è®¿é—®** - ç¡®ä¿ `https://crm.andejiazheng.com` å¯ä»¥ä»å¤–ç½‘è®¿é—®
3. **å›è°ƒæ•°æ®æ ¼å¼** - å¤§æ ‘ä¿ä¼šå‘é€XMLæ ¼å¼çš„æ•°æ®ï¼Œæˆ‘ä»¬éœ€è¦è§£æ
4. **å¹‚ç­‰æ€§** - å¤§æ ‘ä¿å¯èƒ½ä¼šé‡å¤å‘é€å›è°ƒï¼Œéœ€è¦åšå¥½å¹‚ç­‰æ€§å¤„ç†ï¼ˆå½“å‰å·²é€šè¿‡ `updateOne` å®ç°ï¼‰

---

## ğŸ“ ä¸‹ä¸€æ­¥

ç°åœ¨å¯ä»¥é‡æ–°æµ‹è¯•æ”¯ä»˜åŠŸèƒ½äº†ï¼å¦‚æœè¿˜æœ‰é—®é¢˜ï¼ŒæŸ¥çœ‹åç«¯æ—¥å¿—ï¼š
```bash
pm2 logs backend-prod --lines 100
```

