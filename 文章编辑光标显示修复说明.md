# 文章编辑光标显示修复说明

## 修复时间
2026-01-14

## 问题描述

### 问题1：图片只能插入到最底层，不能插入到指定行
**现象**：
- 用户上传图片后，点击"插入"按钮
- 图片总是插入到文本的最底部，而不是光标所在位置
- 无法在文本中间插入图片

**根本原因**：
- `insertAtCursor` 函数无法正确获取 textarea 元素的引用
- 光标位置获取失败，导致默认插入到末尾

### 问题2：输入内容时没有光标显示
**现象**：
- 用户点击正文输入框后，看不到闪烁的光标（像 Word 文档那样的竖线）
- 虽然可以输入文字，但不知道当前光标在哪里
- 用户体验很差，不知道从哪里开始输入

**根本原因**：
- 之前使用了隐藏的 textarea（position: absolute; left: -9999px）
- 光标虽然存在，但因为 textarea 在屏幕外，所以看不到
- 没有设置 autoFocus 和光标颜色

## 解决方案

### 1. 改进 insertAtCursor 函数（第 314-365 行）

**修改内容**：
```typescript
const insertAtCursor = (text: string) => {
  // 尝试多种方式获取 textarea 元素
  let el: HTMLTextAreaElement | null = null;
  
  // 方式1: 通过 resizableTextArea 属性
  if (textAreaRef.current?.resizableTextArea?.textArea) {
    el = textAreaRef.current.resizableTextArea.textArea;
  }
  // 方式2: 直接通过 ref
  else if (textAreaRef.current instanceof HTMLTextAreaElement) {
    el = textAreaRef.current;
  }
  // 方式3: 通过 querySelector 查找
  else if (textAreaRef.current) {
    const textarea = (textAreaRef.current as any).querySelector?.('textarea');
    if (textarea instanceof HTMLTextAreaElement) {
      el = textarea;
    }
  }

  const current = form.getFieldValue('contentRaw') || '';

  if (!el) {
    // 如果找不到 textarea，直接追加到末尾
    form.setFieldsValue({ contentRaw: `${current}${current ? '\n' : ''}${text}` });
    message.info('图片已插入到文本末尾');
    return;
  }

  // 先聚焦 textarea，确保能获取到正确的光标位置
  el.focus();

  // 获取当前光标位置
  const start = el.selectionStart ?? current.length;
  const end = el.selectionEnd ?? current.length;
  
  // 在光标位置插入文本
  const next = current.slice(0, start) + text + current.slice(end);
  form.setFieldsValue({ contentRaw: next });

  // 使用 requestAnimationFrame 确保 DOM 更新后再设置光标位置
  requestAnimationFrame(() => {
    if (el) {
      el.focus();
      const pos = start + text.length;
      el.selectionStart = pos;
      el.selectionEnd = pos;
      // 滚动到光标位置
      el.scrollTop = el.scrollHeight;
    }
  });
};
```

**优化点**：
- ✅ 使用多种方式尝试获取 textarea 元素
- ✅ 插入前先聚焦，确保能获取正确的光标位置
- ✅ 插入后自动滚动到光标位置
- ✅ 如果无法获取光标位置，提示用户

### 2. 将隐藏的 textarea 改为可见的 Input.TextArea（第 827-842 行）

**修改前**：
```tsx
<div style={{ position: 'absolute', left: -9999, ... }}>
  <textarea ... />
</div>
```

**修改后**：
```tsx
<Input.TextArea
  ref={textAreaRef}
  rows={10}
  placeholder="支持：空行分段、# 标题、- 列表、![](图片URL) 插图，或直接 Ctrl+V 粘贴图片"
  onPaste={handlePaste}
  autoFocus
  style={{
    fontSize: 14,
    lineHeight: 1.8,
    caretColor: '#1890ff', // 设置光标颜色为蓝色，更明显
  }}
  onFocus={(e) => {
    // 确保光标可见
    e.target.style.caretColor = '#1890ff';
  }}
/>
```

**优化点**：
- ✅ 使用标准的 Ant Design Input.TextArea 组件
- ✅ 添加 autoFocus 属性，打开模态框时自动聚焦
- ✅ 设置 caretColor 为蓝色，让光标更明显
- ✅ 添加 onFocus 事件，确保光标颜色正确

### 3. 添加模态框打开后自动聚焦（第 721-733 行）

**修改内容**：
```tsx
<Modal
  ...
  afterOpenChange={(open) => {
    // 模态框打开后，延迟聚焦到 textarea，确保光标可见
    if (open && activeTab === 'edit') {
      setTimeout(() => {
        const el = textAreaRef.current?.resizableTextArea?.textArea || textAreaRef.current;
        if (el) {
          el.focus();
          // 将光标移到文本末尾
          const len = el.value?.length || 0;
          el.setSelectionRange(len, len);
        }
      }, 100);
    }
  }}
>
```

**优化点**：
- ✅ 模态框打开后自动聚焦到输入框
- ✅ 光标自动移到文本末尾，方便继续输入
- ✅ 使用 setTimeout 确保 DOM 渲染完成

## 优化效果

### 图片插入功能
✅ **可以插入到指定位置**：点击输入框中的任意位置，然后点击"插入"按钮，图片会插入到光标所在位置
✅ **光标位置正确**：插入后光标会移到图片标记的后面，方便继续输入
✅ **自动滚动**：插入后自动滚动到光标位置，确保用户能看到插入的内容

### 光标显示
✅ **光标可见**：输入框中有明显的蓝色闪烁光标，像 Word 文档一样
✅ **自动聚焦**：打开编辑窗口时，光标自动出现在输入框中
✅ **光标颜色**：使用蓝色光标（#1890ff），更加醒目

## 测试建议

1. **测试光标显示**：
   - 点击"新增文章"按钮
   - 确认正文输入框中有蓝色闪烁的光标
   - 输入一些文字，确认光标跟随文字移动

2. **测试图片插入到指定位置**：
   - 输入一些文字，例如："第一段\n\n第二段"
   - 点击"第一段"和"第二段"之间的位置
   - 上传图片，点击"插入"按钮
   - 确认图片插入到两段之间，而不是末尾

3. **测试光标位置保持**：
   - 在文本中间点击
   - 点击"插入"按钮
   - 确认插入后光标在图片标记后面

4. **测试粘贴图片**：
   - 复制一张图片
   - 在输入框中按 Ctrl+V
   - 确认图片插入到光标位置

