# 月嫂档期功能 - 生产环境部署说明

## ⚠️ 重要提示

这是**生产环境**，需要谨慎操作！

## 当前状态

### 已完成的开发工作
✅ 后端代码已完成（档期API、数据模型、合同自动同步）
✅ 前端代码已完成（档期日历组件）
✅ 修复了 LESS 依赖问题（改用内联样式）
✅ 代码无编译错误

### 生产环境状态
- 后端：backend-prod 运行在端口 3000
- 前端：frontend-prod 运行（已构建的静态文件）
- 开发环境：backend-dev 和 frontend-dev 也在运行

## 需要执行的部署步骤

### 方案 A：立即部署（推荐在业务低峰期）

```bash
# 1. 重新构建前端
cd /home/ubuntu/andejiazhengcrm/frontend
npm run build

# 2. 重启后端生产服务（加载新的档期API）
pm2 restart backend-prod

# 3. 重启前端生产服务（加载新的构建文件）
pm2 restart frontend-prod

# 4. 检查服务状态
pm2 status
pm2 logs backend-prod --lines 50
pm2 logs frontend-prod --lines 50
```

### 方案 B：延迟部署（推荐）

**等待合适的时间窗口**，然后执行方案 A 的步骤。

建议部署时间：
- 业务低峰期（如凌晨或周末）
- 或者在下一次计划的发布窗口

## 部署风险评估

### 低风险
- ✅ 新功能是**增量功能**，不影响现有功能
- ✅ 仅月嫂简历显示档期，其他工种不受影响
- ✅ 档期功能是可选的，不影响核心业务流程
- ✅ 合同创建时的档期同步是非阻塞的（失败不影响合同创建）

### 需要注意
- ⚠️ 后端添加了新的 API 路由
- ⚠️ Resume 模型添加了新字段（MongoDB 自动兼容）
- ⚠️ 合同创建逻辑有修改（添加了档期同步）

## 回滚方案

如果部署后出现问题，可以快速回滚：

```bash
# 1. 回滚到上一个 git 版本
cd /home/ubuntu/andejiazhengcrm
git log --oneline -5  # 查看最近的提交
git checkout <上一个稳定版本的commit-hash>

# 2. 重新构建前端
cd frontend
npm run build

# 3. 重启服务
pm2 restart backend-prod
pm2 restart frontend-prod
```

## 测试计划

部署后需要测试：

1. **基本功能测试**
   - [ ] 登录系统
   - [ ] 查看月嫂简历列表
   - [ ] 进入月嫂简历详情页
   - [ ] 查看档期日历是否正常显示

2. **档期功能测试**
   - [ ] 更新档期
   - [ ] 查看档期状态
   - [ ] 创建合同，检查档期是否自动更新

3. **回归测试**
   - [ ] 非月嫂简历（育儿嫂、保姆等）正常显示
   - [ ] 合同创建功能正常
   - [ ] 客户管理功能正常

## 数据库变更

### Resume 集合
新增字段：`availabilityCalendar`（数组）

MongoDB 会自动处理：
- 旧数据：该字段为 undefined 或空数组
- 新数据：包含档期信息

**无需手动迁移数据**

## 监控建议

部署后监控以下指标：

1. **错误日志**
   ```bash
   pm2 logs backend-prod --err --lines 100
   ```

2. **API 响应时间**
   - 关注 `/api/resumes/:id/availability` 接口

3. **用户反馈**
   - 是否有用户报告档期功能异常
   - 是否有用户报告其他功能受影响

## 联系方式

如有问题，请联系开发团队。

## 当前建议

**建议：暂不部署到生产环境**

原因：
1. 这是生产环境，需要更充分的测试
2. 应该在开发/测试环境充分验证后再部署
3. 需要选择合适的部署时间窗口
4. 需要提前通知相关人员

**下一步行动：**
1. 在开发环境（localhost:5173）充分测试
2. 如有测试环境，先部署到测试环境
3. 准备详细的测试用例
4. 选择合适的部署时间
5. 通知相关人员
6. 执行部署
7. 监控系统状态

---

**创建时间**: 2026-01-04
**创建人**: AI Assistant

