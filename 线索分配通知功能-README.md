# 线索分配通知功能 - 完整文档导航

## 📚 文档列表

### 1. 快速开始

**文件**: `CRM端主动调用云函数-快速参考.md`

适合快速了解方案和实施步骤的开发者。

**内容**:
- 方案概述
- CRM端已完成的工作
- 小程序端待办事项
- 调试指南

---

### 2. 详细实现报告

**文件**: `CRM端主动调用云函数-实现完成报告.md`

适合需要了解技术细节的开发者。

**内容**:
- 环境变量配置
- 服务实现细节
- 接口修改说明
- 云函数请求格式
- 测试指南

---

### 3. 小程序云函数示例

**文件**: `小程序云函数示例-quickstartFunctions.js`

小程序端云函数的完整实现代码。

**内容**:
- 云函数入口函数
- 发送订阅消息逻辑
- 用户openid查询
- 订阅消息模板配置说明

---

### 4. 测试脚本

**文件**: `test_cloud_function_notification.js`

用于测试CRM端调用云函数功能的脚本。

**使用方法**:
```bash
# 1. 编辑脚本，填入真实的 TOKEN、CUSTOMER_ID、ASSIGNED_TO_USER_ID
# 2. 运行测试
node test_cloud_function_notification.js
```

---

### 5. 历史文档（已废弃）

**文件**: `CRM端-线索分配通知实现说明.md`

方案1的实现说明（已废弃，仅供参考）。

---

## 🎯 实施流程

### CRM端（已完成 ✅）

1. ✅ 添加小程序配置到环境变量
2. ✅ 创建微信云函数调用服务
3. ✅ 修改4个客户分配接口
4. ✅ 添加异步云函数调用逻辑
5. ✅ 编译测试通过

### 小程序端（待实施 ⏳）

1. ⏳ 配置小程序AppSecret到CRM后端
2. ⏳ 实现云函数 `quickstartFunctions`
3. ⏳ 配置订阅消息模板
4. ⏳ 部署云函数
5. ⏳ 测试完整流程

---

## 🔧 配置清单

### CRM后端配置

**文件**: `backend/.env`

```env
# 微信小程序配置（用于云函数调用）
MINIPROGRAM_APPID=wxb2c4e35d16d99fd3
MINIPROGRAM_APPSECRET=需要从小程序后台获取
MINIPROGRAM_CLOUD_ENV=cloud1-4gi0bpoje72fedd1
```

### 小程序配置

1. **云函数名称**: `quickstartFunctions`
2. **云环境ID**: `cloud1-4gi0bpoje72fedd1`
3. **订阅消息模板**: 需要在小程序后台配置

---

## 📊 技术架构

```
┌─────────────────────────────────────────────────────────────┐
│                         CRM端操作                            │
│  (Web端 或 小程序端分配客户)                                 │
└────────────────────────┬────────────────────────────────────┘
                         │
                         ▼
┌─────────────────────────────────────────────────────────────┐
│              CustomersController                             │
│  - assignCustomer()                                          │
│  - assignCustomerForMiniprogram()                            │
│  - batchAssignCustomers()                                    │
│  - assignFromPool()                                          │
└────────────────────────┬────────────────────────────────────┘
                         │
                         ▼
┌─────────────────────────────────────────────────────────────┐
│           WechatCloudService                                 │
│  - getAccessToken() [缓存机制]                               │
│  - sendCustomerAssignNotification()                          │
│  - sendBatchCustomerAssignNotification()                     │
└────────────────────────┬────────────────────────────────────┘
                         │
                         ▼
┌─────────────────────────────────────────────────────────────┐
│         微信云开发 HTTP API                                   │
│  POST /tcb/invokecloudfunction                               │
└────────────────────────┬────────────────────────────────────┘
                         │
                         ▼
┌─────────────────────────────────────────────────────────────┐
│      小程序云函数 quickstartFunctions                         │
│  - 接收通知请求                                               │
│  - 查询用户openid                                             │
│  - 发送订阅消息                                               │
└────────────────────────┬────────────────────────────────────┘
                         │
                         ▼
┌─────────────────────────────────────────────────────────────┐
│              用户收到订阅消息通知                             │
└─────────────────────────────────────────────────────────────┘
```

---

## 🧪 测试步骤

### 1. CRM端测试

```bash
# 1. 配置小程序AppSecret
vim backend/.env

# 2. 重启后端服务
cd backend
pm2 restart backend-dev

# 3. 查看日志
pm2 logs backend-dev

# 4. 运行测试脚本
node test_cloud_function_notification.js
```

### 2. 小程序端测试

1. 部署云函数
2. 在CRM端分配客户
3. 查看云函数日志
4. 检查用户是否收到通知

---

## ⚠️ 注意事项

1. **AppSecret安全**: 不要将AppSecret提交到代码仓库
2. **用户授权**: 用户必须先授权订阅消息才能收到通知
3. **openid映射**: 云函数中需要正确映射用户ID到openid
4. **模板配置**: 订阅消息模板必须在小程序后台配置
5. **云函数部署**: 确保云函数部署到正确的云环境

---

## 📞 技术支持

### CRM端问题

- 检查 `backend/.env` 配置
- 查看 `logs/backend-dev-out.log` 日志
- 运行测试脚本诊断问题

### 小程序端问题

- 检查云函数是否部署
- 查看云开发控制台日志
- 确认订阅消息模板配置
- 验证用户openid是否正确存储

---

## 🎉 功能特点

1. **可靠性**: CRM端主动推送，不依赖小程序端
2. **性能**: 异步执行，不阻塞用户操作
3. **容错性**: 通知失败不影响分配操作
4. **统一性**: 所有通知逻辑集中管理
5. **可维护性**: 易于扩展和调试

---

**文档版本**: v1.0  
**创建日期**: 2025-12-24  
**维护者**: 开发团队  
**状态**: ✅ CRM端已完成，小程序端待实施

