# çº¿ç´¢åˆ†é…é€šçŸ¥åŠŸèƒ½ - éƒ¨ç½²å’Œæµ‹è¯•æŒ‡å—

> **å®Œæˆæ—¥æœŸ**: 2025-12-21  
> **å®æ–½æ–¹æ¡ˆ**: CRMåç«¯è¿”å› `notificationData`ï¼Œå°ç¨‹åºç«¯æ¥æ”¶å¹¶å‘é€é€šçŸ¥

---

## ğŸ“¦ éƒ¨ç½²æ­¥éª¤

### 1. é‡å¯CRMåç«¯æœåŠ¡

ä¿®æ”¹å·²å®Œæˆï¼Œéœ€è¦é‡å¯åç«¯æœåŠ¡ä½¿æ›´æ”¹ç”Ÿæ•ˆï¼š

```bash
# è¿›å…¥åç«¯ç›®å½•
cd backend

# é‡å¯æœåŠ¡ï¼ˆæ ¹æ®ä½ çš„éƒ¨ç½²æ–¹å¼é€‰æ‹©ï¼‰

# æ–¹å¼1: ä½¿ç”¨PM2
pm2 restart crm-backend

# æ–¹å¼2: ä½¿ç”¨Docker
docker-compose restart backend

# æ–¹å¼3: ç›´æ¥è¿è¡Œ
npm run start:prod
```

### 2. éªŒè¯æœåŠ¡å¯åŠ¨

```bash
# æ£€æŸ¥æœåŠ¡çŠ¶æ€
curl http://localhost:3000/api/health

# æˆ–è€…æŸ¥çœ‹æ—¥å¿—
pm2 logs crm-backend
```

---

## ğŸ§ª æµ‹è¯•æ­¥éª¤

### æ–¹å¼1: ä½¿ç”¨æµ‹è¯•è„šæœ¬ï¼ˆæ¨èï¼‰

1. **é…ç½®æµ‹è¯•è„šæœ¬**

ç¼–è¾‘ `test_customer_assignment_notification.js`ï¼š

```javascript
const API_BASE_URL = 'http://localhost:3000/api';  // ä¿®æ”¹ä¸ºå®é™…åœ°å€
const TOKEN = 'YOUR_JWT_TOKEN_HERE';                // æ›¿æ¢ä¸ºå®é™…token

const TEST_DATA = {
  customerId: 'å®é™…çš„å®¢æˆ·ID',
  assignedToUserId: 'å®é™…çš„ç”¨æˆ·ID',
  customerIds: ['å®¢æˆ·ID1', 'å®¢æˆ·ID2'],
};
```

2. **è¿è¡Œæµ‹è¯•**

```bash
node test_customer_assignment_notification.js
```

3. **æŸ¥çœ‹ç»“æœ**

æµ‹è¯•è„šæœ¬ä¼šè¾“å‡ºæ¯ä¸ªæ¥å£çš„æµ‹è¯•ç»“æœï¼ŒåŒ…æ‹¬æ˜¯å¦åŒ…å« `notificationData` å­—æ®µã€‚

---

### æ–¹å¼2: ä½¿ç”¨Postman/cURL

#### æµ‹è¯•1: å•ä¸ªå®¢æˆ·åˆ†é…

```bash
curl -X PATCH "http://localhost:3000/api/customers/miniprogram/CUSTOMER_ID/assign" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "assignedTo": "USER_ID",
    "assignmentReason": "æµ‹è¯•åˆ†é…"
  }'
```

**æœŸæœ›ç»“æœ**ï¼š
```json
{
  "success": true,
  "message": "å®¢æˆ·åˆ†é…æˆåŠŸ",
  "data": {
    "_id": "...",
    "name": "å¼ ä¸‰",
    "notificationData": {
      "assignedToId": "USER_ID",
      "customerName": "å¼ ä¸‰",
      "source": "æµ‹è¯•åˆ†é…",
      "assignerName": "æç»ç†",
      "customerId": "CUSTOMER_ID",
      "assignTime": "2025-12-21T10:30:00.000Z"
    }
  }
}
```

#### æµ‹è¯•2: æ‰¹é‡åˆ†é…

```bash
curl -X POST "http://localhost:3000/api/customers/batch-assign" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "customerIds": ["CUSTOMER_ID_1", "CUSTOMER_ID_2"],
    "assignedTo": "USER_ID",
    "assignmentReason": "æ‰¹é‡æµ‹è¯•"
  }'
```

**æœŸæœ›ç»“æœ**ï¼š
```json
{
  "success": true,
  "message": "æ‰¹é‡åˆ†é…å®Œæˆï¼šæˆåŠŸ 2 ä¸ªï¼Œå¤±è´¥ 0 ä¸ª",
  "data": {
    "success": 2,
    "failed": 0,
    "notificationData": {
      "assignedToId": "USER_ID",
      "customerCount": 2,
      "customerIds": ["CUSTOMER_ID_1", "CUSTOMER_ID_2"]
    }
  }
}
```

---

### æ–¹å¼3: åœ¨CRMå‰ç«¯æµ‹è¯•

1. **ç™»å½•CRMç³»ç»Ÿ**
2. **è¿›å…¥å®¢æˆ·åˆ—è¡¨**
3. **é€‰æ‹©ä¸€ä¸ªå®¢æˆ·ï¼Œç‚¹å‡»"åˆ†é…"**
4. **æ‰“å¼€æµè§ˆå™¨å¼€å‘è€…å·¥å…· (F12)**
5. **æŸ¥çœ‹Networkæ ‡ç­¾ï¼Œæ‰¾åˆ°åˆ†é…è¯·æ±‚çš„å“åº”**
6. **ç¡®è®¤å“åº”ä¸­åŒ…å« `notificationData` å­—æ®µ**

---

## âœ… éªŒè¯æ¸…å•

### CRMåç«¯éªŒè¯

- [ ] æœåŠ¡æˆåŠŸé‡å¯
- [ ] æ²¡æœ‰å¯åŠ¨é”™è¯¯
- [ ] æ—¥å¿—ä¸­æ²¡æœ‰å¼‚å¸¸

### æ¥å£éªŒè¯

- [ ] `PATCH /api/customers/:id/assign` è¿”å› `notificationData`
- [ ] `PATCH /api/customers/miniprogram/:id/assign` è¿”å› `notificationData`
- [ ] `POST /api/customers/batch-assign` è¿”å› `notificationData`
- [ ] `POST /api/customers/public-pool/assign` è¿”å› `notificationData`

### æ•°æ®å®Œæ•´æ€§éªŒè¯

- [ ] `notificationData.assignedToId` æ­£ç¡®
- [ ] `notificationData.customerName` æ­£ç¡®
- [ ] `notificationData.assignerName` æ­£ç¡®
- [ ] `notificationData.assignTime` æ­£ç¡®

---

## ğŸ”§ å°ç¨‹åºç«¯é›†æˆ

### 1. æ¥æ”¶é€šçŸ¥æ•°æ®

```javascript
// å°ç¨‹åºç«¯ä»£ç ç¤ºä¾‹
async function assignCustomer(customerId, assignedTo, reason) {
  const res = await wx.request({
    url: `${API_BASE}/customers/miniprogram/${customerId}/assign`,
    method: 'PATCH',
    header: {
      'Authorization': `Bearer ${token}`
    },
    data: {
      assignedTo: assignedTo,
      assignmentReason: reason
    }
  });

  if (res.data.success && res.data.data.notificationData) {
    // âœ… æ¥æ”¶åˆ°é€šçŸ¥æ•°æ®
    const notificationData = res.data.data.notificationData;
    
    // å‘é€è®¢é˜…æ¶ˆæ¯
    await sendSubscribeNotification(notificationData);
  }
}
```

### 2. å‘é€è®¢é˜…æ¶ˆæ¯

```javascript
async function sendSubscribeNotification(notificationData) {
  // è°ƒç”¨äº‘å‡½æ•°å‘é€è®¢é˜…æ¶ˆæ¯
  await wx.cloud.callFunction({
    name: 'sendNotification',
    data: {
      type: 'customer_assign',
      toUserId: notificationData.assignedToId,
      customerName: notificationData.customerName,
      source: notificationData.source,
      assignerName: notificationData.assignerName,
      assignTime: notificationData.assignTime
    }
  });
}
```

---

## ğŸ› å¸¸è§é—®é¢˜

### é—®é¢˜1: è¿”å›æ•°æ®ä¸­æ²¡æœ‰ `notificationData`

**åŸå› **: 
- æœåŠ¡æœªé‡å¯
- ä»£ç æœªæ­£ç¡®éƒ¨ç½²

**è§£å†³**:
```bash
# é‡å¯æœåŠ¡
pm2 restart crm-backend

# æ£€æŸ¥ä»£ç æ˜¯å¦æœ€æ–°
git pull
npm install
```

### é—®é¢˜2: `notificationData` ä¸­æŸäº›å­—æ®µä¸ºç©º

**åŸå› **:
- ç”¨æˆ·ä¿¡æ¯ä¸å®Œæ•´ï¼ˆå¦‚ `req.user.name` ä¸ºç©ºï¼‰
- å®¢æˆ·ä¿¡æ¯ä¸å®Œæ•´

**è§£å†³**:
- ç¡®ä¿ç”¨æˆ·è¡¨ä¸­æœ‰ `name` å­—æ®µ
- ç¡®ä¿å®¢æˆ·è¡¨ä¸­æœ‰å®Œæ•´ä¿¡æ¯

### é—®é¢˜3: å°ç¨‹åºç«¯æ”¶ä¸åˆ°é€šçŸ¥

**åŸå› **:
- å‘˜å·¥æœªè®¢é˜…
- æ¨¡æ¿IDä¸æ­£ç¡®
- å°ç¨‹åºç«¯æœªæ­£ç¡®å¤„ç† `notificationData`

**è§£å†³**:
- ç¡®ä¿å‘˜å·¥åœ¨å°ç¨‹åºä¸­å·²æˆæƒè®¢é˜…
- æ£€æŸ¥å°ç¨‹åºåå°çš„æ¨¡æ¿IDé…ç½®
- æ£€æŸ¥å°ç¨‹åºç«¯ä»£ç æ˜¯å¦æ­£ç¡®æ¥æ”¶å’Œå¤„ç†æ•°æ®

---

## ğŸ“Š ç›‘æ§å’Œæ—¥å¿—

### æŸ¥çœ‹åˆ†é…æ—¥å¿—

```bash
# æŸ¥çœ‹åç«¯æ—¥å¿—
pm2 logs crm-backend | grep "å°ç¨‹åºåˆ†é…å®¢æˆ·"

# æŸ¥çœ‹é€šçŸ¥æ•°æ®æ—¥å¿—
pm2 logs crm-backend | grep "é€šçŸ¥æ•°æ®å·²å‡†å¤‡"
```

### ç›‘æ§åˆ†é…æˆåŠŸç‡

åœ¨CRMåå°å¯ä»¥æŸ¥çœ‹ï¼š
- åˆ†é…æˆåŠŸæ¬¡æ•°
- åˆ†é…å¤±è´¥æ¬¡æ•°
- é€šçŸ¥å‘é€æˆåŠŸç‡

---

## ğŸ‰ å®Œæˆï¼

å¦‚æœæ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼Œè¯´æ˜CRMåç«¯å·²ç»æˆåŠŸæ”¯æŒçº¿ç´¢åˆ†é…é€šçŸ¥åŠŸèƒ½ï¼

**ä¸‹ä¸€æ­¥**ï¼š
1. å°ç¨‹åºç«¯æ¥æ”¶ `notificationData`
2. è°ƒç”¨å¾®ä¿¡è®¢é˜…æ¶ˆæ¯APIå‘é€é€šçŸ¥
3. æµ‹è¯•å®Œæ•´æµç¨‹

---

## ğŸ“ æŠ€æœ¯æ”¯æŒ

å¦‚æœ‰é—®é¢˜ï¼Œè¯·æŸ¥çœ‹ï¼š
- `CRMç«¯-çº¿ç´¢åˆ†é…é€šçŸ¥å®ç°è¯´æ˜.md` - è¯¦ç»†å®ç°è¯´æ˜
- `test_customer_assignment_notification.js` - æµ‹è¯•è„šæœ¬
- åç«¯æ—¥å¿—æ–‡ä»¶

