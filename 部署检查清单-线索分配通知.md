# 线索分配通知功能 - 部署检查清单

## 📋 CRM端检查清单

### 1. 环境变量配置

- [ ] 在 `backend/.env` 中添加小程序配置
  ```env
  MINIPROGRAM_APPID=wxb2c4e35d16d99fd3
  MINIPROGRAM_APPSECRET=从小程序后台获取
  MINIPROGRAM_CLOUD_ENV=cloud1-4gi0bpoje72fedd1
  ```

- [ ] 确认 AppSecret 已正确配置（不是占位符）
- [ ] 确认 AppSecret 不在代码仓库中

### 2. 代码部署

- [ ] 确认 `wechat-cloud.service.ts` 文件存在
- [ ] 确认 `weixin.module.ts` 已导出 `WechatCloudService`
- [ ] 确认 `customers.controller.ts` 已注入 `WechatCloudService`
- [ ] 确认4个分配接口都已添加云函数调用

### 3. 编译和重启

- [ ] 运行 `cd backend && npm run build`
- [ ] 确认编译成功，无错误
- [ ] 重启后端服务: `pm2 restart backend-prod`
- [ ] 确认服务启动成功

### 4. 日志检查

- [ ] 查看启动日志: `pm2 logs backend-prod`
- [ ] 确认看到: `✅ 微信云函数服务初始化完成`
- [ ] 如果看到警告，检查 AppSecret 配置

---

## 📱 小程序端检查清单

### 1. 云函数实现

- [ ] 创建云函数目录: `cloudfunctions/quickstartFunctions/`
- [ ] 复制示例代码: `小程序云函数示例-quickstartFunctions.js`
- [ ] 修改用户表查询逻辑（根据实际数据结构）
- [ ] 配置订阅消息模板ID

### 2. 订阅消息配置

- [ ] 登录小程序后台: https://mp.weixin.qq.com
- [ ] 进入: 功能 → 订阅消息 → 公共模板库
- [ ] 搜索并添加"任务分配"或"工作提醒"模板
- [ ] 记录模板ID
- [ ] 更新到云函数代码中

### 3. 云函数部署

- [ ] 在微信开发者工具中打开云函数
- [ ] 右键 → 上传并部署：云端安装依赖
- [ ] 等待部署完成
- [ ] 在云开发控制台确认部署成功

### 4. 用户数据准备

- [ ] 确认用户表中存储了 openid
- [ ] 确认 userId 和 openid 的映射关系正确
- [ ] 测试查询用户 openid 的逻辑

---

## 🧪 功能测试清单

### 1. 单个客户分配测试（小程序端）

- [ ] 在小程序中分配一个客户
- [ ] 查看CRM后端日志
  - [ ] 看到: `📱 调用云函数发送通知`
  - [ ] 看到: `✅ 云函数调用成功`
- [ ] 查看云函数日志
  - [ ] 看到: `📥 收到云函数调用`
  - [ ] 看到: `✅ 订阅消息发送成功`
- [ ] 确认被分配人收到通知

### 2. 单个客户分配测试（Web端）

- [ ] 在CRM网页端分配一个客户
- [ ] 查看CRM后端日志（同上）
- [ ] 查看云函数日志（同上）
- [ ] 确认被分配人收到通知

### 3. 批量分配测试

- [ ] 在CRM端批量分配多个客户
- [ ] 查看后端日志
  - [ ] 看到: `📱 批量发送通知`
- [ ] 确认被分配人收到通知

### 4. 公海分配测试

- [ ] 从公海分配客户
- [ ] 查看后端日志
  - [ ] 看到: `发送公海分配通知`
- [ ] 确认被分配人收到通知

### 5. 错误处理测试

- [ ] 测试用户未绑定openid的情况
  - [ ] 确认不影响分配操作
  - [ ] 确认日志中记录了错误
- [ ] 测试用户未授权订阅消息的情况
  - [ ] 确认不影响分配操作
  - [ ] 确认日志中记录了错误

---

## 🔍 问题排查清单

### CRM端问题

#### 问题: 看不到云函数调用日志

- [ ] 检查 AppSecret 是否配置
- [ ] 检查服务是否重启
- [ ] 检查日志级别设置

#### 问题: access_token 获取失败

- [ ] 检查 AppSecret 是否正确
- [ ] 检查网络连接
- [ ] 检查微信API是否正常

#### 问题: 云函数调用失败

- [ ] 检查云环境ID是否正确
- [ ] 检查云函数名称是否正确
- [ ] 检查云函数是否已部署

### 小程序端问题

#### 问题: 云函数未收到请求

- [ ] 检查云函数是否部署
- [ ] 检查云环境ID是否匹配
- [ ] 检查云函数名称是否正确

#### 问题: 找不到用户openid

- [ ] 检查用户表结构
- [ ] 检查查询逻辑
- [ ] 检查userId映射

#### 问题: 订阅消息发送失败

- [ ] 检查模板ID是否正确
- [ ] 检查用户是否授权
- [ ] 检查模板字段是否匹配

---

## 📊 监控指标

### 日常监控

- [ ] 每天检查后端日志，确认通知发送正常
- [ ] 每周统计通知发送成功率
- [ ] 每月检查用户反馈

### 关键指标

- **通知发送成功率**: 目标 > 95%
- **云函数调用延迟**: 目标 < 2秒
- **用户授权率**: 目标 > 80%

---

## 📝 文档归档

- [ ] 保存所有配置信息
- [ ] 记录模板ID
- [ ] 记录云环境ID
- [ ] 更新运维文档

---

## ✅ 最终确认

- [ ] CRM端功能正常
- [ ] 小程序端功能正常
- [ ] 测试用例全部通过
- [ ] 文档完整
- [ ] 团队培训完成

---

**检查人**: ___________  
**检查日期**: ___________  
**签字确认**: ___________

